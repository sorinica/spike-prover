<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"/>
<link href="coqdoc.css" rel="stylesheet" type="text/css"/>
<title>term_orderings.dp</title>
</head>

<body>

<div id="page">

<div id="header">
</div>

<div id="main">

<h1 class="libtitle">Library term_orderings.dp</h1>

<div class="code">

<br/>
<span class="id" type="keyword">Add</span> <span class="id" type="var">LoadPath</span> "basis".<br/>
<span class="id" type="keyword">Add</span> <span class="id" type="var">LoadPath</span> "list_extensions".<br/>
<span class="id" type="keyword">Add</span> <span class="id" type="var">LoadPath</span> "term_algebra".<br/>

<br/>
</div>

<div class="doc">
<a name="lab75"></a><h1 class="section">Termination of rewriting</h1>

</div>
<div class="code">

<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">List</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Relations</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Wellfounded</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Arith</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Recdef</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Setoid</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">closure</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">more_list</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">weaved_relation</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">term</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">equational_theory_spec</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab76"></a><h2 class="section">Module Type Termin, for termination of rewriting systems.</h2>

</div>
<div class="code">

<br/>
<span class="id" type="keyword">Module</span> <span class="id" type="var">MakeDP</span> (<span class="id" type="var">E</span> : <span class="id" type="var">EqTh</span>).<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Import</span> <span class="id" type="var">E</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Import</span> <span class="id" type="var">T</span>.<br/>

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">dp</span> (<span class="id" type="var">R</span> : <span class="id" type="var">relation</span> <span class="id" type="var">term</span>) : <span class="id" type="var">term</span> -&gt; <span class="id" type="var">term</span> -&gt; <span class="id" type="keyword">Prop</span>:= <br/>
&nbsp;&nbsp;| <span class="id" type="var">Dp</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">p</span> <span class="id" type="var">f2</span> <span class="id" type="var">l2</span>, <span class="id" type="var">R</span> <span class="id" type="var">t2</span> <span class="id" type="var">t1</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">t2</span> <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f2</span> <span class="id" type="var">l2</span>) -&gt; <span class="id" type="var">defined</span> <span class="id" type="var">R</span> <span class="id" type="var">f2</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">dp</span> <span class="id" type="var">R</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f2</span> <span class="id" type="var">l2</span>) <span class="id" type="var">t1</span>.<br/>

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">rdp_step</span> (<span class="id" type="var">R1</span> <span class="id" type="var">R2</span> : <span class="id" type="var">relation</span> <span class="id" type="var">term</span>) : <span class="id" type="var">term</span> -&gt; <span class="id" type="var">term</span> -&gt; <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Rdp_step</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">t3</span>, <span class="id" type="var">refl_trans_clos</span> (<span class="id" type="var">one_step_list</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R2</span>)) <span class="id" type="var">l2</span> <span class="id" type="var">l1</span> -&gt; <span class="id" type="var">R1</span> <span class="id" type="var">t3</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l2</span>) -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">rdp_step</span> <span class="id" type="var">R1</span> <span class="id" type="var">R2</span> <span class="id" type="var">t3</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span>).<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">dp_incl</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">R1</span> <span class="id" type="var">R2</span>, <span class="id" type="var">inclusion</span> <span class="id" type="var">_</span> <span class="id" type="var">R1</span> <span class="id" type="var">R2</span> -&gt; <span class="id" type="var">inclusion</span> <span class="id" type="var">_</span> (<span class="id" type="var">dp</span> <span class="id" type="var">R1</span>) (<span class="id" type="var">dp</span> <span class="id" type="var">R2</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R1'</span> <span class="id" type="var">R2'</span> <span class="id" type="var">R1_in_R2</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1'</span> <span class="id" type="var">t2'</span> <span class="id" type="var">p</span> <span class="id" type="var">f2</span> <span class="id" type="var">l2</span> <span class="id" type="var">H'</span> <span class="id" type="var">Subt</span> <span class="id" type="var">Df2</span>]; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">Dp</span> <span class="id" type="var">R2'</span> <span class="id" type="var">t2</span> <span class="id" type="var">t2'</span> <span class="id" type="var">p</span> <span class="id" type="var">f2</span> <span class="id" type="var">l2</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">R1_in_R2</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">Df2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">g2</span> <span class="id" type="var">l</span> <span class="id" type="var">u</span> <span class="id" type="var">H1</span>]; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">Def</span> <span class="id" type="var">R2'</span> <span class="id" type="var">f2</span> <span class="id" type="var">l</span> <span class="id" type="var">u</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">R1_in_R2</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">rdp_step_incl</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">R'</span> <span class="id" type="var">R1</span> <span class="id" type="var">R2</span>, <span class="id" type="var">inclusion</span> <span class="id" type="var">_</span> <span class="id" type="var">R</span> <span class="id" type="var">R'</span> -&gt; <span class="id" type="var">inclusion</span> <span class="id" type="var">_</span> <span class="id" type="var">R1</span> <span class="id" type="var">R2</span> -&gt;  <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">inclusion</span> <span class="id" type="var">_</span> (<span class="id" type="var">rdp_step</span> (<span class="id" type="var">axiom</span> (<span class="id" type="var">dp</span> <span class="id" type="var">R</span>)) <span class="id" type="var">R1</span>) (<span class="id" type="var">rdp_step</span> (<span class="id" type="var">axiom</span> (<span class="id" type="var">dp</span> <span class="id" type="var">R'</span>)) <span class="id" type="var">R2</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">R'</span> <span class="id" type="var">R1'</span> <span class="id" type="var">R2'</span> <span class="id" type="var">R_in_R'</span> <span class="id" type="var">R1_in_R2</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">g</span> <span class="id" type="var">k</span> <span class="id" type="var">l'</span> <span class="id" type="var">s''</span> <span class="id" type="var">l_R_l'</span> <span class="id" type="var">Hm</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Rdp_step</span> <span class="id" type="keyword">with</span> <span class="id" type="var">l'</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_trans_incl</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">one_step_list</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R1'</span>)); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">intro</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">one_step_list_incl</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">one_step_incl</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">Hm</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">u1</span> <span class="id" type="var">u2</span> <span class="id" type="var">sigma</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">Hm</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">dp_incl</span> <span class="id" type="keyword">with</span> <span class="id" type="var">R</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">rwr_subterm_rdp_rdp</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R1</span> <span class="id" type="var">R2</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">t</span>, <span class="id" type="var">refl_trans_clos</span> (<span class="id" type="var">one_step_list</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R1</span>)) <span class="id" type="var">l2</span> <span class="id" type="var">l1</span> -&gt; <span class="id" type="var">rdp_step</span> <span class="id" type="var">R2</span> <span class="id" type="var">R1</span> <span class="id" type="var">t</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l2</span>) -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">rdp_step</span> <span class="id" type="var">R2</span> <span class="id" type="var">R1</span> <span class="id" type="var">t</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R1</span> <span class="id" type="var">R2</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">t</span> <span class="id" type="var">H</span> <span class="id" type="var">H'</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">f'</span> <span class="id" type="var">l2'</span> <span class="id" type="var">l3</span> <span class="id" type="var">t'</span> <span class="id" type="var">K</span> <span class="id" type="var">K'</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Rdp_step</span> <span class="id" type="keyword">with</span> <span class="id" type="var">l3</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_trans_clos_is_trans</span> <span class="id" type="keyword">with</span> <span class="id" type="var">l2</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">one_step_subterm_rdp_rdp</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R1</span> <span class="id" type="var">R2</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">t</span>, <span class="id" type="var">one_step_list</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R1</span>) <span class="id" type="var">l2</span> <span class="id" type="var">l1</span> -&gt; <span class="id" type="var">rdp_step</span> <span class="id" type="var">R2</span> <span class="id" type="var">R1</span> <span class="id" type="var">t</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l2</span>) -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">rdp_step</span> <span class="id" type="var">R2</span> <span class="id" type="var">R1</span> <span class="id" type="var">t</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R1</span> <span class="id" type="var">R2</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">t</span> <span class="id" type="var">H</span> <span class="id" type="var">H'</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">rwr_subterm_rdp_rdp</span> <span class="id" type="keyword">with</span> <span class="id" type="var">l2</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">one_step_subterm_acc_rdp_acc_rdp</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R1</span> <span class="id" type="var">R2</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>, <span class="id" type="var">one_step_list</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R1</span>) <span class="id" type="var">l2</span> <span class="id" type="var">l1</span> -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">rdp_step</span> <span class="id" type="var">R2</span> <span class="id" type="var">R1</span>) (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span>) -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Acc</span> (<span class="id" type="var">rdp_step</span> <span class="id" type="var">R2</span> <span class="id" type="var">R1</span>) (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l2</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R1</span> <span class="id" type="var">R2</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">H</span> <span class="id" type="var">Acc_t1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">H'</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_inv</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">one_step_subterm_rdp_rdp</span> <span class="id" type="keyword">with</span> <span class="id" type="var">l2</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">rwr_subterm_acc_rdp_acc_rdp</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R1</span> <span class="id" type="var">R2</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>, <span class="id" type="var">refl_trans_clos</span> (<span class="id" type="var">one_step_list</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R1</span>)) <span class="id" type="var">l2</span> <span class="id" type="var">l1</span> -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">rdp_step</span> <span class="id" type="var">R2</span> <span class="id" type="var">R1</span>) (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span>) -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Acc</span> (<span class="id" type="var">rdp_step</span> <span class="id" type="var">R2</span> <span class="id" type="var">R1</span>) (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l2</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R1</span> <span class="id" type="var">R2</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">H</span> <span class="id" type="var">Acc_t1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">H'</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_inv</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">rwr_subterm_rdp_rdp</span> <span class="id" type="keyword">with</span> <span class="id" type="var">l2</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">dp_step</span> <span class="id" type="var">R</span> := <span class="id" type="var">rdp_step</span> (<span class="id" type="var">axiom</span> (<span class="id" type="var">dp</span> <span class="id" type="var">R</span>)) <span class="id" type="var">R</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">acc_one_step_acc_dp</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">t</span>, ~ (<span class="id" type="var">R</span> <span class="id" type="var">t</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>))) -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>)  <span class="id" type="var">t</span> -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">dp_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">HR</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">axiom</span> (<span class="id" type="var">dp</span> <span class="id" type="var">R</span>) <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">trans_clos</span> (<span class="id" type="var">union</span> <span class="id" type="var">term</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">direct_subterm</span>) <span class="id" type="var">s</span> <span class="id" type="var">t</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">H'</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">s'</span> <span class="id" type="var">t'</span> <span class="id" type="var">sigma</span> <span class="id" type="var">H</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">p</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">H''</span> <span class="id" type="var">H3</span> <span class="id" type="var">Df</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H4</span> := <span class="id" type="var">subterm_at_pos_apply_subst_apply_subst_subterm_at_pos</span> <span class="id" type="var">t2</span> <span class="id" type="var">p</span> <span class="id" type="var">sigma</span>); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H3</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H4</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">subterm_subterm</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H4</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">H1</span> | <span class="id" type="var">H2</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">t_step</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">at_top</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">trans_clos_is_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t2</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">trans_incl</span> <span class="id" type="keyword">with</span> <span class="id" type="var">direct_subterm</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">H</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">t_step</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">at_top</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>; <span class="id" type="tactic">trivial</span>.<br/>

<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">Acc_t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_incl</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">trans_clos</span> (<span class="id" type="var">union</span> <span class="id" type="var">term</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">direct_subterm</span>)).<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">t</span> <span class="id" type="var">Acc_t</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">H'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">f'</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">H3</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">l</span> | <span class="id" type="var">k1</span> <span class="id" type="var">k2</span> <span class="id" type="var">K2</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">trans_clos_is_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f'</span> <span class="id" type="var">l2</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">trans_incl</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s'</span> <span class="id" type="var">t'</span> <span class="id" type="var">H'</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">general_context</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">acc_trans</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">acc_with_subterm</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">dp_necessary</span> : <br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">t</span>, ~ (<span class="id" type="var">R</span> <span class="id" type="var">t</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>))) -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">well_founded</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>)  -&gt; <span class="id" type="var">well_founded</span> (<span class="id" type="var">dp_step</span> <span class="id" type="var">R</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">HR</span> <span class="id" type="var">Wf</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">acc_one_step_acc_dp</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
Plain standard dependency pair criterion 
</div>
<div class="code">
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">dp_criterion_local</span> : <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">t</span>, ~ (<span class="id" type="var">R</span> <span class="id" type="var">t</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>))) -&gt; <br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">x</span>, <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">t</span>)) -&gt;<br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span>, {<span class="id" type="var">constructor</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span>} + {<span class="id" type="var">defined</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span>}) -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>,   <span class="id" type="var">Acc</span> (<span class="id" type="var">dp_step</span> <span class="id" type="var">R</span>)  <span class="id" type="var">t</span> -&gt; (<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span>, <span class="id" type="var">direct_subterm</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">s</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">HR</span> <span class="id" type="var">RR</span> <span class="id" type="var">CD</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">Acc_t</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">Acc_t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t</span> <span class="id" type="var">Acc_t</span> <span class="id" type="var">IH</span>].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">Acc_l</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x</span> | <span class="id" type="var">f</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_var</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Acc_l</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">acc_one_step_list</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Acc_l</span>; <span class="id" type="var">revert</span> <span class="id" type="var">IH</span>.<br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">Acc_l</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">l</span> <span class="id" type="var">Acc_l</span> <span class="id" type="var">IHl</span>]; <span class="id" type="tactic">intros</span> <span class="id" type="var">IH'</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Acc_l'</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span>).<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">acc_one_step_list</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>; <span class="id" type="tactic">exact</span> <span class="id" type="var">Acc_l</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>; <br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">s</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x1</span> | <span class="id" type="var">f1</span> <span class="id" type="var">l1</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_var</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H'</span> | <span class="id" type="var">f'</span> <span class="id" type="var">l1'</span> <span class="id" type="var">l2</span> <span class="id" type="var">H'</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t1_R_t2</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H'</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x</span> | <span class="id" type="var">g</span> <span class="id" type="var">k</span>].<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">R</span> <span class="id" type="var">t1</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>)); <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">HR</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">g</span> <span class="id" type="var">l</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H''</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">n</span> <span class="id" type="var">t</span>, <span class="id" type="var">size</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>) &lt;= <span class="id" type="var">n</span> -&gt; (<span class="id" type="var">exists</span> <span class="id" type="var">p</span>, <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">t1</span> <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> <span class="id" type="var">t</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>)).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">n</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">n</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">n</span>].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">St</span>; <span class="id" type="var">absurd</span> (1 &lt;= 0); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>; <br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">le_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">size</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>)); <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">size_ge_one</span>.<br/>
<span class="id" type="tactic">intros</span> [<span class="id" type="var">x</span> | <span class="id" type="var">g</span> <span class="id" type="var">h</span>] <span class="id" type="var">St</span> [<span class="id" type="var">p</span> <span class="id" type="var">H''</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">E.var_acc</span> <span class="id" type="keyword">with</span> <span class="id" type="var">k</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H</span> : <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">k</span>))).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">RR</span> <span class="id" type="keyword">with</span> <span class="id" type="var">t1</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">var_in_subterm</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>) <span class="id" type="var">p</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_list_unfold</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Acc_h</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">h</span> -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>)).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">t_in_h</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHn</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">le_S_n</span>; <span class="id" type="tactic">refine</span> (<span class="id" type="var">le_trans</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">St</span>); <span class="id" type="tactic">apply</span> <span class="id" type="var">size_direct_subterm</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">In_split</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">t_in_h</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">h'</span> [<span class="id" type="var">h''</span> <span class="id" type="var">K</span>]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">h</span>.<br/>
<span class="id" type="var">exists</span> (<span class="id" type="var">p</span> ++ (<span class="id" type="var">length</span> <span class="id" type="var">h'</span> :: <span class="id" type="var">nil</span>)).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">subterm_in_subterm</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> (<span class="id" type="var">h'</span> ++ <span class="id" type="var">t</span> :: <span class="id" type="var">h''</span>)).<br/>
<span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">nth_error_at_pos</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">CD</span> <span class="id" type="var">g</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">Cg</span> | <span class="id" type="var">Dg</span>].<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">acc_subterms</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">t_in_map_h</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">t_in_map_h</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t_in_map_h</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t'</span> [<span class="id" type="var">H'''</span> <span class="id" type="var">t'_in_h</span>]]; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_h</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IH'</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Rdp_step</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">map</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">k</span>).<br/>
<span class="id" type="var">left</span>.<br/>
<span class="id" type="tactic">replace</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">map</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">k</span>)) <span class="id" type="keyword">with</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">k</span>)); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Dp</span> <span class="id" type="keyword">with</span> <span class="id" type="var">t1</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">s_in_h</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">s_in_h</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">s_in_h</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">s_in_h</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">_s</span> [<span class="id" type="var">_ssig_eq_s</span> <span class="id" type="var">_s_in_h</span>]]; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_h</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">H''</span> (<span class="id" type="var">size</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f1</span> <span class="id" type="var">l1</span>))).<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">le_n</span>.<br/>
<span class="id" type="var">exists</span> (@<span class="id" type="var">nil</span> <span class="id" type="var">nat</span>); <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">one_step_subterm_rdp_rdp</span> <span class="id" type="keyword">with</span> <span class="id" type="var">l1</span>; <span class="id" type="tactic">trivial</span>.<br/>

<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">H''</span> <span class="id" type="var">H'''</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IH'</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">one_step_subterm_rdp_rdp</span> <span class="id" type="keyword">with</span> <span class="id" type="var">l1</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Defined</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">dp_criterion</span> : <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">t</span>, ~ (<span class="id" type="var">R</span> <span class="id" type="var">t</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>))) -&gt; <br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">x</span>, <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">t</span>)) -&gt;<br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span>, {<span class="id" type="var">constructor</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span>} + {<span class="id" type="var">defined</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span>}) -&gt;<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">well_founded</span> (<span class="id" type="var">dp_step</span> <span class="id" type="var">R</span>)  -&gt; <span class="id" type="var">well_founded</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">HR</span> <span class="id" type="var">RR</span> <span class="id" type="var">CD</span> <span class="id" type="var">Wf</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">x</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_var</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">dp_criterion_local</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Defined</span>.<br/>

<br/>
</div>

<div class="doc">
Standard dependency pair criterion with minimal chains 
</div>
<div class="code">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">acc_sub</span> <span class="id" type="var">R</span> <span class="id" type="var">t</span> := <span class="id" type="keyword">forall</span> <span class="id" type="var">s</span>, <span class="id" type="var">direct_subterm</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">s</span>.<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">dp_step_min</span> <span class="id" type="var">R</span> := <span class="id" type="var">rest</span> (<span class="id" type="var">acc_sub</span> <span class="id" type="var">R</span>) (<span class="id" type="var">dp_step</span> <span class="id" type="var">R</span>).<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">dp_criterion_min_local</span> : <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">t</span>, ~ (<span class="id" type="var">R</span> <span class="id" type="var">t</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>))) -&gt; <br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">x</span>, <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">t</span>)) -&gt;<br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span>, {<span class="id" type="var">constructor</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span>} + {<span class="id" type="var">defined</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span>}) -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>,   <span class="id" type="var">Acc</span> (<span class="id" type="var">dp_step_min</span> <span class="id" type="var">R</span>)  <span class="id" type="var">t</span> -&gt; (<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span>, <span class="id" type="var">direct_subterm</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">s</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">HR</span> <span class="id" type="var">RR</span> <span class="id" type="var">CD</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">Acc_t</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">Acc_t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t</span> <span class="id" type="var">Acc_t</span> <span class="id" type="var">IH</span>].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">Acc_l</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x</span> | <span class="id" type="var">f</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_var</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Acc_l</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">acc_one_step_list</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Acc_l</span>; <span class="id" type="var">revert</span> <span class="id" type="var">Acc_t</span> <span class="id" type="var">IH</span>.<br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">Acc_l</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">l</span> <span class="id" type="var">Acc_l</span> <span class="id" type="var">IHl</span>].<br/>
<span class="id" type="var">revert</span> <span class="id" type="var">l</span> <span class="id" type="var">Acc_l</span> <span class="id" type="var">IHl</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Main</span> : <br/>
<span class="id" type="keyword">forall</span> <span class="id" type="var">l</span> (<span class="id" type="var">Hsub</span> : <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step_list</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>)) <span class="id" type="var">l</span>)<br/>
(<span class="id" type="var">IH2</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">y</span> (<span class="id" type="var">Hy</span> : <span class="id" type="var">one_step_list</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">y</span> <span class="id" type="var">l</span>)<br/>
&nbsp;(<span class="id" type="var">Ht'</span> : <span class="id" type="var">Acc</span> (<span class="id" type="var">dp_step_min</span> <span class="id" type="var">R</span>) (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">y</span>))<br/>
&nbsp;(<span class="id" type="var">Hsub'</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">y0</span>, <span class="id" type="var">dp_step_min</span> <span class="id" type="var">R</span> <span class="id" type="var">y0</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">y</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> : <span class="id" type="var">term</span>, <span class="id" type="var">direct_subterm</span> <span class="id" type="var">s</span> <span class="id" type="var">y0</span> -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">s</span>) -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">y0</span>),<br/>
&nbsp;<span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">y</span>))<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">Ht</span> : <span class="id" type="var">Acc</span> (<span class="id" type="var">dp_step_min</span> <span class="id" type="var">R</span>) (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">IH1</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">y</span>, <span class="id" type="var">dp_step_min</span> <span class="id" type="var">R</span> <span class="id" type="var">y</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> : <span class="id" type="var">term</span>, <span class="id" type="var">direct_subterm</span> <span class="id" type="var">s</span> <span class="id" type="var">y</span> -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">s</span>) -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">y</span>), <br/>
<span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">l</span> <span class="id" type="var">Acc_l</span> <span class="id" type="var">IH2</span> <span class="id" type="var">Acc_t</span> <span class="id" type="var">IH1</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">s</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x1</span> | <span class="id" type="var">f1</span> <span class="id" type="var">l1</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_var</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H'</span> | <span class="id" type="var">f'</span> <span class="id" type="var">l1'</span> <span class="id" type="var">l2</span> <span class="id" type="var">H'</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t1_R_t2</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H'</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x</span> | <span class="id" type="var">g</span> <span class="id" type="var">k</span>].<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">R</span> <span class="id" type="var">t1</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>)); <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">HR</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">g</span> <span class="id" type="var">l</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H''</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">n</span> <span class="id" type="var">t</span>, <span class="id" type="var">size</span> <span class="id" type="var">t</span> &lt;= <span class="id" type="var">n</span> -&gt; (<span class="id" type="var">exists</span> <span class="id" type="var">p</span>, <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">t1</span> <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> <span class="id" type="var">t</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>)).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">n</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">n</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">n</span>].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">St</span>; <span class="id" type="var">absurd</span> (1 &lt;= 0); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>; <br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">le_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">size</span> <span class="id" type="var">t</span>); <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">size_ge_one</span>.<br/>
<span class="id" type="tactic">intros</span> [<span class="id" type="var">x</span> | <span class="id" type="var">g</span> <span class="id" type="var">h</span>] <span class="id" type="var">St</span> [<span class="id" type="var">p</span> <span class="id" type="var">H''</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">E.var_acc</span> <span class="id" type="keyword">with</span> <span class="id" type="var">k</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">RR</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">t1_R_t2</span> <span class="id" type="var">x</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">var_in_subterm</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>) <span class="id" type="var">p</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">acc_one_step_list</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Acc_h</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">h</span> -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>)).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">t_in_h</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHn</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">le_S_n</span>; <span class="id" type="tactic">refine</span> (<span class="id" type="var">le_trans</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">St</span>); <span class="id" type="tactic">apply</span> <span class="id" type="var">size_direct_subterm</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">In_split</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">t_in_h</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">h'</span> [<span class="id" type="var">h''</span> <span class="id" type="var">K</span>]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">h</span>.<br/>
<span class="id" type="var">exists</span> (<span class="id" type="var">p</span> ++ (<span class="id" type="var">length</span> <span class="id" type="var">h'</span> :: <span class="id" type="var">nil</span>)).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">subterm_in_subterm</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> (<span class="id" type="var">h'</span> ++ <span class="id" type="var">t</span> :: <span class="id" type="var">h''</span>)).<br/>
<span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">nth_error_at_pos</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">CD</span> <span class="id" type="var">g</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">Cg</span> | <span class="id" type="var">Dg</span>].<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">acc_subterms</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">t_in_map_h</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">t_in_map_h</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t_in_map_h</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t'</span> [<span class="id" type="var">H'''</span> <span class="id" type="var">t'_in_h</span>]]; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_h</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IH1</span>.<br/>
<span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Rdp_step</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">map</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">k</span>).<br/>
<span class="id" type="var">left</span>.<br/>
<span class="id" type="tactic">replace</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">map</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">k</span>)) <span class="id" type="keyword">with</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">k</span>)); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Dp</span> <span class="id" type="keyword">with</span> <span class="id" type="var">t1</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">s_in_h</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">s_in_h</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">s_in_h</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">s_in_h</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">_s</span> [<span class="id" type="var">_ssig_eq_s</span> <span class="id" type="var">_s_in_h</span>]]; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_h</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">acc_sub</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">acc_one_step_list</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">s_in_h</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">s_in_h</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">s_in_h</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">s_in_h</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">u</span> [<span class="id" type="var">H2</span> <span class="id" type="var">u_in_h</span>]]; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_h</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">H''</span> (<span class="id" type="var">size</span> <span class="id" type="var">t1</span>)).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">le_n</span>.<br/>
<span class="id" type="var">exists</span> (@<span class="id" type="var">nil</span> <span class="id" type="var">nat</span>); <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IH2</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> [<span class="id" type="var">H''</span> [<span class="id" type="var">acc_sub_s</span>  <span class="id" type="var">acc_l1</span>]].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_inv</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">split</span>; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">split</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">one_step_subterm_rdp_rdp</span> <span class="id" type="keyword">with</span> <span class="id" type="var">l1</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">acc_sub</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">acc_one_step_list</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span>  [<span class="id" type="var">H''</span> [<span class="id" type="var">acc_sub_s</span>  <span class="id" type="var">acc_l1</span>]] <span class="id" type="var">_</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IH1</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">split</span>; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">split</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">one_step_subterm_rdp_rdp</span> <span class="id" type="keyword">with</span> <span class="id" type="var">l1</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">acc_sub</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">acc_one_step_list</span>; <span class="id" type="tactic">assumption</span>.<br/>

<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">Main</span> <span class="id" type="var">l</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_inv</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">y</span>); <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IH</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">dp_criterion_min</span> : <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">t</span>, ~ (<span class="id" type="var">R</span> <span class="id" type="var">t</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>))) -&gt; <br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">x</span>, <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">t</span>)) -&gt;<br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span>, {<span class="id" type="var">constructor</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span>} + {<span class="id" type="var">defined</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span>}) -&gt;<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">well_founded</span> (<span class="id" type="var">dp_step_min</span> <span class="id" type="var">R</span>)  -&gt; <span class="id" type="var">well_founded</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">HR</span> <span class="id" type="var">RR</span> <span class="id" type="var">CD</span> <span class="id" type="var">Wf</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">x</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_var</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">dp_criterion_min_local</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">ddp</span> <span class="id" type="var">R</span> <span class="id" type="var">v</span> <span class="id" type="var">u</span> := <span class="id" type="var">dp</span> <span class="id" type="var">R</span> <span class="id" type="var">v</span> <span class="id" type="var">u</span> /\ (<span class="id" type="keyword">forall</span> <span class="id" type="var">i</span> <span class="id" type="var">p</span>, <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">u</span> (<span class="id" type="var">i</span> :: <span class="id" type="var">p</span>) &lt;&gt; <span class="id" type="var">Some</span> <span class="id" type="var">v</span>).<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">ddp_is_dp</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">ddp</span> <span class="id" type="var">R</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; <span class="id" type="var">dp</span> <span class="id" type="var">R</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">t2</span> <span class="id" type="var">t1</span> [<span class="id" type="var">H</span> <span class="id" type="var">_</span>]; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">ddp_step</span> <span class="id" type="var">R</span> := <span class="id" type="var">rdp_step</span> (<span class="id" type="var">axiom</span> (<span class="id" type="var">ddp</span> <span class="id" type="var">R</span>)) <span class="id" type="var">R</span>.<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">ddp_step_min</span> <span class="id" type="var">R</span> := <span class="id" type="var">rest</span> (<span class="id" type="var">acc_sub</span> <span class="id" type="var">R</span>) (<span class="id" type="var">ddp_step</span> <span class="id" type="var">R</span>).<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">rddp_step_incl</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">R'</span> <span class="id" type="var">R1</span> <span class="id" type="var">R2</span>, <span class="id" type="var">inclusion</span> <span class="id" type="var">_</span> <span class="id" type="var">R</span> <span class="id" type="var">R'</span> -&gt; <span class="id" type="var">inclusion</span> <span class="id" type="var">_</span> <span class="id" type="var">R1</span> <span class="id" type="var">R2</span> -&gt;  <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">inclusion</span> <span class="id" type="var">_</span> (<span class="id" type="var">rdp_step</span> (<span class="id" type="var">axiom</span> (<span class="id" type="var">ddp</span> <span class="id" type="var">R</span>)) <span class="id" type="var">R1</span>) (<span class="id" type="var">rdp_step</span> (<span class="id" type="var">axiom</span> (<span class="id" type="var">ddp</span> <span class="id" type="var">R'</span>)) <span class="id" type="var">R2</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">R'</span> <span class="id" type="var">R1'</span> <span class="id" type="var">R2'</span> <span class="id" type="var">R_in_R'</span> <span class="id" type="var">R1_in_R2</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">g</span> <span class="id" type="var">k</span> <span class="id" type="var">l'</span> <span class="id" type="var">s''</span> <span class="id" type="var">l_R_l'</span> <span class="id" type="var">Hm</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Rdp_step</span> <span class="id" type="keyword">with</span> <span class="id" type="var">l'</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_trans_incl</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">one_step_list</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R1'</span>)); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">intro</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">one_step_list_incl</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">one_step_incl</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">Hm</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">u1</span> <span class="id" type="var">u2</span> <span class="id" type="var">sigma</span> [<span class="id" type="var">H1</span> <span class="id" type="var">Sub</span>] <span class="id" type="var">H2</span> <span class="id" type="var">H3</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">Hm</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>.<br/>
<span class="id" type="tactic">split</span>; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">assumption</span>].<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Dp</span> <span class="id" type="keyword">with</span> <span class="id" type="var">t2</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">R_in_R'</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Def</span> <span class="id" type="keyword">with</span> <span class="id" type="var">l</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">R_in_R'</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">ddp_step_incl</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">R1</span> <span class="id" type="var">R2</span>, <span class="id" type="var">inclusion</span> <span class="id" type="var">_</span> <span class="id" type="var">R1</span> <span class="id" type="var">R2</span> -&gt;  <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">inclusion</span> <span class="id" type="var">_</span> (<span class="id" type="var">ddp_step</span> <span class="id" type="var">R1</span>) (<span class="id" type="var">ddp_step</span> <span class="id" type="var">R2</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R1'</span> <span class="id" type="var">R2'</span> <span class="id" type="var">R1_in_R2</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">rddp_step_incl</span> <span class="id" type="var">R1'</span> <span class="id" type="var">R2'</span> <span class="id" type="var">R1'</span> <span class="id" type="var">R2'</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">ddp_criterion_local</span> : <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">t</span>, ~ (<span class="id" type="var">R</span> <span class="id" type="var">t</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>))) -&gt; <br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">x</span>, <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">t</span>)) -&gt;<br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span>, {<span class="id" type="var">constructor</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span>} + {<span class="id" type="var">defined</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span>}) -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>,   <span class="id" type="var">Acc</span> (<span class="id" type="var">ddp_step_min</span> <span class="id" type="var">R</span>)  <span class="id" type="var">t</span> -&gt; (<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span>, <span class="id" type="var">direct_subterm</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">s</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">HR</span> <span class="id" type="var">RR</span> <span class="id" type="var">CD</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">Acc_t</span> <span class="id" type="var">IH</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">dp_criterion_min_local</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">IH</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">Acc_t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t</span> <span class="id" type="var">Acc_t</span> <span class="id" type="var">IH</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> [<span class="id" type="var">H</span> [<span class="id" type="var">Hs</span> <span class="id" type="var">Ht</span>]].<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">f</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">t'</span> <span class="id" type="var">K1</span> <span class="id" type="var">K2</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">K2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">s1</span> <span class="id" type="var">t2</span> <span class="id" type="var">sigma</span> <span class="id" type="var">K3</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">K2</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">K3</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">l</span> <span class="id" type="var">r</span> <span class="id" type="var">p</span> <span class="id" type="var">g</span> <span class="id" type="var">k1</span> <span class="id" type="var">K4</span> <span class="id" type="var">Sub</span> <span class="id" type="var">Dg</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">K3</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">subterm_at_pos_dec</span> <span class="id" type="var">t2</span> (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">k1</span>)) <span class="id" type="keyword">as</span> [[<span class="id" type="var">q</span> <span class="id" type="var">Sub'</span>] | <span class="id" type="var">not_Sub</span>].<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">q</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">q</span>].<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">Acc</span> (<span class="id" type="var">ddp_step_min</span> <span class="id" type="var">R</span>) (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l2</span>)).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">cycle_not_acc</span>; <span class="id" type="tactic">split</span>; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Rdp_step</span> <span class="id" type="keyword">with</span> <span class="id" type="var">l2</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Sub'</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">Sub'</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">Sub'</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">Sub'</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">t2</span>.<br/>
<span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Dp</span> <span class="id" type="keyword">with</span> <span class="id" type="var">r</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">i</span> <span class="id" type="var">q</span> <span class="id" type="var">Sub''</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">size_subterm_at_pos</span> (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">k1</span>) <span class="id" type="var">i</span> <span class="id" type="var">q</span>); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Sub''</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">lt_irrefl</span>.<br/>
<span class="id" type="tactic">refine</span> (<span class="id" type="var">rwr_sub_acc_sub_acc_sub</span> <span class="id" type="var">R</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">K1</span> <span class="id" type="var">Ht</span>).<br/>
<span class="id" type="tactic">refine</span> (<span class="id" type="var">rwr_sub_acc_sub_acc_sub</span> <span class="id" type="var">R</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">K1</span> <span class="id" type="var">Ht</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> [<span class="id" type="var">H</span> [<span class="id" type="var">Hu</span> <span class="id" type="var">Hfl2</span>]]; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_inv</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">split</span>; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">split</span>; <span class="id" type="tactic">assumption</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">rwr_subterm_rdp_rdp</span> <span class="id" type="keyword">with</span> <span class="id" type="var">l2</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_incl</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">dp_step</span> <span class="id" type="var">R</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s1</span> <span class="id" type="var">s2</span> [<span class="id" type="var">H</span> <span class="id" type="var">_</span>]; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">acc_one_step_acc_dp</span>; [<span class="id" type="tactic">apply</span> <span class="id" type="var">HR</span> | <span class="id" type="var">idtac</span>].<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">subterm_at_pos_apply_subst_apply_subst_subterm_at_pos</span> <span class="id" type="var">t2</span> (<span class="id" type="var">i</span> :: <span class="id" type="var">q</span>) <span class="id" type="var">sigma</span>).<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Sub'</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="var">subterm_at_pos</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">nth_error_ok_in</span> <span class="id" type="var">i</span> <span class="id" type="var">l2</span>); <span class="id" type="tactic">destruct</span> (<span class="id" type="var">nth_error</span> <span class="id" type="var">l2</span> <span class="id" type="var">i</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">ti</span> | ].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">H</span> <span class="id" type="var">Sub''</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">H</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">l2'</span> [<span class="id" type="var">l2''</span> [<span class="id" type="var">L2</span> <span class="id" type="var">H'</span>]]]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">acc_subterms_3</span> <span class="id" type="keyword">with</span> <span class="id" type="var">q</span> <span class="id" type="var">ti</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">rwr_sub_acc_sub_acc_sub</span> <span class="id" type="var">R</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">K1</span> <span class="id" type="var">Ht</span>); <span class="id" type="tactic">subst</span> <span class="id" type="var">l2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IH</span>;  <span class="id" type="tactic">split</span>; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Rdp_step</span> <span class="id" type="keyword">with</span> <span class="id" type="var">l2</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>.<br/>
<span class="id" type="tactic">split</span>; [<span class="id" type="tactic">apply</span> <span class="id" type="var">Dp</span> <span class="id" type="keyword">with</span> <span class="id" type="var">r</span> <span class="id" type="var">p</span> | <span class="id" type="var">idtac</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">ddp_simple_criterion_local</span> : <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">t</span>, ~ (<span class="id" type="var">R</span> <span class="id" type="var">t</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>))) -&gt; <br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">x</span>, <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">t</span>)) -&gt;<br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span>, {<span class="id" type="var">constructor</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span>} + {<span class="id" type="var">defined</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span>}) -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>,   <span class="id" type="var">Acc</span> (<span class="id" type="var">ddp_step</span> <span class="id" type="var">R</span>)  <span class="id" type="var">t</span> -&gt; (<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span>, <span class="id" type="var">direct_subterm</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">s</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">HR</span> <span class="id" type="var">RR</span> <span class="id" type="var">CD</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">Acc_t</span> <span class="id" type="var">IH</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">ddp_criterion_local</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_incl</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">ddp_step</span> <span class="id" type="var">R</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">clear</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> [<span class="id" type="var">H</span> <span class="id" type="var">_</span>]; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">ddp_criterion</span> : <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">t</span>, ~ (<span class="id" type="var">R</span> <span class="id" type="var">t</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>))) -&gt; <br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">x</span>, <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">t</span>)) -&gt;<br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span>, {<span class="id" type="var">constructor</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span>} + {<span class="id" type="var">defined</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span>}) -&gt;<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">well_founded</span> (<span class="id" type="var">ddp_step_min</span> <span class="id" type="var">R</span>)  -&gt; <span class="id" type="var">well_founded</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">HR</span> <span class="id" type="var">RR</span> <span class="id" type="var">CD</span> <span class="id" type="var">Wf</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">x</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_var</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">ddp_criterion_local</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">acc_one_step_acc_ddp</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">t</span>, ~ (<span class="id" type="var">R</span> <span class="id" type="var">t</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>))) -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>)  <span class="id" type="var">t</span> -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">ddp_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">HR</span> <span class="id" type="var">t</span> <span class="id" type="var">Acc_t</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_incl</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">dp_step</span> <span class="id" type="var">R</span>).<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">t</span> <span class="id" type="var">Acc_t</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Rdp_step</span> <span class="id" type="keyword">with</span> <span class="id" type="var">l2</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">ddp_is_dp</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">acc_one_step_acc_dp</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">ddp_necessary</span> : <br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">t</span>, ~ (<span class="id" type="var">R</span> <span class="id" type="var">t</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>))) -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">well_founded</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>)  -&gt; <span class="id" type="var">well_founded</span> (<span class="id" type="var">ddp_step</span> <span class="id" type="var">R</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">HR</span> <span class="id" type="var">Wf</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">acc_one_step_acc_ddp</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
Dependency chains on well-formed terms, for well-formed systems 
</div>
<div class="code">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">ddp_step_min_wf</span> <span class="id" type="var">R</span> := <span class="id" type="var">rest</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">t</span> =&gt; <span class="id" type="var">acc_sub</span> <span class="id" type="var">R</span> <span class="id" type="var">t</span> /\ <span class="id" type="var">well_formed</span> <span class="id" type="var">t</span>) (<span class="id" type="var">ddp_step</span> <span class="id" type="var">R</span>).<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">well_formed_rdp_step_inv</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> (<span class="id" type="var">R1</span> <span class="id" type="var">R2</span> : <span class="id" type="var">relation</span> <span class="id" type="var">term</span>), <br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span>, <span class="id" type="var">R1</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span> -&gt; <span class="id" type="var">well_formed</span> <span class="id" type="var">u</span> /\ <span class="id" type="var">well_formed</span> <span class="id" type="var">v</span>) -&gt;<br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">R1</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">x</span>, <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">t</span>)) -&gt;<br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span>, <span class="id" type="var">R2</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span> -&gt; <span class="id" type="var">well_formed</span> <span class="id" type="var">u</span> /\ <span class="id" type="var">well_formed</span> <span class="id" type="var">v</span>) -&gt;<br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">R2</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">x</span>, <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">t</span>)) -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">well_formed</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">rdp_step</span> (<span class="id" type="var">axiom</span> <span class="id" type="var">R1</span>) <span class="id" type="var">R2</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">well_formed</span> <span class="id" type="var">s</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R1</span> <span class="id" type="var">R2</span> <span class="id" type="var">W1</span> <span class="id" type="var">R_reg1</span> <span class="id" type="var">W2</span> <span class="id" type="var">R_reg2</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">Wt</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">f</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">t3</span> <span class="id" type="var">H'</span> <span class="id" type="var">H''</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H''</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">s'</span> <span class="id" type="var">u</span> <span class="id" type="var">sigma</span> <span class="id" type="var">H</span> <span class="id" type="var">Hs</span> <span class="id" type="var">Hfl2</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H''</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_apply_subst_strong</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">x_in_s'</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_remove_term</span> <span class="id" type="keyword">with</span> <span class="id" type="var">u</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Hfl2</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">l</span> | <span class="id" type="var">k1</span> <span class="id" type="var">k2</span> <span class="id" type="var">H''</span>]; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_rwr</span> <span class="id" type="keyword">with</span> <span class="id" type="var">R2</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">general_context</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_in_term_is_sound</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">R_reg1</span> <span class="id" type="keyword">with</span> <span class="id" type="var">s'</span>.<br/>
<span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">var_in_term_is_sound</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">W1</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">Ws'</span> <span class="id" type="var">_</span>]; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">well_formed_dp</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> (<span class="id" type="var">R1</span> : <span class="id" type="var">relation</span> <span class="id" type="var">term</span>), <br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span>, <span class="id" type="var">R1</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span> -&gt; <span class="id" type="var">well_formed</span> <span class="id" type="var">u</span> /\ <span class="id" type="var">well_formed</span> <span class="id" type="var">v</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">dp</span> <span class="id" type="var">R1</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">well_formed</span> <span class="id" type="var">s</span> /\  <span class="id" type="var">well_formed</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R1</span> <span class="id" type="var">W1</span> <span class="id" type="var">v</span> <span class="id" type="var">u</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">u'</span> <span class="id" type="var">r</span> <span class="id" type="var">p</span> <span class="id" type="var">g</span> <span class="id" type="var">k</span> <span class="id" type="var">r_R_u</span> <span class="id" type="var">Sub</span> <span class="id" type="var">Dg</span> <span class="id" type="var">H2</span> <span class="id" type="var">H3</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">W1</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">r_R_u</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">Wr</span> <span class="id" type="var">_</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_subterm</span> <span class="id" type="keyword">with</span> <span class="id" type="var">r</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">W1</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">r_R_u</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">_</span> <span class="id" type="var">Wu</span>]; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">reg_dp</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> (<span class="id" type="var">R1</span> : <span class="id" type="var">relation</span> <span class="id" type="var">term</span>), <br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">R1</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">x</span>, <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">t</span>)) -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">dp</span> <span class="id" type="var">R1</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">x</span>, <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">t</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R1</span> <span class="id" type="var">R1_reg</span> <span class="id" type="var">v</span> <span class="id" type="var">u</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">u'</span> <span class="id" type="var">r</span> <span class="id" type="var">p</span> <span class="id" type="var">g</span> <span class="id" type="var">k</span> <span class="id" type="var">r_R_u</span> <span class="id" type="var">Sub</span> <span class="id" type="var">Dg</span> <span class="id" type="var">H2</span> <span class="id" type="var">H3</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">x_in_k</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">R1_reg</span> <span class="id" type="keyword">with</span> <span class="id" type="var">r</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">refine</span> (<span class="id" type="var">var_in_subterm</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">Sub</span> <span class="id" type="var">x_in_k</span>).<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">ddp_criterion_strong_wf_local</span> : <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">t</span>, ~ (<span class="id" type="var">R</span> <span class="id" type="var">t</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>))) -&gt; <br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">x</span>, <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">t</span>)) -&gt;<br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">r</span> <span class="id" type="var">l</span> : <span class="id" type="var">term</span>, <span class="id" type="var">R</span> <span class="id" type="var">r</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="var">well_formed</span> <span class="id" type="var">r</span> /\ <span class="id" type="var">well_formed</span> <span class="id" type="var">l</span>) -&gt; <br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span>, {<span class="id" type="var">constructor</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span>} + {<span class="id" type="var">defined</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span>}) -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">Acc</span> (<span class="id" type="var">ddp_step_min_wf</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span> -&gt; (<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span>, <span class="id" type="var">direct_subterm</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">s</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">well_formed</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">HR</span> <span class="id" type="var">RR</span> <span class="id" type="var">WR</span> <span class="id" type="var">CD</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">Acc_t</span> <span class="id" type="var">Hl</span> <span class="id" type="var">Wt</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">ddp_criterion_local</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">revert</span> <span class="id" type="var">Hl</span> <span class="id" type="var">Wt</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">Acc_t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t</span> <span class="id" type="var">Acc_t</span> <span class="id" type="var">IH</span>].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">Hl</span> <span class="id" type="var">Wt</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> [<span class="id" type="var">H</span> [<span class="id" type="var">Hs</span> <span class="id" type="var">Ht</span>]]; <span class="id" type="tactic">assert</span> (<span class="id" type="var">Ws</span> : <span class="id" type="var">well_formed</span> <span class="id" type="var">s</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_rdp_step_inv</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">ddp</span> <span class="id" type="var">R</span>) <span class="id" type="var">R</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">Hs</span> <span class="id" type="var">Ht</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_dp</span> <span class="id" type="keyword">with</span> <span class="id" type="var">R</span>; [<span class="id" type="tactic">apply</span> <span class="id" type="var">WR</span> | <span class="id" type="tactic">apply</span> <span class="id" type="var">ddp_is_dp</span>; <span class="id" type="tactic">trivial</span>].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">reg_dp</span> <span class="id" type="keyword">with</span> <span class="id" type="var">R</span>; [<span class="id" type="tactic">apply</span> <span class="id" type="var">RR</span> | <span class="id" type="tactic">apply</span> <span class="id" type="var">ddp_is_dp</span>; <span class="id" type="tactic">trivial</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IH</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">split</span>; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">split</span>; <span class="id" type="tactic">split</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">dp_criterion_strong_wf</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">t</span>, ~ (<span class="id" type="var">R</span> <span class="id" type="var">t</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>))) -&gt; <br/>
&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">x</span>, <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">t</span>)) -&gt;<br/>
&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">well_formed</span> <span class="id" type="var">s</span> /\ <span class="id" type="var">well_formed</span> <span class="id" type="var">t</span>) -&gt;<br/>
&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span>, {<span class="id" type="var">constructor</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span>} + {<span class="id" type="var">defined</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span>}) -&gt;<br/>
&nbsp;<span class="id" type="keyword">forall</span> (<span class="id" type="var">inject</span> : <span class="id" type="var">nat</span> -&gt; <span class="id" type="var">variable</span>) (<span class="id" type="var">inject_inv</span> : <span class="id" type="var">variable</span> -&gt; <span class="id" type="var">nat</span>),<br/>
&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">n</span> : <span class="id" type="var">nat</span>, <span class="id" type="var">inject_inv</span> (<span class="id" type="var">inject</span> <span class="id" type="var">n</span>) = <span class="id" type="var">n</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="var">well_founded</span> (<span class="id" type="var">ddp_step_min_wf</span> <span class="id" type="var">R</span>) -&gt; <span class="id" type="var">well_founded</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">HR</span> <span class="id" type="var">RR</span> <span class="id" type="var">WR</span> <span class="id" type="var">CD</span> <span class="id" type="var">inject</span> <span class="id" type="var">inject_inv</span> <span class="id" type="var">Hinj</span> <span class="id" type="var">W</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">acc_well_formed_acc_all</span> <span class="id" type="keyword">with</span> <span class="id" type="var">inject</span> <span class="id" type="var">inject_inv</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_var</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">ddp_criterion_strong_wf_local</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">t_in_l</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">proj1</span> (<span class="id" type="var">well_formed_unfold</span> <span class="id" type="var">H0</span>)); <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
Lifting when the underlying relation is defined as a set of pairs of terms 
</div>
<div class="code">

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">defined_subterms</span> (<span class="id" type="var">is_def</span> : <span class="id" type="var">symbol</span> -&gt; <span class="id" type="var">bool</span>) (<span class="id" type="var">lhs</span> : <span class="id" type="var">term</span>) (<span class="id" type="var">acc</span>: <span class="id" type="var">list</span> <span class="id" type="var">term</span>) (<span class="id" type="var">t</span>:term) {<span class="id" type="keyword">struct</span> <span class="id" type="var">t</span>} := <br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">acc</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">acc'</span> := <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">if</span> <span class="id" type="var">is_def</span> <span class="id" type="var">f</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">then</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">if</span> <span class="id" type="var">eq_bool</span> <span class="id" type="var">lhs</span> <span class="id" type="var">t</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">then</span> <span class="id" type="var">t</span> :: <span class="id" type="var">acc</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">else</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">if</span> <span class="id" type="var">is_subterm</span> <span class="id" type="var">t</span> <span class="id" type="var">lhs</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">then</span> <span class="id" type="var">acc</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">else</span> <span class="id" type="var">t</span> :: <span class="id" type="var">acc</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">else</span> <span class="id" type="var">acc</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">fold_left</span> (<span class="id" type="var">defined_subterms</span> <span class="id" type="var">is_def</span> <span class="id" type="var">lhs</span>) <span class="id" type="var">l</span> <span class="id" type="var">acc'</span> <br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">defined_subterms_accumulates</span> : <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">is_def</span> <span class="id" type="var">lhs</span> <span class="id" type="var">x</span> <span class="id" type="var">acc</span>  <span class="id" type="var">y</span>, <span class="id" type="var">In</span> <span class="id" type="var">y</span> <span class="id" type="var">acc</span> -&gt; <span class="id" type="var">In</span> <span class="id" type="var">y</span> (<span class="id" type="var">defined_subterms</span> <span class="id" type="var">is_def</span> <span class="id" type="var">lhs</span> <span class="id" type="var">acc</span> <span class="id" type="var">x</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">is_def</span> <span class="id" type="var">lhs</span> <span class="id" type="var">x</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">x</span> <span class="id" type="keyword">using</span> <span class="id" type="var">term_rec3</span>;<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">acc</span> <span class="id" type="var">y</span> <span class="id" type="var">y_in_acc</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">fold_left_in_acc</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">acc0</span> <span class="id" type="var">x</span> <span class="id" type="var">y0</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>;<span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> *.<br/>
<span class="id" type="tactic">case</span> (<span class="id" type="var">is_def</span> <span class="id" type="var">f</span>); [ | <span class="id" type="tactic">assumption</span>].<br/>
<span class="id" type="tactic">case</span> (<span class="id" type="var">eq_bool</span> <span class="id" type="var">lhs</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)).<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">is_subterm</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) <span class="id" type="var">lhs</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">Sub</span> | <span class="id" type="var">not_Sub</span>].<br/>
<span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">defined_subterms_is_complete</span>: <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">is_def</span> <span class="id" type="var">lhs</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">r</span> <span class="id" type="var">p</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">acc</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">r</span> <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">is_def</span> <span class="id" type="var">f</span> = <span class="id" type="var">true</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(~exists <span class="id" type="var">i</span>, <span class="id" type="var">exists</span> <span class="id" type="var">p</span>, <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">lhs</span> (<span class="id" type="var">i</span> :: <span class="id" type="var">p</span>) = <span class="id" type="var">Some</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">In</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) (<span class="id" type="var">defined_subterms</span> <span class="id" type="var">is_def</span> <span class="id" type="var">lhs</span> <span class="id" type="var">acc</span> <span class="id" type="var">r</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">is_def</span> <span class="id" type="var">lhs</span> <span class="id" type="var">r</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">r</span> <span class="id" type="keyword">using</span> <span class="id" type="var">term_rec3</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">p</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">acc</span> <span class="id" type="var">H</span> <span class="id" type="var">f_in_def</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">p</span>] <span class="id" type="var">g</span> <span class="id" type="var">k</span> <span class="id" type="var">acc</span> <span class="id" type="var">H'</span> <span class="id" type="var">g_in_def</span> <span class="id" type="var">Sub</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">g</span> <span class="id" type="var">k</span>; <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">fold_left_in_acc</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">defined_subterms_accumulates</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">g_in_def</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">eq_bool_ok</span> <span class="id" type="var">lhs</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)); <span class="id" type="tactic">case</span> (<span class="id" type="var">eq_bool</span> <span class="id" type="var">lhs</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)); [<span class="id" type="tactic">intro</span> <span class="id" type="var">lhs_eq_fl</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">lhs_diff_fl</span>].<br/>
&nbsp;&nbsp;<span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">is_subterm_ok_true</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) <span class="id" type="var">lhs</span>).<br/>
&nbsp;&nbsp;<span class="id" type="tactic">case</span> (<span class="id" type="var">is_subterm</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) <span class="id" type="var">lhs</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">Sub'</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>].<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">False_ind</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Sub</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">Sub'</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) <span class="id" type="keyword">as</span> [[ | <span class="id" type="var">i</span> <span class="id" type="var">p</span>] <span class="id" type="var">Sub''</span>].<br/>
&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Sub''</span>; <span class="id" type="var">absurd</span> (<span class="id" type="var">lhs</span> = <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>); <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">Sub''</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">exists</span> <span class="id" type="var">i</span>; <span class="id" type="var">exists</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">more_list.nth_error_ok_in</span> <span class="id" type="var">i</span> <span class="id" type="var">l</span>).<br/>
&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">nth_error</span> <span class="id" type="var">l</span> <span class="id" type="var">i</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">ti</span> | ].<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">h</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">h</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">l1</span> [<span class="id" type="var">l2</span> [<span class="id" type="var">h1</span> <span class="id" type="var">h2</span>]]]; <span class="id" type="tactic">clear</span> <span class="id" type="var">h</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">fold_left_app</span>; <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">fold_left_in_acc</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span>;  <span class="id" type="tactic">apply</span> <span class="id" type="var">defined_subterms_accumulates</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">H</span> <span class="id" type="keyword">with</span> <span class="id" type="var">p</span>;  <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> *.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">defined_subterms_unfold_gen</span> : <br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">is_def</span> <span class="id" type="var">s</span> <span class="id" type="var">lhs</span> <span class="id" type="var">acc1</span> <span class="id" type="var">acc2</span> <span class="id" type="var">acc1'</span> <span class="id" type="var">acc2'</span>, <br/>
&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">acc1</span> &lt;-&gt; <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">acc1'</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">acc2</span> &lt;-&gt; <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">acc2'</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> (<span class="id" type="var">defined_subterms</span> <span class="id" type="var">is_def</span> <span class="id" type="var">lhs</span> (<span class="id" type="var">acc1</span> ++ <span class="id" type="var">acc2</span>) <span class="id" type="var">s</span>) &lt;-&gt;  <br/>
&nbsp;&nbsp;&nbsp;(<span class="id" type="var">In</span> <span class="id" type="var">t</span> (<span class="id" type="var">defined_subterms</span> <span class="id" type="var">is_def</span> <span class="id" type="var">lhs</span> <span class="id" type="var">acc1'</span> <span class="id" type="var">s</span>) \/ <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">acc2'</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">is_def</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">s</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">lhs</span> <span class="id" type="var">acc1</span> <span class="id" type="var">acc2</span> <span class="id" type="var">acc1'</span> <span class="id" type="var">acc2'</span> <span class="id" type="var">I1</span> <span class="id" type="var">I2</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">I1</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">I2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_app_or</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">I1</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">I2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">IH</span> <span class="id" type="var">lhs</span> <span class="id" type="var">acc1</span> <span class="id" type="var">acc2</span> <span class="id" type="var">acc1'</span> <span class="id" type="var">acc2'</span> <span class="id" type="var">I1</span> <span class="id" type="var">I2</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">set</span> (<span class="id" type="var">fl</span> := <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) <span class="id" type="keyword">in</span> *.<br/>
<span class="id" type="tactic">set</span> (<span class="id" type="var">flacc1</span> :=  (<span class="id" type="keyword">if</span> <span class="id" type="var">is_def</span> <span class="id" type="var">f</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">if</span> <span class="id" type="var">eq_bool</span> <span class="id" type="var">lhs</span> <span class="id" type="var">fl</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">then</span> <span class="id" type="var">fl</span> :: <span class="id" type="var">acc1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">else</span> <span class="id" type="keyword">if</span> <span class="id" type="var">is_subterm</span> <span class="id" type="var">fl</span> <span class="id" type="var">lhs</span> <span class="id" type="keyword">then</span> <span class="id" type="var">acc1</span> <span class="id" type="keyword">else</span> <span class="id" type="var">fl</span> :: <span class="id" type="var">acc1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">else</span> <span class="id" type="var">acc1</span>)) <span class="id" type="keyword">in</span> *.<br/>
<span class="id" type="tactic">replace</span> (<span class="id" type="keyword">if</span> <span class="id" type="var">is_def</span> <span class="id" type="var">f</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">if</span> <span class="id" type="var">eq_bool</span> <span class="id" type="var">lhs</span> <span class="id" type="var">fl</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">then</span> <span class="id" type="var">fl</span> :: <span class="id" type="var">acc1</span> ++ <span class="id" type="var">acc2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">else</span> <span class="id" type="keyword">if</span> <span class="id" type="var">is_subterm</span> <span class="id" type="var">fl</span> <span class="id" type="var">lhs</span> <span class="id" type="keyword">then</span> <span class="id" type="var">acc1</span> ++ <span class="id" type="var">acc2</span> <span class="id" type="keyword">else</span> <span class="id" type="var">fl</span> :: <span class="id" type="var">acc1</span> ++ <span class="id" type="var">acc2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">else</span> <span class="id" type="var">acc1</span> ++ <span class="id" type="var">acc2</span>) <span class="id" type="keyword">with</span> (<span class="id" type="var">flacc1</span> ++ <span class="id" type="var">acc2</span>).<br/>
<span class="id" type="tactic">set</span> (<span class="id" type="var">flacc1'</span> :=  (<span class="id" type="keyword">if</span> <span class="id" type="var">is_def</span> <span class="id" type="var">f</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">if</span> <span class="id" type="var">eq_bool</span> <span class="id" type="var">lhs</span> <span class="id" type="var">fl</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">then</span> <span class="id" type="var">fl</span> :: <span class="id" type="var">acc1'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">else</span> <span class="id" type="keyword">if</span> <span class="id" type="var">is_subterm</span> <span class="id" type="var">fl</span> <span class="id" type="var">lhs</span> <span class="id" type="keyword">then</span> <span class="id" type="var">acc1'</span> <span class="id" type="keyword">else</span> <span class="id" type="var">fl</span> :: <span class="id" type="var">acc1'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">else</span> <span class="id" type="var">acc1'</span>)) <span class="id" type="keyword">in</span> *.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">flI1</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">t</span> : <span class="id" type="var">term</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">flacc1</span> &lt;-&gt; <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">flacc1'</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">flacc1</span>, <span class="id" type="var">flacc1'</span>; <span class="id" type="tactic">case</span> (<span class="id" type="var">is_def</span> <span class="id" type="var">f</span>).<br/>
<span class="id" type="tactic">case</span> (<span class="id" type="var">eq_bool</span> <span class="id" type="var">lhs</span> <span class="id" type="var">fl</span>).<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">I1</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">exact</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">H</span> =&gt; <span class="id" type="var">H</span>).<br/>
<span class="id" type="tactic">case</span> (<span class="id" type="var">is_subterm</span> <span class="id" type="var">fl</span> <span class="id" type="var">lhs</span>).<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">I1</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">exact</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">H</span> =&gt; <span class="id" type="var">H</span>).<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">I1</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">exact</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">H</span> =&gt; <span class="id" type="var">H</span>).<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">I1</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">exact</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">H</span> =&gt; <span class="id" type="var">H</span>).<br/>
<span class="id" type="var">clearbody</span> <span class="id" type="var">flacc1</span>; <span class="id" type="var">clearbody</span> <span class="id" type="var">flacc1'</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">acc1</span> <span class="id" type="var">acc1'</span> <span class="id" type="var">I1</span>.<br/>
<span class="id" type="var">revert</span> <span class="id" type="var">flacc1</span> <span class="id" type="var">acc2</span> <span class="id" type="var">flacc1'</span> <span class="id" type="var">acc2'</span> <span class="id" type="var">flI1</span> <span class="id" type="var">I2</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">s</span> <span class="id" type="var">l</span>]; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">acc1</span> <span class="id" type="var">acc2</span> <span class="id" type="var">acc1'</span> <span class="id" type="var">acc2'</span> <span class="id" type="var">I1</span> <span class="id" type="var">I2</span>.<br/>
<span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">I1</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">I2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_app_or</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">I1</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">I2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>.<br/>
<span class="id" type="tactic">replace</span> (<span class="id" type="var">defined_subterms</span> <span class="id" type="var">is_def</span> <span class="id" type="var">lhs</span> (<span class="id" type="var">acc1</span> ++ <span class="id" type="var">acc2</span>) <span class="id" type="var">s</span>) <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">nil</span> ++ <span class="id" type="var">defined_subterms</span> <span class="id" type="var">is_def</span> <span class="id" type="var">lhs</span> (<span class="id" type="var">acc1</span> ++ <span class="id" type="var">acc2</span>) <span class="id" type="var">s</span>); [ | <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>].<br/>
<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">IHl</span> (<span class="id" type="var">tail_prop</span> <span class="id" type="var">_</span> <span class="id" type="var">IH</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">nil</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">defined_subterms</span> <span class="id" type="var">is_def</span> <span class="id" type="var">lhs</span> (<span class="id" type="var">acc1</span> ++ <span class="id" type="var">acc2</span>) <span class="id" type="var">s</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">nil</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id" type="var">defined_subterms</span> <span class="id" type="var">is_def</span> <span class="id" type="var">lhs</span> <span class="id" type="var">acc1'</span> <span class="id" type="var">s</span>) ++ <span class="id" type="var">acc2'</span>)).<br/>
<span class="id" type="tactic">replace</span> (<span class="id" type="var">defined_subterms</span> <span class="id" type="var">is_def</span> <span class="id" type="var">lhs</span> <span class="id" type="var">acc1'</span> <span class="id" type="var">s</span>) <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">nil</span> ++ <span class="id" type="var">defined_subterms</span> <span class="id" type="var">is_def</span> <span class="id" type="var">lhs</span> <span class="id" type="var">acc1'</span> <span class="id" type="var">s</span>); [ | <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>].<br/>
<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">IHl</span> (<span class="id" type="var">tail_prop</span> <span class="id" type="var">_</span> <span class="id" type="var">IH</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">nil</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">defined_subterms</span> <span class="id" type="var">is_def</span> <span class="id" type="var">lhs</span> <span class="id" type="var">acc1'</span> <span class="id" type="var">s</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">nil</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">defined_subterms</span> <span class="id" type="var">is_def</span> <span class="id" type="var">lhs</span> <span class="id" type="var">acc1'</span> <span class="id" type="var">s</span>)).<br/>
<span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">intros</span> [<span class="id" type="var">H1</span> | <span class="id" type="var">H2</span>].<br/>
<span class="id" type="tactic">do</span> 2 <span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">in_app_or</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H2</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">H3</span> | <span class="id" type="var">H3</span>].<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">intros</span> [[<span class="id" type="var">H1</span> | <span class="id" type="var">H2</span>] | <span class="id" type="var">H3</span>].<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">intro</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">exact</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">H</span> =&gt; <span class="id" type="var">H</span>).<br/>
<span class="id" type="tactic">intro</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">exact</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">H</span> =&gt; <span class="id" type="var">H</span>).<br/>

<br/>
<span class="id" type="tactic">intro</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">exact</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">H</span> =&gt; <span class="id" type="var">H</span>).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">u</span>; <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">IH</span> <span class="id" type="var">_</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) <span class="id" type="var">lhs</span> <span class="id" type="var">acc1</span> <span class="id" type="var">acc2</span> <span class="id" type="var">acc1'</span> <span class="id" type="var">acc2'</span>).<br/>
<span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">in_app_or</span>.<br/>
<span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">flacc1</span>; <span class="id" type="tactic">case</span> (<span class="id" type="var">is_def</span> <span class="id" type="var">f</span>); [ | <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>].<br/>
<span class="id" type="tactic">case</span> (<span class="id" type="var">eq_bool</span> <span class="id" type="var">lhs</span> <span class="id" type="var">fl</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">case</span> (<span class="id" type="var">is_subterm</span> <span class="id" type="var">fl</span> <span class="id" type="var">lhs</span>); <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">defined_subterms_unfold</span> : <br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">is_def</span> <span class="id" type="var">s</span> <span class="id" type="var">lhs</span> <span class="id" type="var">acc</span>, <br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> (<span class="id" type="var">defined_subterms</span> <span class="id" type="var">is_def</span> <span class="id" type="var">lhs</span> <span class="id" type="var">acc</span> <span class="id" type="var">s</span>) &lt;-&gt;  <br/>
&nbsp;&nbsp;&nbsp;(<span class="id" type="var">In</span> <span class="id" type="var">t</span> (<span class="id" type="var">defined_subterms</span> <span class="id" type="var">is_def</span> <span class="id" type="var">lhs</span> <span class="id" type="var">nil</span> <span class="id" type="var">s</span>) \/ <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">acc</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">is_def</span> <span class="id" type="var">s</span> <span class="id" type="var">lhs</span> <span class="id" type="var">acc</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- (<span class="id" type="var">defined_subterms_unfold_gen</span> <span class="id" type="var">is_def</span> <span class="id" type="var">s</span> <span class="id" type="var">lhs</span> <span class="id" type="var">nil</span> <span class="id" type="var">acc</span> <span class="id" type="var">nil</span> <span class="id" type="var">acc</span>).<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">exact</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">H</span> =&gt; <span class="id" type="var">H</span>).<br/>
<span class="id" type="tactic">intro</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">exact</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">H</span> =&gt; <span class="id" type="var">H</span>).<br/>
<span class="id" type="tactic">intro</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">exact</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">H</span> =&gt; <span class="id" type="var">H</span>).<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">fold_left_defined_subterms_unfold</span> : <br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">is_def</span> <span class="id" type="var">lhs</span> <span class="id" type="var">l</span> <span class="id" type="var">acc</span> <span class="id" type="var">t</span>, <br/>
&nbsp;&nbsp;<span class="id" type="var">In</span> <span class="id" type="var">t</span> (<span class="id" type="var">fold_left</span> (<span class="id" type="var">defined_subterms</span> <span class="id" type="var">is_def</span> <span class="id" type="var">lhs</span>) <span class="id" type="var">l</span> <span class="id" type="var">acc</span>) &lt;-&gt;<br/>
&nbsp;&nbsp;<span class="id" type="var">In</span> <span class="id" type="var">t</span> (<span class="id" type="var">fold_left</span> (<span class="id" type="var">defined_subterms</span> <span class="id" type="var">is_def</span> <span class="id" type="var">lhs</span>) <span class="id" type="var">l</span> <span class="id" type="var">nil</span>) \/ <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">acc</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">is_def</span> <span class="id" type="var">lhs</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">s</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">acc</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">split</span>; [<span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">exact</span> <span class="id" type="var">H</span> | <span class="id" type="tactic">intros</span> [<span class="id" type="var">Abs</span> | <span class="id" type="var">H</span>]; [<span class="id" type="var">contradiction</span> | <span class="id" type="tactic">exact</span> <span class="id" type="var">H</span>]].<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">acc</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">IHl</span> (<span class="id" type="var">defined_subterms</span> <span class="id" type="var">is_def</span> <span class="id" type="var">lhs</span> <span class="id" type="var">acc</span> <span class="id" type="var">s</span>)).<br/>
<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">IHl</span> (<span class="id" type="var">defined_subterms</span> <span class="id" type="var">is_def</span> <span class="id" type="var">lhs</span> <span class="id" type="var">nil</span> <span class="id" type="var">s</span>)).<br/>
<span class="id" type="tactic">rewrite</span>  <span class="id" type="var">defined_subterms_unfold</span>.<br/>
<span class="id" type="tactic">intuition</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">defined_subterms_is_sound</span>: <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">is_def</span> <span class="id" type="var">lhs</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">r</span> <span class="id" type="var">g</span> <span class="id" type="var">k</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">In</span> (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">k</span>) (<span class="id" type="var">defined_subterms</span> <span class="id" type="var">is_def</span> <span class="id" type="var">lhs</span> <span class="id" type="var">nil</span> <span class="id" type="var">r</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id" type="var">is_def</span> <span class="id" type="var">g</span> = <span class="id" type="var">true</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">exists</span> <span class="id" type="var">p</span>, <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">r</span> <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">k</span>)) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">i</span> <span class="id" type="var">q</span>, <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">lhs</span> (<span class="id" type="var">i</span> :: <span class="id" type="var">q</span>) &lt;&gt; <span class="id" type="var">Some</span> (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">k</span>))).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">is_def</span> <span class="id" type="var">lhs</span> <span class="id" type="var">r</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">r</span> <span class="id" type="keyword">using</span> <span class="id" type="var">term_rec3</span>;   <span class="id" type="tactic">intros</span> <span class="id" type="var">g</span> <span class="id" type="var">k</span> <span class="id" type="var">gk_in_d</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">gk_in_d</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">fold_left_defined_subterms_unfold</span> <span class="id" type="keyword">in</span> <span class="id" type="var">gk_in_d</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">gk_in_d</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">gk_in_d</span> | <span class="id" type="var">gk_in_d</span>].<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">K</span> : <span class="id" type="var">is_def</span> <span class="id" type="var">g</span> = <span class="id" type="var">true</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">exists</span> <span class="id" type="var">i</span>, <span class="id" type="var">exists</span> <span class="id" type="var">p</span> : <span class="id" type="var">list</span> <span class="id" type="var">nat</span>, <span class="id" type="var">subterm_at_pos</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) (<span class="id" type="var">i</span> :: <span class="id" type="var">p</span>) = <span class="id" type="var">Some</span> (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">k</span>)) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> (<span class="id" type="var">i</span> : <span class="id" type="var">nat</span>) (<span class="id" type="var">q</span> : <span class="id" type="var">list</span> <span class="id" type="var">nat</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">lhs</span> (<span class="id" type="var">i</span> :: <span class="id" type="var">q</span>) &lt;&gt; <span class="id" type="var">Some</span> (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">k</span>))).<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="var">subterm_at_pos</span> <span class="id" type="tactic">at</span> 1.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span>].<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">gk_in_d</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">fold_left_defined_subterms_unfold</span> <span class="id" type="keyword">in</span> <span class="id" type="var">gk_in_d</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">gk_in_d</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">gk_in_d</span> | <span class="id" type="var">gk_in_d</span>].<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">IHl</span> (<span class="id" type="var">tail_prop</span> <span class="id" type="var">_</span> <span class="id" type="var">H</span>) <span class="id" type="var">gk_in_d</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">Dg</span> [[<span class="id" type="var">i</span>  [<span class="id" type="var">p</span> <span class="id" type="var">K1</span>]] <span class="id" type="var">K2</span>]].<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> (<span class="id" type="var">S</span> <span class="id" type="var">i</span>); <span class="id" type="var">exists</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">H</span> <span class="id" type="var">_</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">gk_in_d</span>) <span class="id" type="keyword">as</span>  [<span class="id" type="var">Dg</span> [[<span class="id" type="var">p</span> <span class="id" type="var">K1</span>] <span class="id" type="var">K2</span>]].<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> 0; <span class="id" type="var">exists</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">K</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">Dg</span> [[<span class="id" type="var">i</span>  [<span class="id" type="var">p</span> <span class="id" type="var">K1</span>]] <span class="id" type="var">K2</span>]].<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> (<span class="id" type="var">i</span> :: <span class="id" type="var">p</span>); <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">revert</span> <span class="id" type="var">gk_in_d</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">case_eq</span> (<span class="id" type="var">is_def</span> <span class="id" type="var">f</span>).<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">case_eq</span> (<span class="id" type="var">eq_bool</span> <span class="id" type="var">lhs</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)).<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">lhs_eq_fl</span> <span class="id" type="var">Df</span> [<span class="id" type="var">gk_eq_fl</span> | <span class="id" type="var">gk_in_nil</span>]; [ | <span class="id" type="var">contradiction</span>].<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">gk_eq_fl</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">gk_eq_fl</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> <span class="id" type="var">nil</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">eq_bool_ok</span> <span class="id" type="var">lhs</span> (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">k</span>)); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">lhs_eq_fl</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">lhs_eq_fl</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">lhs_eq_gk</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">lhs_eq_gk</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">i</span> <span class="id" type="var">q</span> <span class="id" type="var">Sub</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">size_subterm_at_pos</span> <span class="id" type="var">lhs</span> <span class="id" type="var">i</span> <span class="id" type="var">q</span>); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Sub</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">lt_irrefl</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">case_eq</span> (<span class="id" type="var">is_subterm</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) <span class="id" type="var">lhs</span>).<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">nSub</span> <span class="id" type="var">lhs_diff_fl</span> <span class="id" type="var">Df</span> [<span class="id" type="var">gk_eq_fl</span> | <span class="id" type="var">gk_in_nil</span>]; [ | <span class="id" type="var">contradiction</span>].<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">gk_eq_fl</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">gk_eq_fl</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> <span class="id" type="var">nil</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">i</span> <span class="id" type="var">q</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">is_subterm_ok_false</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">defined_list</span> (<span class="id" type="var">l</span> : <span class="id" type="var">list</span> (<span class="id" type="var">term</span> * <span class="id" type="var">term</span>))  <span class="id" type="var">acc</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">acc</span><br/>
&nbsp;&nbsp;| (<span class="id" type="var">Var</span> <span class="id" type="var">_</span>, <span class="id" type="var">_</span>) :: <span class="id" type="var">tl</span> =&gt; <span class="id" type="var">defined_list</span> <span class="id" type="var">tl</span> <span class="id" type="var">acc</span> <br/>
&nbsp;&nbsp;| (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">_</span>, <span class="id" type="var">_</span>) :: <span class="id" type="var">tl</span> =&gt; <span class="id" type="var">defined_list</span> <span class="id" type="var">tl</span> (<span class="id" type="var">f</span> :: <span class="id" type="var">acc</span>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">defined_list_complete</span> : <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">rule_list</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">l</span> <span class="id" type="var">r</span>, <span class="id" type="var">R</span> <span class="id" type="var">r</span> <span class="id" type="var">l</span> &lt;-&gt; <span class="id" type="var">In</span> (<span class="id" type="var">l</span>,r) <span class="id" type="var">rule_list</span>) -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span>, <span class="id" type="var">defined</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span>  -&gt; <span class="id" type="var">In</span> <span class="id" type="var">f</span> (<span class="id" type="var">defined_list</span> <span class="id" type="var">rule_list</span> <span class="id" type="var">nil</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">rule_list</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">l</span> <span class="id" type="var">r</span>, <span class="id" type="var">R</span> <span class="id" type="var">r</span> <span class="id" type="var">l</span> &lt;-&gt; <span class="id" type="var">In</span> (<span class="id" type="var">l</span>,r) <span class="id" type="var">rule_list</span>) -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">acc</span>, (<span class="id" type="var">defined</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span> \/ <span class="id" type="var">In</span> <span class="id" type="var">f</span> <span class="id" type="var">acc</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">f</span> (<span class="id" type="var">defined_list</span> <span class="id" type="var">rule_list</span> <span class="id" type="var">acc</span>)).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">Rlist</span>; <span class="id" type="var">revert</span> <span class="id" type="var">R</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">Rlist</span> <span class="id" type="keyword">as</span> [ | [<span class="id" type="var">l1</span> <span class="id" type="var">r1</span>] <span class="id" type="var">Rlist</span>];<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">Rlist_ok</span> <span class="id" type="var">_f</span> <span class="id" type="var">acc</span> [[<span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">t</span> <span class="id" type="var">H</span>] | <span class="id" type="var">f_in_acc</span>].<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Rlist_ok</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Rlist_ok</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">H</span> | <span class="id" type="var">H</span>].<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">IHRlist</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">r</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">In</span> (<span class="id" type="var">l</span>,r) <span class="id" type="var">Rlist</span>)).<br/>
<span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">intro</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">intro</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">l1</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">IHRlist</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">r</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">In</span> (<span class="id" type="var">l</span>,r) <span class="id" type="var">Rlist</span>)).<br/>
<span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">intro</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">intro</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">constructor</span> 1 <span class="id" type="keyword">with</span> <span class="id" type="var">l</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">intro</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">intro</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">constructor</span> 1 <span class="id" type="keyword">with</span> <span class="id" type="var">l</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">l1</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">IHRlist</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">r</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">In</span> (<span class="id" type="var">l</span>,r) <span class="id" type="var">Rlist</span>)).<br/>
<span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">intro</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">intro</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">intro</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">intro</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">do</span> 2 <span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>

<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">Rlist</span> <span class="id" type="var">Rlist_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">Df</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">H</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">Rlist_ok</span>); <span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Defined</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">defined_list_sound</span> : <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">rule_list</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">l</span> <span class="id" type="var">r</span>, <span class="id" type="var">R</span> <span class="id" type="var">r</span> <span class="id" type="var">l</span> &lt;-&gt; <span class="id" type="var">In</span> (<span class="id" type="var">l</span>,r) <span class="id" type="var">rule_list</span>) -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span>, <span class="id" type="var">In</span> <span class="id" type="var">f</span> (<span class="id" type="var">defined_list</span> <span class="id" type="var">rule_list</span> <span class="id" type="var">nil</span>) -&gt; <span class="id" type="var">defined</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span> .<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">rule_list</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">l</span> <span class="id" type="var">r</span>, <span class="id" type="var">R</span> <span class="id" type="var">r</span> <span class="id" type="var">l</span> &lt;-&gt; <span class="id" type="var">In</span> (<span class="id" type="var">l</span>,r) <span class="id" type="var">rule_list</span>) -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">acc</span>, <span class="id" type="var">In</span> <span class="id" type="var">f</span> (<span class="id" type="var">defined_list</span> <span class="id" type="var">rule_list</span> <span class="id" type="var">acc</span>) -&gt; (<span class="id" type="var">defined</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span> \/ <span class="id" type="var">In</span> <span class="id" type="var">f</span> <span class="id" type="var">acc</span>)).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">Rlist</span>; <span class="id" type="var">revert</span> <span class="id" type="var">R</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">Rlist</span> <span class="id" type="keyword">as</span> [ | [<span class="id" type="var">l1</span> <span class="id" type="var">r1</span>] <span class="id" type="var">Rlist</span>];<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">Rlist_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">acc</span> <span class="id" type="var">Df</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Rlist_ok'</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">l</span> <span class="id" type="var">r</span> : <span class="id" type="var">term</span>, <span class="id" type="var">In</span> (<span class="id" type="var">l</span>, <span class="id" type="var">r</span>) <span class="id" type="var">Rlist</span> &lt;-&gt; <span class="id" type="var">In</span> (<span class="id" type="var">l</span>, <span class="id" type="var">r</span>) <span class="id" type="var">Rlist</span>).<br/>
<span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">intro</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">intro</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Df</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">l1</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">f1</span> <span class="id" type="var">l1</span>].<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">IHRlist</span> <span class="id" type="var">_</span> <span class="id" type="var">Rlist_ok'</span> <span class="id" type="var">f</span> <span class="id" type="var">acc</span> <span class="id" type="var">Df</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">Df'</span> | <span class="id" type="var">f_in_acc</span>].<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">Df'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">f'</span> <span class="id" type="var">l</span> <span class="id" type="var">t</span> <span class="id" type="var">H</span>]; <span class="id" type="tactic">subst</span>; <span class="id" type="var">constructor</span> 1 <span class="id" type="keyword">with</span> <span class="id" type="var">l</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Rlist_ok</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">IHRlist</span> <span class="id" type="var">_</span> <span class="id" type="var">Rlist_ok'</span> <span class="id" type="var">f</span> (<span class="id" type="var">f1</span> :: <span class="id" type="var">acc</span>) <span class="id" type="var">Df</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">Df'</span> | <span class="id" type="var">f_in_f1acc</span>].<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">Df'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">f'</span> <span class="id" type="var">l</span> <span class="id" type="var">t</span> <span class="id" type="var">H</span>]; <span class="id" type="tactic">subst</span>; <span class="id" type="var">constructor</span> 1 <span class="id" type="keyword">with</span> <span class="id" type="var">l</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Rlist_ok</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">f_in_f1acc</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">f_in_f1acc</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">f_eq_f1</span> | <span class="id" type="var">f_in_acc</span>].<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">constructor</span> 1 <span class="id" type="keyword">with</span> <span class="id" type="var">l1</span> <span class="id" type="var">r1</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Rlist_ok</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">f1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>

<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">Rlist</span> <span class="id" type="var">Rlist_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">Df</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">H</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">Rlist_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">nil</span> <span class="id" type="var">Df</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">Df'</span> | <span class="id" type="var">f_in_nil</span>]; [<span class="id" type="tactic">assumption</span> | <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="keyword">Defined</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">defined_dec</span> : <br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">rule_list</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">l</span> <span class="id" type="var">r</span>, <span class="id" type="var">R</span> <span class="id" type="var">r</span> <span class="id" type="var">l</span> &lt;-&gt; <span class="id" type="var">In</span> (<span class="id" type="var">l</span>,r) <span class="id" type="var">rule_list</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span>, {<span class="id" type="var">defined</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span>} + { ~ <span class="id" type="var">defined</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span>}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">Rlist</span> <span class="id" type="var">Rlist_ok</span> <span class="id" type="var">f</span>.<br/>
<span class="id" type="var">case_eq</span> (<span class="id" type="var">list_exists</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">lr</span> =&gt; <span class="id" type="keyword">match</span> <span class="id" type="var">fst</span> <span class="id" type="var">lr</span> <span class="id" type="keyword">with</span> <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">false</span> | <span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">eq_symb_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span> <span class="id" type="keyword">end</span>) <span class="id" type="var">Rlist</span>).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">Df</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">list_exists_is_sound</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Df</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">Df</span> <span class="id" type="keyword">as</span> [[<span class="id" type="var">l</span> <span class="id" type="var">r</span>] [<span class="id" type="var">H1</span> <span class="id" type="var">H2</span>]]; <span class="id" type="tactic">destruct</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">g</span>].<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span>); <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">intro</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">g</span>.<br/>
<span class="id" type="var">constructor</span> 1 <span class="id" type="keyword">with</span> <span class="id" type="var">l</span> <span class="id" type="var">r</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Rlist_ok</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">nDf</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">Df</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">Df</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">f'</span> <span class="id" type="var">l</span> <span class="id" type="var">t</span> <span class="id" type="var">H</span>]; <span class="id" type="tactic">subst</span> <span class="id" type="var">f'</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Rlist_ok</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">nDf'</span> := <span class="id" type="var">list_exists_is_complete_false</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">nDf</span> <span class="id" type="var">_</span> <span class="id" type="var">H</span>); <br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">nDf'</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">eq_symb_bool_refl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">nDf'</span>; <span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="keyword">Defined</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">constructor_defined_dec</span> :  <span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">rule_list</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">l</span> <span class="id" type="var">r</span>, <span class="id" type="var">R</span> <span class="id" type="var">r</span> <span class="id" type="var">l</span> &lt;-&gt; <span class="id" type="var">In</span> (<span class="id" type="var">l</span>,r) <span class="id" type="var">rule_list</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span>, {<span class="id" type="var">constructor</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span>} + {<span class="id" type="var">defined</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span>}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">rule_list</span> <span class="id" type="var">H</span> <span class="id" type="var">f</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">defined_dec</span> <span class="id" type="var">R</span> <span class="id" type="var">rule_list</span> <span class="id" type="var">H</span> <span class="id" type="var">f</span>).<br/>
&nbsp;&nbsp;<span class="id" type="var">right</span>;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">left</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">constructor</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span>;<span class="id" type="tactic">intro</span> <span class="id" type="var">abs</span>;<span class="id" type="tactic">apply</span> <span class="id" type="var">n</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">Def</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">t</span> <span class="id" type="var">abs</span>).<br/>
<span class="id" type="keyword">Defined</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">ddp_rule</span> <span class="id" type="var">is_def</span>  (<span class="id" type="var">lhs</span> <span class="id" type="var">rhs</span>:term) := <br/>
&nbsp;&nbsp;<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">r</span> =&gt; (<span class="id" type="var">lhs</span>,r)) (<span class="id" type="var">defined_subterms</span> <span class="id" type="var">is_def</span> <span class="id" type="var">lhs</span> (@<span class="id" type="var">nil</span> <span class="id" type="var">term</span>) <span class="id" type="var">rhs</span>).<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">ddp_list</span> <span class="id" type="var">is_def</span> <span class="id" type="var">rule_list</span> := <br/>
&nbsp;&nbsp;<span class="id" type="var">fold_left</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">acc</span> (<span class="id" type="var">rule</span> : <span class="id" type="var">term</span>*term) =&gt; (<span class="id" type="keyword">let</span> (<span class="id" type="var">lhs</span>,rhs) := <span class="id" type="var">rule</span> <span class="id" type="keyword">in</span> (<span class="id" type="var">ddp_rule</span> <span class="id" type="var">is_def</span> <span class="id" type="var">lhs</span> <span class="id" type="var">rhs</span>))++acc)<br/>
&nbsp;&nbsp;<span class="id" type="var">rule_list</span> (@<span class="id" type="var">nil</span> (<span class="id" type="var">term</span>*term)).<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">ddp_list_is_complete</span> : <br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">rule_list</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">l</span> <span class="id" type="var">r</span>, <span class="id" type="var">R</span> <span class="id" type="var">r</span> <span class="id" type="var">l</span> &lt;-&gt; <span class="id" type="var">In</span> (<span class="id" type="var">l</span>,r) <span class="id" type="var">rule_list</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">is_def</span>,   (<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span>, <span class="id" type="var">is_def</span> <span class="id" type="var">f</span> = <span class="id" type="var">true</span> &lt;-&gt; <span class="id" type="var">defined</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span>, <span class="id" type="var">ddp</span> <span class="id" type="var">R</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">In</span> (<span class="id" type="var">y</span>,x) (<span class="id" type="var">ddp_list</span> <span class="id" type="var">is_def</span> <span class="id" type="var">rule_list</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">Rlist</span> <span class="id" type="var">Rlist_ok</span> <span class="id" type="var">is_def</span> <span class="id" type="var">is_def_ok</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span> [<span class="id" type="var">H</span> <span class="id" type="var">Sub</span>].<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">ll</span> <span class="id" type="var">r</span> <span class="id" type="var">p</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">K</span> <span class="id" type="var">Sub'</span> <span class="id" type="var">Df</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Rlist_ok</span> <span class="id" type="keyword">in</span> <span class="id" type="var">K</span>.<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">Rlist_ok</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">Rlist</span> <span class="id" type="keyword">as</span> [ | [<span class="id" type="var">l1</span> <span class="id" type="var">r1</span>] <span class="id" type="var">Rlist</span>].<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">K</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">K</span> | <span class="id" type="var">K</span>].<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">ddp_list</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">fold_left_in_acc</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">acc</span> [<span class="id" type="var">a</span> <span class="id" type="var">b</span>] <span class="id" type="var">z</span> <span class="id" type="var">z_in_acc</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">ddp_rule</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>.<br/>
<span class="id" type="var">exists</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>); <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">defined_subterms_is_complete</span> <span class="id" type="keyword">with</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">is_def_ok</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">intros</span> [<span class="id" type="var">i</span> [<span class="id" type="var">q</span> <span class="id" type="var">Sub''</span>]]; <span class="id" type="tactic">apply</span> (<span class="id" type="var">Sub</span> <span class="id" type="var">i</span> <span class="id" type="var">q</span> <span class="id" type="var">Sub''</span>).<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">ddp_list</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">replace</span> (<span class="id" type="var">ddp_rule</span> <span class="id" type="var">is_def</span> <span class="id" type="var">l1</span> <span class="id" type="var">r1</span> ++ <span class="id" type="var">nil</span>) <span class="id" type="keyword">with</span> (<span class="id" type="var">nil</span> ++ (<span class="id" type="var">ddp_rule</span> <span class="id" type="var">is_def</span> <span class="id" type="var">l1</span> <span class="id" type="var">r1</span> ++ <span class="id" type="var">nil</span>)); [ | <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>].<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">fold_left_in_acc_split</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHRlist</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">ddp_list_is_sound</span> : <br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">rule_list</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">l</span> <span class="id" type="var">r</span>, <span class="id" type="var">R</span> <span class="id" type="var">r</span> <span class="id" type="var">l</span> &lt;-&gt; <span class="id" type="var">In</span> (<span class="id" type="var">l</span>,r) <span class="id" type="var">rule_list</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">is_def</span>,   (<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span>, <span class="id" type="var">is_def</span> <span class="id" type="var">f</span> = <span class="id" type="var">true</span> &lt;-&gt; <span class="id" type="var">defined</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span>, <span class="id" type="var">In</span> (<span class="id" type="var">y</span>,x) (<span class="id" type="var">ddp_list</span> <span class="id" type="var">is_def</span> <span class="id" type="var">rule_list</span>) -&gt; <span class="id" type="var">ddp</span> <span class="id" type="var">R</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H'</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">Rlist</span> <span class="id" type="var">is_def</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span>, <span class="id" type="var">In</span> (<span class="id" type="var">y</span>, <span class="id" type="var">x</span>) (<span class="id" type="var">ddp_list</span> <span class="id" type="var">is_def</span> <span class="id" type="var">Rlist</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">exists</span> <span class="id" type="var">t2</span>, <span class="id" type="var">exists</span> <span class="id" type="var">f2</span>, <span class="id" type="var">exists</span> <span class="id" type="var">l2</span>, <span class="id" type="var">exists</span> <span class="id" type="var">p</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">x</span> = <span class="id" type="var">Term</span> <span class="id" type="var">f2</span> <span class="id" type="var">l2</span> /\ <span class="id" type="var">In</span> (<span class="id" type="var">y</span>,t2) <span class="id" type="var">Rlist</span> /\  <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">t2</span> <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f2</span> <span class="id" type="var">l2</span>)  /\ <span class="id" type="var">is_def</span> <span class="id" type="var">f2</span> = <span class="id" type="var">true</span> ) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">i</span> <span class="id" type="var">p</span>, <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">y</span> (<span class="id" type="var">i</span> :: <span class="id" type="var">p</span>) &lt;&gt; <span class="id" type="var">Some</span> <span class="id" type="var">x</span>)).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">Rlist</span> <span class="id" type="var">is_def</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">Rlist</span> <span class="id" type="keyword">as</span>  [ | [<span class="id" type="var">l1</span> <span class="id" type="var">r1</span>] <span class="id" type="var">Rlist</span>].<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">ddp_list</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">app_nil_end</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">replace</span> (<span class="id" type="var">ddp_rule</span> <span class="id" type="var">is_def</span> <span class="id" type="var">l1</span> <span class="id" type="var">r1</span>) <span class="id" type="keyword">with</span> (<span class="id" type="var">nil</span> ++ <span class="id" type="var">ddp_rule</span> <span class="id" type="var">is_def</span> <span class="id" type="var">l1</span> <span class="id" type="var">r1</span>) <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; [ | <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>].<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">fold_left_in_acc_split</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">H</span> | <span class="id" type="var">H</span>].<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">IHRlist</span> <span class="id" type="var">H</span>) <span class="id" type="keyword">as</span> [[<span class="id" type="var">t2</span> [<span class="id" type="var">f2</span> [ <span class="id" type="var">l2</span> [<span class="id" type="var">p</span> [<span class="id" type="var">H1</span> [<span class="id" type="var">H2</span> <span class="id" type="var">H3</span>]]]]]] <span class="id" type="var">H4</span>].<br/>
<span class="id" type="tactic">split</span>; [ | <span class="id" type="tactic">assumption</span>].<br/>
<span class="id" type="var">exists</span> <span class="id" type="var">t2</span>; <span class="id" type="var">exists</span> <span class="id" type="var">f2</span>; <span class="id" type="var">exists</span> <span class="id" type="var">l2</span>; <span class="id" type="var">exists</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">split</span>; [<span class="id" type="var">right</span> | ]; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">IHRlist</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">ddp_rule</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x'</span> [<span class="id" type="var">H1</span> <span class="id" type="var">H2</span>]].<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">x</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x</span> | <span class="id" type="var">g</span> <span class="id" type="var">k</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>.<br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">r1</span> <span class="id" type="keyword">using</span> <span class="id" type="var">term_rec3</span>.<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">fold_left_defined_subterms_unfold</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H2</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">H2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">H2</span> | <span class="id" type="var">H2</span>].<br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">fold_left_defined_subterms_unfold</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H2</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">H2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">H2</span> | <span class="id" type="var">H2</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>; [ | <span class="id" type="tactic">assumption</span>].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">u_in_l</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">H</span> <span class="id" type="var">u</span>); <span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">H</span> <span class="id" type="var">_</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>))); <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="var">revert</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">case</span> (<span class="id" type="var">is_def</span> <span class="id" type="var">f</span>).<br/>
<span class="id" type="tactic">case</span> (<span class="id" type="var">eq_bool</span> <span class="id" type="var">y</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)).<br/>
<span class="id" type="tactic">intros</span> [<span class="id" type="var">H1</span> | <span class="id" type="var">H2</span>]; [<span class="id" type="tactic">discriminate</span> | <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">case</span> (<span class="id" type="var">is_subterm</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) <span class="id" type="var">y</span>).<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">intros</span> [<span class="id" type="var">H1</span> | <span class="id" type="var">H2</span>]; [<span class="id" type="tactic">discriminate</span> | <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">defined_subterms_is_sound</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H2</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">Dg</span> [[<span class="id" type="var">p</span> <span class="id" type="var">Sub</span>] <span class="id" type="var">K2</span>]].<br/>
<span class="id" type="tactic">split</span>; [ | <span class="id" type="tactic">assumption</span>].<br/>
<span class="id" type="var">exists</span> <span class="id" type="var">r1</span>; <span class="id" type="var">exists</span> <span class="id" type="var">g</span>; <span class="id" type="var">exists</span> <span class="id" type="var">k</span>; <span class="id" type="var">exists</span> <span class="id" type="var">p</span>.<br/>
<span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">split</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">split</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">Rlist</span> <span class="id" type="var">Rlist_ok</span> <span class="id" type="var">is_def</span> <span class="id" type="var">is_def_ok</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">H'</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H</span>) <span class="id" type="keyword">as</span> [[<span class="id" type="var">t2</span> [<span class="id" type="var">f2</span> [<span class="id" type="var">l2</span> [<span class="id" type="var">p</span> [<span class="id" type="var">H1</span> [<span class="id" type="var">H2</span> [<span class="id" type="var">H3</span> <span class="id" type="var">H4</span>]]]]]]] <span class="id" type="var">H5</span>].<br/>
<span class="id" type="tactic">split</span>; [ | <span class="id" type="tactic">assumption</span>].<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">x</span>; <span class="id" type="var">constructor</span> 1 <span class="id" type="keyword">with</span> <span class="id" type="var">t2</span> <span class="id" type="var">p</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Rlist_ok</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">is_def_ok</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">dp_criterion_lift</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">rule_list</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">l</span> <span class="id" type="var">r</span>, <span class="id" type="var">R</span> <span class="id" type="var">r</span> <span class="id" type="var">l</span> &lt;-&gt; <span class="id" type="var">In</span> (<span class="id" type="var">l</span>,r) <span class="id" type="var">rule_list</span>) -&gt;<br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">l</span> <span class="id" type="var">r</span>, <span class="id" type="var">In</span> (<span class="id" type="var">l</span>,r) <span class="id" type="var">rule_list</span> -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">v</span>, <span class="id" type="var">l</span> &lt;&gt; <span class="id" type="var">Var</span> <span class="id" type="var">v</span>) -&gt;<br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">l</span> <span class="id" type="var">r</span>, <span class="id" type="var">In</span> (<span class="id" type="var">l</span>,r) <span class="id" type="var">rule_list</span> -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">v</span>, <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">r</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">l</span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">well_founded</span> (<span class="id" type="var">ddp_step_min</span> <span class="id" type="var">R</span>)  -&gt; <span class="id" type="var">well_founded</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">rule_list</span> <span class="id" type="var">Equiv</span> <span class="id" type="var">R_var</span> <span class="id" type="var">R_reg</span> <span class="id" type="var">Wf</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">ddp_criterion</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">t</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Equiv</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">R_var</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>) <span class="id" type="var">t</span> <span class="id" type="var">H</span> <span class="id" type="var">x</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Equiv</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">R_reg</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span> <span class="id" type="var">H</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">constructor_defined_dec</span> <span class="id" type="keyword">with</span> <span class="id" type="var">rule_list</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Section</span> <span class="id" type="var">Marked_DP</span>.<br/>

<br/>
<span class="id" type="keyword">Variable</span> <span class="id" type="var">R</span> : <span class="id" type="var">relation</span> <span class="id" type="var">term</span>.<br/>
<span class="id" type="keyword">Variable</span> <span class="id" type="var">R_var</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">t</span>, ~R <span class="id" type="var">t</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>).<br/>
<span class="id" type="keyword">Variable</span> <span class="id" type="var">mark</span> : <span class="id" type="var">symbol</span> -&gt; <span class="id" type="var">symbol</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">mark_term</span> (<span class="id" type="var">t</span> : <span class="id" type="var">term</span>) : <span class="id" type="var">term</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">x</span> =&gt; <span class="id" type="var">Var</span> <span class="id" type="var">x</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">Term</span> (<span class="id" type="var">mark</span> <span class="id" type="var">f</span>) <span class="id" type="var">l</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">mrel</span> (<span class="id" type="var">P</span> : <span class="id" type="var">relation</span> <span class="id" type="var">term</span>) : <span class="id" type="var">relation</span> <span class="id" type="var">term</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">Mrel</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">P</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; <span class="id" type="var">mrel</span> <span class="id" type="var">P</span> (<span class="id" type="var">mark_term</span> <span class="id" type="var">t1</span>) (<span class="id" type="var">mark_term</span> <span class="id" type="var">t2</span>).<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">x_to_x2_commutes_mark</span> : <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">sigma</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>, <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">mark_term</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)) =  (<span class="id" type="var">mark_term</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>))).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">sigma</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">rdp_step_rmdp_step</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> (<span class="id" type="var">dpR</span> : <span class="id" type="var">relation</span> <span class="id" type="var">term</span>), <br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span>, <span class="id" type="var">dpR</span> <span class="id" type="var">v</span> <span class="id" type="var">u</span> -&gt; <span class="id" type="var">dp</span> <span class="id" type="var">R</span> <span class="id" type="var">v</span> <span class="id" type="var">u</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">rdp_step</span> (<span class="id" type="var">axiom</span> <span class="id" type="var">dpR</span>) <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">rdp_step</span> (<span class="id" type="var">axiom</span> (<span class="id" type="var">mrel</span> <span class="id" type="var">dpR</span>)) <span class="id" type="var">R</span> (<span class="id" type="var">mark_term</span> <span class="id" type="var">s</span>) (<span class="id" type="var">mark_term</span> <span class="id" type="var">t</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">dpR</span> <span class="id" type="var">dpR_in_dpR</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">H</span>.<br/>

<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">f</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">_s</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">H3</span> <span class="id" type="var">H4</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Rdp_step</span> <span class="id" type="keyword">with</span> <span class="id" type="var">l2</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v</span> <span class="id" type="var">u</span> <span class="id" type="var">sigma</span> <span class="id" type="var">K1</span> <span class="id" type="var">K2</span> <span class="id" type="var">K3</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">K1'</span> := <span class="id" type="var">dpR_in_dpR</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">K1</span>); <br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">K1'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">p</span> <span class="id" type="var">f2</span> <span class="id" type="var">k2</span> <span class="id" type="var">H</span> <span class="id" type="var">Sub</span> <span class="id" type="var">Df2</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">K1'</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">u</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">xu</span> | <span class="id" type="var">fu</span> <span class="id" type="var">lu</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">R_var</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H</span>).<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">K3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">K3</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">instance</span> (<span class="id" type="var">mrel</span> <span class="id" type="var">dpR</span>) (<span class="id" type="var">Term</span> (<span class="id" type="var">mark</span> <span class="id" type="var">f2</span>) <span class="id" type="var">k2</span>) (<span class="id" type="var">Term</span> (<span class="id" type="var">mark</span> <span class="id" type="var">f</span>) <span class="id" type="var">lu</span>) <span class="id" type="var">sigma</span>).<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">Mrel</span> <span class="id" type="var">dpR</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f2</span> <span class="id" type="var">k2</span>) (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">lu</span>)).<br/>
<span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">mdp_criterion_local</span> : <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> (<span class="id" type="var">dpR</span> : <span class="id" type="var">relation</span> <span class="id" type="var">term</span>), <br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span>, <span class="id" type="var">dpR</span> <span class="id" type="var">v</span> <span class="id" type="var">u</span> -&gt; <span class="id" type="var">dp</span> <span class="id" type="var">R</span> <span class="id" type="var">v</span> <span class="id" type="var">u</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span>, <span class="id" type="var">Acc</span> (<span class="id" type="var">rdp_step</span> (<span class="id" type="var">axiom</span> (<span class="id" type="var">mrel</span> <span class="id" type="var">dpR</span>)) <span class="id" type="var">R</span>)  (<span class="id" type="var">mark_term</span> <span class="id" type="var">s</span>) -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Acc</span> (<span class="id" type="var">rdp_step</span> (<span class="id" type="var">axiom</span> <span class="id" type="var">dpR</span>) <span class="id" type="var">R</span>) <span class="id" type="var">s</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">dpR</span> <span class="id" type="var">dpR_in_dpR</span> <span class="id" type="var">t</span> <span class="id" type="var">Acc_t</span>.<br/>
<span class="id" type="tactic">set</span> (<span class="id" type="var">t'</span> := <span class="id" type="var">mark_term</span> <span class="id" type="var">t</span>) <span class="id" type="keyword">in</span> *; <br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Tt</span> := <span class="id" type="var">refl_equal</span> <span class="id" type="var">t'</span>); <span class="id" type="tactic">unfold</span> <span class="id" type="var">t'</span> <span class="id" type="tactic">at</span> 2 <span class="id" type="keyword">in</span> <span class="id" type="var">Tt</span>; <span class="id" type="var">clearbody</span> <span class="id" type="var">t'</span>.<br/>
<span class="id" type="var">revert</span> <span class="id" type="var">t</span> <span class="id" type="var">Tt</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">Acc_t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t'</span> <span class="id" type="var">Acc_t</span> <span class="id" type="var">IH</span>].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">H'</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IH</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">mark_term</span> <span class="id" type="var">s</span>); [ | <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>].<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">t'</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">rdp_step_rmdp_step</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">mdp_criterion</span> : <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> (<span class="id" type="var">dpR</span> : <span class="id" type="var">relation</span> <span class="id" type="var">term</span>), <br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span>, <span class="id" type="var">dpR</span> <span class="id" type="var">v</span> <span class="id" type="var">u</span> -&gt; <span class="id" type="var">dp</span> <span class="id" type="var">R</span> <span class="id" type="var">v</span> <span class="id" type="var">u</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">well_founded</span> (<span class="id" type="var">rdp_step</span> (<span class="id" type="var">axiom</span> (<span class="id" type="var">mrel</span> <span class="id" type="var">dpR</span>)) <span class="id" type="var">R</span>)  -&gt;  <br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">well_founded</span> (<span class="id" type="var">rdp_step</span> (<span class="id" type="var">axiom</span> <span class="id" type="var">dpR</span>) <span class="id" type="var">R</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">dpR</span> <span class="id" type="var">dpR_in_dpR</span> <span class="id" type="var">W</span> <span class="id" type="var">t</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">mdp_criterion_local</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">mdp_criterion_local_strong</span> : <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> (<span class="id" type="var">dpR</span> : <span class="id" type="var">relation</span> <span class="id" type="var">term</span>), <br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span>, <span class="id" type="var">dpR</span> <span class="id" type="var">v</span> <span class="id" type="var">u</span> -&gt; <span class="id" type="var">dp</span> <span class="id" type="var">R</span> <span class="id" type="var">v</span> <span class="id" type="var">u</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span>, <span class="id" type="var">Acc</span> (<span class="id" type="var">rest</span> (<span class="id" type="var">acc_sub</span> <span class="id" type="var">R</span>) (<span class="id" type="var">rdp_step</span> (<span class="id" type="var">axiom</span> (<span class="id" type="var">mrel</span> <span class="id" type="var">dpR</span>)) <span class="id" type="var">R</span>)) (<span class="id" type="var">mark_term</span> <span class="id" type="var">s</span>) -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Acc</span> (<span class="id" type="var">rest</span> (<span class="id" type="var">acc_sub</span> <span class="id" type="var">R</span>) (<span class="id" type="var">rdp_step</span> (<span class="id" type="var">axiom</span> <span class="id" type="var">dpR</span>) <span class="id" type="var">R</span>)) <span class="id" type="var">s</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">dpR</span> <span class="id" type="var">dpR_in_dpR</span> <span class="id" type="var">t</span> <span class="id" type="var">Acc_t</span>.<br/>
<span class="id" type="tactic">set</span> (<span class="id" type="var">t'</span> := <span class="id" type="var">mark_term</span> <span class="id" type="var">t</span>) <span class="id" type="keyword">in</span> *; <br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Tt</span> := <span class="id" type="var">refl_equal</span> <span class="id" type="var">t'</span>); <span class="id" type="tactic">unfold</span> <span class="id" type="var">t'</span> <span class="id" type="tactic">at</span> 2 <span class="id" type="keyword">in</span> <span class="id" type="var">Tt</span>; <span class="id" type="var">clearbody</span> <span class="id" type="var">t'</span>.<br/>
<span class="id" type="var">revert</span> <span class="id" type="var">t</span> <span class="id" type="var">Tt</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">Acc_t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t'</span> <span class="id" type="var">Acc_t</span> <span class="id" type="var">IH</span>].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">H'</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IH</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">mark_term</span> <span class="id" type="var">s</span>); [ | <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>].<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">t'</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">H'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">H'</span> <span class="id" type="var">Hmin</span>]; <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">rdp_step_rmdp_step</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">mdp_criterion_strong</span> : <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> (<span class="id" type="var">dpR</span> : <span class="id" type="var">relation</span> <span class="id" type="var">term</span>), <br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span>, <span class="id" type="var">dpR</span> <span class="id" type="var">v</span> <span class="id" type="var">u</span> -&gt; <span class="id" type="var">dp</span> <span class="id" type="var">R</span> <span class="id" type="var">v</span> <span class="id" type="var">u</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">well_founded</span> (<span class="id" type="var">rest</span> (<span class="id" type="var">acc_sub</span> <span class="id" type="var">R</span>) (<span class="id" type="var">rdp_step</span> (<span class="id" type="var">axiom</span> (<span class="id" type="var">mrel</span> <span class="id" type="var">dpR</span>)) <span class="id" type="var">R</span>))  -&gt;  <br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">well_founded</span> (<span class="id" type="var">rest</span> (<span class="id" type="var">acc_sub</span> <span class="id" type="var">R</span>) (<span class="id" type="var">rdp_step</span> (<span class="id" type="var">axiom</span> <span class="id" type="var">dpR</span>) <span class="id" type="var">R</span>)).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">dpR</span> <span class="id" type="var">dpR_in_dpR</span> <span class="id" type="var">W</span> <span class="id" type="var">t</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">mdp_criterion_local_strong</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">TT</span> :  (<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span>, <span class="id" type="var">mark</span> (<span class="id" type="var">mark</span> <span class="id" type="var">f</span>) = <span class="id" type="var">f</span>) -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">t</span> = <span class="id" type="var">mark_term</span> (<span class="id" type="var">mark_term</span> <span class="id" type="var">t</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">mark_inv</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">t</span>; [<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">simpl</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">mark_inv</span>]; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">mrdp_step_rdp_step</span> :<br/>
&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span>, <span class="id" type="var">mark</span> (<span class="id" type="var">mark</span> <span class="id" type="var">f</span>) = <span class="id" type="var">f</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> (<span class="id" type="var">dpR</span> : <span class="id" type="var">relation</span> <span class="id" type="var">term</span>), <br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span>, <span class="id" type="var">dpR</span> <span class="id" type="var">v</span> <span class="id" type="var">u</span> -&gt; <span class="id" type="var">dp</span> <span class="id" type="var">R</span> <span class="id" type="var">v</span> <span class="id" type="var">u</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">rdp_step</span> (<span class="id" type="var">axiom</span> (<span class="id" type="var">mrel</span> <span class="id" type="var">dpR</span>)) <span class="id" type="var">R</span> (<span class="id" type="var">mark_term</span> <span class="id" type="var">s</span>) (<span class="id" type="var">mark_term</span> <span class="id" type="var">t</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">rdp_step</span> (<span class="id" type="var">axiom</span> <span class="id" type="var">dpR</span>) <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">mark_inv</span> <span class="id" type="var">dpR</span> <span class="id" type="var">dpR_in_dpR</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">_f</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">_s</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">H3</span> <span class="id" type="var">H4</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">f</span> <span class="id" type="var">l1'</span>]; [<span class="id" type="tactic">discriminate</span> | <span class="id" type="tactic">injection</span> <span class="id" type="var">H4</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H4</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">_f</span> <span class="id" type="var">l1'</span>].<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Rdp_step</span> <span class="id" type="keyword">with</span> <span class="id" type="var">l2</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">_v</span> <span class="id" type="var">_u</span> <span class="id" type="var">sigma</span> <span class="id" type="var">_K1</span> <span class="id" type="var">K2</span> <span class="id" type="var">K3</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">_K1</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v</span> <span class="id" type="var">u</span> <span class="id" type="var">K1</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">_K1</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">K1'</span> := <span class="id" type="var">dpR_in_dpR</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">K1</span>); <br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">K1'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">p</span> <span class="id" type="var">f2</span> <span class="id" type="var">k2</span> <span class="id" type="var">H</span> <span class="id" type="var">Sub</span> <span class="id" type="var">Df2</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">K1'</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">u</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">xu</span> | <span class="id" type="var">fu</span> <span class="id" type="var">lu</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">R_var</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H</span>).<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">K3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">K3</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">_K2</span> := <span class="id" type="tactic">f_equal</span> <span class="id" type="var">mark_term</span> <span class="id" type="var">K2</span>); <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">_K2</span>; <span class="id" type="tactic">rewrite</span> &lt;- (<span class="id" type="var">TT</span> <span class="id" type="var">mark_inv</span>) <span class="id" type="keyword">in</span> <span class="id" type="var">_K2</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">mark_inv</span> <span class="id" type="keyword">in</span> <span class="id" type="var">_K2</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">_K2</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">instance</span> <span class="id" type="var">dpR</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f2</span> <span class="id" type="var">k2</span>) (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">lu</span>) <span class="id" type="var">sigma</span>).<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">_H2</span> := <span class="id" type="tactic">f_equal</span> <span class="id" type="var">mark</span> <span class="id" type="var">H2</span>); <span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> <span class="id" type="var">mark_inv</span> <span class="id" type="keyword">in</span> <span class="id" type="var">_H2</span>.<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">f</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">mdp_reverted_criterion_local_strong</span> : <br/>
&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span>, <span class="id" type="var">mark</span> (<span class="id" type="var">mark</span> <span class="id" type="var">f</span>) = <span class="id" type="var">f</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> (<span class="id" type="var">dpR</span> : <span class="id" type="var">relation</span> <span class="id" type="var">term</span>), <br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span>, <span class="id" type="var">dpR</span> <span class="id" type="var">v</span> <span class="id" type="var">u</span> -&gt; <span class="id" type="var">dp</span> <span class="id" type="var">R</span> <span class="id" type="var">v</span> <span class="id" type="var">u</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span>, <span class="id" type="var">Acc</span> (<span class="id" type="var">rest</span> (<span class="id" type="var">acc_sub</span> <span class="id" type="var">R</span>) (<span class="id" type="var">rdp_step</span> (<span class="id" type="var">axiom</span> <span class="id" type="var">dpR</span>) <span class="id" type="var">R</span>)) <span class="id" type="var">s</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Acc</span> (<span class="id" type="var">rest</span> (<span class="id" type="var">acc_sub</span> <span class="id" type="var">R</span>) (<span class="id" type="var">rdp_step</span> (<span class="id" type="var">axiom</span> (<span class="id" type="var">mrel</span> <span class="id" type="var">dpR</span>)) <span class="id" type="var">R</span>)) (<span class="id" type="var">mark_term</span> <span class="id" type="var">s</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">mark_inv</span> <span class="id" type="var">dpR</span> <span class="id" type="var">dpR_in_dpR</span> <span class="id" type="var">t</span> <span class="id" type="var">Acc_t</span>.<br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">Acc_t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t'</span> <span class="id" type="var">Acc_t</span> <span class="id" type="var">IH</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">H'</span>.<br/>
<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">TT</span> <span class="id" type="var">mark_inv</span>); <span class="id" type="tactic">apply</span> <span class="id" type="var">IH</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">H'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">H'</span> <span class="id" type="var">Hmin</span>]; <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">mrdp_step_rdp_step</span> <span class="id" type="var">mark_inv</span> <span class="id" type="var">_</span> <span class="id" type="var">dpR_in_dpR</span>); <span class="id" type="tactic">rewrite</span> &lt;- (<span class="id" type="var">TT</span> <span class="id" type="var">mark_inv</span> <span class="id" type="var">s</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">t'</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">mdp_strong_necessary_local</span> : <br/>
&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span>, <span class="id" type="var">mark</span> (<span class="id" type="var">mark</span> <span class="id" type="var">f</span>) = <span class="id" type="var">f</span>) -&gt;<br/>
&nbsp;<span class="id" type="keyword">forall</span> (<span class="id" type="var">dpR</span> : <span class="id" type="var">relation</span> <span class="id" type="var">term</span>), <br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span>, <span class="id" type="var">dpR</span> <span class="id" type="var">v</span> <span class="id" type="var">u</span> -&gt; <span class="id" type="var">dp</span> <span class="id" type="var">R</span> <span class="id" type="var">v</span> <span class="id" type="var">u</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">well_founded</span> (<span class="id" type="var">rest</span> (<span class="id" type="var">acc_sub</span> <span class="id" type="var">R</span>) (<span class="id" type="var">rdp_step</span> (<span class="id" type="var">axiom</span> <span class="id" type="var">dpR</span>) <span class="id" type="var">R</span>))  -&gt;  <br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">well_founded</span> (<span class="id" type="var">rest</span> (<span class="id" type="var">acc_sub</span> <span class="id" type="var">R</span>) (<span class="id" type="var">rdp_step</span> (<span class="id" type="var">axiom</span> (<span class="id" type="var">mrel</span> <span class="id" type="var">dpR</span>)) <span class="id" type="var">R</span>)).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">mark_inv</span> <span class="id" type="var">dpR</span> <span class="id" type="var">dpR_in_dpR</span> <span class="id" type="var">W</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">TT</span> <span class="id" type="var">mark_inv</span> <span class="id" type="var">t</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">mdp_reverted_criterion_local_strong</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">End</span> <span class="id" type="var">Marked_DP</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">are_connected</span> <span class="id" type="var">dpR</span> <span class="id" type="var">R</span> <span class="id" type="var">uv'</span> <span class="id" type="var">uv</span> := <br/>
&nbsp;&nbsp;<span class="id" type="var">exists</span> <span class="id" type="var">sigma</span>, <span class="id" type="var">exists</span> <span class="id" type="var">sigma'</span>, <br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">uv</span>, <span class="id" type="var">uv'</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| (<span class="id" type="var">u</span>,v), (<span class="id" type="var">u'</span>, <span class="id" type="var">v'</span>) =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">dpR</span> <span class="id" type="var">v</span> <span class="id" type="var">u</span> /\ <span class="id" type="var">dpR</span> <span class="id" type="var">v'</span> <span class="id" type="var">u'</span> /\ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma'</span> <span class="id" type="var">u'</span>), (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">v</span>) <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">lu'</span>, <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">lv</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">f</span> = <span class="id" type="var">g</span> /\ <span class="id" type="var">refl_trans_clos</span> (<span class="id" type="var">one_step_list</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>)) <span class="id" type="var">lu'</span> <span class="id" type="var">lv</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">_</span>, <span class="id" type="var">_</span> =&gt; <span class="id" type="var">False</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Section</span> <span class="id" type="var">RU</span>.<br/>
<span class="id" type="keyword">Variable</span> <span class="id" type="var">is_def</span> : <span class="id" type="var">symbol</span> -&gt; <span class="id" type="var">bool</span>.<br/>

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">rough_unif</span> (<span class="id" type="var">t1</span> <span class="id" type="var">t2</span> : <span class="id" type="var">term</span>) {<span class="id" type="keyword">struct</span> <span class="id" type="var">t1</span>} : <span class="id" type="var">bool</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">t1</span>, <span class="id" type="var">t2</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| (<span class="id" type="var">Var</span> <span class="id" type="var">_</span>), <span class="id" type="var">_</span>  =&gt; <span class="id" type="var">true</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">_</span>, (<span class="id" type="var">Var</span> <span class="id" type="var">_</span>)  =&gt; <span class="id" type="var">true</span><br/>
&nbsp;&nbsp;| (<span class="id" type="var">Term</span> <span class="id" type="var">f1</span> <span class="id" type="var">k1</span>), (<span class="id" type="var">Term</span> <span class="id" type="var">f2</span> <span class="id" type="var">k2</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">if</span> <span class="id" type="var">orb</span> (<span class="id" type="var">is_def</span> <span class="id" type="var">f1</span>) (<span class="id" type="var">is_def</span> <span class="id" type="var">f2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">then</span> <span class="id" type="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">else</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">if</span> <span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f1</span> <span class="id" type="var">f2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">rough_unif_list</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">fix</span> <span class="id" type="var">rough_unif_list</span> (<span class="id" type="var">l1</span> <span class="id" type="var">l2</span> : <span class="id" type="var">list</span> <span class="id" type="var">term</span>) {<span class="id" type="keyword">struct</span> <span class="id" type="var">l1</span>} : <span class="id" type="var">bool</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l1</span>, <span class="id" type="var">l2</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span>, <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span>, (<span class="id" type="var">_</span> :: <span class="id" type="var">_</span>) =&gt; <span class="id" type="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">_</span> :: <span class="id" type="var">_</span>), <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">t1</span> :: <span class="id" type="var">lt1</span>), (<span class="id" type="var">t2</span> :: <span class="id" type="var">lt2</span>) =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">andb</span> (<span class="id" type="var">rough_unif</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">rough_unif_list</span> <span class="id" type="var">lt1</span> <span class="id" type="var">lt2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>) <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">rough_unif_list</span> <span class="id" type="var">k1</span> <span class="id" type="var">k2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">else</span> <span class="id" type="var">false</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">rough_unif_list</span> (<span class="id" type="var">l1</span> <span class="id" type="var">l2</span> : <span class="id" type="var">list</span> <span class="id" type="var">term</span>) {<span class="id" type="keyword">struct</span> <span class="id" type="var">l1</span>} : <span class="id" type="var">bool</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l1</span>, <span class="id" type="var">l2</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span>, <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span>, (<span class="id" type="var">_</span> :: <span class="id" type="var">_</span>) =&gt; <span class="id" type="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">_</span> :: <span class="id" type="var">_</span>), <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">t1</span> :: <span class="id" type="var">lt1</span>), (<span class="id" type="var">t2</span> :: <span class="id" type="var">lt2</span>) =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">andb</span> (<span class="id" type="var">rough_unif</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">rough_unif_list</span> <span class="id" type="var">lt1</span> <span class="id" type="var">lt2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">rough_unif_unfold</span> : <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">rough_unif</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> =<br/>
&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">t1</span>, <span class="id" type="var">t2</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| (<span class="id" type="var">Var</span> <span class="id" type="var">_</span>), <span class="id" type="var">_</span>  =&gt; <span class="id" type="var">true</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">_</span>, (<span class="id" type="var">Var</span> <span class="id" type="var">_</span>)  =&gt; <span class="id" type="var">true</span><br/>
&nbsp;&nbsp;| (<span class="id" type="var">Term</span> <span class="id" type="var">f1</span> <span class="id" type="var">k1</span>), (<span class="id" type="var">Term</span> <span class="id" type="var">f2</span> <span class="id" type="var">k2</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">if</span> <span class="id" type="var">orb</span> (<span class="id" type="var">is_def</span> <span class="id" type="var">f1</span>) (<span class="id" type="var">is_def</span> <span class="id" type="var">f2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">then</span> <span class="id" type="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">else</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">if</span> <span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f1</span> <span class="id" type="var">f2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">then</span> <span class="id" type="var">rough_unif_list</span> <span class="id" type="var">k1</span> <span class="id" type="var">k2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">else</span> <span class="id" type="var">false</span><br/>
<span class="id" type="keyword">end</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">t1</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v1</span> | <span class="id" type="var">f1</span> <span class="id" type="var">k1</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v2</span> | <span class="id" type="var">f2</span> <span class="id" type="var">k2</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">is_def</span> <span class="id" type="var">f1</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">is_def</span> <span class="id" type="var">f2</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">eq_symb_bool</span> <span class="id" type="var">f1</span> <span class="id" type="var">f2</span>); [<span class="id" type="tactic">simpl</span> | <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>].<br/>
<span class="id" type="var">revert</span> <span class="id" type="var">k2</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">k1</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t1</span> <span class="id" type="var">k1</span>]; <span class="id" type="tactic">intros</span> [ | <span class="id" type="var">t2</span> <span class="id" type="var">k2</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">connect_approx</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span> : <span class="id" type="var">bool</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">u</span>, <span class="id" type="var">v</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span>, <span class="id" type="var">_</span> =&gt; <span class="id" type="var">false</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">_</span>, <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">false</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>, <span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">k</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">if</span> <span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">then</span> <span class="id" type="var">rough_unif_list</span> <span class="id" type="var">l</span> <span class="id" type="var">k</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">else</span> <span class="id" type="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">End</span> <span class="id" type="var">RU</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">rough_unif_is_ok</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> (<span class="id" type="var">R</span> <span class="id" type="var">dpR</span> : <span class="id" type="var">relation</span> <span class="id" type="var">term</span>) <span class="id" type="var">mark</span> <span class="id" type="var">is_def</span>,<br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">t</span>, ~R <span class="id" type="var">t</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>)) -&gt;<br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span>, <span class="id" type="var">defined</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span> -&gt; <span class="id" type="var">is_def</span> <span class="id" type="var">f</span> = <span class="id" type="var">true</span>) -&gt;<br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span>, <span class="id" type="var">dpR</span> <span class="id" type="var">v</span> <span class="id" type="var">u</span> -&gt; <span class="id" type="var">dp</span> <span class="id" type="var">R</span> <span class="id" type="var">v</span> <span class="id" type="var">u</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span> <span class="id" type="var">u'</span> <span class="id" type="var">v'</span>, <span class="id" type="var">are_connected</span> (<span class="id" type="var">mrel</span> <span class="id" type="var">mark</span> <span class="id" type="var">dpR</span>) <span class="id" type="var">R</span> (<span class="id" type="var">u'</span>,v') (<span class="id" type="var">u</span>,v) -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="var">connect_approx</span> <span class="id" type="var">is_def</span> <span class="id" type="var">v</span> <span class="id" type="var">u'</span> = <span class="id" type="var">true</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">dpR</span> <span class="id" type="var">mark</span> <span class="id" type="var">is_def</span> <span class="id" type="var">R_var</span> <span class="id" type="var">is_def_ok</span> <span class="id" type="var">dpR_in_dpR</span> <span class="id" type="var">_u</span> <span class="id" type="var">_v</span> <span class="id" type="var">_u'</span> <span class="id" type="var">_v'</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">sigma</span> [<span class="id" type="var">sigma'</span> [<span class="id" type="var">_H1</span> [<span class="id" type="var">_H2</span> <span class="id" type="var">H3</span>]]]].<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">_H1</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v</span> <span class="id" type="var">u</span> <span class="id" type="var">H1</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">_H1</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">_H2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v'</span> <span class="id" type="var">u'</span> <span class="id" type="var">H2</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">_H2</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">K1</span> := <span class="id" type="var">dpR_in_dpR</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H1</span>); <span class="id" type="tactic">clear</span> <span class="id" type="var">H1</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">K2</span> := <span class="id" type="var">dpR_in_dpR</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H2</span>); <span class="id" type="tactic">clear</span> <span class="id" type="var">H2</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">K1</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">p</span> <span class="id" type="var">f2</span> <span class="id" type="var">l2</span> <span class="id" type="var">H</span> <span class="id" type="var">Sub</span> <span class="id" type="var">Df2</span>].<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">K2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1'</span> <span class="id" type="var">t2'</span> <span class="id" type="var">p'</span> <span class="id" type="var">f2'</span> <span class="id" type="var">l2'</span> <span class="id" type="var">H'</span> <span class="id" type="var">Sub'</span> <span class="id" type="var">Df2'</span>].<br/>
<span class="id" type="tactic">subst</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">u'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x</span> | <span class="id" type="var">g</span> <span class="id" type="var">k</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">R_var</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H'</span>).<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H3</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">H3</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">H3</span> <span class="id" type="var">H4</span>].<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H3</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">eq_symb_bool_refl</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">K0</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">k'</span> <span class="id" type="var">l'</span> <span class="id" type="var">sigma</span> <span class="id" type="var">sigma'</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">refl_trans_clos</span> (<span class="id" type="var">one_step_list</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">map</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma'</span>) <span class="id" type="var">k'</span>) (<span class="id" type="var">map</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">l'</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">rough_unif_list</span> <span class="id" type="var">is_def</span> <span class="id" type="var">l'</span> <span class="id" type="var">k'</span> = <span class="id" type="var">true</span>).<br/>
<span class="id" type="tactic">clear</span> -R_var <span class="id" type="var">is_def_ok</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">k</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">k</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">list_rec3</span> <span class="id" type="var">size</span>); <span class="id" type="tactic">clear</span> <span class="id" type="var">k</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">n</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">n</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">n</span>]; <span class="id" type="tactic">intros</span> <span class="id" type="var">k</span> <span class="id" type="var">Sk</span> <span class="id" type="var">l</span> <span class="id" type="var">sigma</span> <span class="id" type="var">sigma'</span> <span class="id" type="var">H</span>;<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">k</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">s</span> <span class="id" type="var">k</span>].<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">L</span>:= <span class="id" type="var">refl_trans_clos_one_step_list_length_eq</span> <span class="id" type="var">H</span>).<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="var">absurd</span> (1 &lt;= 0).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">Abs</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">Abs</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">le_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">list_size</span> <span class="id" type="var">size</span> (<span class="id" type="var">s</span> :: <span class="id" type="var">k</span>)); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">le_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">size</span> <span class="id" type="var">s</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">size_ge_one</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">le_plus_l</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">L</span>:= <span class="id" type="var">refl_trans_clos_one_step_list_length_eq</span> <span class="id" type="var">H</span>).<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">L</span>:= <span class="id" type="var">refl_trans_clos_one_step_list_length_eq</span> <span class="id" type="var">H</span>).<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">refl_trans_clos_one_step_list_head_tail</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">H'</span> <span class="id" type="var">H</span>].<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Sk'</span> : <span class="id" type="var">list_size</span> <span class="id" type="var">size</span> <span class="id" type="var">k</span> &lt;= <span class="id" type="var">n</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">le_S_n</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">le_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">list_size</span> <span class="id" type="var">size</span> (<span class="id" type="var">s</span> :: <span class="id" type="var">k</span>)); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">refine</span> (<span class="id" type="var">plus_le_compat_r</span> 1 (<span class="id" type="var">size</span> <span class="id" type="var">s</span>) <span class="id" type="var">_</span> <span class="id" type="var">_</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">size_ge_one</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Ss</span> : <span class="id" type="var">size</span> <span class="id" type="var">s</span> &lt;= <span class="id" type="var">S</span> <span class="id" type="var">n</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">le_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">list_size</span> <span class="id" type="var">size</span> (<span class="id" type="var">s</span> :: <span class="id" type="var">k</span>)); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">le_plus_l</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHn</span> <span class="id" type="keyword">with</span> <span class="id" type="var">k</span> <span class="id" type="var">l</span> <span class="id" type="var">sigma</span> <span class="id" type="var">sigma'</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">l</span> <span class="id" type="var">k</span> <span class="id" type="var">Sk</span> <span class="id" type="var">Sk'</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">rough_unif_unfold</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x</span> | <span class="id" type="var">f</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">s</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x</span> | <span class="id" type="var">g</span> <span class="id" type="var">k</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H'</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">is_def</span> <span class="id" type="var">f</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">eq_symb_bool_refl</span>.<br/>
<span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">size_unfold</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Ss</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">le_S_n</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">Ss</span>); <span class="id" type="tactic">clear</span> <span class="id" type="var">Ss</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">Ss</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHn</span> <span class="id" type="keyword">with</span> <span class="id" type="var">k</span> <span class="id" type="var">l</span> <span class="id" type="var">sigma</span> <span class="id" type="var">sigma'</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H2</span>; <span class="id" type="var">left</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Df</span> : <span class="id" type="var">defined</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span> \/ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">f</span> = <span class="id" type="var">g</span> /\ <span class="id" type="var">refl_trans_clos</span> (<span class="id" type="var">one_step_list</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">map</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma'</span>) <span class="id" type="var">k</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">map</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">l</span>))).<br/>
<span class="id" type="tactic">set</span> (<span class="id" type="var">l'</span> := <span class="id" type="var">map</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">l</span>) <span class="id" type="keyword">in</span> *; <span class="id" type="var">clearbody</span> <span class="id" type="var">l'</span>.<br/>
<span class="id" type="tactic">set</span> (<span class="id" type="var">k'</span> := <span class="id" type="var">map</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma'</span>) <span class="id" type="var">k</span>) <span class="id" type="keyword">in</span> *; <span class="id" type="var">clearbody</span> <span class="id" type="var">k'</span>.<br/>
<span class="id" type="tactic">set</span> (<span class="id" type="var">fl</span> := <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l'</span>) <span class="id" type="keyword">in</span> *.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Hf</span> := <span class="id" type="var">refl_equal</span> <span class="id" type="var">fl</span>).<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">fl</span> <span class="id" type="tactic">at</span> 2 <span class="id" type="keyword">in</span> <span class="id" type="var">Hf</span>; <span class="id" type="var">clearbody</span> <span class="id" type="var">fl</span>; <span class="id" type="var">revert</span> <span class="id" type="var">Hf</span>.<br/>
<span class="id" type="tactic">set</span> (<span class="id" type="var">gk</span> := <span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">k'</span>) <span class="id" type="keyword">in</span> *.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Hg</span> := <span class="id" type="var">refl_equal</span> <span class="id" type="var">gk</span>).<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">gk</span> <span class="id" type="tactic">at</span> 2 <span class="id" type="keyword">in</span> <span class="id" type="var">Hg</span>; <span class="id" type="var">clearbody</span> <span class="id" type="var">gk</span>; <span class="id" type="var">revert</span> <span class="id" type="var">Hg</span>.<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">Ss</span>; <span class="id" type="var">revert</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span> <span class="id" type="var">l'</span> <span class="id" type="var">k'</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span> <span class="id" type="var">l'</span> <span class="id" type="var">k'</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v</span> | <span class="id" type="var">f2</span> <span class="id" type="var">l2</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">R_var</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">constructor</span> 1 <span class="id" type="keyword">with</span> <span class="id" type="var">l2</span> <span class="id" type="var">t1</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H3</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v</span> | <span class="id" type="var">f2</span> <span class="id" type="var">l2</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">R_var</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H1</span>).<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">IHtrans_clos</span> <span class="id" type="var">f</span> <span class="id" type="var">f2</span> <span class="id" type="var">l'</span> (<span class="id" type="var">map</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma0</span>) <span class="id" type="var">l2</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>) (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">Df</span> | [<span class="id" type="var">f_eq_f2</span> <span class="id" type="var">K</span>]].<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">f2</span>; <span class="id" type="var">left</span>; <span class="id" type="var">constructor</span> 1 <span class="id" type="keyword">with</span> <span class="id" type="var">l2</span> <span class="id" type="var">t1</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">IHtrans_clos</span> <span class="id" type="var">f</span> <span class="id" type="var">f0</span> <span class="id" type="var">l'</span> <span class="id" type="var">l2</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>) (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">Df</span> | [<span class="id" type="var">f_eq_f0</span> <span class="id" type="var">K</span>]].<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">f0</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">H4</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">subst</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_trans_clos_is_trans</span> <span class="id" type="keyword">with</span> <span class="id" type="var">l2</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">Df</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">Df</span> | [<span class="id" type="var">f_eq_g</span> <span class="id" type="var">K</span>]].<br/>
<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">is_def_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">Df</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">g</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">is_def</span> <span class="id" type="var">f</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">eq_symb_bool_refl</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">size_unfold</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Ss</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">le_S_n</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">Ss</span>); <span class="id" type="tactic">clear</span> <span class="id" type="var">Ss</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">Ss</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHn</span> <span class="id" type="keyword">with</span> <span class="id" type="var">k</span> <span class="id" type="var">l</span> <span class="id" type="var">sigma</span> <span class="id" type="var">sigma'</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">K0</span> <span class="id" type="keyword">with</span> <span class="id" type="var">sigma</span> <span class="id" type="var">sigma'</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">comp_comp</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">dpR</span> <span class="id" type="var">R</span> <span class="id" type="var">comp</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">uv</span> <span class="id" type="var">uv'</span>, <span class="id" type="var">are_connected</span> <span class="id" type="var">dpR</span> <span class="id" type="var">R</span> <span class="id" type="var">uv</span> <span class="id" type="var">uv'</span> -&gt; <span class="id" type="var">comp</span> <span class="id" type="var">uv</span> &lt;= <span class="id" type="var">comp</span> <span class="id" type="var">uv'</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">uv</span> <span class="id" type="var">uv'</span>, <span class="id" type="var">comp</span> <span class="id" type="var">uv</span> &lt;&gt; <span class="id" type="var">comp</span> <span class="id" type="var">uv'</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~ (<span class="id" type="var">refl_trans_clos</span> (<span class="id" type="var">are_connected</span> <span class="id" type="var">dpR</span> <span class="id" type="var">R</span>) <span class="id" type="var">uv</span> <span class="id" type="var">uv'</span> /\ <span class="id" type="var">refl_trans_clos</span> (<span class="id" type="var">are_connected</span> <span class="id" type="var">dpR</span> <span class="id" type="var">R</span>) <span class="id" type="var">uv'</span> <span class="id" type="var">uv</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">dpR</span> <span class="id" type="var">R</span> <span class="id" type="var">comp</span> <span class="id" type="var">H1</span> <span class="id" type="var">uv</span> <span class="id" type="var">uv'</span> <span class="id" type="var">H2</span> [<span class="id" type="var">H3</span> <span class="id" type="var">H4</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H2</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">H3</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">a</span> | <span class="id" type="var">a</span> <span class="id" type="var">b</span> <span class="id" type="var">H3</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">H4</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">a</span> | <span class="id" type="var">a</span> <span class="id" type="var">b</span> <span class="id" type="var">H4</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">le_antisym</span>.<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">H4</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">H3</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">a</span> <span class="id" type="var">b</span> <span class="id" type="var">H3</span> | <span class="id" type="var">a</span> <span class="id" type="var">b</span> <span class="id" type="var">c</span> <span class="id" type="var">H3</span> <span class="id" type="var">H4</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">le_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">comp</span> <span class="id" type="var">b</span>); [ <span class="id" type="tactic">apply</span> <span class="id" type="var">H1</span> | ]; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">H3</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">H4</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">a</span> <span class="id" type="var">b</span> <span class="id" type="var">H3</span> | <span class="id" type="var">a</span> <span class="id" type="var">b</span> <span class="id" type="var">c</span> <span class="id" type="var">H3</span> <span class="id" type="var">H4</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">le_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">comp</span> <span class="id" type="var">b</span>); [ <span class="id" type="tactic">apply</span> <span class="id" type="var">H1</span> | ]; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">End</span> <span class="id" type="var">MakeDP</span>.<br/>

<br/>
</div>
</div>

<div id="footer">
<hr/><a href="index.html">Index</a><hr/>This page has been generated by <a href="http://www.lix.polytechnique.fr/coq/">coqdoc</a>
</div>

</div>

</body>
</html>