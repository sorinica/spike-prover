<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"/>
<link href="coqdoc.css" rel="stylesheet" type="text/css"/>
<title>ac_matching.matching_algo</title>
</head>

<body>

<div id="page">

<div id="header">
</div>

<div id="main">

<h1 class="libtitle">Library ac_matching.matching_algo</h1>

<div class="code">

<br/>
<span class="id" type="keyword">Add</span> <span class="id" type="var">LoadPath</span> "basis".<br/>
<span class="id" type="keyword">Add</span> <span class="id" type="var">LoadPath</span> "list_extensions".<br/>
<span class="id" type="keyword">Add</span> <span class="id" type="var">LoadPath</span> "term_algebra".<br/>
<span class="id" type="keyword">Add</span> <span class="id" type="var">LoadPath</span> "term_orderings".<br/>

<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Arith</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">List</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">more_list</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">list_permut</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">list_sort</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">term_spec</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">term_o</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">equational_theory</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">ac</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">matching</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">dickson</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">matching_well_formed</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">matching_well_founded</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">matching_sound</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">matching_complete</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Wellfounded</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Wf_nat</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">dickson</span>.<br/>

<br/>
<span class="id" type="keyword">Module</span> <span class="id" type="keyword">Type</span> <span class="id" type="var">S</span>.<br/>

<br/>
<span class="id" type="keyword">Declare Module</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">CMatching</span> : <span class="id" type="var">matching_complete.S</span>.<br/>
<span class="id" type="keyword">Import</span> <span class="id" type="var">SMatching</span>.<br/>
<span class="id" type="keyword">Import</span> <span class="id" type="var">WFMMatching</span>.<br/>
<span class="id" type="keyword">Import</span> <span class="id" type="var">WFMatching</span>.<br/>
<span class="id" type="keyword">Import</span> <span class="id" type="var">Matching</span>.<br/>
<span class="id" type="keyword">Import</span> <span class="id" type="var">Cf_eq_ac</span>.<br/>
<span class="id" type="keyword">Import</span> <span class="id" type="var">Ac</span>.<br/>
<span class="id" type="keyword">Import</span> <span class="id" type="var">EqTh</span>.<br/>
<span class="id" type="keyword">Import</span> <span class="id" type="var">T</span>.<br/>
<span class="id" type="keyword">Import</span> <span class="id" type="keyword">Sort</span>.<br/>

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">well_formed_matching_problem</span> : <span class="id" type="keyword">Set</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">W</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">pb</span>, <span class="id" type="var">well_formed_pb</span> <span class="id" type="var">pb</span> -&gt; <span class="id" type="var">well_formed_matching_problem</span>.<br/>

<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">wfpb_weight</span> <span class="id" type="var">wfpb</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">wfpb</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">W</span> <span class="id" type="var">pb</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">pb_weight</span> <span class="id" type="var">pb</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">o_lpb</span> <span class="id" type="var">lwfpb1</span> <span class="id" type="var">lwfpb2</span> :=<br/>
&nbsp;(<span class="id" type="var">NatMul.multiset_extension_step</span> <span class="id" type="var">lt</span>) <br/>
&nbsp;(<span class="id" type="var">map</span> <span class="id" type="var">wfpb_weight</span> <span class="id" type="var">lwfpb1</span>) (<span class="id" type="var">map</span> <span class="id" type="var">wfpb_weight</span> <span class="id" type="var">lwfpb2</span>).<br/>

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">build_well_formed_matching_problem_list</span> <br/>
&nbsp;(<span class="id" type="var">lpb</span> : <span class="id" type="var">list</span> <span class="id" type="var">matching_problem</span>) :  <br/>
&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">p</span>, <span class="id" type="var">In</span> <span class="id" type="var">p</span> <span class="id" type="var">lpb</span> -&gt; <span class="id" type="var">well_formed_pb</span> <span class="id" type="var">p</span>) -&gt; <span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span> :=<br/>
&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">lpb</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">return</span> (<span class="id" type="keyword">forall</span> <span class="id" type="var">p</span>, <span class="id" type="var">In</span> <span class="id" type="var">p</span> <span class="id" type="var">lpb</span> -&gt; <span class="id" type="var">well_formed_pb</span> <span class="id" type="var">p</span>) -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span> <span class="id" type="keyword">with</span> <br/>
&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="keyword">fun</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">nil</span><br/>
&nbsp;| <span class="id" type="var">pb</span> :: <span class="id" type="var">tl_lpb</span> =&gt; <span class="id" type="keyword">fun</span> <span class="id" type="var">proof</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;(<span class="id" type="var">W</span> <span class="id" type="var">pb</span> (<span class="id" type="var">proof</span> <span class="id" type="var">pb</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)))) :: <br/>
&nbsp;&nbsp;&nbsp;(<span class="id" type="var">build_well_formed_matching_problem_list</span> <span class="id" type="var">tl_lpb</span> (@<span class="id" type="var">tail_prop</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">pb</span> <span class="id" type="var">tl_lpb</span> <span class="id" type="var">proof</span>))<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">wf_solve</span> (<span class="id" type="var">wpb</span> : <span class="id" type="var">well_formed_matching_problem</span>) :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">wpb</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">W</span> <span class="id" type="var">pb</span> <span class="id" type="var">w</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">build_well_formed_matching_problem_list</span> (<span class="id" type="var">solve</span> <span class="id" type="var">pb</span>) (<span class="id" type="var">well_formed_solve</span> <span class="id" type="var">pb</span> <span class="id" type="var">w</span>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Parameter</span> <span class="id" type="var">F_wf_solve_dec1</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">wpb</span> <span class="id" type="var">lpb'</span>, <span class="id" type="var">o_lpb</span> <span class="id" type="var">lpb'</span> (<span class="id" type="var">wpb</span> :: <span class="id" type="var">lpb'</span>).<br/>

<br/>
<span class="id" type="keyword">Parameter</span> <span class="id" type="var">F_wf_solve_dec2</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">wpb</span> <span class="id" type="var">lpb'</span>, <span class="id" type="var">o_lpb</span> ((<span class="id" type="var">wf_solve</span> <span class="id" type="var">wpb</span>) ++ <span class="id" type="var">lpb'</span>) (<span class="id" type="var">wpb</span> :: <span class="id" type="var">lpb'</span>).<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">F_wf_solve</span> (<span class="id" type="var">lpb</span> : <span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span>) :<br/>
&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">y</span>, <span class="id" type="var">o_lpb</span> <span class="id" type="var">y</span> <span class="id" type="var">lpb</span> -&gt; <span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span>) -&gt; <br/>
&nbsp;<span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span> :=<br/>
<span class="id" type="keyword">match</span> <span class="id" type="var">lpb</span> <span class="id" type="keyword">return</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id" type="keyword">forall</span> <span class="id" type="var">y</span> : <span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">o_lpb</span> <span class="id" type="var">y</span> <span class="id" type="var">lpb</span> -&gt; <span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span>)<br/>
<span class="id" type="keyword">with</span><br/>
| <span class="id" type="var">nil</span> =&gt; <span class="id" type="keyword">fun</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">nil</span><br/>
| <span class="id" type="var">wpb</span> :: <span class="id" type="var">tl_lpb</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">wpb</span> <span class="id" type="keyword">return</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id" type="keyword">forall</span> <span class="id" type="var">y</span> : <span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">o_lpb</span> <span class="id" type="var">y</span> (<span class="id" type="var">wpb</span> :: <span class="id" type="var">tl_lpb</span>) -&gt; <span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">W</span> <span class="id" type="var">pb</span> <span class="id" type="var">w</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">pb</span> <span class="id" type="keyword">return</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">w1</span> : <span class="id" type="var">well_formed_pb</span> <span class="id" type="var">pb</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">y</span> : <span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">o_lpb</span> <span class="id" type="var">y</span> (<span class="id" type="var">W</span> <span class="id" type="var">pb</span> <span class="id" type="var">w1</span> :: <span class="id" type="var">tl_lpb</span>) -&gt; <span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">mk_pb</span> <span class="id" type="var">existential_vars</span> <span class="id" type="var">unsolved_part</span> <span class="id" type="var">solved_part</span> <span class="id" type="var">partly_solved_part</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">fun</span> <span class="id" type="var">w1</span> <span class="id" type="var">srec</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">unsolved_part</span> <span class="id" type="keyword">return</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">w2</span> : <span class="id" type="var">well_formed_pb</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">mk_pb</span> <span class="id" type="var">existential_vars</span> <span class="id" type="var">unsolved_part</span> <span class="id" type="var">solved_part</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">partly_solved_part</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">y</span> : <span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">o_lpb</span> <span class="id" type="var">y</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">W</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">mk_pb</span> <span class="id" type="var">existential_vars</span> <span class="id" type="var">unsolved_part</span> <span class="id" type="var">solved_part</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">partly_solved_part</span>) <span class="id" type="var">w2</span> :: <span class="id" type="var">tl_lpb</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="keyword">fun</span> <span class="id" type="var">w2</span> <span class="id" type="var">srec3</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">W</span> (<span class="id" type="var">mk_pb</span> <span class="id" type="var">existential_vars</span> <span class="id" type="var">nil</span> <span class="id" type="var">solved_part</span> <span class="id" type="var">partly_solved_part</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">w2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:: <span class="id" type="var">srec3</span> <span class="id" type="var">tl_lpb</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">F_wf_solve_dec1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">W</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">mk_pb</span> <span class="id" type="var">existential_vars</span> <span class="id" type="var">nil</span> <span class="id" type="var">solved_part</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">partly_solved_part</span>) <span class="id" type="var">w2</span>) <span class="id" type="var">tl_lpb</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">p</span> :: <span class="id" type="var">unsolved_part0</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">fun</span> <span class="id" type="var">w2</span> <span class="id" type="var">srec3</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">srec3</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">wf_solve</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">W</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">mk_pb</span> <span class="id" type="var">existential_vars</span> (<span class="id" type="var">p</span> :: <span class="id" type="var">unsolved_part0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">solved_part</span> <span class="id" type="var">partly_solved_part</span>) <span class="id" type="var">w2</span>) ++ <span class="id" type="var">tl_lpb</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">F_wf_solve_dec2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">W</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">mk_pb</span> <span class="id" type="var">existential_vars</span> (<span class="id" type="var">p</span> :: <span class="id" type="var">unsolved_part0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">solved_part</span> <span class="id" type="var">partly_solved_part</span>) <span class="id" type="var">w2</span>) <span class="id" type="var">tl_lpb</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span> <span class="id" type="var">w1</span> <span class="id" type="var">srec</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span> <span class="id" type="var">w</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Parameter</span> <span class="id" type="var">well_founded_o_lpb</span> : <span class="id" type="var">well_founded</span> <span class="id" type="var">o_lpb</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">wf_solve_loop</span> :<br/>
<span class="id" type="keyword">forall</span> (<span class="id" type="var">l</span> : <span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span>), <br/>
(<span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span>) :=<br/>
<span class="id" type="keyword">Fix</span> <span class="id" type="var">well_founded_o_lpb</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span>) <span class="id" type="var">F_wf_solve</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">init_pb</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> := <span class="id" type="var">mk_pb</span> <span class="id" type="var">nil</span> ((<span class="id" type="var">t1</span>,t2) :: <span class="id" type="var">nil</span>) <span class="id" type="var">nil</span> <span class="id" type="var">nil</span>.<br/>

<br/>
<span class="id" type="keyword">Parameter</span> <span class="id" type="var">well_formed_init_pb</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">well_formed_cf</span> <span class="id" type="var">t1</span> -&gt; <span class="id" type="var">well_formed_cf</span> <span class="id" type="var">t2</span> -&gt; <br/>
&nbsp;&nbsp;<span class="id" type="var">well_formed_pb</span> (<span class="id" type="var">init_pb</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>).<br/>

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">extract_solution</span> <br/>
&nbsp;(<span class="id" type="var">solved_part</span> :  <span class="id" type="var">substitution</span>) <br/>
&nbsp;&nbsp;(<span class="id" type="var">partly_solved_part</span> : <span class="id" type="var">list</span> (<span class="id" type="var">variable</span>*  <span class="id" type="var">partly_solved_term</span>))<br/>
&nbsp;&nbsp;{<span class="id" type="keyword">struct</span> <span class="id" type="var">partly_solved_part</span>} : <span class="id" type="var">substitution</span> :=<br/>
&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">partly_solved_part</span> <span class="id" type="keyword">with</span><br/>
&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">solved_part</span><br/>
&nbsp;| (<span class="id" type="var">x</span>,x_part_val) :: <span class="id" type="var">tl_partly_solved_part</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">f</span> := <span class="id" type="var">head_symb</span> <span class="id" type="var">x_part_val</span> <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">x_val</span> := <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">quicksort</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">solved_part</span> (<span class="id" type="var">Var</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">x_part_val</span>))) ::<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">closed_term</span> <span class="id" type="var">x_part_val</span>) :: <span class="id" type="var">nil</span>))) <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">extract_solution</span> ((<span class="id" type="var">x</span>, <span class="id" type="var">x_val</span>) :: <span class="id" type="var">solved_part</span>) <span class="id" type="var">tl_partly_solved_part</span><br/>
&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">clean_sol</span> <br/>
&nbsp;&nbsp;(<span class="id" type="var">existential_vars</span> : <span class="id" type="var">list</span> <span class="id" type="var">variable</span>) (<span class="id" type="var">sigma</span> : <span class="id" type="var">substitution</span>) <br/>
&nbsp;&nbsp;{<span class="id" type="keyword">struct</span> <span class="id" type="var">sigma</span>} : <span class="id" type="var">substitution</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">sigma</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">nil</span><br/>
&nbsp;&nbsp;| (<span class="id" type="var">x</span>,x_val) :: <span class="id" type="var">tl_sigma</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">if</span> <span class="id" type="var">mem_bool</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">existential_vars</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">then</span> <span class="id" type="var">clean_sol</span> <span class="id" type="var">existential_vars</span> <span class="id" type="var">tl_sigma</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">else</span> (<span class="id" type="var">x</span>, <span class="id" type="var">x_val</span>) :: (<span class="id" type="var">clean_sol</span> <span class="id" type="var">existential_vars</span> <span class="id" type="var">tl_sigma</span>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">matching</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">map</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">fun</span> <span class="id" type="var">wpb</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">wpb</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">W</span> <span class="id" type="var">pb</span> <span class="id" type="var">_</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">clean_sol</span> (<span class="id" type="var">existential_vars</span> <span class="id" type="var">pb</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">extract_solution</span> (<span class="id" type="var">solved_part</span> <span class="id" type="var">pb</span>) (<span class="id" type="var">partly_solved_part</span> <span class="id" type="var">pb</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">wf_solve_loop</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id" type="var">W</span> (<span class="id" type="var">init_pb</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>) (<span class="id" type="var">well_formed_init_pb</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span>)) :: <span class="id" type="var">nil</span>)).<br/>

<br/>

<br/>
<span class="id" type="keyword">Parameter</span> <span class="id" type="var">matching_is_sound</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span> <span class="id" type="var">sigma</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">In</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">matching</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span>) -&gt; <span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t1</span> = <span class="id" type="var">t2</span>.<br/>

<br/>

<br/>
<span class="id" type="keyword">Parameter</span> <span class="id" type="var">matching_is_complete</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span> <span class="id" type="var">sigma</span>, <span class="id" type="var">well_formed_cf_subst</span> <span class="id" type="var">sigma</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t1</span> = <span class="id" type="var">t2</span> -&gt;<br/>
&nbsp;&nbsp;(<span class="id" type="var">exists</span> <span class="id" type="var">sigma'</span>, <span class="id" type="var">In</span> <span class="id" type="var">sigma'</span> (<span class="id" type="var">matching</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">v</span>, <span class="id" type="var">occurs_in_term</span> <span class="id" type="var">v</span> <span class="id" type="var">t1</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma</span>  (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>) = <span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma'</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>))).<br/>

<br/>
<span class="id" type="keyword">End</span> <span class="id" type="var">S</span>.<br/>

<br/>
<span class="id" type="keyword">Module</span> <span class="id" type="var">Make</span> (<span class="id" type="var">CMatching1</span> : <span class="id" type="var">matching_complete.S</span>) :<br/>
&nbsp;<span class="id" type="var">S</span> <span class="id" type="keyword">with</span> <span class="id" type="keyword">Module</span> <span class="id" type="var">CMatching</span> := <span class="id" type="var">CMatching1</span>.<br/>

<br/>
<span class="id" type="keyword">Module</span> <span class="id" type="var">CMatching</span> := <span class="id" type="var">CMatching1</span>.<br/>

<br/>
<span class="id" type="keyword">Import</span> <span class="id" type="var">CMatching1</span>.<br/>
<span class="id" type="keyword">Import</span> <span class="id" type="var">SMatching</span>.<br/>
<span class="id" type="keyword">Import</span> <span class="id" type="var">WFMMatching</span>.<br/>
<span class="id" type="keyword">Import</span> <span class="id" type="var">WFMatching</span>.<br/>
<span class="id" type="keyword">Import</span> <span class="id" type="var">Matching</span>.<br/>
<span class="id" type="keyword">Import</span> <span class="id" type="var">Cf_eq_ac</span>.<br/>
<span class="id" type="keyword">Import</span> <span class="id" type="var">Ac</span>.<br/>
<span class="id" type="keyword">Import</span> <span class="id" type="var">EqTh</span>.<br/>
<span class="id" type="keyword">Import</span> <span class="id" type="var">T</span>.<br/>
<span class="id" type="keyword">Import</span> <span class="id" type="var">F</span>.<br/>
<span class="id" type="keyword">Import</span> <span class="id" type="var">X</span>.<br/>
<span class="id" type="keyword">Import</span> <span class="id" type="keyword">Sort</span>.<br/>
<span class="id" type="keyword">Import</span> <span class="id" type="var">LPermut</span>.<br/>

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">well_formed_matching_problem</span> : <span class="id" type="keyword">Set</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">W</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">pb</span>, <span class="id" type="var">well_formed_pb</span> <span class="id" type="var">pb</span> -&gt; <span class="id" type="var">well_formed_matching_problem</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">wfpb_weight</span> <span class="id" type="var">wfpb</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">wfpb</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">W</span> <span class="id" type="var">pb</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">pb_weight</span> <span class="id" type="var">pb</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">o_lpb</span> <span class="id" type="var">lwfpb1</span> <span class="id" type="var">lwfpb2</span> :=<br/>
&nbsp;(<span class="id" type="var">NatMul.multiset_extension_step</span> <span class="id" type="var">lt</span>) <br/>
&nbsp;(<span class="id" type="var">map</span> <span class="id" type="var">wfpb_weight</span> <span class="id" type="var">lwfpb1</span>) (<span class="id" type="var">map</span> <span class="id" type="var">wfpb_weight</span> <span class="id" type="var">lwfpb2</span>).<br/>

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">build_well_formed_matching_problem_list</span> <br/>
&nbsp;(<span class="id" type="var">lpb</span> : <span class="id" type="var">list</span> <span class="id" type="var">matching_problem</span>) :  (<span class="id" type="keyword">forall</span> <span class="id" type="var">p</span>, <span class="id" type="var">In</span> <span class="id" type="var">p</span> <span class="id" type="var">lpb</span> -&gt; <span class="id" type="var">well_formed_pb</span> <span class="id" type="var">p</span>) -&gt; <span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span> :=<br/>
&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">lpb</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">return</span> (<span class="id" type="keyword">forall</span> <span class="id" type="var">p</span>, <span class="id" type="var">In</span> <span class="id" type="var">p</span> <span class="id" type="var">lpb</span> -&gt; <span class="id" type="var">well_formed_pb</span> <span class="id" type="var">p</span>) -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span> <span class="id" type="keyword">with</span> <br/>
&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="keyword">fun</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">nil</span><br/>
&nbsp;| <span class="id" type="var">pb</span> :: <span class="id" type="var">tl_lpb</span> =&gt; <span class="id" type="keyword">fun</span> <span class="id" type="var">proof</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;(<span class="id" type="var">W</span> <span class="id" type="var">pb</span> (<span class="id" type="var">proof</span> <span class="id" type="var">pb</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)))) :: <br/>
&nbsp;&nbsp;&nbsp;(<span class="id" type="var">build_well_formed_matching_problem_list</span> <span class="id" type="var">tl_lpb</span> (@<span class="id" type="var">tail_prop</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">pb</span> <span class="id" type="var">tl_lpb</span> <span class="id" type="var">proof</span>))<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">weight_is_weight</span> : <br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">lpb</span>, <span class="id" type="keyword">forall</span> <span class="id" type="var">proof</span> : (<span class="id" type="keyword">forall</span> <span class="id" type="var">p</span>, <span class="id" type="var">In</span> <span class="id" type="var">p</span> <span class="id" type="var">lpb</span> -&gt; <span class="id" type="var">well_formed_pb</span> <span class="id" type="var">p</span>),<br/>
&nbsp;<span class="id" type="var">map</span> <span class="id" type="var">wfpb_weight</span> (<span class="id" type="var">build_well_formed_matching_problem_list</span> <span class="id" type="var">lpb</span> <span class="id" type="var">proof</span>) =<br/>
&nbsp;<span class="id" type="var">map</span> <span class="id" type="var">pb_weight</span> <span class="id" type="var">lpb</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">lpb</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">proof</span>;<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHlpb</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">wf_solve</span> (<span class="id" type="var">wpb</span> : <span class="id" type="var">well_formed_matching_problem</span>) :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">wpb</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">W</span> <span class="id" type="var">pb</span> <span class="id" type="var">w</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">build_well_formed_matching_problem_list</span> (<span class="id" type="var">solve</span> <span class="id" type="var">pb</span>) (<span class="id" type="var">well_formed_solve</span> <span class="id" type="var">pb</span> <span class="id" type="var">w</span>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">F_wf_solve_dec1</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">wpb</span> <span class="id" type="var">lpb'</span>, <span class="id" type="var">o_lpb</span> <span class="id" type="var">lpb'</span> (<span class="id" type="var">wpb</span> :: <span class="id" type="var">lpb'</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">wpb</span> <span class="id" type="var">lpb'</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">o_lpb</span>.<br/>
<span class="id" type="tactic">apply</span> (@<span class="id" type="var">NatMul.rmv_case</span> <span class="id" type="var">lt</span> (<span class="id" type="var">map</span> <span class="id" type="var">wfpb_weight</span> <span class="id" type="var">lpb'</span>) (<span class="id" type="var">map</span> <span class="id" type="var">wfpb_weight</span> (<span class="id" type="var">wpb</span> :: <span class="id" type="var">lpb'</span>)) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">map</span> <span class="id" type="var">wfpb_weight</span> <span class="id" type="var">lpb'</span>) <span class="id" type="var">nil</span> (<span class="id" type="var">wfpb_weight</span> <span class="id" type="var">wpb</span>)).<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">NatMul.LP.permut_refl</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">NatMul.LP.permut_refl</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">F_wf_solve_dec2</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">wpb</span> <span class="id" type="var">lpb'</span>, <span class="id" type="var">o_lpb</span> ((<span class="id" type="var">wf_solve</span> <span class="id" type="var">wpb</span>) ++ <span class="id" type="var">lpb'</span>) (<span class="id" type="var">wpb</span> :: <span class="id" type="var">lpb'</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">wpb</span> <span class="id" type="var">lpb'</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">o_lpb</span>, <span class="id" type="var">wf_solve</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">wpb</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">map_app</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">weight_is_weight</span>.<br/>
<span class="id" type="tactic">apply</span> (@<span class="id" type="var">NatMul.rmv_case</span> <span class="id" type="var">lt</span> ((<span class="id" type="var">map</span> <span class="id" type="var">pb_weight</span> (<span class="id" type="var">solve</span> <span class="id" type="var">pb</span>)) ++ <span class="id" type="var">map</span> <span class="id" type="var">wfpb_weight</span> <span class="id" type="var">lpb'</span>)<br/>
(<span class="id" type="var">pb_weight</span> <span class="id" type="var">pb</span> :: <span class="id" type="var">map</span> <span class="id" type="var">wfpb_weight</span> <span class="id" type="var">lpb'</span>) <br/>
(<span class="id" type="var">map</span> <span class="id" type="var">wfpb_weight</span> <span class="id" type="var">lpb'</span>) (<span class="id" type="var">map</span> <span class="id" type="var">pb_weight</span> (<span class="id" type="var">solve</span> <span class="id" type="var">pb</span>)) (<span class="id" type="var">pb_weight</span> <span class="id" type="var">pb</span>)).<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">well_founded_solve</span> <span class="id" type="var">pb</span> <span class="id" type="var">w</span>).<br/>
<span class="id" type="tactic">replace</span> (<span class="id" type="var">WFMatching.Matching.solve</span> <span class="id" type="var">pb</span>) <span class="id" type="keyword">with</span> (<span class="id" type="var">solve</span> <span class="id" type="var">pb</span>); [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">trivial</span>].<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">w</span> <span class="id" type="var">lpb'</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">solve</span> <span class="id" type="var">pb</span>); <span class="id" type="tactic">induction</span> <span class="id" type="var">l</span>.<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">H</span> <span class="id" type="var">b</span> <span class="id" type="var">In_b</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">In_b</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">In_b</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">In_b</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">NatMul.LP.EDS.eq_A</span>, <span class="id" type="var">NatMul.DS.eq_A</span> <span class="id" type="keyword">in</span> *;<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">b</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">NatMul.LP.permut_refl</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">NatMul.LP.permut_refl</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">F_wf_solve</span> (<span class="id" type="var">lpb</span> : <span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span>) :<br/>
&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">y</span>, <span class="id" type="var">o_lpb</span> <span class="id" type="var">y</span> <span class="id" type="var">lpb</span> -&gt; <span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span>) -&gt; <br/>
&nbsp;<span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span> :=<br/>
<span class="id" type="keyword">match</span> <span class="id" type="var">lpb</span> <span class="id" type="keyword">return</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id" type="keyword">forall</span> <span class="id" type="var">y</span> : <span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">o_lpb</span> <span class="id" type="var">y</span> <span class="id" type="var">lpb</span> -&gt; <span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span>)<br/>
<span class="id" type="keyword">with</span><br/>
| <span class="id" type="var">nil</span> =&gt; <span class="id" type="keyword">fun</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">nil</span><br/>
| <span class="id" type="var">wpb</span> :: <span class="id" type="var">tl_lpb</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">wpb</span> <span class="id" type="keyword">return</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id" type="keyword">forall</span> <span class="id" type="var">y</span> : <span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">o_lpb</span> <span class="id" type="var">y</span> (<span class="id" type="var">wpb</span> :: <span class="id" type="var">tl_lpb</span>) -&gt; <span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">W</span> <span class="id" type="var">pb</span> <span class="id" type="var">w</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">pb</span> <span class="id" type="keyword">return</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">w1</span> : <span class="id" type="var">well_formed_pb</span> <span class="id" type="var">pb</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">y</span> : <span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">o_lpb</span> <span class="id" type="var">y</span> (<span class="id" type="var">W</span> <span class="id" type="var">pb</span> <span class="id" type="var">w1</span> :: <span class="id" type="var">tl_lpb</span>) -&gt; <span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">mk_pb</span> <span class="id" type="var">existential_vars</span> <span class="id" type="var">unsolved_part</span> <span class="id" type="var">solved_part</span> <span class="id" type="var">partly_solved_part</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">fun</span> <span class="id" type="var">w1</span> <span class="id" type="var">srec</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">unsolved_part</span> <span class="id" type="keyword">return</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">w2</span> : <span class="id" type="var">well_formed_pb</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">mk_pb</span> <span class="id" type="var">existential_vars</span> <span class="id" type="var">unsolved_part</span> <span class="id" type="var">solved_part</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">partly_solved_part</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">y</span> : <span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">o_lpb</span> <span class="id" type="var">y</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">W</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">mk_pb</span> <span class="id" type="var">existential_vars</span> <span class="id" type="var">unsolved_part</span> <span class="id" type="var">solved_part</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">partly_solved_part</span>) <span class="id" type="var">w2</span> :: <span class="id" type="var">tl_lpb</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="keyword">fun</span> <span class="id" type="var">w2</span> <span class="id" type="var">srec3</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">W</span> (<span class="id" type="var">mk_pb</span> <span class="id" type="var">existential_vars</span> <span class="id" type="var">nil</span> <span class="id" type="var">solved_part</span> <span class="id" type="var">partly_solved_part</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">w2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:: <span class="id" type="var">srec3</span> <span class="id" type="var">tl_lpb</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">F_wf_solve_dec1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">W</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">mk_pb</span> <span class="id" type="var">existential_vars</span> <span class="id" type="var">nil</span> <span class="id" type="var">solved_part</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">partly_solved_part</span>) <span class="id" type="var">w2</span>) <span class="id" type="var">tl_lpb</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">p</span> :: <span class="id" type="var">unsolved_part0</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">fun</span> <span class="id" type="var">w2</span> <span class="id" type="var">srec3</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">srec3</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">wf_solve</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">W</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">mk_pb</span> <span class="id" type="var">existential_vars</span> (<span class="id" type="var">p</span> :: <span class="id" type="var">unsolved_part0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">solved_part</span> <span class="id" type="var">partly_solved_part</span>) <span class="id" type="var">w2</span>) ++ <span class="id" type="var">tl_lpb</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">F_wf_solve_dec2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">W</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">mk_pb</span> <span class="id" type="var">existential_vars</span> (<span class="id" type="var">p</span> :: <span class="id" type="var">unsolved_part0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">solved_part</span> <span class="id" type="var">partly_solved_part</span>) <span class="id" type="var">w2</span>) <span class="id" type="var">tl_lpb</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span> <span class="id" type="var">w1</span> <span class="id" type="var">srec</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span> <span class="id" type="var">w</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
<span class="id" type="keyword">end</span>.<br/>

<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">well_founded_o_lpb</span> : <span class="id" type="var">well_founded</span> <span class="id" type="var">o_lpb</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">o_lpb</span>;<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">wf_inverse_image</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> (<span class="id" type="var">NatMul.multiset_extension_step</span> <span class="id" type="var">lt</span>)<br/>
(<span class="id" type="var">map</span> <span class="id" type="var">wfpb_weight</span>) (<span class="id" type="var">NatMul.dickson</span> <span class="id" type="var">lt_wf</span>)).<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">wf_solve_loop</span> :<br/>
<span class="id" type="keyword">forall</span> (<span class="id" type="var">l</span> : <span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span>), <br/>
(<span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span>) :=<br/>
<span class="id" type="keyword">Fix</span> <span class="id" type="var">well_founded_o_lpb</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span>) <span class="id" type="var">F_wf_solve</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">wf_solve_loop_unfold</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">l</span> : <span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span>,<br/>
<span class="id" type="var">wf_solve_loop</span> <span class="id" type="var">l</span> = @<span class="id" type="var">F_wf_solve</span> <span class="id" type="var">l</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">y</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">wf_solve_loop</span> <span class="id" type="var">y</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">wf_solve_loop</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Fix_eq</span> <span class="id" type="keyword">with</span> <br/>
(<span class="id" type="var">P</span>:= (<span class="id" type="keyword">fun</span> <span class="id" type="var">_</span>:list <span class="id" type="var">well_formed_matching_problem</span> =&gt; <span class="id" type="var">list</span> <span class="id" type="var">well_formed_matching_problem</span>));<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">x</span>.<br/>
<span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">F_wf_solve</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">w</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">pb</span> <span class="id" type="var">w</span>];<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">pb</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">starting_vars</span> <span class="id" type="var">un_slvd_part</span> <span class="id" type="var">slvd_part</span> <span class="id" type="var">party_slvd_part</span>];<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">un_slvd_part</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">wf_solve_nil</span> : <br/>
&nbsp;&nbsp;<span class="id" type="var">wf_solve_loop</span> <span class="id" type="var">nil</span> = <span class="id" type="var">nil</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">wf_solve_loop_unfold</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">wf_solve_cons</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">wpb</span> <span class="id" type="var">lpb</span>,<br/>
&nbsp;<span class="id" type="var">wf_solve_loop</span> (<span class="id" type="var">wpb</span> :: <span class="id" type="var">lpb</span>) = <span class="id" type="keyword">match</span> <span class="id" type="var">wpb</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">W</span> <span class="id" type="var">pb</span> <span class="id" type="var">w</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">unsolved_part</span> <span class="id" type="var">pb</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">wpb</span> :: (<span class="id" type="var">wf_solve_loop</span> <span class="id" type="var">lpb</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">_</span> :: <span class="id" type="var">_</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">wf_solve_loop</span> ((<span class="id" type="var">wf_solve</span> <span class="id" type="var">wpb</span>) ++ <span class="id" type="var">lpb</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">wpb</span> <span class="id" type="var">lpb</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">wf_solve_loop_unfold</span>;<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">wpb</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">pb</span> <span class="id" type="var">w</span>]; <br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">pb</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">starting_vars</span> <span class="id" type="var">un_slvd_part</span> <span class="id" type="var">slvd_part</span> <span class="id" type="var">party_slvd_part</span>]; <br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">un_slvd_part</span>;<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">is_wf_sol</span> <span class="id" type="var">wpb</span> <span class="id" type="var">sigma</span> :=<br/>
&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">wpb</span> <span class="id" type="keyword">with</span><br/>
&nbsp;| <span class="id" type="var">W</span> <span class="id" type="var">pb</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">is_sol</span> <span class="id" type="var">pb</span> <span class="id" type="var">sigma</span><br/>
&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">wf_projection</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">pb</span> <span class="id" type="var">w</span> <span class="id" type="var">lpb</span> <span class="id" type="var">proof</span>, <br/>
&nbsp;<span class="id" type="var">In</span> (<span class="id" type="var">W</span> <span class="id" type="var">pb</span> <span class="id" type="var">w</span>) (<span class="id" type="var">build_well_formed_matching_problem_list</span> <span class="id" type="var">lpb</span> <span class="id" type="var">proof</span>) -&gt;<br/>
&nbsp;<span class="id" type="var">In</span> <span class="id" type="var">pb</span> <span class="id" type="var">lpb</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">pb</span> <span class="id" type="var">w</span> <span class="id" type="var">lpb</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">lpb</span>.<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">proof</span> <span class="id" type="var">In_wpb</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">In_wpb</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">In_wpb</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">In_wpb</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">In_wpb</span>.<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">In_wpb</span>; <span class="id" type="tactic">intro</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">IHlpb</span> <span class="id" type="var">_</span> <span class="id" type="var">In_wpb</span>).<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">wf_solve_is_sound</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">wpb</span> <span class="id" type="var">p</span> <span class="id" type="var">sigma</span>, <br/>
&nbsp;<span class="id" type="var">In</span> <span class="id" type="var">p</span> (<span class="id" type="var">wf_solve</span> <span class="id" type="var">wpb</span>) -&gt; <span class="id" type="var">is_wf_sol</span> <span class="id" type="var">p</span> <span class="id" type="var">sigma</span> -&gt; <span class="id" type="var">is_wf_sol</span> <span class="id" type="var">wpb</span> <span class="id" type="var">sigma</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">wpb</span> <span class="id" type="var">p</span> <span class="id" type="var">sigma</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">wpb</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">wf_solve</span>, <span class="id" type="var">is_wf_sol</span>;<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">solve_is_sound</span> <span class="id" type="var">pb</span> <span class="id" type="var">sigma</span> <span class="id" type="var">w</span> <span class="id" type="var">pb0</span>); <span class="id" type="tactic">trivial</span>;<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">wf_projection</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">wf_solve_loop_is_sound</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">lpb</span> <span class="id" type="var">p</span> <span class="id" type="var">sigma</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">In</span> <span class="id" type="var">p</span> (<span class="id" type="var">wf_solve_loop</span> <span class="id" type="var">lpb</span>) -&gt; <span class="id" type="var">is_wf_sol</span> <span class="id" type="var">p</span> <span class="id" type="var">sigma</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="var">exists</span> <span class="id" type="var">pb</span>, <span class="id" type="var">In</span> <span class="id" type="var">pb</span> <span class="id" type="var">lpb</span> /\ <span class="id" type="var">is_wf_sol</span> <span class="id" type="var">pb</span> <span class="id" type="var">sigma</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">lpb</span>;<br/>
<span class="id" type="tactic">refine</span> (<span class="id" type="var">well_founded_ind</span> <span class="id" type="var">well_founded_o_lpb</span><br/>
(<span class="id" type="keyword">fun</span> <span class="id" type="var">lpb</span> =&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">p</span> <span class="id" type="var">sigma</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">In</span> <span class="id" type="var">p</span> (<span class="id" type="var">wf_solve_loop</span> <span class="id" type="var">lpb</span>) -&gt; <span class="id" type="var">is_wf_sol</span> <span class="id" type="var">p</span> <span class="id" type="var">sigma</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="var">exists</span> <span class="id" type="var">pb</span>, <span class="id" type="var">In</span> <span class="id" type="var">pb</span> <span class="id" type="var">lpb</span> /\ <span class="id" type="var">is_wf_sol</span> <span class="id" type="var">pb</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">_</span> <span class="id" type="var">_</span>);<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">lpb</span>; <br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">lpb</span> <span class="id" type="var">IH</span> <span class="id" type="var">p</span> <span class="id" type="var">sigma</span> <span class="id" type="var">In_p</span> <span class="id" type="var">Is_sol_p</span>;<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">lpb</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">wf_solve_nil</span> <span class="id" type="keyword">in</span> <span class="id" type="var">In_p</span>; <span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">wf_solve_cons</span> <span class="id" type="keyword">in</span> <span class="id" type="var">In_p</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">w</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">unsolved_part</span> <span class="id" type="var">pb</span>).<br/>
<span class="id" type="tactic">elim</span> <span class="id" type="var">In_p</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">In_p</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">In_p</span>.<br/>
<span class="id" type="var">exists</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">elim</span> (<span class="id" type="var">IH</span> <span class="id" type="var">lpb</span> (<span class="id" type="var">F_wf_solve_dec1</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">p</span> <span class="id" type="var">sigma</span> <span class="id" type="var">In_p</span> <span class="id" type="var">Is_sol_p</span>);<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">pb0</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">In_pb0</span> <span class="id" type="var">Is_sol_pb0</span>; <br/>
<span class="id" type="var">exists</span> <span class="id" type="var">pb0</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">elim</span> (<span class="id" type="var">IH</span> (<span class="id" type="var">wf_solve</span> (<span class="id" type="var">W</span> <span class="id" type="var">pb</span> <span class="id" type="var">w</span>) ++ <span class="id" type="var">lpb</span>) (<span class="id" type="var">F_wf_solve_dec2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">p</span> <span class="id" type="var">sigma</span> <span class="id" type="var">In_p</span> <span class="id" type="var">Is_sol_p</span>);<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">pb0</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">In_pb0</span> <span class="id" type="var">Is_sol_pb0</span>;<br/>
<span class="id" type="tactic">elim</span> (<span class="id" type="var">in_app_or</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">In_pb0</span>); <span class="id" type="tactic">clear</span> <span class="id" type="var">In_pb0</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">In_pb0</span>.<br/>
<span class="id" type="var">exists</span> (<span class="id" type="var">W</span> <span class="id" type="var">pb</span> <span class="id" type="var">w</span>); <span class="id" type="tactic">split</span>;<br/>
[ <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span><br/>
| <span class="id" type="tactic">apply</span> (<span class="id" type="var">wf_solve_is_sound</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">In_pb0</span> <span class="id" type="var">Is_sol_pb0</span>) ].<br/>
<span class="id" type="var">exists</span> <span class="id" type="var">pb0</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">is_wf_wf_sol</span> <span class="id" type="var">wpb</span> <span class="id" type="var">sigma</span> :=<br/>
&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">wpb</span> <span class="id" type="keyword">with</span><br/>
&nbsp;| <span class="id" type="var">W</span> <span class="id" type="var">pb</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">is_well_formed_sol</span> <span class="id" type="var">pb</span> <span class="id" type="var">sigma</span><br/>
&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">wf_solve_is_complete</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">wpb</span> <span class="id" type="var">sigma</span>, <span class="id" type="var">is_wf_wf_sol</span> <span class="id" type="var">wpb</span> <span class="id" type="var">sigma</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">wpb</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">W</span> <span class="id" type="var">pb</span> <span class="id" type="var">_</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">unsolved_part</span> <span class="id" type="var">pb</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">True</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">_</span> :: <span class="id" type="var">_</span> =&gt; <span class="id" type="var">exists</span> <span class="id" type="var">pb</span>, <span class="id" type="var">In</span> <span class="id" type="var">pb</span> (<span class="id" type="var">wf_solve</span> <span class="id" type="var">wpb</span>) /\ <span class="id" type="var">is_wf_wf_sol</span> <span class="id" type="var">pb</span> <span class="id" type="var">sigma</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">wpb</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">is_wf_wf_sol</span>;<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">sigma</span> <span class="id" type="var">Is_sol</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">solve_is_complete</span> <span class="id" type="var">pb</span> <span class="id" type="var">w</span> <span class="id" type="var">sigma</span> <span class="id" type="var">Is_sol</span>);<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">unsolved_part</span> <span class="id" type="var">pb</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">wf_solve</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">solve</span> <span class="id" type="var">pb</span>) (<span class="id" type="var">well_formed_solve</span> <span class="id" type="var">pb</span> <span class="id" type="var">w</span>).<br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">l0</span>;<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">w0</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>;<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">pb'</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">In_pb'</span> <span class="id" type="var">Is_sol'</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">In_pb'</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">In_pb'</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">In_pb'</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="var">exists</span> <br/>
(<span class="id" type="var">W</span> <span class="id" type="var">a</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">w0</span> <span class="id" type="var">a</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">or_introl</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id" type="var">fix</span> <span class="id" type="var">In</span> (<span class="id" type="var">a0</span> : <span class="id" type="var">matching_problem</span>) (<span class="id" type="var">l1</span> : <span class="id" type="var">list</span> <span class="id" type="var">matching_problem</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="id" type="keyword">struct</span> <span class="id" type="var">l1</span>} : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l1</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">False</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">b</span> :: <span class="id" type="var">m</span> =&gt; <span class="id" type="var">b</span> = <span class="id" type="var">a0</span> \/ <span class="id" type="var">In</span> <span class="id" type="var">a0</span> <span class="id" type="var">m</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>) <span class="id" type="var">a</span> <span class="id" type="var">l0</span>) (<span class="id" type="var">refl_equal</span> <span class="id" type="var">a</span>))));<br/>
<span class="id" type="tactic">split</span>; [ <span class="id" type="var">left</span> | <span class="id" type="tactic">subst</span> <span class="id" type="var">pb'</span> ]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">cut</span> (<span class="id" type="var">exists</span> <span class="id" type="var">pb'</span> : <span class="id" type="var">matching_problem</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">In</span> <span class="id" type="var">pb'</span> <span class="id" type="var">l0</span> /\ <span class="id" type="var">is_well_formed_sol</span> <span class="id" type="var">pb'</span> <span class="id" type="var">sigma</span>).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>;<br/>
<span class="id" type="tactic">elim</span> (<span class="id" type="var">IHl0</span> (@<span class="id" type="var">tail_prop</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">a</span> <span class="id" type="var">l0</span> <span class="id" type="var">w0</span>) <span class="id" type="var">H</span>); <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>;<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">pb0</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">In_pb0</span> <span class="id" type="var">Is_sol0</span>;<br/>
<span class="id" type="var">exists</span> <span class="id" type="var">pb0</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">exists</span> <span class="id" type="var">pb'</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">wf_solve_loop_is_complete</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">lpb</span> <span class="id" type="var">p</span> <span class="id" type="var">sigma</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">In</span> <span class="id" type="var">p</span> <span class="id" type="var">lpb</span> -&gt; <span class="id" type="var">is_wf_wf_sol</span> <span class="id" type="var">p</span> <span class="id" type="var">sigma</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="var">exists</span> <span class="id" type="var">pb</span>, <span class="id" type="var">In</span> <span class="id" type="var">pb</span> (<span class="id" type="var">wf_solve_loop</span> <span class="id" type="var">lpb</span>) /\ <span class="id" type="var">is_wf_wf_sol</span> <span class="id" type="var">pb</span> <span class="id" type="var">sigma</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">lpb</span>;<br/>
<span class="id" type="tactic">refine</span> (<span class="id" type="var">well_founded_ind</span> <span class="id" type="var">well_founded_o_lpb</span><br/>
(<span class="id" type="keyword">fun</span> <span class="id" type="var">lpb</span> =&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">p</span> <span class="id" type="var">sigma</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">In</span> <span class="id" type="var">p</span> <span class="id" type="var">lpb</span> -&gt; <span class="id" type="var">is_wf_wf_sol</span> <span class="id" type="var">p</span> <span class="id" type="var">sigma</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="var">exists</span> <span class="id" type="var">pb</span>, <span class="id" type="var">In</span> <span class="id" type="var">pb</span> (<span class="id" type="var">wf_solve_loop</span> <span class="id" type="var">lpb</span>) /\ <span class="id" type="var">is_wf_wf_sol</span> <span class="id" type="var">pb</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">_</span> <span class="id" type="var">_</span>);<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">lpb</span>; <br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">lpb</span> <span class="id" type="var">IH</span> <span class="id" type="var">p</span> <span class="id" type="var">sigma</span> <span class="id" type="var">In_p</span> <span class="id" type="var">Is_sol_p</span>;<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">lpb</span>.<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">wf_solve_cons</span>;<br/>
<span class="id" type="tactic">elim</span> <span class="id" type="var">In_p</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">In_p</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">In_p</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">wf_solve_is_complete</span> <span class="id" type="var">p</span> <span class="id" type="var">sigma</span> <span class="id" type="var">Is_sol_p</span>); <span class="id" type="tactic">subst</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">w</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">unsolved_part</span> <span class="id" type="var">pb</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">W</span> <span class="id" type="var">pb</span> <span class="id" type="var">w</span>); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">p</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>;<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">In_p</span> <span class="id" type="var">Is_sol</span>;<br/>
<span class="id" type="tactic">refine</span> (<span class="id" type="var">IH</span> (<span class="id" type="var">wf_solve</span> (<span class="id" type="var">W</span> <span class="id" type="var">pb</span> <span class="id" type="var">w</span>) ++ <span class="id" type="var">lpb</span>) (<span class="id" type="var">F_wf_solve_dec2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">p</span> <span class="id" type="var">sigma</span> <br/>
(<span class="id" type="var">in_or_app</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> <span class="id" type="var">In_p</span>)) <span class="id" type="var">Is_sol</span>).<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">w</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">unsolved_part</span> <span class="id" type="var">pb</span>).<br/>
<span class="id" type="tactic">elim</span> (<span class="id" type="var">IH</span> <span class="id" type="var">lpb</span> (<span class="id" type="var">F_wf_solve_dec1</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">p</span> <span class="id" type="var">sigma</span> <span class="id" type="var">In_p</span> <span class="id" type="var">Is_sol_p</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">pb0</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="var">exists</span> <span class="id" type="var">pb0</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">elim</span> (<span class="id" type="var">IH</span> (<span class="id" type="var">wf_solve</span> (<span class="id" type="var">W</span> <span class="id" type="var">pb</span> <span class="id" type="var">w</span>) ++ <span class="id" type="var">lpb</span>) (<span class="id" type="var">F_wf_solve_dec2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">p</span> <span class="id" type="var">sigma</span> <br/>
(<span class="id" type="var">in_or_app</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> (<span class="id" type="var">or_intror</span> <span class="id" type="var">_</span> <span class="id" type="var">In_p</span>)) <span class="id" type="var">Is_sol_p</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">pb0</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="var">exists</span> <span class="id" type="var">pb0</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">wf_solve_loop_end</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">lpb</span> <span class="id" type="var">wpb</span>, <br/>
&nbsp;&nbsp;<span class="id" type="var">In</span> <span class="id" type="var">wpb</span> (<span class="id" type="var">wf_solve_loop</span> <span class="id" type="var">lpb</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">wpb</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">W</span> <span class="id" type="var">pb</span> <span class="id" type="var">_</span> =&gt; (<span class="id" type="var">unsolved_part</span> <span class="id" type="var">pb</span>) = <span class="id" type="var">nil</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">lpb</span>;<br/>
<span class="id" type="tactic">refine</span> (<span class="id" type="var">well_founded_ind</span> <span class="id" type="var">well_founded_o_lpb</span><br/>
(<span class="id" type="keyword">fun</span> <span class="id" type="var">lpb</span> =&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">wpb</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">In</span> <span class="id" type="var">wpb</span> (<span class="id" type="var">wf_solve_loop</span> <span class="id" type="var">lpb</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">wpb</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">W</span> <span class="id" type="var">pb</span> <span class="id" type="var">_</span> =&gt; (<span class="id" type="var">unsolved_part</span> <span class="id" type="var">pb</span>) = <span class="id" type="var">nil</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>) <span class="id" type="var">_</span> <span class="id" type="var">_</span>).<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">lpb</span>;<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">lpb</span> <span class="id" type="var">IH</span> <span class="id" type="var">wpb</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">lpb</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">wf_solve_nil</span>; <span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">wf_solve_cons</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">w</span>.<br/>
<span class="id" type="tactic">cut</span> (<span class="id" type="keyword">forall</span> <span class="id" type="var">pb1</span>, <span class="id" type="var">pb1</span> = <span class="id" type="var">pb</span> -&gt; <span class="id" type="var">unsolved_part</span> <span class="id" type="var">pb1</span> = <span class="id" type="var">unsolved_part</span> <span class="id" type="var">pb</span>).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">unsolved_part</span> <span class="id" type="var">pb</span>);<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">H</span> <span class="id" type="var">pb</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)); <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">H</span> <span class="id" type="var">In_wpb</span>.<br/>
<span class="id" type="tactic">elim</span> <span class="id" type="var">In_wpb</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">In_wpb</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">In_wpb</span>.<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">wpb</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">refine</span> (<span class="id" type="var">IH</span> <span class="id" type="var">lpb</span> (<span class="id" type="var">F_wf_solve_dec1</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">_</span> <span class="id" type="var">In_wpb</span>).<br/>
<span class="id" type="tactic">refine</span> (<span class="id" type="var">IH</span> (<span class="id" type="var">wf_solve</span> (<span class="id" type="var">W</span> <span class="id" type="var">pb</span> <span class="id" type="var">w</span>) ++ <span class="id" type="var">lpb</span>) (<span class="id" type="var">F_wf_solve_dec2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">_</span> <span class="id" type="var">In_wpb</span>).<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">pb</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">init_pb</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> := <span class="id" type="var">mk_pb</span> <span class="id" type="var">nil</span> ((<span class="id" type="var">t1</span>,t2) :: <span class="id" type="var">nil</span>) <span class="id" type="var">nil</span> <span class="id" type="var">nil</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">well_formed_init_pb</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">well_formed_cf</span> <span class="id" type="var">t1</span> -&gt; <span class="id" type="var">well_formed_cf</span> <span class="id" type="var">t2</span> -&gt; <br/>
&nbsp;&nbsp;<span class="id" type="var">well_formed_pb</span> (<span class="id" type="var">init_pb</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">well_formed_pb</span>, <span class="id" type="var">init_pb</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intuition</span>.<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">t0</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">t3</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">None</span> = <span class="id" type="var">Some</span> <span class="id" type="var">p</span>); <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">extract_solution</span> <br/>
&nbsp;(<span class="id" type="var">solved_part</span> :  <span class="id" type="var">substitution</span>) <br/>
&nbsp;&nbsp;(<span class="id" type="var">partly_solved_part</span> : <span class="id" type="var">list</span> (<span class="id" type="var">variable</span>*  <span class="id" type="var">partly_solved_term</span>))<br/>
&nbsp;&nbsp;{<span class="id" type="keyword">struct</span> <span class="id" type="var">partly_solved_part</span>} : <span class="id" type="var">substitution</span> :=<br/>
&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">partly_solved_part</span> <span class="id" type="keyword">with</span><br/>
&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">solved_part</span><br/>
&nbsp;| (<span class="id" type="var">x</span>,x_part_val) :: <span class="id" type="var">tl_partly_solved_part</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">f</span> := <span class="id" type="var">head_symb</span> <span class="id" type="var">x_part_val</span> <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">x_val</span> := <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">quicksort</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">solved_part</span> (<span class="id" type="var">Var</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">x_part_val</span>))) ::<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">closed_term</span> <span class="id" type="var">x_part_val</span>) :: <span class="id" type="var">nil</span>))) <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">extract_solution</span> ((<span class="id" type="var">x</span>, <span class="id" type="var">x_val</span>) :: <span class="id" type="var">solved_part</span>) <span class="id" type="var">tl_partly_solved_part</span><br/>
&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">extract_solution_unfold</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">solved_part</span> <span class="id" type="var">partly_solved_part</span> <span class="id" type="var">x</span> <span class="id" type="var">x_part_val</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">extract_solution</span> <span class="id" type="var">solved_part</span> ((<span class="id" type="var">x</span>,x_part_val) :: <span class="id" type="var">partly_solved_part</span>) =<br/>
&nbsp;&nbsp;<span class="id" type="var">extract_solution</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id" type="var">x</span>, (<span class="id" type="var">Term</span> (<span class="id" type="var">head_symb</span> <span class="id" type="var">x_part_val</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">quicksort</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">flatten</span> (<span class="id" type="var">head_symb</span> <span class="id" type="var">x_part_val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">solved_part</span> (<span class="id" type="var">Var</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">x_part_val</span>))) ::<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">closed_term</span> <span class="id" type="var">x_part_val</span>) :: <span class="id" type="var">nil</span>))))) :: <span class="id" type="var">solved_part</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">partly_solved_part</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">extract_solution_in_solved_part</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">solved_part</span> <span class="id" type="var">partly_solved_part</span> <span class="id" type="var">v</span> <span class="id" type="var">t</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">nb_occ</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">solved_part</span> + <br/>
&nbsp;&nbsp;<span class="id" type="var">nb_occ</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">partly_solved_part</span> &lt;= 1 -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">solved_part</span> = <span class="id" type="var">Some</span> <span class="id" type="var">t</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="var">apply_cf_subst</span> (<span class="id" type="var">extract_solution</span> <span class="id" type="var">solved_part</span> <span class="id" type="var">partly_solved_part</span>) (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>) = <span class="id" type="var">t</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>

<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">sp</span> <span class="id" type="var">psp</span>; <span class="id" type="tactic">generalize</span> <span class="id" type="var">sp</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">sp</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">psp</span> <span class="id" type="keyword">as</span> [ | [<span class="id" type="var">x</span> <span class="id" type="var">s</span>] <span class="id" type="var">psp</span>];<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">sp</span> <span class="id" type="var">v</span> <span class="id" type="var">t</span> <span class="id" type="var">H</span> <span class="id" type="var">v_sp</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">v_sp</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">extract_solution_unfold</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHpsp</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="var">revert</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v</span> <span class="id" type="var">x</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">x</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">v_eq_x</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v_diff_x</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">plus_comm</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">plus_comm</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">revert</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v</span> <span class="id" type="var">x</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">x</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v_diff_x</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">some_nb_occ_Sn</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">_</span> <span class="id" type="var">v_sp</span>);<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">nb_occ</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sp</span>) <span class="id" type="keyword">as</span> [ | <span class="id" type="var">n</span>].<br/>
<span class="id" type="tactic">intro</span>; <span class="id" type="var">absurd</span> (1 &lt;= 0); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">plus_comm</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">S</span>(<span class="id" type="var">S</span> (<span class="id" type="var">nb_occ</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">psp</span> + <span class="id" type="var">n</span>)) &lt;= 1); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">new_var_occ_in_solved_part</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">pb</span>, <span class="id" type="var">unsolved_part</span> <span class="id" type="var">pb</span> = <span class="id" type="var">nil</span> -&gt; <br/>
&nbsp;&nbsp;<span class="id" type="var">well_sorted_partly_solved_part</span> (<span class="id" type="var">partly_solved_part</span> <span class="id" type="var">pb</span>) -&gt;<br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">v</span> <span class="id" type="var">p</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> (<span class="id" type="var">partly_solved_part</span> <span class="id" type="var">pb</span>) = <span class="id" type="var">Some</span> <span class="id" type="var">p</span> -&gt; <span class="id" type="var">occurs_in_pb</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p</span>) <span class="id" type="var">pb</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">partly_solved_part</span> <span class="id" type="var">pb</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">True</span><br/>
&nbsp;&nbsp;| (<span class="id" type="var">v</span>,p) :: <span class="id" type="var">_</span> =&gt; <span class="id" type="keyword">match</span> <span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p</span>) (<span class="id" type="var">solved_part</span> <span class="id" type="var">pb</span>) <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Some</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">True</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">None</span> =&gt; <span class="id" type="var">False</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> [<span class="id" type="var">starting_vars</span> <span class="id" type="var">usp</span> <span class="id" type="var">sp</span> [ | [<span class="id" type="var">v</span> <span class="id" type="var">ps</span>] <span class="id" type="var">psp</span>]] <span class="id" type="var">U</span> <span class="id" type="var">well_sorted</span> <span class="id" type="var">new_var_occ</span>.<br/>
<span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">new_var_occ</span> <span class="id" type="var">v</span> <span class="id" type="var">ps</span>); <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v</span> <span class="id" type="var">v</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">v</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v_diff_v</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">v_diff_v</span>; <span class="id" type="tactic">reflexivity</span>].<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">new_var_ps_occ</span>; <br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">new_var_ps_occ</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)); <span class="id" type="tactic">clear</span> <span class="id" type="var">new_var_ps_occ</span>;<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">occurs_in_pb</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">U</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">usp</span>; <span class="id" type="tactic">simpl</span>;<br/>
<span class="id" type="tactic">intros</span> [<span class="id" type="var">F</span> | <span class="id" type="var">new_var_ps_occ</span>]; [<span class="id" type="var">contradiction</span> | <span class="id" type="var">idtac</span>].<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">some_nb_occ_Sn</span> <span class="id" type="var">X.eq_bool</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">ps</span>) <span class="id" type="var">psp</span>);<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">ps</span>) <span class="id" type="var">psp</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">new_var_ps_val</span> | ].<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">F</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">F</span> <span class="id" type="var">new_var_ps_val</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)); <span class="id" type="tactic">clear</span> <span class="id" type="var">F</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">F</span>;<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">well_sorted</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">well_sorted</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">_</span> [<span class="id" type="var">H</span> <span class="id" type="var">_</span>]];<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">new_var_diff_new_var</span> := <span class="id" type="var">H</span> <span class="id" type="var">_</span> <span class="id" type="var">F</span>);<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">ps</span> = <span class="id" type="var">new_var</span> <span class="id" type="var">ps</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">revert</span> <span class="id" type="var">new_var_ps_occ</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">ps</span>) <span class="id" type="var">v</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">ps</span>) <span class="id" type="var">v</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">new_var_ps_eq_v</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">new_var_ps_diff_v</span>].<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">v</span>  = <span class="id" type="var">new_var</span> <span class="id" type="var">ps</span>); [<span class="id" type="tactic">destruct</span> <span class="id" type="var">well_sorted</span> | <span class="id" type="tactic">apply</span> <span class="id" type="var">sym_eq</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intuition</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">extract_solution_in_partly_solved_part</span> :<br/>
<span class="id" type="keyword">forall</span> <span class="id" type="var">solved_part</span> <span class="id" type="var">partly_solved_part</span> <span class="id" type="var">ex</span>,<br/>
&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">v</span>, <span class="id" type="var">nb_occ</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">solved_part</span> +<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">nb_occ</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">partly_solved_part</span> &lt;= 1) -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="var">well_sorted_partly_solved_part</span> <span class="id" type="var">partly_solved_part</span> -&gt;<br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">v</span> <span class="id" type="var">p</span>, <span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">partly_solved_part</span> = <span class="id" type="var">Some</span> <span class="id" type="var">p</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">occurs_in_pb</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">mk_pb</span> <span class="id" type="var">ex</span> <span class="id" type="var">nil</span> <span class="id" type="var">solved_part</span> <span class="id" type="var">partly_solved_part</span>)) -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">v</span> <span class="id" type="var">p</span>, <span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">partly_solved_part</span> = <span class="id" type="var">Some</span> <span class="id" type="var">p</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="var">apply_cf_subst</span> (<span class="id" type="var">extract_solution</span> <span class="id" type="var">solved_part</span> <span class="id" type="var">partly_solved_part</span>) (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>) = <br/>
&nbsp;&nbsp;<span class="id" type="var">Term</span> (<span class="id" type="var">head_symb</span> <span class="id" type="var">p</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">quicksort</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">flatten</span> (<span class="id" type="var">head_symb</span> <span class="id" type="var">p</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id" type="var">apply_cf_subst</span> (<span class="id" type="var">extract_solution</span> <span class="id" type="var">solved_part</span> <span class="id" type="var">partly_solved_part</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">Var</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p</span>))) ::<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">closed_term</span> <span class="id" type="var">p</span>) :: <span class="id" type="var">nil</span>))).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">sp</span> <span class="id" type="var">psp</span>; <span class="id" type="tactic">generalize</span> <span class="id" type="var">sp</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">sp</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">psp</span> <span class="id" type="keyword">as</span> [ | [<span class="id" type="var">x</span> <span class="id" type="var">s</span>] <span class="id" type="var">psp</span>];<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">sp</span> <span class="id" type="var">ex</span> <span class="id" type="var">only_one_occ</span> <span class="id" type="var">well_sorted</span> <span class="id" type="var">new_var_occ</span> <span class="id" type="var">y</span> <span class="id" type="var">p</span> <span class="id" type="var">y_psp</span>.<br/>
<span class="id" type="tactic">discriminate</span>.<br/>

<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">y_psp</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">extract_solution_unfold</span>.<br/>
<span class="id" type="var">revert</span> <span class="id" type="var">y_psp</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">y</span> <span class="id" type="var">x</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">y</span> <span class="id" type="var">x</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">y_eq_x</span> <span class="id" type="var">y_psp</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">y_diff_x</span> <span class="id" type="var">y_psp</span>].<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">y_psp</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H</span> :=<br/>
&nbsp;&nbsp;(<span class="id" type="var">extract_solution_in_solved_part</span> <br/>
&nbsp;&nbsp;((<span class="id" type="var">x</span>, (<span class="id" type="var">Term</span> (<span class="id" type="var">head_symb</span> <span class="id" type="var">p</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">quicksort</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">flatten</span> (<span class="id" type="var">head_symb</span> <span class="id" type="var">p</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sp</span> (<span class="id" type="var">Var</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:: <span class="id" type="var">closed_term</span> <span class="id" type="var">p</span> :: <span class="id" type="var">nil</span>))))) :: <span class="id" type="var">sp</span>)<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">psp</span> <span class="id" type="var">x</span><br/>
&nbsp;&nbsp;&nbsp;(<span class="id" type="var">Term</span> (<span class="id" type="var">head_symb</span> <span class="id" type="var">p</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">quicksort</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">flatten</span> (<span class="id" type="var">head_symb</span> <span class="id" type="var">p</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sp</span> (<span class="id" type="var">Var</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:: <span class="id" type="var">closed_term</span> <span class="id" type="var">p</span> :: <span class="id" type="var">nil</span>)))))).<br/>
<span class="id" type="tactic">refine</span> (<span class="id" type="var">trans_eq</span> (<span class="id" type="var">H</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">_</span>); <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span> <span class="id" type="var">y_psp</span>. <span class="id" type="tactic">generalize</span> (<span class="id" type="var">only_one_occ</span> <span class="id" type="var">x</span>); <span class="id" type="tactic">simpl</span>; <br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">x</span> <span class="id" type="var">x</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">x</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">x_diff_x</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">x_diff_x</span>; <span class="id" type="tactic">reflexivity</span>].<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">plus_comm</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">plus_comm</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">x</span> <span class="id" type="var">x</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">x</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">x_diff_x</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">x_diff_x</span>; <span class="id" type="tactic">reflexivity</span>].<br/>
<span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">t</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Term</span> (<span class="id" type="var">head_symb</span> <span class="id" type="var">p</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">quicksort</span> (<span class="id" type="var">flatten</span> (<span class="id" type="var">head_symb</span> <span class="id" type="var">p</span>) (<span class="id" type="var">t</span> :: <span class="id" type="var">closed_term</span> <span class="id" type="var">p</span> :: <span class="id" type="var">nil</span>))))).<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">new_var_occ_in_solved_part</span> (<span class="id" type="var">mk_pb</span> <span class="id" type="var">ex</span> <span class="id" type="var">nil</span> <span class="id" type="var">sp</span> ((<span class="id" type="var">x</span>,p) :: <span class="id" type="var">psp</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>) <span class="id" type="var">well_sorted</span> <span class="id" type="var">new_var_occ</span>).<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="var">partly_solved_part</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="var">solved_part</span>.<br/>
<span class="id" type="tactic">replace</span> (<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sp</span> (<span class="id" type="var">Var</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p</span>))) <span class="id" type="keyword">with</span><br/>
(<span class="id" type="keyword">match</span> <span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p</span>) <span class="id" type="var">sp</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Some</span>  <span class="id" type="var">new_var_p_val</span> =&gt; <span class="id" type="var">new_var_p_val</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">None</span> =&gt; <span class="id" type="var">Var</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>) <span class="id" type="tactic">by</span> <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p</span>) <span class="id" type="var">sp</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">new_var_p_val</span> <span class="id" type="var">F</span> <span class="id" type="var">_</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">F</span>]; [<span class="id" type="var">idtac</span> | <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H</span>:= <br/>
&nbsp;&nbsp;&nbsp;(<span class="id" type="var">extract_solution_in_solved_part</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id" type="var">x</span>, (<span class="id" type="var">Term</span> (<span class="id" type="var">head_symb</span> <span class="id" type="var">p</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">quicksort</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">flatten</span> (<span class="id" type="var">head_symb</span> <span class="id" type="var">p</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sp</span> (<span class="id" type="var">Var</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:: <span class="id" type="var">closed_term</span> <span class="id" type="var">p</span> :: <span class="id" type="var">nil</span>))))) :: <span class="id" type="var">sp</span>)<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">psp</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p</span>) <span class="id" type="var">new_var_p_val</span>)).<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H</span> <span class="id" type="tactic">at</span> 1.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="var">apply_cf_subst</span> <span class="id" type="tactic">at</span> 2; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">F</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">only_one_occ</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p</span>)); <span class="id" type="tactic">simpl</span>;<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p</span>) <span class="id" type="var">x</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p</span>) <span class="id" type="var">x</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">new_var_p_eq_x</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">new_var_p_diff_x</span>].<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">well_sorted</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x_diff_new_var_p</span> <span class="id" type="var">_</span>]; <br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">x</span> = <span class="id" type="var">new_var</span> <span class="id" type="var">p</span>); <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">sym_eq</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p</span>) <span class="id" type="var">x</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p</span>) <span class="id" type="var">x</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">new_var_p_eq_x</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">new_var_p_diff_x</span>].<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">well_sorted</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x_diff_new_var_p</span> <span class="id" type="var">_</span>]; <br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">x</span> = <span class="id" type="var">new_var</span> <span class="id" type="var">p</span>); <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">sym_eq</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">trivial</span>.<br/>

<br/>
<span class="id" type="tactic">refine</span> (<span class="id" type="var">IHpsp</span> <span class="id" type="var">_</span> <span class="id" type="var">ex</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">y</span> <span class="id" type="var">p</span> <span class="id" type="var">y_psp</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">z</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">only_one_occ</span> <span class="id" type="var">z</span>); <span class="id" type="tactic">simpl</span>;<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">z</span> <span class="id" type="var">x</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">z</span> <span class="id" type="var">x</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">z_eq_x</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">z_diff_x</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">plus_comm</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">plus_comm</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">well_sorted</span>; <span class="id" type="tactic">intuition</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">z</span> <span class="id" type="var">z_val</span> <span class="id" type="var">z_psp</span>; <br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">new_var_occ</span> <span class="id" type="var">z</span>) (<span class="id" type="var">only_one_occ</span> <span class="id" type="var">z</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">some_nb_occ_Sn</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">z</span> <span class="id" type="var">psp</span> <span class="id" type="var">z_psp</span>);<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="var">find</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="var">nb_occ</span>;<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">z</span> <span class="id" type="var">x</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">z</span> <span class="id" type="var">x</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">z_eq_x</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">z_diff_x</span>].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">z</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">nb_occ</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">psp</span>) <span class="id" type="keyword">as</span> [ | <span class="id" type="var">n</span>].<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="var">absurd</span> (1 &lt;= 0); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">plus_comm</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="var">plus</span>;<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="var">absurd</span> (<span class="id" type="var">S</span> (<span class="id" type="var">S</span> (<span class="id" type="var">n</span> + <span class="id" type="var">nb_occ</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">sp</span>)) &lt;= 1); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">H</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">H</span> <span class="id" type="var">z_val</span> <span class="id" type="var">z_psp</span>).<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">occurs_in_pb</span>; <span class="id" type="tactic">simpl</span>;<br/>
<span class="id" type="tactic">intros</span> [<span class="id" type="var">occ_in_usp</span> | [<span class="id" type="var">occ_in_psp</span> | <span class="id" type="var">occ_in_sp</span>]].<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">revert</span> <span class="id" type="var">occ_in_psp</span>.<br/>
<span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">z_val</span>) <span class="id" type="var">x</span>); [<span class="id" type="var">right</span> | <span class="id" type="var">left</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">z_val</span>) <span class="id" type="var">x</span>); <span class="id" type="var">right</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">clean_sol</span> <br/>
&nbsp;&nbsp;(<span class="id" type="var">existential_vars</span> : <span class="id" type="var">list</span> <span class="id" type="var">variable</span>) (<span class="id" type="var">sigma</span> : <span class="id" type="var">substitution</span>) <br/>
&nbsp;&nbsp;{<span class="id" type="keyword">struct</span> <span class="id" type="var">sigma</span>} : <span class="id" type="var">substitution</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">sigma</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">nil</span><br/>
&nbsp;&nbsp;| (<span class="id" type="var">x</span>,x_val) :: <span class="id" type="var">tl_sigma</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">if</span> <span class="id" type="var">mem_bool</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">existential_vars</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">then</span> <span class="id" type="var">clean_sol</span> <span class="id" type="var">existential_vars</span> <span class="id" type="var">tl_sigma</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">else</span> (<span class="id" type="var">x</span>, <span class="id" type="var">x_val</span>) :: (<span class="id" type="var">clean_sol</span> <span class="id" type="var">existential_vars</span> <span class="id" type="var">tl_sigma</span>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">matching</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">map</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">fun</span> <span class="id" type="var">wpb</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">wpb</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">W</span> <span class="id" type="var">pb</span> <span class="id" type="var">_</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">clean_sol</span> (<span class="id" type="var">existential_vars</span> <span class="id" type="var">pb</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">extract_solution</span> (<span class="id" type="var">solved_part</span> <span class="id" type="var">pb</span>) (<span class="id" type="var">partly_solved_part</span> <span class="id" type="var">pb</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">wf_solve_loop</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id" type="var">W</span> (<span class="id" type="var">init_pb</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>) (<span class="id" type="var">well_formed_init_pb</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span>)) :: <span class="id" type="var">nil</span>)).<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">variable_preservation</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">v</span> <span class="id" type="var">lpb</span>, <br/>
&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">wpb</span>, <span class="id" type="var">In</span> <span class="id" type="var">wpb</span> <span class="id" type="var">lpb</span> -&gt;<br/>
&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">wpb</span> <span class="id" type="keyword">with</span><br/>
&nbsp;| <span class="id" type="var">W</span> <span class="id" type="var">pb</span> <span class="id" type="var">_</span> =&gt; (~ <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">existential_vars</span> <span class="id" type="var">pb</span>)) /\ (<span class="id" type="var">occurs_in_pb</span> <span class="id" type="var">v</span> <span class="id" type="var">pb</span>)<br/>
&nbsp;<span class="id" type="keyword">end</span>) -&gt;<br/>
&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">wpb'</span>, <span class="id" type="var">In</span> <span class="id" type="var">wpb'</span> (<span class="id" type="var">wf_solve_loop</span> <span class="id" type="var">lpb</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">wpb'</span> <span class="id" type="keyword">with</span><br/>
&nbsp;| <span class="id" type="var">W</span> <span class="id" type="var">pb'</span> <span class="id" type="var">_</span> =&gt;  (~ <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">existential_vars</span> <span class="id" type="var">pb'</span>)) /\ (<span class="id" type="var">occurs_in_pb</span> <span class="id" type="var">v</span> <span class="id" type="var">pb'</span>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">lpb</span>;<br/>
<span class="id" type="tactic">refine</span> (<span class="id" type="var">well_founded_ind</span> <span class="id" type="var">well_founded_o_lpb</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">fun</span> <span class="id" type="var">lpb</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">wpb</span> : <span class="id" type="var">well_formed_matching_problem</span>, <span class="id" type="var">In</span> <span class="id" type="var">wpb</span> <span class="id" type="var">lpb</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">wpb</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">W</span> <span class="id" type="var">pb</span> <span class="id" type="var">_</span> =&gt; ~ <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">existential_vars</span> <span class="id" type="var">pb</span>) /\ <span class="id" type="var">occurs_in_pb</span> <span class="id" type="var">x</span> <span class="id" type="var">pb</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">wpb'</span> : <span class="id" type="var">well_formed_matching_problem</span>, <span class="id" type="var">In</span> <span class="id" type="var">wpb'</span> (<span class="id" type="var">wf_solve_loop</span> <span class="id" type="var">lpb</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">wpb'</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">W</span> <span class="id" type="var">pb'</span> <span class="id" type="var">_</span> =&gt; ~ <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">existential_vars</span> <span class="id" type="var">pb'</span>) /\ <span class="id" type="var">occurs_in_pb</span> <span class="id" type="var">x</span> <span class="id" type="var">pb'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>) <span class="id" type="var">_</span> <span class="id" type="var">_</span>).<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">lpb</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">lpb</span> <span class="id" type="var">IH</span> <span class="id" type="var">P_lpb</span> <span class="id" type="var">wpb</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">lpb</span> <span class="id" type="keyword">as</span> [ | [<span class="id" type="var">pb</span> <span class="id" type="var">w_pb</span>] <span class="id" type="var">lpb</span>].<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">wf_solve_nil</span>; <span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">wf_solve_cons</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">pb</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">ex</span> [ | [<span class="id" type="var">s</span> <span class="id" type="var">t</span>] <span class="id" type="var">usp</span>] <span class="id" type="var">sp</span> <span class="id" type="var">psp</span>];<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="var">unsolved_part</span>; <span class="id" type="var">cbv</span> <span class="id" type="var">iota</span>.<br/>
<span class="id" type="tactic">intros</span> [<span class="id" type="var">wpb_eq_w_pb</span> | <span class="id" type="var">wpb_in_loop_lpb</span>].<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">wpb</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">P_lpb</span> (<span class="id" type="var">W</span> (<span class="id" type="var">mk_pb</span> <span class="id" type="var">ex</span> <span class="id" type="var">nil</span> <span class="id" type="var">sp</span> <span class="id" type="var">psp</span>) <span class="id" type="var">w_pb</span>)); <span class="id" type="tactic">trivial</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">refine</span> (<span class="id" type="var">IH</span> <span class="id" type="var">lpb</span> (<span class="id" type="var">F_wf_solve_dec1</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">_</span> <span class="id" type="var">wpb</span> <span class="id" type="var">wpb_in_loop_lpb</span>); <br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">P_lpb</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>

<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">wpb_in_loop</span>; <br/>
<span class="id" type="tactic">refine</span> (<span class="id" type="var">IH</span> (<span class="id" type="var">wf_solve</span> (<span class="id" type="var">W</span> (<span class="id" type="var">mk_pb</span> <span class="id" type="var">ex</span> ((<span class="id" type="var">s</span>, <span class="id" type="var">t</span>) :: <span class="id" type="var">usp</span>) <span class="id" type="var">sp</span> <span class="id" type="var">psp</span>) <span class="id" type="var">w_pb</span>) ++ <span class="id" type="var">lpb</span>) (<span class="id" type="var">F_wf_solve_dec2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">_</span> <span class="id" type="var">wpb</span> <span class="id" type="var">wpb_in_loop</span>).<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">wpb</span> <span class="id" type="var">wpb_in_loop</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">wpb</span> <span class="id" type="var">wpb_in_loop</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">in_app_or</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">wpb_in_loop</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">wpb_in_solve_pb</span> | <span class="id" type="var">wpb_in_loop_lpb</span>];<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">wpb_in_loop</span>; [ <span class="id" type="var">idtac</span> |  <span class="id" type="tactic">apply</span> <span class="id" type="var">P_lpb</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>].<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">P_lpb</span> <span class="id" type="var">_</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>))); <span class="id" type="tactic">simpl</span> <span class="id" type="var">existential_vars</span>; <span class="id" type="tactic">intros</span> [<span class="id" type="var">NE</span> <span class="id" type="var">O</span>].<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">wpb</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">pb'</span> <span class="id" type="var">w_pb'</span>]; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">wf_projection</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">wpb_in_solve_pb</span>).<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">lpb</span> <span class="id" type="var">IH</span> <span class="id" type="var">P_lpb</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">solve</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="var">unsolved_part</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="var">solved_part</span>; <span class="id" type="var">cbv</span> <span class="id" type="var">iota</span> <span class="id" type="var">beta</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">s</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">v</span> | <span class="id" type="var">f1</span> <span class="id" type="var">l1</span>].<br/>
<span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sp</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">v_val</span> <span class="id" type="var">v_sp</span>| <span class="id" type="tactic">intro</span> <span class="id" type="var">v_sp</span>].<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">T.eq_bool_ok</span> <span class="id" type="var">v_val</span> <span class="id" type="var">t</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">T.eq_bool</span> <span class="id" type="var">v_val</span> <span class="id" type="var">t</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">v_val_eq_t</span> | <span class="id" type="tactic">intros</span>; <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="var">existential_vars</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="var">partly_solved_part</span>;<br/>
<span class="id" type="tactic">intros</span> [<span class="id" type="var">pb'_eq_pb1</span> | <span class="id" type="var">pb'_in_nil</span>]; [<span class="id" type="tactic">subst</span> <span class="id" type="var">pb'</span> | <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">split</span>; [<span class="id" type="tactic">trivial</span> | <span class="id" type="var">idtac</span>].<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">O</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">O</span> | <span class="id" type="var">O</span> ]; [<span class="id" type="var">idtac</span> | <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>].<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="var">unsolved_part</span> <span class="id" type="keyword">in</span> <span class="id" type="var">O</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">O</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">O</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">O</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">O</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">v</span>; <span class="id" type="var">right</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">v_sp</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="var">partly_solved_part</span>;<br/>
<span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">psp</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">v_pval</span> <span class="id" type="var">v_psp</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v_psp</span>].<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">f2</span> <span class="id" type="var">l2</span>]; [<span class="id" type="tactic">intro</span>; <span class="id" type="var">contradiction</span> | <span class="id" type="var">idtac</span>].<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> (<span class="id" type="var">head_symb</span> <span class="id" type="var">v_pval</span>) <span class="id" type="var">f2</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> (<span class="id" type="var">head_symb</span> <span class="id" type="var">v_pval</span>) <span class="id" type="var">f2</span>); <br/>
[<span class="id" type="tactic">intro</span> <span class="id" type="var">top_v_pval_eq_f2</span> | <span class="id" type="tactic">intros</span>; <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">remove</span> <span class="id" type="var">T.eq_bool</span> (<span class="id" type="var">closed_term</span> <span class="id" type="var">v_pval</span>) <span class="id" type="var">l2</span>); [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">intros</span>; <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">intros</span> [<span class="id" type="var">pb'_eq_pb1</span> | <span class="id" type="var">pb'_in_nil</span>]; [<span class="id" type="tactic">subst</span> <span class="id" type="var">pb'</span> | <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="var">existential_vars</span>; <span class="id" type="tactic">split</span>; [<span class="id" type="tactic">trivial</span> | <span class="id" type="var">idtac</span>].<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">O</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">O</span> | [ <span class="id" type="var">O</span> | <span class="id" type="var">O</span> ]].<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="var">unsolved_part</span> <span class="id" type="keyword">in</span> <span class="id" type="var">O</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">O</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">O</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">O</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">O</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">v</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">v_psp</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> [<span class="id" type="var">pb'_eq_pb1</span> | <span class="id" type="var">pb'_in_nil</span>]; [<span class="id" type="tactic">subst</span> <span class="id" type="var">pb'</span> | <span class="id" type="tactic">intros</span>; <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="var">existential_vars</span>; <span class="id" type="tactic">split</span>; [<span class="id" type="tactic">trivial</span> | <span class="id" type="var">idtac</span>].<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">O</span> <span class="id" type="keyword">as</span> [ [<span class="id" type="var">O</span> | <span class="id" type="var">O</span>] | [ <span class="id" type="var">O</span> | <span class="id" type="var">O</span> ]].<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">O</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">v</span>; <span class="id" type="var">right</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">simpl</span>; <br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">x</span> <span class="id" type="var">x</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">x</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">exact</span> <span class="id" type="var">I</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">x_diff_x</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">x_diff_x</span>; <span class="id" type="tactic">reflexivity</span>].<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">v</span>); <span class="id" type="tactic">trivial</span>.<br/>

<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">f2</span> <span class="id" type="var">l2</span>]; [<span class="id" type="tactic">intros</span>; <span class="id" type="var">contradiction</span> | <span class="id" type="var">idtac</span>].<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f1</span> <span class="id" type="var">f2</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f1</span> <span class="id" type="var">f2</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">f1_eq_f2</span> | <span class="id" type="tactic">intros</span>; <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">f2</span>; <span class="id" type="var">case_eq</span> (<span class="id" type="var">arity</span> <span class="id" type="var">f1</span>); [ <span class="id" type="tactic">intro</span> <span class="id" type="var">Af1</span>| <span class="id" type="tactic">intro</span> <span class="id" type="var">Af1</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">n</span> <span class="id" type="var">Af1</span>].<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">le_gt_dec</span> (<span class="id" type="var">length</span> <span class="id" type="var">l1</span>) (<span class="id" type="var">length</span> <span class="id" type="var">l2</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">L</span> | <span class="id" type="var">L</span>]; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">intros</span>; <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">l1</span> <span class="id" type="keyword">as</span> [ | [<span class="id" type="var">v1</span> | <span class="id" type="var">g1</span> <span class="id" type="var">ll1</span>] <span class="id" type="var">l1</span>].<br/>
<span class="id" type="tactic">intros</span> [<span class="id" type="var">pb'_eq_pb1</span> | <span class="id" type="var">pb'_in_nil</span>]; [<span class="id" type="tactic">subst</span> <span class="id" type="var">pb'</span> | <span class="id" type="tactic">intros</span>; <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">O</span> <span class="id" type="keyword">as</span> [ [<span class="id" type="var">O</span> | <span class="id" type="var">O</span>] | <span class="id" type="var">O</span>]; [<span class="id" type="var">contradiction</span> | <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span> | <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>].<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="var">solved_part</span>;<br/>
<span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v1</span> <span class="id" type="var">sp</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">v1_val</span> <span class="id" type="var">v1_sp</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v1_sp</span>].<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">ac_elementary_solve_term_var_with_val_term</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">remove</span> <span class="id" type="var">T.eq_bool</span> <span class="id" type="var">v1_val</span> <span class="id" type="var">l2</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">l2'</span> | ].<br/>
<span class="id" type="tactic">intros</span> [<span class="id" type="var">pb'_eq_pb1</span> | <span class="id" type="var">pb'_in_nil</span>]; [<span class="id" type="tactic">subst</span> <span class="id" type="var">pb'</span> | <span class="id" type="tactic">intros</span>; <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">split</span>; [<span class="id" type="tactic">trivial</span> | <span class="id" type="var">idtac</span>].<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">O</span> <span class="id" type="keyword">as</span> [ [[<span class="id" type="var">O</span> | <span class="id" type="var">O</span>] | <span class="id" type="var">O</span>] | <span class="id" type="var">O</span>]; [<span class="id" type="var">idtac</span> | <span class="id" type="var">idtac</span> | <span class="id" type="var">idtac</span> | <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>].<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">x</span>; <span class="id" type="var">right</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">v1_sp</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">l1</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">s1</span> [ | <span class="id" type="var">t1</span> <span class="id" type="var">l1</span>]]; [<span class="id" type="var">contradiction</span> | <span class="id" type="tactic">intuition</span> | <span class="id" type="tactic">simpl</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">list_permut_occurs_in_term_list</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">s1</span> :: <span class="id" type="var">t1</span> :: <span class="id" type="var">l1</span>); <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">quick_permut</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">v1_val</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">g</span> <span class="id" type="var">ll</span>]; [<span class="id" type="tactic">intros</span>; <span class="id" type="var">contradiction</span> | <span class="id" type="var">idtac</span>].<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f1</span> <span class="id" type="var">g</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f1</span> <span class="id" type="var">g</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">f1_eq_g</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">g</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">f1_diff_g</span>; <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">remove_list</span> <span class="id" type="var">ll</span> <span class="id" type="var">l2</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">l2'</span> | ]; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">intros</span>; <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">EDS.A</span>, <span class="id" type="var">DOS.A</span> <span class="id" type="keyword">in</span> *; <br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">le_gt_dec</span> (<span class="id" type="var">length</span> <span class="id" type="var">l1</span>) (<span class="id" type="var">length</span> <span class="id" type="var">l2'</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">L'</span> | <span class="id" type="var">L'</span>]; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">intros</span>; <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">intros</span> [<span class="id" type="var">pb'_eq_pb1</span> | <span class="id" type="var">pb'_in_nil</span>]; [<span class="id" type="tactic">subst</span> <span class="id" type="var">pb'</span> | <span class="id" type="tactic">intros</span>; <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">split</span>; [<span class="id" type="tactic">trivial</span> | <span class="id" type="var">idtac</span>].<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">O</span> <span class="id" type="keyword">as</span> [ [[<span class="id" type="var">O</span> | <span class="id" type="var">O</span>] | <span class="id" type="var">O</span>] | <span class="id" type="var">O</span>]; [<span class="id" type="var">idtac</span> | <span class="id" type="var">idtac</span> | <span class="id" type="var">idtac</span> | <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>].<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">x</span>; <span class="id" type="var">right</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">v1_sp</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">l1</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">s1</span> [ | <span class="id" type="var">t1</span> <span class="id" type="var">l1</span>]]; [<span class="id" type="var">contradiction</span> | <span class="id" type="tactic">intuition</span> | <span class="id" type="tactic">simpl</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">list_permut_occurs_in_term_list</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">s1</span> :: <span class="id" type="var">t1</span> :: <span class="id" type="var">l1</span>); <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">quick_permut</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v1</span> <span class="id" type="var">psp</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">v1_pval</span> <span class="id" type="var">v1_psp</span>| <span class="id" type="tactic">intro</span> <span class="id" type="var">v1_psp</span>].<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">ac_elementary_solve_term_var_with_part_val_term</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f1</span> (<span class="id" type="var">head_symb</span> <span class="id" type="var">v1_pval</span>)); <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f1</span> (<span class="id" type="var">head_symb</span> <span class="id" type="var">v1_pval</span>)); <br/>
[<span class="id" type="tactic">intro</span> <span class="id" type="var">f1_eq_top_v1_pval</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">f1_diff_top_v1_pval</span>].<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">remove</span> <span class="id" type="var">T.eq_bool</span> (<span class="id" type="var">closed_term</span> <span class="id" type="var">v1_pval</span>) <span class="id" type="var">l2</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">l2'</span> | ]; <br/>
[<span class="id" type="var">idtac</span> | <span class="id" type="tactic">intros</span>; <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">intros</span> [<span class="id" type="var">pb'_eq_pb1</span> | <span class="id" type="var">pb'_in_nil</span>]; [<span class="id" type="tactic">subst</span> <span class="id" type="var">pb'</span> | <span class="id" type="tactic">intros</span>; <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">split</span>; [<span class="id" type="tactic">trivial</span> | <span class="id" type="var">idtac</span>].<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">O</span> <span class="id" type="keyword">as</span> [ [ [ <span class="id" type="var">O</span> | <span class="id" type="var">O</span>] | <span class="id" type="var">O</span>] | <span class="id" type="var">O</span> ]; [<span class="id" type="var">idtac</span> | <span class="id" type="var">idtac</span> | <span class="id" type="var">idtac</span> | <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>].<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">x</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">v1_psp</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">l1</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t1</span> <span class="id" type="var">l1</span>]; [<span class="id" type="var">contradiction</span> | <span class="id" type="var">idtac</span>].<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">list_permut_occurs_in_term_list</span> <span class="id" type="keyword">with</span> ((<span class="id" type="var">Var</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">v1_pval</span>)) :: <span class="id" type="var">t1</span> :: <span class="id" type="var">l1</span>);<br/>
[ <span class="id" type="tactic">apply</span> <span class="id" type="var">quick_permut</span> | <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span> ].<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">pb'_in_lpb</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">pb'</span>;<br/>
<span class="id" type="tactic">refine</span> (<span class="id" type="var">prop_map_without_repetition</span> <span class="id" type="var">_</span> <span class="id" type="var">T.eq_bool_ok</span>  <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">pb'_in_lpb</span>);<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">pb'</span> <span class="id" type="var">w_pb'</span> <span class="id" type="var">pb'_in_lpb</span> <span class="id" type="var">wpb_in_solve_pb</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">t2</span> <span class="id" type="var">t2_in_l2</span>; <br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t2</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">g2</span> <span class="id" type="var">ll2</span> ]; [<span class="id" type="tactic">trivial</span> | <span class="id" type="var">idtac</span>].<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">g2</span> (<span class="id" type="var">head_symb</span> <span class="id" type="var">v1_pval</span>)); <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">g2</span> (<span class="id" type="var">head_symb</span> <span class="id" type="var">v1_pval</span>));<br/>
[<span class="id" type="tactic">intros</span> <span class="id" type="var">g2_eq_top_v1_pval</span> | <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">trivial</span>].<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">remove</span> <span class="id" type="var">T.eq_bool</span> (<span class="id" type="var">closed_term</span> <span class="id" type="var">v1_pval</span>) <span class="id" type="var">ll2</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">ll2'</span> | ]; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">trivial</span>].<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">remove</span> <span class="id" type="var">T.eq_bool</span> (<span class="id" type="var">Term</span> <span class="id" type="var">g2</span> <span class="id" type="var">ll2</span>) <span class="id" type="var">l2</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">l2'</span> | ]; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">trivial</span>].<br/>
<span class="id" type="tactic">split</span>; [<span class="id" type="tactic">trivial</span> | <span class="id" type="var">idtac</span>].<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">O</span> <span class="id" type="keyword">as</span> [ [[<span class="id" type="var">O</span> | <span class="id" type="var">O</span>] | <span class="id" type="var">O</span>] | <span class="id" type="var">O</span>]; [<span class="id" type="var">idtac</span> | <span class="id" type="var">idtac</span> | <span class="id" type="var">idtac</span> | <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>].<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">x</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">v1_psp</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">l1</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">s1</span> [ | <span class="id" type="var">t1</span> <span class="id" type="var">l1</span>]]; [<span class="id" type="var">contradiction</span> | <span class="id" type="tactic">intuition</span> | <span class="id" type="var">idtac</span>].<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">list_permut_occurs_in_term_list</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">s1</span> :: <span class="id" type="var">t1</span> :: <span class="id" type="var">l1</span>); <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">quick_permut</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">right</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">ac_elementary_solve_term_var_without_val_term</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">pb'_in_lpb</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">pb'</span>;<br/>
<span class="id" type="tactic">refine</span> (<span class="id" type="var">prop_map12_without_repetition</span> <span class="id" type="var">_</span> <span class="id" type="var">T.eq_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">pb'_in_lpb</span>); <br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">pb'</span> <span class="id" type="var">w_pb'</span> <span class="id" type="var">pb'_in_lpb</span> <span class="id" type="var">wpb_in_solve_pb</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">t2</span> <span class="id" type="var">t2_in_l2</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">remove</span> <span class="id" type="var">T.eq_bool</span> <span class="id" type="var">t2</span> <span class="id" type="var">l2</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">l2'</span> | ]; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">trivial</span>].<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">EDS.A</span>, <span class="id" type="var">DOS.A</span> <span class="id" type="keyword">in</span> *;<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">le_gt_dec</span> (<span class="id" type="var">length</span> <span class="id" type="var">l2</span>) (<span class="id" type="var">length</span> <span class="id" type="var">l1</span> + 1)) <span class="id" type="keyword">as</span> [<span class="id" type="var">L'</span> | <span class="id" type="var">L'</span>].<br/>
<span class="id" type="tactic">split</span>; [<span class="id" type="tactic">trivial</span> | <span class="id" type="var">idtac</span>].<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">O</span> <span class="id" type="keyword">as</span> [ [[<span class="id" type="var">O</span> | <span class="id" type="var">O</span>] | <span class="id" type="var">O</span>] | [ <span class="id" type="var">O</span> | <span class="id" type="var">O</span>]].<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">O</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">x</span>; <span class="id" type="tactic">simpl</span>;<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v1</span> <span class="id" type="var">v1</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v1</span> <span class="id" type="var">v1</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">trivial</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v1_diff_v1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">v1_diff_v1</span>; <span class="id" type="tactic">reflexivity</span>].<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">l1</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">s1</span> [ | <span class="id" type="var">t1</span> <span class="id" type="var">l1</span>]]; [<span class="id" type="var">contradiction</span> | <span class="id" type="tactic">intuition</span> | <span class="id" type="var">idtac</span>].<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">list_permut_occurs_in_term_list</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">s1</span> :: <span class="id" type="var">t1</span> :: <span class="id" type="var">l1</span>); <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">quick_permut</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">v1</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">split</span>; <span class="id" type="tactic">split</span>; [<span class="id" type="tactic">trivial</span> | <span class="id" type="var">idtac</span> | <span class="id" type="var">idtac</span> | <span class="id" type="var">idtac</span>].<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">O</span> <span class="id" type="keyword">as</span> [ [[<span class="id" type="var">O</span> | <span class="id" type="var">O</span>] | <span class="id" type="var">O</span>] | [ <span class="id" type="var">O</span> | <span class="id" type="var">O</span> ]].<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">O</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">x</span>; <span class="id" type="tactic">simpl</span>;<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v1</span> <span class="id" type="var">v1</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v1</span> <span class="id" type="var">v1</span>); [<span class="id" type="tactic">trivial</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v1_diff_v1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">v1_diff_v1</span>; <span class="id" type="tactic">reflexivity</span>].<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">l1</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">s1</span> [ | <span class="id" type="var">t1</span> <span class="id" type="var">l1</span>]]; [<span class="id" type="var">contradiction</span> | <span class="id" type="tactic">intuition</span> | <span class="id" type="var">idtac</span>].<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">list_permut_occurs_in_term_list</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">s1</span> :: <span class="id" type="var">t1</span> :: <span class="id" type="var">l1</span>); <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">quick_permut</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">v1</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span> [<span class="id" type="var">x_is_fresh</span> | <span class="id" type="var">H</span>]; [<span class="id" type="tactic">subst</span> <span class="id" type="var">x</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">fresh_var_spec</span> <span class="id" type="var">_</span> <span class="id" type="var">O</span>) | <span class="id" type="tactic">apply</span> <span class="id" type="var">NE</span>; <span class="id" type="tactic">trivial</span>].<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">l1</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t1</span> <span class="id" type="var">l1</span>]; <span class="id" type="tactic">destruct</span> <span class="id" type="var">O</span> <span class="id" type="keyword">as</span> [ [[<span class="id" type="var">O</span> | <span class="id" type="var">O</span>] | <span class="id" type="var">O</span>] | [ <span class="id" type="var">O</span> | <span class="id" type="var">O</span> ]].<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">O</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">x</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">simpl</span>;<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v1</span> <span class="id" type="var">v1</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v1</span> <span class="id" type="var">v1</span>); [<span class="id" type="tactic">trivial</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v1_diff_v1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">v1_diff_v1</span>; <span class="id" type="tactic">reflexivity</span>].<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">v1</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">x</span>; <span class="id" type="tactic">simpl</span>; <br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v1</span> <span class="id" type="var">v1</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v1</span> <span class="id" type="var">v1</span>); [<span class="id" type="tactic">trivial</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v1_diff_v1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">v1_diff_v1</span>; <span class="id" type="tactic">reflexivity</span>].<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">simpl</span>; <br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">list_permut_occurs_in_term_list</span> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;(<span class="id" type="var">Var</span> (<span class="id" type="var">fresh_var</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">mk_pb</span> <span class="id" type="var">ex</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id" type="var">Term</span> <span class="id" type="var">f1</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v1</span> :: <span class="id" type="var">t1</span> :: <span class="id" type="var">l1</span>), <span class="id" type="var">Term</span> <span class="id" type="var">f1</span> <span class="id" type="var">l2</span>) :: <span class="id" type="var">usp</span>) <span class="id" type="var">sp</span> <span class="id" type="var">psp</span>)) :: <span class="id" type="var">t1</span> :: <span class="id" type="var">l1</span>);<br/>
[ <span class="id" type="tactic">apply</span> <span class="id" type="var">quick_permut</span> | <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span> ].<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">v1</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>

<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">ac_elementary_solve_term_term_term</span>;<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">pb'_in_lpb</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">pb'</span>;<br/>
<span class="id" type="tactic">refine</span> (<span class="id" type="var">prop_map_without_repetition</span> <span class="id" type="var">_</span> <span class="id" type="var">T.eq_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">pb'_in_lpb</span>); <br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">pb'</span> <span class="id" type="var">w_pb'</span> <span class="id" type="var">pb'_in_lpb</span> <span class="id" type="var">wpb_in_solve_pb</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">t2</span> <span class="id" type="var">t2_in_l2</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t2</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">g2</span> <span class="id" type="var">ll2</span> ]; [<span class="id" type="tactic">trivial</span> | <span class="id" type="var">idtac</span>].<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">g1</span> <span class="id" type="var">g2</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">g1</span> <span class="id" type="var">g2</span>);  [<span class="id" type="tactic">intro</span> <span class="id" type="var">g1_eq_g2</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">trivial</span>].<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">remove</span> <span class="id" type="var">T.eq_bool</span> (<span class="id" type="var">Term</span> <span class="id" type="var">g2</span> <span class="id" type="var">ll2</span>) <span class="id" type="var">l2</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">l2'</span> | ]; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">trivial</span>].<br/>
<span class="id" type="tactic">split</span>; [<span class="id" type="tactic">trivial</span> | <span class="id" type="var">idtac</span>].<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">O</span> <span class="id" type="keyword">as</span> [ [[<span class="id" type="var">O</span> | <span class="id" type="var">O</span>] | <span class="id" type="var">O</span>] | <span class="id" type="var">O</span>]; [<span class="id" type="var">idtac</span> | <span class="id" type="var">idtac</span> | <span class="id" type="var">idtac</span> | <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>].<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">l1</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">s1</span> [ | <span class="id" type="var">t1</span> <span class="id" type="var">l1</span>]]; [<span class="id" type="var">contradiction</span> | <span class="id" type="tactic">intuition</span> | <span class="id" type="var">idtac</span>].<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">list_permut_occurs_in_term_list</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">s1</span> :: <span class="id" type="var">t1</span> :: <span class="id" type="var">l1</span>); <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">quick_permut</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">right</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>

<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">l1</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">s1</span> [ | <span class="id" type="var">t1</span> [ | <span class="id" type="var">u1</span> <span class="id" type="var">l1</span>]]]; <br/>
&nbsp;&nbsp;[<span class="id" type="tactic">intros</span>; <span class="id" type="var">contradiction</span> | <span class="id" type="tactic">intros</span>; <span class="id" type="var">contradiction</span> | <span class="id" type="var">idtac</span> | <span class="id" type="tactic">intros</span>; <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">l2</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">s2</span> [ | <span class="id" type="var">t2</span> [ | <span class="id" type="var">u2</span> <span class="id" type="var">l2</span>]]]; <br/>
&nbsp;&nbsp;[<span class="id" type="tactic">intros</span>; <span class="id" type="var">contradiction</span> | <span class="id" type="tactic">intros</span>; <span class="id" type="var">contradiction</span> | <span class="id" type="var">idtac</span> | <span class="id" type="tactic">intros</span>; <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">intros</span> [<span class="id" type="var">pb'_in_pb1</span> | [<span class="id" type="var">pb'_in_pb2</span> | <span class="id" type="var">pb'_in_nil</span>]]; [<span class="id" type="tactic">subst</span> <span class="id" type="var">pb'</span> | <span class="id" type="tactic">subst</span> <span class="id" type="var">pb'</span> | <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">O</span> <span class="id" type="keyword">as</span> [ [[<span class="id" type="var">O</span> | [<span class="id" type="var">O</span> | <span class="id" type="var">O</span>]] | <span class="id" type="var">O</span>] | <span class="id" type="var">O</span> ]; [<span class="id" type="var">idtac</span> | <span class="id" type="var">idtac</span> | <span class="id" type="var">idtac</span> | <span class="id" type="var">idtac</span> | <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>].<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">right</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">O</span> <span class="id" type="keyword">as</span> [ [[<span class="id" type="var">O</span> | [<span class="id" type="var">O</span> | <span class="id" type="var">O</span>]] | <span class="id" type="var">O</span>] | <span class="id" type="var">O</span> ]; [<span class="id" type="var">idtac</span> | <span class="id" type="var">idtac</span> | <span class="id" type="var">idtac</span> | <span class="id" type="var">idtac</span> | <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>].<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">right</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>

<br/>
<span class="id" type="tactic">generalize</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">usp</span> <span class="id" type="var">O</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">usp</span> <span class="id" type="var">O</span> <span class="id" type="var">w_pb</span> <span class="id" type="var">wpb_in_solve_pb</span>; <br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">l1</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t1</span> <span class="id" type="var">l1</span>]; <span class="id" type="tactic">destruct</span> <span class="id" type="var">l2</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t2</span> <span class="id" type="var">l2</span>]; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">usp</span> <span class="id" type="var">O</span> [<span class="id" type="var">pb'_eq_pb1</span> | <span class="id" type="var">pb'_in_nil</span>]; [<span class="id" type="tactic">subst</span> <span class="id" type="var">pb'</span> | <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">split</span>; [<span class="id" type="tactic">trivial</span> | <span class="id" type="var">idtac</span>].<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">O</span> <span class="id" type="keyword">as</span> [ [<span class="id" type="var">O</span>  | <span class="id" type="var">O</span>] | <span class="id" type="var">O</span> ]; [<span class="id" type="var">idtac</span> | <span class="id" type="var">idtac</span> | <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>].<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">usp</span> <span class="id" type="var">O</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">O'</span> : <span class="id" type="var">occurs_in_pb</span> <span class="id" type="var">x</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">mk_pb</span> <span class="id" type="var">ex</span> ((<span class="id" type="var">Term</span> <span class="id" type="var">f1</span> <span class="id" type="var">l1</span>, <span class="id" type="var">Term</span> <span class="id" type="var">f1</span> <span class="id" type="var">l2</span>) :: (<span class="id" type="var">t1</span>,t2) :: <span class="id" type="var">usp</span>) <span class="id" type="var">sp</span> <span class="id" type="var">psp</span>)).<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">O</span> <span class="id" type="keyword">as</span> [ [[<span class="id" type="var">O</span> | <span class="id" type="var">O</span>] | <span class="id" type="var">O</span>] | <span class="id" type="var">O</span> ]; [<span class="id" type="var">idtac</span> | <span class="id" type="var">idtac</span> | <span class="id" type="var">idtac</span> | <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span> ].<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">right</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H</span>:= <span class="id" type="var">IHl1</span> <span class="id" type="var">l2</span> ((<span class="id" type="var">t1</span>,t2) :: <span class="id" type="var">usp</span>) <span class="id" type="var">O'</span>).<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">fold_left2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">fun</span> (<span class="id" type="var">current_list_of_eqs</span> : <span class="id" type="var">list</span> (<span class="id" type="var">term</span> * <span class="id" type="var">term</span>)) (<span class="id" type="var">t3</span> <span class="id" type="var">t4</span> : <span class="id" type="var">term</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">t3</span>, <span class="id" type="var">t4</span>) :: <span class="id" type="var">current_list_of_eqs</span>) ((<span class="id" type="var">t1</span>, <span class="id" type="var">t2</span>) :: <span class="id" type="var">usp</span>) <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>) <span class="id" type="keyword">as</span> [ | ]; <br/>
[<span class="id" type="var">idtac</span> | <span class="id" type="tactic">intros</span>; <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">pb'_in</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">H</span> <span class="id" type="var">pb'_in</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">matching_step1_is_sound</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span> <span class="id" type="var">sigma</span> <span class="id" type="var">pb</span>, <span class="id" type="var">is_wf_sol</span> <span class="id" type="var">pb</span> <span class="id" type="var">sigma</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">In</span> <span class="id" type="var">pb</span> (<span class="id" type="var">wf_solve_loop</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id" type="var">W</span> (<span class="id" type="var">init_pb</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>) (<span class="id" type="var">well_formed_init_pb</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span>)) :: <span class="id" type="var">nil</span>)) -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t1</span> = <span class="id" type="var">t2</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span> <span class="id" type="var">sigma</span> <span class="id" type="var">pb</span> <span class="id" type="var">Is_sol</span> <span class="id" type="var">In_pb</span>.<br/>
<span class="id" type="tactic">elim</span> (<span class="id" type="var">wf_solve_loop_is_sound</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">sigma</span> <span class="id" type="var">In_pb</span> <span class="id" type="var">Is_sol</span>).<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">pb</span> <span class="id" type="var">Is_sol</span> <span class="id" type="var">In_pb</span>; <br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">pb</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>;<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">In_pb</span> <span class="id" type="var">Is_sol</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">In_pb</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">In_pb</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">In_pb</span>.<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">pb</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">init_pb</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Is_sol</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Is_sol</span>;<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">is_sol</span>, <span class="id" type="var">is_rough_sol</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Is_sol</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">Is_sol</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">Is_sol</span>;<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">sigma'</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">Is_sol</span> <span class="id" type="var">eq_subst</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">Is_sol</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">Is_sol</span>;<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">Is_sol</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Is_sol</span>;<br/>
<span class="id" type="tactic">replace</span> (<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t1</span>) <span class="id" type="keyword">with</span> (<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma'</span> <span class="id" type="var">t1</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Is_sol</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="var">existential_vars</span> <span class="id" type="keyword">in</span> <span class="id" type="var">eq_subst</span>;<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Is_sol</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">sym_eq</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">elim</span> (<span class="id" type="var">eq_subst</span> <span class="id" type="var">v</span>); [ <span class="id" type="var">contradiction</span> | <span class="id" type="tactic">trivial</span> ].<br/>
<span class="id" type="tactic">intros</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">replace</span> (<span class="id" type="var">map</span> (<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma'</span>) <span class="id" type="var">l</span>) <span class="id" type="keyword">with</span><br/>
(<span class="id" type="var">map</span> (<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">l</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">H</span> <span class="id" type="var">a</span>).<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">matching_step2_is_sound</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span> <span class="id" type="var">wpb</span>, <br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">wpb</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">W</span> <span class="id" type="var">pb</span> <span class="id" type="var">_</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">In</span> <span class="id" type="var">wpb</span> (<span class="id" type="var">wf_solve_loop</span> ((<span class="id" type="var">W</span> (<span class="id" type="var">init_pb</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">well_formed_init_pb</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span>)) :: <span class="id" type="var">nil</span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">sigma</span> := <span class="id" type="var">extract_solution</span> (<span class="id" type="var">solved_part</span> <span class="id" type="var">pb</span>) (<span class="id" type="var">partly_solved_part</span> <span class="id" type="var">pb</span>) <span class="id" type="keyword">in</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t1</span> = <span class="id" type="var">t2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span> [<span class="id" type="var">pb</span> <span class="id" type="var">w_pb</span>]; <span class="id" type="tactic">intros</span> <span class="id" type="var">pb_in_loop</span>;<br/>
<span class="id" type="tactic">refine</span> (<span class="id" type="var">matching_step1_is_sound</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">pb_in_loop</span>).<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">is_sol</span>;<br/>
<span class="id" type="var">exists</span> (<span class="id" type="var">extract_solution</span> (<span class="id" type="var">solved_part</span> <span class="id" type="var">pb</span>) (<span class="id" type="var">partly_solved_part</span> <span class="id" type="var">pb</span>)); <span class="id" type="tactic">split</span>;<br/>
[<span class="id" type="var">idtac</span> | <span class="id" type="tactic">intro</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>].<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">usp_eq_nil</span> := <span class="id" type="var">wf_solve_loop_end</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">pb_in_loop</span>); <br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">pb</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">ex</span> <span class="id" type="var">usp</span> <span class="id" type="var">sp</span> <span class="id" type="var">psp</span>]; <span class="id" type="tactic">simpl</span> <span class="id" type="var">unsolved_part</span> <span class="id" type="keyword">in</span> <span class="id" type="var">usp_eq_nil</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">usp</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">is_rough_sol</span>; <span class="id" type="tactic">split</span>; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">split</span>].<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">elim</span> <span class="id" type="var">w_pb</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> [ <span class="id" type="var">_</span> [ <span class="id" type="var">_</span> [<span class="id" type="var">nb_occ_v</span> [<span class="id" type="var">well_sorted</span> <span class="id" type="var">new_var_occ</span>]]]].<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="var">partly_solved_part</span> <span class="id" type="keyword">in</span> *; <span class="id" type="tactic">simpl</span> <span class="id" type="var">solved_part</span> <span class="id" type="keyword">in</span> *.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">extract_solution_in_partly_solved_part</span> <span class="id" type="var">sp</span> <span class="id" type="var">psp</span> <span class="id" type="var">ex</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">nb_occ_v</span> <span class="id" type="var">well_sorted</span> <span class="id" type="var">new_var_occ</span> <span class="id" type="var">v</span>).<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">psp</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v_pval</span> | ]; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">trivial</span>].<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">elim</span> <span class="id" type="var">w_pb</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> [ <span class="id" type="var">_</span> [ <span class="id" type="var">_</span> [<span class="id" type="var">nb_occ_v</span> <span class="id" type="var">_</span>]]].<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="var">partly_solved_part</span> <span class="id" type="keyword">in</span> *; <span class="id" type="tactic">simpl</span> <span class="id" type="var">solved_part</span> <span class="id" type="keyword">in</span> *.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">extract_solution_in_solved_part</span> <span class="id" type="var">sp</span> <span class="id" type="var">psp</span> <span class="id" type="var">v</span>);<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sp</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v_val</span> | ]; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">trivial</span>].<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">H</span> <span class="id" type="var">v_val</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">matching_is_sound</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span> <span class="id" type="var">sigma</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">In</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">matching</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span>) -&gt; <span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t1</span> = <span class="id" type="var">t2</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span> <span class="id" type="var">sigma</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">matching</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">In_wpb</span>.<br/>
<span class="id" type="tactic">cut</span> (<span class="id" type="var">exists</span> <span class="id" type="var">wpb</span>, <span class="id" type="var">In</span> <span class="id" type="var">wpb</span> (<span class="id" type="var">wf_solve_loop</span> ((<span class="id" type="var">W</span> (<span class="id" type="var">init_pb</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">well_formed_init_pb</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span>)) :: <span class="id" type="var">nil</span>)) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">wpb</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">W</span> <span class="id" type="var">pb</span> <span class="id" type="var">_</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">sigma</span> = <span class="id" type="var">clean_sol</span> (<span class="id" type="var">existential_vars</span> <span class="id" type="var">pb</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">extract_solution</span> (<span class="id" type="var">solved_part</span> <span class="id" type="var">pb</span>) (<span class="id" type="var">partly_solved_part</span> <span class="id" type="var">pb</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>).<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">In_wpb</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">In_wpb</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">In_wpb</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">In_wpb</span>;<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">wpb</span> <span class="id" type="var">In_wpb</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">In_wpb</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">In_wpb</span>;<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">In_wpb</span> <span class="id" type="var">Is_sol</span>;<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">matching_step2_is_sound</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span> <span class="id" type="var">wpb</span>); <span class="id" type="tactic">destruct</span> <span class="id" type="var">wpb</span>;<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">H</span> <span class="id" type="var">In_wpb</span>); <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>;<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Is_sol</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H</span>;<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">Is_sol</span> <span class="id" type="var">H</span>; <br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">extract_solution</span> (<span class="id" type="var">solved_part</span> <span class="id" type="var">pb</span>) (<span class="id" type="var">partly_solved_part</span> <span class="id" type="var">pb</span>));<br/>
<span class="id" type="tactic">cut</span> (<span class="id" type="keyword">forall</span> <span class="id" type="var">v</span>, <span class="id" type="var">occurs_in_term</span> <span class="id" type="var">v</span> <span class="id" type="var">t1</span> -&gt; ~ <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">existential_vars</span> <span class="id" type="var">pb</span>)).<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">existential_vars</span> <span class="id" type="var">pb</span>); <span class="id" type="tactic">clear</span> <span class="id" type="var">sigma</span> <span class="id" type="var">pb</span> <span class="id" type="var">w</span> <span class="id" type="var">In_wpb</span>;<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">not_occurs</span> <span class="id" type="var">sigma</span>; <span class="id" type="tactic">generalize</span> <span class="id" type="var">v</span> <span class="id" type="var">not_occurs</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">v</span> <span class="id" type="var">not_occurs</span>;<br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">sigma</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">clean_sol</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">not_occurs</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">a</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v</span> <span class="id" type="var">a</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">a</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">v_eq_a</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v_diff_a</span>].<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">assert</span> (<span class="id" type="var">a_not_in_l</span> := <span class="id" type="var">not_occurs</span> <span class="id" type="var">a</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)).<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">mem_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">a</span> <span class="id" type="var">l</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">mem_bool</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">a</span> <span class="id" type="var">l</span>).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">a_mem_l</span>; <span class="id" type="var">absurd</span> (<span class="id" type="var">In</span> <span class="id" type="var">a</span> <span class="id" type="var">l</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">mem_impl_in</span> (@<span class="id" type="var">eq</span> <span class="id" type="var">variable</span>)); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">a</span> <span class="id" type="var">a</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">a</span> <span class="id" type="var">a</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">trivial</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">a_diff_a</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">a_diff_a</span>; <span class="id" type="tactic">reflexivity</span>].<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">mem_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">a</span> <span class="id" type="var">l</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">mem_bool</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">a</span> <span class="id" type="var">l</span>).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">a_mem_l</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">IHsigma</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHsigma</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">a_not_mem_l</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v</span> <span class="id" type="var">a</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">a</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">v_eq_a</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>].<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">v</span>=a); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">IHsigma</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHsigma</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l0</span> <span class="id" type="var">IH</span> <span class="id" type="var">not_occurs</span> <span class="id" type="var">sigma</span>;<br/>
<span class="id" type="tactic">cut</span> (<span class="id" type="var">map</span> (<span class="id" type="var">apply_cf_subst</span> (<span class="id" type="var">clean_sol</span> <span class="id" type="var">l</span> <span class="id" type="var">sigma</span>)) <span class="id" type="var">l0</span> = <span class="id" type="var">map</span> (<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">l0</span>).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">l0</span>.<br/>
<span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="var">map</span>; <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">IH</span> <span class="id" type="var">a</span>).<br/>
<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">IHl0</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IH</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">not_occurs</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">not_occurs</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">O</span>; <br/>
<span class="id" type="tactic">cut</span> (<span class="id" type="keyword">let</span> <span class="id" type="var">lpb</span>:= (<span class="id" type="var">W</span> (<span class="id" type="var">init_pb</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>) (<span class="id" type="var">well_formed_init_pb</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span>) :: <span class="id" type="var">nil</span>) <span class="id" type="keyword">in</span><br/>
<span class="id" type="keyword">forall</span> <span class="id" type="var">wpb</span>, <span class="id" type="var">In</span> <span class="id" type="var">wpb</span> <span class="id" type="var">lpb</span> -&gt;<br/>
<span class="id" type="keyword">match</span> <span class="id" type="var">wpb</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">W</span> <span class="id" type="var">pb'</span> <span class="id" type="var">_</span> =&gt; ~ <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">existential_vars</span> <span class="id" type="var">pb'</span>) /\ <span class="id" type="var">occurs_in_pb</span> <span class="id" type="var">v</span> <span class="id" type="var">pb'</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">elim</span> (<span class="id" type="var">variable_preservation</span> <span class="id" type="var">v</span> <span class="id" type="var">_</span> <span class="id" type="var">H</span> (<span class="id" type="var">W</span> <span class="id" type="var">pb</span> <span class="id" type="var">w</span>) <span class="id" type="var">In_wpb</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">lpb</span> <span class="id" type="var">wpb</span> <span class="id" type="var">In_wpb'</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">In_wpb'</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">In_wpb'</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">In_wpb'</span>.<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">wpb</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">init_pb</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">not</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">wf_solve_loop</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">W</span> (<span class="id" type="var">init_pb</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>) (<span class="id" type="var">well_formed_init_pb</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:: <span class="id" type="var">nil</span>)) <span class="id" type="var">In_wpb</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">In_wpb</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">l</span>;<br/>
[<span class="id" type="var">contradiction</span> <br/>
| <span class="id" type="tactic">simpl</span> <span class="id" type="var">map</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">In_wpb</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">In_wpb</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">In_wpb</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">In_wpb</span>;<br/>
[<span class="id" type="tactic">destruct</span> <span class="id" type="var">a</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">W</span> <span class="id" type="var">pb</span> <span class="id" type="var">w</span>); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>; [ <span class="id" type="var">left</span> | <span class="id" type="tactic">apply</span> <span class="id" type="var">sym_eq</span> ]; <span class="id" type="tactic">trivial</span><br/>
|elim (<span class="id" type="var">IHl</span> <span class="id" type="var">In_wpb</span>); <span class="id" type="tactic">clear</span> <span class="id" type="var">In_wpb</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">wpb</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>;<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">In_wpb</span> <span class="id" type="var">H</span>; <span class="id" type="var">exists</span> <span class="id" type="var">wpb</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>]].<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">matching_step1_is_complete</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span> <span class="id" type="var">sigma</span>, <span class="id" type="var">well_formed_cf_subst</span> <span class="id" type="var">sigma</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t1</span> = <span class="id" type="var">t2</span> -&gt;<br/>
&nbsp;&nbsp;(<span class="id" type="var">exists</span> <span class="id" type="var">pb</span>, <span class="id" type="var">is_wf_wf_sol</span> <span class="id" type="var">pb</span> <span class="id" type="var">sigma</span> /\ <span class="id" type="var">In</span> <span class="id" type="var">pb</span> (<span class="id" type="var">wf_solve_loop</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id" type="var">W</span> (<span class="id" type="var">init_pb</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>) (<span class="id" type="var">well_formed_init_pb</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span>)) :: <span class="id" type="var">nil</span>))).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span> <span class="id" type="var">sigma</span> <span class="id" type="var">Wsigma</span> <span class="id" type="var">Is_sol</span>.<br/>
<span class="id" type="tactic">set</span> (<span class="id" type="var">pb</span>:=(W (<span class="id" type="var">init_pb</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>) (<span class="id" type="var">well_formed_init_pb</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span>))).<br/>
<span class="id" type="tactic">elim</span> (<span class="id" type="var">wf_solve_loop_is_complete</span> (<span class="id" type="var">pb</span> :: <span class="id" type="var">nil</span>) <span class="id" type="var">pb</span>) <span class="id" type="keyword">with</span> <span class="id" type="var">sigma</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">pb0</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">In_pb0</span> <span class="id" type="var">Is_sol0</span>; <br/>
<span class="id" type="var">exists</span> <span class="id" type="var">pb0</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">is_wf_wf_sol</span>, <span class="id" type="var">is_well_formed_sol</span>, <span class="id" type="var">is_rough_sol</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="var">exists</span> <span class="id" type="var">sigma</span>; <span class="id" type="tactic">intuition</span>.<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">t0</span> <span class="id" type="var">t3</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">matching_step2_is_complete</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span> <span class="id" type="var">sigma</span>, <span class="id" type="var">well_formed_cf_subst</span> <span class="id" type="var">sigma</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t1</span> = <span class="id" type="var">t2</span> -&gt;<br/>
&nbsp;&nbsp;(<span class="id" type="var">exists</span> <span class="id" type="var">wpb</span>, <span class="id" type="var">In</span> <span class="id" type="var">wpb</span> (<span class="id" type="var">wf_solve_loop</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id" type="var">W</span> (<span class="id" type="var">init_pb</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>) (<span class="id" type="var">well_formed_init_pb</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span>)) :: <span class="id" type="var">nil</span>)) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">wpb</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">W</span> <span class="id" type="var">pb</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">v</span>, <span class="id" type="var">occurs_in_term</span> <span class="id" type="var">v</span> <span class="id" type="var">t1</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma</span>  (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>) = <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">apply_cf_subst</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">extract_solution</span> (<span class="id" type="var">solved_part</span> <span class="id" type="var">pb</span>) (<span class="id" type="var">partly_solved_part</span> <span class="id" type="var">pb</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">Var</span> <span class="id" type="var">v</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span> <span class="id" type="var">sigma</span> <span class="id" type="var">Wsigma</span> <span class="id" type="var">Is_sol</span>;<br/>
<span class="id" type="tactic">elim</span> (<span class="id" type="var">matching_step1_is_complete</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span> <span class="id" type="var">sigma</span> <span class="id" type="var">Wsigma</span> <span class="id" type="var">Is_sol</span>).<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">Is_sol</span>;<br/>
<span class="id" type="tactic">intros</span> [<span class="id" type="var">pb</span> <span class="id" type="var">w_pb</span>] [<span class="id" type="var">Is_sol</span> <span class="id" type="var">pb_in_loop</span>].<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">Is_sol</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">sigma'</span> [[<span class="id" type="var">Is_sol'_usp</span> [<span class="id" type="var">Is_sol'_psp</span> <span class="id" type="var">Is_sol'_sp</span>]] [<span class="id" type="var">sigma_eq_sigma'</span> <span class="id" type="var">Wsigma'</span>]]].<br/>
<span class="id" type="var">exists</span> (<span class="id" type="var">W</span> <span class="id" type="var">pb</span> <span class="id" type="var">w_pb</span>); <span class="id" type="tactic">split</span>; [<span class="id" type="tactic">trivial</span> | <span class="id" type="var">idtac</span>].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">O</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H</span> : <span class="id" type="keyword">let</span> <span class="id" type="var">lpb</span>:= (<span class="id" type="var">W</span> (<span class="id" type="var">init_pb</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>) (<span class="id" type="var">well_formed_init_pb</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span>) :: <span class="id" type="var">nil</span>) <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">wpb</span>, <span class="id" type="var">In</span> <span class="id" type="var">wpb</span> <span class="id" type="var">lpb</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">wpb</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">W</span> <span class="id" type="var">pb'</span> <span class="id" type="var">_</span> =&gt; ~ <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">existential_vars</span> <span class="id" type="var">pb'</span>) /\ <span class="id" type="var">occurs_in_pb</span> <span class="id" type="var">v</span> <span class="id" type="var">pb'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">lpb</span> <span class="id" type="var">wpb</span> <span class="id" type="var">In_wpb'</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">In_wpb'</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">In_wpb'</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">In_wpb'</span>.<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">wpb</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">not</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">init_pb</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">contradiction</span>.<br/>

<br/>
<span class="id" type="tactic">elim</span> (<span class="id" type="var">variable_preservation</span> <span class="id" type="var">v</span> <span class="id" type="var">_</span> <span class="id" type="var">H</span> (<span class="id" type="var">W</span> <span class="id" type="var">pb</span> <span class="id" type="var">w_pb</span>) <span class="id" type="var">pb_in_loop</span>); <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>;<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">E'</span> <span class="id" type="var">O'</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">usp_eq_nil</span> := <span class="id" type="var">wf_solve_loop_end</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">pb_in_loop</span>); <br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">pb</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">ex</span> <span class="id" type="var">usp</span> <span class="id" type="var">sp</span> <span class="id" type="var">psp</span>]; <span class="id" type="tactic">simpl</span> <span class="id" type="var">unsolved_part</span> <span class="id" type="keyword">in</span> *; <span class="id" type="tactic">subst</span> <span class="id" type="var">usp</span>.<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">Is_sol'_usp</span>; <br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">pb_in_loop</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">w_pb</span>;<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> <span class="id" type="var">w</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">w</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">w</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> <span class="id" type="var">w</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">w</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">w</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> <span class="id" type="var">w</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">w</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">w</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">nb_occ_v</span> <span class="id" type="var">w</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">w</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">w</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">well_sorted</span> <span class="id" type="var">new_var_occ</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="var">partly_solved_part</span> <span class="id" type="keyword">in</span> *; <span class="id" type="tactic">simpl</span> <span class="id" type="var">solved_part</span> <span class="id" type="keyword">in</span> *;<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="var">existential_vars</span> <span class="id" type="keyword">in</span> *.<br/>
<span class="id" type="tactic">elim</span> (<span class="id" type="var">sigma_eq_sigma'</span> <span class="id" type="var">v</span>); <span class="id" type="tactic">intro</span> <span class="id" type="var">E_v</span>.<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">In</span> <span class="id" type="var">v</span> <span class="id" type="var">ex</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">E_v</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">sigma</span> <span class="id" type="var">Wsigma</span> <span class="id" type="var">sigma_eq_sigma'</span> <span class="id" type="var">E_v</span> <span class="id" type="var">O</span>.<br/>
<span class="id" type="tactic">elim</span> <span class="id" type="var">O'</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">O'</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">O'</span>.<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">elim</span> <span class="id" type="var">O'</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">O'</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">O'</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">O'</span>.<br/>
<span class="id" type="tactic">generalize</span> <br/>
<span class="id" type="var">sp</span> <span class="id" type="var">Is_sol'_psp</span> <span class="id" type="var">Is_sol'_sp</span> <span class="id" type="var">nb_occ_v</span> <br/>
<span class="id" type="var">well_sorted</span> <span class="id" type="var">new_var_occ</span> <span class="id" type="var">O'</span> (<span class="id" type="var">extract_solution_in_partly_solved_part</span> <span class="id" type="var">sp</span> <br/>
<span class="id" type="var">psp</span> <span class="id" type="var">ex</span> <span class="id" type="var">nb_occ_v</span> <span class="id" type="var">well_sorted</span> <span class="id" type="var">new_var_occ</span>);<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">sp</span> <span class="id" type="var">w_pb</span> <span class="id" type="var">Is_sol'_psp</span> <span class="id" type="var">Is_sol'_sp</span> <span class="id" type="var">nb_occ_v</span> <br/>
<span class="id" type="var">well_sorted</span> <span class="id" type="var">new_var_occ</span> <span class="id" type="var">O'</span> <span class="id" type="var">E'</span>;<br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">psp</span>.<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">sp</span> <span class="id" type="var">Is_sol'_psp</span> <span class="id" type="var">Is_sol'_sp</span> <span class="id" type="var">nb_occ_v</span><br/>
<span class="id" type="var">well_sorted</span> <span class="id" type="var">new_var_occ</span>;<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">a</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">Is_sol'_psp</span> <span class="id" type="var">v</span>); <span class="id" type="tactic">simpl</span> <span class="id" type="var">find</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v</span> <span class="id" type="var">a</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">a</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">v_eq_a</span> <span class="id" type="var">H</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">a</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v_diff_a</span>].<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span>;<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">extract_solution_unfold</span>;<br/>
<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">extract_solution_in_solved_part</span><br/>
((<span class="id" type="var">v</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">Term</span> (<span class="id" type="var">head_symb</span> <span class="id" type="var">p</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">quicksort</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">flatten</span> (<span class="id" type="var">head_symb</span> <span class="id" type="var">p</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sp</span> (<span class="id" type="var">Var</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:: <span class="id" type="var">closed_term</span> <span class="id" type="var">p</span> :: <span class="id" type="var">nil</span>))))) :: <span class="id" type="var">sp</span>)<br/>
<span class="id" type="var">psp</span> <span class="id" type="var">v</span> <br/>
(<span class="id" type="var">Term</span> (<span class="id" type="var">head_symb</span> <span class="id" type="var">p</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">quicksort</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">flatten</span> (<span class="id" type="var">head_symb</span> <span class="id" type="var">p</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sp</span> (<span class="id" type="var">Var</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:: <span class="id" type="var">closed_term</span> <span class="id" type="var">p</span> :: <span class="id" type="var">nil</span>))))).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>; <br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">t</span> =&gt; <span class="id" type="var">Term</span> (<span class="id" type="var">head_symb</span> <span class="id" type="var">p</span>)<br/>
&nbsp;&nbsp;(<span class="id" type="var">quicksort</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">flatten</span> (<span class="id" type="var">head_symb</span> <span class="id" type="var">p</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">t</span> :: <span class="id" type="var">closed_term</span> <span class="id" type="var">p</span> :: <span class="id" type="var">nil</span>)))));<br/>
<span class="id" type="tactic">generalize</span> <br/>
(<span class="id" type="var">new_var_occ_in_solved_part</span> <br/>
&nbsp;&nbsp;(<span class="id" type="var">mk_pb</span> <span class="id" type="var">ex</span> <span class="id" type="var">nil</span> <span class="id" type="var">sp</span> ((<span class="id" type="var">v</span>,p) :: <span class="id" type="var">psp</span>))<br/>
&nbsp;(<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>) <span class="id" type="var">well_sorted</span> <span class="id" type="var">new_var_occ</span>)<br/>
(<span class="id" type="var">Is_sol'_sp</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p</span>)); <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p</span>) <span class="id" type="var">sp</span>); <span class="id" type="tactic">trivial</span>; <span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">nb_occ_v</span> <span class="id" type="var">v</span>); <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v</span> <span class="id" type="var">v</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">v</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v_diff_v</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">v_diff_v</span>; <span class="id" type="tactic">reflexivity</span>].<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">plus_comm</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">plus_comm</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="var">find</span>;<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v</span> <span class="id" type="var">v</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">v</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">trivial</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v_diff_v</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">v_diff_v</span>; <span class="id" type="tactic">reflexivity</span>].<br/>

<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">extract_solution_unfold</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHpsp</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">Is_sol'_psp</span> <span class="id" type="var">v0</span>) (<span class="id" type="var">nb_occ_v</span> <span class="id" type="var">v0</span>);<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="var">nb_occ</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="var">find</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v0</span> <span class="id" type="var">a</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v0</span> <span class="id" type="var">a</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">v0_eq_a</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">v0</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v0_diff_a</span>].<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">some_nb_occ_Sn</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">a</span> <span class="id" type="var">psp</span>);<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">a</span> <span class="id" type="var">psp</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">H1</span> <span class="id" type="var">p0</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)); <span class="id" type="tactic">clear</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H1</span>;<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">nb_occ</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">a</span> <span class="id" type="var">psp</span>).<br/>
<span class="id" type="var">absurd</span> (1 &lt;= 0); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">plus_comm</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H2</span>;<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">S</span>(<span class="id" type="var">S</span>(<span class="id" type="var">n</span> + <span class="id" type="var">nb_occ</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">a</span> <span class="id" type="var">sp</span>)) &lt;= 1); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">v1</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">Is_sol'_psp</span> <span class="id" type="var">v1</span>);<br/>
<span class="id" type="tactic">pattern</span> <br/>
(<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sp</span> (<span class="id" type="var">Var</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p</span>)) :: <span class="id" type="var">closed_term</span> <span class="id" type="var">p</span> :: <span class="id" type="var">nil</span>); <span class="id" type="tactic">simpl</span> <span class="id" type="var">find</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v1</span> <span class="id" type="var">a</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v1</span> <span class="id" type="var">a</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">v1_eq_a</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">v1</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v1_diff_a</span>].<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H1</span>; <br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">t</span> =&gt; <br/>
<span class="id" type="var">Term</span> (<span class="id" type="var">head_symb</span> <span class="id" type="var">p</span>)<br/>
&nbsp;&nbsp;(<span class="id" type="var">quicksort</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">flatten</span> (<span class="id" type="var">head_symb</span> <span class="id" type="var">p</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">t</span> :: <span class="id" type="var">closed_term</span> <span class="id" type="var">p</span> :: <span class="id" type="var">nil</span>))))).<br/>
<span class="id" type="tactic">generalize</span> <br/>
(<span class="id" type="var">new_var_occ_in_solved_part</span> <br/>
&nbsp;&nbsp;(<span class="id" type="var">mk_pb</span> <span class="id" type="var">ex</span> <span class="id" type="var">nil</span> <span class="id" type="var">sp</span> ((<span class="id" type="var">a</span>, <span class="id" type="var">p</span>) :: <span class="id" type="var">psp</span>))<br/>
&nbsp;&nbsp;(<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>) <span class="id" type="var">well_sorted</span> <span class="id" type="var">new_var_occ</span>); <span class="id" type="tactic">intro</span> <span class="id" type="var">H4</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H4</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">Is_sol'_sp</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p</span>)).<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p</span>) <span class="id" type="var">sp</span>); <span class="id" type="tactic">trivial</span>; <span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Is_sol'_sp</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">v1</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">nb_occ_v</span> <span class="id" type="var">v1</span>); <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v1</span> <span class="id" type="var">a</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v1</span> <span class="id" type="var">a</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">v1_eq_a</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">v1</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v1_diff_a</span>; <span class="id" type="tactic">trivial</span>].<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">plus_comm</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">plus_comm</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">elim</span> <span class="id" type="var">well_sorted</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v1</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">nb_occ_v</span> <span class="id" type="var">v1</span>) (<span class="id" type="var">new_var_occ</span> <span class="id" type="var">v1</span>); <span class="id" type="tactic">simpl</span> <span class="id" type="var">find</span>;<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">generalize</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H'</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v1</span> <span class="id" type="var">a</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v1</span> <span class="id" type="var">a</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">v1_eq_a</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">v1</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v1_diff_a</span>].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">some_nb_occ_Sn</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">a</span> <span class="id" type="var">psp</span>).<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">a</span> <span class="id" type="var">psp</span>).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">H1</span> <span class="id" type="var">p0</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)); <span class="id" type="tactic">clear</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H1</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">nb_occ</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">a</span> <span class="id" type="var">psp</span>).<br/>
<span class="id" type="var">absurd</span> (1 &lt;= 0); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">plus_comm</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H'</span>;<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">S</span>(<span class="id" type="var">S</span>(<span class="id" type="var">n</span> + <span class="id" type="var">nb_occ</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">a</span> <span class="id" type="var">sp</span>)) &lt;= 1); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">H'</span> <span class="id" type="var">H1</span> <span class="id" type="var">p0</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">elim</span> (<span class="id" type="var">H1</span> <span class="id" type="var">p0</span> <span class="id" type="var">H2</span>); <span class="id" type="tactic">clear</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H1</span>.<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="var">revert</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p0</span>) <span class="id" type="var">a</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p0</span>) <span class="id" type="var">a</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">new_var_p0_eq_a</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">new_var_p0_diff_a</span>].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>; <span class="id" type="var">right</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p0</span>) <span class="id" type="var">a</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p0</span>) <span class="id" type="var">a</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">trivial</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">new_var_p0_diff_a</span>].<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p0</span> = <span class="id" type="var">a</span>); <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p0</span>) <span class="id" type="var">psp</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">p1</span> <span class="id" type="var">F</span> <span class="id" type="var">_</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">F</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">F</span>; <span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p0</span>) <span class="id" type="var">sp</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">F'</span> <span class="id" type="var">_</span>; <span class="id" type="var">right</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p0</span>) <span class="id" type="var">a</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p0</span>) <span class="id" type="var">a</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">new_var_p0_eq_a</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>].<br/>
<span class="id" type="tactic">exact</span> <span class="id" type="var">I</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">F'</span>; <span class="id" type="tactic">exact</span> <span class="id" type="var">I</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">F'</span> [<span class="id" type="var">Abs</span> | <span class="id" type="var">Abs</span>]; <span class="id" type="var">contradiction</span>.<br/>

<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v1</span> <span class="id" type="var">p1</span> <span class="id" type="var">F1</span>.<br/>
<span class="id" type="tactic">refine</span> (<span class="id" type="var">extract_solution_in_partly_solved_part</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">ex</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">F1</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v2</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">nb_occ_v</span> <span class="id" type="var">v2</span>); <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v2</span> <span class="id" type="var">a</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v2</span> <span class="id" type="var">a</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">v2_eq_a</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">v2</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v2_diff_a</span>; <span class="id" type="tactic">trivial</span>].<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">plus_comm</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">plus_comm</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">elim</span> <span class="id" type="var">well_sorted</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v2</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">nb_occ_v</span> <span class="id" type="var">v2</span>) (<span class="id" type="var">new_var_occ</span> <span class="id" type="var">v2</span>); <span class="id" type="tactic">simpl</span> <span class="id" type="var">find</span>;<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">generalize</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H'</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v2</span> <span class="id" type="var">a</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v2</span> <span class="id" type="var">a</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">v2_eq_a</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">v2</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v2_diff_a</span>].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">some_nb_occ_Sn</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">a</span> <span class="id" type="var">psp</span>).<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">a</span> <span class="id" type="var">psp</span>).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">H1</span> <span class="id" type="var">p0</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)); <span class="id" type="tactic">clear</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H1</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">nb_occ</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">a</span> <span class="id" type="var">psp</span>).<br/>
<span class="id" type="var">absurd</span> (1 &lt;= 0); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">plus_comm</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H'</span>;<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">S</span>(<span class="id" type="var">S</span>(<span class="id" type="var">n</span> + <span class="id" type="var">nb_occ</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">a</span> <span class="id" type="var">sp</span>)) &lt;= 1); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">H'</span> <span class="id" type="var">H1</span> <span class="id" type="var">p0</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">elim</span> (<span class="id" type="var">H1</span> <span class="id" type="var">p0</span> <span class="id" type="var">H2</span>); <span class="id" type="tactic">clear</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H1</span>.<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">elim</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="var">find</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p0</span>) <span class="id" type="var">a</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p0</span>) <span class="id" type="var">a</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">new_var_p0_eq_a</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">new_var_p0_diff_a</span>].<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p0</span>) <span class="id" type="var">a</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p0</span>) <span class="id" type="var">a</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">trivial</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">new_var_p0_diff_a</span>].<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p0</span> = <span class="id" type="var">a</span>); <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> (<span class="id" type="var">new_var</span> <span class="id" type="var">p0</span>) <span class="id" type="var">a</span>); <span class="id" type="tactic">trivial</span>.<br/>

<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">Is_sol'_sp</span> <span class="id" type="var">v</span>) <br/>
(<span class="id" type="var">extract_solution_in_solved_part</span> <span class="id" type="var">sp</span> <span class="id" type="var">psp</span> <span class="id" type="var">v</span>); <br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sp</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">H0</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">H</span> <span class="id" type="var">t</span> (<span class="id" type="var">nb_occ_v</span> <span class="id" type="var">v</span>) (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)); <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">contradiction</span>.<br/>

<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">matching_is_complete</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span> <span class="id" type="var">sigma</span>, <span class="id" type="var">well_formed_cf_subst</span> <span class="id" type="var">sigma</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t1</span> = <span class="id" type="var">t2</span> -&gt;<br/>
&nbsp;&nbsp;(<span class="id" type="var">exists</span> <span class="id" type="var">sigma'</span>, <span class="id" type="var">In</span> <span class="id" type="var">sigma'</span> (<span class="id" type="var">matching</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">v</span>, <span class="id" type="var">occurs_in_term</span> <span class="id" type="var">v</span> <span class="id" type="var">t1</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma</span>  (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>) = <span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma'</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>))).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span> <span class="id" type="var">sigma</span> <span class="id" type="var">W_sigma</span> <span class="id" type="var">Is_sol</span>;<br/>
<span class="id" type="tactic">elim</span> (<span class="id" type="var">matching_step2_is_complete</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span> <span class="id" type="var">sigma</span> <span class="id" type="var">W_sigma</span> <span class="id" type="var">Is_sol</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">wpb</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">In_wpb</span> <span class="id" type="var">Is_sol'</span>;<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">wpb</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">matching</span>.<br/>
<span class="id" type="var">exists</span> (<span class="id" type="var">clean_sol</span> (<span class="id" type="var">existential_vars</span> <span class="id" type="var">pb</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">extract_solution</span> (<span class="id" type="var">solved_part</span> <span class="id" type="var">pb</span>) (<span class="id" type="var">partly_solved_part</span> <span class="id" type="var">pb</span>))); <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">generalize</span> <span class="id" type="var">In_wpb</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">In_wpb</span>;<br/>
<span class="id" type="tactic">induction</span> (<span class="id" type="var">wf_solve_loop</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">W</span> (<span class="id" type="var">init_pb</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>) (<span class="id" type="var">well_formed_init_pb</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span>) :: <span class="id" type="var">nil</span>)).<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">In_wpb</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">In_wpb</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">In_wpb</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">In_wpb</span>.<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">a</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">O</span>;<br/>
<span class="id" type="tactic">cut</span> (<span class="id" type="keyword">let</span> <span class="id" type="var">lpb</span>:= (<span class="id" type="var">W</span> (<span class="id" type="var">init_pb</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>) (<span class="id" type="var">well_formed_init_pb</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span>) :: <span class="id" type="var">nil</span>) <span class="id" type="keyword">in</span><br/>
<span class="id" type="keyword">forall</span> <span class="id" type="var">wpb</span>, <span class="id" type="var">In</span> <span class="id" type="var">wpb</span> <span class="id" type="var">lpb</span> -&gt;<br/>
<span class="id" type="keyword">match</span> <span class="id" type="var">wpb</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">W</span> <span class="id" type="var">pb'</span> <span class="id" type="var">_</span> =&gt; ~ <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">existential_vars</span> <span class="id" type="var">pb'</span>) /\ <span class="id" type="var">occurs_in_pb</span> <span class="id" type="var">v</span> <span class="id" type="var">pb'</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">elim</span> (<span class="id" type="var">variable_preservation</span> <span class="id" type="var">v</span> <span class="id" type="var">_</span> <span class="id" type="var">H</span> (<span class="id" type="var">W</span> <span class="id" type="var">pb</span> <span class="id" type="var">w</span>) <span class="id" type="var">In_wpb</span>); <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>;<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">E'</span> <span class="id" type="var">O'</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Is_sol'</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">extract_solution</span> (<span class="id" type="var">solved_part</span> <span class="id" type="var">pb</span>) (<span class="id" type="var">partly_solved_part</span> <span class="id" type="var">pb</span>)).<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span> <span class="id" type="var">sigma</span> <span class="id" type="var">W_sigma</span> <span class="id" type="var">Is_sol</span> <span class="id" type="var">w</span> <span class="id" type="var">In_wpb</span> <span class="id" type="var">Is_sol'</span> <span class="id" type="var">O</span> <span class="id" type="var">O'</span>;<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">sigma</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">sigma</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">a</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">mem_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">a</span> (<span class="id" type="var">existential_vars</span> <span class="id" type="var">pb</span>)); <span class="id" type="tactic">case</span> (<span class="id" type="var">mem_bool</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">a</span> (<span class="id" type="var">existential_vars</span> <span class="id" type="var">pb</span>)).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">a_mem_ex</span>;<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v</span> <span class="id" type="var">a</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">a</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">v_eq_a</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">a</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v_diff_a</span>].<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">existential_vars</span> <span class="id" type="var">pb</span>)); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">mem_impl_in</span> <span class="id" type="keyword">with</span> (@<span class="id" type="var">eq</span> <span class="id" type="var">_</span>).<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">IHsigma</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHsigma</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">a_not_mem_ex</span>; <span class="id" type="tactic">simpl</span>;<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v</span> <span class="id" type="var">a</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">a</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">v_eq_a</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">a</span>; <span class="id" type="tactic">trivial</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v_diff_a</span>].<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">IHsigma</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHsigma</span>; <span class="id" type="tactic">trivial</span>.<br/>

<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">lpb</span> <span class="id" type="var">wpb</span> <span class="id" type="var">In_wpb'</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">In_wpb'</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">In_wpb'</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">In_wpb'</span>.<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">wpb</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">not</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">init_pb</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">End</span> <span class="id" type="var">Make</span>.<br/>

<br/>

<br/>

<br/>

<br/>
</div>
</div>

<div id="footer">
<hr/><a href="index.html">Index</a><hr/>This page has been generated by <a href="http://www.lix.polytechnique.fr/coq/">coqdoc</a>
</div>

</div>

</body>
</html>