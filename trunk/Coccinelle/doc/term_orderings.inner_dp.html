<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"/>
<link href="coqdoc.css" rel="stylesheet" type="text/css"/>
<title>term_orderings.inner_dp</title>
</head>

<body>

<div id="page">

<div id="header">
</div>

<div id="main">

<h1 class="libtitle">Library term_orderings.inner_dp</h1>

<div class="code">
<span class="id" type="keyword">Add</span> <span class="id" type="var">LoadPath</span> "basis".<br/>
<span class="id" type="keyword">Add</span> <span class="id" type="var">LoadPath</span> "list_extensions".<br/>
<span class="id" type="keyword">Add</span> <span class="id" type="var">LoadPath</span> "term_algebra".<br/>

<br/>
</div>

<div class="doc">
<a name="lab79"></a><h1 class="section">Equational theory on a term algebra</h1>

</div>
<div class="code">

<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">List</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Relations</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Wellfounded</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Arith</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">closure</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">more_list</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">weaved_relation</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">term</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">equational_theory_spec</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">rwr_strategies</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">dp</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">rpo</span>.<br/>

<br/>
<span class="id" type="keyword">Module</span> <span class="id" type="var">Make</span> (<span class="id" type="var">E</span> : <span class="id" type="var">EqTh</span>).<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Import</span> <span class="id" type="var">E</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Import</span> <span class="id" type="var">T</span>.<br/>

<br/>
<span class="id" type="keyword">Module</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">R</span> := <span class="id" type="var">rwr_strategies.Make</span> (<span class="id" type="var">E</span>).<br/>
<span class="id" type="keyword">Module</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">DP</span> := <span class="id" type="var">dp.MakeDP</span> (<span class="id" type="var">E</span>).<br/>

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">idp</span> (<span class="id" type="var">R</span> : <span class="id" type="var">relation</span> <span class="id" type="var">term</span>) : <span class="id" type="var">term</span> -&gt; <span class="id" type="var">term</span> -&gt; <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;| <span class="id" type="var">Idp</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">axiom</span> (<span class="id" type="var">dp</span> <span class="id" type="var">R</span>) <span class="id" type="var">t2</span> <span class="id" type="var">t1</span> -&gt; (<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span>, <span class="id" type="var">direct_subterm</span> <span class="id" type="var">s</span> <span class="id" type="var">t1</span> -&gt; <span class="id" type="var">nf</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">s</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">idp</span> <span class="id" type="var">R</span> <span class="id" type="var">t2</span> <span class="id" type="var">t1</span>.<br/>

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">idp_step</span> (<span class="id" type="var">R</span> : <span class="id" type="var">relation</span> <span class="id" type="var">term</span>) : <span class="id" type="var">term</span> -&gt; <span class="id" type="var">term</span> -&gt; <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;&nbsp;| <span class="id" type="var">IDp_step</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">t3</span>, <span class="id" type="var">refl_trans_clos</span> (<span class="id" type="var">one_step_list</span> (<span class="id" type="var">P_step</span> <span class="id" type="var">R</span> (<span class="id" type="var">inner</span> <span class="id" type="var">R</span>))) <span class="id" type="var">l2</span> <span class="id" type="var">l1</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">idp</span> <span class="id" type="var">R</span> <span class="id" type="var">t3</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l2</span>) -&gt; <span class="id" type="var">idp_step</span> <span class="id" type="var">R</span> <span class="id" type="var">t3</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span>).<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">idp_criterion_aux</span> : <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">t</span>, ~ (<span class="id" type="var">R</span> <span class="id" type="var">t</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>))) -&gt; <br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">x</span>, <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">t</span>)) -&gt;<br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span>, {<span class="id" type="var">constructor</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span>} + {<span class="id" type="var">defined</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span>}) -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>,   <span class="id" type="var">Acc</span> (<span class="id" type="var">idp_step</span> <span class="id" type="var">R</span>)  <span class="id" type="var">t</span> -&gt; (<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span>, <span class="id" type="var">direct_subterm</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">P_step</span> <span class="id" type="var">R</span> (<span class="id" type="var">inner</span> <span class="id" type="var">R</span>)) <span class="id" type="var">s</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Acc</span> (<span class="id" type="var">P_step</span> <span class="id" type="var">R</span> (<span class="id" type="var">inner</span> <span class="id" type="var">R</span>)) <span class="id" type="var">t</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">HR</span> <span class="id" type="var">RR</span> <span class="id" type="var">CD</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Acc_var</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">x</span>, <span class="id" type="var">Acc</span> (<span class="id" type="var">P_step</span> <span class="id" type="var">R</span> (<span class="id" type="var">inner</span> <span class="id" type="var">R</span>)) (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>)).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">x</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v2</span> | ].<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">R</span> <span class="id" type="var">t1</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v2</span>)); <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">HR</span>.<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">Acc_t</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">Acc_t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t</span> <span class="id" type="var">Acc_t</span> <span class="id" type="var">IH</span>].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">Acc_l</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x</span> | <span class="id" type="var">f</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_var</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Acc_l</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">acc_one_step_list</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Acc_l</span>; <span class="id" type="var">revert</span> <span class="id" type="var">IH</span>.<br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">Acc_l</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">l</span> <span class="id" type="var">Acc_l</span> <span class="id" type="var">IHl</span>]; <span class="id" type="tactic">intros</span> <span class="id" type="var">IH'</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Acc_l'</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">P_step</span> <span class="id" type="var">R</span> (<span class="id" type="var">inner</span> <span class="id" type="var">R</span>)) <span class="id" type="var">t</span>).<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">acc_one_step_list</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>; <span class="id" type="tactic">exact</span> <span class="id" type="var">Acc_l</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>; <br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">s</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x1</span> | <span class="id" type="var">f1</span> <span class="id" type="var">l1</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_var</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t</span> <span class="id" type="var">s</span> <span class="id" type="var">Hnf</span> <span class="id" type="var">H'</span> | <span class="id" type="var">f'</span> <span class="id" type="var">lt</span> <span class="id" type="var">ls</span> <span class="id" type="var">H'</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t1_R_t2</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H'</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x</span> | <span class="id" type="var">g</span> <span class="id" type="var">k</span>].<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">R</span> <span class="id" type="var">t1</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>)); <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">HR</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">g</span> <span class="id" type="var">l</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H''</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">n</span> <span class="id" type="var">t</span>, <span class="id" type="var">size</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>) &lt;= <span class="id" type="var">n</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">exists</span> <span class="id" type="var">p</span>, <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">t1</span> <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> <span class="id" type="var">t</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Acc</span> (<span class="id" type="var">P_step</span> <span class="id" type="var">R</span> (<span class="id" type="var">inner</span> <span class="id" type="var">R</span>)) (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>)).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">n</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">n</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">n</span>].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">St</span>; <span class="id" type="var">absurd</span> (1 &lt;= 0); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>; <br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">le_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">size</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>)); <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">size_ge_one</span>.<br/>
<span class="id" type="tactic">intros</span> [<span class="id" type="var">x</span> | <span class="id" type="var">g</span> <span class="id" type="var">h</span>] <span class="id" type="var">St</span> [<span class="id" type="var">p</span> <span class="id" type="var">H''</span>].<br/>

<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">var_P_acc</span> <span class="id" type="keyword">with</span> <span class="id" type="var">k</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H</span> : <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">k</span>))).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">RR</span> <span class="id" type="keyword">with</span> <span class="id" type="var">t1</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">var_in_subterm</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>) <span class="id" type="var">p</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_list_unfold</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Acc_h</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">h</span> -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">P_step</span> <span class="id" type="var">R</span> (<span class="id" type="var">inner</span> <span class="id" type="var">R</span>)) (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>)).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">t_in_h</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">In_split</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">t_in_h</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">h'</span> [<span class="id" type="var">h''</span> <span class="id" type="var">K</span>]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">h</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHn</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">le_S_n</span>; <span class="id" type="tactic">refine</span> (<span class="id" type="var">le_trans</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">St</span>); <span class="id" type="tactic">apply</span> <span class="id" type="var">size_direct_subterm</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">map_app</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">exists</span> (<span class="id" type="var">p</span> ++ (<span class="id" type="var">length</span> <span class="id" type="var">h'</span> :: <span class="id" type="var">nil</span>)).<br/>
<span class="id" type="tactic">generalize</span> <span class="id" type="var">t1</span> <span class="id" type="var">H''</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t1</span> <span class="id" type="var">H''</span> <span class="id" type="var">H1</span> <span class="id" type="var">t1_R_t2</span> <span class="id" type="var">IHn</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">p</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">p</span>].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">H''</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H''</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">H''</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">nth_error_at_pos</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">H''</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H''</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">t1</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">g1</span> <span class="id" type="var">k1</span>].<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">nth_error</span> <span class="id" type="var">k1</span> <span class="id" type="var">i</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">ti</span> | ].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHp</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">CD</span> <span class="id" type="var">g</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">Cg</span> | <span class="id" type="var">Dg</span>].<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">P_acc_subterms</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">t_in_map_h</span>; <span class="id" type="tactic">setoid_rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">t_in_map_h</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t_in_map_h</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t'</span> [<span class="id" type="var">H'''</span> <span class="id" type="var">t'_in_h</span>]]; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_h</span>; <span class="id" type="tactic">trivial</span>.<br/>

<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">subterm_at_pos_dec_alt</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">k</span>) (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">h</span>)) <span class="id" type="keyword">as</span> [[<span class="id" type="var">q</span> <span class="id" type="var">Sub</span>] | <span class="id" type="var">not_Sub</span>].<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">q</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">q</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IH'</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IDp_step</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">map</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">k</span>).<br/>
<span class="id" type="var">left</span>.<br/>
<span class="id" type="tactic">replace</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">map</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">k</span>)) <span class="id" type="keyword">with</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">k</span>)); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Idp</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Dp</span> <span class="id" type="keyword">with</span> <span class="id" type="var">t1</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">t_in_map_h</span>; <span class="id" type="tactic">setoid_rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">t_in_map_h</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t_in_map_h</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t'</span> [<span class="id" type="var">H'''</span> <span class="id" type="var">t'_in_h</span>]]; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_h</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Sub</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">nth_error_ok_in</span> <span class="id" type="var">i</span> <span class="id" type="var">k</span>); <span class="id" type="tactic">destruct</span> (<span class="id" type="var">nth_error</span> <span class="id" type="var">k</span> <span class="id" type="var">i</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">ti</span> | ].<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">H</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">k1</span> [<span class="id" type="var">k2</span> [<span class="id" type="var">L</span> <span class="id" type="var">H'</span>]]].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">P_acc_subterms_3</span> <span class="id" type="keyword">with</span> <span class="id" type="var">q</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">ti</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_l'</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> <span class="id" type="var">ti</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">subst</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">subterm_at_pos_apply_subst_apply_subst_subterm_at_pos</span> <span class="id" type="var">ti</span> <span class="id" type="var">q</span> <span class="id" type="var">sigma</span>).<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IH'</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IDp_step</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">map</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">k</span>).<br/>
<span class="id" type="var">left</span>.<br/>
<span class="id" type="tactic">replace</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">map</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">k</span>)) <span class="id" type="keyword">with</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">k</span>)); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Idp</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Dp</span> <span class="id" type="keyword">with</span> <span class="id" type="var">t1</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">s_in_h</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">s_in_h</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">s_in_h</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">s_in_h</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">u</span> [<span class="id" type="var">H2</span> <span class="id" type="var">u_in_h</span>]]; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_h</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">H''</span> (<span class="id" type="var">size</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f1</span> <span class="id" type="var">l1</span>))).<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">le_n</span>.<br/>
<span class="id" type="var">exists</span> (@<span class="id" type="var">nil</span> <span class="id" type="var">nat</span>); <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_t</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IDp_step</span> <span class="id" type="keyword">with</span> <span class="id" type="var">l2</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_trans_clos_is_trans</span> <span class="id" type="keyword">with</span> <span class="id" type="var">l1</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>

<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">H''</span> <span class="id" type="var">H'''</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IH'</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H''</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">IDp_step</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">l2</span> <span class="id" type="var">s</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_trans_clos_is_trans</span> <span class="id" type="keyword">with</span> <span class="id" type="var">l1</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">idp_criterion</span> : <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">t</span>, ~ (<span class="id" type="var">R</span> <span class="id" type="var">t</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>))) -&gt; <br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">x</span>, <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">t</span>)) -&gt;<br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span>, {<span class="id" type="var">constructor</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span>} + {<span class="id" type="var">defined</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span>}) -&gt;<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">well_founded</span> (<span class="id" type="var">idp_step</span> <span class="id" type="var">R</span>)  -&gt; <span class="id" type="var">well_founded</span> (<span class="id" type="var">P_step</span> <span class="id" type="var">R</span> (<span class="id" type="var">inner</span> <span class="id" type="var">R</span>)).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">HR</span> <span class="id" type="var">RR</span> <span class="id" type="var">CD</span> <span class="id" type="var">Wf</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">x</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v2</span> | ].<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">R</span> <span class="id" type="var">t1</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v2</span>)); <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">HR</span>.<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">idp_criterion_aux</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Section</span> <span class="id" type="var">Psi_definition</span>.<br/>

<br/>
<span class="id" type="keyword">Variable</span> <span class="id" type="var">R</span> : <span class="id" type="var">relation</span> <span class="id" type="var">term</span>.<br/>
<span class="id" type="keyword">Variable</span> <span class="id" type="var">Rvar</span> : (<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span> <span class="id" type="var">x</span>, ~ (<span class="id" type="var">R</span> <span class="id" type="var">t</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>))).<br/>
<span class="id" type="keyword">Variable</span> <span class="id" type="var">Rreg</span> : (<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">x</span>, <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">t</span>)).<br/>
<span class="id" type="keyword">Variable</span> <span class="id" type="var">rule_list</span> : <span class="id" type="var">list</span> (<span class="id" type="var">term</span> * <span class="id" type="var">term</span>).<br/>
<span class="id" type="keyword">Variable</span> <span class="id" type="var">Req</span> : (<span class="id" type="keyword">forall</span> <span class="id" type="var">l</span> <span class="id" type="var">r</span>, <span class="id" type="var">R</span> <span class="id" type="var">r</span> <span class="id" type="var">l</span> &lt;-&gt; <span class="id" type="var">In</span> (<span class="id" type="var">l</span>, <span class="id" type="var">r</span>) <span class="id" type="var">rule_list</span>).<br/>
<span class="id" type="keyword">Variable</span> <span class="id" type="var">wf_inner</span> : <span class="id" type="var">well_founded</span> (<span class="id" type="var">P_step</span> <span class="id" type="var">R</span> (<span class="id" type="var">inner</span> <span class="id" type="var">R</span>)).<br/>
<span class="id" type="keyword">Variable</span> <span class="id" type="var">UIR</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span> <span class="id" type="var">s'</span>, <span class="id" type="var">inner</span> <span class="id" type="var">R</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">axiom</span> <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">axiom</span> <span class="id" type="var">R</span> <span class="id" type="var">s'</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">s</span> = <span class="id" type="var">s'</span>.<br/>
<span class="id" type="keyword">Variable</span> <span class="id" type="var">AICR</span> : <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">l</span> <span class="id" type="var">r</span> <span class="id" type="var">sigma</span>, <span class="id" type="var">R</span> <span class="id" type="var">r</span> <span class="id" type="var">l</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">p</span> <span class="id" type="var">g</span> <span class="id" type="var">d</span> <span class="id" type="var">tau</span>, <span class="id" type="var">R</span> <span class="id" type="var">d</span> <span class="id" type="var">g</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">subterm_at_pos</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">l</span>) <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">tau</span> <span class="id" type="var">g</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">inner</span> <span class="id" type="var">R</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">tau</span> <span class="id" type="var">g</span>) -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">p</span> = <span class="id" type="var">nil</span> \/ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> <span class="id" type="var">q</span>, <span class="id" type="var">exists</span> <span class="id" type="var">q'</span>, <span class="id" type="var">exists</span> <span class="id" type="var">v</span>, <span class="id" type="var">p</span> = <span class="id" type="var">q</span> ++ <span class="id" type="var">q'</span> /\ <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">l</span> <span class="id" type="var">q</span> = <span class="id" type="var">Some</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>))) \/<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">exists</span> <span class="id" type="var">s'</span>, <span class="id" type="var">P_step</span> <span class="id" type="var">R</span> (<span class="id" type="var">inner</span> <span class="id" type="var">R</span>) <span class="id" type="var">s'</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">l</span>) /\ <span class="id" type="var">rwr</span> <span class="id" type="var">R</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">r</span>) <span class="id" type="var">s'</span>).<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">Rvar'</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">t</span>, ~ (<span class="id" type="var">In</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>,t) <span class="id" type="var">rule_list</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">x</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">Rvar</span> <span class="id" type="var">x</span> <span class="id" type="var">t</span>); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Req</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">Rreg'</span> : (<span class="id" type="keyword">forall</span> <span class="id" type="var">l</span> <span class="id" type="var">r</span>, <span class="id" type="var">In</span> (<span class="id" type="var">l</span>,r) <span class="id" type="var">rule_list</span> -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">x</span>, <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">r</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">l</span>)).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">l</span> <span class="id" type="var">r</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Rreg</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Req</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">nf_var</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">v</span>, <span class="id" type="var">nf</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">s</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v2</span> | <span class="id" type="var">f2</span> <span class="id" type="var">l2</span>].<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">R</span> <span class="id" type="var">t1</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v2</span>)); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">Psi</span> : <span class="id" type="var">relation</span> <span class="id" type="var">term</span> :=<br/>
&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Psi_at_top</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">axiom</span> <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; (<span class="id" type="var">inner</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span> -&gt; <span class="id" type="var">Psi</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span><br/>
&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Psi_in_context</span> : <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">llst</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> (<span class="id" type="var">s</span>,t) <span class="id" type="var">llst</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">Psi</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>) \/ (<span class="id" type="var">s</span> = <span class="id" type="var">t</span> /\ <span class="id" type="var">nf</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">exists</span> <span class="id" type="var">s</span>, <span class="id" type="var">exists</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> (<span class="id" type="var">s</span>,t) <span class="id" type="var">llst</span> /\ ~nf (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Psi</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">term</span> <span class="id" type="var">term</span>) <span class="id" type="var">llst</span>)) (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">snd</span> <span class="id" type="var">term</span> <span class="id" type="var">term</span>) <span class="id" type="var">llst</span>)).<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">Psi_not_nf</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span>, <span class="id" type="var">Psi</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">nf</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span> -&gt; <span class="id" type="var">False</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">s</span> <span class="id" type="var">P</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">P</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">ss</span> <span class="id" type="var">tt</span> <span class="id" type="var">H</span> <span class="id" type="var">K</span> | <span class="id" type="var">g</span> <span class="id" type="var">ll</span> <span class="id" type="var">H</span> <span class="id" type="var">K</span>]; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">nf</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">H'</span> <span class="id" type="var">s</span>); <span class="id" type="tactic">apply</span> <span class="id" type="var">at_top</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">IHl</span> <span class="id" type="var">s</span> <span class="id" type="var">P</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">P</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">ss</span> <span class="id" type="var">tt</span> <span class="id" type="var">H</span> <span class="id" type="var">K</span> | <span class="id" type="var">g</span> <span class="id" type="var">ll</span> <span class="id" type="var">H</span> <span class="id" type="var">K</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">P</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">nf</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">H'</span> <span class="id" type="var">s</span>); <span class="id" type="tactic">apply</span> <span class="id" type="var">at_top</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">K</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">s</span> [<span class="id" type="var">t</span> [<span class="id" type="var">st_in_ll</span> <span class="id" type="var">P</span>]]].<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">P</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">nf_one_step_subterm</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H</span>).<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">s</span>,t); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">Psi_unique</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span> <span class="id" type="var">s'</span>, <span class="id" type="var">Psi</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">Psi</span> <span class="id" type="var">s'</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">s</span> = <span class="id" type="var">s'</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">s</span> <span class="id" type="var">s'</span> <span class="id" type="var">P</span> <span class="id" type="var">P'</span>.<br/>
<span class="id" type="tactic">assert</span> <span class="id" type="var">False</span>; [<span class="id" type="var">idtac</span> | <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">Psi_not_nf</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>) <span class="id" type="var">s</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">nf_var</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">IHl</span> <span class="id" type="var">s</span> <span class="id" type="var">s'</span> <span class="id" type="var">P</span> <span class="id" type="var">P'</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">P</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">ss</span> <span class="id" type="var">tt</span> <span class="id" type="var">H</span> <span class="id" type="var">K</span> | <span class="id" type="var">g</span> <span class="id" type="var">ll</span> <span class="id" type="var">H</span> <span class="id" type="var">K</span>]; <span class="id" type="tactic">inversion</span> <span class="id" type="var">P'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">ss'</span> <span class="id" type="var">tt'</span> <span class="id" type="var">H'</span> <span class="id" type="var">K'</span> | <span class="id" type="var">g'</span> <span class="id" type="var">ll'</span> <span class="id" type="var">H'</span> <span class="id" type="var">K'</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">P</span> <span class="id" type="var">P'</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">UIR</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)); <span class="id" type="tactic">trivial</span>.<br/>

<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">inner</span> <span class="id" type="keyword">in</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">K</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">K'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">s'</span> [<span class="id" type="var">t'</span> [<span class="id" type="var">st_in_ll'</span> <span class="id" type="var">P</span>]]].<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">nf</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t'</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">s'</span>,t'); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>

<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">inner</span> <span class="id" type="keyword">in</span> <span class="id" type="var">K'</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">K'</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">K</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">s</span> [<span class="id" type="var">t</span> [<span class="id" type="var">st_in_ll'</span> <span class="id" type="var">P</span>]]].<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">nf</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">K'</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">s</span>,t); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>

<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)).<br/>
<span class="id" type="tactic">generalize</span> <span class="id" type="var">H1</span> <span class="id" type="var">ll'</span> <span class="id" type="var">H'</span> <span class="id" type="var">IHl</span> <span class="id" type="var">H6</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">K</span> <span class="id" type="var">K'</span> <span class="id" type="var">H1</span> <span class="id" type="var">ll'</span> <span class="id" type="var">H'</span> <span class="id" type="var">IHl</span> <span class="id" type="var">H6</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">ll</span> <span class="id" type="keyword">as</span> [ | [<span class="id" type="var">s</span> <span class="id" type="var">t</span>] <span class="id" type="var">ll</span>].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> [ | [<span class="id" type="var">s'</span> <span class="id" type="var">t'</span>] <span class="id" type="var">ll'</span>]; <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">H1</span> [ | [<span class="id" type="var">s'</span> <span class="id" type="var">t'</span>] <span class="id" type="var">ll'</span>]; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">H'</span> <span class="id" type="var">IHl</span> <span class="id" type="var">H6</span>.<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">H6</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H6</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">H6</span> <span class="id" type="var">H7</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">t'</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">H1</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>))) <span class="id" type="keyword">as</span> [<span class="id" type="var">P</span> | [<span class="id" type="var">E</span> <span class="id" type="var">I</span>]];<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">H'</span> <span class="id" type="var">s'</span> <span class="id" type="var">t</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>))) <span class="id" type="keyword">as</span> [<span class="id" type="var">P'</span> | [<span class="id" type="var">E'</span> <span class="id" type="var">I'</span>]].<br/>
<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">IHl</span> <span class="id" type="var">t</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) <span class="id" type="var">s</span> <span class="id" type="var">s'</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">s'</span> :: <span class="id" type="var">l</span>)).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHll</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H1</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H'</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">u_in_ll</span> <span class="id" type="var">v</span> <span class="id" type="var">v'</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">s'</span>; <span class="id" type="tactic">assert</span> <span class="id" type="var">False</span>; [<span class="id" type="var">idtac</span> | <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">Psi_not_nf</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">P</span> <span class="id" type="var">I'</span>).<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">assert</span> <span class="id" type="var">False</span>; [<span class="id" type="var">idtac</span> | <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">Psi_not_nf</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">P'</span> <span class="id" type="var">I</span>).<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">s</span> <span class="id" type="var">s'</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">t</span> :: <span class="id" type="var">l</span>)).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHll</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H1</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H'</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">u_in_ll</span> <span class="id" type="var">v</span> <span class="id" type="var">v'</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">Psi_def</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, ~nf (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span> -&gt; {<span class="id" type="var">t'</span> : <span class="id" type="var">term</span> | <span class="id" type="var">Psi</span> <span class="id" type="var">t'</span> <span class="id" type="var">t</span>}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">red_dec</span> :=compute_red_is_correct <span class="id" type="var">rule_list</span> <span class="id" type="var">Rreg'</span> <span class="id" type="var">R</span> <span class="id" type="var">Req</span>).<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">nf_dec</span> := <span class="id" type="var">dec_nf</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">red_dec</span>).<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">inner_dec</span> := <span class="id" type="var">nf_dec_inner_dec</span> <span class="id" type="var">_</span> <span class="id" type="var">nf_dec</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">assert</span> (<span class="id" type="var">Acc_t</span> := <span class="id" type="var">wf_inner</span> <span class="id" type="var">t</span>); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">P_acc_with_subterm</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Acc_t</span>.<br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">Acc_t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t</span> <span class="id" type="var">Acc_t</span> <span class="id" type="var">IH</span>].<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">t_not_nf</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v</span> | <span class="id" type="var">f</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">nf</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>)); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">nf_var</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">red_dec_fl</span> := <span class="id" type="var">red_dec</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)).<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">compute_red</span> <span class="id" type="var">rule_list</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)) <span class="id" type="keyword">as</span> [ | <span class="id" type="var">r</span> <span class="id" type="var">rl</span>].<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">nf</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">red_dec_fl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">inner_dec</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">inner_fl</span> | <span class="id" type="var">not_inner_fl</span>].<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H'</span> : <span class="id" type="var">one_step</span> <span class="id" type="var">R</span> <span class="id" type="var">r</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)).<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">red_dec_fl</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">exists</span> <span class="id" type="var">r</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">H'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H''</span> | <span class="id" type="var">g</span> <span class="id" type="var">k1</span> <span class="id" type="var">k2</span> <span class="id" type="var">H''</span>]; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Psi_at_top</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">assert</span> <span class="id" type="var">False</span>; [<span class="id" type="var">idtac</span> | <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">inner</span> <span class="id" type="keyword">in</span> <span class="id" type="var">inner_fl</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">inner_fl</span>.<br/>
<span class="id" type="tactic">generalize</span> <span class="id" type="var">inner_fl</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">f</span> <span class="id" type="var">Acc_t</span> <span class="id" type="var">IH</span> <span class="id" type="var">t_not_nf</span> <span class="id" type="var">red_dec_fl</span> <span class="id" type="var">H'</span> <span class="id" type="var">inner_fl</span>.<br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">H''</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">nf_l</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">nf_l</span> <span class="id" type="var">t2</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) <span class="id" type="var">t1</span> <span class="id" type="var">H</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHH''</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">nf_l</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> -&gt; ~ <span class="id" type="var">nf</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span> -&gt; { <span class="id" type="var">t'</span> : <span class="id" type="var">term</span> | <span class="id" type="var">Psi</span> <span class="id" type="var">t'</span> <span class="id" type="var">t</span>} ).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">t_in_l</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IH</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H'</span> : {<span class="id" type="var">ll</span> : <span class="id" type="var">list</span> (<span class="id" type="var">term</span> * <span class="id" type="var">term</span>) | <span class="id" type="var">map</span> (@<span class="id" type="var">snd</span> <span class="id" type="var">term</span> <span class="id" type="var">term</span>) <span class="id" type="var">ll</span> = <span class="id" type="var">l</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> (<span class="id" type="var">s</span>,t) <span class="id" type="var">ll</span> -&gt; <span class="id" type="var">Psi</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> \/ (<span class="id" type="var">s</span>=t /\ <span class="id" type="var">nf</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span>))}).<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">f</span> <span class="id" type="var">Acc_t</span> <span class="id" type="var">IH</span> <span class="id" type="var">t_not_nf</span> <span class="id" type="var">red_dec_fl</span> <span class="id" type="var">not_inner_fl</span> <span class="id" type="var">r</span> <span class="id" type="var">rl</span>.<br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="var">exists</span> (@<span class="id" type="var">nil</span> (<span class="id" type="var">term</span> * <span class="id" type="var">term</span>)); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">IHl</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">ll</span> [<span class="id" type="var">H1</span> <span class="id" type="var">H2</span>]].<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">nf_dec</span> <span class="id" type="var">t</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">nf_t</span> | <span class="id" type="var">not_nf_t</span>].<br/>
<span class="id" type="var">exists</span> ((<span class="id" type="var">t</span>,t) :: <span class="id" type="var">ll</span>); <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span> [<span class="id" type="var">uv_eq_tt</span> | <span class="id" type="var">uv_in_ll</span>].<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">uv_eq_tt</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">H</span> <span class="id" type="var">t</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>))) <span class="id" type="keyword">as</span> [<span class="id" type="var">t'</span> <span class="id" type="var">P</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">exists</span> ((<span class="id" type="var">t'</span>,t) :: <span class="id" type="var">ll</span>); <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span> [<span class="id" type="var">uv_eq_tt'</span> | <span class="id" type="var">uv_in_ll</span>].<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">uv_eq_tt'</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">H'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">ll</span> [<span class="id" type="var">H1</span> <span class="id" type="var">H2</span>]].<br/>
<span class="id" type="var">exists</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">term</span> <span class="id" type="var">term</span>) <span class="id" type="var">ll</span>)).<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Psi_in_context</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H3</span> : <span class="id" type="var">exists</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> /\ ~nf (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span>).<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">inner</span> <span class="id" type="keyword">in</span> <span class="id" type="var">not_inner_fl</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">not_inner_fl</span>.<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">Acc_t</span> <span class="id" type="var">IH</span> <span class="id" type="var">t_not_nf</span> <span class="id" type="var">red_dec_fl</span> <span class="id" type="var">H</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">r</span> <span class="id" type="var">rl</span> <span class="id" type="var">f</span>.<br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">s</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="tactic">assert</span> <span class="id" type="var">False</span>; [<span class="id" type="var">idtac</span> | <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">not_inner_fl</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">nf_dec</span> <span class="id" type="var">s</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">nf_s</span> | <span class="id" type="var">not_nf_s</span>].<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">IHl</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t</span> [<span class="id" type="var">t_in_l</span> <span class="id" type="var">H</span>]].<br/>
<span class="id" type="tactic">intro</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">not_inner_fl</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> [<span class="id" type="var">u_eq_s</span> | <span class="id" type="var">u_in_l</span>].<br/>
<span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">exists</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">exists</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">H3</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t</span> [<span class="id" type="var">t_in_l</span> <span class="id" type="var">H4</span>]].<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">H</span> <span class="id" type="var">t</span> <span class="id" type="var">t_in_l</span> <span class="id" type="var">H4</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">t'</span> <span class="id" type="var">H5</span>].<br/>
<span class="id" type="var">exists</span> <span class="id" type="var">t'</span>; <span class="id" type="var">exists</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H1</span> <span class="id" type="keyword">in</span> <span class="id" type="var">t_in_l</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">t_in_l</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t_in_l</span> <span class="id" type="keyword">as</span> [[<span class="id" type="var">u'</span> <span class="id" type="var">u</span>] [<span class="id" type="var">H6</span> <span class="id" type="var">H7</span>]].<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H6</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">u</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">H2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H7</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">H8</span> | [<span class="id" type="var">H8</span>  <span class="id" type="var">H9</span>]].<br/>
<span class="id" type="tactic">replace</span> <span class="id" type="var">t'</span> <span class="id" type="keyword">with</span> <span class="id" type="var">u'</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">refine</span> (<span class="id" type="var">Psi_unique</span>  <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H8</span> <span class="id" type="var">H5</span>).<br/>
<span class="id" type="tactic">assert</span> <span class="id" type="var">False</span>; [<span class="id" type="var">idtac</span> | <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Psi_not_nf</span> <span class="id" type="keyword">with</span> <span class="id" type="var">t</span> <span class="id" type="var">t'</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Defined</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">psi</span> (<span class="id" type="var">t</span> : <span class="id" type="var">term</span>) : <span class="id" type="var">term</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">red_dec</span> :=compute_red_is_correct <span class="id" type="var">rule_list</span> <span class="id" type="var">Rreg'</span> <span class="id" type="var">R</span> <span class="id" type="var">Req</span>).<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">nf_dec</span> := <span class="id" type="var">dec_nf</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">red_dec</span>).<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">nf_dec</span> <span class="id" type="var">t</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">nf_t</span> | <span class="id" type="var">not_nf_dec</span>].<br/>
<span class="id" type="tactic">exact</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">Psi_def</span> <span class="id" type="var">t</span> <span class="id" type="var">not_nf_dec</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">t'</span> <span class="id" type="var">H</span>].<br/>
<span class="id" type="tactic">exact</span> <span class="id" type="var">t'</span>.<br/>
<span class="id" type="keyword">Defined</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">psi_char</span> : <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, (<span class="id" type="var">psi</span> <span class="id" type="var">t</span> = <span class="id" type="var">t</span> /\ <span class="id" type="var">nf</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span>) \/ (<span class="id" type="var">Psi</span> (<span class="id" type="var">psi</span> <span class="id" type="var">t</span>) <span class="id" type="var">t</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">psi</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">dec_nf</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) (<span class="id" type="var">compute_red</span> <span class="id" type="var">rule_list</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">compute_red_is_correct</span> <span class="id" type="var">rule_list</span> <span class="id" type="var">Rreg'</span> <span class="id" type="var">R</span> <span class="id" type="var">Req</span>) <span class="id" type="var">t</span>).<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">Psi_def</span> <span class="id" type="var">t</span> <span class="id" type="var">n</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">t'</span> <span class="id" type="var">P</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">psi_nf</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">nf</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span> -&gt; <span class="id" type="var">psi</span> <span class="id" type="var">t</span> = <span class="id" type="var">t</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">nf_t</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">psi_char</span> <span class="id" type="var">t</span>) <span class="id" type="keyword">as</span> [[<span class="id" type="var">H1</span> <span class="id" type="var">H2</span>] | <span class="id" type="var">P</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">assert</span> <span class="id" type="var">False</span>; [<span class="id" type="var">idtac</span> | <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">Psi_not_nf</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">P</span> <span class="id" type="var">nf_t</span>).<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">psi_not_nf</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, ~nf (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span> -&gt; <span class="id" type="var">Psi</span> (<span class="id" type="var">psi</span> <span class="id" type="var">t</span>) <span class="id" type="var">t</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">nf_t</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">psi_char</span> <span class="id" type="var">t</span>) <span class="id" type="keyword">as</span> [[<span class="id" type="var">H1</span> <span class="id" type="var">H2</span>] | <span class="id" type="var">P</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">nf</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">Psi_psi</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">Psi</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">psi</span> <span class="id" type="var">t</span> = <span class="id" type="var">s</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">P</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Psi_unique</span> <span class="id" type="keyword">with</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">psi_not_nf</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">Psi_not_nf</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">Psi_in_context_bis</span> :<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">k</span>, (<span class="id" type="var">exists</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> /\ ~nf (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span>) -&gt; <span class="id" type="var">k</span> = <span class="id" type="var">map</span> <span class="id" type="var">psi</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="var">Psi</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">k</span>) (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">k</span> <span class="id" type="var">K</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">k</span>.<br/>
<span class="id" type="tactic">replace</span> (<span class="id" type="var">map</span> <span class="id" type="var">psi</span> <span class="id" type="var">l</span>) <span class="id" type="keyword">with</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">term</span> <span class="id" type="var">term</span>) (<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">t</span> =&gt; (<span class="id" type="var">psi</span> <span class="id" type="var">t</span>,t)) <span class="id" type="var">l</span>)).<br/>
<span class="id" type="tactic">replace</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) <span class="id" type="keyword">with</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">snd</span> <span class="id" type="var">term</span> <span class="id" type="var">term</span>) (<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">t</span> =&gt; (<span class="id" type="var">psi</span> <span class="id" type="var">t</span>,t)) <span class="id" type="var">l</span>))).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Psi_in_context</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">st_in_ll</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">st_in_ll</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">st_in_ll</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t'</span> [<span class="id" type="var">H</span> <span class="id" type="var">t_in_l</span>]]; <span class="id" type="tactic">injection</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">s</span> <span class="id" type="var">t'</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">psi_char</span> <span class="id" type="var">t</span>) <span class="id" type="keyword">as</span> [[<span class="id" type="var">H1</span> <span class="id" type="var">H2</span>] | <span class="id" type="var">P</span>].<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">K</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t</span> [<span class="id" type="var">t_in_l</span> <span class="id" type="var">not_nf_t</span>]].<br/>
<span class="id" type="var">exists</span> (<span class="id" type="var">psi</span> <span class="id" type="var">t</span>); <span class="id" type="var">exists</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)).<br/>
<span class="id" type="tactic">pattern</span> <span class="id" type="var">l</span> <span class="id" type="tactic">at</span> 2; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">map_id</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">map_map</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">map_eq</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">map_map</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">map_eq</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">psi_not_inner</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>, ~(inner <span class="id" type="var">R</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)) -&gt; <span class="id" type="var">psi</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) = <span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">map</span> <span class="id" type="var">psi</span> <span class="id" type="var">l</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">not_nf_fl</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">red_dec</span> :=compute_red_is_correct <span class="id" type="var">rule_list</span> <span class="id" type="var">Rreg'</span> <span class="id" type="var">R</span> <span class="id" type="var">Req</span>).<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">nf_dec</span> := <span class="id" type="var">dec_nf</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">red_dec</span>).<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">psi_char</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)) <span class="id" type="keyword">as</span> [[<span class="id" type="var">H1</span> <span class="id" type="var">H2</span>] | <span class="id" type="var">P</span>].<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">inner</span> <span class="id" type="var">R</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">s_in_l</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">s_in_l</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">nf_one_step_subterm</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Psi_unique</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Psi_in_context_bis</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">P</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">inner</span> <span class="id" type="var">R</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">H3</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">s</span> [<span class="id" type="var">t</span> [<span class="id" type="var">st_in_llst</span> <span class="id" type="var">not_nf_t</span>]]].<br/>
<span class="id" type="var">exists</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">s</span>,t); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">psi_inner_axiom</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">inner</span> <span class="id" type="var">R</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">axiom</span> <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">psi</span> <span class="id" type="var">t</span> = <span class="id" type="var">s</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">H</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">psi_char</span> <span class="id" type="var">t</span>) <span class="id" type="keyword">as</span> [[<span class="id" type="var">H1</span> <span class="id" type="var">H2</span>] | <span class="id" type="var">P</span>].<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H''</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">H2</span> <span class="id" type="var">s</span> <span class="id" type="var">H''</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">at_top</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Psi_unique</span> <span class="id" type="keyword">with</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Psi_at_top</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">Psi_rwr</span> :  <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span>, <span class="id" type="var">Psi</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">trans_clos</span> (<span class="id" type="var">P_step</span> <span class="id" type="var">R</span> (<span class="id" type="var">inner</span> <span class="id" type="var">R</span>)) <span class="id" type="var">s</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">red_dec</span> :=compute_red_is_correct <span class="id" type="var">rule_list</span> <span class="id" type="var">Rreg'</span> <span class="id" type="var">R</span> <span class="id" type="var">Req</span>).<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">nf_dec</span> := <span class="id" type="var">dec_nf</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">red_dec</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">s</span> <span class="id" type="var">P</span>; <span class="id" type="tactic">assert</span> <span class="id" type="var">False</span>; [<span class="id" type="var">idtac</span> | <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">Psi_not_nf</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>) <span class="id" type="var">s</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">nf_var</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">IH</span> <span class="id" type="var">s</span> <span class="id" type="var">P</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">psi_char</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)) <span class="id" type="keyword">as</span> [[<span class="id" type="var">H1</span> <span class="id" type="var">H2</span>] | <span class="id" type="var">P'</span>].<br/>
<span class="id" type="tactic">assert</span> <span class="id" type="var">False</span>; [<span class="id" type="var">idtac</span> | <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">Psi_not_nf</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) <span class="id" type="var">s</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">Psi_unique</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">P</span> <span class="id" type="var">P'</span>).<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">P'</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">P'</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">t_step</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">P_at_top</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">psi_not_inner</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">P_general_context</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">H3</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">s'</span> [<span class="id" type="var">t</span> [<span class="id" type="var">st_in_ll</span> <span class="id" type="var">not_nf_t</span>]]].<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">psi_not_inner</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">rwr_list_expand</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">In_split</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">st_in_ll</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">ll1</span> [<span class="id" type="var">ll2</span> <span class="id" type="var">H'</span>]]; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="var">exists</span> <span class="id" type="var">t</span>; <span class="id" type="var">exists</span> <span class="id" type="var">s'</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="var">exists</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">snd</span> <span class="id" type="var">term</span> <span class="id" type="var">term</span>) <span class="id" type="var">ll1</span>).<br/>
<span class="id" type="var">exists</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">snd</span> <span class="id" type="var">term</span> <span class="id" type="var">term</span>) <span class="id" type="var">ll2</span>).<br/>
<span class="id" type="var">exists</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">term</span> <span class="id" type="var">term</span>) <span class="id" type="var">ll1</span>).<br/>
<span class="id" type="var">exists</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">term</span> <span class="id" type="var">term</span>) <span class="id" type="var">ll2</span>).<br/>
<span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">map_app</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">map_app</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H'</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">kk</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span>, <span class="id" type="var">In</span> (<span class="id" type="var">u</span>,v) <span class="id" type="var">kk</span> -&gt; <span class="id" type="var">refl_trans_clos</span> (<span class="id" type="var">P_step</span> <span class="id" type="var">R</span> (<span class="id" type="var">inner</span> <span class="id" type="var">R</span>)) <span class="id" type="var">u</span> <span class="id" type="var">v</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">refl_trans_clos</span> (<span class="id" type="var">one_step_list</span> (<span class="id" type="var">P_step</span> <span class="id" type="var">R</span> (<span class="id" type="var">inner</span> <span class="id" type="var">R</span>))) (<span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">kk</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">map</span> (@<span class="id" type="var">snd</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">kk</span>)).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">kk</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">kk</span> <span class="id" type="keyword">as</span> [ | [<span class="id" type="var">u1</span> <span class="id" type="var">v1</span>] <span class="id" type="var">kk</span>]; <span class="id" type="tactic">intros</span> <span class="id" type="var">H'</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">refl_trans_clos_one_step_list_head_tail</span>; <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">H'</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHkk</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H'</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span> <span class="id" type="var">uv_in_ll1</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">H2</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">H2'</span> | [<span class="id" type="var">H2'</span> <span class="id" type="var">_</span>]].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IH</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">u</span>,v); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">subst</span>; <span class="id" type="var">left</span>.<br/>
<span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IH</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">s'</span>,t); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">H2</span> <span class="id" type="var">s'</span> <span class="id" type="var">t</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">H2'</span> | [<span class="id" type="var">_</span> <span class="id" type="var">H2'</span>]]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">nf</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span> <span class="id" type="var">uv_in_ll2</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">H2</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">H2'</span> | [<span class="id" type="var">H2'</span> <span class="id" type="var">_</span>]].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="tactic">do</span> 2 <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IH</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">u</span>,v); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="tactic">do</span> 2 <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">subst</span>; <span class="id" type="var">left</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">inner</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">not_nf_t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">simpl</span>; <br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">s'</span>,t); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">H3</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">s'</span> [<span class="id" type="var">t</span> [<span class="id" type="var">st_in_ll</span> <span class="id" type="var">not_nf_t</span>]]].<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">inner</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">not_nf_t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">simpl</span>; <br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">s'</span>,t); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">Psi_not_refl</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">Psi</span> <span class="id" type="var">t</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">False</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">P</span>; <span class="id" type="tactic">assert</span> <span class="id" type="var">False</span>; [<span class="id" type="var">idtac</span> | <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">Psi_not_nf</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>) (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>)); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">nf_var</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">IHl</span> <span class="id" type="var">P</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">P</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">u</span> <span class="id" type="var">v</span> <span class="id" type="var">H</span> <span class="id" type="var">Acc_u</span> <span class="id" type="var">H3</span> | <span class="id" type="var">f'</span> <span class="id" type="var">ll</span> <span class="id" type="var">H</span> <span class="id" type="var">K</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">P</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">apply</span> (@<span class="id" type="var">cycle_not_acc</span> <span class="id" type="var">_</span> (<span class="id" type="var">P_step</span> <span class="id" type="var">R</span> (<span class="id" type="var">inner</span> <span class="id" type="var">R</span>)) (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">P_at_top</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">wf_inner</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">K</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">s</span> [<span class="id" type="var">t</span> [<span class="id" type="var">st_in_ll</span> <span class="id" type="var">not_nf_t</span>]]].<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">s_eq_t</span> : <span class="id" type="var">s</span> = <span class="id" type="var">t</span>).<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">H0</span> <span class="id" type="var">not_nf_t</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">ll</span> <span class="id" type="keyword">as</span> [ | [<span class="id" type="var">u</span> <span class="id" type="var">v</span>] <span class="id" type="var">ll</span>].<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">st_in_ll</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">st_in_ll</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">st_eq_uv</span> | <span class="id" type="var">st_in_ll</span>].<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">st_eq_uv</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">st_eq_uv</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHll</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">H0</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">st_in_ll</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">P</span> | [<span class="id" type="var">_</span> <span class="id" type="var">nf_t</span>]].<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">IHl</span> <span class="id" type="var">t</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">t</span>,t); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">not_nf_t</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">psi_two_cases</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, (<span class="id" type="var">nf</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span> /\ <span class="id" type="var">psi</span> <span class="id" type="var">t</span> = <span class="id" type="var">t</span>) \/ (~nf (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span> /\ <span class="id" type="var">psi</span> <span class="id" type="var">t</span> &lt;&gt; <span class="id" type="var">t</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">nf_var</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">psi_nf</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">nf_var</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">IH</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">red_dec</span> :=compute_red_is_correct <span class="id" type="var">rule_list</span> <span class="id" type="var">Rreg'</span> <span class="id" type="var">R</span> <span class="id" type="var">Req</span>).<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">nf_dec</span> := <span class="id" type="var">dec_nf</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">red_dec</span>).<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">nf_dec</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">nf_fl</span> | <span class="id" type="var">not_nf_fl</span>].<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">psi_nf</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">psi_char</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)) <span class="id" type="keyword">as</span> [[<span class="id" type="var">H1</span> <span class="id" type="var">H2</span>] | <span class="id" type="var">P</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">not_nf_fl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">Psi_not_refl</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span> <span class="id" type="keyword">in</span> <span class="id" type="var">P</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">map_psi</span> :<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>, <span class="id" type="var">psi</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) = <span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">map</span> <span class="id" type="var">psi</span> <span class="id" type="var">l</span>) \/ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">P_step</span> <span class="id" type="var">R</span> (<span class="id" type="var">inner</span> <span class="id" type="var">R</span>) (<span class="id" type="var">psi</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)) (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">map</span> <span class="id" type="var">psi</span> <span class="id" type="var">l</span>)) /\ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">inner</span> <span class="id" type="var">R</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">map</span> <span class="id" type="var">psi</span> <span class="id" type="var">l</span>))).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">psi_char</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)) <span class="id" type="keyword">as</span> [[<span class="id" type="var">H1</span> <span class="id" type="var">H2</span>] | <span class="id" type="var">P</span>].<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">psi_nf</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)).<br/>
<span class="id" type="tactic">pattern</span> <span class="id" type="var">l</span> <span class="id" type="tactic">at</span> 1; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">map_id</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">map_eq</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">s_in_l</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">psi_nf</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">nf_one_step_subterm</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">P</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">H</span> <span class="id" type="var">K</span> | <span class="id" type="var">f'</span> <span class="id" type="var">ll</span> <span class="id" type="var">H</span> <span class="id" type="var">K</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">P</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">replace</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">map</span> <span class="id" type="var">psi</span> <span class="id" type="var">l</span>)) <span class="id" type="keyword">with</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>).<br/>
<span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">P_at_top</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)).<br/>
<span class="id" type="tactic">pattern</span> <span class="id" type="var">l</span> <span class="id" type="tactic">at</span> 1; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">map_id</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">map_eq</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">s_in_l</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">psi_nf</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)).<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">map_map</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">map_eq</span>.<br/>
<span class="id" type="tactic">intros</span> [<span class="id" type="var">s</span> <span class="id" type="var">t</span>] <span class="id" type="var">st_in_ll</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">H1</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">st_in_ll</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">H2</span> | [<span class="id" type="var">H2</span> <span class="id" type="var">nf_t</span>]].<br/>
<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">Psi_psi</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H2</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">psi_nf</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">psi_subst</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">sigma</span> <span class="id" type="var">tau</span>, <span class="id" type="var">tau</span> = <span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">xval</span> =&gt; (@<span class="id" type="var">fst</span> <span class="id" type="var">variable</span> <span class="id" type="var">term</span> <span class="id" type="var">xval</span>, <span class="id" type="var">psi</span> (@<span class="id" type="var">snd</span> <span class="id" type="var">variable</span> <span class="id" type="var">term</span> <span class="id" type="var">xval</span>))) <span class="id" type="var">sigma</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">refl_trans_clos</span> (<span class="id" type="var">P_step</span> <span class="id" type="var">R</span> (<span class="id" type="var">inner</span> <span class="id" type="var">R</span>)) (<span class="id" type="var">psi</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>)) (<span class="id" type="var">apply_subst</span> <span class="id" type="var">tau</span> <span class="id" type="var">t</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">sigma</span> <span class="id" type="var">tau</span> <span class="id" type="var">H</span>;<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Hvar</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">v</span>,  <span class="id" type="var">apply_subst</span> <span class="id" type="var">tau</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>) = <span class="id" type="var">psi</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>))).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">tau</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H3</span> := @<span class="id" type="var">find_map</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">psi</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma</span>).<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">val</span> | ]; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H3</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">psi_nf</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">nf_var</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Hvar</span>; <span class="id" type="var">left</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">map_psi</span> <span class="id" type="var">f</span> (<span class="id" type="var">map</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">l</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">H1</span> | [<span class="id" type="var">H1</span> <span class="id" type="var">H1'</span>]].<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H1</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H2</span> : <span class="id" type="var">refl_trans_clos</span> (<span class="id" type="var">one_step_list</span> (<span class="id" type="var">P_step</span> <span class="id" type="var">R</span> (<span class="id" type="var">inner</span> <span class="id" type="var">R</span>))) (<span class="id" type="var">map</span> <span class="id" type="var">psi</span> (<span class="id" type="var">map</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">l</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">map</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">tau</span>) <span class="id" type="var">l</span>)).<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">map_map</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">refl_trans_clos_one_step_list_refl_trans_clos_alt</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">l2</span> | <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">K2</span>].<br/>
<span class="id" type="var">left</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">P_general_context</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H2</span> : <span class="id" type="var">refl_trans_clos</span> (<span class="id" type="var">one_step_list</span> (<span class="id" type="var">P_step</span> <span class="id" type="var">R</span> (<span class="id" type="var">inner</span> <span class="id" type="var">R</span>))) (<span class="id" type="var">map</span> <span class="id" type="var">psi</span> (<span class="id" type="var">map</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">l</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">map</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">tau</span>) <span class="id" type="var">l</span>)).<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">map_map</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">refl_trans_clos_one_step_list_refl_trans_clos_alt</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">l2</span> | <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">K2</span>].<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">t_step</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">trans_clos_is_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">map</span> <span class="id" type="var">psi</span> (<span class="id" type="var">map</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">l</span>))).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">t_step</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">P_general_context</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">Psi_sim_inner_at_top</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span>, <span class="id" type="var">axiom</span> <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt;  <span class="id" type="var">inner</span> <span class="id" type="var">R</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">refl_trans_clos</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) (<span class="id" type="var">psi</span> <span class="id" type="var">s</span>) (<span class="id" type="var">psi</span> <span class="id" type="var">t</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span> <span class="id" type="var">H</span> <span class="id" type="var">It</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">r</span> <span class="id" type="var">l</span> <span class="id" type="var">sigma</span> <span class="id" type="var">H'</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">psi_char</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">l</span>)) <span class="id" type="keyword">as</span> [[<span class="id" type="var">_</span> <span class="id" type="var">H</span>] | <span class="id" type="var">P</span>].<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">r</span>) (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">l</span>)).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H''</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">H</span> <span class="id" type="var">_</span> <span class="id" type="var">H''</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">at_top</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">P</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">u</span> <span class="id" type="var">v</span> <span class="id" type="var">H</span> <span class="id" type="var">Acc_u</span> <span class="id" type="var">H3</span> | <span class="id" type="var">f'</span> <span class="id" type="var">ll</span> <span class="id" type="var">H</span> <span class="id" type="var">K</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">P</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H7</span> : <span class="id" type="var">psi</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">l</span>) = <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">r</span>).<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">UIR</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">l</span>)); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H7</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">psi_char</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">r</span>)) <span class="id" type="keyword">as</span> [[<span class="id" type="var">H1</span> <span class="id" type="var">H2</span>] | <span class="id" type="var">P</span>].<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H1</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">trans_incl</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">P_step</span> <span class="id" type="var">R</span> (<span class="id" type="var">inner</span> <span class="id" type="var">R</span>)).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">H6</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">P_step_one_step</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">inner</span> <span class="id" type="var">R</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Psi_rwr</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">K</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">s</span> [<span class="id" type="var">t</span> [<span class="id" type="var">st_in_ll</span> <span class="id" type="var">not_nf_t</span>]]].<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">nf</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">It</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H2</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">s</span>,t); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">Psi_sim_inner</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span>, <span class="id" type="var">P_step</span> <span class="id" type="var">R</span> (<span class="id" type="var">inner</span> <span class="id" type="var">R</span>) <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt;  <span class="id" type="var">refl_trans_clos</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) (<span class="id" type="var">psi</span> <span class="id" type="var">s</span>) (<span class="id" type="var">psi</span> <span class="id" type="var">t</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">s</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H'</span> | <span class="id" type="var">f'</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">H'</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">nf_var</span> <span class="id" type="var">v</span> <span class="id" type="var">s</span>); <span class="id" type="tactic">apply</span> <span class="id" type="var">at_top</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">IHl</span> <span class="id" type="var">s</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H'</span> | <span class="id" type="var">f'</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">H'</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">Psi_sim_inner_at_top</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H0</span> <span class="id" type="var">H'</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">H1</span> | <span class="id" type="var">H1</span>].<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">P_step_in_list</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H'</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">t</span> [<span class="id" type="var">s</span> [<span class="id" type="var">k1</span> [<span class="id" type="var">k2</span> [<span class="id" type="var">H1</span> [<span class="id" type="var">H2</span> <span class="id" type="var">H3</span>]]]]]].<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">psi_char</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)) <span class="id" type="keyword">as</span> [[<span class="id" type="var">K1</span> <span class="id" type="var">K2</span>] | <span class="id" type="var">P</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">one_step_nf_inner_step_nf</span> <span class="id" type="keyword">in</span> <span class="id" type="var">K2</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">K2</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l2</span>)); <span class="id" type="tactic">apply</span> <span class="id" type="var">P_in_context</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Rvar</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">P</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">ss</span> <span class="id" type="var">tt</span> <span class="id" type="var">H</span> <span class="id" type="var">K</span> | <span class="id" type="var">g</span> <span class="id" type="var">ll</span> <span class="id" type="var">H4</span> <span class="id" type="var">K</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">P</span>.<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">ss</span> <span class="id" type="var">tt</span>.<br/>
<span class="id" type="tactic">assert</span> <span class="id" type="var">False</span>; [<span class="id" type="var">idtac</span> | <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">refine</span> (<span class="id" type="var">K</span> <span class="id" type="var">t</span> <span class="id" type="var">_</span> <span class="id" type="var">s</span> <span class="id" type="var">_</span>).<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">P_step_one_step</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">inner</span> <span class="id" type="var">R</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">g</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H6</span> : <span class="id" type="var">map</span> (<span class="id" type="var">fst</span> (<span class="id" type="var">A</span>:=term) (<span class="id" type="var">B</span>:=term)) <span class="id" type="var">ll</span> = <span class="id" type="var">map</span> <span class="id" type="var">psi</span> <span class="id" type="var">l</span>).<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H5</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">K</span> <span class="id" type="var">H5</span> <span class="id" type="var">H0</span>.<br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">ll</span> <span class="id" type="keyword">as</span> [ | [<span class="id" type="var">u</span> <span class="id" type="var">v</span>] <span class="id" type="var">ll</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">IHll</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">t</span> =&gt; <span class="id" type="var">t</span> :: <span class="id" type="var">map</span> (<span class="id" type="var">fst</span> (<span class="id" type="var">A</span>:=term) (<span class="id" type="var">B</span>:=term)) <span class="id" type="var">ll</span>)).<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">H4</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>))) <span class="id" type="keyword">as</span> [<span class="id" type="var">H5</span> | [<span class="id" type="var">H5</span> <span class="id" type="var">H6</span>]].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Psi_unique</span> <span class="id" type="keyword">with</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">psi_not_nf</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H6</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">Psi_not_nf</span> <span class="id" type="var">v</span> <span class="id" type="var">u</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">psi_nf</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H4</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H6</span> <span class="id" type="keyword">in</span> *.<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">H4</span> <span class="id" type="var">H5</span> <span class="id" type="var">H6</span>; <span class="id" type="tactic">rename</span> <span class="id" type="var">H0</span> <span class="id" type="var">into</span> <span class="id" type="var">H4</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">map_psi</span> <span class="id" type="var">f</span> <span class="id" type="var">l2</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">H5</span> | [<span class="id" type="var">H5</span> <span class="id" type="var">H5'</span>]].<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H4</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H5</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">t_in_k</span> : <span class="id" type="var">In</span> <span class="id" type="var">t</span> (<span class="id" type="var">k1</span> ++ <span class="id" type="var">t</span> :: <span class="id" type="var">k2</span>)).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H2</span> <span class="id" type="keyword">in</span> <span class="id" type="var">t_in_k</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H4</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H2</span>, <span class="id" type="var">H3</span>; <span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> <span class="id" type="var">map_app</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">IH'</span> := <span class="id" type="var">IHl</span> <span class="id" type="var">_</span> <span class="id" type="var">t_in_k</span> <span class="id" type="var">_</span> <span class="id" type="var">H1</span>); <span class="id" type="tactic">inversion</span> <span class="id" type="var">IH'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x</span> | <span class="id" type="var">ps</span> <span class="id" type="var">pt</span> <span class="id" type="var">H6</span>].<br/>
<span class="id" type="var">left</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">context_in</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">t_in_k</span> : <span class="id" type="var">In</span> <span class="id" type="var">t</span> (<span class="id" type="var">k1</span> ++ <span class="id" type="var">t</span> :: <span class="id" type="var">k2</span>)).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H2</span> <span class="id" type="keyword">in</span> <span class="id" type="var">t_in_k</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_trans_clos_is_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">map</span> <span class="id" type="var">psi</span> <span class="id" type="var">l2</span>)).<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">P_step_one_step</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">inner</span> <span class="id" type="var">R</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H2</span>, <span class="id" type="var">H3</span>, <span class="id" type="var">map_app</span>, <span class="id" type="var">map_app</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">IH'</span>:= <span class="id" type="var">IHl</span> <span class="id" type="var">_</span> <span class="id" type="var">t_in_k</span> <span class="id" type="var">_</span> <span class="id" type="var">H1</span>); <span class="id" type="tactic">inversion</span> <span class="id" type="var">IH'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x</span> | <span class="id" type="var">ps</span> <span class="id" type="var">pt</span> <span class="id" type="var">H6</span>].<br/>
<span class="id" type="var">left</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">context_in</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">Psi_sim_one_step</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span>, <span class="id" type="var">one_step</span> <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">rwr</span> <span class="id" type="var">R</span> (<span class="id" type="var">psi</span> <span class="id" type="var">s</span>) (<span class="id" type="var">psi</span> <span class="id" type="var">t</span>) \/ <span class="id" type="var">P_step</span> <span class="id" type="var">R</span> (<span class="id" type="var">inner</span> <span class="id" type="var">R</span>) <span class="id" type="var">s</span> <span class="id" type="var">t</span> \/ <span class="id" type="var">exists</span> <span class="id" type="var">s'</span>, <span class="id" type="var">rwr</span> <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">s'</span> /\ <span class="id" type="var">P_step</span> <span class="id" type="var">R</span> (<span class="id" type="var">inner</span> <span class="id" type="var">R</span>) <span class="id" type="var">s'</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">W</span> : <span class="id" type="var">well_founded</span> (<span class="id" type="var">union</span> <span class="id" type="var">_</span> (<span class="id" type="var">P_step</span> <span class="id" type="var">R</span> (<span class="id" type="var">inner</span> <span class="id" type="var">R</span>)) <span class="id" type="var">direct_subterm</span>)).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">rewrite</span> &lt;-P_acc_with_subterm; <span class="id" type="tactic">apply</span> <span class="id" type="var">wf_inner</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">refine</span> (<span class="id" type="var">well_founded_ind</span> <span class="id" type="var">W</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">t</span>); <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">IHt</span> <span class="id" type="var">s</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H'</span> | <span class="id" type="var">f'</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">H'</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">rename</span> <span class="id" type="var">H'</span> <span class="id" type="var">into</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">r</span> <span class="id" type="var">l</span> <span class="id" type="var">sigma</span> <span class="id" type="var">H'</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">psi_char</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">l</span>)) <span class="id" type="keyword">as</span> [[<span class="id" type="var">_</span> <span class="id" type="var">H</span>] | <span class="id" type="var">P</span>].<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">r</span>) (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">l</span>)).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H''</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">H</span> <span class="id" type="var">_</span> <span class="id" type="var">H''</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">at_top</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">P</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">u</span> <span class="id" type="var">v</span> <span class="id" type="var">H</span> <span class="id" type="var">Acc_u</span> <span class="id" type="var">H3</span> | <span class="id" type="var">f'</span> <span class="id" type="var">ll</span> <span class="id" type="var">H</span> <span class="id" type="var">K</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">P</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H7</span> : <span class="id" type="var">psi</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">l</span>) = <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">r</span>).<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">UIR</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">l</span>)); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H7</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">psi_char</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">r</span>)) <span class="id" type="keyword">as</span> [[<span class="id" type="var">H1</span> <span class="id" type="var">H2</span>] | <span class="id" type="var">P</span>].<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">P_at_top</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">trans_incl</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">P_step</span> <span class="id" type="var">R</span> (<span class="id" type="var">inner</span> <span class="id" type="var">R</span>)).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">H6</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">P_step_one_step</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">inner</span> <span class="id" type="var">R</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Psi_rwr</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">set</span> (<span class="id" type="var">tau</span> := <span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">xval</span> =&gt; (@<span class="id" type="var">fst</span> <span class="id" type="var">variable</span> <span class="id" type="var">term</span> <span class="id" type="var">xval</span>, <span class="id" type="var">psi</span> (@<span class="id" type="var">snd</span> <span class="id" type="var">variable</span> <span class="id" type="var">term</span> <span class="id" type="var">xval</span>))) <span class="id" type="var">sigma</span>).<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">red_dec</span> :=compute_red_is_correct <span class="id" type="var">rule_list</span> <span class="id" type="var">Rreg'</span> <span class="id" type="var">R</span> <span class="id" type="var">Req</span>).<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">nf_dec</span> := <span class="id" type="var">dec_nf</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">red_dec</span>).<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">inner_dec</span> := <span class="id" type="var">nf_dec_inner_dec</span> <span class="id" type="var">_</span> <span class="id" type="var">nf_dec</span>).<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">AICR</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">sigma</span> <span class="id" type="var">H'</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">H6</span> | <span class="id" type="var">H6</span>].<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H3'</span> : <span class="id" type="var">psi</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">l</span>) = <span class="id" type="var">apply_subst</span> <span class="id" type="var">tau</span> <span class="id" type="var">l</span>).<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H4</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">p</span>, <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">l</span> <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> <span class="id" type="var">s</span> -&gt;  <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">psi</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">s</span>) = <span class="id" type="var">apply_subst</span> <span class="id" type="var">tau</span> <span class="id" type="var">s</span>).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">s</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">p</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">tau</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H5</span> := @<span class="id" type="var">find_map</span> <span class="id" type="var">_</span>  <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">psi</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma</span>).<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">val</span> | ]; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H5</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">psi_nf</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">nf_var</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">k</span> <span class="id" type="var">IH</span> <span class="id" type="var">p</span> <span class="id" type="var">Sub</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H3'</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">s</span>, <span class="id" type="var">In</span> <span class="id" type="var">s</span> <span class="id" type="var">k</span> -&gt; <span class="id" type="var">psi</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">s</span>) = <span class="id" type="var">apply_subst</span> <span class="id" type="var">tau</span> <span class="id" type="var">s</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">s_in_k</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">In_split</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">s_in_k</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">k1</span> [<span class="id" type="var">k2</span> <span class="id" type="var">H4</span>]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">k</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">IH</span> <span class="id" type="var">s</span> <span class="id" type="var">s_in_k</span> (<span class="id" type="var">p</span> ++ (<span class="id" type="var">length</span> <span class="id" type="var">k1</span> :: <span class="id" type="var">nil</span>))).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">subterm_in_subterm</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">k1</span> ++ <span class="id" type="var">s</span> :: <span class="id" type="var">k2</span>)); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">nth_error_at_pos</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">inner_dec</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">k</span>))) <span class="id" type="keyword">as</span> [<span class="id" type="var">inner_fk</span> | <span class="id" type="var">not_inner_fk</span>].<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">psi_char</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">k</span>))) <span class="id" type="keyword">as</span> [[<span class="id" type="var">H4</span> <span class="id" type="var">H5</span>] | <span class="id" type="var">P</span>].<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H4</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)); <span class="id" type="tactic">apply</span> <span class="id" type="var">map_eq</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">s_in_k</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H3'</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">sym_eq</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">psi_nf</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">nf_one_step_subterm</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">k</span>)); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">P</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">H''</span> <span class="id" type="var">_</span> | <span class="id" type="var">f''</span> <span class="id" type="var">ll'</span> <span class="id" type="var">H''</span> <span class="id" type="var">K'</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">P</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H''</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">d</span> <span class="id" type="var">g</span> <span class="id" type="var">phi</span> <span class="id" type="var">H3</span> <span class="id" type="var">H4</span> <span class="id" type="var">H5</span>].<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">H6</span> <span class="id" type="var">p</span> <span class="id" type="var">g</span> <span class="id" type="var">d</span> <span class="id" type="var">phi</span> <span class="id" type="var">H3</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">H7</span> | <span class="id" type="var">H7</span>].<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H5</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">subterm_at_pos_apply_subst_apply_subst_subterm_at_pos</span> <span class="id" type="var">l</span> <span class="id" type="var">p</span> <span class="id" type="var">sigma</span>).<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H5</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">l</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">psi_not_inner</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)).<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">map_map</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">map_eq</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H7</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">K</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">s</span> [<span class="id" type="var">t</span> [<span class="id" type="var">st_in_ll</span> <span class="id" type="var">not_nf_t</span>]]]; <span class="id" type="tactic">apply</span> <span class="id" type="var">not_nf_t</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">H7</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H2</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">s</span>,t); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">H7</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">q</span> [<span class="id" type="var">q'</span> [<span class="id" type="var">v</span> [<span class="id" type="var">H7</span> <span class="id" type="var">Sub'</span>]]]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">p</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">subterm_in_subterm2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">Sub</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">u</span> [<span class="id" type="var">Sub''</span> <span class="id" type="var">H7</span>]].<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Sub'</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Sub''</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">Sub''</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">Sub''</span>; <span class="id" type="tactic">intro</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">u</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">q'</span>; <span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">K'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">s'</span> [<span class="id" type="var">t'</span> [<span class="id" type="var">st_in_ll'</span> <span class="id" type="var">not_nf_t'</span>]]].<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">nf</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t'</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">inner_fk</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H5</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">s'</span>,t'); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">psi_not_inner</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">map_map</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">map_eq</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">H4</span> <span class="id" type="var">l</span> (@<span class="id" type="var">nil</span> <span class="id" type="var">nat</span>)); <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H3'</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">P</span> := <span class="id" type="var">psi_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">tau</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>) <span class="id" type="var">r</span>).<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">P</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">pr</span> <span class="id" type="var">H4</span> <span class="id" type="var">H4'</span> | <span class="id" type="var">pr</span> <span class="id" type="var">pr'</span> <span class="id" type="var">H4</span>].<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">t_step</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">at_top</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H4'</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">trans_clos_is_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">tau</span> <span class="id" type="var">r</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">trans_incl</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">P_step</span> <span class="id" type="var">R</span> (<span class="id" type="var">inner</span> <span class="id" type="var">R</span>)); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">H''</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">P_step_one_step</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">inner</span> <span class="id" type="var">R</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">t_step</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">at_top</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>; <span class="id" type="tactic">trivial</span>.<br/>

<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">H6</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">s'</span> [<span class="id" type="var">H6</span> <span class="id" type="var">H7</span>]]; <span class="id" type="var">exists</span> <span class="id" type="var">s'</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>

<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">one_step_in_list</span> <span class="id" type="var">H'</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">t</span> [<span class="id" type="var">s</span> [<span class="id" type="var">k1</span> [<span class="id" type="var">k2</span> [<span class="id" type="var">H1</span> [<span class="id" type="var">H2</span> <span class="id" type="var">H3</span>]]]]]].<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">psi_char</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f'</span> <span class="id" type="var">l2</span>)) <span class="id" type="keyword">as</span> [[<span class="id" type="var">K1</span> <span class="id" type="var">K2</span>] | <span class="id" type="var">P</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">K2</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f'</span> <span class="id" type="var">l1</span>)); <span class="id" type="tactic">apply</span> <span class="id" type="var">in_context</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">P</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">ss</span> <span class="id" type="var">tt</span> <span class="id" type="var">H</span> <span class="id" type="var">K</span> | <span class="id" type="var">g</span> <span class="id" type="var">ll</span> <span class="id" type="var">H4</span> <span class="id" type="var">K</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">P</span>.<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">ss</span> <span class="id" type="var">tt</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>.<br/>
<span class="id" type="tactic">refine</span> (<span class="id" type="var">K</span> <span class="id" type="var">t</span> <span class="id" type="var">_</span> <span class="id" type="var">s</span> <span class="id" type="var">H1</span>); <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">l2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">g</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H6</span> : <span class="id" type="var">map</span> (<span class="id" type="var">fst</span> (<span class="id" type="var">A</span>:=term) (<span class="id" type="var">B</span>:=term)) <span class="id" type="var">ll</span> = <span class="id" type="var">map</span> <span class="id" type="var">psi</span> <span class="id" type="var">l2</span>).<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H5</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">K</span> <span class="id" type="var">H5</span> <span class="id" type="var">H0</span>.<br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">ll</span> <span class="id" type="keyword">as</span> [ | [<span class="id" type="var">u</span> <span class="id" type="var">v</span>] <span class="id" type="var">ll</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">IHll</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">t</span> =&gt; <span class="id" type="var">t</span> :: <span class="id" type="var">map</span> (<span class="id" type="var">fst</span> (<span class="id" type="var">A</span>:=term) (<span class="id" type="var">B</span>:=term)) <span class="id" type="var">ll</span>)).<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">H4</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>))) <span class="id" type="keyword">as</span> [<span class="id" type="var">H5</span> | [<span class="id" type="var">H5</span> <span class="id" type="var">H6</span>]].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Psi_unique</span> <span class="id" type="keyword">with</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">psi_not_nf</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H6</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">Psi_not_nf</span> <span class="id" type="var">v</span> <span class="id" type="var">u</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">psi_nf</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H4</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H6</span> <span class="id" type="keyword">in</span> *; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H5</span> <span class="id" type="keyword">in</span> *.<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">H4</span> <span class="id" type="var">H5</span> <span class="id" type="var">H6</span>; <span class="id" type="tactic">rename</span> <span class="id" type="var">H0</span> <span class="id" type="var">into</span> <span class="id" type="var">H4</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">map_psi</span> <span class="id" type="var">f'</span> <span class="id" type="var">l1</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">H5</span> | [<span class="id" type="var">H5</span> <span class="id" type="var">H5'</span>]].<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H5</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">t_in_k</span> : <span class="id" type="var">In</span> <span class="id" type="var">t</span> (<span class="id" type="var">k1</span> ++ <span class="id" type="var">t</span> :: <span class="id" type="var">k2</span>)).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H2</span> <span class="id" type="keyword">in</span> <span class="id" type="var">t_in_k</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">IHt</span> <span class="id" type="var">t</span> (<span class="id" type="var">or_intror</span> <span class="id" type="var">_</span> <span class="id" type="var">t_in_k</span>) <span class="id" type="var">_</span> <span class="id" type="var">H1</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">H6</span> | [<span class="id" type="var">H6</span> | [<span class="id" type="var">s'</span> [<span class="id" type="var">H6</span> <span class="id" type="var">H7</span>]]]].<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>; <span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> <span class="id" type="var">map_app</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">context_in</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">P_step_context_in</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">do</span> 2 <span class="id" type="var">right</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f'</span> (<span class="id" type="var">k1</span> ++ <span class="id" type="var">s'</span> :: <span class="id" type="var">k2</span>)); <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">context_in</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">P_step_context_in</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">t_in_k</span> : <span class="id" type="var">In</span> <span class="id" type="var">t</span> (<span class="id" type="var">k1</span> ++ <span class="id" type="var">t</span> :: <span class="id" type="var">k2</span>)).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H2</span> <span class="id" type="keyword">in</span> <span class="id" type="var">t_in_k</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">IHt</span> <span class="id" type="var">t</span> (<span class="id" type="var">or_intror</span> <span class="id" type="var">_</span> <span class="id" type="var">t_in_k</span>) <span class="id" type="var">_</span> <span class="id" type="var">H1</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">H6</span> | [<span class="id" type="var">H6</span> | [<span class="id" type="var">s'</span> [<span class="id" type="var">H6</span> <span class="id" type="var">H7</span>]]]].<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">trans_clos_is_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f'</span> (<span class="id" type="var">map</span> <span class="id" type="var">psi</span> <span class="id" type="var">l1</span>)).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">t_step</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">P_step_one_step</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">inner</span> <span class="id" type="var">R</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">l2</span> <span class="id" type="var">l1</span>; <span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> <span class="id" type="var">map_app</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">context_in</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">P_step_context_in</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">do</span> 2 <span class="id" type="var">right</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f'</span> (<span class="id" type="var">k1</span> ++ <span class="id" type="var">s'</span> :: <span class="id" type="var">k2</span>)); <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">context_in</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">P_step_context_in</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">psi_id</span> <span class="id" type="var">t</span> := (<span class="id" type="var">psi</span> <span class="id" type="var">t</span>, <span class="id" type="var">t</span>).<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">oo</span> := @<span class="id" type="var">lex</span> <span class="id" type="var">term</span> <span class="id" type="var">term</span> <span class="id" type="var">eq_bool</span> (<span class="id" type="var">rwr</span> <span class="id" type="var">R</span>) (<span class="id" type="var">trans_clos</span> (<span class="id" type="var">P_step</span> <span class="id" type="var">R</span> (<span class="id" type="var">inner</span> <span class="id" type="var">R</span>))).<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">ooo</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> := <span class="id" type="var">oo</span> (<span class="id" type="var">psi_id</span> <span class="id" type="var">s</span>) (<span class="id" type="var">psi_id</span> <span class="id" type="var">t</span>).<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">acc_psi_acc_ooo</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">pt</span>, <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">pt</span> -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">psi</span> <span class="id" type="var">t</span> = <span class="id" type="var">pt</span> -&gt; <span class="id" type="var">Acc</span> <span class="id" type="var">ooo</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">a</span> <span class="id" type="var">Acc_a</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">acc_trans</span> <span class="id" type="var">Acc_a</span>); <span class="id" type="tactic">clear</span> <span class="id" type="var">Acc_a</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">Acc_a</span>.<br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">Acc_a</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">a</span> <span class="id" type="var">Acc_a</span> <span class="id" type="var">IHa</span>].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">a</span>.<br/>
<span class="id" type="tactic">generalize</span> <span class="id" type="var">Acc_a</span> <span class="id" type="var">IHa</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">Acc_a</span> <span class="id" type="var">IHa</span>;<br/>
<span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">refine</span> (<span class="id" type="var">well_founded_ind</span> (<span class="id" type="var">wf_trans</span> <span class="id" type="var">wf_inner</span>) <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">t</span>); <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">IH</span> <span class="id" type="var">Acc_psi_t</span> <span class="id" type="var">Acc_t</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">ooo</span>, <span class="id" type="var">oo</span>, <span class="id" type="var">psi_id</span> <span class="id" type="keyword">in</span> *.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">lex</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="var">revert</span> <span class="id" type="var">H</span>;<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">eq_bool_ok</span> (<span class="id" type="var">psi</span> <span class="id" type="var">s</span>) (<span class="id" type="var">psi</span> <span class="id" type="var">t</span>)); <span class="id" type="tactic">case</span> (<span class="id" type="var">eq_bool</span> (<span class="id" type="var">psi</span> <span class="id" type="var">s</span>) (<span class="id" type="var">psi</span> <span class="id" type="var">t</span>)); [<span class="id" type="tactic">intro</span> <span class="id" type="var">psi_s_eq_psi_t</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">psi_s_diff_psi_t</span>].<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">IH</span> <span class="id" type="var">s</span> <span class="id" type="var">H</span>); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">psi_s_eq_psi_t</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_t</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">psi</span> <span class="id" type="var">s</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">acc_psi_acc</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) (<span class="id" type="var">psi</span> <span class="id" type="var">t</span>) -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">Acc_psi_t</span>;<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Acc_t</span> := <span class="id" type="var">acc_psi_acc_ooo</span> <span class="id" type="var">_</span> <span class="id" type="var">Acc_psi_t</span> <span class="id" type="var">t</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)).<br/>
<span class="id" type="tactic">generalize</span> <span class="id" type="var">Acc_psi_t</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">Acc_psi_t</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">Acc_t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t</span> <span class="id" type="var">Acc_t</span> <span class="id" type="var">IH</span>].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">Acc_psi_t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">Psi_sim_one_step</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span> <span class="id" type="var">H</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">H1</span> | [<span class="id" type="var">H1</span> | [<span class="id" type="var">s'</span> [<span class="id" type="var">H1</span> <span class="id" type="var">H2</span>]]]]; <span class="id" type="tactic">unfold</span> <span class="id" type="var">ooo</span>, <span class="id" type="var">oo</span>, <span class="id" type="var">psi_id</span> <span class="id" type="keyword">in</span> *.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IH</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">lex</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">eq_bool_ok</span> (<span class="id" type="var">psi</span> <span class="id" type="var">s</span>) (<span class="id" type="var">psi</span> <span class="id" type="var">t</span>)); <span class="id" type="tactic">case</span> (<span class="id" type="var">eq_bool</span> (<span class="id" type="var">psi</span> <span class="id" type="var">s</span>) (<span class="id" type="var">psi</span> <span class="id" type="var">t</span>)); [<span class="id" type="tactic">intro</span> <span class="id" type="var">psi_s_eq_psi_t</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">psi_s_diff_psi_t</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">Acc</span> (<span class="id" type="var">rwr</span> <span class="id" type="var">R</span>) (<span class="id" type="var">psi</span> <span class="id" type="var">t</span>)).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">cycle_not_acc</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">psi_s_eq_psi_t</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">acc_one_step</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">acc_one_step</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">acc_one_step</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Acc_psi_t</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">Acc_psi_t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">Acc_psi_t</span>]; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_psi_t</span>; <span class="id" type="tactic">trivial</span>.<br/>

<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IH</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">lex</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">eq_bool_ok</span> (<span class="id" type="var">psi</span> <span class="id" type="var">s</span>) (<span class="id" type="var">psi</span> <span class="id" type="var">t</span>)); <span class="id" type="tactic">case</span> (<span class="id" type="var">eq_bool</span> (<span class="id" type="var">psi</span> <span class="id" type="var">s</span>) (<span class="id" type="var">psi</span> <span class="id" type="var">t</span>)); [<span class="id" type="tactic">intro</span> <span class="id" type="var">psi_s_eq_psi_t</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">psi_s_diff_psi_t</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">t_step</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">P</span> := <span class="id" type="var">Psi_sim_inner</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H1</span>).<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">P</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">p</span> <span class="id" type="var">H2</span> <span class="id" type="var">H2'</span>| <span class="id" type="var">ps</span> <span class="id" type="var">pt</span> <span class="id" type="var">H2</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">P</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">psi</span> <span class="id" type="var">s</span> = <span class="id" type="var">psi</span> <span class="id" type="var">t</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">P</span> := <span class="id" type="var">Psi_sim_inner</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H1</span>).<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">P</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">p</span> <span class="id" type="var">H2</span> <span class="id" type="var">H2'</span>| <span class="id" type="var">ps</span> <span class="id" type="var">pt</span> <span class="id" type="var">H2</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">P</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H2'</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">acc_one_step</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">acc_one_step</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Acc_psi_t</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">Acc_psi_t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">Acc_psi_t</span>]; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_psi_t</span>; <span class="id" type="tactic">trivial</span>.<br/>

<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Acc_s'</span> : <span class="id" type="var">Acc</span> (<span class="id" type="var">rwr</span> <span class="id" type="var">R</span>) <span class="id" type="var">s'</span>).<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">acc_one_step</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IH</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">lex</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">eq_bool_ok</span> (<span class="id" type="var">psi</span> <span class="id" type="var">s'</span>) (<span class="id" type="var">psi</span> <span class="id" type="var">t</span>)); <span class="id" type="tactic">case</span> (<span class="id" type="var">eq_bool</span> (<span class="id" type="var">psi</span> <span class="id" type="var">s'</span>) (<span class="id" type="var">psi</span> <span class="id" type="var">t</span>)); [<span class="id" type="tactic">intro</span> <span class="id" type="var">psi_s_eq_psi_t</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">psi_s_diff_psi_t</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">t_step</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">P</span> := <span class="id" type="var">Psi_sim_inner</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H2</span>).<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">P</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">p</span> <span class="id" type="var">H3</span> <span class="id" type="var">H3'</span>| <span class="id" type="var">ps'</span> <span class="id" type="var">pt</span> <span class="id" type="var">H3</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">P</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">psi</span> <span class="id" type="var">s'</span> = <span class="id" type="var">psi</span> <span class="id" type="var">t</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">P</span> := <span class="id" type="var">Psi_sim_inner</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H2</span>).<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">P</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">p</span> <span class="id" type="var">H3</span> <span class="id" type="var">H3'</span>| <span class="id" type="var">ps'</span> <span class="id" type="var">pt</span> <span class="id" type="var">H3</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">P</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H3'</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">acc_one_step</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">acc_one_step</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Acc_psi_t</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">Acc_psi_t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">Acc_psi_t</span>]; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_psi_t</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">acc_one_step</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">Acc_s'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">Acc_s'</span>]; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_s'</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">acc_inner_acc</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">refine</span> (<span class="id" type="var">well_founded_ind</span> (<span class="id" type="var">wf_trans</span> <span class="id" type="var">wf_inner</span>) <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">t</span>); <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">IH</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">acc_psi_acc</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">psi_char</span> <span class="id" type="var">t</span>) <span class="id" type="keyword">as</span> [[<span class="id" type="var">H3</span> <span class="id" type="var">H4</span>] | <span class="id" type="var">H3</span>].<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H3</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">assert</span> <span class="id" type="var">False</span>; [<span class="id" type="var">idtac</span> | <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">H4</span> <span class="id" type="var">_</span> <span class="id" type="var">H</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IH</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Psi_rwr</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">wf_inner_wf</span> : <span class="id" type="var">well_founded</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">acc_inner_acc</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">End</span> <span class="id" type="var">Psi_definition</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">wf_inner_no_wf</span> : <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> : <span class="id" type="var">relation</span> <span class="id" type="var">term</span>,<br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> (<span class="id" type="var">t</span> : <span class="id" type="var">term</span>) (<span class="id" type="var">x</span> : <span class="id" type="var">variable</span>), ~ <span class="id" type="var">R</span> <span class="id" type="var">t</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>)) -&gt;<br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> : <span class="id" type="var">term</span>, <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> : <span class="id" type="var">variable</span>, <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">t</span>)) -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">rule_list</span> : <span class="id" type="var">list</span> (<span class="id" type="var">term</span> * <span class="id" type="var">term</span>), (<span class="id" type="keyword">forall</span> <span class="id" type="var">l</span> <span class="id" type="var">r</span> : <span class="id" type="var">term</span>, <span class="id" type="var">R</span> <span class="id" type="var">r</span> <span class="id" type="var">l</span> &lt;-&gt; <span class="id" type="var">In</span> (<span class="id" type="var">l</span>, <span class="id" type="var">r</span>) <span class="id" type="var">rule_list</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="var">well_founded</span> (<span class="id" type="var">P_step</span> <span class="id" type="var">R</span> (<span class="id" type="var">inner</span> <span class="id" type="var">R</span>)) -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="var">non_overlapping</span> <span class="id" type="var">R</span> -&gt; <span class="id" type="var">well_founded</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">Rvar</span> <span class="id" type="var">Rreg</span> <span class="id" type="var">rule_list</span> <span class="id" type="var">Req</span> <span class="id" type="var">wf_inner</span> <span class="id" type="var">NO</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">wf_inner_wf</span> <span class="id" type="keyword">with</span> <span class="id" type="var">rule_list</span>; <span class="id" type="tactic">trivial</span>.<br/>

<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span> <span class="id" type="var">s'</span> <span class="id" type="var">It</span> <span class="id" type="var">H</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">r</span> <span class="id" type="var">l</span> <span class="id" type="var">sigma</span>]; <span class="id" type="tactic">inversion</span> <span class="id" type="var">H'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">d</span> <span class="id" type="var">g</span> <span class="id" type="var">tau</span>]; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H6</span> := <span class="id" type="var">NO</span> <span class="id" type="var">l</span> <span class="id" type="var">r</span> <span class="id" type="var">g</span> <span class="id" type="var">d</span> <span class="id" type="var">sigma</span> <span class="id" type="var">tau</span> <span class="id" type="var">H0</span> <span class="id" type="var">H3</span>).<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v</span> | <span class="id" type="var">f</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">R</span> <span class="id" type="var">r</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>)); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">H6</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> (@<span class="id" type="var">nil</span> <span class="id" type="var">nat</span>) (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>) (<span class="id" type="var">sym_eq</span> <span class="id" type="var">H5</span>)) <span class="id" type="keyword">as</span> [ <span class="id" type="var">_</span> [<span class="id" type="var">H7</span> <span class="id" type="var">H8</span>]]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H6</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">sym_eq</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">subst_eq_vars</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_d</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">subst_eq_vars</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H5</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">H5</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Rreg</span> <span class="id" type="keyword">with</span> <span class="id" type="var">d</span>; <span class="id" type="tactic">trivial</span>.<br/>

<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">l</span> <span class="id" type="var">r</span> <span class="id" type="var">sigma</span> <span class="id" type="var">H0</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">p</span> <span class="id" type="var">g</span> <span class="id" type="var">d</span> <span class="id" type="var">tau</span> <span class="id" type="var">H3</span> <span class="id" type="var">Sub</span> <span class="id" type="var">Igtau</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H6</span> := <span class="id" type="var">NO</span> <span class="id" type="var">l</span> <span class="id" type="var">r</span> <span class="id" type="var">g</span> <span class="id" type="var">d</span> <span class="id" type="var">sigma</span> <span class="id" type="var">tau</span> <span class="id" type="var">H0</span> <span class="id" type="var">H3</span>).<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H7</span> := <span class="id" type="var">subterm_in_instantiated_term</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">Sub</span>).<br/>
<span class="id" type="var">case_eq</span> (<span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">l</span> <span class="id" type="var">p</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">u'</span> <span class="id" type="var">Sub'</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Sub'</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H7</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">u'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v</span> | <span class="id" type="var">f'</span> <span class="id" type="var">l'</span>].<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">exists</span> <span class="id" type="var">p</span>; <span class="id" type="var">exists</span> (@<span class="id" type="var">nil</span> <span class="id" type="var">nat</span>); <span class="id" type="var">exists</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">app_nil_end</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">H6</span> <span class="id" type="var">f'</span> <span class="id" type="var">l'</span> <span class="id" type="var">p</span> <span class="id" type="var">Sub'</span> (<span class="id" type="var">sym_eq</span> <span class="id" type="var">H7</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">p_eq_nil</span> <span class="id" type="var">_</span>]; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">Sub'</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Sub'</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H7</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">H7</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v</span> [<span class="id" type="var">q</span> [<span class="id" type="var">q'</span> [<span class="id" type="var">H7</span> [<span class="id" type="var">v_in_l</span> [<span class="id" type="var">Sub''</span> <span class="id" type="var">Sub3</span>]]]]]].<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">exists</span> <span class="id" type="var">q</span>; <span class="id" type="var">exists</span> <span class="id" type="var">q'</span>; <span class="id" type="var">exists</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">End</span> <span class="id" type="var">Make</span>.<br/>

<br/>
</div>
</div>

<div id="footer">
<hr/><a href="index.html">Index</a><hr/>This page has been generated by <a href="http://www.lix.polytechnique.fr/coq/">coqdoc</a>
</div>

</div>

</body>
</html>