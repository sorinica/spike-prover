<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"/>
<link href="coqdoc.css" rel="stylesheet" type="text/css"/>
<title>ac_matching.ac</title>
</head>

<body>

<div id="page">

<div id="header">
</div>

<div id="main">

<h1 class="libtitle">Library ac_matching.ac</h1>

<div class="code">

<br/>
<span class="id" type="keyword">Add</span> <span class="id" type="var">LoadPath</span> "basis".<br/>
<span class="id" type="keyword">Add</span> <span class="id" type="var">LoadPath</span> "list_extensions".<br/>
<span class="id" type="keyword">Add</span> <span class="id" type="var">LoadPath</span> "term_algebra".<br/>
<span class="id" type="keyword">Add</span> <span class="id" type="var">LoadPath</span> "term_orderings".<br/>

<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Relations</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">List</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">more_list</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">list_permut</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">list_sort</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Arith</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">term_spec</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">term_o</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">equational_theory_spec</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">equational_theory</span>.<br/>

<br/>
<span class="id" type="keyword">Set</span> <span class="id" type="keyword">Implicit</span> <span class="id" type="var">Arguments</span>.<br/>

<br/>
<span class="id" type="keyword">Module</span> <span class="id" type="keyword">Type</span> <span class="id" type="var">S</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Declare Module</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">EqTh</span> : <span class="id" type="var">equational_theory_spec.EqTh</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Import</span> <span class="id" type="var">T</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Import</span> <span class="id" type="var">F</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Declare Module</span> <span class="id" type="var">TO</span> : <span class="id" type="var">ordered_set.S</span> <span class="id" type="keyword">with</span> <span class="id" type="keyword">Definition</span> <span class="id" type="var">A</span> := <span class="id" type="var">term</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Declare Module</span> <span class="id" type="keyword">Import</span> <span class="id" type="keyword">Sort</span> : <span class="id" type="var">list_sort.Sort</span> <span class="id" type="keyword">with</span> <span class="id" type="keyword">Module</span> <span class="id" type="var">DOS</span> := <span class="id" type="var">TO</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Import</span> <span class="id" type="var">LPermut</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab111"></a><h2 class="section">Definition of AC.</h2>

</div>
<div class="code">
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">ac_one_step_at_top</span> : <span class="id" type="var">term</span> -&gt; <span class="id" type="var">term</span> -&gt; <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">a_axiom</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> (<span class="id" type="var">f</span>:symbol) (<span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">t3</span>:term),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ac_one_step_at_top</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">Term</span> <span class="id" type="var">f</span> ((<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t1</span> :: <span class="id" type="var">t2</span> :: <span class="id" type="var">nil</span>)) :: <span class="id" type="var">t3</span> :: <span class="id" type="var">nil</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t1</span> :: ((<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t2</span> :: <span class="id" type="var">t3</span> :: <span class="id" type="var">nil</span>)) :: <span class="id" type="var">nil</span>)))<br/>
&nbsp;&nbsp;| <span class="id" type="var">c_axiom</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> (<span class="id" type="var">f</span>:symbol) (<span class="id" type="var">t1</span> <span class="id" type="var">t2</span>:term),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">C</span> \/ <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ac_one_step_at_top</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t1</span> :: <span class="id" type="var">t2</span> :: <span class="id" type="var">nil</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t2</span> :: <span class="id" type="var">t1</span> :: <span class="id" type="var">nil</span>)).<br/>

<br/>
<span class="id" type="keyword">Hint</span> <span class="id" type="var">Constructors</span> <span class="id" type="var">ac_one_step_at_top</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">ac</span> := <span class="id" type="var">th_eq</span> <span class="id" type="var">ac_one_step_at_top</span>.<br/>

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">flatten</span> (<span class="id" type="var">f</span> : <span class="id" type="var">symbol</span>) (<span class="id" type="var">l</span> : <span class="id" type="var">list</span> <span class="id" type="var">term</span>) : <span class="id" type="var">list</span> <span class="id" type="var">term</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">nil</span><br/>
&nbsp;&nbsp;| (<span class="id" type="var">Var</span> <span class="id" type="var">_</span> <span class="id" type="keyword">as</span> <span class="id" type="var">t</span>) :: <span class="id" type="var">tl</span> =&gt; <span class="id" type="var">t</span> :: (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> <span class="id" type="var">tl</span>)<br/>
&nbsp;&nbsp;| (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">ll</span> <span class="id" type="keyword">as</span> <span class="id" type="var">t</span>) :: <span class="id" type="var">tl</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">if</span> <span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">then</span> <span class="id" type="var">ll</span> ++ (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> <span class="id" type="var">tl</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">else</span> <span class="id" type="var">t</span> :: (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> <span class="id" type="var">tl</span>)<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">canonical_form</span> (<span class="id" type="var">t</span> : <span class="id" type="var">term</span>) : <span class="id" type="var">term</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">t</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Term</span> <span class="id" type="var">f</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">match</span> <span class="id" type="var">arity</span> <span class="id" type="var">f</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Free</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">map</span> <span class="id" type="var">canonical_form</span> <span class="id" type="var">l</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">C</span> =&gt; <span class="id" type="var">quicksort</span> (<span class="id" type="var">map</span> <span class="id" type="var">canonical_form</span> <span class="id" type="var">l</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">AC</span> =&gt; <span class="id" type="var">quicksort</span> (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">map</span> <span class="id" type="var">canonical_form</span> <span class="id" type="var">l</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>)<br/>
<span class="id" type="keyword">end</span>.<br/>

<br/>
&nbsp;<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">well_formed_cf</span> (<span class="id" type="var">t</span>:term) : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">True</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">wf_cf_list</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">fix</span> <span class="id" type="var">wf_cf_list</span> (<span class="id" type="var">l</span>:list <span class="id" type="var">term</span>) : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">True</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">h</span> :: <span class="id" type="var">tl</span> =&gt; <span class="id" type="var">well_formed_cf</span> <span class="id" type="var">h</span> /\ <span class="id" type="var">wf_cf_list</span> <span class="id" type="var">tl</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>) <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">wf_cf_list</span> <span class="id" type="var">l</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">match</span> <span class="id" type="var">arity</span> <span class="id" type="var">f</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Free</span> <span class="id" type="var">n</span> =&gt; <span class="id" type="var">length</span> <span class="id" type="var">l</span> = <span class="id" type="var">n</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">C</span> =&gt; <span class="id" type="var">length</span> <span class="id" type="var">l</span> = 2 /\ <span class="id" type="var">is_sorted</span> <span class="id" type="var">l</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">AC</span> =&gt; <span class="id" type="var">length</span> <span class="id" type="var">l</span> &gt;= 2 /\ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">is_sorted</span> <span class="id" type="var">l</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span>, <span class="id" type="var">In</span> <span class="id" type="var">s</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="keyword">match</span> <span class="id" type="var">s</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">True</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">f</span>&lt;&gt;g<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">build</span> (<span class="id" type="var">f</span> : <span class="id" type="var">symbol</span>) <span class="id" type="var">l</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">t</span> :: <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">t</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">_</span> =&gt; <span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">quicksort</span> <span class="id" type="var">l</span>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">well_formed_cf_subst</span> <span class="id" type="var">sigma</span> := <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">v</span>, <span class="id" type="keyword">match</span> <span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">None</span> =&gt; <span class="id" type="var">True</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Some</span> <span class="id" type="var">t</span> =&gt; <span class="id" type="var">well_formed_cf</span> <span class="id" type="var">t</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
&nbsp;<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">apply_cf_subst</span> (<span class="id" type="var">sigma</span> : <span class="id" type="var">substitution</span>) (<span class="id" type="var">t</span> : <span class="id" type="var">term</span>) {<span class="id" type="keyword">struct</span> <span class="id" type="var">t</span>} : <span class="id" type="var">term</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">v</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">None</span> =&gt; <span class="id" type="var">t</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Some</span> <span class="id" type="var">v_sigma</span> =&gt; <span class="id" type="var">v_sigma</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">l_sigma</span> := <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">arity</span> <span class="id" type="var">f</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">AC</span> =&gt; <span class="id" type="var">quicksort</span> (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">map</span> (<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">l</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">C</span> =&gt; <span class="id" type="var">quicksort</span> (<span class="id" type="var">map</span> (<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">l</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Free</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">map</span> (<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">l</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span> <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l_sigma</span><br/>
&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
&nbsp;<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">ac_size</span> (<span class="id" type="var">t</span>:term) : <span class="id" type="var">nat</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">v</span> =&gt; 1<br/>
&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">ac_size_list</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">fix</span> <span class="id" type="var">ac_size_list</span> (<span class="id" type="var">l</span> : <span class="id" type="var">list</span> <span class="id" type="var">term</span>) {<span class="id" type="keyword">struct</span> <span class="id" type="var">l</span>} : <span class="id" type="var">nat</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; 0<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">t</span> :: <span class="id" type="var">lt</span> =&gt; <span class="id" type="var">ac_size</span> <span class="id" type="var">t</span> + <span class="id" type="var">ac_size_list</span> <span class="id" type="var">lt</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>) <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">match</span> <span class="id" type="var">arity</span> <span class="id" type="var">f</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">AC</span> =&gt; (<span class="id" type="var">length</span> <span class="id" type="var">l</span>) - 1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">C</span> =&gt; 1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Free</span> <span class="id" type="var">_</span> =&gt; 1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>) + <span class="id" type="var">ac_size_list</span> <span class="id" type="var">l</span><br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
&nbsp;<span class="id" type="keyword">Parameter</span> <span class="id" type="var">l_assoc</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">t3</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="var">ac</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t1</span> :: <span class="id" type="var">t2</span> :: <span class="id" type="var">nil</span>) :: <span class="id" type="var">t3</span> :: <span class="id" type="var">nil</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t1</span> :: (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t2</span> :: <span class="id" type="var">t3</span> :: <span class="id" type="var">nil</span>)) :: <span class="id" type="var">nil</span>)).<br/>

<br/>
<span class="id" type="keyword">Parameter</span> <span class="id" type="var">r_assoc</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">t3</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="var">ac</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t1</span> :: (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t2</span> :: <span class="id" type="var">t3</span> :: <span class="id" type="var">nil</span>)) :: <span class="id" type="var">nil</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t1</span> :: <span class="id" type="var">t2</span> :: <span class="id" type="var">nil</span>) :: <span class="id" type="var">t3</span> :: <span class="id" type="var">nil</span>)).<br/>

<br/>
<span class="id" type="keyword">Parameter</span> <span class="id" type="var">comm</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">C</span> \/ <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="var">ac</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t1</span> :: <span class="id" type="var">t2</span> :: <span class="id" type="var">nil</span>)) (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t2</span> :: <span class="id" type="var">t1</span> :: <span class="id" type="var">nil</span>)).<br/>

<br/>
<span class="id" type="keyword">Parameter</span> <span class="id" type="var">ac_top_eq</span> : <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">ac</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">t1</span>, <span class="id" type="var">t2</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">x1</span>, <span class="id" type="var">Var</span> <span class="id" type="var">x2</span> =&gt; <span class="id" type="var">x1</span> = <span class="id" type="var">x2</span><br/>
&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>, <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">False</span><br/>
&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span>, <span class="id" type="var">Term</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">False</span><br/>
&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f1</span> <span class="id" type="var">_</span>, <span class="id" type="var">Term</span> <span class="id" type="var">f2</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">f1</span> = <span class="id" type="var">f2</span><br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Parameter</span> <span class="id" type="var">well_formed_cf_unfold</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>,<br/>
&nbsp;<span class="id" type="var">well_formed_cf</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">True</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">u</span>, <span class="id" type="var">In</span> <span class="id" type="var">u</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="var">well_formed_cf</span> <span class="id" type="var">u</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">match</span> <span class="id" type="var">arity</span> <span class="id" type="var">f</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">AC</span> =&gt; <span class="id" type="var">length</span> <span class="id" type="var">l</span> &gt;= 2 /\ <span class="id" type="var">is_sorted</span> <span class="id" type="var">l</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">u</span>, <span class="id" type="var">In</span> <span class="id" type="var">u</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="keyword">match</span> <span class="id" type="var">u</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">True</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">f</span> &lt;&gt; <span class="id" type="var">g</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">C</span> =&gt; <span class="id" type="var">length</span> <span class="id" type="var">l</span> = 2 /\ <span class="id" type="var">is_sorted</span> <span class="id" type="var">l</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Free</span> <span class="id" type="var">n</span> =&gt; <span class="id" type="var">length</span> <span class="id" type="var">l</span> = <span class="id" type="var">n</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Parameter</span> <span class="id" type="var">well_formed_cf_subterms</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>, <span class="id" type="var">well_formed_cf</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) -&gt; (<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="var">well_formed_cf</span> <span class="id" type="var">t</span>).<br/>

<br/>
<span class="id" type="keyword">Parameter</span> <span class="id" type="var">well_formed_cf_length</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt; <span class="id" type="var">well_formed_cf</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) -&gt; 2 &lt;= <span class="id" type="var">length</span> <span class="id" type="var">l</span>.<br/>

<br/>
<span class="id" type="keyword">Parameter</span> <span class="id" type="var">well_formed_cf_sorted</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt; <span class="id" type="var">well_formed_cf</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) -&gt; <span class="id" type="var">is_sorted</span> <span class="id" type="var">l</span>.<br/>

<br/>
<span class="id" type="keyword">Parameter</span> <span class="id" type="var">well_formed_cf_alien</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt; <span class="id" type="var">well_formed_cf</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) -&gt;<br/>
&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">True</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">f</span> &lt;&gt; <span class="id" type="var">g</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>).<br/>

<br/>
&nbsp;<span class="id" type="keyword">Parameter</span> <span class="id" type="var">flatten_app</span> : <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>, <span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">l1</span> ++ <span class="id" type="var">l2</span>) = (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span>) ++ (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> <span class="id" type="var">l2</span>).<br/>

<br/>
<span class="id" type="keyword">Parameter</span> <span class="id" type="var">list_permut_flatten</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>, <span class="id" type="var">permut</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> -&gt; <span class="id" type="var">permut</span> (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span>) (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> <span class="id" type="var">l2</span>).<br/>

<br/>
<span class="id" type="keyword">Parameter</span> <span class="id" type="var">length_flatten_bis</span> :<br/>
<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">l</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="var">well_formed_cf</span> <span class="id" type="var">t</span>) -&gt;<br/>
&nbsp;(<span class="id" type="var">length</span> <span class="id" type="var">l</span>) &lt;= <span class="id" type="var">length</span> (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>).<br/>

<br/>
<span class="id" type="keyword">Parameter</span> <span class="id" type="var">flatten_cf</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt; <span class="id" type="var">well_formed_cf</span> <span class="id" type="var">t1</span> -&gt; <span class="id" type="var">well_formed_cf</span> <span class="id" type="var">t2</span> -&gt;<br/>
&nbsp;<span class="id" type="var">permut</span> (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">t1</span> :: <span class="id" type="var">nil</span>)) (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">t2</span> :: <span class="id" type="var">nil</span>)) -&gt;<br/>
&nbsp;<span class="id" type="var">t1</span> = <span class="id" type="var">t2</span>.<br/>

<br/>
&nbsp;<span class="id" type="keyword">Parameter</span> <span class="id" type="var">flatten_cf_cf</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt; <span class="id" type="var">well_formed</span> <span class="id" type="var">t1</span> -&gt; <span class="id" type="var">well_formed</span> <span class="id" type="var">t2</span> -&gt;<br/>
&nbsp;<span class="id" type="var">permut</span> (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">canonical_form</span> <span class="id" type="var">t1</span> :: <span class="id" type="var">nil</span>))<br/>
&nbsp;(<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">canonical_form</span> <span class="id" type="var">t2</span> :: <span class="id" type="var">nil</span>)) -&gt;<br/>
&nbsp;<span class="id" type="var">canonical_form</span> <span class="id" type="var">t1</span> = <span class="id" type="var">canonical_form</span> <span class="id" type="var">t2</span>.<br/>

<br/>
<span class="id" type="keyword">Parameter</span> <span class="id" type="var">build_eq_Term</span> :<br/>
<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>, 2 &lt;= <span class="id" type="var">length</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="var">build</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> = <span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">quicksort</span> <span class="id" type="var">l</span>).<br/>

<br/>
<span class="id" type="keyword">Parameter</span> <span class="id" type="var">well_formed_cf_build</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt;<br/>
&nbsp;1 &lt;= <span class="id" type="var">length</span> <span class="id" type="var">l</span> -&gt;<br/>
&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="var">well_formed_cf</span> <span class="id" type="var">t</span>) -&gt;<br/>
&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span> | <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">True</span> | <span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">f</span> &lt;&gt; <span class="id" type="var">g</span> <span class="id" type="keyword">end</span>) -&gt;<br/>
&nbsp;<span class="id" type="var">well_formed_cf</span> (<span class="id" type="var">build</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>).<br/>

<br/>
<span class="id" type="keyword">Parameter</span> <span class="id" type="var">well_formed_cf_build_cons</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt; <br/>
&nbsp;<span class="id" type="var">well_formed_cf</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t</span> :: <span class="id" type="var">l</span>)) -&gt; <span class="id" type="var">well_formed_cf</span> (<span class="id" type="var">build</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>).<br/>

<br/>
<span class="id" type="keyword">Parameter</span> <span class="id" type="var">well_formed_cf_build_inside</span> :<br/>
<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">t</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt; <br/>
&nbsp;<span class="id" type="var">well_formed_cf</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">l1</span> ++ <span class="id" type="var">t</span> :: <span class="id" type="var">l2</span>)) -&gt; <span class="id" type="var">well_formed_cf</span> (<span class="id" type="var">build</span> <span class="id" type="var">f</span> (<span class="id" type="var">l1</span> ++ <span class="id" type="var">l2</span>)).<br/>

<br/>
<span class="id" type="keyword">Parameter</span> <span class="id" type="var">flatten_build</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt; <br/>
&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span> | <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">True</span> | <span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">f</span> &lt;&gt; <span class="id" type="var">g</span> <span class="id" type="keyword">end</span>) -&gt;<br/>
&nbsp;<span class="id" type="var">permut</span> (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> ((<span class="id" type="var">build</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) :: <span class="id" type="var">nil</span>)) <span class="id" type="var">l</span>.<br/>

<br/>
<span class="id" type="keyword">Parameter</span> <span class="id" type="var">flatten_build_cons</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt; <span class="id" type="var">well_formed_cf</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t</span> :: <span class="id" type="var">l</span>)) -&gt; <br/>
&nbsp;<span class="id" type="var">permut</span> (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> ((<span class="id" type="var">build</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) :: <span class="id" type="var">nil</span>)) <span class="id" type="var">l</span>.<br/>

<br/>
<span class="id" type="keyword">Parameter</span> <span class="id" type="var">flatten_build_inside</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">t</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt; <br/>
&nbsp;<span class="id" type="var">well_formed_cf</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">l1</span> ++ <span class="id" type="var">t</span> :: <span class="id" type="var">l2</span>)) -&gt;<br/>
&nbsp;<span class="id" type="var">permut</span> (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> ((<span class="id" type="var">build</span> <span class="id" type="var">f</span> (<span class="id" type="var">l1</span> ++ <span class="id" type="var">l2</span>)) :: <span class="id" type="var">nil</span>)) (<span class="id" type="var">l1</span> ++ <span class="id" type="var">l2</span>).<br/>

<br/>
<span class="id" type="keyword">Parameter</span> <span class="id" type="var">flatten_apply_cf_subst</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">sigma</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="var">permut</span> (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">map</span> (<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">l</span>))<br/>
&nbsp;&nbsp;(<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">build</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) :: <span class="id" type="var">nil</span>)).<br/>

<br/>
<span class="id" type="keyword">Parameter</span> <span class="id" type="var">well_formed_cf_apply_subst</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">sigma</span>, <span class="id" type="var">well_formed_cf_subst</span> <span class="id" type="var">sigma</span> -&gt; <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">well_formed_cf</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">well_formed_cf</span> (<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>).<br/>

<br/>
<span class="id" type="keyword">Parameter</span> <span class="id" type="var">length_flatten_ter</span> :<br/>
<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">sigma</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt; <span class="id" type="var">well_formed_cf_subst</span> <span class="id" type="var">sigma</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">l</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="var">well_formed_cf</span> <span class="id" type="var">t</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="var">length</span> <span class="id" type="var">l</span> &lt;= <span class="id" type="var">length</span> (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">map</span> (<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">l</span>)).<br/>

<br/>
<span class="id" type="keyword">Parameter</span> <span class="id" type="var">ac_cf_eq</span> :  <span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">ac</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; <span class="id" type="var">canonical_form</span> <span class="id" type="var">t1</span> = <span class="id" type="var">canonical_form</span> <span class="id" type="var">t2</span>.<br/>
<span class="id" type="keyword">Parameter</span> <span class="id" type="var">ac_size_eq</span> :  <span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">ac</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; <span class="id" type="var">size</span> <span class="id" type="var">t1</span> = <span class="id" type="var">size</span> <span class="id" type="var">t2</span>.<br/>

<br/>
<span class="id" type="keyword">Parameter</span> <span class="id" type="var">ac_size_unfold</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <br/>
&nbsp;&nbsp;<span class="id" type="var">ac_size</span> <span class="id" type="var">t</span> = <span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; 1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">match</span> <span class="id" type="var">arity</span> <span class="id" type="var">f</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">AC</span> =&gt; (<span class="id" type="var">length</span> <span class="id" type="var">l</span>) - 1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">C</span> =&gt; 1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Free</span> <span class="id" type="var">_</span> =&gt; 1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>) + <span class="id" type="var">list_size</span> <span class="id" type="var">ac_size</span> <span class="id" type="var">l</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
&nbsp;<span class="id" type="keyword">Parameter</span> <span class="id" type="var">size_size_aux3</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">t</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt; <span class="id" type="var">well_formed</span> <span class="id" type="var">t</span> -&gt;<br/>
&nbsp;1 &lt;= <span class="id" type="var">length</span> (<span class="id" type="var">A</span>:=term) (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">canonical_form</span> <span class="id" type="var">t</span> :: <span class="id" type="var">nil</span>)).<br/>

<br/>
<span class="id" type="keyword">Parameter</span> <span class="id" type="var">size_size</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">well_formed</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">size</span> <span class="id" type="var">t</span> = <span class="id" type="var">ac_size</span> (<span class="id" type="var">canonical_form</span> <span class="id" type="var">t</span>).<br/>

<br/>
<span class="id" type="keyword">Parameter</span> <span class="id" type="var">ac_size_ge_one</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">well_formed_cf</span> <span class="id" type="var">t</span> -&gt; 1 &lt;= <span class="id" type="var">ac_size</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="keyword">End</span> <span class="id" type="var">S</span>.<br/>

<br/>
<span class="id" type="keyword">Module</span> <span class="id" type="var">Make'</span> (<span class="id" type="var">T1</span>: <span class="id" type="var">Term</span>) <br/>
(<span class="id" type="var">OF1</span> : <span class="id" type="var">ordered_set.S</span> <span class="id" type="keyword">with</span> <span class="id" type="keyword">Definition</span> <span class="id" type="var">A</span> := <span class="id" type="var">T1.symbol</span>) <br/>
(<span class="id" type="var">OX1</span> : <span class="id" type="var">ordered_set.S</span> <span class="id" type="keyword">with</span> <span class="id" type="keyword">Definition</span> <span class="id" type="var">A</span> := <span class="id" type="var">T1.variable</span>) &lt;: <br/>
<span class="id" type="var">S</span> <span class="id" type="keyword">with</span> <span class="id" type="keyword">Module</span> <span class="id" type="var">EqTh.T</span> := <span class="id" type="var">T1</span>.<br/>

<br/>
<span class="id" type="keyword">Module</span> <span class="id" type="var">T</span> := <span class="id" type="var">T1</span>.<br/>
<span class="id" type="keyword">Module</span> <span class="id" type="var">EqTh</span> := <span class="id" type="var">equational_theory.Make</span> (<span class="id" type="var">T</span>).<br/>
<span class="id" type="keyword">Import</span> <span class="id" type="var">EqTh</span>.<br/>
<span class="id" type="keyword">Import</span> <span class="id" type="var">T1</span>.<br/>
<span class="id" type="keyword">Import</span> <span class="id" type="var">T1.F</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab112"></a><h2 class="section">Definition of AC.</h2>

</div>
<div class="code">
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">ac_one_step_at_top</span> : <span class="id" type="var">term</span> -&gt; <span class="id" type="var">term</span> -&gt; <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">a_axiom</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> (<span class="id" type="var">f</span>:symbol) (<span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">t3</span>:term),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ac_one_step_at_top</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">Term</span> <span class="id" type="var">f</span> ((<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t1</span> :: <span class="id" type="var">t2</span> :: <span class="id" type="var">nil</span>)) :: <span class="id" type="var">t3</span> :: <span class="id" type="var">nil</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t1</span> :: ((<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t2</span> :: <span class="id" type="var">t3</span> :: <span class="id" type="var">nil</span>)) :: <span class="id" type="var">nil</span>)))<br/>
&nbsp;&nbsp;| <span class="id" type="var">c_axiom</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> (<span class="id" type="var">f</span>:symbol) (<span class="id" type="var">t1</span> <span class="id" type="var">t2</span>:term),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">C</span> \/ <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ac_one_step_at_top</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t1</span> :: <span class="id" type="var">t2</span> :: <span class="id" type="var">nil</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t2</span> :: <span class="id" type="var">t1</span> :: <span class="id" type="var">nil</span>)).<br/>

<br/>
<span class="id" type="keyword">Hint</span> <span class="id" type="var">Constructors</span> <span class="id" type="var">ac_one_step_at_top</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">ac</span> := <span class="id" type="var">th_eq</span> <span class="id" type="var">ac_one_step_at_top</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">no_need_of_instance</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">axiom</span> (<span class="id" type="var">sym_refl</span> <span class="id" type="var">ac_one_step_at_top</span>) <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">sym_refl</span> <span class="id" type="var">ac_one_step_at_top</span>) <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">sym_refl</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">inversion_clear</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">u1</span> <span class="id" type="var">u2</span> <span class="id" type="var">sigma</span> <span class="id" type="var">H'</span>]; <span class="id" type="tactic">destruct</span> <span class="id" type="var">H'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">H'</span> | [<span class="id" type="var">H'</span> | <span class="id" type="var">H'</span>]].<br/>
<span class="id" type="tactic">inversion_clear</span> <span class="id" type="var">H'</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">a_axiom</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">c_axiom</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">inversion_clear</span> <span class="id" type="var">H'</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">a_axiom</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">c_axiom</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">l_assoc</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">t3</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="var">ac</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t1</span> :: <span class="id" type="var">t2</span> :: <span class="id" type="var">nil</span>) :: <span class="id" type="var">t3</span> :: <span class="id" type="var">nil</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t1</span> :: (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t2</span> :: <span class="id" type="var">t3</span> :: <span class="id" type="var">nil</span>)) :: <span class="id" type="var">nil</span>)).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">t3</span> <span class="id" type="var">Af</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">ac</span>, <span class="id" type="var">th_eq</span>.<br/>
<span class="id" type="tactic">do</span> 2 <span class="id" type="var">left</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- (<span class="id" type="var">empty_subst_is_id</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t1</span> :: <span class="id" type="var">t2</span> :: <span class="id" type="var">nil</span>) :: <span class="id" type="var">t3</span> :: <span class="id" type="var">nil</span>))).<br/>
<span class="id" type="tactic">rewrite</span> &lt;- (<span class="id" type="var">empty_subst_is_id</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t1</span> :: <span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t2</span> :: <span class="id" type="var">t3</span> :: <span class="id" type="var">nil</span>) :: <span class="id" type="var">nil</span>))).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">a_axiom</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">r_assoc</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">t3</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="var">ac</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t1</span> :: (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t2</span> :: <span class="id" type="var">t3</span> :: <span class="id" type="var">nil</span>)) :: <span class="id" type="var">nil</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t1</span> :: <span class="id" type="var">t2</span> :: <span class="id" type="var">nil</span>) :: <span class="id" type="var">t3</span> :: <span class="id" type="var">nil</span>)).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">t3</span> <span class="id" type="var">Af</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">ac</span>, <span class="id" type="var">th_eq</span>.<br/>
<span class="id" type="tactic">do</span> 2 <span class="id" type="var">left</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- (<span class="id" type="var">empty_subst_is_id</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t1</span> :: <span class="id" type="var">t2</span> :: <span class="id" type="var">nil</span>) :: <span class="id" type="var">t3</span> :: <span class="id" type="var">nil</span>))).<br/>
<span class="id" type="tactic">rewrite</span> &lt;- (<span class="id" type="var">empty_subst_is_id</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t1</span> :: <span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t2</span> :: <span class="id" type="var">t3</span> :: <span class="id" type="var">nil</span>) :: <span class="id" type="var">nil</span>))).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">a_axiom</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">comm</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">C</span> \/ <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="var">ac</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t1</span> :: <span class="id" type="var">t2</span> :: <span class="id" type="var">nil</span>)) (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t2</span> :: <span class="id" type="var">t1</span> :: <span class="id" type="var">nil</span>)).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Af</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">ac</span>, <span class="id" type="var">th_eq</span>.<br/>
<span class="id" type="tactic">do</span> 2 <span class="id" type="var">left</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- (<span class="id" type="var">empty_subst_is_id</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t1</span> :: <span class="id" type="var">t2</span> :: <span class="id" type="var">nil</span>))).<br/>
<span class="id" type="tactic">rewrite</span> &lt;- (<span class="id" type="var">empty_subst_is_id</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t2</span> :: <span class="id" type="var">t1</span> :: <span class="id" type="var">nil</span>))).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">c_axiom</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">ac_one_step_at_top_top_eq</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, (<span class="id" type="var">sym_refl</span> <span class="id" type="var">ac_one_step_at_top</span>) <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">t1</span>, <span class="id" type="var">t2</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">x1</span>, <span class="id" type="var">Var</span> <span class="id" type="var">x2</span> =&gt; <span class="id" type="var">x1</span> = <span class="id" type="var">x2</span><br/>
&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>, <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">False</span><br/>
&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span>, <span class="id" type="var">Term</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">False</span><br/>
&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f1</span> <span class="id" type="var">_</span>, <span class="id" type="var">Term</span> <span class="id" type="var">f2</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">f1</span> = <span class="id" type="var">f2</span><br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">sym_refl</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> [<span class="id" type="var">Ac</span> | [<span class="id" type="var">Ac</span> | <span class="id" type="var">t1_eq_t2</span>]].<br/>
<span class="id" type="tactic">inversion_clear</span> <span class="id" type="var">Ac</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">inversion_clear</span> <span class="id" type="var">Ac</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">t2</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">t1</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">ac_one_step_top_eq</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> : <span class="id" type="var">term</span>, <span class="id" type="var">one_step</span> (<span class="id" type="var">sym_refl</span> <span class="id" type="var">ac_one_step_at_top</span>) <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt;    <br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">t1</span>, <span class="id" type="var">t2</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">x1</span>, <span class="id" type="var">Var</span> <span class="id" type="var">x2</span> =&gt; <span class="id" type="var">x1</span> = <span class="id" type="var">x2</span><br/>
&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>, <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">False</span><br/>
&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span>, <span class="id" type="var">Term</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">False</span><br/>
&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f1</span> <span class="id" type="var">_</span>, <span class="id" type="var">Term</span> <span class="id" type="var">f2</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">f1</span> = <span class="id" type="var">f2</span><br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Ac</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">Ac</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">ac_one_step_at_top_top_eq</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">no_need_of_instance</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">ac_top_eq</span> : <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> : <span class="id" type="var">term</span>, <span class="id" type="var">ac</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">t1</span>, <span class="id" type="var">t2</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">x1</span>, <span class="id" type="var">Var</span> <span class="id" type="var">x2</span> =&gt; <span class="id" type="var">x1</span> = <span class="id" type="var">x2</span><br/>
&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>, <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">False</span><br/>
&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span>, <span class="id" type="var">Term</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">False</span><br/>
&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f1</span> <span class="id" type="var">_</span>, <span class="id" type="var">Term</span> <span class="id" type="var">f2</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">f1</span> = <span class="id" type="var">f2</span><br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Ac</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">Ac</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">H'</span> <span class="id" type="var">H4</span> <span class="id" type="var">H5</span> | <span class="id" type="var">f</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">H'</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span>]; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">ac_one_step_top_eq</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">ac_one_step_top_eq</span> <span class="id" type="var">H</span>).<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">x</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">v1</span> | <span class="id" type="var">f1</span> <span class="id" type="var">l1</span> ]; <br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">y</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">v2</span> | <span class="id" type="var">f2</span> <span class="id" type="var">l2</span> ]; <br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">z</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">v3</span> | <span class="id" type="var">f3</span> <span class="id" type="var">l3</span> ]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intro</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">trans_eq</span> <span class="id" type="keyword">with</span> <span class="id" type="var">v2</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">intro</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">trans_eq</span> <span class="id" type="keyword">with</span> <span class="id" type="var">f2</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Module</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">TO</span> := <span class="id" type="var">term_o.Make</span> (<span class="id" type="var">T1</span>) (<span class="id" type="var">OF1</span>) (<span class="id" type="var">OX1</span>).<br/>

<br/>
<span class="id" type="keyword">Module</span> <span class="id" type="keyword">Import</span> <span class="id" type="keyword">Sort</span> :=  <span class="id" type="var">list_sort.Make</span> (<span class="id" type="var">TO</span>).<br/>
<span class="id" type="keyword">Import</span> <span class="id" type="var">LPermut</span>.<br/>

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">flatten</span> (<span class="id" type="var">f</span> : <span class="id" type="var">symbol</span>) (<span class="id" type="var">l</span> : <span class="id" type="var">list</span> <span class="id" type="var">term</span>) : <span class="id" type="var">list</span> <span class="id" type="var">term</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">nil</span><br/>
&nbsp;&nbsp;| (<span class="id" type="var">Var</span> <span class="id" type="var">_</span> <span class="id" type="keyword">as</span> <span class="id" type="var">t</span>) :: <span class="id" type="var">tl</span> =&gt; <span class="id" type="var">t</span> :: (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> <span class="id" type="var">tl</span>)<br/>
&nbsp;&nbsp;| (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">ll</span> <span class="id" type="keyword">as</span> <span class="id" type="var">t</span>) :: <span class="id" type="var">tl</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">if</span> <span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">then</span> <span class="id" type="var">ll</span> ++ (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> <span class="id" type="var">tl</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">else</span> <span class="id" type="var">t</span> :: (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> <span class="id" type="var">tl</span>)<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">canonical_form</span> (<span class="id" type="var">t</span> : <span class="id" type="var">term</span>) : <span class="id" type="var">term</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">t</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Term</span> <span class="id" type="var">f</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">match</span> <span class="id" type="var">arity</span> <span class="id" type="var">f</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Free</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">map</span> <span class="id" type="var">canonical_form</span> <span class="id" type="var">l</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">C</span> =&gt; <span class="id" type="var">quicksort</span> (<span class="id" type="var">map</span> <span class="id" type="var">canonical_form</span> <span class="id" type="var">l</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">AC</span> =&gt; <span class="id" type="var">quicksort</span> (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">map</span> <span class="id" type="var">canonical_form</span> <span class="id" type="var">l</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>)<br/>
<span class="id" type="keyword">end</span>.<br/>

<br/>

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">well_formed_cf</span> (<span class="id" type="var">t</span>:term) : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">True</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">wf_cf_list</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">fix</span> <span class="id" type="var">wf_cf_list</span> (<span class="id" type="var">l</span>:list <span class="id" type="var">term</span>) : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">True</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">h</span> :: <span class="id" type="var">tl</span> =&gt; <span class="id" type="var">well_formed_cf</span> <span class="id" type="var">h</span> /\ <span class="id" type="var">wf_cf_list</span> <span class="id" type="var">tl</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>) <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">wf_cf_list</span> <span class="id" type="var">l</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">match</span> <span class="id" type="var">arity</span> <span class="id" type="var">f</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Free</span> <span class="id" type="var">n</span> =&gt; <span class="id" type="var">length</span> <span class="id" type="var">l</span> = <span class="id" type="var">n</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">C</span> =&gt; <span class="id" type="var">length</span> <span class="id" type="var">l</span> = 2 /\ <span class="id" type="var">is_sorted</span> <span class="id" type="var">l</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">AC</span> =&gt; <span class="id" type="var">length</span> <span class="id" type="var">l</span> &gt;= 2 /\ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">is_sorted</span> <span class="id" type="var">l</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span>, <span class="id" type="var">In</span> <span class="id" type="var">s</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="keyword">match</span> <span class="id" type="var">s</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">True</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">f</span>&lt;&gt;g<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">well_formed_cf_unfold</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>,<br/>
&nbsp;<span class="id" type="var">well_formed_cf</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">True</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">u</span>, <span class="id" type="var">In</span> <span class="id" type="var">u</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="var">well_formed_cf</span> <span class="id" type="var">u</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">match</span> <span class="id" type="var">arity</span> <span class="id" type="var">f</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">AC</span> =&gt; <span class="id" type="var">length</span> <span class="id" type="var">l</span> &gt;= 2 /\ <span class="id" type="var">is_sorted</span> <span class="id" type="var">l</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">u</span>, <span class="id" type="var">In</span> <span class="id" type="var">u</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="keyword">match</span> <span class="id" type="var">u</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">True</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">f</span> &lt;&gt; <span class="id" type="var">g</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">C</span> =&gt; <span class="id" type="var">length</span> <span class="id" type="var">l</span> = 2 /\ <span class="id" type="var">is_sorted</span> <span class="id" type="var">l</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Free</span> <span class="id" type="var">n</span> =&gt; <span class="id" type="var">length</span> <span class="id" type="var">l</span> = <span class="id" type="var">n</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v</span> | <span class="id" type="var">f</span> <span class="id" type="var">l</span>]; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">intros</span> [<span class="id" type="var">Wl</span> <span class="id" type="var">Ll</span>]; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">Ll</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> [<span class="id" type="var">u_eq_t</span> | <span class="id" type="var">In_u</span>]; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">intuition</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">well_formed_cf_subterms</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>, <span class="id" type="var">well_formed_cf</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) -&gt; (<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="var">well_formed_cf</span> <span class="id" type="var">t</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">W</span>; <span class="id" type="tactic">elim</span> (<span class="id" type="var">well_formed_cf_unfold</span> <span class="id" type="var">_</span> <span class="id" type="var">W</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">well_formed_cf_length</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt; <span class="id" type="var">well_formed_cf</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) -&gt; 2 &lt;= <span class="id" type="var">length</span> <span class="id" type="var">l</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">Af</span> [<span class="id" type="var">_</span> <span class="id" type="var">Ll</span>]; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Af</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Ll</span>; <span class="id" type="tactic">intuition</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">well_formed_cf_sorted</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt; <span class="id" type="var">well_formed_cf</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) -&gt; <span class="id" type="var">is_sorted</span> <span class="id" type="var">l</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">Af</span> [<span class="id" type="var">_</span> <span class="id" type="var">Ll</span>]; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Af</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Ll</span>; <span class="id" type="tactic">intuition</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">well_formed_cf_alien</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt; <span class="id" type="var">well_formed_cf</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) -&gt;<br/>
&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">True</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">f</span> &lt;&gt; <span class="id" type="var">g</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">Af</span> [<span class="id" type="var">_</span> <span class="id" type="var">Ll</span>]; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Af</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Ll</span>; <span class="id" type="tactic">intuition</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">well_formed_cf_fold</span> : <br/>
<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, (<span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">True</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">u</span>, <span class="id" type="var">In</span> <span class="id" type="var">u</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="var">well_formed_cf</span> <span class="id" type="var">u</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">match</span> <span class="id" type="var">arity</span> <span class="id" type="var">f</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">AC</span> =&gt; <span class="id" type="var">length</span> <span class="id" type="var">l</span> &gt;= 2 /\ <span class="id" type="var">is_sorted</span> <span class="id" type="var">l</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">u</span>, <span class="id" type="var">In</span> <span class="id" type="var">u</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="keyword">match</span> <span class="id" type="var">u</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">True</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">f</span> &lt;&gt; <span class="id" type="var">g</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">C</span> =&gt; <span class="id" type="var">length</span> <span class="id" type="var">l</span> = 2 /\ <span class="id" type="var">is_sorted</span> <span class="id" type="var">l</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Free</span> <span class="id" type="var">n</span> =&gt; <span class="id" type="var">length</span> <span class="id" type="var">l</span> = <span class="id" type="var">n</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>) -&gt; <span class="id" type="var">well_formed_cf</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v</span> | <span class="id" type="var">f</span> <span class="id" type="var">l</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> [<span class="id" type="var">Wl</span> <span class="id" type="var">Hl</span>]; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">Hl</span>; <br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span>]; <span class="id" type="tactic">intuition</span>; <br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Wl</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">flatten_app</span> : <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>, <span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">l1</span> ++ <span class="id" type="var">l2</span>) = (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span>) ++ (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> <span class="id" type="var">l2</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">l1</span> <span class="id" type="keyword">as</span> [ | [<span class="id" type="var">v1</span> | <span class="id" type="var">g1</span> <span class="id" type="var">ll1</span>]]; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">l2</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHl1</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">l2</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHl1</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">g1</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">g1</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">f_eq_g1</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">f_diff_g1</span>].<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">app_ass</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">list_permut_flatten</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>, <span class="id" type="var">permut</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> -&gt; <span class="id" type="var">permut</span> (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span>) (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> <span class="id" type="var">l2</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">l1</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t1</span> <span class="id" type="var">l1</span>]; <span class="id" type="tactic">intros</span> <span class="id" type="var">l2</span> <span class="id" type="var">P</span>.<br/>
<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">permut_nil</span> (<span class="id" type="var">permut_sym</span> <span class="id" type="var">P</span>)); <span class="id" type="tactic">apply</span> <span class="id" type="var">permut_refl</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">In_t1</span> : <span class="id" type="var">mem</span> (@<span class="id" type="var">eq</span> <span class="id" type="var">_</span>) <span class="id" type="var">t1</span> <span class="id" type="var">l2</span>). <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">P</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">mem_split_set</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">eq_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">In_t1</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">t1'</span> [<span class="id" type="var">l2'</span> [<span class="id" type="var">l2''</span> [<span class="id" type="var">t1_eq_t1'</span> [<span class="id" type="var">H</span> <span class="id" type="var">_</span>]]]]]; <br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">t1_eq_t1'</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">l2</span>;<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">P'</span> : <span class="id" type="var">permut</span> (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span>) (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">l2'</span> ++ <span class="id" type="var">l2''</span>))).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHl1</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">permut_cons_inside</span> <span class="id" type="keyword">in</span> <span class="id" type="var">P</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">dummy</span> <span class="id" type="var">t1</span> <span class="id" type="var">t1'</span> <span class="id" type="var">t1_eq_t1'</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">t1'</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">flatten_app</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">t1</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v1</span> | <span class="id" type="var">f1</span> <span class="id" type="var">ll1</span>].<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">permut_cons_inside</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">flatten_app</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">f1</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">f1</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">f_eq_f1</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">f1</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>].<br/>
<span class="id" type="tactic">transitivity</span> (<span class="id" type="var">ll1</span> ++ <span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">l2'</span> ++ <span class="id" type="var">l2''</span>)).<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">permut_app1</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">flatten_app</span>; <span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">app_ass</span>; <br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">permut_app2</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">list_permut_app_app</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">permut_cons_inside</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">flatten_app</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">well_formed_cf_is_well_formed_cf</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">cf</span>, <span class="id" type="var">well_formed_cf</span> <span class="id" type="var">cf</span> -&gt; <span class="id" type="var">exists</span> <span class="id" type="var">t</span>, <span class="id" type="var">well_formed</span> <span class="id" type="var">t</span> /\ <span class="id" type="var">cf</span> = <span class="id" type="var">canonical_form</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">cf</span> <span class="id" type="var">Wcf</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">well_formed_cf_unfold</span> <span class="id" type="var">_</span> <span class="id" type="var">Wcf</span>);<br/>
<span class="id" type="tactic">pattern</span> <span class="id" type="var">cf</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">cf</span> <span class="id" type="var">Wcf</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">_</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>); <span class="id" type="tactic">unfold</span> <span class="id" type="var">well_formed</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">Hrec</span> [<span class="id" type="var">Wl</span> <span class="id" type="var">Ll</span>]; <br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Wl'</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">u</span>, <span class="id" type="var">In</span> <span class="id" type="var">u</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="var">exists</span> <span class="id" type="var">s</span>, <span class="id" type="var">well_formed</span> <span class="id" type="var">s</span> /\ <span class="id" type="var">u</span> = <span class="id" type="var">canonical_form</span> <span class="id" type="var">s</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Hrec</span>; <span class="id" type="tactic">trivial</span>; <br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_cf_unfold</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Wl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">destruct_arity</span> <span class="id" type="var">f</span> <span class="id" type="var">n</span> <span class="id" type="var">Af</span>.<br/>
<span class="id" type="var">revert</span> <span class="id" type="var">Ll</span>; <span class="id" type="tactic">intros</span> [<span class="id" type="var">Ll</span> [<span class="id" type="var">Sl</span> <span class="id" type="var">Al</span>]]; <span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t1</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="var">absurd</span> (0 &gt;= 2); <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">ge</span>; <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t2</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="var">absurd</span> (1 &gt;= 2); <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">ge</span>; <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="tactic">elim</span> (<span class="id" type="var">Wl'</span> <span class="id" type="var">t1</span>). <span class="id" type="tactic">intros</span> <span class="id" type="var">u1</span> [<span class="id" type="var">Wu1</span> <span class="id" type="var">Hu1</span>] .<br/>
<span class="id" type="tactic">elim</span> (<span class="id" type="var">Wl'</span> <span class="id" type="var">t2</span>). <span class="id" type="tactic">intros</span> <span class="id" type="var">u2</span> [<span class="id" type="var">Wu2</span> <span class="id" type="var">Hu2</span>] .<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">At1</span> : <span class="id" type="keyword">match</span> <span class="id" type="var">t1</span> <span class="id" type="keyword">with</span> <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">True</span> | <span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">f</span> &lt;&gt; <span class="id" type="var">g</span> <span class="id" type="keyword">end</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Al</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">At2</span> : <span class="id" type="keyword">match</span> <span class="id" type="var">t2</span> <span class="id" type="keyword">with</span> <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">True</span> | <span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">f</span> &lt;&gt; <span class="id" type="var">g</span> <span class="id" type="keyword">end</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Al</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t3</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="var">exists</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">u2</span> :: <span class="id" type="var">u1</span> :: <span class="id" type="var">nil</span>)); <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_fold</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Af</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">try</span> <span class="id" type="tactic">subst</span> <span class="id" type="var">u</span>; <span class="id" type="tactic">trivial</span>;<br/>
<span class="id" type="tactic">elim</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">try</span> <span class="id" type="tactic">subst</span> <span class="id" type="var">u</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Af</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">Hu1</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">Hu2</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t1</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v1</span> | <span class="id" type="var">g1</span> <span class="id" type="var">ll1</span>]; <span class="id" type="tactic">destruct</span> <span class="id" type="var">t2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v2</span> | <span class="id" type="var">g2</span> <span class="id" type="var">ll2</span>].<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)); <span class="id" type="tactic">apply</span> <span class="id" type="var">sort_is_unique</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">quick_sorted</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">permut_sym</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">quick_permut_bis</span>; <br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">list_permut_app_app</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v2</span> :: <span class="id" type="var">nil</span>) (<span class="id" type="var">Var</span> <span class="id" type="var">v1</span> :: <span class="id" type="var">nil</span>)).<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">g2</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">g2</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">f_eq_g2</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">f_diff_g2</span>].<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">f</span>=g2); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)); <span class="id" type="tactic">apply</span> <span class="id" type="var">sort_is_unique</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">quick_sorted</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">permut_sym</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">quick_permut_bis</span>; <br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">list_permut_app_app</span> (<span class="id" type="var">Term</span> <span class="id" type="var">g2</span> <span class="id" type="var">ll2</span> :: <span class="id" type="var">nil</span>) (<span class="id" type="var">Var</span> <span class="id" type="var">v1</span> :: <span class="id" type="var">nil</span>)).<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">g1</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">g1</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">f_eq_g1</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">f_diff_g1</span>].<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">f</span>=g1); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)); <span class="id" type="tactic">apply</span> <span class="id" type="var">sort_is_unique</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">permut_sym</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">quick_permut_bis</span>; <br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">list_permut_app_app</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v2</span> :: <span class="id" type="var">nil</span>) (<span class="id" type="var">Term</span> <span class="id" type="var">g1</span> <span class="id" type="var">ll1</span> :: <span class="id" type="var">nil</span>)).<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">g2</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">g2</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">f_eq_g2</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">f_diff_g2</span>].<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">f</span>=g2); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">g1</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">g1</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">f_eq_g1</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">f_diff_g1</span>].<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">f</span>=g1); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)); <span class="id" type="tactic">apply</span> <span class="id" type="var">sort_is_unique</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">quick_sorted</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">permut_sym</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">quick_permut_bis</span>; <br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">list_permut_app_app</span> (<span class="id" type="var">Term</span> <span class="id" type="var">g2</span> <span class="id" type="var">ll2</span> :: <span class="id" type="var">nil</span>) (<span class="id" type="var">Term</span> <span class="id" type="var">g1</span> <span class="id" type="var">ll1</span> :: <span class="id" type="var">nil</span>)).<br/>
<span class="id" type="tactic">elim</span> <span class="id" type="var">IHl</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s2</span> [<span class="id" type="var">Ws2</span> <span class="id" type="var">Hs2</span>]; <span class="id" type="var">exists</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">s2</span> :: <span class="id" type="var">u1</span> :: <span class="id" type="var">nil</span>)); <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_fold</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Af</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">try</span> <span class="id" type="tactic">subst</span> <span class="id" type="var">u</span>; <span class="id" type="tactic">trivial</span>;<br/>
<span class="id" type="tactic">elim</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">try</span> <span class="id" type="tactic">subst</span> <span class="id" type="var">u</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Af</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">Hu1</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">Hs2</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">f</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">f</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">f_diff_f</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">f_diff_f</span>; <span class="id" type="tactic">reflexivity</span>].<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t1</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v1</span> | <span class="id" type="var">g1</span> <span class="id" type="var">ll1</span>].<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)); <span class="id" type="tactic">apply</span> <span class="id" type="var">sort_is_unique</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">quick_sorted</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">permut_sym</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">quick_permut_bis</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">permut_sym</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">permut_cons_inside</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">app_nil_end</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">permut_refl</span>.<br/>
<span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">g1</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">g1</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">f_eq_g1</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">f_diff_g1</span>].<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">f</span>=g1); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)); <span class="id" type="tactic">apply</span> <span class="id" type="var">sort_is_unique</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">quick_sorted</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">permut_sym</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">quick_permut_bis</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">permut_sym</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">permut_cons_inside</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">app_nil_end</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">permut_refl</span>.<br/>
<span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Hrec</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Wl</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Wl'</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">sorted_tl_sorted</span> <span class="id" type="keyword">with</span> <span class="id" type="var">t1</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Al</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">generalize</span> <span class="id" type="var">Ll</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">Ll</span>; <span class="id" type="tactic">intros</span> [<span class="id" type="var">Ll</span> <span class="id" type="var">Sl</span>]; <span class="id" type="tactic">destruct</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t1</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="var">absurd</span> (0 = 2); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t2</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="var">absurd</span> (1 = 2); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t3</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="tactic">elim</span> (<span class="id" type="var">Wl'</span> <span class="id" type="var">t1</span>). <span class="id" type="tactic">intros</span> <span class="id" type="var">u1</span> [<span class="id" type="var">Wu1</span> <span class="id" type="var">Hu1</span>] .<br/>
<span class="id" type="tactic">elim</span> (<span class="id" type="var">Wl'</span> <span class="id" type="var">t2</span>). <span class="id" type="tactic">intros</span> <span class="id" type="var">u2</span> [<span class="id" type="var">Wu2</span> <span class="id" type="var">Hu2</span>] .<br/>
<span class="id" type="var">exists</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">u1</span> :: <span class="id" type="var">u2</span> :: <span class="id" type="var">nil</span>)); <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_fold</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Af</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">try</span> <span class="id" type="tactic">subst</span> <span class="id" type="var">u</span>; <span class="id" type="tactic">trivial</span>;<br/>
<span class="id" type="tactic">elim</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">try</span> <span class="id" type="tactic">subst</span> <span class="id" type="var">u</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Af</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>));<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">sort_is_unique</span>; <span class="id" type="tactic">trivial</span>;<br/>
[ <span class="id" type="tactic">apply</span> <span class="id" type="var">quick_sorted</span> | <span class="id" type="tactic">apply</span> <span class="id" type="var">quick_permut</span> ].<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">S</span>(<span class="id" type="var">S</span>(<span class="id" type="var">S</span>(<span class="id" type="var">length</span> <span class="id" type="var">l</span>))) = 2); <span class="id" type="tactic">auto</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H</span> : <span class="id" type="var">exists</span> <span class="id" type="var">l'</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span>, <span class="id" type="var">In</span> <span class="id" type="var">s</span> <span class="id" type="var">l'</span> -&gt; <span class="id" type="var">well_formed</span> <span class="id" type="var">s</span>) /\ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">map</span> <span class="id" type="var">canonical_form</span> <span class="id" type="var">l'</span> = <span class="id" type="var">l</span>).<br/>
<span class="id" type="tactic">generalize</span> <span class="id" type="var">l</span> <span class="id" type="var">Wl'</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">l</span> <span class="id" type="var">Hrec</span> <span class="id" type="var">Wl</span> <span class="id" type="var">Wl'</span> <span class="id" type="var">Ll</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">nil</span> (<span class="id" type="var">A</span> := <span class="id" type="var">term</span>)); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">Wl</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">IHl</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">l'</span> [<span class="id" type="var">Wl'</span> <span class="id" type="var">Hl'</span>]; <span class="id" type="tactic">elim</span> (<span class="id" type="var">Wl</span> <span class="id" type="var">t</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t'</span> [<span class="id" type="var">Wt'</span> <span class="id" type="var">Ht'</span>]; <span class="id" type="var">exists</span> (<span class="id" type="var">t'</span> :: <span class="id" type="var">l'</span>); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> [ <span class="id" type="var">s_eq_t'</span> | <span class="id" type="var">In_s</span>]; <span class="id" type="tactic">try</span> <span class="id" type="tactic">subst</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Wl'</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Wl</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">elim</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">l'</span> [<span class="id" type="var">Wl''</span> <span class="id" type="var">Hl'</span>]; <span class="id" type="var">exists</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l'</span>); <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_fold</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Af</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">length_map</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Af</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">length_flatten_bis</span> :<br/>
<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">l</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="var">well_formed_cf</span> <span class="id" type="var">t</span>) -&gt;<br/>
&nbsp;(<span class="id" type="var">length</span> <span class="id" type="var">l</span>) &lt;= <span class="id" type="var">length</span> (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">Af</span> <span class="id" type="var">l</span> <span class="id" type="var">Wl</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v</span> | <span class="id" type="var">g</span> <span class="id" type="var">ll</span>].<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">le_n_S</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Wl</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">f_eq_g</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">f_diff_g</span>].<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">length_app</span>; <span class="id" type="tactic">replace</span> (<span class="id" type="var">S</span> (<span class="id" type="var">length</span> <span class="id" type="var">l</span>)) <span class="id" type="keyword">with</span> (1 + <span class="id" type="var">length</span> <span class="id" type="var">l</span>); <span class="id" type="tactic">trivial</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">plus_le_compat</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Wt</span> : <span class="id" type="var">well_formed_cf</span> (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">ll</span>)). <span class="id" type="tactic">apply</span> <span class="id" type="var">Wl</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">well_formed_cf</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Wt</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">g</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Af</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Wt</span>;<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">Wt</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">_</span> [<span class="id" type="var">Lll</span> <span class="id" type="var">_</span>]]; <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Wl</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">le_n_S</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Wl</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">length_flatten</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span>, <span class="id" type="keyword">forall</span> <span class="id" type="var">l</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt; (<span class="id" type="keyword">forall</span> <span class="id" type="var">u</span>, <span class="id" type="var">In</span> <span class="id" type="var">u</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="var">well_formed</span> <span class="id" type="var">u</span>) -&gt; <br/>
&nbsp;&nbsp;<span class="id" type="var">length</span> <span class="id" type="var">l</span> &lt;= <span class="id" type="var">length</span> (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">map</span> <span class="id" type="var">canonical_form</span> <span class="id" type="var">l</span>)).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">list_rec3</span> <span class="id" type="var">size</span>); <span class="id" type="tactic">clear</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">n</span>;<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">S_l</span>; <span class="id" type="var">absurd</span> (1 &lt;= 0); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">le_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">size</span> <span class="id" type="var">t</span> + <span class="id" type="var">list_size</span> <span class="id" type="var">size</span> <span class="id" type="var">l</span>); <span class="id" type="tactic">trivial</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">le_plus_trans</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">size_ge_one</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">Sl</span> <span class="id" type="var">Af</span> <span class="id" type="var">Wl</span>;<br/>
<span class="id" type="tactic">replace</span> (<span class="id" type="var">t</span> :: <span class="id" type="var">l</span>) <span class="id" type="keyword">with</span> ((<span class="id" type="var">t</span> :: <span class="id" type="var">nil</span>) ++ <span class="id" type="var">l</span>); <span class="id" type="tactic">trivial</span>;<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">map_app</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">flatten_app</span>; <span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> <span class="id" type="var">length_app</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">plus_le_compat</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Wt</span> : <span class="id" type="var">well_formed</span> <span class="id" type="var">t</span>). <span class="id" type="tactic">apply</span> <span class="id" type="var">Wl</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v</span> | <span class="id" type="var">g</span> <span class="id" type="var">ll</span>]; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">f_eq_g</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">f_diff_g</span>].<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">g</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">app_nil_end</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Af</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">length_quicksort</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">le_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">length</span> <span class="id" type="var">ll</span>).<br/>
<span class="id" type="tactic">elim</span> (<span class="id" type="var">well_formed_unfold</span> <span class="id" type="var">Wt</span>); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Af</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> <span class="id" type="var">Lll</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Lll</span>; <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHn</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">le_S_n</span>; <br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">le_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">size</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">ll</span>) + <span class="id" type="var">list_size</span> <span class="id" type="var">size</span> <span class="id" type="var">l</span>); <span class="id" type="tactic">trivial</span>;<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">size_unfold</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">le_n_S</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">le_plus_l</span>.<br/>
<span class="id" type="tactic">elim</span> (<span class="id" type="var">well_formed_unfold</span> <span class="id" type="var">Wt</span>); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Af</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">le_n</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHn</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">plus_le_reg_l</span> <span class="id" type="keyword">with</span> 1; <br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">le_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">size</span> <span class="id" type="var">t</span> + <span class="id" type="var">list_size</span> <span class="id" type="var">size</span> <span class="id" type="var">l</span>); <span class="id" type="tactic">trivial</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">plus_le_compat_r</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">size_ge_one</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Wl</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">well_formed_cf_is_well_formed_cf_conv</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">cf</span>, (<span class="id" type="var">exists</span> <span class="id" type="var">t</span>, <span class="id" type="var">well_formed</span> <span class="id" type="var">t</span> /\ <span class="id" type="var">cf</span> = <span class="id" type="var">canonical_form</span> <span class="id" type="var">t</span>) -&gt; <span class="id" type="var">well_formed_cf</span> <span class="id" type="var">cf</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">cf</span> [<span class="id" type="var">t</span> [<span class="id" type="var">Wt</span> <span class="id" type="var">Ct</span>]]; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">generalize</span> <span class="id" type="var">Wt</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">Wt</span>.<br/>
<span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec2</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">n</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">n</span> ];<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">St</span> <span class="id" type="var">Wt</span>.<br/>
<span class="id" type="var">absurd</span> (1 &lt;= 0); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>; <br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">le_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">size</span> <span class="id" type="var">t</span>); <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">size_ge_one</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_cf_fold</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">v</span> | <span class="id" type="var">f</span> <span class="id" type="var">l</span> ]; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">well_formed_unfold</span> <span class="id" type="var">Wt</span>); <span class="id" type="tactic">intros</span> [<span class="id" type="var">Wl</span> <span class="id" type="var">L</span>].<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Wl'</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> (<span class="id" type="var">map</span> <span class="id" type="var">canonical_form</span> <span class="id" type="var">l</span>)  -&gt; <span class="id" type="var">well_formed_cf</span> <span class="id" type="var">t</span>).<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">Wt</span> <span class="id" type="var">L</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">size_unfold</span> <span class="id" type="keyword">in</span> <span class="id" type="var">St</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t1</span> <span class="id" type="var">l</span> ].<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">In_t</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">In_t</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">In_t</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">In_t</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHn</span>;<br/>
[ <span class="id" type="tactic">apply</span> <span class="id" type="var">le_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">list_size</span> <span class="id" type="var">size</span> (<span class="id" type="var">t1</span> :: <span class="id" type="var">l</span>)); <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span><br/>
| <span class="id" type="tactic">apply</span> <span class="id" type="var">Wl</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span> ].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">trivial</span>;<br/>
[ <span class="id" type="tactic">apply</span> <span class="id" type="var">le_trans</span> <span class="id" type="keyword">with</span> (1 + <span class="id" type="var">list_size</span> <span class="id" type="var">size</span> (<span class="id" type="var">t1</span> :: <span class="id" type="var">l</span>)); <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span><br/>
| <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Wl</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>].<br/>
<span class="id" type="var">destruct_arity</span> <span class="id" type="var">f</span> <span class="id" type="var">a</span> <span class="id" type="var">Af</span>.<br/>
<span class="id" type="tactic">split</span>; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">split</span>; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">split</span>]].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">in_quick_in</span> <span class="id" type="keyword">in</span> <span class="id" type="var">In_u</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">map</span> <span class="id" type="var">canonical_form</span> <span class="id" type="var">l</span>) <span class="id" type="var">Wl'</span> <span class="id" type="var">In_u</span>;<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">l</span> <span class="id" type="var">St</span> <span class="id" type="var">Wt</span> <span class="id" type="var">Wl</span> <span class="id" type="var">L</span> <span class="id" type="var">Wl'</span> <span class="id" type="var">In_u</span>;<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span> ]; <span class="id" type="tactic">intros</span> <span class="id" type="var">Wl</span> <span class="id" type="var">In_u</span>.<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H</span>:=flatten_app <span class="id" type="var">f</span> (<span class="id" type="var">t</span> :: <span class="id" type="var">nil</span>) <span class="id" type="var">l</span>); <span class="id" type="tactic">simpl</span> <span class="id" type="var">app</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span> <span class="id" type="keyword">in</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>;<br/>
<span class="id" type="tactic">elim</span> (<span class="id" type="var">in_app_or</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">In_u</span>); <span class="id" type="tactic">clear</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">In_u</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Wt</span> : <span class="id" type="var">well_formed_cf</span> <span class="id" type="var">t</span>). <span class="id" type="tactic">apply</span> <span class="id" type="var">Wl</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v</span> | <span class="id" type="var">g</span> <span class="id" type="var">h</span>].<br/>
<span class="id" type="tactic">elim</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="var">revert</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">f_eq_g</span> <span class="id" type="var">In_u</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">f_diff_g</span> <span class="id" type="var">In_u</span>].<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">app_nil_end</span> <span class="id" type="keyword">in</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">well_formed_cf_subterms</span> <span class="id" type="var">Wt</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">elim</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Wl</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">length_quicksort</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">L</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">ge</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">length_flatten</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">quick_sorted</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">in_quick_in</span> <span class="id" type="keyword">in</span> <span class="id" type="var">In_u</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">map</span> <span class="id" type="var">canonical_form</span> <span class="id" type="var">l</span>) <span class="id" type="var">In_u</span> <span class="id" type="var">Wl'</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">l</span> <span class="id" type="var">St</span> <span class="id" type="var">Wt</span> <span class="id" type="var">Wl</span> <span class="id" type="var">L</span> <span class="id" type="var">Wl'</span> <span class="id" type="var">In_u</span>; <br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">list_rec3</span> <span class="id" type="var">size</span>); <span class="id" type="tactic">clear</span> <span class="id" type="var">l</span>; <br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">n0</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">m</span>]; <span class="id" type="tactic">destruct</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span> ].<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="var">absurd</span> (1 &lt;= 0); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>; <br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">le_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">list_size</span> <span class="id" type="var">size</span> (<span class="id" type="var">t</span> :: <span class="id" type="var">l</span>)); <span class="id" type="tactic">trivial</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">le_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">size</span> <span class="id" type="var">t</span>); <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">size_ge_one</span>.<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H</span>:=flatten_app <span class="id" type="var">f</span> (<span class="id" type="var">t</span> :: <span class="id" type="var">nil</span>) <span class="id" type="var">l</span>); <span class="id" type="tactic">simpl</span> <span class="id" type="var">app</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">Sl</span> <span class="id" type="var">In_u</span> <span class="id" type="var">Wl</span>; <span class="id" type="tactic">elim</span> (<span class="id" type="var">in_app_or</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">In_u</span>); <span class="id" type="tactic">clear</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">In_u</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Wt</span> : <span class="id" type="var">well_formed_cf</span> <span class="id" type="var">t</span>). <span class="id" type="tactic">apply</span> <span class="id" type="var">Wl</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">v</span> | <span class="id" type="var">g</span> <span class="id" type="var">ll</span> ].<br/>
<span class="id" type="tactic">elim</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="var">revert</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">f_eq_g</span> <span class="id" type="var">In_u</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">f_diff_g</span> <span class="id" type="var">In_u</span>].<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">g</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">app_nil_end</span> <span class="id" type="keyword">in</span> <span class="id" type="var">In_u</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_cf_alien</span> <span class="id" type="keyword">with</span> <span class="id" type="var">ll</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">elim</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">IHm</span> <span class="id" type="var">l</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">le_S_n</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">le_trans</span> <span class="id" type="keyword">with</span> (1 + <span class="id" type="var">list_size</span> <span class="id" type="var">size</span> <span class="id" type="var">l</span>); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">le_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">size</span> <span class="id" type="var">t</span> + <span class="id" type="var">list_size</span> <span class="id" type="var">size</span> <span class="id" type="var">l</span>); <span class="id" type="tactic">trivial</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">plus_le_compat_r</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">size_ge_one</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Wl</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">split</span>; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">split</span>].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">in_quick_in</span> <span class="id" type="keyword">in</span> <span class="id" type="var">In_u</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Wl'</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">length_quicksort</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">length_map</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">quick_sorted</span>.<br/>
<span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">length_map</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">flatten_cf</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt; <span class="id" type="var">well_formed_cf</span> <span class="id" type="var">t1</span> -&gt; <span class="id" type="var">well_formed_cf</span> <span class="id" type="var">t2</span> -&gt;<br/>
&nbsp;<span class="id" type="var">permut</span> (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">t1</span> :: <span class="id" type="var">nil</span>)) (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">t2</span> :: <span class="id" type="var">nil</span>)) -&gt; <span class="id" type="var">t1</span> = <span class="id" type="var">t2</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Af</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">t1</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v1</span> | <span class="id" type="var">f1</span> <span class="id" type="var">l1</span>]; <span class="id" type="tactic">destruct</span> <span class="id" type="var">t2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v2</span> | <span class="id" type="var">f2</span> <span class="id" type="var">l2</span>].<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">permut_length_1</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">f2</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">f2</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">f_eq_f2</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">f2</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">f_diff_f2</span>].<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">app_nil_end</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">P</span>; <span class="id" type="var">absurd</span> (2 &lt;= 1); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">permut_length</span> <span class="id" type="var">P</span>); <span class="id" type="tactic">simpl</span>;<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">L</span>; <span class="id" type="tactic">pattern</span> 1 <span class="id" type="tactic">at</span> 2; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">L</span>; <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_cf_length</span> <span class="id" type="keyword">with</span> <span class="id" type="var">f</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">P</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">permut_length_1</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">f1</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">f1</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">f_eq_f1</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">f1</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">f_diff_f1</span>].<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">app_nil_end</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">P</span>; <span class="id" type="var">absurd</span> (2 &lt;= 1); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">permut_length</span> <span class="id" type="var">P</span>); <span class="id" type="tactic">simpl</span>;<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">L</span>; <span class="id" type="tactic">pattern</span> 1 <span class="id" type="tactic">at</span> 2; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">L</span>; <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_cf_length</span> <span class="id" type="keyword">with</span> <span class="id" type="var">f</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">P</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">permut_length_1</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">f1</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">f1</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">f_eq_f1</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">f1</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">f_diff_f1</span>];<br/>
(<span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">f2</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">f2</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">f_eq_f2</span> <span class="id" type="var">P</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">f2</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">f_diff_f2</span> <span class="id" type="var">P</span>]).<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>));<br/>
<span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">app_nil_end</span> <span class="id" type="keyword">in</span> <span class="id" type="var">P</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">sort_is_unique</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_cf_sorted</span> <span class="id" type="keyword">with</span> <span class="id" type="var">f</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">absurd</span> (2 &lt;= 1); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">app_nil_end</span> <span class="id" type="keyword">in</span> <span class="id" type="var">P</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">permut_length</span> <span class="id" type="var">P</span>); <span class="id" type="tactic">simpl</span>;<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">L</span>; <span class="id" type="tactic">pattern</span> 1 <span class="id" type="tactic">at</span> 2; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">L</span>; <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_cf_length</span> <span class="id" type="keyword">with</span> <span class="id" type="var">f</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">absurd</span> (2 &lt;= 1); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">app_nil_end</span> <span class="id" type="keyword">in</span> <span class="id" type="var">P</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">permut_length</span> <span class="id" type="var">P</span>); <span class="id" type="tactic">simpl</span>;<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">L</span>; <span class="id" type="tactic">pattern</span> 1 <span class="id" type="tactic">at</span> 2; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">L</span>; <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_cf_length</span> <span class="id" type="keyword">with</span> <span class="id" type="var">f</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">permut_length_1</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">flatten_cf_cf</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt; <span class="id" type="var">well_formed</span> <span class="id" type="var">t1</span> -&gt; <span class="id" type="var">well_formed</span> <span class="id" type="var">t2</span> -&gt;<br/>
&nbsp;<span class="id" type="var">permut</span> (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">canonical_form</span> <span class="id" type="var">t1</span> :: <span class="id" type="var">nil</span>))<br/>
&nbsp;(<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">canonical_form</span> <span class="id" type="var">t2</span> :: <span class="id" type="var">nil</span>)) -&gt;<br/>
&nbsp;<span class="id" type="var">canonical_form</span> <span class="id" type="var">t1</span> = <span class="id" type="var">canonical_form</span> <span class="id" type="var">t2</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Af</span> <span class="id" type="var">Wt1</span> <span class="id" type="var">Wt2</span> <span class="id" type="var">P</span>; <br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">flatten_cf</span> <span class="id" type="keyword">with</span> <span class="id" type="var">f</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_cf_is_well_formed_cf_conv</span>; <span class="id" type="var">exists</span> <span class="id" type="var">t1</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_cf_is_well_formed_cf_conv</span>; <span class="id" type="var">exists</span> <span class="id" type="var">t2</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">build</span> (<span class="id" type="var">f</span> : <span class="id" type="var">symbol</span>) <span class="id" type="var">l</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">t</span> :: <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">t</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">_</span> =&gt; <span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">quicksort</span> <span class="id" type="var">l</span>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">build_eq_Term</span> :<br/>
<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>, 2 &lt;= <span class="id" type="var">length</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="var">build</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> = <span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">quicksort</span> <span class="id" type="var">l</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">Ll</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">u</span> [ | <span class="id" type="var">v</span> <span class="id" type="var">l</span>]]; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Ll</span>; <span class="id" type="var">absurd</span> (2 &lt;= 1); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">well_formed_cf_build</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt;<br/>
&nbsp;1 &lt;= <span class="id" type="var">length</span> <span class="id" type="var">l</span> -&gt;<br/>
&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="var">well_formed_cf</span> <span class="id" type="var">t</span>) -&gt;<br/>
&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span> | <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">True</span> | <span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">f</span> &lt;&gt; <span class="id" type="var">g</span> <span class="id" type="keyword">end</span>) -&gt;<br/>
&nbsp;<span class="id" type="var">well_formed_cf</span> (<span class="id" type="var">build</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">Af</span> <span class="id" type="var">Ll</span> <span class="id" type="var">Wl</span> <span class="id" type="var">Al</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t1</span> [ | <span class="id" type="var">t2</span> <span class="id" type="var">l</span>]].<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Ll</span>; <span class="id" type="var">absurd</span> (1 &lt;= 0); <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Wl</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">build_eq_Term</span>; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_cf_fold</span>; <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">in_quick_in</span> <span class="id" type="keyword">in</span> <span class="id" type="var">In_u</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Wl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Af</span>; <span class="id" type="tactic">split</span>; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">split</span>].<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">length_quicksort</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">quick_sorted</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">in_quick_in</span> <span class="id" type="keyword">in</span> <span class="id" type="var">In_u</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Al</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">well_formed_cf_build_cons</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt; <br/>
&nbsp;<span class="id" type="var">well_formed_cf</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t</span> :: <span class="id" type="var">l</span>)) -&gt; <span class="id" type="var">well_formed_cf</span> (<span class="id" type="var">build</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> <span class="id" type="var">Af</span> <span class="id" type="var">W</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_cf_build</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">le_S_n</span>; <span class="id" type="tactic">replace</span> (<span class="id" type="var">S</span> (<span class="id" type="var">length</span> <span class="id" type="var">l</span>)) <span class="id" type="keyword">with</span> (<span class="id" type="var">length</span> (<span class="id" type="var">t</span> :: <span class="id" type="var">l</span>)); <span class="id" type="tactic">trivial</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_cf_length</span> <span class="id" type="keyword">with</span> <span class="id" type="var">f</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">well_formed_cf_subterms</span> <span class="id" type="var">W</span>); <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">well_formed_cf_alien</span> <span class="id" type="var">Af</span> <span class="id" type="var">W</span>); <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">well_formed_cf_build_inside</span> :<br/>
<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">t</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt; <br/>
&nbsp;<span class="id" type="var">well_formed_cf</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">l1</span> ++ <span class="id" type="var">t</span> :: <span class="id" type="var">l2</span>)) -&gt; <span class="id" type="var">well_formed_cf</span> (<span class="id" type="var">build</span> <span class="id" type="var">f</span> (<span class="id" type="var">l1</span> ++ <span class="id" type="var">l2</span>)).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">t</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">Af</span> <span class="id" type="var">W</span>; <br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">u</span>, <span class="id" type="var">In</span> <span class="id" type="var">u</span> (<span class="id" type="var">l1</span> ++ <span class="id" type="var">l2</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">u</span> (<span class="id" type="var">l1</span> ++ <span class="id" type="var">t</span> :: <span class="id" type="var">l2</span>)).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">elim</span> (<span class="id" type="var">in_app_or</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">In_u</span>); <span class="id" type="tactic">clear</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">In_u</span>; <br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; [ <span class="id" type="var">left</span> | <span class="id" type="var">right</span>; <span class="id" type="var">right</span> ]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_cf_build</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">le_S_n</span>; <span class="id" type="tactic">replace</span> (<span class="id" type="var">S</span> (<span class="id" type="var">length</span> (<span class="id" type="var">l1</span> ++ <span class="id" type="var">l2</span>))) <span class="id" type="keyword">with</span> (<span class="id" type="var">length</span> (<span class="id" type="var">l1</span> ++ <span class="id" type="var">t</span> :: <span class="id" type="var">l2</span>)).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_cf_length</span> <span class="id" type="keyword">with</span> <span class="id" type="var">f</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> <span class="id" type="var">length_app</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">plus_comm</span>; <span class="id" type="tactic">simpl</span>; <br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">plus_comm</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">well_formed_cf_subterms</span> <span class="id" type="var">W</span>); <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">well_formed_cf_alien</span> <span class="id" type="var">Af</span> <span class="id" type="var">W</span>); <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">flatten_build</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt; <br/>
&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span> | <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">True</span> | <span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">f</span> &lt;&gt; <span class="id" type="var">g</span> <span class="id" type="keyword">end</span>) -&gt;<br/>
&nbsp;<span class="id" type="var">permut</span> (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> ((<span class="id" type="var">build</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) :: <span class="id" type="var">nil</span>)) <span class="id" type="var">l</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> [ | <span class="id" type="var">t1</span> [ | <span class="id" type="var">t2</span> <span class="id" type="var">l</span>]] <span class="id" type="var">Af</span> <span class="id" type="var">Al</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">f</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">f</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Pnil</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">f_diff_f</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">f_diff_f</span>; <span class="id" type="tactic">reflexivity</span>].<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Al_t1</span> := <span class="id" type="var">Al</span> <span class="id" type="var">_</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>))).<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">t1</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">g</span>]; [<span class="id" type="tactic">auto</span> | <span class="id" type="var">idtac</span>].<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">f_eq_g</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Al_t1</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">f</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">f</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">f_diff_f</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">f_diff_f</span>; <span class="id" type="tactic">reflexivity</span>].<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">app_nil_end</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">quick_permut_bis</span>; <span class="id" type="tactic">auto</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">flatten_build_cons</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt; <span class="id" type="var">well_formed_cf</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t</span> :: <span class="id" type="var">l</span>)) -&gt; <br/>
&nbsp;<span class="id" type="var">permut</span> (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> ((<span class="id" type="var">build</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) :: <span class="id" type="var">nil</span>)) <span class="id" type="var">l</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> <span class="id" type="var">Af</span> <span class="id" type="var">W</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">flatten_build</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">well_formed_cf_alien</span> <span class="id" type="var">Af</span> <span class="id" type="var">W</span>); <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">flatten_build_inside</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">t</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt; <br/>
&nbsp;<span class="id" type="var">well_formed_cf</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">l1</span> ++ <span class="id" type="var">t</span> :: <span class="id" type="var">l2</span>)) -&gt;<br/>
&nbsp;<span class="id" type="var">permut</span> (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> ((<span class="id" type="var">build</span> <span class="id" type="var">f</span> (<span class="id" type="var">l1</span> ++ <span class="id" type="var">l2</span>)) :: <span class="id" type="var">nil</span>)) (<span class="id" type="var">l1</span> ++ <span class="id" type="var">l2</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">t</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">Af</span> <span class="id" type="var">W</span>; <br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">flatten_build</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">well_formed_cf_alien</span> <span class="id" type="var">Af</span> <span class="id" type="var">W</span>);<br/>
<span class="id" type="tactic">elim</span> (<span class="id" type="var">in_app_or</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">In_u</span>); <span class="id" type="tactic">clear</span> <span class="id" type="var">In_u</span>; <br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; [<span class="id" type="var">left</span> | <span class="id" type="var">right</span>; <span class="id" type="var">right</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab113"></a><h2 class="section">Substitutions modulo AC</h2>

</div>
<div class="code">
<span class="id" type="keyword">Definition</span> <span class="id" type="var">is_subst_canonical_form</span> <span class="id" type="var">sigma</span> <span class="id" type="var">sigma_cf</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">v</span>, <span class="id" type="keyword">match</span> <span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">None</span> =&gt; <span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma_cf</span> = <span class="id" type="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Some</span> <span class="id" type="var">v_sigma</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma_cf</span> = <span class="id" type="var">Some</span> (<span class="id" type="var">canonical_form</span> <span class="id" type="var">v_sigma</span>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">is_subst_cf_is_subst_cf</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">sigma</span>, <span class="id" type="var">is_subst_canonical_form</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">map_subst</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">_</span> <span class="id" type="var">t</span> =&gt; <span class="id" type="var">canonical_form</span> <span class="id" type="var">t</span>) <span class="id" type="var">sigma</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">sigma</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">is_subst_canonical_form</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">subst_comp_is_subst_comp_aux1</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">well_formed_cf_subst</span> <span class="id" type="var">sigma</span> := <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">v</span>, <span class="id" type="keyword">match</span> <span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">None</span> =&gt; <span class="id" type="var">True</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Some</span> <span class="id" type="var">t</span> =&gt; <span class="id" type="var">well_formed_cf</span> <span class="id" type="var">t</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">well_formed_cf_subst_is_well_formed_cf_subst_aux</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">sigma</span>, <span class="id" type="var">well_formed_cf_subst</span> <span class="id" type="var">sigma</span> -&gt;<br/>
&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">v</span>, <span class="id" type="var">nb_occ</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma</span> &lt;= 1) -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="var">exists</span> <span class="id" type="var">sigma'</span>, <span class="id" type="var">well_formed_subst</span> <span class="id" type="var">sigma'</span> /\ <br/>
&nbsp;&nbsp;<span class="id" type="var">is_subst_canonical_form</span> <span class="id" type="var">sigma'</span> <span class="id" type="var">sigma</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">well_formed_cf_subst</span>, <span class="id" type="var">is_subst_canonical_form</span>; <br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">sigma</span> <span class="id" type="var">Wsigma</span> <span class="id" type="var">Nb_occ_sigma</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">sigma</span> <span class="id" type="keyword">as</span> [ | [<span class="id" type="var">v1</span> <span class="id" type="var">t1</span>] <span class="id" type="var">sigma</span>].<br/>
<span class="id" type="var">exists</span> (<span class="id" type="var">nil</span> : <span class="id" type="var">substitution</span>); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">elim</span> <span class="id" type="var">IHsigma</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">sigma'</span> [<span class="id" type="var">Wsigma'</span> <span class="id" type="var">Hsigma'</span>]; <span class="id" type="tactic">assert</span> (<span class="id" type="var">Wt1</span> : <span class="id" type="var">well_formed_cf</span> <span class="id" type="var">t1</span>).<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">Wsigma</span> <span class="id" type="var">v1</span>); <span class="id" type="tactic">simpl</span>; <br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v1</span> <span class="id" type="var">v1</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v1</span> <span class="id" type="var">v1</span>); [ <span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">v1_diff_v1</span>]; <span class="id" type="tactic">trivial</span>; <br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">v1</span>=v1); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">elim</span> (<span class="id" type="var">well_formed_cf_is_well_formed_cf</span> <span class="id" type="var">_</span> <span class="id" type="var">Wt1</span>); <span class="id" type="tactic">intros</span> <span class="id" type="var">u1</span> [<span class="id" type="var">Wu1</span> <span class="id" type="var">Hu1</span>];<br/>
<span class="id" type="var">exists</span> ((<span class="id" type="var">v1</span>,u1)::sigma'); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">v1</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Wsigma'</span>.<br/>
<span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Hsigma'</span>.<br/>

<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">Wsigma</span> <span class="id" type="var">v</span>) (<span class="id" type="var">Nb_occ_sigma</span> <span class="id" type="var">v</span>); <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">v1</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">some_nb_occ_Sn</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">H</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)); <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">H</span> <span class="id" type="var">_</span> <span class="id" type="var">H'</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">nb_occ</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma</span>) <span class="id" type="keyword">as</span> [ | <span class="id" type="var">no</span>];<br/>
[ <span class="id" type="var">absurd</span> (1 &lt;= 0) | <span class="id" type="var">absurd</span> (<span class="id" type="var">S</span>(<span class="id" type="var">S</span> <span class="id" type="var">no</span>) &lt;= 1) ]; <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">exact</span> <span class="id" type="var">I</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">Nb_occ_sigma</span> <span class="id" type="var">v</span>); <span class="id" type="tactic">simpl</span>;<br/>
<span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">v1</span>); <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">well_formed_cf_subst_is_well_formed_cf_subst</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">sigma</span>, <span class="id" type="var">well_formed_cf_subst</span> <span class="id" type="var">sigma</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="var">exists</span> <span class="id" type="var">sigma'</span>, <span class="id" type="var">well_formed_subst</span> <span class="id" type="var">sigma'</span> /\ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">is_subst_canonical_form</span> <span class="id" type="var">sigma'</span> <span class="id" type="var">sigma</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">E</span> : <span class="id" type="var">equivalence</span> <span class="id" type="var">_</span> (@<span class="id" type="var">eq</span> <span class="id" type="var">variable</span>)).<br/>
<span class="id" type="tactic">repeat</span> <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">t3</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">sigma</span> <span class="id" type="var">Wsigma</span>;<br/>
<span class="id" type="tactic">elim</span> (<span class="id" type="var">reduce_assoc_list</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">E</span> <span class="id" type="var">sigma</span>);<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">sigma1</span> [<span class="id" type="var">Nb_occ</span> <span class="id" type="var">H</span>];<br/>
<span class="id" type="tactic">elim</span> (<span class="id" type="var">well_formed_cf_subst_is_well_formed_cf_subst_aux</span> (<span class="id" type="var">sigma</span> := <span class="id" type="var">sigma1</span>));<br/>
<span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">sigma'</span> [<span class="id" type="var">Wsigma'</span> <span class="id" type="var">H'</span>]; <span class="id" type="var">exists</span> <span class="id" type="var">sigma'</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>;<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H'</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Wsigma</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">apply_cf_subst</span> (<span class="id" type="var">sigma</span> : <span class="id" type="var">substitution</span>) (<span class="id" type="var">t</span> : <span class="id" type="var">term</span>) {<span class="id" type="keyword">struct</span> <span class="id" type="var">t</span>} : <span class="id" type="var">term</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">v</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">None</span> =&gt; <span class="id" type="var">t</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Some</span> <span class="id" type="var">v_sigma</span> =&gt; <span class="id" type="var">v_sigma</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">l_sigma</span> := <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">arity</span> <span class="id" type="var">f</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">AC</span> =&gt; <span class="id" type="var">quicksort</span> (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">map</span> (<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">l</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">C</span> =&gt; <span class="id" type="var">quicksort</span> (<span class="id" type="var">map</span> (<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">l</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Free</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">map</span> (<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">l</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span> <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l_sigma</span><br/>
&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">flatten_apply_cf_subst</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">sigma</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="var">permut</span> (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">map</span> (<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">l</span>))<br/>
&nbsp;&nbsp;(<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">build</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) :: <span class="id" type="var">nil</span>)).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">sigma</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">Af</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t1</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">f</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">f</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">f_diff_f</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">f_diff_f</span>; <span class="id" type="tactic">reflexivity</span>].<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Af</span>; <span class="id" type="tactic">repeat</span> <span class="id" type="tactic">rewrite</span> <span class="id" type="var">quicksort_equation</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">auto</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t2</span> <span class="id" type="var">l</span>]; <span class="id" type="tactic">auto</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Af</span>; <br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">f</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">f</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">f_diff_f</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">f_diff_f</span>; <span class="id" type="tactic">reflexivity</span>].<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">app_nil_end</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">permut_sym</span>; <br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">quick_permut_bis</span>;<br/>
<span class="id" type="tactic">transitivity</span> (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">map</span> (<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma</span>) (<span class="id" type="var">t1</span> :: <span class="id" type="var">t2</span> :: <span class="id" type="var">l</span>))); <span class="id" type="tactic">auto</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">list_permut_flatten</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">permut_map</span> <span class="id" type="keyword">with</span> (@<span class="id" type="var">eq</span> <span class="id" type="var">term</span>).<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">permut_sym</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">quick_permut</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">apply_cf_subst_is_sound</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">sigma</span> <span class="id" type="var">sigma_cf</span>, <span class="id" type="var">is_subst_canonical_form</span> <span class="id" type="var">sigma</span> <span class="id" type="var">sigma_cf</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma_cf</span> (<span class="id" type="var">canonical_form</span> <span class="id" type="var">t</span>) = <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">canonical_form</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">sigma</span> <span class="id" type="var">sigma_cf</span> <span class="id" type="var">H</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>

<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">H</span> <span class="id" type="var">v</span>); <span class="id" type="tactic">simpl</span>; <br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">t</span> | ]; <br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H_v</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H_v</span>; <span class="id" type="tactic">trivial</span>.<br/>

<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">IH</span>; <br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">IHl</span> : <span class="id" type="var">map</span> (<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma_cf</span>) (<span class="id" type="var">map</span> <span class="id" type="var">canonical_form</span> <span class="id" type="var">l</span>) =<br/>
&nbsp;<span class="id" type="var">map</span> <span class="id" type="var">canonical_form</span> (<span class="id" type="var">map</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">l</span>)).<br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="var">map</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHl</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IH</span>; [ <span class="id" type="var">idtac</span> | <span class="id" type="var">left</span> ]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IH</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)).<br/>
<span class="id" type="var">destruct_arity</span> <span class="id" type="var">f</span> <span class="id" type="var">a</span> <span class="id" type="var">Af</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">sort_is_unique</span>; [<span class="id" type="tactic">apply</span> <span class="id" type="var">quick_sorted</span> | <span class="id" type="tactic">apply</span> <span class="id" type="var">quick_sorted</span> | <span class="id" type="var">idtac</span>];<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">quick_permut_bis</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">permut_sym</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">quick_permut_bis</span>;<br/>
<span class="id" type="tactic">transitivity</span><br/>
&nbsp;&nbsp;(<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">map</span> (<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma_cf</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">map</span> <span class="id" type="var">canonical_form</span> <span class="id" type="var">l</span>)))).<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">IHl</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">map</span> <span class="id" type="var">canonical_form</span> <span class="id" type="var">l</span>); <span class="id" type="tactic">clear</span> <span class="id" type="var">l</span> <span class="id" type="var">IHl</span> <span class="id" type="var">IH</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span>]; <span class="id" type="tactic">auto</span>.<br/>
<span class="id" type="tactic">replace</span> (<span class="id" type="var">t</span> :: <span class="id" type="var">l</span>) <span class="id" type="keyword">with</span> ((<span class="id" type="var">t</span> :: <span class="id" type="var">nil</span>) ++ <span class="id" type="var">l</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">map_app</span>; <span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> <span class="id" type="var">flatten_app</span>; <br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">map_app</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">flatten_app</span>;<br/>
<span class="id" type="tactic">transitivity</span> <br/>
&nbsp;&nbsp;(<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">map</span> (<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma_cf</span>) (<span class="id" type="var">t</span> :: <span class="id" type="var">nil</span>)) ++<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">map</span> (<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma_cf</span>) (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>))).<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">permut_app1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">permut_app2</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">v</span> | <span class="id" type="var">g</span> <span class="id" type="var">ll</span>]; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">auto</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">f_eq_g</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">g</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">f_diff_g</span>].<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Af</span>; <span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">app_nil_end</span>; <br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">permut_sym</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">quick_permut</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">f_eq_g</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">g</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">f_diff_g</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">list_permut_flatten</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">permut_map</span> <span class="id" type="keyword">with</span> (@<span class="id" type="var">eq</span> <span class="id" type="var">term</span>).<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">quick_permut</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">sort_is_unique</span>; [<span class="id" type="tactic">apply</span> <span class="id" type="var">quick_sorted</span> | <span class="id" type="tactic">apply</span> <span class="id" type="var">quick_sorted</span> | <span class="id" type="var">idtac</span>];<br/>
<span class="id" type="tactic">do</span> 2 (<span class="id" type="tactic">apply</span> <span class="id" type="var">quick_permut_bis</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">permut_sym</span>); <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">IHl</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">permut_map</span> <span class="id" type="keyword">with</span> (@<span class="id" type="var">eq</span> <span class="id" type="var">term</span>).<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">quick_permut_bis</span>; <span class="id" type="tactic">auto</span>.<br/>
<span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">well_formed_cf_apply_subst</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">sigma</span>, <span class="id" type="var">well_formed_cf_subst</span> <span class="id" type="var">sigma</span> -&gt; <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">well_formed_cf</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">well_formed_cf</span> (<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">sigma</span> <span class="id" type="var">Wsigma</span> <span class="id" type="var">t</span> <span class="id" type="var">Wt</span>;<br/>
<span class="id" type="tactic">elim</span> (<span class="id" type="var">well_formed_cf_is_well_formed_cf</span> <span class="id" type="var">_</span> <span class="id" type="var">Wt</span>); <br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> [<span class="id" type="var">Wu</span> <span class="id" type="var">Hu</span>]; <span class="id" type="tactic">subst</span>;<br/>
<span class="id" type="tactic">elim</span> (<span class="id" type="var">well_formed_cf_subst_is_well_formed_cf_subst</span> <span class="id" type="var">Wsigma</span>);<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">tau</span> [<span class="id" type="var">Wtau</span> <span class="id" type="var">Htau</span>];<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">apply_cf_subst_is_sound</span> <span class="id" type="keyword">with</span> <span class="id" type="var">tau</span> <span class="id" type="var">sigma</span> <span class="id" type="var">u</span>; <span class="id" type="tactic">trivial</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_cf_is_well_formed_cf_conv</span>;<br/>
<span class="id" type="var">exists</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">tau</span> <span class="id" type="var">u</span>); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_apply_subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">length_flatten_ter</span> :<br/>
<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">sigma</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt; <span class="id" type="var">well_formed_cf_subst</span> <span class="id" type="var">sigma</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">l</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="var">well_formed_cf</span> <span class="id" type="var">t</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="var">length</span> <span class="id" type="var">l</span> &lt;= <span class="id" type="var">length</span> (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">map</span> (<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">l</span>)).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">sigma</span> <span class="id" type="var">Af</span> <span class="id" type="var">Wsigma</span> <span class="id" type="var">l</span> <span class="id" type="var">Wl</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">replace</span> (<span class="id" type="var">t</span>::l) <span class="id" type="keyword">with</span> ((<span class="id" type="var">t</span>::nil) ++ <span class="id" type="var">l</span>); <span class="id" type="tactic">trivial</span>;<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">map_app</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">flatten_app</span>; <br/>
<span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> <span class="id" type="var">length_app</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">plus_le_compat</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Wtsigma</span> : <span class="id" type="var">well_formed_cf</span> (<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>)).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_cf_apply_subst</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Wl</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="var">map</span>;<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">apply_cf_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>) <span class="id" type="keyword">as</span> [ <span class="id" type="var">v</span> | <span class="id" type="var">g</span> <span class="id" type="var">ll</span> ]; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>;<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">f_eq_g</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">g</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">app_nil_end</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">le_trans</span> <span class="id" type="keyword">with</span> 2; <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_cf_length</span> <span class="id" type="keyword">with</span> <span class="id" type="var">f</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Wl</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab114"></a><h2 class="section">Canonical forms and equality modulo AC</h2>

</div>
<div class="code">
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">ac_one_step_at_top_cf_eq</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">ac_one_step_at_top</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; <span class="id" type="var">canonical_form</span> <span class="id" type="var">t1</span> = <span class="id" type="var">canonical_form</span> <span class="id" type="var">t2</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">P12</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">permut</span> (<span class="id" type="var">t1</span> :: <span class="id" type="var">t2</span> :: <span class="id" type="var">nil</span>) (<span class="id" type="var">t2</span> :: <span class="id" type="var">t1</span> :: <span class="id" type="var">nil</span>)).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>; <br/>
<span class="id" type="tactic">replace</span> (<span class="id" type="var">t1</span> :: <span class="id" type="var">t2</span> :: <span class="id" type="var">nil</span>) <span class="id" type="keyword">with</span> ((<span class="id" type="var">t1</span> :: <span class="id" type="var">nil</span>) ++ (<span class="id" type="var">t2</span> :: <span class="id" type="var">nil</span>)); <span class="id" type="tactic">trivial</span>;<br/>
<span class="id" type="tactic">replace</span> (<span class="id" type="var">t2</span> :: <span class="id" type="var">t1</span> :: <span class="id" type="var">nil</span>) <span class="id" type="keyword">with</span> ((<span class="id" type="var">t2</span> :: <span class="id" type="var">nil</span>) ++ (<span class="id" type="var">t1</span> :: <span class="id" type="var">nil</span>)); <span class="id" type="tactic">trivial</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">list_permut_app_app</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Ccase</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">f</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">C</span> \/ <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>,<br/>
<span class="id" type="var">canonical_form</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t1</span> :: <span class="id" type="var">t2</span> :: <span class="id" type="var">nil</span>)) =<br/>
<span class="id" type="var">canonical_form</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t2</span> :: <span class="id" type="var">t1</span> :: <span class="id" type="var">nil</span>))).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> [<span class="id" type="var">Af</span> | <span class="id" type="var">Af</span>] <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Af</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>));<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">sort_is_unique</span>; <span class="id" type="tactic">try</span> <span class="id" type="tactic">apply</span> <span class="id" type="var">quick_sorted</span>; <br/>
<span class="id" type="tactic">do</span> 2 (<span class="id" type="tactic">apply</span> <span class="id" type="var">quick_permut_bis</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">permut_sym</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">P12</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">canonical_form</span> <span class="id" type="var">t1</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v1</span> | <span class="id" type="var">f1</span> <span class="id" type="var">ll1</span>];<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">canonical_form</span> <span class="id" type="var">t2</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v2</span> | <span class="id" type="var">f2</span> <span class="id" type="var">ll2</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">P12</span>.<br/>
<span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">f2</span>);<br/>
[ <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">permut_cons_inside</span>; <span class="id" type="tactic">auto</span> <br/>
| <span class="id" type="tactic">apply</span> <span class="id" type="var">P12</span> ].<br/>
<span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">f1</span>);<br/>
[ <span class="id" type="tactic">apply</span> <span class="id" type="var">permut_sym</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">permut_cons_inside</span>; <span class="id" type="tactic">auto</span> <br/>
| <span class="id" type="tactic">apply</span> <span class="id" type="var">P12</span> ].<br/>
<span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">f1</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">f2</span>).<br/>
<span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">app_nil_end</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">list_permut_app_app</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">permut_sym</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">permut_cons_inside</span>; <span class="id" type="tactic">auto</span>.<br/>
<span class="id" type="tactic">reflexivity</span>.<br/>

<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">permut_cons_inside</span>; <span class="id" type="tactic">auto</span>.<br/>
<span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">P12</span>.<br/>

<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">ACcase</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">f</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">t3</span>,<br/>
<span class="id" type="var">canonical_form</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t1</span> :: <span class="id" type="var">t2</span> :: <span class="id" type="var">nil</span>) :: <span class="id" type="var">t3</span> :: <span class="id" type="var">nil</span>)) =<br/>
<span class="id" type="var">canonical_form</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t1</span> :: <span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t2</span> :: <span class="id" type="var">t3</span> :: <span class="id" type="var">nil</span>) :: <span class="id" type="var">nil</span>))).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">Af</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">t3</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Af</span>; <br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">f</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">f</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">f_diff_f</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">f_diff_f</span>; <span class="id" type="tactic">reflexivity</span>].<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)); <span class="id" type="tactic">apply</span> <span class="id" type="var">sort_is_unique</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">quick_sorted</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">quick_sorted</span>.<br/>
<span class="id" type="tactic">do</span> 2 (<span class="id" type="tactic">apply</span> <span class="id" type="var">quick_permut_bis</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">permut_sym</span>).<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">canonical_form</span> <span class="id" type="var">t1</span>) (<span class="id" type="var">canonical_form</span> <span class="id" type="var">t2</span>) (<span class="id" type="var">canonical_form</span> <span class="id" type="var">t3</span>);<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">t3</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">t3</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">app_nil_end</span>.<br/>
<span class="id" type="tactic">transitivity</span> ((<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">t1</span> :: <span class="id" type="var">t2</span> :: <span class="id" type="var">nil</span>)) ++ (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">t3</span> :: <span class="id" type="var">nil</span>))).<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">permut_app2</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">permut_sym</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">quick_permut</span>.<br/>
<span class="id" type="tactic">transitivity</span> ((<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">t1</span> :: <span class="id" type="var">nil</span>)) ++ (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">t2</span> :: <span class="id" type="var">t3</span> :: <span class="id" type="var">nil</span>))).<br/>
<span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">flatten_app</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="var">app</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">permut_refl</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t1</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v1</span> | <span class="id" type="var">g1</span> <span class="id" type="var">ll1</span>].<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">permut_cons</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">quick_permut</span>.<br/>
<span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">g1</span>).<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">app_nil_end</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">permut_app1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">quick_permut</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">permut_cons</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">quick_permut</span>.<br/>
<span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">auto</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">sym_eq</span>; <span class="id" type="tactic">auto</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">sym_refl_ac_one_step_at_top_cf_eq</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, (<span class="id" type="var">sym_refl</span> <span class="id" type="var">ac_one_step_at_top</span>) <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; <span class="id" type="var">canonical_form</span> <span class="id" type="var">t1</span> = <span class="id" type="var">canonical_form</span> <span class="id" type="var">t2</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">sym_refl</span>; <span class="id" type="tactic">intros</span> [<span class="id" type="var">H</span> | [<span class="id" type="var">H</span> | <span class="id" type="var">H</span>]].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">ac_one_step_at_top_cf_eq</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">sym_eq</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">ac_one_step_at_top_cf_eq</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">ac_one_step_cf_eq</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">one_step</span> (<span class="id" type="var">sym_refl</span> <span class="id" type="var">ac_one_step_at_top</span>) <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; <span class="id" type="var">canonical_form</span> <span class="id" type="var">t1</span> = <span class="id" type="var">canonical_form</span> <span class="id" type="var">t2</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t1</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">inversion_clear</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">H'</span> | <span class="id" type="var">f</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">H'</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">sym_refl_ac_one_step_at_top_cf_eq</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">no_need_of_instance</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span> <span class="id" type="var">IHl1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>; <br/>
<span class="id" type="tactic">inversion_clear</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">Hroot</span> | <span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">l2</span> <span class="id" type="var">Hsub</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">sym_refl_ac_one_step_at_top_cf_eq</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">no_need_of_instance</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H</span> : <span class="id" type="var">map</span> <span class="id" type="var">canonical_form</span> <span class="id" type="var">l1</span> = <span class="id" type="var">map</span> <span class="id" type="var">canonical_form</span> <span class="id" type="var">l2</span>).<br/>
<span class="id" type="tactic">generalize</span> <span class="id" type="var">l2</span> <span class="id" type="var">Hsub</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">l2</span> <span class="id" type="var">Hsub</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">l1</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t1</span> <span class="id" type="var">l1</span>]; <br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">l2</span> <span class="id" type="var">Hsub</span>; <span class="id" type="tactic">inversion_clear</span> <span class="id" type="var">Hsub</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">t</span> =&gt; <span class="id" type="var">t</span> :: <span class="id" type="var">map</span> <span class="id" type="var">canonical_form</span> <span class="id" type="var">l1</span>));<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHl1</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">canonical_form</span> <span class="id" type="var">t1</span> :: <span class="id" type="var">l</span>));<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHl0</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHl1</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>

<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">ac_cf_eq</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">ac</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; <span class="id" type="var">canonical_form</span> <span class="id" type="var">t1</span> = <span class="id" type="var">canonical_form</span> <span class="id" type="var">t2</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">ac</span>, <span class="id" type="var">th_eq</span>;<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">refine</span> (<span class="id" type="var">rwr_inv</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> (@<span class="id" type="var">trans_eq</span> <span class="id" type="var">term</span>) <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H</span>).<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">ac_one_step_cf_eq</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">ac_one_step_at_top_size_eq</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">ac_one_step_at_top</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; <span class="id" type="var">size</span> <span class="id" type="var">t1</span> = <span class="id" type="var">size</span> <span class="id" type="var">t2</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">repeat</span> <span class="id" type="tactic">rewrite</span> <span class="id" type="var">plus_0_r</span>; <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>;<br/>
<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">plus_comm</span> (<span class="id" type="var">size</span> <span class="id" type="var">t1</span>) (<span class="id" type="var">S</span> (<span class="id" type="var">size</span> <span class="id" type="var">t2</span> + <span class="id" type="var">size</span> <span class="id" type="var">t3</span>))); <span class="id" type="tactic">simpl</span>;<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">n</span> =&gt; <span class="id" type="var">S</span> (<span class="id" type="var">S</span> <span class="id" type="var">n</span>)));<br/>
<span class="id" type="tactic">rewrite</span> &lt;- (<span class="id" type="var">plus_assoc</span> (<span class="id" type="var">size</span> <span class="id" type="var">t1</span>) (<span class="id" type="var">size</span> <span class="id" type="var">t2</span>) (<span class="id" type="var">size</span> <span class="id" type="var">t3</span>)); <span class="id" type="tactic">apply</span> <span class="id" type="var">plus_comm</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">sym_refl_ac_one_step_at_top_size_eq</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, (<span class="id" type="var">sym_refl</span> <span class="id" type="var">ac_one_step_at_top</span>) <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; <span class="id" type="var">size</span> <span class="id" type="var">t1</span> = <span class="id" type="var">size</span> <span class="id" type="var">t2</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">sym_refl</span>; <span class="id" type="tactic">intros</span> [<span class="id" type="var">H</span> | [<span class="id" type="var">H</span> | <span class="id" type="var">H</span>]].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">ac_one_step_at_top_size_eq</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">sym_eq</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">ac_one_step_at_top_size_eq</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">ac_one_step_size_eq</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">one_step</span> (<span class="id" type="var">sym_refl</span> <span class="id" type="var">ac_one_step_at_top</span>) <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; <span class="id" type="var">size</span> <span class="id" type="var">t1</span> = <span class="id" type="var">size</span> <span class="id" type="var">t2</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t1</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">inversion_clear</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">H'</span> | <span class="id" type="var">f</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">H'</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">sym_refl_ac_one_step_at_top_size_eq</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">no_need_of_instance</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span> <span class="id" type="var">IHl1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>; <br/>
<span class="id" type="tactic">inversion_clear</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">Hroot</span> | <span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">l2</span> <span class="id" type="var">Hsub</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">sym_refl_ac_one_step_at_top_size_eq</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">no_need_of_instance</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H</span> : <span class="id" type="var">list_size</span> <span class="id" type="var">size</span> <span class="id" type="var">l1</span> = <span class="id" type="var">list_size</span> <span class="id" type="var">size</span> <span class="id" type="var">l2</span>).<br/>
<span class="id" type="tactic">generalize</span> <span class="id" type="var">l2</span> <span class="id" type="var">Hsub</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">l2</span> <span class="id" type="var">Hsub</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">l1</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t1</span> <span class="id" type="var">l1</span>]; <br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">l2</span> <span class="id" type="var">Hsub</span>; <span class="id" type="tactic">inversion_clear</span> <span class="id" type="var">Hsub</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">n</span> =&gt; <span class="id" type="var">n</span> + <span class="id" type="var">list_size</span> <span class="id" type="var">size</span> <span class="id" type="var">l1</span>));<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHl1</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">n</span> =&gt; <span class="id" type="var">size</span> <span class="id" type="var">t1</span> + <span class="id" type="var">n</span>));<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHl0</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHl1</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> <span class="id" type="var">size_unfold</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">ac_size_eq</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">ac</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; <span class="id" type="var">size</span> <span class="id" type="var">t1</span> = <span class="id" type="var">size</span> <span class="id" type="var">t2</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">refine</span> (<span class="id" type="var">rwr_inv</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> (@<span class="id" type="var">trans_eq</span> <span class="id" type="var">nat</span>) <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H</span>).<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">ac_one_step_size_eq</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">ac_size</span> (<span class="id" type="var">t</span>:term) : <span class="id" type="var">nat</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">v</span> =&gt; 1<br/>
&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">ac_size_list</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">fix</span> <span class="id" type="var">ac_size_list</span> (<span class="id" type="var">l</span> : <span class="id" type="var">list</span> <span class="id" type="var">term</span>) {<span class="id" type="keyword">struct</span> <span class="id" type="var">l</span>} : <span class="id" type="var">nat</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; 0<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">t</span> :: <span class="id" type="var">lt</span> =&gt; <span class="id" type="var">ac_size</span> <span class="id" type="var">t</span> + <span class="id" type="var">ac_size_list</span> <span class="id" type="var">lt</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>) <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">match</span> <span class="id" type="var">arity</span> <span class="id" type="var">f</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">AC</span> =&gt; (<span class="id" type="var">length</span> <span class="id" type="var">l</span>) - 1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">C</span> =&gt; 1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Free</span> <span class="id" type="var">_</span> =&gt; 1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>) + <span class="id" type="var">ac_size_list</span> <span class="id" type="var">l</span><br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">ac_size_unfold</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <br/>
&nbsp;&nbsp;<span class="id" type="var">ac_size</span> <span class="id" type="var">t</span> = <span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; 1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">match</span> <span class="id" type="var">arity</span> <span class="id" type="var">f</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">AC</span> =&gt; (<span class="id" type="var">length</span> <span class="id" type="var">l</span>) - 1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">C</span> =&gt; 1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Free</span> <span class="id" type="var">_</span> =&gt; 1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>) + <span class="id" type="var">list_size</span> <span class="id" type="var">ac_size</span> <span class="id" type="var">l</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v</span> | <span class="id" type="var">f</span> <span class="id" type="var">l</span>]; <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">n</span> =&gt; (<span class="id" type="keyword">match</span> <span class="id" type="var">arity</span> <span class="id" type="var">f</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">AC</span> =&gt; <span class="id" type="var">length</span> <span class="id" type="var">l</span> - 1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">C</span> =&gt; 1 <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Free</span> <span class="id" type="var">_</span> =&gt; 1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>) + <span class="id" type="var">n</span>)); <br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">IHl</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">ac_size</span> <span class="id" type="var">t</span>);<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">f</span> <span class="id" type="var">t</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span>]; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>;<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">n</span>; <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">IHl</span> (<span class="id" type="var">n</span> + <span class="id" type="var">ac_size</span> <span class="id" type="var">t</span>)); <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">IHl</span> (<span class="id" type="var">ac_size</span> <span class="id" type="var">t</span>));<br/>
<span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">size_size_aux2</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">t</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt; <span class="id" type="var">well_formed</span> <span class="id" type="var">t</span> -&gt;<br/>
&nbsp;<span class="id" type="var">ac_size</span> (<span class="id" type="var">canonical_form</span> <span class="id" type="var">t</span>) = <br/>
&nbsp;<span class="id" type="var">list_size</span> <span class="id" type="var">ac_size</span> (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">canonical_form</span> <span class="id" type="var">t</span> :: <span class="id" type="var">nil</span>)) +<br/>
&nbsp;(<span class="id" type="var">length</span> (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">canonical_form</span> <span class="id" type="var">t</span> :: <span class="id" type="var">nil</span>))) - 1.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">t</span> <span class="id" type="var">Af</span> <span class="id" type="var">Wt</span>; <span class="id" type="tactic">assert</span> (<span class="id" type="var">Wu</span> : <span class="id" type="var">well_formed_cf</span> (<span class="id" type="var">canonical_form</span> <span class="id" type="var">t</span>)).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_cf_is_well_formed_cf_conv</span>; <span class="id" type="var">exists</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">canonical_form</span> <span class="id" type="var">t</span>) <span class="id" type="var">Wu</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span> <span class="id" type="var">Wt</span> <span class="id" type="var">Wu</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">Wu</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">u</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v</span> | <span class="id" type="var">g</span> <span class="id" type="var">l</span>]; <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">f_eq_g</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">g</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">f_diff_g</span>].<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Af</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">app_nil_end</span>;<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">well_formed_cf_length</span> <span class="id" type="var">Af</span> <span class="id" type="var">Wu</span>); <span class="id" type="tactic">intro</span> <span class="id" type="var">Ll</span>;<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">length</span> <span class="id" type="var">l</span>) <span class="id" type="keyword">as</span> [ | <span class="id" type="var">n</span>].<br/>
<span class="id" type="var">absurd</span> (2 &lt;= 0); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">plus_comm</span> (<span class="id" type="var">list_size</span> <span class="id" type="var">ac_size</span> <span class="id" type="var">l</span>)); <span class="id" type="tactic">simpl</span>;<br/>
<span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">minus_n_O</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">list_size_fold</span> <span class="id" type="var">ac_size</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">plus_0_r</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">sym_eq</span>;<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">plus_comm</span>; <span class="id" type="tactic">simpl</span>;<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">minus_n_O</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">size_size_aux3</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">t</span>, <span class="id" type="var">arity</span> <span class="id" type="var">f</span> = <span class="id" type="var">AC</span> -&gt; <span class="id" type="var">well_formed</span> <span class="id" type="var">t</span> -&gt;<br/>
&nbsp;1 &lt;= <span class="id" type="var">length</span> (<span class="id" type="var">A</span>:=term) (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">canonical_form</span> <span class="id" type="var">t</span> :: <span class="id" type="var">nil</span>)).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">t</span> <span class="id" type="var">Ar</span> <span class="id" type="var">Wt</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">length_flatten</span> (<span class="id" type="var">t</span> :: <span class="id" type="var">nil</span>) <span class="id" type="var">Ar</span>);<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">In_u</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">In_u</span>.<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">u</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">size_size</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">well_formed</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">size</span> <span class="id" type="var">t</span> = <span class="id" type="var">ac_size</span> (<span class="id" type="var">canonical_form</span> <span class="id" type="var">t</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">H</span> <span class="id" type="var">Wt</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">well_formed_unfold</span> <span class="id" type="var">Wt</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">Wl</span> <span class="id" type="var">Ll</span>].<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Hl</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="var">size</span> <span class="id" type="var">t</span> = <span class="id" type="var">ac_size</span> (<span class="id" type="var">canonical_form</span> <span class="id" type="var">t</span>)).<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Wl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">H</span> <span class="id" type="var">Wt</span>;<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Hl'</span> : <span class="id" type="var">list_size</span> <span class="id" type="var">size</span> <span class="id" type="var">l</span> = <span class="id" type="var">list_size</span> <span class="id" type="var">ac_size</span> (<span class="id" type="var">map</span> <span class="id" type="var">canonical_form</span> <span class="id" type="var">l</span>)).<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">Ll</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">Hl</span> <span class="id" type="var">t</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>))); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Wl</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Hl</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">list_size_fold</span> <span class="id" type="var">size</span>); <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">list_size_fold</span> <span class="id" type="var">ac_size</span>);<br/>
<span class="id" type="var">destruct_arity</span> <span class="id" type="var">f</span> <span class="id" type="var">n</span> <span class="id" type="var">Af</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Dummy</span> : <span class="id" type="var">DOS.A</span> = <span class="id" type="var">term</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">length_quicksort</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Dummy2</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">l</span>, @<span class="id" type="var">length</span> <span class="id" type="var">DOS.A</span> <span class="id" type="var">l</span> = @<span class="id" type="var">length</span> <span class="id" type="var">term</span> <span class="id" type="var">l</span>).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">k</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Dummy2</span>.<br/>
<span class="id" type="tactic">replace</span> (<span class="id" type="var">list_size</span> <span class="id" type="var">ac_size</span> (<span class="id" type="var">quicksort</span> (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">map</span> <span class="id" type="var">canonical_form</span> <span class="id" type="var">l</span>))))<br/>
<span class="id" type="keyword">with</span> (<span class="id" type="var">list_size</span> <span class="id" type="var">ac_size</span> (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">map</span> <span class="id" type="var">canonical_form</span> <span class="id" type="var">l</span>))).<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t1</span> [ | <span class="id" type="var">t2</span> [ | <span class="id" type="var">t3</span> <span class="id" type="var">l</span>]]];<br/>
[<span class="id" type="var">absurd</span> (0 = 2) | <span class="id" type="var">absurd</span> (1 = 2) | <span class="id" type="var">idtac</span> | <span class="id" type="var">absurd</span> (<span class="id" type="var">S</span>(<span class="id" type="var">S</span>(<span class="id" type="var">S</span>(<span class="id" type="var">length</span> <span class="id" type="var">l</span>))) = 2)];<br/>
<span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="var">map</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="var">list_size</span>;<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">plus_0_r</span>;<br/>
<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">Hl</span> <span class="id" type="var">t1</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)));<br/>
<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">Hl</span> <span class="id" type="var">t2</span> (<span class="id" type="var">or_intror</span> <span class="id" type="var">_</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)))).<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">W1</span> : <span class="id" type="var">well_formed_cf</span> (<span class="id" type="var">canonical_form</span> <span class="id" type="var">t1</span>)).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_cf_is_well_formed_cf_conv</span>; <br/>
<span class="id" type="var">exists</span> <span class="id" type="var">t1</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Wl</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">W2</span> : <span class="id" type="var">well_formed_cf</span> (<span class="id" type="var">canonical_form</span> <span class="id" type="var">t2</span>)).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_cf_is_well_formed_cf_conv</span>; <br/>
<span class="id" type="var">exists</span> <span class="id" type="var">t2</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Wl</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">canonical_form</span> <span class="id" type="var">t1</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v1</span> | <span class="id" type="var">f1</span> <span class="id" type="var">ll1</span>];<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">canonical_form</span> <span class="id" type="var">t2</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v2</span> | <span class="id" type="var">f2</span> <span class="id" type="var">ll2</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="var">flatten</span>;<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">f2</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">f2</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">f_eq_f2</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">f2</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">f_diff_f2</span>].<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">app_nil_end</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Af</span>.<br/>
<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">list_size_fold</span> <span class="id" type="var">ac_size</span>); <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">minus_n_O</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">well_formed_cf_length</span> <span class="id" type="var">Af</span> <span class="id" type="var">W2</span>).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">Lll2</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">length</span> <span class="id" type="var">ll2</span>) <span class="id" type="keyword">as</span> [ | <span class="id" type="var">n2</span>].<br/>
<span class="id" type="var">absurd</span> (2 &lt;= 0); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">minus_n_O</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">sym_eq</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">plus_comm</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">plus_comm</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">plus_0_r</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="var">flatten</span>;<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">f1</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">f1</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">f_eq_f1</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">f1</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">f_diff_f1</span>].<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Af</span>; <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">list_size_fold</span> <span class="id" type="var">ac_size</span>).<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">well_formed_cf_length</span> <span class="id" type="var">Af</span> <span class="id" type="var">W1</span>);<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">Lll1</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">length_app</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">length</span> <span class="id" type="var">ll1</span>) <span class="id" type="keyword">as</span> [ | <span class="id" type="var">n1</span>].<br/>
<span class="id" type="var">absurd</span> (2 &lt;= 0); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">list_size_app</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">minus_n_O</span>;<br/>
<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">plus_comm</span> <span class="id" type="var">n1</span> 1); <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">plus_assoc</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">replace</span> (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f1</span> <span class="id" type="var">ll1</span> :: <span class="id" type="var">Term</span> <span class="id" type="var">f2</span> <span class="id" type="var">ll2</span> :: <span class="id" type="var">nil</span>)) <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;((<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f1</span> <span class="id" type="var">ll1</span> :: <span class="id" type="var">nil</span>)) ++ (<span class="id" type="var">flatten</span> <span class="id" type="var">f</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f2</span> <span class="id" type="var">ll2</span> :: <span class="id" type="var">nil</span>))).<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">length_app</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">f1</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">f1</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">f_eq_f1</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">f1</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">f_diff_f1</span>];<br/>
(<span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">f2</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">F.Symb.eq_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">f2</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">f_eq_f2</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">f2</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">f_diff_f2</span>]).<br/>
<span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">app_nil_end</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Af</span>;<br/>
<span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">list_size_fold</span> <span class="id" type="var">ac_size</span>); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">list_size_app</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">DOS.A</span> <span class="id" type="keyword">in</span> *; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">well_formed_cf_length</span> <span class="id" type="var">Af</span> <span class="id" type="var">W1</span>);<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">Lll1</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">length</span> <span class="id" type="var">ll1</span>) <span class="id" type="keyword">as</span> [ | <span class="id" type="var">n1</span>].<br/>
<span class="id" type="var">absurd</span> (2 &lt;= 0); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">DOS.A</span> <span class="id" type="keyword">in</span> *; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">well_formed_cf_length</span> <span class="id" type="var">Af</span> <span class="id" type="var">W2</span>);<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">Lll2</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">length</span> <span class="id" type="var">ll2</span>) <span class="id" type="keyword">as</span> [ | <span class="id" type="var">n2</span>].<br/>
<span class="id" type="var">absurd</span> (2 &lt;= 0); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">do</span> 3 <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">minus_n_O</span>;<br/>
<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">plus_comm</span> <span class="id" type="var">n1</span> (<span class="id" type="var">S</span> <span class="id" type="var">n2</span>)); <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">plus_comm</span> <span class="id" type="var">n2</span> <span class="id" type="var">n1</span>);<br/>
<span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">plus_assoc</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">n</span> =&gt; <span class="id" type="var">S</span> (<span class="id" type="var">n1</span> + <span class="id" type="var">n</span>)));<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">plus_comm</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">plus_assoc</span>;<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">n</span> =&gt; <span class="id" type="var">n2</span> + <span class="id" type="var">n</span>)); <span class="id" type="tactic">apply</span> <span class="id" type="var">plus_comm</span>.<br/>

<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Af</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">app_nil_end</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">list_size_app</span>; <span class="id" type="tactic">simpl</span>;<br/>
<span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">list_size_fold</span> <span class="id" type="var">ac_size</span>); <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">plus_0_r</span>;<br/>
<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">plus_comm</span> (<span class="id" type="var">length</span> <span class="id" type="var">ll1</span>) 1); <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">minus_n_O</span>;<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">DOS.A</span> <span class="id" type="keyword">in</span> *; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">well_formed_cf_length</span> <span class="id" type="var">Af</span> <span class="id" type="var">W1</span>);<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">Lll1</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">length</span> <span class="id" type="var">ll1</span>) <span class="id" type="keyword">as</span> [ | <span class="id" type="var">n1</span>].<br/>
<span class="id" type="var">absurd</span> (2 &lt;= 0); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">minus_n_O</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">plus_assoc</span>; <span class="id" type="tactic">trivial</span>.<br/>

<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Af</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">app_nil_end</span>.<br/>
<span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">list_size_fold</span> <span class="id" type="var">ac_size</span>).<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">DOS.A</span> <span class="id" type="keyword">in</span> *; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">well_formed_cf_length</span> <span class="id" type="var">Af</span> <span class="id" type="var">W2</span>);<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">Lll2</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">length</span> <span class="id" type="var">ll2</span>) <span class="id" type="keyword">as</span> [ | <span class="id" type="var">n2</span>].<br/>
<span class="id" type="var">absurd</span> (2 &lt;= 0); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="var">minus</span>;  <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">minus_n_O</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="var">plus</span>; <span class="id" type="tactic">do</span> 3 <span class="id" type="tactic">rewrite</span> <span class="id" type="var">plus_assoc</span>;<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">n</span> =&gt; <span class="id" type="var">S</span> (<span class="id" type="var">n</span> + <span class="id" type="var">list_size</span> <span class="id" type="var">ac_size</span> <span class="id" type="var">ll2</span>))).<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">plus_comm</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">plus_assoc</span>; <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">list_size_fold</span> <span class="id" type="var">ac_size</span>); <span class="id" type="tactic">trivial</span>.<br/>

<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">plus_0_r</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">flatten_app</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="var">app</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">permut_size</span> <span class="id" type="keyword">with</span> (@<span class="id" type="var">eq</span> <span class="id" type="var">term</span>).<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">quick_permut</span>.<br/>

<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Hl'</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> <span class="id" type="var">S</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">permut_size</span> <span class="id" type="keyword">with</span> (@<span class="id" type="var">eq</span> <span class="id" type="var">term</span>).<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">quick_permut</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Hl'</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">ac_size_ge_one</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">well_formed_cf</span> <span class="id" type="var">t</span> -&gt; 1 &lt;= <span class="id" type="var">ac_size</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">Wt</span>; <span class="id" type="tactic">elim</span> (<span class="id" type="var">well_formed_cf_is_well_formed_cf</span> <span class="id" type="var">_</span> <span class="id" type="var">Wt</span>);<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> [<span class="id" type="var">Wu</span> <span class="id" type="var">Hu</span>]; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">size_size</span>; <span class="id" type="tactic">trivial</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">size_ge_one</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">End</span> <span class="id" type="var">Make'</span>.<br/>

<br/>
<span class="id" type="keyword">Module</span> <span class="id" type="var">Make</span> (<span class="id" type="var">T1</span>: <span class="id" type="var">Term</span>) <br/>
(<span class="id" type="var">OF1</span> : <span class="id" type="var">ordered_set.S</span> <span class="id" type="keyword">with</span> <span class="id" type="keyword">Definition</span> <span class="id" type="var">A</span> := <span class="id" type="var">T1.symbol</span>) <br/>
(<span class="id" type="var">OX1</span> : <span class="id" type="var">ordered_set.S</span> <span class="id" type="keyword">with</span> <span class="id" type="keyword">Definition</span> <span class="id" type="var">A</span> := <span class="id" type="var">T1.variable</span>) : <br/>
<span class="id" type="var">S</span> <span class="id" type="keyword">with</span> <span class="id" type="keyword">Module</span> <span class="id" type="var">EqTh.T</span> := <span class="id" type="var">T1</span> := <span class="id" type="var">Make'</span> <span class="id" type="var">T1</span> <span class="id" type="var">OF1</span> <span class="id" type="var">OX1</span>.<br/>
</div>
</div>

<div id="footer">
<hr/><a href="index.html">Index</a><hr/>This page has been generated by <a href="http://www.lix.polytechnique.fr/coq/">coqdoc</a>
</div>

</div>

</body>
</html>