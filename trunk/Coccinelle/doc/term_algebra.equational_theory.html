<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"/>
<link href="coqdoc.css" rel="stylesheet" type="text/css"/>
<title>term_algebra.equational_theory</title>
</head>

<body>

<div id="page">

<div id="header">
</div>

<div id="main">

<h1 class="libtitle">Library term_algebra.equational_theory</h1>

<div class="code">

<br/>
<span class="id" type="keyword">Add</span> <span class="id" type="var">LoadPath</span> "basis".<br/>
<span class="id" type="keyword">Add</span> <span class="id" type="var">LoadPath</span> "list_extensions".<br/>

<br/>
</div>

<div class="doc">
<a name="lab35"></a><h1 class="section">Equational theory on a term algebra</h1>

</div>
<div class="code">

<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">List</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Relations</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Wellfounded</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Arith</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Setoid</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">closure</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">more_list</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">weaved_relation</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">dickson</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">term_spec</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">equational_theory_spec</span>.<br/>

<br/>
<span class="id" type="keyword">Notation</span> " T '-[' R ']-&gt;' U " := (<span class="id" type="var">R</span> <span class="id" type="var">U</span> <span class="id" type="var">T</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80) : <span class="id" type="var">term_scope</span> .<br/>

<br/>
</div>

<div class="doc">
<a name="lab36"></a><h2 class="section">A functor building a Module EqTh from a term algebra.</h2>

</div>
<div class="code">
<span class="id" type="keyword">Module</span> <span class="id" type="var">Make</span> (<span class="id" type="var">T1</span> : <span class="id" type="var">term_spec.Term</span>)  &lt;: <span class="id" type="var">EqTh</span> <span class="id" type="keyword">with</span> <span class="id" type="keyword">Module</span> <span class="id" type="var">T</span>:=T1.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Module</span> <span class="id" type="var">T</span> := <span class="id" type="var">T1</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Import</span> <span class="id" type="var">T</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Inductive</span> <span class="id" type="var">defined</span> (<span class="id" type="var">R</span> : <span class="id" type="var">relation</span> <span class="id" type="var">term</span>) : <span class="id" type="var">symbol</span> -&gt; <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">Def</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">t</span>, <span class="id" type="var">R</span> <span class="id" type="var">t</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) -&gt; <span class="id" type="var">defined</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Inductive</span> <span class="id" type="var">constructor</span> (<span class="id" type="var">R</span> : <span class="id" type="var">relation</span> <span class="id" type="var">term</span>) : <span class="id" type="var">symbol</span> -&gt; <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">Const</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">f</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">l</span> <span class="id" type="var">t</span>, ~ (<span class="id" type="var">R</span> <span class="id" type="var">t</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>))) -&gt; <span class="id" type="var">constructor</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Inductive</span> <span class="id" type="var">module</span> (<span class="id" type="var">R1</span> <span class="id" type="var">R2</span> : <span class="id" type="var">relation</span> <span class="id" type="var">term</span>) : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">Mod</span> : (<span class="id" type="keyword">forall</span> <span class="id" type="var">f2</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">defined</span> <span class="id" type="var">R2</span> <span class="id" type="var">f2</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">R1</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">symb_in_term_list</span> <span class="id" type="var">f2</span> (<span class="id" type="var">s</span> :: <span class="id" type="var">t</span> :: <span class="id" type="var">nil</span>) = <span class="id" type="var">false</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="var">module</span> <span class="id" type="var">R1</span> <span class="id" type="var">R2</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab37"></a><h3 class="section">One step at top.</h3>

</div>
<div class="code">
&nbsp;&nbsp;<span class="id" type="keyword">Inductive</span> <span class="id" type="var">axiom</span> (<span class="id" type="var">R</span> : <span class="id" type="var">relation</span> <span class="id" type="var">term</span>) : <span class="id" type="var">term</span> -&gt; <span class="id" type="var">term</span> -&gt; <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">instance</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">sigma</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">R</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; <span class="id" type="var">axiom</span> <span class="id" type="var">R</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t1</span>) (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t2</span>).<br/>

<br/>
</div>

<div class="doc">
<a name="lab38"></a><h3 class="section">One step at any position.</h3>

</div>
<div class="code">
&nbsp;&nbsp;<span class="id" type="keyword">Inductive</span> <span class="id" type="var">one_step</span> (<span class="id" type="var">R</span> : <span class="id" type="var">relation</span> <span class="id" type="var">term</span>) : <span class="id" type="var">term</span> -&gt; <span class="id" type="var">term</span> -&gt; <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">at_top</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">axiom</span> <span class="id" type="var">R</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; <span class="id" type="var">one_step</span> <span class="id" type="var">R</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">in_context</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>, <span class="id" type="var">one_step_list</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> -&gt; <span class="id" type="var">one_step</span> <span class="id" type="var">R</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span>) (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l2</span>).<br/>

<br/>
</div>

<div class="doc">
<a name="lab39"></a><h3 class="section">Rewriting Theory as transitive closure of an equational step.</h3>

</div>
<div class="code">
&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <span class="id" type="var">rwr</span> (<span class="id" type="var">R</span> : <span class="id" type="var">relation</span> <span class="id" type="var">term</span>) := <span class="id" type="var">trans_clos</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>).<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">one_step_one_rule</span> :<br/>
<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">one_step</span> <span class="id" type="var">R</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span> -&gt; <span class="id" type="var">exists</span> <span class="id" type="var">r</span>, <span class="id" type="var">exists</span> <span class="id" type="var">l</span>, <span class="id" type="var">R</span> <span class="id" type="var">r</span> <span class="id" type="var">l</span> /\ <span class="id" type="var">one_step</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">r'</span> <span class="id" type="var">l'</span> =&gt; <span class="id" type="var">In</span> (<span class="id" type="var">r'</span>,l') ((<span class="id" type="var">r</span>,l) :: <span class="id" type="var">nil</span>)) <span class="id" type="var">t</span> <span class="id" type="var">s</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">s</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">t</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x2</span> | <span class="id" type="var">f2</span> <span class="id" type="var">l2</span>].<br/>
<span class="id" type="var">exists</span> <span class="id" type="var">t1</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x2</span>); <span class="id" type="tactic">split</span>; [<span class="id" type="tactic">assumption</span> | <span class="id" type="tactic">apply</span> <span class="id" type="var">at_top</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>].<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">IH</span> <span class="id" type="var">t</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="var">exists</span> <span class="id" type="var">t1</span>; <span class="id" type="var">exists</span> <span class="id" type="var">t2</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">one_step_in_list</span> <span class="id" type="var">H1</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">u</span> [<span class="id" type="var">u'</span> [<span class="id" type="var">k1</span> [<span class="id" type="var">k2</span> [<span class="id" type="var">H2</span> [<span class="id" type="var">H3</span> <span class="id" type="var">H4</span>]]]]]].<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">u_in_l</span> : <span class="id" type="var">In</span> <span class="id" type="var">u</span> <span class="id" type="var">l</span>).<br/>
<span class="id" type="tactic">subst</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">IH</span> <span class="id" type="var">u</span> <span class="id" type="var">u_in_l</span> <span class="id" type="var">u'</span> <span class="id" type="var">H2</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">t1</span> [<span class="id" type="var">t2</span> [<span class="id" type="var">K1</span> <span class="id" type="var">K2</span>]]].<br/>
<span class="id" type="var">exists</span> <span class="id" type="var">t1</span>; <span class="id" type="var">exists</span> <span class="id" type="var">t2</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">in_context</span>.<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">IH</span> <span class="id" type="var">K</span> <span class="id" type="var">H1</span> <span class="id" type="var">u_in_l</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">l</span> <span class="id" type="var">l1</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">k1</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">a1</span> <span class="id" type="var">k1</span>].<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHk1</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">one_step_one_step</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">one_step</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">s</span> <span class="id" type="var">t</span> &lt;-&gt; <span class="id" type="var">one_step</span> <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="var">revert</span> <span class="id" type="var">s</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">s</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">K</span> | ]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">K</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">sigma</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">H3</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H1</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">s1</span> <span class="id" type="var">s2</span> <span class="id" type="var">K</span> | <span class="id" type="var">f</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">K</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">K</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">s1</span> <span class="id" type="var">s2</span> <span class="id" type="var">tau</span> <span class="id" type="var">K1</span> <span class="id" type="var">K2</span> <span class="id" type="var">K3</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">subst_comp_is_subst_comp</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">at_top</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">IHl</span> <span class="id" type="var">s</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">K</span> | <span class="id" type="var">g</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">K1</span> <span class="id" type="var">K2</span> <span class="id" type="var">K3</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">K</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">sigma</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">H3</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H1</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">s1</span> <span class="id" type="var">s2</span> <span class="id" type="var">K</span> | <span class="id" type="var">g</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">K</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">K</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">s1</span> <span class="id" type="var">s2</span> <span class="id" type="var">tau</span> <span class="id" type="var">K1</span> <span class="id" type="var">K2</span> <span class="id" type="var">K3</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">subst_comp_is_subst_comp</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">at_top</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="var">right</span>.<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">H3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H3</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="var">revert</span> <span class="id" type="var">sigma</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">K</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">l</span> <span class="id" type="var">K</span> | <span class="id" type="var">t</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">K</span>]; <span class="id" type="tactic">intros</span> <span class="id" type="var">sigma</span> <span class="id" type="var">IHl</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>; [<span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span> | <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>; <span class="id" type="tactic">assumption</span>].<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">IHK</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">tail_prop</span> <span class="id" type="var">_</span> <span class="id" type="var">IHl</span>)).<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">revert</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">K1</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">l</span> <span class="id" type="var">K</span> | <span class="id" type="var">t</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">K</span>]; <span class="id" type="tactic">intros</span> <span class="id" type="var">IHl</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>; [<span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span> | <span class="id" type="tactic">assumption</span>].<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">IHK</span> (<span class="id" type="var">tail_prop</span> <span class="id" type="var">_</span> <span class="id" type="var">IHl</span>)).<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">instance</span> <span class="id" type="var">_</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">nil</span> <span class="id" type="var">H</span>); <span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> <span class="id" type="var">empty_subst_is_id</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">R_in_rwr_R</span> : <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> (<span class="id" type="var">R</span> : <span class="id" type="var">term</span> -&gt; <span class="id" type="var">term</span> -&gt; <span class="id" type="keyword">Prop</span>),<br/>
&nbsp;&nbsp;<span class="id" type="var">R</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; <span class="id" type="var">rwr</span> <span class="id" type="var">R</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">R</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">t_step</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">at_top</span>; <br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">instance</span> <span class="id" type="var">R</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">nil</span> <span class="id" type="var">H</span>); <span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> <span class="id" type="var">empty_subst_is_id</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">no_need_of_instance'</span> : <span class="id" type="keyword">forall</span> (<span class="id" type="var">R</span> : <span class="id" type="var">relation</span> <span class="id" type="var">term</span>) <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">R</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; <span class="id" type="var">axiom</span> <span class="id" type="var">R</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">replace</span> <span class="id" type="var">t1</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">nil</span> <span class="id" type="var">t1</span>); [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">apply</span> <span class="id" type="var">empty_subst_is_id</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">replace</span> <span class="id" type="var">t2</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">nil</span> <span class="id" type="var">t2</span>); [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">apply</span> <span class="id" type="var">empty_subst_is_id</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Notation</span> " T '-[' R '+]-&gt;' U " := (<span class="id" type="var">rwr</span> <span class="id" type="var">R</span> <span class="id" type="var">T</span> <span class="id" type="var">U</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80) : <span class="id" type="var">term_scope</span> .<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Hint</span> <span class="id" type="var">Constructors</span> <span class="id" type="var">axiom</span> <span class="id" type="var">one_step</span> <span class="id" type="var">one_step_list</span> <span class="id" type="var">trans_clos</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab40"></a><h3 class="section">Rewriting is a congruence.</h3>

</div>
<div class="code">
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">context_cons</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">l</span>, <span class="id" type="var">rwr</span> <span class="id" type="var">R</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; <span class="id" type="var">rwr</span> <span class="id" type="var">R</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t1</span> :: <span class="id" type="var">l</span>)) (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t2</span> :: <span class="id" type="var">l</span>)).<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">l</span> <span class="id" type="var">H</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">t3</span> <span class="id" type="var">Trans1</span> <span class="id" type="var">Trans2</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_context</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">t_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">t2</span> :: <span class="id" type="var">l</span>)); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">in_context</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">one_step_context_in</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">l'</span>, <span class="id" type="var">one_step</span> <span class="id" type="var">R</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">one_step</span> <span class="id" type="var">R</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">l</span> ++ <span class="id" type="var">t1</span> :: <span class="id" type="var">l'</span>)) (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">l</span> ++ <span class="id" type="var">t2</span> :: <span class="id" type="var">l'</span>)).<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">l'</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_context</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span> ]; <span class="id" type="tactic">simpl</span>; [ <span class="id" type="tactic">apply</span> <span class="id" type="var">head_step</span> | <span class="id" type="tactic">apply</span> <span class="id" type="var">tail_step</span> ]; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">context_in</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">rwr</span> <span class="id" type="var">R</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">l'</span>, <span class="id" type="var">rwr</span> <span class="id" type="var">R</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">l</span> ++ <span class="id" type="var">t1</span> :: <span class="id" type="var">l'</span>)) (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">l</span> ++ <span class="id" type="var">t2</span> :: <span class="id" type="var">l'</span>)).<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">Step</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">t3</span> <span class="id" type="var">Trans1</span> <span class="id" type="var">Trans2</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">l'</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">t_step</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">one_step_context_in</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">l'</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">t_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">l</span> ++ <span class="id" type="var">t2</span> :: <span class="id" type="var">l'</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">in_context</span>; <span class="id" type="tactic">clear</span> - <span class="id" type="var">Trans1</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">l</span>; [<span class="id" type="var">left</span> | <span class="id" type="var">right</span>]; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHTrans2</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">general_context</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>, <span class="id" type="var">rwr_list</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> -&gt; <span class="id" type="var">rwr</span> <span class="id" type="var">R</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span>) (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l2</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">H</span> | <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">l3</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span>].<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="var">right</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l2</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab41"></a><h3 class="section">Compatibility with substitutions.</h3>

</div>
<div class="code">
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">one_step_apply_subst</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">sigma</span> , <span class="id" type="var">one_step</span> <span class="id" type="var">R</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">one_step</span> <span class="id" type="var">R</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t1</span>) (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t2</span>).<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x1</span> <span class="id" type="var">t2</span> <span class="id" type="var">sigma</span> <span class="id" type="var">H</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion_clear</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">t1'</span> <span class="id" type="var">t2'</span> <span class="id" type="var">H'</span>|];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion_clear</span> <span class="id" type="var">H'</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">t1'</span> <span class="id" type="var">t2'</span> <span class="id" type="var">tau</span> <span class="id" type="var">H''</span>];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">do</span> 2 (<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">subst_comp_is_subst_comp</span>); <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">f1</span> <span class="id" type="var">l1</span> <span class="id" type="var">Hrec</span> <span class="id" type="var">t2</span> <span class="id" type="var">sigma</span> <span class="id" type="var">H</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion_clear</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">t1'</span> <span class="id" type="var">t2'</span> <span class="id" type="var">H'</span>| <span class="id" type="var">f</span> <span class="id" type="var">l1'</span> <span class="id" type="var">l2</span> <span class="id" type="var">H''</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion_clear</span> <span class="id" type="var">H'</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">t1'</span> <span class="id" type="var">t2'</span> <span class="id" type="var">tau</span> <span class="id" type="var">H''</span>]; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">do</span> 2 (<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">subst_comp_is_subst_comp</span>); <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_context</span>; <span class="id" type="tactic">generalize</span> <span class="id" type="var">l2</span> <span class="id" type="var">H''</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">l2</span> <span class="id" type="var">H''</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">l1</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">a1</span> <span class="id" type="var">l1</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">l2</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">inversion_clear</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">l2'</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">inversion_clear</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">t1'</span> <span class="id" type="var">a2</span> <span class="id" type="var">l</span> <span class="id" type="var">H'</span> | <span class="id" type="var">t'</span> <span class="id" type="var">l1'</span> <span class="id" type="var">l2</span> <span class="id" type="var">H'</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">head_step</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Hrec</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">tail_step</span>;  <span class="id" type="tactic">apply</span> <span class="id" type="var">IHl1</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">intros</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Hrec</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">one_step_subterm_subst</span> :<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">sigma</span>, <br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">refl_trans_clos</span> (<span class="id" type="var">union</span> <span class="id" type="var">_</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) (<span class="id" type="var">direct_subterm</span>)) <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">refl_trans_clos</span> (<span class="id" type="var">union</span> <span class="id" type="var">_</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) (<span class="id" type="var">direct_subterm</span>)) (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">s</span>) (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">sigma</span> [<span class="id" type="var">s'</span> | <span class="id" type="var">s'</span> <span class="id" type="var">t'</span> <span class="id" type="var">H</span>].<br/>
<span class="id" type="var">left</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1</span> <span class="id" type="var">t2</span> [<span class="id" type="var">H</span> | <span class="id" type="var">H</span>] | <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">t3</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span>].<br/>
<span class="id" type="tactic">do</span> 2 <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">one_step_apply_subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v2</span> | <span class="id" type="var">f2</span> <span class="id" type="var">l2</span>].<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> <span class="id" type="var">t1</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">trans_clos_is_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t2</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">H1</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">H1</span> | <span class="id" type="var">H1</span>].<br/>
<span class="id" type="tactic">do</span> 2 <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">one_step_apply_subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v2</span> | <span class="id" type="var">f2</span> <span class="id" type="var">l2</span>].<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H1</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> <span class="id" type="var">t1</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">rwr_apply_subst</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">sigma</span>, <span class="id" type="var">rwr</span> <span class="id" type="var">R</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">rwr</span> <span class="id" type="var">R</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t1</span>) (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t2</span>).<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">sigma</span> <span class="id" type="var">H</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">t3</span> <span class="id" type="var">H1</span> <span class="id" type="var">Hrec1</span> <span class="id" type="var">H2</span> <span class="id" type="var">Hrec2</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">t_step</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">one_step_apply_subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">t_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t2</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">one_step_apply_subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab42"></a><h3 class="section">Inclusion of relations and associated equational theories.</h3>

</div>
<div class="code">
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">rwr_inv</span> : <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">A</span> <span class="id" type="var">R</span> (<span class="id" type="var">eq</span> : <span class="id" type="var">A</span> -&gt; <span class="id" type="var">A</span> -&gt; <span class="id" type="keyword">Prop</span>) (<span class="id" type="var">f</span> : <span class="id" type="var">term</span> -&gt; <span class="id" type="var">A</span>), <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span> <span class="id" type="var">a3</span>, <span class="id" type="var">eq</span> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span> -&gt; <span class="id" type="var">eq</span> <span class="id" type="var">a2</span> <span class="id" type="var">a3</span> -&gt; <span class="id" type="var">eq</span> <span class="id" type="var">a1</span> <span class="id" type="var">a3</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">one_step</span> <span class="id" type="var">R</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; <span class="id" type="var">eq</span> (<span class="id" type="var">f</span> <span class="id" type="var">t1</span>) (<span class="id" type="var">f</span> <span class="id" type="var">t2</span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">rwr</span> <span class="id" type="var">R</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; <span class="id" type="var">eq</span> (<span class="id" type="var">f</span> <span class="id" type="var">t1</span>) (<span class="id" type="var">f</span> <span class="id" type="var">t2</span>).<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">A</span> <span class="id" type="var">R</span> <span class="id" type="var">eq</span> <span class="id" type="var">f</span> <span class="id" type="var">eq_trans</span> <span class="id" type="var">Step_inv</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">eq_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">f</span> <span class="id" type="var">y</span>); <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">axiom_incl</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> (<span class="id" type="var">R1</span> <span class="id" type="var">R2</span> : <span class="id" type="var">term</span> -&gt; <span class="id" type="var">term</span> -&gt; <span class="id" type="keyword">Prop</span>) , <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">R1</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; <span class="id" type="var">R2</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">axiom</span> <span class="id" type="var">R1</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; <span class="id" type="var">axiom</span> <span class="id" type="var">R2</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">R1</span> <span class="id" type="var">R2</span> <span class="id" type="var">Incl</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">one_step_incl</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> (<span class="id" type="var">R1</span> <span class="id" type="var">R2</span> : <span class="id" type="var">term</span> -&gt; <span class="id" type="var">term</span> -&gt; <span class="id" type="keyword">Prop</span>) , <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">R1</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; <span class="id" type="var">R2</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">one_step</span> <span class="id" type="var">R1</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; <span class="id" type="var">one_step</span> <span class="id" type="var">R2</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">R1</span> <span class="id" type="var">R2</span> <span class="id" type="var">Incl</span> <span class="id" type="var">t1</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">at_top</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">axiom_incl</span> <span class="id" type="keyword">with</span> <span class="id" type="var">R1</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">f1</span> <span class="id" type="var">l1</span> <span class="id" type="var">Hrec</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">inversion_clear</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [| <span class="id" type="var">f</span> <span class="id" type="var">l1'</span> <span class="id" type="var">l2</span> <span class="id" type="var">H'</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">at_top</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">axiom_incl</span> <span class="id" type="keyword">with</span> <span class="id" type="var">R1</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">in_context</span>; <span class="id" type="tactic">generalize</span> <span class="id" type="var">l2</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">l2</span> <span class="id" type="var">H'</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">l1</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">a1</span> <span class="id" type="var">l1</span> ]; <span class="id" type="tactic">intros</span> <span class="id" type="var">l2</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">inversion_clear</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">head_step</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Hrec</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">tail_step</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHl1</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Hrec</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">rwr_incl</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> (<span class="id" type="var">R1</span> <span class="id" type="var">R2</span> : <span class="id" type="var">term</span> -&gt; <span class="id" type="var">term</span> -&gt; <span class="id" type="keyword">Prop</span>), <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">R1</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; <span class="id" type="var">R2</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">rwr</span> <span class="id" type="var">R1</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; <span class="id" type="var">rwr</span> <span class="id" type="var">R2</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">R1</span> <span class="id" type="var">R2</span> <span class="id" type="var">Incl</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">t_step</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">one_step_incl</span> <span class="id" type="keyword">with</span> <span class="id" type="var">R1</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">t_trans</span> <span class="id" type="keyword">with</span> <span class="id" type="var">y</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">one_step_incl</span> <span class="id" type="keyword">with</span> <span class="id" type="var">R1</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">rwr_list_incl</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> (<span class="id" type="var">R1</span> <span class="id" type="var">R2</span> : <span class="id" type="var">term</span> -&gt; <span class="id" type="var">term</span> -&gt; <span class="id" type="keyword">Prop</span>), <br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">R1</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; <span class="id" type="var">R2</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>, <span class="id" type="var">rwr_list</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R1</span>) <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> -&gt; <span class="id" type="var">rwr_list</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R2</span>) <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R1</span> <span class="id" type="var">R2</span> <span class="id" type="var">Incl</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">trans_incl</span>.<br/>
<span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">intro</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">one_step_list_incl</span>.<br/>
<span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">intro</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">one_step_incl</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">th_eq_closure_one_step</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> (<span class="id" type="var">R</span> : <span class="id" type="var">term</span> -&gt; <span class="id" type="var">term</span> -&gt; <span class="id" type="keyword">Prop</span>), <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">one_step</span> (<span class="id" type="var">rwr</span> <span class="id" type="var">R</span>) <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; <span class="id" type="var">rwr</span> <span class="id" type="var">R</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">t1</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t1</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">x1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">inversion_clear</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">t1'</span> <span class="id" type="var">t2'</span> <span class="id" type="var">H'</span> | ];<br/>
<span class="id" type="tactic">inversion_clear</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">rwr_apply_subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f1</span> <span class="id" type="var">l1</span> <span class="id" type="var">Hrec</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">inversion_clear</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">t1'</span> <span class="id" type="var">t2'</span> <span class="id" type="var">H'</span> | <span class="id" type="var">f'</span> <span class="id" type="var">l1'</span> <span class="id" type="var">l2</span> <span class="id" type="var">H'</span>].<br/>
<span class="id" type="tactic">inversion_clear</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">rwr_apply_subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">general_context</span>; <span class="id" type="tactic">generalize</span> <span class="id" type="var">l2</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">l2</span> <span class="id" type="var">H'</span>.<br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">l1</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">a1</span> <span class="id" type="var">l1</span> ]; <span class="id" type="tactic">intros</span> <span class="id" type="var">l2</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">H1</span> <span class="id" type="var">a2</span> <span class="id" type="var">H3</span> <span class="id" type="var">a1_R_a2</span> <span class="id" type="var">H5</span> <span class="id" type="var">H6</span> | <span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">l2'</span> <span class="id" type="var">l1_R_l2'</span> <span class="id" type="var">H5</span> <span class="id" type="var">H6</span>]; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">Hrec</span> <span class="id" type="var">_</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) <span class="id" type="var">_</span> <span class="id" type="var">a1_R_a2</span>).<br/>
<span class="id" type="tactic">clear</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">a1</span> <span class="id" type="var">a2</span> <span class="id" type="var">H</span> | <span class="id" type="var">a1</span> <span class="id" type="var">a2</span> <span class="id" type="var">a3</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span>].<br/>
<span class="id" type="tactic">do</span> 2 <span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="var">right</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">a2</span> :: <span class="id" type="var">l1</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">IHl1</span> (<span class="id" type="var">tail_prop</span> <span class="id" type="var">_</span> <span class="id" type="var">Hrec</span>) <span class="id" type="var">l2'</span> <span class="id" type="var">l1_R_l2'</span>).<br/>
<span class="id" type="tactic">clear</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">H</span> | <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">l3</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span>].<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">trans_clos_is_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">a1</span> :: <span class="id" type="var">l2</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">th_eq_closure</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> (<span class="id" type="var">R</span> : <span class="id" type="var">term</span> -&gt; <span class="id" type="var">term</span> -&gt; <span class="id" type="keyword">Prop</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">rwr</span> (<span class="id" type="var">rwr</span> <span class="id" type="var">R</span>) <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; <span class="id" type="var">rwr</span> <span class="id" type="var">R</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">R</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">th_eq_closure_one_step</span> <span class="id" type="var">R</span>); <span class="id" type="tactic">unfold</span> <span class="id" type="var">rwr</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span>  (<span class="id" type="var">trans_clos_is_trans</span> (<span class="id" type="var">R</span> := <span class="id" type="var">one_step</span> <span class="id" type="var">R</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">trans_clos</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>)); <span class="id" type="tactic">clear</span> <span class="id" type="var">R</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">rwr_R</span> <span class="id" type="var">rwr_R_trans</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">rwr_R_step</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [ | ]; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">rwr_R_trans</span> <span class="id" type="keyword">with</span> <span class="id" type="var">y</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">rwr_at_pos</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">p</span> <span class="id" type="var">t</span> <span class="id" type="var">sigma</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span> <span class="id" type="var">t'</span>, <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">u</span>) -&gt; <br/>
&nbsp;&nbsp;<span class="id" type="var">rwr</span> <span class="id" type="var">R</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span> -&gt; <span class="id" type="var">t'</span> = (<span class="id" type="var">replace_at_pos</span> <span class="id" type="var">t</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">v</span>) <span class="id" type="var">p</span>) -&gt; <span class="id" type="var">rwr</span> <span class="id" type="var">R</span> <span class="id" type="var">t</span> <span class="id" type="var">t'</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">p</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">p</span>]; <span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">sigma</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span> <span class="id" type="var">t'</span> <span class="id" type="var">Sbt</span> <span class="id" type="var">H</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Sbt</span>.<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">Sbt</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">Sbt</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">th_eq_closure</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">t_step</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">at_top</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x</span> | <span class="id" type="var">f</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">t'</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">general_context</span>.<br/>
<span class="id" type="var">revert</span> <span class="id" type="var">l</span> <span class="id" type="var">Sbt</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">i</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span>]; <span class="id" type="tactic">intros</span> [ | <span class="id" type="var">s</span> <span class="id" type="var">l</span>] <span class="id" type="var">Sbt</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Sbt</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">IHp</span> <span class="id" type="var">s</span> <span class="id" type="var">sigma</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span> <span class="id" type="var">_</span> <span class="id" type="var">Sbt</span> <span class="id" type="var">H</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)).<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">replace_at_pos</span> <span class="id" type="var">s</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">v</span>) <span class="id" type="var">p</span>); <span class="id" type="tactic">clear</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span> | <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">t3</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span>].<br/>
<span class="id" type="tactic">do</span> 2 <span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="var">right</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">t2</span> :: <span class="id" type="var">l</span>); [<span class="id" type="var">left</span> | <span class="id" type="var">idtac</span>]; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Sbt</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">IHi</span> <span class="id" type="var">_</span> <span class="id" type="var">Sbt</span>); <span class="id" type="tactic">clear</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">H</span> | <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">l3</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span>].<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">trans_clos_is_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">s</span> :: <span class="id" type="var">l2</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">split_rel</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R1</span> <span class="id" type="var">R2</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">one_step</span> (<span class="id" type="var">union</span> <span class="id" type="var">_</span> <span class="id" type="var">R1</span> <span class="id" type="var">R2</span>) <span class="id" type="var">t</span> <span class="id" type="var">s</span> &lt;-&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">one_step</span> <span class="id" type="var">R1</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span> \/ <span class="id" type="var">one_step</span> <span class="id" type="var">R2</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span>).<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">R1</span> <span class="id" type="var">R2</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec2</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">s</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">n</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">n</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">n</span>]; <span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">Size_s</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">absurd</span> (1 &lt;= 0); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">le_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">size</span> <span class="id" type="var">s</span>); <span class="id" type="tactic">trivial</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">size_ge_one</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">s'</span> <span class="id" type="var">t'</span> <span class="id" type="var">H'</span> | <span class="id" type="var">f'</span> <span class="id" type="var">lt</span> <span class="id" type="var">ls</span> <span class="id" type="var">H'</span>]; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t'</span> <span class="id" type="var">s'</span> <span class="id" type="var">sigma</span> <span class="id" type="var">H''</span>]; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">H''</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">K1</span> | <span class="id" type="var">K2</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">at_top</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">right</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">at_top</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">Size_ls</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">s</span>, <span class="id" type="var">In</span> <span class="id" type="var">s</span> <span class="id" type="var">ls</span> -&gt; <span class="id" type="var">size</span> <span class="id" type="var">s</span> &lt;= <span class="id" type="var">n</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">s_in_ls</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">le_S_n</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">le_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">size</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f'</span> <span class="id" type="var">ls</span>)); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">size_direct_subterm</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">clear</span> <span class="id" type="var">H</span> <span class="id" type="var">Size_s</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">H''</span> : <span class="id" type="var">one_step_list</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R1</span>) <span class="id" type="var">lt</span> <span class="id" type="var">ls</span> \/<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">one_step_list</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R2</span>) <span class="id" type="var">lt</span> <span class="id" type="var">ls</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">H'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t'</span> <span class="id" type="var">s'</span> <span class="id" type="var">l</span> <span class="id" type="var">H''</span> | <span class="id" type="var">s</span> <span class="id" type="var">lt'</span> <span class="id" type="var">ls'</span> <span class="id" type="var">H''</span>]; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">IHn</span> <span class="id" type="var">s'</span> (<span class="id" type="var">Size_ls</span> <span class="id" type="var">s'</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>))) <span class="id" type="var">t'</span>) <span class="id" type="keyword">in</span> <span class="id" type="var">H''</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">H''</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">H1</span> | <span class="id" type="var">H2</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">head_step</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">right</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">head_step</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">IHH''</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">H1</span> | <span class="id" type="var">H2</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Size_ls</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">tail_step</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">right</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">tail_step</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">H''</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">H1</span> | <span class="id" type="var">H2</span>]; [<span class="id" type="var">left</span> | <span class="id" type="var">right</span>]; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_context</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">H1</span> | <span class="id" type="var">H2</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">one_step_incl</span> <span class="id" type="keyword">with</span> <span class="id" type="var">R1</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">one_step_incl</span> <span class="id" type="keyword">with</span> <span class="id" type="var">R2</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">no_need_of_instance_is_modular</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> (<span class="id" type="var">R1</span> <span class="id" type="var">R2</span> : <span class="id" type="var">term</span> -&gt; <span class="id" type="var">term</span> -&gt; <span class="id" type="keyword">Prop</span>), <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">axiom</span> <span class="id" type="var">R1</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; <span class="id" type="var">R1</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">axiom</span> <span class="id" type="var">R2</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; <span class="id" type="var">R2</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">axiom</span> (<span class="id" type="var">union</span> <span class="id" type="var">term</span> <span class="id" type="var">R1</span> <span class="id" type="var">R2</span>) <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; (<span class="id" type="var">union</span> <span class="id" type="var">term</span> <span class="id" type="var">R1</span> <span class="id" type="var">R2</span>) <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>).<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">R1</span> <span class="id" type="var">R2</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1'</span> <span class="id" type="var">t2'</span> <span class="id" type="var">sigma</span> <span class="id" type="var">H'</span>]; <span class="id" type="tactic">subst</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H'</span>; [<span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H1</span> | <span class="id" type="var">right</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H2</span>];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <span class="id" type="var">sym_refl</span> <span class="id" type="var">R</span> (<span class="id" type="var">t1</span> <span class="id" type="var">t2</span> : <span class="id" type="var">term</span>) := <span class="id" type="var">R</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> \/ <span class="id" type="var">R</span> <span class="id" type="var">t2</span> <span class="id" type="var">t1</span> \/ <span class="id" type="var">t1</span> = <span class="id" type="var">t2</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <span class="id" type="var">th_eq</span> <span class="id" type="var">R</span> := <span class="id" type="var">rwr</span> (<span class="id" type="var">sym_refl</span> <span class="id" type="var">R</span>).<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Notation</span> " T '&lt;-[' R '*]-&gt;' U " := (<span class="id" type="var">th_eq</span> <span class="id" type="var">R</span> <span class="id" type="var">T</span> <span class="id" type="var">U</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80) : <span class="id" type="var">term_scope</span> .<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">th_refl</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">t</span>, <span class="id" type="var">th_eq</span> <span class="id" type="var">R</span> <span class="id" type="var">t</span> <span class="id" type="var">t</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">th_eq</span>, <span class="id" type="var">sym_refl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">t_step</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">at_top</span>; <span class="id" type="tactic">rewrite</span> &lt;- (<span class="id" type="var">empty_subst_is_id</span> <span class="id" type="var">t</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>; <span class="id" type="var">right</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">th_sym</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">th_eq</span> <span class="id" type="var">R</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; <span class="id" type="var">th_eq</span> <span class="id" type="var">R</span> <span class="id" type="var">t2</span> <span class="id" type="var">t1</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">R</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">refine</span> (<span class="id" type="var">rwr_inv</span> <span class="id" type="var">term</span> (<span class="id" type="var">sym_refl</span> <span class="id" type="var">R</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">fun</span> <span class="id" type="var">u1</span> <span class="id" type="var">u2</span> =&gt; <span class="id" type="var">th_eq</span> <span class="id" type="var">R</span> <span class="id" type="var">u2</span> <span class="id" type="var">u1</span>) (<span class="id" type="keyword">fun</span> <span class="id" type="var">t</span> =&gt; <span class="id" type="var">t</span>) <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">th_eq</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">trans_clos_is_trans</span> <span class="id" type="keyword">with</span> <span class="id" type="var">a2</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">th_eq</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">t_step</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">axiom_sym</span> : <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">axiom</span> (<span class="id" type="var">sym_refl</span> <span class="id" type="var">R</span>) <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; <span class="id" type="var">axiom</span> (<span class="id" type="var">sym_refl</span> <span class="id" type="var">R</span>) <span class="id" type="var">t2</span> <span class="id" type="var">t1</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">clear</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">inversion_clear</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">u1</span> <span class="id" type="var">u2</span> <span class="id" type="var">sigma</span> <span class="id" type="var">H'</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">H'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">H'</span> | [<span class="id" type="var">H'</span> | <span class="id" type="var">H'</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>; <span class="id" type="var">right</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">v1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">inversion_clear</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">H'</span> | <span class="id" type="var">f</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">H'</span> ].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">at_top</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">axiom_sym</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span> <span class="id" type="var">IH</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">inversion_clear</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">H'</span> | <span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">l2</span> <span class="id" type="var">H'</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">at_top</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">axiom_sym</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">in_context</span>; <span class="id" type="tactic">generalize</span> <span class="id" type="var">l2</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">f</span> <span class="id" type="var">t2</span> <span class="id" type="var">l2</span> <span class="id" type="var">H'</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">l1</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t1</span> <span class="id" type="var">l1</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">l2</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">H'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> [ | <span class="id" type="var">t2</span> <span class="id" type="var">l2</span>] <span class="id" type="var">H'</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion_clear</span> <span class="id" type="var">H'</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">H''</span> | <span class="id" type="var">f</span> <span class="id" type="var">l1'</span> <span class="id" type="var">l2'</span> <span class="id" type="var">H''</span> ].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">head_step</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IH</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">tail_step</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHl1</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IH</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>

<br/>
</div>

<div class="doc">
<a name="lab43"></a><h3 class="section">Accessibility of the rewriting relation.</h3>

</div>
<div class="code">
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">acc_one_step</span> : <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">t</span>, <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span> &lt;-&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">rwr</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">acc_trans</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_incl</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">rwr_sub_acc_sub_acc_sub</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>, <span class="id" type="var">refl_trans_clos</span> (<span class="id" type="var">one_step_list</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>)) <span class="id" type="var">l2</span> <span class="id" type="var">l1</span> -&gt; <br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span>, <span class="id" type="var">In</span> <span class="id" type="var">s</span> <span class="id" type="var">l1</span> -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">s</span>) -&gt; (<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span>, <span class="id" type="var">In</span> <span class="id" type="var">s</span> <span class="id" type="var">l2</span> -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">s</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>, <span class="id" type="var">one_step_list</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">l2</span> <span class="id" type="var">l1</span> -&gt; <br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span>, <span class="id" type="var">In</span> <span class="id" type="var">s</span> <span class="id" type="var">l1</span> -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">s</span>) -&gt; (<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span>, <span class="id" type="var">In</span> <span class="id" type="var">s</span> <span class="id" type="var">l2</span> -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">s</span>)).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">Hacc</span> <span class="id" type="var">s</span> [<span class="id" type="var">s_eq_t1</span> | <span class="id" type="var">s_in_l</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_inv</span> <span class="id" type="keyword">with</span> <span class="id" type="var">t2</span>; [<span class="id" type="tactic">apply</span> <span class="id" type="var">Hacc</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span> | <span class="id" type="tactic">subst</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">assumption</span> ].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Hacc</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">Hacc</span> <span class="id" type="var">s</span> [<span class="id" type="var">s_eq_t</span> | <span class="id" type="var">s_in_l1</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Hacc</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHone_step_list</span>; [ <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Hacc</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span> | <span class="id" type="tactic">assumption</span>].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">H0</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">H1</span> | <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">l3</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H3</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span> <span class="id" type="keyword">with</span> <span class="id" type="var">l2</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHH2</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">acc_subterms</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">t</span>, ~ (<span class="id" type="var">R</span> <span class="id" type="var">t</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>))) -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span>) -&gt; <span class="id" type="var">constructor</span> <span class="id" type="var">R</span> <span class="id" type="var">f</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>).<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">HR</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">Acc_l</span> <span class="id" type="var">Cf'</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">Cf'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">f'</span> <span class="id" type="var">Cf</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">Cf'</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">f'</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">acc_one_step_list</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Acc_l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">pattern</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">refine</span> (@<span class="id" type="var">Acc_ind</span> <span class="id" type="var">_</span> (<span class="id" type="var">one_step_list</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>)) <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">l</span> <span class="id" type="var">Acc_l</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">clear</span> <span class="id" type="var">l</span> <span class="id" type="var">Acc_l</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">l</span> <span class="id" type="var">Acc_l</span> <span class="id" type="var">IH</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H'</span> | <span class="id" type="var">f'</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">H'</span>]; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">sigma</span> <span class="id" type="var">H''</span> <span class="id" type="var">H3</span> <span class="id" type="var">H'''</span>]; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">t2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x2</span> | <span class="id" type="var">f2</span> <span class="id" type="var">l2</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">absurd</span> (<span class="id" type="var">R</span> <span class="id" type="var">t1</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x2</span>)); <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">HR</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H'''</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">H'''</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H'''</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">absurd</span> (<span class="id" type="var">R</span> <span class="id" type="var">t1</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l2</span>)); <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Cf</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IH</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> <span class="id" type="var">l1</span> <span class="id" type="var">l</span> <span class="id" type="var">H'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">k</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">k</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">s</span> <span class="id" type="var">k</span>]; <span class="id" type="tactic">intros</span> <span class="id" type="var">k'</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">head_step</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">tail_step</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">acc_subterms_1</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span>, <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span> -&gt; <span class="id" type="var">direct_subterm</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">s</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span> <span class="id" type="var">Acc_t</span>; <span class="id" type="tactic">generalize</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">refine</span> (@<span class="id" type="var">Acc_ind</span> <span class="id" type="var">_</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">t</span> <span class="id" type="var">Acc_t</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">clear</span> <span class="id" type="var">t</span> <span class="id" type="var">Acc_t</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">Acc_t</span> <span class="id" type="var">IH</span> <span class="id" type="var">s</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">x</span> | <span class="id" type="var">f</span> <span class="id" type="var">l</span>]; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">H'</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">In_split</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">l1</span> [<span class="id" type="var">l2</span> <span class="id" type="var">H''</span>]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">l</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">IH</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">l1</span> ++ <span class="id" type="var">u</span> :: <span class="id" type="var">l2</span>))).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">one_step_context_in</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">acc_subterms_3</span> : <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">p</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span>, <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span> -&gt; <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> <span class="id" type="var">s</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">s</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">p</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">p</span>]; <span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span> <span class="id" type="var">Acc_t</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intro</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">x</span> | <span class="id" type="var">f</span> <span class="id" type="var">l</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">H'</span> := <span class="id" type="var">nth_error_ok_in</span> <span class="id" type="var">i</span> <span class="id" type="var">l</span>); <span class="id" type="tactic">destruct</span> (<span class="id" type="var">nth_error</span> <span class="id" type="var">l</span> <span class="id" type="var">i</span>) <span class="id" type="keyword">as</span> [ <span class="id" type="var">s'</span> | ].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">H'</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)); <span class="id" type="tactic">clear</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">s'_in_l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">IHp</span> <span class="id" type="var">s'</span>); <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">acc_subterms_1</span> <span class="id" type="var">R</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">s'_in_l</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">l1</span> [<span class="id" type="var">l2</span> [<span class="id" type="var">_</span> <span class="id" type="var">H'</span>]]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">simpl</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">acc_with_subterm_subterms</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">t</span>, <span class="id" type="var">Acc</span> (<span class="id" type="var">union</span> <span class="id" type="var">_</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">direct_subterm</span>) <span class="id" type="var">t</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span>, <span class="id" type="var">direct_subterm</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Acc</span> (<span class="id" type="var">union</span> <span class="id" type="var">_</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">direct_subterm</span>) <span class="id" type="var">s</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">t</span> <span class="id" type="var">Acc_t</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">Acc_t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t</span> <span class="id" type="var">Acc_t</span> <span class="id" type="var">IH</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_t</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">acc_with_subterm</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">t</span>, <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span> &lt;-&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Acc</span> (<span class="id" type="var">union</span> <span class="id" type="var">_</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">direct_subterm</span>) <span class="id" type="var">t</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">Acc_t</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">Acc_t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t</span> <span class="id" type="var">Acc_t</span> <span class="id" type="var">IH</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> <span class="id" type="var">Acc_t</span> <span class="id" type="var">IH</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">Acc_t</span> <span class="id" type="var">IH</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec2</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">n</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">n</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">n</span>]; <span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">size_t</span> <span class="id" type="var">Acc_t</span> <span class="id" type="var">IH</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">absurd</span> (1 &lt;= 0); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">le_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">size</span> <span class="id" type="var">t</span>); <span class="id" type="tactic">trivial</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">size_ge_one</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">H</span> | <span class="id" type="var">H</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IH</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHn</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">le_S_n</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">le_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">size</span> <span class="id" type="var">t</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">size_direct_subterm</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">H'</span> : <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">u</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">acc_subterms_1</span> <span class="id" type="keyword">with</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_t</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_R_u</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">x</span> | <span class="id" type="var">f</span> <span class="id" type="var">l</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">In_split</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">l'</span> [<span class="id" type="var">l''</span> <span class="id" type="var">H''</span>]]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">acc_with_subterm_subterms</span> <span class="id" type="var">R</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">l'</span> ++ <span class="id" type="var">v</span> :: <span class="id" type="var">l''</span>))).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IH</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">one_step_context_in</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_incl</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">var_acc</span> : <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">l</span> <span class="id" type="var">x</span> <span class="id" type="var">sigma</span>, <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list_list</span> <span class="id" type="var">l</span>) -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> (<span class="id" type="var">map</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">l</span>) -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>)).<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">list_rec3</span> <span class="id" type="var">size</span>); <span class="id" type="tactic">clear</span> <span class="id" type="var">l</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">n</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">n</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">n</span>]; <span class="id" type="tactic">intros</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span>] <span class="id" type="var">Sl</span> <span class="id" type="var">x</span> <span class="id" type="var">sigma</span> <span class="id" type="var">H</span> <span class="id" type="var">Acc_l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="var">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Sl</span>; <span class="id" type="var">absurd</span> (1 &lt;= 0); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">le_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">size</span> <span class="id" type="var">t</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">size_ge_one</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">refine</span> (<span class="id" type="var">le_trans</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">Sl</span>); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="var">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">Sl'</span> : <span class="id" type="var">list_size</span> <span class="id" type="var">size</span> <span class="id" type="var">l</span> &lt;= <span class="id" type="var">n</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">le_S_n</span>; <span class="id" type="tactic">refine</span> (<span class="id" type="var">le_trans</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">Sl</span>); <span class="id" type="tactic">simpl</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">plus_le_compat_r</span> 1 (<span class="id" type="var">size</span> <span class="id" type="var">t</span>) (<span class="id" type="var">list_size</span> <span class="id" type="var">size</span> <span class="id" type="var">l</span>)); <span class="id" type="tactic">apply</span> <span class="id" type="var">size_ge_one</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">y</span> | <span class="id" type="var">g</span> <span class="id" type="var">k</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">y_eq_x</span> | <span class="id" type="var">x_in_l</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">y</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_l</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="var">map</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">IHn</span> <span class="id" type="var">l</span>); <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_l</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="var">map</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">Sk</span> : <span class="id" type="var">list_size</span> <span class="id" type="var">size</span> <span class="id" type="var">k</span> &lt;= <span class="id" type="var">n</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">le_S_n</span>; <span class="id" type="tactic">refine</span> (<span class="id" type="var">le_trans</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">Sl</span>); <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">list_size_fold</span> <span class="id" type="var">size</span> <span class="id" type="var">k</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">le_n_S</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">le_plus_l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">Acc_k</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> (<span class="id" type="var">map</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">k</span>) -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">acc_subterms_1</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> (<span class="id" type="var">map</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">k</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_l</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="var">map</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">replace</span> (<span class="id" type="var">var_list_list</span> (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">k</span> :: <span class="id" type="var">l</span>)) <span class="id" type="keyword">with</span> (<span class="id" type="var">var_list</span> (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">k</span>)  ++ <span class="id" type="var">var_list_list</span> <span class="id" type="var">l</span>) <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_list_unfold</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">IHn</span> <span class="id" type="var">_</span> <span class="id" type="var">Sk</span> <span class="id" type="var">x</span> <span class="id" type="var">sigma</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">in_app_or</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">x_in_k</span> | <span class="id" type="var">x_in_l</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">H</span> <span class="id" type="var">x_in_k</span>); <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_k</span>; <span class="id" type="tactic">trivial</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">IHn</span> <span class="id" type="var">l</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_l</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">compute_head_red</span> <span class="id" type="var">s</span> <span class="id" type="var">rule_list</span> {<span class="id" type="keyword">struct</span> <span class="id" type="var">rule_list</span>} : <span class="id" type="var">list</span> <span class="id" type="var">term</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">rule_list</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">nil</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">l</span>,r) :: <span class="id" type="var">rule_list</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">matching</span> ((<span class="id" type="var">l</span>,s) :: <span class="id" type="var">nil</span>) <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Some</span> <span class="id" type="var">sigma</span> =&gt; (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">r</span>) :: <span class="id" type="var">compute_head_red</span> <span class="id" type="var">s</span> <span class="id" type="var">rule_list</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">None</span> =&gt; <span class="id" type="var">compute_head_red</span> <span class="id" type="var">s</span> <span class="id" type="var">rule_list</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">compute_head_red_is_correct</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">rule_list</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">l</span> <span class="id" type="var">r</span>, <span class="id" type="var">In</span> (<span class="id" type="var">l</span>,r) <span class="id" type="var">rule_list</span> -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">v</span>, <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">r</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">l</span>)) -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">l</span> <span class="id" type="var">r</span>, <span class="id" type="var">R</span> <span class="id" type="var">r</span> <span class="id" type="var">l</span> &lt;-&gt; <span class="id" type="var">In</span> (<span class="id" type="var">l</span>,r) <span class="id" type="var">rule_list</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span>, (<span class="id" type="var">In</span> <span class="id" type="var">s</span> (<span class="id" type="var">compute_head_red</span> <span class="id" type="var">t</span> <span class="id" type="var">rule_list</span>) &lt;-&gt; <span class="id" type="var">axiom</span> <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>).<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">rule_list</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">rule_list</span> <span class="id" type="keyword">as</span> [ | [<span class="id" type="var">l</span> <span class="id" type="var">r</span>] <span class="id" type="var">rule_list</span>];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">Reg</span> <span class="id" type="var">R</span> <span class="id" type="var">Equiv</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Equiv</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H0</span>; <span class="id" type="var">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">case_eq</span> (<span class="id" type="var">matching</span> ((<span class="id" type="var">l</span>,t) :: <span class="id" type="var">nil</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">sigma</span> <span class="id" type="var">mlt_eq_sigma</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">matching_correct</span> <span class="id" type="var">mlt_eq_sigma</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">C1</span> [<span class="id" type="var">C2</span> <span class="id" type="var">C3</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">H'</span> := <span class="id" type="var">C3</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>))).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">mlt_eq_sigma</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">H</span> | <span class="id" type="var">H</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Equiv</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">set</span> (<span class="id" type="var">R'</span> := <span class="id" type="keyword">fun</span> <span class="id" type="var">r</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">In</span> (<span class="id" type="var">l</span>,r) <span class="id" type="var">rule_list</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">axiom_incl</span> <span class="id" type="keyword">with</span> <span class="id" type="var">R'</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">l1</span> <span class="id" type="var">r1</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">R'</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Equiv</span>; <span class="id" type="tactic">intro</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">IHrule_list</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">l1</span> <span class="id" type="var">r1</span> <span class="id" type="var">l1r1_in_rule_list</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Reg</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">l1</span> <span class="id" type="var">r1</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">R'</span>; <span class="id" type="tactic">intuition</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">mlt_eq_none</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">mlt_eq_none</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">set</span> (<span class="id" type="var">R'</span> := <span class="id" type="keyword">fun</span> <span class="id" type="var">r</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">In</span> (<span class="id" type="var">l</span>,r) <span class="id" type="var">rule_list</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">axiom_incl</span> <span class="id" type="keyword">with</span> <span class="id" type="var">R'</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">l1</span> <span class="id" type="var">r1</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">R'</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Equiv</span>; <span class="id" type="tactic">intro</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">IHrule_list</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">l1</span> <span class="id" type="var">r1</span> <span class="id" type="var">l1r1_in_rule_list</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Reg</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">l1</span> <span class="id" type="var">r1</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">R'</span>; <span class="id" type="tactic">intuition</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Equiv</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">H0</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">H0</span> | <span class="id" type="var">H0</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">C</span> := @<span class="id" type="var">matching_correct</span> ((<span class="id" type="var">l</span>, <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">l</span>) :: <span class="id" type="var">nil</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">C'</span> := <span class="id" type="var">matching_complete</span> ((<span class="id" type="var">l</span>, <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">l</span>) :: <span class="id" type="var">nil</span>) <span class="id" type="var">sigma</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">matching</span> ((<span class="id" type="var">l</span>, <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">l</span>) :: <span class="id" type="var">nil</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">tau</span> | ].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">C</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)); <span class="id" type="tactic">clear</span> <span class="id" type="var">C</span>; <span class="id" type="tactic">intros</span> [<span class="id" type="var">C1</span> [<span class="id" type="var">C2</span> <span class="id" type="var">C3</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">left</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">H'</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">v</span>, <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">r</span>) -&gt; <span class="id" type="var">apply_subst</span> <span class="id" type="var">tau</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>) = <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_r</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">v_in_l</span> : <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">l</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Reg</span> <span class="id" type="keyword">with</span> <span class="id" type="var">r</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">C'</span> <span class="id" type="keyword">with</span> <span class="id" type="var">l</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">l</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span> [<span class="id" type="var">ps_eq_llsigma</span> | <span class="id" type="var">ps_in_nil</span>]; [<span class="id" type="var">idtac</span> | <span class="id" type="var">contradiction</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">ps_eq_llsigma</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> <span class="id" type="var">r</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">IH</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IH</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">k</span> <span class="id" type="var">IHl</span> <span class="id" type="var">IH</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">ll</span> =&gt; <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">ll</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">map_eq</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">a</span> <span class="id" type="var">a_in_k</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">In_split</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">a_in_k</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">k1</span> [<span class="id" type="var">k2</span> <span class="id" type="var">K</span>]]; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_a</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IH</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (@<span class="id" type="var">var_in_subterm</span> <span class="id" type="var">v</span> <span class="id" type="var">a</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">k1</span> ++ <span class="id" type="var">a</span> :: <span class="id" type="var">k2</span>)) (<span class="id" type="var">length</span> <span class="id" type="var">k1</span> :: <span class="id" type="var">nil</span>)); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">nth_error_at_pos</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> <span class="id" type="var">False</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">C'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span> [<span class="id" type="var">ps_eq_llsigma</span> | <span class="id" type="var">ps_in_nil</span>]; [<span class="id" type="var">idtac</span> | <span class="id" type="var">contradiction</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">ps_eq_llsigma</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">H'</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">l</span> <span class="id" type="var">r</span> : <span class="id" type="var">term</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">In</span> (<span class="id" type="var">l</span>, <span class="id" type="var">r</span>) <span class="id" type="var">rule_list</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">v</span> : <span class="id" type="var">variable</span>, <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">r</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">l</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">l1</span> <span class="id" type="var">r1</span> <span class="id" type="var">lr_in_rule_list</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Reg</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">matching</span> ((<span class="id" type="var">l</span>, <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t2</span>) :: <span class="id" type="var">nil</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">tau</span> | ]; [<span class="id" type="var">right</span> | <span class="id" type="var">idtac</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">set</span> (<span class="id" type="var">R'</span> := <span class="id" type="keyword">fun</span> <span class="id" type="var">r</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">In</span> (<span class="id" type="var">l</span>,r) <span class="id" type="var">rule_list</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">IHrule_list</span> <span class="id" type="var">H'</span> <span class="id" type="var">R'</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">R'</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">l1</span> <span class="id" type="var">r1</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">R'</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">set</span> (<span class="id" type="var">R'</span> := <span class="id" type="keyword">fun</span> <span class="id" type="var">r</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">In</span> (<span class="id" type="var">l</span>,r) <span class="id" type="var">rule_list</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">IHrule_list</span> <span class="id" type="var">H'</span> <span class="id" type="var">R'</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">R'</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">l1</span> <span class="id" type="var">r1</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">R'</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <span class="id" type="var">o_size</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> := <span class="id" type="var">size</span> <span class="id" type="var">t1</span> &lt; <span class="id" type="var">size</span> <span class="id" type="var">t2</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">wf_size</span> : <span class="id" type="var">well_founded</span> <span class="id" type="var">o_size</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">well_founded</span>, <span class="id" type="var">o_size</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">size</span> <span class="id" type="var">t</span>); <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">n</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">n</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">n</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">y</span> <span class="id" type="var">Abs</span>; <span class="id" type="var">absurd</span> (<span class="id" type="var">size</span> <span class="id" type="var">y</span> &lt; 0); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">y</span> <span class="id" type="var">Sy</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">Sy</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">Sx</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHn</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHn</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Defined</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">term_acc_subst</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">t</span> <span class="id" type="var">sigma</span>, <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>) -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">H</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">s</span>, <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">s</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span> <span class="id" type="var">sigma</span>, <span class="id" type="var">s</span> = (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>) -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">Acc_s</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">Acc_s</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">s</span> <span class="id" type="var">Acc_s</span> <span class="id" type="var">IH'</span>]; <span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">sigma</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">s</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">IH</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">u</span> <span class="id" type="var">tau</span>, <span class="id" type="var">one_step</span> <span class="id" type="var">R</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">tau</span> <span class="id" type="var">u</span>) (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">u</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">tau</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">IH'</span> <span class="id" type="var">_</span> <span class="id" type="var">H</span> <span class="id" type="var">u</span> <span class="id" type="var">tau</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">clear</span> <span class="id" type="var">IH'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">u_R_t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IH</span> <span class="id" type="keyword">with</span> <span class="id" type="var">sigma</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">one_step_apply_subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">t</span> <span class="id" type="var">sigma</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>) <span class="id" type="var">sigma</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">nf_one_step_subterm</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">t</span>, <span class="id" type="var">nf</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span> -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">s</span>, <span class="id" type="var">direct_subterm</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">nf</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">s</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">_</span> <span class="id" type="var">s</span> <span class="id" type="var">H</span>; <span class="id" type="var">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">IH</span> <span class="id" type="var">Hnf</span> <span class="id" type="var">s</span> <span class="id" type="var">s_in_l</span> <span class="id" type="var">u</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">In_split</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">s_in_l</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">l'</span> [<span class="id" type="var">l''</span> <span class="id" type="var">H'</span>]]; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">Hnf</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">l'</span> ++ <span class="id" type="var">u</span> :: <span class="id" type="var">l''</span>))).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">in_context</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">IH</span> <span class="id" type="var">Hnf</span> <span class="id" type="var">s_in_l</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">l'</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">s'</span> <span class="id" type="var">l'</span>]; <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">head_step</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">tail_step</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHl'</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Section</span> <span class="id" type="var">Compute_Red</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Variable</span> <span class="id" type="var">rule_list</span> : <span class="id" type="var">list</span> (<span class="id" type="var">term</span> * <span class="id" type="var">term</span>).<br/>

<br/>
</div>

<div class="doc">
<a name="lab44"></a><h3 class="section">Definition of a step of compute_red.</h3>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <span class="id" type="var">F_compute_red</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span> (<span class="id" type="var">crec</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">s</span>, <span class="id" type="var">o_size</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">list</span> <span class="id" type="var">term</span>), <span class="id" type="var">list</span> <span class="id" type="var">term</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">crec</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v</span> | <span class="id" type="var">f</span> <span class="id" type="var">l</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">exact</span> (<span class="id" type="var">compute_head_red</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>) <span class="id" type="var">rule_list</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">crec_l</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">t</span> (<span class="id" type="var">t_in_l</span> : <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span>), <span class="id" type="var">list</span> <span class="id" type="var">term</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">t_in_l</span>; <span class="id" type="tactic">exact</span> (<span class="id" type="var">crec</span> <span class="id" type="var">t</span> (<span class="id" type="var">size_direct_subterm</span> <span class="id" type="var">t</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) <span class="id" type="var">t_in_l</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">exact</span> ((<span class="id" type="var">compute_head_red</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) <span class="id" type="var">rule_list</span>) ++<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">k</span> =&gt; <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">k</span>) (<span class="id" type="var">mapii_dep</span> (<span class="id" type="var">Dep_fun</span> <span class="id" type="var">l</span> <span class="id" type="var">crec_l</span>)))).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Defined</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab45"></a><h3 class="section">Definition of compute_red.</h3>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <span class="id" type="var">compute_red</span> :  <span class="id" type="var">term</span> -&gt; <span class="id" type="var">list</span> <span class="id" type="var">term</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Fix</span> <span class="id" type="var">wf_size</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">t</span> =&gt; <span class="id" type="var">list</span> <span class="id" type="var">term</span>) <span class="id" type="var">F_compute_red</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab46"></a><h3 class="section">A more practical equivalent definition of compute_red.</h3>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">compute_red_unfold</span> : <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span> : <span class="id" type="var">term</span>, <span class="id" type="var">compute_red</span> <span class="id" type="var">t</span> = @<span class="id" type="var">F_compute_red</span> <span class="id" type="var">t</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">y</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">compute_red</span> <span class="id" type="var">y</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">compute_red</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">refine</span> (<span class="id" type="var">Fix_eq</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">t</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">F</span> <span class="id" type="var">G</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">F_compute_red</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">v</span> | <span class="id" type="var">f</span> <span class="id" type="var">l</span> ]; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">kk</span> =&gt; <span class="id" type="var">compute_head_red</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) <span class="id" type="var">rule_list</span> ++ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">k</span> =&gt; <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">k</span>) <span class="id" type="var">kk</span>))).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">mapii_dep_eq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">t_in_l</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">compute_red_is_correct</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">l</span> <span class="id" type="var">r</span>, <span class="id" type="var">In</span> (<span class="id" type="var">l</span>,r) <span class="id" type="var">rule_list</span> -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">v</span>, <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">r</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">l</span>)) -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">l</span> <span class="id" type="var">r</span>, <span class="id" type="var">R</span> <span class="id" type="var">r</span> <span class="id" type="var">l</span> &lt;-&gt; <span class="id" type="var">In</span> (<span class="id" type="var">l</span>,r) <span class="id" type="var">rule_list</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span>, (<span class="id" type="var">In</span> <span class="id" type="var">s</span> (<span class="id" type="var">compute_red</span> <span class="id" type="var">t</span>) &lt;-&gt; <span class="id" type="var">one_step</span> <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">Reg</span> <span class="id" type="var">R</span> <span class="id" type="var">Equiv</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">compute_red_unfold</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">at_top</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- (<span class="id" type="var">compute_head_red_is_correct</span> <span class="id" type="var">rule_list</span> <span class="id" type="var">Reg</span> <span class="id" type="var">R</span> <span class="id" type="var">Equiv</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">compute_red_unfold</span>; <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">compute_head_red_is_correct</span> <span class="id" type="var">rule_list</span> <span class="id" type="var">Reg</span> <span class="id" type="var">R</span> <span class="id" type="var">Equiv</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">compute_red_unfold</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">in_app_or</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">H1</span> | <span class="id" type="var">H2</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">at_top</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- (<span class="id" type="var">compute_head_red_is_correct</span> <span class="id" type="var">rule_list</span> <span class="id" type="var">Reg</span> <span class="id" type="var">R</span> <span class="id" type="var">Equiv</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">H2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">k</span> [<span class="id" type="var">H2</span> <span class="id" type="var">H3</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_context</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> <span class="id" type="var">IHl</span> <span class="id" type="var">k</span> <span class="id" type="var">H3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">IHl</span> <span class="id" type="var">k</span> <span class="id" type="var">H3</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">a</span> <span class="id" type="var">l</span>]; <span class="id" type="tactic">intros</span> <span class="id" type="var">IHll</span> <span class="id" type="var">k</span> <span class="id" type="var">H3</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">mapii_dep_unfold</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H3</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H3</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">in_app_or</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H3</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">H4</span> | <span class="id" type="var">H5</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H3</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H4</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">H4</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">b</span> [<span class="id" type="var">H4</span> <span class="id" type="var">H5</span>]]; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">head_step</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- (<span class="id" type="var">IHll</span> <span class="id" type="var">a</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H5</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">H5</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">l'</span> [<span class="id" type="var">H5</span> <span class="id" type="var">H6</span>]]; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">tail_step</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">t_in_l</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHll</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">compute_red_unfold</span>; <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">left</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">compute_head_red_is_correct</span> <span class="id" type="var">rule_list</span> <span class="id" type="var">Reg</span> <span class="id" type="var">R</span> <span class="id" type="var">Equiv</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">compute_red_unfold</span>; <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> <span class="id" type="var">l1</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">IHl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">mapii_dep_unfold</span>; <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">left</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> <span class="id" type="var">t1</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">IHl</span> <span class="id" type="var">_</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) <span class="id" type="var">t1</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">mapii_dep_unfold</span>; <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> <span class="id" type="var">l1</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHone_step_list</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">u_in_l2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">End</span> <span class="id" type="var">Compute_Red</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">FB_nf_dec</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">FB</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span>, <span class="id" type="var">one_step</span> <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> &lt;-&gt; <span class="id" type="var">In</span> <span class="id" type="var">s</span> (<span class="id" type="var">FB</span> <span class="id" type="var">t</span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, {<span class="id" type="var">nf</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span>}+{~ <span class="id" type="var">nf</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span>}.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">FB</span> <span class="id" type="var">red_dec</span> <span class="id" type="var">t</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">case_eq</span> (<span class="id" type="var">FB</span> <span class="id" type="var">t</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">FBt</span> ; <span class="id" type="var">left</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">nf</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">red_dec</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span>); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">FBt</span>; <span class="id" type="var">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">l</span> <span class="id" type="var">FBt</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">nf</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">nf_t</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">nf_t</span> <span class="id" type="var">s</span>); <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">red_dec</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span>); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">FBt</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Defined</span>.<br/>

<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Module</span> <span class="id" type="var">VT</span> : <span class="id" type="var">decidable_set.S</span> <span class="id" type="keyword">with</span> <span class="id" type="keyword">Definition</span> <span class="id" type="var">A</span> := (<span class="id" type="var">variable</span> * <span class="id" type="var">term</span>)%type.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <span class="id" type="var">A</span> := (<span class="id" type="var">variable</span> * <span class="id" type="var">term</span>)%type.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <span class="id" type="var">eq_A</span> := (@<span class="id" type="var">eq</span> <span class="id" type="var">A</span>).<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <span class="id" type="var">eq_bool</span> := <span class="id" type="keyword">fun</span> <span class="id" type="var">vt1</span> <span class="id" type="var">vt2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">vt1</span>, <span class="id" type="var">vt2</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">v1</span>,t1), (<span class="id" type="var">v2</span>,t2) =&gt; <span class="id" type="var">andb</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v1</span> <span class="id" type="var">v2</span>) (<span class="id" type="var">T.eq_bool</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>) <span class="id" type="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">eq_bool_ok</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">vt1</span> <span class="id" type="var">vt2</span>, <span class="id" type="keyword">match</span> <span class="id" type="var">eq_bool</span> <span class="id" type="var">vt1</span> <span class="id" type="var">vt2</span> <span class="id" type="keyword">with</span> <span class="id" type="var">true</span> =&gt; <span class="id" type="var">vt1</span> = <span class="id" type="var">vt2</span> | <span class="id" type="var">false</span> =&gt; <span class="id" type="var">vt1</span> &lt;&gt; <span class="id" type="var">vt2</span> <span class="id" type="keyword">end</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> [<span class="id" type="var">v1</span> <span class="id" type="var">t1</span>] [<span class="id" type="var">v2</span> <span class="id" type="var">t2</span>]; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v1</span> <span class="id" type="var">v2</span>) (<span class="id" type="var">T.eq_bool_ok</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">eq_bool</span>; <span class="id" type="tactic">case</span> (<span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v1</span> <span class="id" type="var">v2</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">case</span> (<span class="id" type="var">T1.eq_bool</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> <span class="id" type="var">t1_diff_t2</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">vt1_eq_vt2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">t1_diff_t2</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">vt1_eq_vt2</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">v1_diff_v2</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">vt1_eq_vt2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">v1_diff_v2</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">vt1_eq_vt2</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Defined</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">End</span> <span class="id" type="var">VT</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Module</span> <span class="id" type="var">D</span> := <span class="id" type="var">dickson.Make</span> (<span class="id" type="var">VT</span>).<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <span class="id" type="var">rwr_subst</span> <span class="id" type="var">R</span> <span class="id" type="var">sigma'</span> <span class="id" type="var">sigma</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">trans_clos</span> (<span class="id" type="var">D.multiset_extension_step</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">yval'</span> <span class="id" type="var">xval</span> =&gt; <span class="id" type="var">rwr</span> <span class="id" type="var">R</span> (<span class="id" type="var">snd</span> <span class="id" type="var">yval'</span>) (<span class="id" type="var">snd</span> <span class="id" type="var">xval</span>))) <span class="id" type="var">sigma'</span> <span class="id" type="var">sigma</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">acc_rwr_subst</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">sigma</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">val</span>, <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,val) <span class="id" type="var">sigma</span> -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">val</span>) &lt;-&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">rwr_subst</span> <span class="id" type="var">R</span>) <span class="id" type="var">sigma</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">sigma</span>; <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">Acc_sigma</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">rwr_subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_incl</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">trans_clos</span> (<span class="id" type="var">D.multiset_extension_step</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">yval'</span> <span class="id" type="var">xval</span> =&gt; <span class="id" type="var">rwr</span> <span class="id" type="var">R</span> (<span class="id" type="var">snd</span> <span class="id" type="var">yval'</span>) (<span class="id" type="var">snd</span> <span class="id" type="var">xval</span>)))).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">acc_trans</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">D.dickson_strong</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> [<span class="id" type="var">x</span> <span class="id" type="var">val</span>] <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">Acc_rwr_val</span> : <span class="id" type="var">Acc</span> (<span class="id" type="var">rwr</span> <span class="id" type="var">R</span>) <span class="id" type="var">val</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">acc_trans</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_sigma</span> <span class="id" type="keyword">with</span> <span class="id" type="var">x</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="var">revert</span> <span class="id" type="var">x</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">Acc_rwr_val</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">val</span> <span class="id" type="var">Acc_val</span> <span class="id" type="var">IH</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>; <span class="id" type="tactic">intros</span> [<span class="id" type="var">y</span> <span class="id" type="var">val'</span>] <span class="id" type="var">H</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IH</span>; <span class="id" type="tactic">trivial</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">Acc_sigma</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">Acc_sigma</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">sigma</span> <span class="id" type="var">Acc_sigma</span> <span class="id" type="var">IH</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">y</span> <span class="id" type="var">val</span> <span class="id" type="var">yval_in_sigma</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">val'</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">In_split</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">yval_in_sigma</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">sigma1</span> [<span class="id" type="var">sigma2</span> <span class="id" type="var">H'</span>]]; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">IH</span> (<span class="id" type="var">sigma1</span> ++ (<span class="id" type="var">y</span>,val') :: <span class="id" type="var">sigma2</span>)) <span class="id" type="keyword">with</span> <span class="id" type="var">y</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">rwr_subst</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">t_step</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">refine</span> (@<span class="id" type="var">D.rmv_case</span> <span class="id" type="var">_</span> (<span class="id" type="var">sigma1</span> ++ (<span class="id" type="var">y</span>, <span class="id" type="var">val'</span>) :: <span class="id" type="var">sigma2</span>) (<span class="id" type="var">sigma1</span> ++ (<span class="id" type="var">y</span>, <span class="id" type="var">val</span>) :: <span class="id" type="var">sigma2</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">sigma1</span> ++ <span class="id" type="var">sigma2</span>) ((<span class="id" type="var">y</span>,val') :: <span class="id" type="var">nil</span>) (<span class="id" type="var">y</span>,val) <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">D.LP.EDS.eq_A</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">b</span> [<span class="id" type="var">H'</span> | <span class="id" type="var">H'</span>]; [<span class="id" type="tactic">subst</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">t_step</span>; <span class="id" type="tactic">trivial</span> | <span class="id" type="var">contradiction</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">D.LP.permut_sym</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">D.LP.permut_cons_inside</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">D.LP.EDS.eq_A</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">D.LP.permut_sym</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">D.LP.permut_cons_inside</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">D.LP.EDS.eq_A</span>, <span class="id" type="var">D.LP.EDS.eq_A</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">acc_nf_subst</span> : <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span> <span class="id" type="var">FB</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span>, <span class="id" type="var">In</span> <span class="id" type="var">s</span> (<span class="id" type="var">FB</span> <span class="id" type="var">t</span>) &lt;-&gt; <span class="id" type="var">one_step</span> <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">sigma</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">val</span>, <span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">sigma</span> = <span class="id" type="var">Some</span> <span class="id" type="var">val</span> -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">val</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="id" type="var">sigma'</span> : <span class="id" type="var">substitution</span> | (<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">val'</span>, <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,val') <span class="id" type="var">sigma'</span> &lt;-&gt; <span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">sigma'</span> = <span class="id" type="var">Some</span> <span class="id" type="var">val'</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">val</span>, <span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">sigma</span> = <span class="id" type="var">Some</span> <span class="id" type="var">val</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> <span class="id" type="var">val'</span>, (<span class="id" type="var">In</span> (<span class="id" type="var">x</span>,val') <span class="id" type="var">sigma'</span> /\ <span class="id" type="var">nf</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">val'</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">val'</span> = <span class="id" type="var">val</span> \/ <span class="id" type="var">trans_clos</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">val'</span> <span class="id" type="var">val</span>))) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">val'</span>, <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,val') <span class="id" type="var">sigma'</span> -&gt; <span class="id" type="var">nf</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">val'</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">val'</span>, <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,val') <span class="id" type="var">sigma'</span> -&gt; <span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">sigma</span> &lt;&gt; <span class="id" type="var">None</span>)}.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">FB</span> <span class="id" type="var">red_dec</span> <span class="id" type="var">sigma</span> <span class="id" type="var">Acc_sigma</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">remove_garbage_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">tau</span> [<span class="id" type="var">H1</span> [<span class="id" type="var">H</span> <span class="id" type="var">H'</span>]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">H''</span> : {<span class="id" type="var">sigma'</span> : <span class="id" type="var">substitution</span> | <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">val'</span>, <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,val') <span class="id" type="var">sigma'</span> &lt;-&gt; <span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">sigma'</span> = <span class="id" type="var">Some</span> <span class="id" type="var">val'</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">val</span>, <span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">tau</span> = <span class="id" type="var">Some</span> <span class="id" type="var">val</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> <span class="id" type="var">val'</span>, (<span class="id" type="var">In</span> (<span class="id" type="var">x</span>,val') <span class="id" type="var">sigma'</span> /\ <span class="id" type="var">nf</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">val'</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">val'</span> = <span class="id" type="var">val</span> \/ <span class="id" type="var">trans_clos</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">val'</span> <span class="id" type="var">val</span>))) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">val'</span>, <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,val') <span class="id" type="var">sigma'</span> -&gt; <span class="id" type="var">nf</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">val'</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">val'</span>, <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,val') <span class="id" type="var">sigma'</span> -&gt; <span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">tau</span> &lt;&gt; <span class="id" type="var">None</span>)}).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">Acc_tau</span> : <span class="id" type="keyword">forall</span> (<span class="id" type="var">x</span> : <span class="id" type="var">variable</span>) (<span class="id" type="var">val</span> : <span class="id" type="var">term</span>), <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,val) <span class="id" type="var">tau</span> -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">val</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">val</span> <span class="id" type="var">H''</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">Acc_sigma</span> <span class="id" type="var">x</span> <span class="id" type="var">val</span>); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">trivial</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">clear</span> <span class="id" type="var">sigma</span> <span class="id" type="var">Acc_sigma</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">tau</span> <span class="id" type="keyword">as</span> [ | [<span class="id" type="var">x</span> <span class="id" type="var">val</span>] <span class="id" type="var">tau</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> (<span class="id" type="var">nil</span> : <span class="id" type="var">substitution</span>); <span class="id" type="tactic">repeat</span> <span class="id" type="tactic">split</span>; <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">contradiction</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">IHtau</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">sigma'</span> [<span class="id" type="var">H1</span> [<span class="id" type="var">H2</span> [<span class="id" type="var">H3</span> <span class="id" type="var">K3</span>]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">y</span> <span class="id" type="var">valy</span> <span class="id" type="var">H4</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">In_split</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H4</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">tau1</span> [<span class="id" type="var">tau2</span> <span class="id" type="var">H5</span>]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">tau</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- (<span class="id" type="var">H</span> <span class="id" type="var">y</span> <span class="id" type="var">valy</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">y</span> <span class="id" type="var">x</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">eq_var_bool</span> <span class="id" type="var">y</span> <span class="id" type="var">x</span>); <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="id" type="tactic">intro</span> <span class="id" type="var">y_eq_x</span>; <span class="id" type="var">absurd</span> (<span class="id" type="var">y</span> = <span class="id" type="var">x</span>) | <span class="id" type="tactic">intro</span> <span class="id" type="var">y_diff_x</span>]; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">y</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">H'</span> <span class="id" type="var">x</span> <span class="id" type="var">x</span> <span class="id" type="var">val</span> <span class="id" type="var">valy</span> <span class="id" type="var">nil</span> <span class="id" type="var">tau1</span> <span class="id" type="var">tau2</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">right</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">y</span> <span class="id" type="var">z</span> <span class="id" type="var">valy</span> <span class="id" type="var">valz</span> <span class="id" type="var">tau1</span> <span class="id" type="var">tau2</span> <span class="id" type="var">tau3</span> <span class="id" type="var">H1</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">H'</span> <span class="id" type="var">y</span> <span class="id" type="var">z</span> <span class="id" type="var">valy</span> <span class="id" type="var">valz</span> ((<span class="id" type="var">x</span>,val) :: <span class="id" type="var">tau1</span>) <span class="id" type="var">tau2</span> <span class="id" type="var">tau3</span>); <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">y</span> <span class="id" type="var">valy</span> <span class="id" type="var">H''</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_tau</span> <span class="id" type="keyword">with</span> <span class="id" type="var">y</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">acc_nf</span> <span class="id" type="var">FB</span> <span class="id" type="var">red_dec</span> (<span class="id" type="var">Acc_tau</span> <span class="id" type="var">x</span> <span class="id" type="var">val</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)))) <span class="id" type="keyword">as</span> [<span class="id" type="var">val'</span> [<span class="id" type="var">H4</span> <span class="id" type="var">H5</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> ((<span class="id" type="var">x</span>,val') :: <span class="id" type="var">sigma'</span>); <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">y</span> <span class="id" type="var">valy</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H6</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H6</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">H6</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">H6</span> | <span class="id" type="var">H6</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">H6</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H6</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">y</span> <span class="id" type="var">y</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">eq_var_bool</span> <span class="id" type="var">y</span> <span class="id" type="var">y</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">y_diff_y</span>; <span class="id" type="var">absurd</span> (<span class="id" type="var">y</span> = <span class="id" type="var">y</span>)]; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">H7</span> := <span class="id" type="var">K3</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H6</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">H8</span> := <span class="id" type="var">find_mem</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">y</span> <span class="id" type="var">tau</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">y</span> <span class="id" type="var">tau</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">valy'</span> | ]; [<span class="id" type="var">idtac</span> | <span class="id" type="var">absurd</span> (@<span class="id" type="var">None</span> <span class="id" type="var">term</span> = <span class="id" type="var">None</span>); <span class="id" type="tactic">trivial</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">H8</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">y'</span> [<span class="id" type="var">tau1</span> [<span class="id" type="var">tau2</span> [<span class="id" type="var">H9</span> <span class="id" type="var">H10</span>]]]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">y'</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H7</span> <span class="id" type="var">H8</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">H</span> <span class="id" type="var">y</span> <span class="id" type="var">valy'</span>) (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">y</span> <span class="id" type="var">x</span>); <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">case</span> (<span class="id" type="var">eq_var_bool</span> <span class="id" type="var">y</span> <span class="id" type="var">x</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> <span class="id" type="var">y_eq_x</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">H7</span> <span class="id" type="var">y_diff_x</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">y</span>; <span class="id" type="var">absurd</span> (<span class="id" type="var">x</span> = <span class="id" type="var">x</span>); <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">H'</span> <span class="id" type="var">x</span> <span class="id" type="var">x</span> <span class="id" type="var">val</span> <span class="id" type="var">valy'</span> <span class="id" type="var">nil</span> <span class="id" type="var">tau1</span> <span class="id" type="var">tau2</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H1</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find_mem</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H6</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">y'</span> [<span class="id" type="var">l1</span> [<span class="id" type="var">l2</span> [<span class="id" type="var">H7</span> <span class="id" type="var">H8</span>]]]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">y'</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H8</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">repeat</span> <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">y</span> <span class="id" type="var">valy</span>; <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">y</span> <span class="id" type="var">x</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">eq_var_bool</span> <span class="id" type="var">y</span> <span class="id" type="var">x</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">y_eq_x</span> <span class="id" type="var">H6</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">y_diff_x</span> <span class="id" type="var">H6</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">H6</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H6</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">y</span> <span class="id" type="var">valy</span>; <span class="id" type="var">exists</span> <span class="id" type="var">val'</span>; <span class="id" type="tactic">repeat</span> <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">H2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H6</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">valy'</span> [<span class="id" type="var">K1</span> [<span class="id" type="var">K2</span> <span class="id" type="var">K4</span>]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> <span class="id" type="var">valy'</span>; <span class="id" type="tactic">repeat</span> <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">y</span> <span class="id" type="var">valy</span> [<span class="id" type="var">H6</span> | <span class="id" type="var">H6</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">H6</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H6</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">y</span> <span class="id" type="var">valy</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">H3</span> <span class="id" type="keyword">with</span> <span class="id" type="var">y</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">y</span> <span class="id" type="var">valy</span>; <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">y</span> <span class="id" type="var">x</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">eq_var_bool</span> <span class="id" type="var">y</span> <span class="id" type="var">x</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">y_eq_x</span> <span class="id" type="var">H6</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">y_diff_x</span> <span class="id" type="var">H6</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">K3</span> <span class="id" type="keyword">with</span> <span class="id" type="var">valy</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">H6</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">H6</span> | <span class="id" type="var">H6</span>]; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">H6</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">y</span>; <span class="id" type="var">absurd</span> (<span class="id" type="var">x</span> = <span class="id" type="var">x</span>); <span class="id" type="tactic">trivial</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">H''</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">sigma'</span> [<span class="id" type="var">H2</span> [<span class="id" type="var">H3</span> [<span class="id" type="var">H4</span> <span class="id" type="var">H5</span>]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> <span class="id" type="var">sigma'</span>; <span class="id" type="tactic">split</span>; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">repeat</span> <span class="id" type="tactic">split</span>]; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">val</span> <span class="id" type="var">H''</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H1</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H''</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H3</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">val</span> <span class="id" type="var">H''</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H5</span> <span class="id" type="keyword">with</span> <span class="id" type="var">val</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Defined</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <span class="id" type="var">non_overlapping</span> (<span class="id" type="var">R</span> : <span class="id" type="var">relation</span> <span class="id" type="var">term</span>) := <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">l1</span> <span class="id" type="var">r1</span> <span class="id" type="var">l2</span> <span class="id" type="var">r2</span> <span class="id" type="var">sigma</span> <span class="id" type="var">tau</span>, <span class="id" type="var">R</span> <span class="id" type="var">r1</span> <span class="id" type="var">l1</span> -&gt; <span class="id" type="var">R</span> <span class="id" type="var">r2</span> <span class="id" type="var">l2</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">p</span>, <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">l1</span> <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) = <span class="id" type="var">apply_subst</span> <span class="id" type="var">tau</span> <span class="id" type="var">l2</span> -&gt; <span class="id" type="var">p</span> = <span class="id" type="var">nil</span> /\ <span class="id" type="var">l1</span> = <span class="id" type="var">l2</span> /\ <span class="id" type="var">r1</span> = <span class="id" type="var">r2</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <span class="id" type="var">overlay</span> (<span class="id" type="var">R</span> : <span class="id" type="var">relation</span> <span class="id" type="var">term</span>) := <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">l1</span> <span class="id" type="var">r1</span> <span class="id" type="var">l2</span> <span class="id" type="var">r2</span> <span class="id" type="var">sigma</span> <span class="id" type="var">tau</span>, <span class="id" type="var">R</span> <span class="id" type="var">r1</span> <span class="id" type="var">l1</span> -&gt; <span class="id" type="var">R</span> <span class="id" type="var">r2</span> <span class="id" type="var">l2</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">p</span>, <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">l1</span> <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) = <span class="id" type="var">apply_subst</span> <span class="id" type="var">tau</span> <span class="id" type="var">l2</span> -&gt; <span class="id" type="var">p</span> = <span class="id" type="var">nil</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">well_formed_one_step</span> : <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> (<span class="id" type="var">R</span> : <span class="id" type="var">relation</span> <span class="id" type="var">term</span>), (<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">x</span>, <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">t</span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">r</span> <span class="id" type="var">l</span>, <span class="id" type="var">R</span> <span class="id" type="var">r</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="var">well_formed</span> <span class="id" type="var">r</span> /\ <span class="id" type="var">well_formed</span> <span class="id" type="var">l</span>) -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">one_step</span> <span class="id" type="var">R</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span> -&gt; <span class="id" type="var">well_formed</span> <span class="id" type="var">s</span> -&gt; <span class="id" type="var">well_formed</span> <span class="id" type="var">t</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">R_reg</span> <span class="id" type="var">WR</span> <span class="id" type="var">t2</span> <span class="id" type="var">t1</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">revert</span> <span class="id" type="var">t1</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">v2</span> <span class="id" type="var">t1</span> <span class="id" type="var">H</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1'</span> <span class="id" type="var">t2'</span> <span class="id" type="var">H'</span> | <span class="id" type="var">f</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">H'</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">t1'</span> <span class="id" type="var">t2'</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">H'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">r</span> <span class="id" type="var">l</span> <span class="id" type="var">sigma</span> <span class="id" type="var">H''</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v</span> | ]; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">discriminate</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_apply_subst_strong</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">x_in_r</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_remove_term</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_in_term_is_sound</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">R_reg</span> <span class="id" type="keyword">with</span> <span class="id" type="var">r</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">var_in_term_is_sound</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">proj1</span> (<span class="id" type="var">WR</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>  <span class="id" type="var">H''</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l2</span> <span class="id" type="var">IHl2</span> <span class="id" type="var">t1</span> <span class="id" type="var">H</span> <span class="id" type="var">Wfl2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1'</span> <span class="id" type="var">t2'</span> <span class="id" type="var">H'</span> | <span class="id" type="var">f'</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2'</span> <span class="id" type="var">H'</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">t1'</span> <span class="id" type="var">t2'</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">H'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">r</span> <span class="id" type="var">l</span> <span class="id" type="var">sigma</span> <span class="id" type="var">H''</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">t1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_apply_subst_strong</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">x_in_r</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_remove_term</span> <span class="id" type="keyword">with</span> <span class="id" type="var">l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_in_term_is_sound</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">R_reg</span> <span class="id" type="keyword">with</span> <span class="id" type="var">r</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">var_in_term_is_sound</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">proj1</span> (<span class="id" type="var">WR</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>  <span class="id" type="var">H''</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">t1</span> <span class="id" type="var">l2'</span> <span class="id" type="var">f'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_fold</span>; <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">well_formed_unfold</span> <span class="id" type="var">Wfl2</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">Wl2</span> <span class="id" type="var">_</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">Wfl2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">H'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">l</span> <span class="id" type="var">H</span> | <span class="id" type="var">t</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">H</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> [<span class="id" type="var">u_eq_t1</span> | <span class="id" type="var">u_in_l</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHl2</span> <span class="id" type="keyword">with</span> <span class="id" type="var">t2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">left</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">u</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Wl2</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Wl2</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> [<span class="id" type="var">u_eq_t</span> | <span class="id" type="var">u_in_l1</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Wl2</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHH</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">t2</span> <span class="id" type="var">t2_in_l2</span> <span class="id" type="var">t1</span> <span class="id" type="var">H'</span> <span class="id" type="var">Wt2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHl2</span> <span class="id" type="keyword">with</span> <span class="id" type="var">t2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Wl2</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">well_formed_unfold</span> <span class="id" type="var">Wfl2</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">_</span> <span class="id" type="var">Af</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">one_step_list_length_eq</span> <span class="id" type="var">H'</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">well_formed_rwr</span> : <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> (<span class="id" type="var">R</span> : <span class="id" type="var">relation</span> <span class="id" type="var">term</span>), (<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">x</span>, <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">t</span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">r</span> <span class="id" type="var">l</span>, <span class="id" type="var">R</span> <span class="id" type="var">r</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="var">well_formed</span> <span class="id" type="var">r</span> /\ <span class="id" type="var">well_formed</span> <span class="id" type="var">l</span>) -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">rwr</span> <span class="id" type="var">R</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span> -&gt; <span class="id" type="var">well_formed</span> <span class="id" type="var">s</span> -&gt; <span class="id" type="var">well_formed</span> <span class="id" type="var">t</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">R_reg</span> <span class="id" type="var">WR</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span> | <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">t3</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_one_step</span> <span class="id" type="keyword">with</span> <span class="id" type="var">R</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">Wt3</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_one_step</span> <span class="id" type="keyword">with</span> <span class="id" type="var">R</span> <span class="id" type="var">t2</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHH2</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">map2</span> (<span class="id" type="var">A</span> <span class="id" type="var">B</span> <span class="id" type="var">C</span> : <span class="id" type="keyword">Type</span>) (<span class="id" type="var">f</span>: <span class="id" type="var">A</span> -&gt; <span class="id" type="var">B</span> -&gt; <span class="id" type="var">C</span>) (<span class="id" type="var">l1</span> : <span class="id" type="var">list</span> <span class="id" type="var">A</span>) (<span class="id" type="var">l2</span> : <span class="id" type="var">list</span> <span class="id" type="var">B</span>) : <span class="id" type="var">list</span> <span class="id" type="var">C</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l1</span>, <span class="id" type="var">l2</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span>, <span class="id" type="var">_</span> =&gt; <span class="id" type="var">nil</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">_</span>, <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">nil</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">a</span> :: <span class="id" type="var">l1</span>, <span class="id" type="var">b</span> :: <span class="id" type="var">l2</span> =&gt; (<span class="id" type="var">f</span> <span class="id" type="var">a</span> <span class="id" type="var">b</span>) :: <span class="id" type="var">map2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">maxl</span>  (<span class="id" type="var">A</span> : <span class="id" type="keyword">Type</span>) (<span class="id" type="var">l</span>  : <span class="id" type="var">list</span> (<span class="id" type="var">nat</span> * <span class="id" type="var">A</span>)) : <span class="id" type="var">nat</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; 0<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">n</span>,_) :: <span class="id" type="var">l</span> =&gt; <span class="id" type="var">Max.max</span> <span class="id" type="var">n</span> (<span class="id" type="var">maxl</span> <span class="id" type="var">_</span> <span class="id" type="var">l</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">maxl_is_max</span> : <span class="id" type="keyword">forall</span> (<span class="id" type="var">A</span> : <span class="id" type="keyword">Type</span>) <span class="id" type="var">l</span> <span class="id" type="var">n</span> <span class="id" type="var">a</span>, <span class="id" type="var">In</span> (<span class="id" type="var">n</span>,a) <span class="id" type="var">l</span> -&gt; <span class="id" type="var">n</span> &lt;= <span class="id" type="var">maxl</span> <span class="id" type="var">A</span> <span class="id" type="var">l</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">fix</span> 2.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">A</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span>; <span class="id" type="var">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">na1</span> <span class="id" type="var">l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">case</span> <span class="id" type="var">na1</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">na1</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">n1</span> <span class="id" type="var">a1</span> <span class="id" type="var">n</span> <span class="id" type="var">a</span> [<span class="id" type="var">na_eq_na1</span> | <span class="id" type="var">na_in_l</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">na_eq_na1</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">n1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Max.le_max_l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">le_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">maxl</span> <span class="id" type="var">A</span> <span class="id" type="var">l</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">maxl_is_max</span> <span class="id" type="keyword">with</span> <span class="id" type="var">a</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Max.le_max_r</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">maxll</span>  (<span class="id" type="var">A</span> : <span class="id" type="keyword">Type</span>) (<span class="id" type="var">ll</span> : <span class="id" type="var">list</span> (<span class="id" type="var">list</span> (<span class="id" type="var">nat</span> * <span class="id" type="var">A</span>))) : <span class="id" type="var">nat</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">ll</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; 0<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">l</span> :: <span class="id" type="var">ll</span> =&gt; <span class="id" type="var">Max.max</span> (<span class="id" type="var">maxl</span> <span class="id" type="var">_</span> <span class="id" type="var">l</span>) (<span class="id" type="var">maxll</span> <span class="id" type="var">_</span> <span class="id" type="var">ll</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">maxll_is_max</span> : <span class="id" type="keyword">forall</span> (<span class="id" type="var">A</span> : <span class="id" type="keyword">Type</span>) <span class="id" type="var">ll</span> <span class="id" type="var">l</span>, <span class="id" type="var">In</span> <span class="id" type="var">l</span> <span class="id" type="var">ll</span> -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">n</span> <span class="id" type="var">a</span>, <span class="id" type="var">In</span> (<span class="id" type="var">n</span>,a) <span class="id" type="var">l</span> -&gt; <span class="id" type="var">n</span> &lt;= <span class="id" type="var">maxll</span> <span class="id" type="var">A</span> <span class="id" type="var">ll</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">fix</span> 2.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">A</span> <span class="id" type="var">ll</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">ll</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">ll</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span>; <span class="id" type="var">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">l1</span> <span class="id" type="var">ll</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">l</span> [<span class="id" type="var">l_eq_l1</span> | <span class="id" type="var">l_in_ll</span>] <span class="id" type="var">n</span> <span class="id" type="var">a</span> <span class="id" type="var">na_in_l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">le_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">maxl</span> <span class="id" type="var">A</span> <span class="id" type="var">l1</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">maxl_is_max</span> <span class="id" type="keyword">with</span> <span class="id" type="var">a</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Max.le_max_l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">le_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">maxll</span> <span class="id" type="var">A</span> <span class="id" type="var">ll</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">maxll_is_max</span> <span class="id" type="keyword">with</span> <span class="id" type="var">l</span> <span class="id" type="var">a</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Max.le_max_r</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Section</span> <span class="id" type="var">Dec_well_formed</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Variable</span> <span class="id" type="var">R</span> : <span class="id" type="var">relation</span> <span class="id" type="var">term</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Variable</span> <span class="id" type="var">R_reg</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">x</span>, <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">t</span>) .<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Variable</span> <span class="id" type="var">R_var</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">v</span> <span class="id" type="var">t</span>, ~ <span class="id" type="var">R</span> <span class="id" type="var">t</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Variable</span> <span class="id" type="var">WR</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">R</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">well_formed</span> <span class="id" type="var">s</span> /\ <span class="id" type="var">well_formed</span> <span class="id" type="var">t</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Variable</span> <span class="id" type="var">inject</span> : <span class="id" type="var">nat</span> -&gt; <span class="id" type="var">variable</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Variable</span> <span class="id" type="var">inject_inv</span> : <span class="id" type="var">variable</span> -&gt; <span class="id" type="var">nat</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Variable</span> <span class="id" type="var">Hinject1</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">v</span>, <span class="id" type="var">inject</span> (<span class="id" type="var">inject_inv</span> <span class="id" type="var">v</span>) = <span class="id" type="var">v</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Variable</span> <span class="id" type="var">Hinject2</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">n</span>, <span class="id" type="var">inject_inv</span> (<span class="id" type="var">inject</span> <span class="id" type="var">n</span>) = <span class="id" type="var">n</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">Acc_var</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">x</span>, <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">x</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H'</span> | <span class="id" type="var">f'</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">H'</span>]; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">sigma</span> <span class="id" type="var">H''</span> <span class="id" type="var">H3</span> <span class="id" type="var">H'''</span>]; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">t2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x2</span> | <span class="id" type="var">f2</span> <span class="id" type="var">l2</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">absurd</span> (<span class="id" type="var">R</span> <span class="id" type="var">t1</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x2</span>)); <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">HR</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H'''</span>; <span class="id" type="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">find_inject</span> : <span class="id" type="keyword">forall</span> (<span class="id" type="var">A</span> <span class="id" type="var">B</span> : <span class="id" type="keyword">Set</span>) <span class="id" type="var">v</span> (<span class="id" type="var">f</span> : (<span class="id" type="var">nat</span> * <span class="id" type="var">A</span>) -&gt; <span class="id" type="var">B</span>) <span class="id" type="var">sigma</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> (<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">xt</span> =&gt; (<span class="id" type="var">inject</span> (<span class="id" type="var">fst</span> <span class="id" type="var">xt</span>), <span class="id" type="var">f</span> <span class="id" type="var">xt</span>)) <span class="id" type="var">sigma</span>) =<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">find</span> <span class="id" type="var">beq_nat</span> (<span class="id" type="var">inject_inv</span> <span class="id" type="var">v</span>) (<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">xt</span> =&gt; (<span class="id" type="var">fst</span> <span class="id" type="var">xt</span>, <span class="id" type="var">f</span> <span class="id" type="var">xt</span>)) <span class="id" type="var">sigma</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">fix</span> 5.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">C</span> <span class="id" type="var">B</span> <span class="id" type="var">v</span> <span class="id" type="var">f</span> <span class="id" type="var">sigma</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">sigma</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">sigma</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">p</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">n</span> <span class="id" type="var">c</span>; <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">eq_nat_dec</span> (<span class="id" type="var">inject_inv</span> <span class="id" type="var">v</span>) <span class="id" type="var">n</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v_eq_n</span> | <span class="id" type="var">v_diff_n</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">n</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Hinject1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v</span> <span class="id" type="var">v</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">v</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v_diff_v</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">v_diff_v</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">beq_nat_refl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v</span> (<span class="id" type="var">inject</span> <span class="id" type="var">n</span>)); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> (<span class="id" type="var">inject</span> <span class="id" type="var">n</span>)); [<span class="id" type="tactic">intro</span> <span class="id" type="var">v_eq_n</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">v_diff_n</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Hinject2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">decidable_set.beq_nat_ok</span> (<span class="id" type="var">inject_inv</span> <span class="id" type="var">v</span>) <span class="id" type="var">n</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">case</span> (<span class="id" type="var">beq_nat</span> (<span class="id" type="var">inject_inv</span> <span class="id" type="var">v</span>) <span class="id" type="var">n</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">v_eq_n</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">v_diff_n</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">find_inject</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">subst_aux</span> : <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> (<span class="id" type="var">sigma</span> : <span class="id" type="var">substitution</span>), (<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span>, <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,u) <span class="id" type="var">sigma</span> -&gt; <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,v) <span class="id" type="var">sigma</span> -&gt; <span class="id" type="var">u</span> = <span class="id" type="var">v</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span>, <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,u) <span class="id" type="var">sigma</span> -&gt; <span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">sigma</span> = <span class="id" type="var">Some</span> <span class="id" type="var">u</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">sigma</span> <span class="id" type="var">H</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span> <span class="id" type="var">xu_in_sig</span>; <span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">sigma</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">x_val</span> <span class="id" type="var">x_sigma</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">x_sigma</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="tactic">f_equal</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">H</span> <span class="id" type="var">x</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find_mem</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">x_sigma</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">x'</span> [<span class="id" type="var">sig1</span> [<span class="id" type="var">sig2</span> [<span class="id" type="var">x_eq_x'</span> <span class="id" type="var">H'</span>]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">x'</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">refine</span> (<span class="id" type="var">find_not_found</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">_</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span> <span class="id" type="var">sigma</span> <span class="id" type="var">x_sigma</span> (<span class="id" type="var">eq_var_bool_refl</span> <span class="id" type="var">x</span>) <span class="id" type="var">xu_in_sig</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">decompose_term_aux</span> : <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span> <span class="id" type="var">sigma</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span>, <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,u) <span class="id" type="var">sigma</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">u</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">True</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> =&gt; (<span class="id" type="keyword">match</span> <span class="id" type="var">F.arity</span> <span class="id" type="var">f</span> <span class="id" type="keyword">with</span> <span class="id" type="var">Free</span> <span class="id" type="var">n</span> =&gt; <span class="id" type="var">n</span> | <span class="id" type="var">_</span> =&gt; 2 <span class="id" type="keyword">end</span>) &lt;&gt; <span class="id" type="var">length</span> <span class="id" type="var">l</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span>, <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,u) <span class="id" type="var">sigma</span> -&gt; <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,v) <span class="id" type="var">sigma</span> -&gt; <span class="id" type="var">u</span> = <span class="id" type="var">v</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span> <span class="id" type="var">u</span>, <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,u) <span class="id" type="var">sigma</span> -&gt; <span class="id" type="var">In</span> (<span class="id" type="var">y</span>,u) <span class="id" type="var">sigma</span> -&gt; <span class="id" type="var">x</span> = <span class="id" type="var">y</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="id" type="var">s</span> : <span class="id" type="var">term</span> &amp; {<span class="id" type="var">tau</span> : <span class="id" type="var">substitution</span> | <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">sigma'</span> := <span class="id" type="var">tau</span> ++ <span class="id" type="var">sigma</span> <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">t</span> = <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma'</span> <span class="id" type="var">s</span> /\ <span class="id" type="var">well_formed</span> <span class="id" type="var">s</span> /\ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span>, <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,u) <span class="id" type="var">sigma'</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">u</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">True</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> =&gt; (<span class="id" type="keyword">match</span> <span class="id" type="var">F.arity</span> <span class="id" type="var">f</span> <span class="id" type="keyword">with</span> <span class="id" type="var">Free</span> <span class="id" type="var">n</span> =&gt; <span class="id" type="var">n</span> | <span class="id" type="var">_</span> =&gt; 2 <span class="id" type="keyword">end</span>) &lt;&gt; <span class="id" type="var">length</span> <span class="id" type="var">l</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span>, <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,u) <span class="id" type="var">sigma'</span> -&gt; <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,v) <span class="id" type="var">sigma'</span> -&gt; <span class="id" type="var">u</span> = <span class="id" type="var">v</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span> <span class="id" type="var">u</span>, <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,u) <span class="id" type="var">sigma'</span> -&gt; <span class="id" type="var">In</span> (<span class="id" type="var">y</span>,u) <span class="id" type="var">sigma'</span> -&gt; <span class="id" type="var">x</span> = <span class="id" type="var">y</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span>, <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">sigma'</span>))}}.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma</span> <span class="id" type="var">h1</span> <span class="id" type="var">h2</span> <span class="id" type="var">h3</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">mem_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">T.eq_bool_ok</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>) (<span class="id" type="var">map</span> (@<span class="id" type="var">snd</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">sigma</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">case</span> (<span class="id" type="var">mem_bool</span> <span class="id" type="var">T.eq_bool</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>) (<span class="id" type="var">map</span> (@<span class="id" type="var">snd</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">sigma</span>)); [<span class="id" type="tactic">intro</span> <span class="id" type="var">v_in_sig</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v_not_in_sig</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">mem_map_set</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">T.eq_bool_ok</span>  <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">v_in_sig</span>) <span class="id" type="keyword">as</span> [[<span class="id" type="var">x</span> <span class="id" type="var">u</span>] [<span class="id" type="var">v_eq_u</span> <span class="id" type="var">v_in_sig'</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_eq_u</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">u</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>); <span class="id" type="var">exists</span> <span class="id" type="var">nil</span>; <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">subst_aux</span> <span class="id" type="var">sigma</span> <span class="id" type="var">h2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">v_in_sig'</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">h1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">h2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">h3</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">z</span> [<span class="id" type="var">z_eq_x</span> | <span class="id" type="var">z_in_nil</span>]; [<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">x</span>,Var <span class="id" type="var">v</span>); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span> | <span class="id" type="var">contradiction</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">set</span> (<span class="id" type="var">m</span> := (<span class="id" type="var">S</span> (<span class="id" type="var">maxl</span> <span class="id" type="var">_</span> (<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">xt</span> =&gt; (<span class="id" type="var">inject_inv</span> (<span class="id" type="var">fst</span> <span class="id" type="var">xt</span>), <span class="id" type="var">snd</span> <span class="id" type="var">xt</span>)) <span class="id" type="var">sigma</span>)))).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> (<span class="id" type="var">Var</span> (<span class="id" type="var">inject</span> <span class="id" type="var">m</span>)); <span class="id" type="var">exists</span> ((<span class="id" type="var">inject</span> <span class="id" type="var">m</span>, <span class="id" type="var">Var</span> <span class="id" type="var">v</span> ) :: <span class="id" type="var">nil</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">eq_var_bool_refl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span> [<span class="id" type="var">xu_eq_mv</span> | <span class="id" type="var">xu_in_sigma</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">xu_eq_mv</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">h1</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span> <span class="id" type="var">xu_in_sigma</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span> <span class="id" type="var">u'</span> [<span class="id" type="var">xu_eq_mv</span> | <span class="id" type="var">xu_in_sigma</span>] [<span class="id" type="var">xu'_eq_mv</span> | <span class="id" type="var">xu'_in_sigma</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">xu_eq_mv</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">xu'_eq_mv</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">xu_eq_mv</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">xu_eq_mv</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">absurd</span> (<span class="id" type="var">m</span> &lt; <span class="id" type="var">m</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">le_n_S</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">maxl_is_max</span> <span class="id" type="var">_</span> (<span class="id" type="var">map</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">fun</span> <span class="id" type="var">xt</span> : <span class="id" type="var">T1.variable</span> * <span class="id" type="var">T1.term</span> =&gt; (<span class="id" type="var">inject_inv</span> (<span class="id" type="var">fst</span> <span class="id" type="var">xt</span>), <span class="id" type="var">snd</span> <span class="id" type="var">xt</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">sigma</span>) <span class="id" type="var">m</span> <span class="id" type="var">u'</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> (<span class="id" type="var">inject</span> <span class="id" type="var">m</span>, <span class="id" type="var">u'</span>); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Hinject2</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">xu'_eq_mv</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">xu'_eq_mv</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">x</span> <span class="id" type="var">u'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">absurd</span> (<span class="id" type="var">m</span> &lt; <span class="id" type="var">m</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">le_n_S</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">maxl_is_max</span> <span class="id" type="var">_</span> (<span class="id" type="var">map</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">fun</span> <span class="id" type="var">xt</span> : <span class="id" type="var">T1.variable</span> * <span class="id" type="var">T1.term</span> =&gt; (<span class="id" type="var">inject_inv</span> (<span class="id" type="var">fst</span> <span class="id" type="var">xt</span>), <span class="id" type="var">snd</span> <span class="id" type="var">xt</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">sigma</span>) <span class="id" type="var">m</span> <span class="id" type="var">u</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> (<span class="id" type="var">inject</span> <span class="id" type="var">m</span>, <span class="id" type="var">u</span>); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Hinject2</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">h2</span> <span class="id" type="var">x</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span> <span class="id" type="var">u</span> [<span class="id" type="var">xu_eq_mv</span> | <span class="id" type="var">xu_in_sigma</span>] [<span class="id" type="var">yu_eq_mv</span> | <span class="id" type="var">yu_in_sigma</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">xu_eq_mv</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">yu_eq_mv</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">xu_eq_mv</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">xu_eq_mv</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">v_not_in_sig</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_impl_mem</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">y</span>, <span class="id" type="var">Var</span> <span class="id" type="var">v</span>); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">yu_eq_mv</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">yu_eq_mv</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">y</span> <span class="id" type="var">u</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">v_not_in_sig</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_impl_mem</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">x</span>, <span class="id" type="var">Var</span> <span class="id" type="var">v</span>); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">h3</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span> <span class="id" type="var">u</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">z</span> [<span class="id" type="var">z_eq_m</span> | <span class="id" type="var">z_in_nil</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">Hl</span> <span class="id" type="var">sigma</span> <span class="id" type="var">h1</span> <span class="id" type="var">h2</span> <span class="id" type="var">h3</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">mem_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">T.eq_bool_ok</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) (<span class="id" type="var">map</span> (@<span class="id" type="var">snd</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">sigma</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">case</span> (<span class="id" type="var">mem_bool</span> <span class="id" type="var">T.eq_bool</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) (<span class="id" type="var">map</span> (@<span class="id" type="var">snd</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">sigma</span>)); [<span class="id" type="tactic">intro</span> <span class="id" type="var">fl_in_sig</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">fl_not_in_sig</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">mem_map_set</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">T.eq_bool_ok</span>  <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">fl_in_sig</span>) <span class="id" type="keyword">as</span> [[<span class="id" type="var">x</span> <span class="id" type="var">u</span>] [<span class="id" type="var">fl_eq_u</span> <span class="id" type="var">fl_in_sig'</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">fl_eq_u</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">u</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>); <span class="id" type="var">exists</span> <span class="id" type="var">nil</span>; <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">subst_aux</span> <span class="id" type="var">sigma</span> <span class="id" type="var">h2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">fl_in_sig'</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">h1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">h2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">h3</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">z</span> [<span class="id" type="var">z_eq_x</span> | <span class="id" type="var">z_in_nil</span>]; [<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">x</span>,Term <span class="id" type="var">f</span> <span class="id" type="var">l</span>); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span> | <span class="id" type="var">contradiction</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">eq_nat_dec</span> (<span class="id" type="var">length</span> <span class="id" type="var">l</span>) (<span class="id" type="keyword">match</span> <span class="id" type="var">F.arity</span> <span class="id" type="var">f</span> <span class="id" type="keyword">with</span> <span class="id" type="var">Free</span> <span class="id" type="var">n</span> =&gt; <span class="id" type="var">n</span> | <span class="id" type="var">_</span> =&gt; 2 <span class="id" type="keyword">end</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">Wf</span> | <span class="id" type="var">not_Wf</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">Aux</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="id" type="var">ls</span> : <span class="id" type="var">list</span> <span class="id" type="var">T1.term</span> &amp; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="id" type="var">tau</span> : <span class="id" type="var">T1.substitution</span> |<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">sigma'</span> := <span class="id" type="var">tau</span> ++ <span class="id" type="var">sigma</span> <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">l</span> = <span class="id" type="var">map</span> (<span class="id" type="var">T1.apply_subst</span> <span class="id" type="var">sigma'</span>) <span class="id" type="var">ls</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">si</span>, <span class="id" type="var">In</span> <span class="id" type="var">si</span> <span class="id" type="var">ls</span> -&gt; <span class="id" type="var">well_formed</span> <span class="id" type="var">si</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> (<span class="id" type="var">x</span> : <span class="id" type="var">T1.variable</span>) (<span class="id" type="var">u</span> : <span class="id" type="var">T1.term</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">In</span> (<span class="id" type="var">x</span>, <span class="id" type="var">u</span>) <span class="id" type="var">sigma'</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">u</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">T1.Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">True</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">T1.Term</span> <span class="id" type="var">f0</span> <span class="id" type="var">l0</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">T1.F.arity</span> <span class="id" type="var">f0</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">AC</span> =&gt; 2<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">C</span> =&gt; 2<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Free</span> <span class="id" type="var">n</span> =&gt; <span class="id" type="var">n</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span> &lt;&gt; <span class="id" type="var">length</span> <span class="id" type="var">l0</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> (<span class="id" type="var">x</span> : <span class="id" type="var">T1.variable</span>) (<span class="id" type="var">u</span> <span class="id" type="var">v</span> : <span class="id" type="var">T1.term</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">In</span> (<span class="id" type="var">x</span>, <span class="id" type="var">u</span>) <span class="id" type="var">sigma'</span> -&gt; <span class="id" type="var">In</span> (<span class="id" type="var">x</span>, <span class="id" type="var">v</span>) <span class="id" type="var">sigma'</span> -&gt; <span class="id" type="var">u</span> = <span class="id" type="var">v</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> (<span class="id" type="var">x</span> <span class="id" type="var">y</span> : <span class="id" type="var">T1.variable</span>) (<span class="id" type="var">u</span> : <span class="id" type="var">T1.term</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">In</span> (<span class="id" type="var">x</span>, <span class="id" type="var">u</span>) <span class="id" type="var">sigma'</span> -&gt; <span class="id" type="var">In</span> (<span class="id" type="var">y</span>, <span class="id" type="var">u</span>) <span class="id" type="var">sigma'</span> -&gt; <span class="id" type="var">x</span> = <span class="id" type="var">y</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> : <span class="id" type="var">T1.variable</span>, <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">T1.var_list_list</span> <span class="id" type="var">ls</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">sigma'</span>))}}).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">clear</span> <span class="id" type="var">f</span> <span class="id" type="var">fl_not_in_sig</span> <span class="id" type="var">Wf</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">revert</span> <span class="id" type="var">sigma</span> <span class="id" type="var">h1</span> <span class="id" type="var">h2</span> <span class="id" type="var">h3</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span>]; <span class="id" type="tactic">intros</span> <span class="id" type="var">sigma</span> <span class="id" type="var">h1</span> <span class="id" type="var">h2</span> <span class="id" type="var">h3</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> <span class="id" type="var">nil</span>; <span class="id" type="var">exists</span> <span class="id" type="var">nil</span>; <span class="id" type="tactic">repeat</span> <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span>; <span class="id" type="var">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span>; <span class="id" type="var">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">IHl</span> <span class="id" type="keyword">with</span> <span class="id" type="var">sigma</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">ls</span> [<span class="id" type="var">tau</span> [<span class="id" type="var">H0</span> [<span class="id" type="var">Wls</span> [<span class="id" type="var">H1</span> [<span class="id" type="var">H2</span> [<span class="id" type="var">H3</span> <span class="id" type="var">H4</span>]]]]]]]; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">tail_set</span> <span class="id" type="var">_</span> <span class="id" type="var">Hl</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">Hl</span> <span class="id" type="var">t</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) (<span class="id" type="var">tau</span> ++ <span class="id" type="var">sigma</span>) <span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">H3</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">s</span> [<span class="id" type="var">tau'</span> [<span class="id" type="var">K0</span> [<span class="id" type="var">Ws</span> [<span class="id" type="var">K1</span> [<span class="id" type="var">K2</span> [<span class="id" type="var">K3</span> <span class="id" type="var">K4</span>]]]]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> (<span class="id" type="var">s</span> :: <span class="id" type="var">ls</span>); <span class="id" type="var">exists</span> (<span class="id" type="var">tau'</span> ++ <span class="id" type="var">tau</span>); <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">ass_app</span>; <span class="id" type="tactic">repeat</span> <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">f_equal2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">map_eq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">u_in_ls</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">subst_eq_vars</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_u</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">find_app</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">tau'</span> (<span class="id" type="var">tau</span> ++ <span class="id" type="var">sigma</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">mem_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v</span> (<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> : <span class="id" type="var">T1.variable</span> * <span class="id" type="var">T1.term</span> =&gt; <span class="id" type="var">fst</span> <span class="id" type="var">st</span>) <span class="id" type="var">tau'</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">case</span> (<span class="id" type="var">mem_bool</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> (<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> : <span class="id" type="var">T1.variable</span> * <span class="id" type="var">T1.term</span> =&gt; <span class="id" type="var">fst</span> <span class="id" type="var">st</span>) <span class="id" type="var">tau'</span>));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="id" type="tactic">intro</span> <span class="id" type="var">v_in_tau'</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v_not_in_tau'</span>]; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">tau'</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">v_val</span> <span class="id" type="var">v_tau'</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v_tau'</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> (<span class="id" type="var">tau</span> ++ <span class="id" type="var">sigma</span>)); [<span class="id" type="tactic">intros</span> <span class="id" type="var">v_val'</span> <span class="id" type="var">v_tau</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v_tau</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">K2</span> <span class="id" type="var">v</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find_mem</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">v_tau</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v'</span> [<span class="id" type="var">tau1</span> [<span class="id" type="var">tau2</span> [<span class="id" type="var">v_eq_v'</span> <span class="id" type="var">H</span>]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">v'</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">left</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find_mem</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">v_tau'</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v'</span> [<span class="id" type="var">tau1</span> [<span class="id" type="var">tau2</span> [<span class="id" type="var">v_eq_v'</span> <span class="id" type="var">H</span>]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">v'</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">H</span> : <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) (<span class="id" type="var">tau</span> ++ <span class="id" type="var">sigma</span>))).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">H4</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">in_split</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">u_in_ls</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">ls1</span> [<span class="id" type="var">ls2</span> <span class="id" type="var">H</span>]]; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_list_list_app</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [[<span class="id" type="var">v'</span> <span class="id" type="var">u'</span>] [<span class="id" type="var">v_eq_v'</span> <span class="id" type="var">H</span>]]; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_eq_v'</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">v'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">find_not_found</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">v</span> <span class="id" type="var">u'</span> (<span class="id" type="var">tau</span> ++ <span class="id" type="var">sigma</span>) <span class="id" type="var">v_tau</span> (<span class="id" type="var">eq_var_bool_refl</span> <span class="id" type="var">v</span>) <span class="id" type="var">H</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">mem_map_set</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span>  <span class="id" type="var">_</span> <span class="id" type="var">v</span> <span class="id" type="var">tau'</span> <span class="id" type="var">v_in_tau'</span>) <span class="id" type="keyword">as</span> [[<span class="id" type="var">v'</span> <span class="id" type="var">u'</span>] [<span class="id" type="var">v_eq_v'</span> <span class="id" type="var">v_in_tau''</span>]]; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_eq_v'</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">v'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">find_not_found</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">v</span> <span class="id" type="var">u'</span> <span class="id" type="var">tau'</span> <span class="id" type="var">v_tau'</span> (<span class="id" type="var">eq_var_bool_refl</span> <span class="id" type="var">v</span>) <span class="id" type="var">v_in_tau''</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">si</span> [<span class="id" type="var">si_eq_s</span> | <span class="id" type="var">si_in_ls</span>]; [<span class="id" type="tactic">subst</span>; <span class="id" type="tactic">assumption</span> | <span class="id" type="tactic">apply</span> <span class="id" type="var">Wls</span>; <span class="id" type="tactic">assumption</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_sls</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">in_app_or</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">v_in_sls</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v_in_s</span> | <span class="id" type="var">v_in_ls</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">v_in_sls</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">K4</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">map_app</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H4</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">Aux</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">ls</span> [<span class="id" type="var">tau</span> [<span class="id" type="var">H0</span> [<span class="id" type="var">Wls</span> [<span class="id" type="var">H1</span> [<span class="id" type="var">H2</span> [<span class="id" type="var">H3</span> <span class="id" type="var">H4</span>]]]]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">ls</span>); <span class="id" type="var">exists</span> <span class="id" type="var">tau</span>; <span class="id" type="tactic">repeat</span> <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="tactic">f_equal</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_fold</span>; <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">exact</span> <span class="id" type="var">Wls</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H0</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Wf</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">length_map</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Wf</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">F.arity</span> <span class="id" type="var">f</span>); <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">set</span> (<span class="id" type="var">m</span> := (<span class="id" type="var">S</span> (<span class="id" type="var">maxl</span> <span class="id" type="var">_</span> (<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">xt</span> =&gt; (<span class="id" type="var">inject_inv</span> (<span class="id" type="var">fst</span> <span class="id" type="var">xt</span>), <span class="id" type="var">snd</span> <span class="id" type="var">xt</span>)) <span class="id" type="var">sigma</span>)))).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> (<span class="id" type="var">Var</span> (<span class="id" type="var">inject</span> <span class="id" type="var">m</span>)); <span class="id" type="var">exists</span> ((<span class="id" type="var">inject</span> <span class="id" type="var">m</span>, <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> ) :: <span class="id" type="var">nil</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">eq_var_bool_refl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span> [<span class="id" type="var">xu_eq_mv</span> | <span class="id" type="var">xu_in_sigma</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">xu_eq_mv</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">L</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">not_Wf</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">sym_eq</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">h1</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span> <span class="id" type="var">xu_in_sigma</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span> <span class="id" type="var">u'</span> [<span class="id" type="var">xu_eq_mv</span> | <span class="id" type="var">xu_in_sigma</span>] [<span class="id" type="var">xu'_eq_mv</span> | <span class="id" type="var">xu'_in_sigma</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">xu_eq_mv</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">xu'_eq_mv</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">xu_eq_mv</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">xu_eq_mv</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">absurd</span> (<span class="id" type="var">m</span> &lt; <span class="id" type="var">m</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">le_n_S</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">maxl_is_max</span> <span class="id" type="var">_</span> (<span class="id" type="var">map</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">fun</span> <span class="id" type="var">xt</span> : <span class="id" type="var">T1.variable</span> * <span class="id" type="var">T1.term</span> =&gt; (<span class="id" type="var">inject_inv</span> (<span class="id" type="var">fst</span> <span class="id" type="var">xt</span>), <span class="id" type="var">snd</span> <span class="id" type="var">xt</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">sigma</span>) <span class="id" type="var">m</span> <span class="id" type="var">u'</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> (<span class="id" type="var">inject</span> <span class="id" type="var">m</span>, <span class="id" type="var">u'</span>); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Hinject2</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">xu'_eq_mv</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">xu'_eq_mv</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">x</span> <span class="id" type="var">u'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">absurd</span> (<span class="id" type="var">m</span> &lt; <span class="id" type="var">m</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">le_n_S</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">maxl_is_max</span> <span class="id" type="var">_</span> (<span class="id" type="var">map</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">fun</span> <span class="id" type="var">xt</span> : <span class="id" type="var">T1.variable</span> * <span class="id" type="var">T1.term</span> =&gt; (<span class="id" type="var">inject_inv</span> (<span class="id" type="var">fst</span> <span class="id" type="var">xt</span>), <span class="id" type="var">snd</span> <span class="id" type="var">xt</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">sigma</span>) <span class="id" type="var">m</span> <span class="id" type="var">u</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> (<span class="id" type="var">inject</span> <span class="id" type="var">m</span>, <span class="id" type="var">u</span>); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Hinject2</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">h2</span> <span class="id" type="var">x</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span> <span class="id" type="var">u</span> [<span class="id" type="var">xu_eq_mv</span> | <span class="id" type="var">xu_in_sigma</span>] [<span class="id" type="var">yu_eq_mv</span> | <span class="id" type="var">yu_in_sigma</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">xu_eq_mv</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">yu_eq_mv</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">xu_eq_mv</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">xu_eq_mv</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">fl_not_in_sig</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_impl_mem</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">y</span>, <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">yu_eq_mv</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">yu_eq_mv</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">y</span> <span class="id" type="var">u</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">fl_not_in_sig</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_impl_mem</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">x</span>, <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">h3</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span> <span class="id" type="var">u</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">z</span> [<span class="id" type="var">z_eq_m</span> | <span class="id" type="var">z_in_nil</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">decompose_term</span> : <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="id" type="var">s</span> : <span class="id" type="var">term</span> &amp; {<span class="id" type="var">sigma</span> : <span class="id" type="var">substitution</span> | <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">t</span> = <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">s</span> /\ <span class="id" type="var">well_formed</span> <span class="id" type="var">s</span> /\ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span>, <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,u) <span class="id" type="var">sigma</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">u</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">True</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> =&gt; (<span class="id" type="keyword">match</span> <span class="id" type="var">F.arity</span> <span class="id" type="var">f</span> <span class="id" type="keyword">with</span> <span class="id" type="var">Free</span> <span class="id" type="var">n</span> =&gt; <span class="id" type="var">n</span> | <span class="id" type="var">_</span> =&gt; 2 <span class="id" type="keyword">end</span>) &lt;&gt; <span class="id" type="var">length</span> <span class="id" type="var">l</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span>, <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,u) <span class="id" type="var">sigma</span> -&gt; <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,v) <span class="id" type="var">sigma</span> -&gt; <span class="id" type="var">u</span> = <span class="id" type="var">v</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span> <span class="id" type="var">u</span>, <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,u) <span class="id" type="var">sigma</span> -&gt; <span class="id" type="var">In</span> (<span class="id" type="var">y</span>,u) <span class="id" type="var">sigma</span> -&gt; <span class="id" type="var">x</span> = <span class="id" type="var">y</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span>, <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>) &lt;-&gt; <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">sigma</span>))}}.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">t</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">decompose_term_aux</span> <span class="id" type="var">t</span> <span class="id" type="var">nil</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">s</span> [<span class="id" type="var">sigma</span> [<span class="id" type="var">H0</span> [<span class="id" type="var">Ws</span> [<span class="id" type="var">H1</span> [<span class="id" type="var">H2</span> [<span class="id" type="var">H3</span> <span class="id" type="var">H4</span>]]]]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span>; <span class="id" type="var">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span>; <span class="id" type="var">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span>; <span class="id" type="var">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> <span class="id" type="var">s</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">subst_rest</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>) <span class="id" type="var">sigma</span>); <span class="id" type="tactic">repeat</span> <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">app_nil_end</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">subst_eq_vars</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_s</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">subst_rest_ok</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span> <span class="id" type="var">xu_in_rest_sig</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">H1</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span>); <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">app_nil_end</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">subst_rest_subst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">xu_in_rest_sig</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span> <span class="id" type="var">xu_in_rest_sig</span> <span class="id" type="var">xv_in_rest_sig</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">H2</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span>); <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">app_nil_end</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">subst_rest_subst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">xu_in_rest_sig</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">subst_rest_subst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">xv_in_rest_sig</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span> <span class="id" type="var">u</span> <span class="id" type="var">xu_in_rest_sig</span> <span class="id" type="var">yu_in_rest_sig</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">H3</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span> <span class="id" type="var">u</span>); <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">app_nil_end</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">subst_rest_subst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">xu_in_rest_sig</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">subst_rest_subst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">yu_in_rest_sig</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x_in_s</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">H4</span> <span class="id" type="var">_</span> <span class="id" type="var">x_in_s</span>); <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">app_nil_end</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> [[<span class="id" type="var">x'</span> <span class="id" type="var">u</span>] [<span class="id" type="var">x_eq_x'</span> <span class="id" type="var">x_in_sig</span>]]; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">x_eq_x'</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">x'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> (<span class="id" type="var">x</span>,u); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">subst_rest_subst_rest</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">x_in_sig</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">x_in_sig</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">x_in_sig</span> <span class="id" type="keyword">as</span> [[<span class="id" type="var">x'</span> <span class="id" type="var">u</span>] [<span class="id" type="var">x_eq_x'</span> <span class="id" type="var">x_in_sig</span>]]; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">x_eq_x'</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">x'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">subst_rest_rest</span> <span class="id" type="keyword">with</span> <span class="id" type="var">sigma</span> <span class="id" type="var">u</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">decompose_subst_aux</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">s1</span> <span class="id" type="var">s2</span> <span class="id" type="var">sigma</span>, <span class="id" type="var">well_formed</span> <span class="id" type="var">s1</span> -&gt; <span class="id" type="var">well_formed</span> <span class="id" type="var">s2</span>-&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span>, <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,u) <span class="id" type="var">sigma</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">u</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">True</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> =&gt; (<span class="id" type="keyword">match</span> <span class="id" type="var">F.arity</span> <span class="id" type="var">f</span> <span class="id" type="keyword">with</span> <span class="id" type="var">Free</span> <span class="id" type="var">n</span> =&gt; <span class="id" type="var">n</span> | <span class="id" type="var">_</span> =&gt; 2 <span class="id" type="keyword">end</span>) &lt;&gt; <span class="id" type="var">length</span> <span class="id" type="var">l</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span>, <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,u) <span class="id" type="var">sigma</span> -&gt; <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,v) <span class="id" type="var">sigma</span> -&gt; <span class="id" type="var">u</span> = <span class="id" type="var">v</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span> <span class="id" type="var">u</span>, <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,u) <span class="id" type="var">sigma</span> -&gt; <span class="id" type="var">In</span> (<span class="id" type="var">y</span>,u) <span class="id" type="var">sigma</span> -&gt; <span class="id" type="var">x</span> = <span class="id" type="var">y</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span>, <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s1</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">sigma</span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span>, <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s2</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">sigma</span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">s1</span> = <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">s2</span> -&gt; <span class="id" type="var">s1</span> = <span class="id" type="var">s2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">s1</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">s1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">s1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">v1</span> [<span class="id" type="var">v2</span> | <span class="id" type="var">f2</span> <span class="id" type="var">l2</span>] <span class="id" type="var">sigma</span> <span class="id" type="var">W1</span> <span class="id" type="var">W2</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">H3</span> <span class="id" type="var">H41</span> <span class="id" type="var">H42</span> <span class="id" type="var">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="tactic">f_equal</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H3</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v1</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">v1_in_sig</span> : <span class="id" type="var">In</span> <span class="id" type="var">v1</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">sigma</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">H41</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v1_in_sig</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">v1_in_sig</span> <span class="id" type="keyword">as</span> [[<span class="id" type="var">v1'</span> <span class="id" type="var">u1</span>] [<span class="id" type="var">v1_eq_v1'</span> <span class="id" type="var">v1_in_sig</span>]]; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v1_eq_v1'</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">v1'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">subst_aux</span> <span class="id" type="var">_</span> <span class="id" type="var">H2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">v1_in_sig</span>); <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">assert</span> (<span class="id" type="var">v2_in_sig</span> : <span class="id" type="var">In</span> <span class="id" type="var">v2</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">sigma</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">H42</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v2_in_sig</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">v2_in_sig</span> <span class="id" type="keyword">as</span> [[<span class="id" type="var">v2'</span> <span class="id" type="var">u1</span>] [<span class="id" type="var">v2_eq_v2'</span> <span class="id" type="var">v2_in_sig</span>]]; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v2_eq_v2'</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">v2'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">subst_aux</span> <span class="id" type="var">_</span> <span class="id" type="var">H2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">v2_in_sig</span>); <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">v1_in_sig</span> : <span class="id" type="var">In</span> <span class="id" type="var">v1</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">sigma</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">H41</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v1_in_sig</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">v1_in_sig</span> <span class="id" type="keyword">as</span> [[<span class="id" type="var">v1'</span> <span class="id" type="var">u1</span>] [<span class="id" type="var">v1_eq_v1'</span> <span class="id" type="var">v1_in_sig</span>]]; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v1_eq_v1'</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">v1'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">subst_aux</span> <span class="id" type="var">_</span> <span class="id" type="var">H2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">v1_in_sig</span>) <span class="id" type="keyword">in</span> <span class="id" type="var">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">u1</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x1</span> | <span class="id" type="var">g1</span> <span class="id" type="var">k1</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">H1</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">v1_in_sig</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">intro</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">g1</span> <span class="id" type="var">k1</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">map_length</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">sym_eq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">well_formed_unfold</span> <span class="id" type="var">W2</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">_</span> <span class="id" type="var">L2</span>]; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">F.arity</span> <span class="id" type="var">f2</span>); <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">f1</span> <span class="id" type="var">l1</span> <span class="id" type="var">Hl1</span> [<span class="id" type="var">v2</span> | <span class="id" type="var">f2</span> <span class="id" type="var">l2</span>] <span class="id" type="var">sigma</span> <span class="id" type="var">W1</span> <span class="id" type="var">W2</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">H3</span> <span class="id" type="var">H41</span> <span class="id" type="var">H42</span> <span class="id" type="var">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">v2_in_sig</span> : <span class="id" type="var">In</span> <span class="id" type="var">v2</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">sigma</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">H42</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v2_in_sig</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">v2_in_sig</span> <span class="id" type="keyword">as</span> [[<span class="id" type="var">v2'</span> <span class="id" type="var">u2</span>] [<span class="id" type="var">v2_eq_v2'</span> <span class="id" type="var">v2_in_sig</span>]]; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v2_eq_v2'</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">v2'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">subst_aux</span> <span class="id" type="var">_</span> <span class="id" type="var">H2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">v2_in_sig</span>) <span class="id" type="keyword">in</span> <span class="id" type="var">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">u2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x2</span> | <span class="id" type="var">g2</span> <span class="id" type="var">k2</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">H1</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">v2_in_sig</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">intro</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">g2</span> <span class="id" type="var">k2</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">map_length</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">sym_eq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">well_formed_unfold</span> <span class="id" type="var">W1</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">_</span> <span class="id" type="var">L1</span>]; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">F.arity</span> <span class="id" type="var">f1</span>); <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">intro</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">f2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="tactic">f_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_list_unfold</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H41</span>, <span class="id" type="var">H42</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">well_formed_unfold</span> <span class="id" type="var">W1</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">Wl1</span> <span class="id" type="var">_</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">W1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">well_formed_unfold</span> <span class="id" type="var">W2</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">Wl2</span> <span class="id" type="var">_</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">W2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">revert</span> <span class="id" type="var">l2</span> <span class="id" type="var">sigma</span> <span class="id" type="var">Wl1</span> <span class="id" type="var">Wl2</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">H3</span> <span class="id" type="var">H41</span> <span class="id" type="var">H42</span> <span class="id" type="var">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">l1</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t1</span> <span class="id" type="var">l1</span>]; <span class="id" type="tactic">intros</span> [ | <span class="id" type="var">t2</span> <span class="id" type="var">l2</span>] <span class="id" type="var">sigma</span> <span class="id" type="var">Wl1</span> <span class="id" type="var">Wl2</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">H3</span> <span class="id" type="var">H41</span> <span class="id" type="var">H42</span> <span class="id" type="var">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">H0</span> <span class="id" type="var">h0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">Hl1</span> <span class="id" type="var">t1</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) <span class="id" type="var">t2</span> <span class="id" type="var">sigma</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="tactic">f_equal</span>; <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">IHl1</span> (<span class="id" type="var">tail_prop</span> <span class="id" type="var">_</span> <span class="id" type="var">Hl1</span>) <span class="id" type="var">l2</span> <span class="id" type="var">sigma</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">u_in_l1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Wl1</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">u_in_l2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Wl2</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_l1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H41</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_l2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H42</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Wl1</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Wl2</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_t1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H41</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_t2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H42</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">decompose_subst</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span> <span class="id" type="var">tau</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">well_formed</span> <span class="id" type="var">s</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span>, <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,u) <span class="id" type="var">sigma</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">u</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">True</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> =&gt; (<span class="id" type="keyword">match</span> <span class="id" type="var">F.arity</span> <span class="id" type="var">f</span> <span class="id" type="keyword">with</span> <span class="id" type="var">Free</span> <span class="id" type="var">n</span> =&gt; <span class="id" type="var">n</span> | <span class="id" type="var">_</span> =&gt; 2 <span class="id" type="keyword">end</span>) &lt;&gt; <span class="id" type="var">length</span> <span class="id" type="var">l</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span>, <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,u) <span class="id" type="var">sigma</span> -&gt; <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,v) <span class="id" type="var">sigma</span> -&gt; <span class="id" type="var">u</span> = <span class="id" type="var">v</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span> <span class="id" type="var">u</span>, <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,u) <span class="id" type="var">sigma</span> -&gt; <span class="id" type="var">In</span> (<span class="id" type="var">y</span>,u) <span class="id" type="var">sigma</span> -&gt; <span class="id" type="var">x</span> = <span class="id" type="var">y</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span>, <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>) &lt;-&gt; <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">sigma</span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">well_formed</span> <span class="id" type="var">t</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">apply_subst</span> <span class="id" type="var">tau</span> <span class="id" type="var">t</span> = <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">s</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="id" type="var">phi</span> : <span class="id" type="var">substitution</span> | (<span class="id" type="keyword">forall</span> <span class="id" type="var">v</span>, <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">t</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">apply_subst</span> (<span class="id" type="var">subst_comp</span> <span class="id" type="var">sigma</span> <span class="id" type="var">phi</span>) (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>) = <span class="id" type="var">apply_subst</span> <span class="id" type="var">tau</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>)) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">apply_subst</span> <span class="id" type="var">phi</span> <span class="id" type="var">t</span> = <span class="id" type="var">s</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">v</span>, <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">phi</span>) &lt;-&gt; <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">t</span>)) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">well_formed_subst</span> <span class="id" type="var">phi</span>}.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span> <span class="id" type="var">tau</span> <span class="id" type="var">Ws</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">H3</span> <span class="id" type="var">H4</span> <span class="id" type="var">Wt</span> <span class="id" type="var">H0</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">Aux</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">v</span> <span class="id" type="var">p</span>, <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>) -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="id" type="var">v_val</span> : <span class="id" type="var">term</span> | <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">s</span> <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> <span class="id" type="var">v_val</span> /\ <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">v_val</span> = <span class="id" type="var">apply_subst</span> <span class="id" type="var">tau</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>)}).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">revert</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span> <span class="id" type="var">tau</span> <span class="id" type="var">Ws</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">H3</span> <span class="id" type="var">H4</span> <span class="id" type="var">Wt</span> <span class="id" type="var">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">pattern</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">s</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span> <span class="id" type="var">tau</span> <span class="id" type="var">Ws</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">H3</span> <span class="id" type="var">H4</span> <span class="id" type="var">Wt</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H0</span>; <span class="id" type="var">revert</span> <span class="id" type="var">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">v_in_sig</span> : <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">sigma</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H4</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">mem_map_set</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">v</span> <span class="id" type="var">sigma</span>) <span class="id" type="keyword">as</span> [[<span class="id" type="var">v'</span> <span class="id" type="var">v_val</span>] [<span class="id" type="var">v_eq_v'</span> <span class="id" type="var">v_in_sig'</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">in_impl_mem</span>; [<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span> | <span class="id" type="tactic">assumption</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_eq_v'</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">v'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">subst_aux</span> <span class="id" type="var">_</span> <span class="id" type="var">H2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">v_in_sig'</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">H1</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">v_in_sig'</span>); <span class="id" type="tactic">destruct</span> <span class="id" type="var">v_val</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x</span> | <span class="id" type="var">f</span> <span class="id" type="var">l</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">y</span> | ]; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">intro</span>; <span class="id" type="tactic">discriminate</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">H0</span> <span class="id" type="var">x'</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">p</span>]; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">intro</span>; <span class="id" type="tactic">discriminate</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">x'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>); <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">subst_aux</span> <span class="id" type="var">_</span> <span class="id" type="var">H2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">v_in_sig'</span>); <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">L</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">y</span> | <span class="id" type="var">g</span> <span class="id" type="var">k</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">H0</span> <span class="id" type="var">x'</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">p</span>]; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">intro</span>; <span class="id" type="tactic">discriminate</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">x'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>); <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">subst_aux</span> <span class="id" type="var">_</span> <span class="id" type="var">H2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">v_in_sig'</span>); <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">intro</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">g</span> <span class="id" type="var">l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">L</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">map_length</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">sym_eq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">well_formed_unfold</span> <span class="id" type="var">Wt</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">_</span> <span class="id" type="var">L'</span>]; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">F.arity</span> <span class="id" type="var">f</span>); <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">ls</span> <span class="id" type="var">Hls</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span> <span class="id" type="var">tau</span> <span class="id" type="var">Ws</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">H3</span> <span class="id" type="var">H4</span> <span class="id" type="var">Wt</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">y</span> | <span class="id" type="var">g</span> <span class="id" type="var">lt</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">H0</span> <span class="id" type="var">x'</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">p</span>]; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">intro</span>; <span class="id" type="tactic">discriminate</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">x'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">ls</span>); <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">sym_eq</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">H0</span> <span class="id" type="var">H0'</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">g</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">p</span>] <span class="id" type="var">Sub</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Sub</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">nth_error_ok_in</span> <span class="id" type="var">i</span> <span class="id" type="var">lt</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">nth_error</span> <span class="id" type="var">lt</span> <span class="id" type="var">i</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">ti</span> | ]; [<span class="id" type="tactic">intros</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">H</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">lt1</span> [<span class="id" type="var">lt2</span> [<span class="id" type="var">L</span> <span class="id" type="var">H'</span>]]]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span> | <span class="id" type="tactic">discriminate</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H'</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">map_app</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">split_map_set</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> (<span class="id" type="var">sym_eq</span>  <span class="id" type="var">H0</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">ls1</span> [<span class="id" type="var">ls2</span> [<span class="id" type="var">h1</span> [<span class="id" type="var">h2</span> <span class="id" type="var">h3</span>]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">ls2</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">si</span> <span class="id" type="var">ls2</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">si_in_ls</span> : <span class="id" type="var">In</span> <span class="id" type="var">si</span> <span class="id" type="var">ls</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">h1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">Hls</span> <span class="id" type="var">_</span> <span class="id" type="var">si_in_ls</span> (<span class="id" type="var">subst_rest</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">si</span>) <span class="id" type="var">sigma</span>) <span class="id" type="var">ti</span> <span class="id" type="var">tau</span>) <span class="id" type="keyword">with</span> <span class="id" type="var">x</span> <span class="id" type="var">p</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v_val</span> [<span class="id" type="var">Sub'</span> <span class="id" type="var">Sub''</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">well_formed_unfold</span> <span class="id" type="var">Ws</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">Wls</span> <span class="id" type="var">_</span>]; <span class="id" type="tactic">apply</span> <span class="id" type="var">Wls</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">y</span> <span class="id" type="var">u</span> <span class="id" type="var">yu_in_rest_sig</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">H1</span> <span class="id" type="var">y</span>); <span class="id" type="tactic">apply</span> <span class="id" type="var">subst_rest_subst</span>  <span class="id" type="keyword">with</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">si</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">y</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span> <span class="id" type="var">yu_in_rest_sig</span> <span class="id" type="var">yv_in_rest_sig</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">H2</span> <span class="id" type="var">y</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">subst_rest_subst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">yu_in_rest_sig</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">subst_rest_subst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">yv_in_rest_sig</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">y</span> <span class="id" type="var">z</span> <span class="id" type="var">u</span> <span class="id" type="var">yu_in_rest_sig</span> <span class="id" type="var">zu_in_rest_sig</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">H3</span> <span class="id" type="var">y</span> <span class="id" type="var">z</span> <span class="id" type="var">u</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">subst_rest_subst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">yu_in_rest_sig</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">subst_rest_subst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">zu_in_rest_sig</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">y</span>; <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">y_in_si</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">y_in_sig</span> : <span class="id" type="var">In</span> <span class="id" type="var">y</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">sigma</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H4</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">h1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_list_unfold</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_list_list_app</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">y_in_sig</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">y_in_sig</span> <span class="id" type="keyword">as</span> [[<span class="id" type="var">y'</span> <span class="id" type="var">u</span>] [<span class="id" type="var">y_eq_y'</span> <span class="id" type="var">y_in_sig</span>]]; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">y_eq_y'</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">y'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">y</span>,u); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">subst_rest_subst_rest</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">y_in_rest_subst</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">y_in_rest_subst</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">y_in_rest_subst</span> <span class="id" type="keyword">as</span> [[<span class="id" type="var">y'</span> <span class="id" type="var">u</span>] [<span class="id" type="var">y_eq_y'</span> <span class="id" type="var">y_in_rest_subst</span>]]; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">y_eq_y'</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">y'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">subst_rest_rest</span> <span class="id" type="keyword">with</span> <span class="id" type="var">sigma</span> <span class="id" type="var">u</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">well_formed_unfold</span> <span class="id" type="var">Wt</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">Wlt</span> <span class="id" type="var">_</span>]; <span class="id" type="tactic">apply</span> <span class="id" type="var">Wlt</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">h3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">h3</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> <span class="id" type="var">h3</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">h3</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">subst_eq_vars</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">z</span> <span class="id" type="var">z_in_si</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">subst_rest_ok</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> <span class="id" type="var">v_val</span>; <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">h1</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">i</span>; <span class="id" type="tactic">replace</span> (<span class="id" type="var">length</span> <span class="id" type="var">lt1</span>) <span class="id" type="keyword">with</span> (<span class="id" type="var">length</span> <span class="id" type="var">ls1</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">nth_error_at_pos</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- (<span class="id" type="var">length_map</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">ls1</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- (<span class="id" type="var">length_map</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">tau</span>) <span class="id" type="var">lt1</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="tactic">f_equal</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">Sub''</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">subst_eq_vars</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_val</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">subst_rest_ok</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">var_in_subterm</span> <span class="id" type="keyword">with</span> <span class="id" type="var">v_val</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">Aux2</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">v</span>, <span class="id" type="var">mem</span> (@<span class="id" type="var">eq</span> <span class="id" type="var">_</span>) <span class="id" type="var">v</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">t</span>) -&gt; {<span class="id" type="var">v_val</span> : <span class="id" type="var">term</span> | <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">v_val</span> = <span class="id" type="var">apply_subst</span> <span class="id" type="var">tau</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">p</span>, <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">s</span> <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> <span class="id" type="var">v_val</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">well_formed</span> <span class="id" type="var">v_val</span>}).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_t</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">var_in_subterm2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">v_in_t</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">p</span> <span class="id" type="var">Sub</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">Aux</span> <span class="id" type="var">v</span> <span class="id" type="var">p</span> <span class="id" type="var">Sub</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v_val</span> [<span class="id" type="var">Sub'</span> <span class="id" type="var">H</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> <span class="id" type="var">v_val</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">q</span> <span class="id" type="var">Subq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">Aux</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">Subq</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v_val'</span> [<span class="id" type="var">Sub''</span> <span class="id" type="var">H'</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Sub''</span>; <span class="id" type="tactic">apply</span> <span class="id" type="tactic">f_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">decompose_subst_aux</span> <span class="id" type="keyword">with</span> <span class="id" type="var">sigma</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">well_formed_subterm</span> <span class="id" type="var">q</span> <span class="id" type="var">Ws</span> <span class="id" type="var">Sub''</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">well_formed_subterm</span> <span class="id" type="var">p</span> <span class="id" type="var">Ws</span> <span class="id" type="var">Sub'</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">x_in_v_val'</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H4</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">var_in_subterm</span> <span class="id" type="keyword">with</span> <span class="id" type="var">v_val'</span> <span class="id" type="var">q</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">x_in_v_val</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H4</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">var_in_subterm</span> <span class="id" type="keyword">with</span> <span class="id" type="var">v_val</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">well_formed_subterm</span> <span class="id" type="var">p</span> <span class="id" type="var">Ws</span> <span class="id" type="var">Sub'</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">clear</span> <span class="id" type="var">Aux</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">revert</span> <span class="id" type="var">Wt</span> <span class="id" type="var">s</span> <span class="id" type="var">Ws</span> <span class="id" type="var">sigma</span> <span class="id" type="var">tau</span> <span class="id" type="var">H0</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">H3</span> <span class="id" type="var">H4</span> <span class="id" type="var">Aux2</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">_</span> <span class="id" type="var">s</span> <span class="id" type="var">Ws</span> <span class="id" type="var">sigma</span> <span class="id" type="var">tau</span> <span class="id" type="var">H0</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">H3</span> <span class="id" type="var">H4</span> <span class="id" type="var">Aux2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">Aux2</span> <span class="id" type="var">v</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v_val</span> [<span class="id" type="var">K1</span> [<span class="id" type="var">K2</span> <span class="id" type="var">K3</span>]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> ((<span class="id" type="var">v</span>,v_val) :: <span class="id" type="var">nil</span>); <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">z</span> [<span class="id" type="var">z_eq_v</span> | <span class="id" type="var">z_in_nil</span>]; [<span class="id" type="tactic">subst</span> <span class="id" type="var">z</span> | <span class="id" type="var">contradiction</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">subst_comp_is_subst_comp</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">eq_var_bool_refl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">K1</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">eq_var_bool_refl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">K2'</span> := <span class="id" type="var">K2</span> <span class="id" type="var">nil</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)); <span class="id" type="tactic">injection</span> <span class="id" type="var">K2'</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">sym_eq</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">z</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">well_formed_subst</span>; <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">z</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">z</span> <span class="id" type="var">v</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">z</span> <span class="id" type="var">v</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">z_eq_v</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">z_diff_v</span>]; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">lt</span> <span class="id" type="var">Hlt</span> <span class="id" type="var">Wt</span> <span class="id" type="var">s</span> <span class="id" type="var">Ws</span> <span class="id" type="var">sigma</span> <span class="id" type="var">tau</span> <span class="id" type="var">H0</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">H3</span> <span class="id" type="var">H4</span> <span class="id" type="var">Aux2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">s</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x</span> | <span class="id" type="var">g</span> <span class="id" type="var">ls</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">well_formed_unfold</span> <span class="id" type="var">Wt</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">_</span> <span class="id" type="var">L</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">x_in_sig</span> : <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">sigma</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H4</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">x_in_sig</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">x_in_sig</span> <span class="id" type="keyword">as</span> [[<span class="id" type="var">x'</span> <span class="id" type="var">u</span>] [<span class="id" type="var">x_eq_x'</span> <span class="id" type="var">x_in_sig</span>]]; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">x_eq_x'</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">x'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">subst_aux</span> <span class="id" type="var">_</span> <span class="id" type="var">H2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">x_in_sig</span>) <span class="id" type="keyword">in</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">u</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">H1</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">x_in_sig</span>); <span class="id" type="tactic">apply</span> <span class="id" type="var">sym_eq</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">length_map</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">F.arity</span> <span class="id" type="var">f</span>); <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">H0</span> <span class="id" type="var">h0</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">g</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_list_unfold</span> <span class="id" type="keyword">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">well_formed_unfold</span> <span class="id" type="var">Wt</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">Wlt</span> <span class="id" type="var">_</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">Wt</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">well_formed_unfold</span> <span class="id" type="var">Ws</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">Wls</span> <span class="id" type="var">_</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">Ws</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">revert</span> <span class="id" type="var">Wlt</span> <span class="id" type="var">ls</span> <span class="id" type="var">Wls</span> <span class="id" type="var">sigma</span> <span class="id" type="var">H0</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">H3</span> <span class="id" type="var">H4</span> <span class="id" type="var">Aux2</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">lt</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">lt</span>]; <span class="id" type="tactic">intros</span> <span class="id" type="var">Wlt</span> <span class="id" type="var">ls</span> <span class="id" type="var">Wls</span> <span class="id" type="var">sigma</span> <span class="id" type="var">H0</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">H3</span> <span class="id" type="var">H4</span> <span class="id" type="var">Aux2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">ls</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">s</span> <span class="id" type="var">ls</span>]; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">discriminate</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> <span class="id" type="var">nil</span>; <span class="id" type="tactic">repeat</span> <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span>; <span class="id" type="var">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">ls</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">s</span> <span class="id" type="var">ls</span>]; [<span class="id" type="tactic">discriminate</span> | <span class="id" type="var">idtac</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">H0</span> <span class="id" type="var">h0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">Hlt</span> <span class="id" type="var">t</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) (<span class="id" type="var">Wlt</span> <span class="id" type="var">t</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>))) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">s</span> (<span class="id" type="var">Wls</span> <span class="id" type="var">s</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>))) (<span class="id" type="var">subst_rest</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>) <span class="id" type="var">sigma</span>)) <span class="id" type="keyword">with</span> <span class="id" type="var">tau</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">phi</span> [<span class="id" type="var">k1</span> [<span class="id" type="var">k2</span> [<span class="id" type="var">k3</span> <span class="id" type="var">k4</span>]]]]; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">h0</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">subst_eq_vars</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">x_in_s</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">subst_rest_ok</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span> <span class="id" type="var">xu_in_rest_sig</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">H1</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span>); <span class="id" type="tactic">apply</span> <span class="id" type="var">subst_rest_subst</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span> <span class="id" type="var">xu_in_rest_sig</span> <span class="id" type="var">xv_in_rest_sig</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">H2</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span>); <span class="id" type="tactic">apply</span> <span class="id" type="var">subst_rest_subst</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span> <span class="id" type="var">u</span> <span class="id" type="var">xu_in_rest_sig</span> <span class="id" type="var">yu_in_rest_sig</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">H3</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span> <span class="id" type="var">u</span>); <span class="id" type="tactic">apply</span> <span class="id" type="var">subst_rest_subst</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">x</span>; <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">x_in_s</span>; <span class="id" type="tactic">assert</span> (<span class="id" type="var">x_in_sig</span> : <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">sigma</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H4</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">x_in_sig</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">x_in_sig</span> <span class="id" type="keyword">as</span> [[<span class="id" type="var">x'</span> <span class="id" type="var">u</span>] [<span class="id" type="var">x_eq_x'</span> <span class="id" type="var">x_in_sig</span>]]; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">x_eq_x'</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">x'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">x</span>,u); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">subst_rest_subst_rest</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">x_in_rest_sig</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">x_in_rest_sig</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">x_in_rest_sig</span> <span class="id" type="keyword">as</span> [[<span class="id" type="var">x'</span> <span class="id" type="var">u</span>] [<span class="id" type="var">x_eq_x'</span> <span class="id" type="var">x_in_rest_sig</span>]]; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">x_eq_x'</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">x'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">subst_rest_rest</span> <span class="id" type="keyword">with</span> <span class="id" type="var">sigma</span> <span class="id" type="var">u</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_t</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">Aux2</span> <span class="id" type="var">v</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v_val</span> [<span class="id" type="var">K1</span> [<span class="id" type="var">K2</span> <span class="id" type="var">K3</span>]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">mem_or_app</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> <span class="id" type="var">v_val</span>; <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">K1</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">subst_eq_vars</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">z_in_val</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">subst_rest_ok</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">var_in_subterm2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">v_in_t</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">p</span> <span class="id" type="var">Sub</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">var_in_subterm</span> <span class="id" type="keyword">with</span> <span class="id" type="var">v_val</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">K2</span> (0 :: <span class="id" type="var">p</span>)); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">p</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">K2</span> (0 :: <span class="id" type="var">p</span>)); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">IHlt</span> (<span class="id" type="var">tail_set</span> <span class="id" type="var">_</span> <span class="id" type="var">Hlt</span>))  <span class="id" type="keyword">with</span> <span class="id" type="var">ls</span> (<span class="id" type="var">subst_rest</span> (<span class="id" type="var">var_list_list</span> <span class="id" type="var">ls</span>) <span class="id" type="var">sigma</span>)<span class="id" type="keyword">as</span> [<span class="id" type="var">Phi</span> [<span class="id" type="var">K1</span> [<span class="id" type="var">K2</span> [<span class="id" type="var">K3</span> <span class="id" type="var">K4</span>]]]]; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Wlt</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Wls</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">map_eq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">si</span> <span class="id" type="var">si_in_ls</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">subst_eq_vars</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">x_in_si</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">subst_rest_ok</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">in_split</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">si_in_ls</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">ls1</span> [<span class="id" type="var">ls2</span> <span class="id" type="var">H</span>]]; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_list_list_app</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span> <span class="id" type="var">xu_in_rest_sig</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">H1</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span>); <span class="id" type="tactic">apply</span> <span class="id" type="var">subst_rest_subst</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">var_list_list</span> <span class="id" type="var">ls</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span> <span class="id" type="var">xu_in_rest_sig</span> <span class="id" type="var">xv_in_rest_sig</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">H2</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span>); <span class="id" type="tactic">apply</span> <span class="id" type="var">subst_rest_subst</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">var_list_list</span> <span class="id" type="var">ls</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span> <span class="id" type="var">u</span> <span class="id" type="var">xu_in_rest_sig</span> <span class="id" type="var">yu_in_rest_sig</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">H3</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span> <span class="id" type="var">u</span>); <span class="id" type="tactic">apply</span> <span class="id" type="var">subst_rest_subst</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">var_list_list</span> <span class="id" type="var">ls</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">x</span>; <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">x_in_ls</span>; <span class="id" type="tactic">assert</span> (<span class="id" type="var">x_in_sig</span> : <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">sigma</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H4</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">x_in_sig</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">x_in_sig</span> <span class="id" type="keyword">as</span> [[<span class="id" type="var">x'</span> <span class="id" type="var">u</span>] [<span class="id" type="var">x_eq_x'</span> <span class="id" type="var">x_in_sig</span>]]; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">x_eq_x'</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">x'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">x</span>,u); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">subst_rest_subst_rest</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">x_in_rest_sig</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">x_in_rest_sig</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">x_in_rest_sig</span> <span class="id" type="keyword">as</span> [[<span class="id" type="var">x'</span> <span class="id" type="var">u</span>] [<span class="id" type="var">x_eq_x'</span> <span class="id" type="var">x_in_rest_sig</span>]]; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">x_eq_x'</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">x'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">subst_rest_rest</span> <span class="id" type="keyword">with</span> <span class="id" type="var">sigma</span> <span class="id" type="var">u</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_lt</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">Aux2</span> <span class="id" type="var">v</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v_val</span> [<span class="id" type="var">K1</span> [<span class="id" type="var">K2</span> <span class="id" type="var">K3</span>]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">mem_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> <span class="id" type="var">v_val</span>; <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">K1</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">subst_eq_vars</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">z_in_val</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">subst_rest_ok</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">mem_var_list_list</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">v_in_lt</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">ti</span> [<span class="id" type="var">ti_in_lt</span> <span class="id" type="var">v_in_ti</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">var_in_subterm2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">v_in_ti</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">p</span> <span class="id" type="var">Sub</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">in_split</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">ti_in_lt</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">lt1</span> [<span class="id" type="var">lt2</span> <span class="id" type="var">Ht</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Ht</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">map_app</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">split_map_set</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> (<span class="id" type="var">sym_eq</span> <span class="id" type="var">H0</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">ls1</span> [<span class="id" type="var">ls2</span> [<span class="id" type="var">Hs</span> [<span class="id" type="var">Hs1</span> <span class="id" type="var">Hs2</span>]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">ls2</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">si</span> <span class="id" type="var">ls2</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Hs</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_list_list_app</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">left</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">var_in_subterm</span> <span class="id" type="keyword">with</span> <span class="id" type="var">v_val</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">lt</span> <span class="id" type="var">ls</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">K2</span> ((1 + <span class="id" type="var">length</span> <span class="id" type="var">lt1</span>) :: <span class="id" type="var">p</span>)); <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">nth_error_at_pos</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">K2'</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">K2'</span> <span class="id" type="var">Sub</span>); <span class="id" type="tactic">clear</span> <span class="id" type="var">K2'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">replace</span> (<span class="id" type="var">length</span> <span class="id" type="var">lt1</span>) <span class="id" type="keyword">with</span> (<span class="id" type="var">length</span> <span class="id" type="var">ls1</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">nth_error_at_pos</span>; <span class="id" type="tactic">intro</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- (<span class="id" type="var">map_length</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">ls1</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Hs1</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">map_length</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">p</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span>; <span class="id" type="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">K2</span> ((<span class="id" type="var">S</span> <span class="id" type="var">i</span>) :: <span class="id" type="var">p</span>)); <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">u_in_s</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span>, <span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">phi</span> = <span class="id" type="var">Some</span> <span class="id" type="var">u</span> -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">x0</span> : <span class="id" type="var">T1.variable</span>, <span class="id" type="var">In</span> <span class="id" type="var">x0</span> (<span class="id" type="var">T1.var_list</span> <span class="id" type="var">u</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">x0</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span> <span class="id" type="var">x_phi</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">z</span> <span class="id" type="var">z_in_u</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">x_in_t</span> : <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">t</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">k3</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">x</span>,u); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find_mem</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">phi</span> <span class="id" type="var">x_phi</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">x'</span> [<span class="id" type="var">phi1</span> [<span class="id" type="var">phi2</span> [<span class="id" type="var">x_eq_x'</span> <span class="id" type="var">H</span>]]]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">x'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">k2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">var_in_subterm2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> (<span class="id" type="var">in_impl_mem</span> (@<span class="id" type="var">eq</span> <span class="id" type="var">_</span>) (<span class="id" type="keyword">fun</span> <span class="id" type="var">a</span> =&gt; <span class="id" type="var">refl_equal</span> <span class="id" type="var">a</span>) <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">x_in_t</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">p</span> <span class="id" type="var">Sub</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">var_in_subterm</span> <span class="id" type="keyword">with</span> <span class="id" type="var">u</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">subterm_at_pos_apply_subst_apply_subst_subterm_at_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> <span class="id" type="var">phi</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">apply</span> <span class="id" type="tactic">f_equal</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">x_phi</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">v_in_ls</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">v</span>, <span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">Phi</span> = <span class="id" type="var">Some</span> <span class="id" type="var">v</span> -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">x0</span> : <span class="id" type="var">T1.variable</span>, <span class="id" type="var">In</span> <span class="id" type="var">x0</span> (<span class="id" type="var">T1.var_list</span> <span class="id" type="var">v</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">x0</span> (<span class="id" type="var">var_list_list</span> <span class="id" type="var">ls</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">v</span> <span class="id" type="var">x_Phi</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">z</span> <span class="id" type="var">z_in_v</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">x_in_lt</span> : <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list_list</span> <span class="id" type="var">lt</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">K3</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">x</span>,v); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find_mem</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">Phi</span> <span class="id" type="var">x_Phi</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">x'</span> [<span class="id" type="var">Phi1</span> [<span class="id" type="var">Phi2</span> [<span class="id" type="var">x_eq_x'</span> <span class="id" type="var">H</span>]]]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">x'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">K2</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">K2</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">K2</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">K2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">in_var_list_list</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">x_in_lt</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">ti</span> [<span class="id" type="var">ti_in_lt</span> <span class="id" type="var">x_in_ti</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">in_split</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">ti_in_lt</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">lt1</span> [<span class="id" type="var">lt2</span> <span class="id" type="var">H</span>]]; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">map_app</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_list_list_app</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">left</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">var_in_subterm2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> (<span class="id" type="var">in_impl_mem</span> (@<span class="id" type="var">eq</span> <span class="id" type="var">_</span>) (<span class="id" type="keyword">fun</span> <span class="id" type="var">a</span> =&gt; <span class="id" type="var">refl_equal</span> <span class="id" type="var">a</span>) <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">x_in_ti</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">p</span> <span class="id" type="var">Sub</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">var_in_subterm</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">Phi</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>)) <span class="id" type="var">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">subterm_at_pos_apply_subst_apply_subst_subterm_at_pos</span> <span class="id" type="var">ti</span> <span class="id" type="var">p</span> <span class="id" type="var">Phi</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">apply</span> <span class="id" type="tactic">f_equal</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">x_Phi</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">x_Phi</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">ok</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span>, <span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">phi</span> = <span class="id" type="var">Some</span> <span class="id" type="var">u</span> -&gt; <span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">Phi</span> = <span class="id" type="var">Some</span> <span class="id" type="var">v</span> -&gt; <span class="id" type="var">u</span> = <span class="id" type="var">v</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span> <span class="id" type="var">x_phi</span> <span class="id" type="var">x_Phi</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">decompose_subst_aux</span> <span class="id" type="keyword">with</span> <span class="id" type="var">sigma</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">k4</span> <span class="id" type="var">x</span>); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">x_phi</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">K4</span> <span class="id" type="var">x</span>); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">x_Phi</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">z</span> <span class="id" type="var">z_in_u</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H4</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">u_in_s</span> <span class="id" type="keyword">with</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">z</span> <span class="id" type="var">z_in_v</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H4</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">v_in_ls</span> <span class="id" type="keyword">with</span> <span class="id" type="var">x</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">trans_eq</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">tau</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">k1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">subst_comp_is_subst_comp</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">x_phi</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">subst_eq_vars</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">z</span> <span class="id" type="var">z_in_u</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">subst_rest_ok</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">u_in_s</span> <span class="id" type="keyword">with</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">k3</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">x</span>,u); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find_mem</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">phi</span> <span class="id" type="var">x_phi</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">x'</span> [<span class="id" type="var">phi1</span> [<span class="id" type="var">phi2</span> [<span class="id" type="var">x_eq_x'</span> <span class="id" type="var">H</span>]]]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">x'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">K1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">subst_comp_is_subst_comp</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">x_Phi</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">subst_eq_vars</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">z</span> <span class="id" type="var">z_in_v</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">subst_rest_ok</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">v_in_ls</span> <span class="id" type="keyword">with</span> <span class="id" type="var">x</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">K3</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">x</span>,v); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find_mem</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">x_Phi</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">x'</span> [<span class="id" type="var">Phi1</span> [<span class="id" type="var">Phi2</span> [<span class="id" type="var">x_eq_x'</span> <span class="id" type="var">H</span>]]]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">x'</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> (<span class="id" type="var">phi</span> ++ <span class="id" type="var">Phi</span>); <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="var">var_list_list</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_tlt</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">in_app_or</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">v_in_tlt</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v_in_t</span> | <span class="id" type="var">v_in_lt</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">v_in_tlt</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">k1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> <span class="id" type="var">subst_comp_is_subst_comp</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">find_app</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">mem_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v</span> (<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> : <span class="id" type="var">T1.variable</span> * <span class="id" type="var">T1.term</span> =&gt; <span class="id" type="var">fst</span> <span class="id" type="var">st</span>) <span class="id" type="var">phi</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">case</span> (<span class="id" type="var">mem_bool</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> (<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> : <span class="id" type="var">T1.variable</span> * <span class="id" type="var">T1.term</span> =&gt; <span class="id" type="var">fst</span> <span class="id" type="var">st</span>) <span class="id" type="var">phi</span>)); [<span class="id" type="tactic">intro</span> <span class="id" type="var">v_in_phi</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v_not_in_phi</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">phi</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">v_val</span> <span class="id" type="var">v_phi</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v_phi</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">subst_eq_vars</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">z</span> <span class="id" type="var">z_in_v</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">subst_rest_ok</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">u_in_s</span> <span class="id" type="keyword">with</span> <span class="id" type="var">v</span> <span class="id" type="var">v_val</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">v_in_phi'</span> : <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> : <span class="id" type="var">T1.variable</span> * <span class="id" type="var">T1.term</span> =&gt; <span class="id" type="var">fst</span> <span class="id" type="var">st</span>) <span class="id" type="var">phi</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">mem_impl_in</span> <span class="id" type="keyword">with</span> (@<span class="id" type="var">eq</span> <span class="id" type="var">_</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_in_phi'</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">v_in_phi'</span> <span class="id" type="keyword">as</span> [[<span class="id" type="var">v'</span> <span class="id" type="var">v_val</span>] [<span class="id" type="var">v_eq_v'</span> <span class="id" type="var">v_in_phi'</span>]]; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_eq_v'</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">v'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">find_not_found</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">v</span> <span class="id" type="var">v_val</span> <span class="id" type="var">phi</span> <span class="id" type="var">v_phi</span> (<span class="id" type="var">eq_var_bool_refl</span> <span class="id" type="var">v</span>) <span class="id" type="var">v_in_phi'</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">v_not_in_phi</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_impl_mem</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">k3</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">K1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> <span class="id" type="var">subst_comp_is_subst_comp</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">find_app</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">mem_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v</span> (<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> : <span class="id" type="var">T1.variable</span> * <span class="id" type="var">T1.term</span> =&gt; <span class="id" type="var">fst</span> <span class="id" type="var">st</span>) <span class="id" type="var">phi</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">case</span> (<span class="id" type="var">mem_bool</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> (<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> : <span class="id" type="var">T1.variable</span> * <span class="id" type="var">T1.term</span> =&gt; <span class="id" type="var">fst</span> <span class="id" type="var">st</span>) <span class="id" type="var">phi</span>)); [<span class="id" type="tactic">intro</span> <span class="id" type="var">v_in_phi</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v_not_in_phi</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">phi</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">v_val</span> <span class="id" type="var">v_phi</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v_phi</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">Phi</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">v_Val</span> <span class="id" type="var">v_Phi</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v_Phi</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">v_phi</span> <span class="id" type="var">v_Phi</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">subst_eq_vars</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">z</span> <span class="id" type="var">z_in_v</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">subst_rest_ok</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">v_in_ls</span> <span class="id" type="keyword">with</span> <span class="id" type="var">v</span> <span class="id" type="var">v_Val</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">K3</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_in_lt</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_in_lt</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">v_in_lt</span> <span class="id" type="keyword">as</span> [[<span class="id" type="var">v'</span> <span class="id" type="var">v_Val</span>] [<span class="id" type="var">v_eq_v'</span> <span class="id" type="var">v_in_Phi</span>]]; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_eq_v'</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">v'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">find_not_found</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">v</span> <span class="id" type="var">v_Val</span> <span class="id" type="var">Phi</span> <span class="id" type="var">v_Phi</span> (<span class="id" type="var">eq_var_bool_refl</span> <span class="id" type="var">v</span>) <span class="id" type="var">v_in_Phi</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">v_in_phi'</span> : <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> : <span class="id" type="var">T1.variable</span> * <span class="id" type="var">T1.term</span> =&gt; <span class="id" type="var">fst</span> <span class="id" type="var">st</span>) <span class="id" type="var">phi</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">mem_impl_in</span> <span class="id" type="keyword">with</span> (@<span class="id" type="var">eq</span> <span class="id" type="var">_</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_in_phi'</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">v_in_phi'</span> <span class="id" type="keyword">as</span> [[<span class="id" type="var">v'</span> <span class="id" type="var">v_val</span>] [<span class="id" type="var">v_eq_v'</span> <span class="id" type="var">v_in_phi'</span>]]; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_eq_v'</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">v'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">find_not_found</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">v</span> <span class="id" type="var">v_val</span> <span class="id" type="var">phi</span> <span class="id" type="var">v_phi</span> (<span class="id" type="var">eq_var_bool_refl</span> <span class="id" type="var">v</span>) <span class="id" type="var">v_in_phi'</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">Phi</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">v_Val</span> <span class="id" type="var">v_Phi</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v_Phi</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">subst_eq_vars</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">z</span> <span class="id" type="var">z_in_v</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">subst_rest_ok</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">v_in_ls</span> <span class="id" type="keyword">with</span> <span class="id" type="var">v</span> <span class="id" type="var">v_Val</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">K3</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_in_lt</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_in_lt</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">v_in_lt</span> <span class="id" type="keyword">as</span> [[<span class="id" type="var">v'</span> <span class="id" type="var">v_Val</span>] [<span class="id" type="var">v_eq_v'</span> <span class="id" type="var">v_in_Phi</span>]]; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_eq_v'</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">v'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">find_not_found</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">v</span> <span class="id" type="var">v_Val</span> <span class="id" type="var">Phi</span> <span class="id" type="var">v_Phi</span> (<span class="id" type="var">eq_var_bool_refl</span> <span class="id" type="var">v</span>) <span class="id" type="var">v_in_Phi</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="tactic">f_equal</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">f_equal2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">k2</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">subst_eq_vars</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_t</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">find_app</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">mem_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v</span> (<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> : <span class="id" type="var">T1.variable</span> * <span class="id" type="var">T1.term</span> =&gt; <span class="id" type="var">fst</span> <span class="id" type="var">st</span>) <span class="id" type="var">phi</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">case</span> (<span class="id" type="var">mem_bool</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> (<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> : <span class="id" type="var">T1.variable</span> * <span class="id" type="var">T1.term</span> =&gt; <span class="id" type="var">fst</span> <span class="id" type="var">st</span>) <span class="id" type="var">phi</span>)); [<span class="id" type="tactic">intro</span> <span class="id" type="var">v_in_phi</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v_not_in_phi</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">v_not_in_phi</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_impl_mem</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">k3</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">K2</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">K2</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">K2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">K2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">map_eq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">ti</span> <span class="id" type="var">ti_in_lt</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">subst_eq_vars</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_ti</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">find_app</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">mem_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v</span> (<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> : <span class="id" type="var">T1.variable</span> * <span class="id" type="var">T1.term</span> =&gt; <span class="id" type="var">fst</span> <span class="id" type="var">st</span>) <span class="id" type="var">phi</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">case</span> (<span class="id" type="var">mem_bool</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> (<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> : <span class="id" type="var">T1.variable</span> * <span class="id" type="var">T1.term</span> =&gt; <span class="id" type="var">fst</span> <span class="id" type="var">st</span>) <span class="id" type="var">phi</span>)); [<span class="id" type="tactic">intro</span> <span class="id" type="var">v_in_phi</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v_not_in_phi</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">phi</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">v_val</span> <span class="id" type="var">v_phi</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v_phi</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">Phi</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">v_Val</span> <span class="id" type="var">v_Phi</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v_Phi</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">v_phi</span> <span class="id" type="var">v_Phi</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">v_in_lt</span> : <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">var_list_list</span> <span class="id" type="var">lt</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">in_split</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">ti_in_lt</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">lt1</span> [<span class="id" type="var">lt2</span> <span class="id" type="var">H</span>]]; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_list_list_app</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">K3</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_in_lt</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_in_lt</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">v_in_lt</span> <span class="id" type="keyword">as</span> [[<span class="id" type="var">v'</span> <span class="id" type="var">v_Val</span>] [<span class="id" type="var">v_eq_v'</span> <span class="id" type="var">v_in_Phi</span>]]; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_eq_v'</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">v'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">find_not_found</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">v</span> <span class="id" type="var">v_Val</span> <span class="id" type="var">Phi</span> <span class="id" type="var">v_Phi</span> (<span class="id" type="var">eq_var_bool_refl</span> <span class="id" type="var">v</span>) <span class="id" type="var">v_in_Phi</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">v_in_phi'</span> : <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> : <span class="id" type="var">T1.variable</span> * <span class="id" type="var">T1.term</span> =&gt; <span class="id" type="var">fst</span> <span class="id" type="var">st</span>) <span class="id" type="var">phi</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">mem_impl_in</span> <span class="id" type="keyword">with</span> (@<span class="id" type="var">eq</span> <span class="id" type="var">_</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_in_phi'</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">v_in_phi'</span> <span class="id" type="keyword">as</span> [[<span class="id" type="var">v'</span> <span class="id" type="var">v_val</span>] [<span class="id" type="var">v_eq_v'</span> <span class="id" type="var">v_in_phi'</span>]]; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_eq_v'</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">v'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">find_not_found</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">v</span> <span class="id" type="var">v_val</span> <span class="id" type="var">phi</span> <span class="id" type="var">v_phi</span> (<span class="id" type="var">eq_var_bool_refl</span> <span class="id" type="var">v</span>) <span class="id" type="var">v_in_phi'</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">map_app</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">in_app_or</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v_in_phi</span> | <span class="id" type="var">v_in_Phi</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">k3</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">K3</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">in_app_or</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v_in_phi</span> | <span class="id" type="var">v_in_Phi</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">k3</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">K3</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">find_app</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">case</span> (<span class="id" type="var">mem_bool</span> <span class="id" type="var">T1.eq_var_bool</span> <span class="id" type="var">v</span> (<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> : <span class="id" type="var">T1.variable</span> * <span class="id" type="var">T1.term</span> =&gt; <span class="id" type="var">fst</span> <span class="id" type="var">st</span>) <span class="id" type="var">phi</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">k4</span> <span class="id" type="var">v</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">K4</span> <span class="id" type="var">v</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">rewrite_decomposed_term</span> : <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span> <span class="id" type="var">sigma</span>,  <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">t</span> = <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">s</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">well_formed</span> <span class="id" type="var">s</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span>, <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,u) <span class="id" type="var">sigma</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">u</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">True</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> =&gt; (<span class="id" type="keyword">match</span> <span class="id" type="var">F.arity</span> <span class="id" type="var">f</span> <span class="id" type="keyword">with</span> <span class="id" type="var">Free</span> <span class="id" type="var">n</span> =&gt; <span class="id" type="var">n</span> | <span class="id" type="var">_</span> =&gt; 2 <span class="id" type="keyword">end</span>) &lt;&gt; <span class="id" type="var">length</span> <span class="id" type="var">l</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span>, <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,u) <span class="id" type="var">sigma</span> -&gt; <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,v) <span class="id" type="var">sigma</span> -&gt; <span class="id" type="var">u</span> = <span class="id" type="var">v</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span> <span class="id" type="var">u</span>, <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,u) <span class="id" type="var">sigma</span> -&gt; <span class="id" type="var">In</span> (<span class="id" type="var">y</span>,u) <span class="id" type="var">sigma</span> -&gt; <span class="id" type="var">x</span> = <span class="id" type="var">y</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span>, <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">sigma</span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">u</span>, <span class="id" type="var">one_step</span> <span class="id" type="var">R</span> <span class="id" type="var">u</span> <span class="id" type="var">t</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id" type="var">exists</span> <span class="id" type="var">s'</span>, <span class="id" type="var">one_step</span> <span class="id" type="var">R</span> <span class="id" type="var">s'</span> <span class="id" type="var">s</span> /\ <span class="id" type="var">u</span> = <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">s'</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\/<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">exists</span> <span class="id" type="var">p</span>, <span class="id" type="var">exists</span> <span class="id" type="var">x</span>, <span class="id" type="var">exists</span> <span class="id" type="var">u'</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">s</span> <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">one_step</span> <span class="id" type="var">R</span> <span class="id" type="var">u'</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>)) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">u</span> = <span class="id" type="var">replace_at_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">u'</span> <span class="id" type="var">p</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">s</span> <span class="id" type="var">sigma</span> <span class="id" type="var">h0</span> <span class="id" type="var">Ws</span> <span class="id" type="var">h1</span> <span class="id" type="var">h2</span> <span class="id" type="var">h3</span> <span class="id" type="var">h4</span> <span class="id" type="var">u</span> <span class="id" type="var">H'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1'</span> <span class="id" type="var">t2'</span> <span class="id" type="var">H1</span> | ]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H1</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">r</span> <span class="id" type="var">l</span> <span class="id" type="var">phi</span> <span class="id" type="var">H2</span> <span class="id" type="var">H3</span> <span class="id" type="var">H4</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x</span> | ]; [<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">R_var</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H2</span>) | <span class="id" type="tactic">discriminate</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">lt</span> <span class="id" type="var">Hlt</span> <span class="id" type="var">s</span> <span class="id" type="var">sigma</span> <span class="id" type="var">h0</span> <span class="id" type="var">Ws</span> <span class="id" type="var">h1</span> <span class="id" type="var">h2</span> <span class="id" type="var">h3</span> <span class="id" type="var">h4</span> <span class="id" type="var">u</span> <span class="id" type="var">H'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1'</span> <span class="id" type="var">t2'</span> <span class="id" type="var">H1</span> | <span class="id" type="var">f'</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2'</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H1</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">r</span> <span class="id" type="var">l</span> <span class="id" type="var">phi</span> <span class="id" type="var">H2</span> <span class="id" type="var">H3</span> <span class="id" type="var">H4</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">decompose_subst</span> <span class="id" type="var">s</span> (<span class="id" type="var">subst_rest</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>) <span class="id" type="var">sigma</span>) <span class="id" type="var">l</span> <span class="id" type="var">phi</span> <span class="id" type="var">Ws</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">phi'</span> [<span class="id" type="var">K1</span> [<span class="id" type="var">K2</span> [<span class="id" type="var">K3</span> <span class="id" type="var">K4</span>]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span> <span class="id" type="var">xu_in_rest_sig</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">h1</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span>); <span class="id" type="tactic">apply</span> <span class="id" type="var">subst_rest_subst</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span> <span class="id" type="var">xu_in_rest_sig</span> <span class="id" type="var">xv_in_rest_sig</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">h2</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span>); <span class="id" type="tactic">apply</span> <span class="id" type="var">subst_rest_subst</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span> <span class="id" type="var">u</span> <span class="id" type="var">xu_in_rest_sig</span> <span class="id" type="var">yu_in_rest_sig</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">h3</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span> <span class="id" type="var">u</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">subst_rest_subst</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">subst_rest_subst</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">x</span>; <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">x_in_s</span>; <span class="id" type="tactic">assert</span> (<span class="id" type="var">x_in_sig</span> : <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">sigma</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">h4</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">x_in_sig</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">x_in_sig</span> <span class="id" type="keyword">as</span> [[<span class="id" type="var">x'</span> <span class="id" type="var">u</span>] [<span class="id" type="var">x_eq_x'</span> <span class="id" type="var">x_in_sig</span>]]; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">x_eq_x'</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">x'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">x</span>,u); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">subst_rest_subst_rest</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">x_in_rest_sig</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">x_in_rest_sig</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">x_in_rest_sig</span> <span class="id" type="keyword">as</span> [[<span class="id" type="var">x'</span> <span class="id" type="var">u</span>] [<span class="id" type="var">x_eq_x'</span> <span class="id" type="var">x_in_rest_sig</span>]]; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">x_eq_x'</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">x'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">subst_rest_rest</span> <span class="id" type="keyword">with</span> <span class="id" type="var">sigma</span> <span class="id" type="var">u</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">proj2</span> (<span class="id" type="var">WR</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H2</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H4</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">h0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">subst_eq_vars</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_s</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">subst_rest_ok</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">left</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">phi'</span> <span class="id" type="var">r</span>); <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">K2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">at_top</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">instance</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">subst_comp_is_subst_comp</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">subst_eq_vars</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_r</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">v_in_l</span> : <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">l</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">R_reg</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H2</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">sym_eq</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">K1</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> <span class="id" type="var">subst_comp_is_subst_comp</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">subst_eq_vars</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">z</span> <span class="id" type="var">z_in_v_phi'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">subst_rest_ok</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">K2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">var_in_subterm2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> (<span class="id" type="var">in_impl_mem</span> (@<span class="id" type="var">eq</span> <span class="id" type="var">_</span>) (<span class="id" type="keyword">fun</span> <span class="id" type="var">a</span> =&gt; <span class="id" type="var">refl_equal</span> <span class="id" type="var">a</span>) <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">v_in_l</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">p</span> <span class="id" type="var">Sub</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">var_in_subterm</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">phi'</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>)) <span class="id" type="var">p</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">subterm_at_pos_apply_subst_apply_subst_subterm_at_pos</span> <span class="id" type="var">l</span> <span class="id" type="var">p</span> <span class="id" type="var">phi'</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">s</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x</span> | <span class="id" type="var">g</span> <span class="id" type="var">ls</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">right</span>; <span class="id" type="var">exists</span> <span class="id" type="var">nil</span>; <span class="id" type="var">exists</span> <span class="id" type="var">x</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">h0</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_context</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">one_step_in_list</span> <span class="id" type="var">H0</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">ti</span> [<span class="id" type="var">ui</span> [<span class="id" type="var">lt1</span> [<span class="id" type="var">lt2</span> [<span class="id" type="var">K</span> [<span class="id" type="var">K1</span> <span class="id" type="var">K2</span>]]]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">h0</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">h0</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">h0</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">h0</span>; <span class="id" type="tactic">intro</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">g</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">K1</span> <span class="id" type="keyword">in</span> <span class="id" type="var">h0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">split_map_set</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> (<span class="id" type="var">sym_eq</span> <span class="id" type="var">h0</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">ls1</span> [<span class="id" type="var">ls2</span> [<span class="id" type="var">J1</span> [<span class="id" type="var">J2</span> <span class="id" type="var">J3</span>]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">ls2</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">si</span> <span class="id" type="var">ls2</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">J3</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">J3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">J3</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">J3</span> <span class="id" type="var">j3</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">Hlt</span> <span class="id" type="keyword">with</span> <span class="id" type="var">ti</span> <span class="id" type="var">si</span> <span class="id" type="var">sigma</span> <span class="id" type="var">ui</span> <span class="id" type="keyword">as</span> [[<span class="id" type="var">si'</span> [<span class="id" type="var">L1</span> <span class="id" type="var">L2</span>]] | [<span class="id" type="var">p</span> [<span class="id" type="var">x</span> [<span class="id" type="var">ui'</span> [<span class="id" type="var">Sub</span> [<span class="id" type="var">L1</span> <span class="id" type="var">L2</span>]]]]]]; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">K1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">sym_eq</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">proj1</span> (<span class="id" type="var">well_formed_unfold</span> <span class="id" type="var">Ws</span>)); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">J1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">x_in_si</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">h4</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">J1</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_list_list_app</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">left</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">ls1</span> ++ <span class="id" type="var">si'</span> :: <span class="id" type="var">ls2</span>)); <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">in_context</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">J1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">revert</span> <span class="id" type="var">L1</span>; <span class="id" type="tactic">clear</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">ls1</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">s1</span> <span class="id" type="var">ls1</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">head_step</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">tail_step</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHls1</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="tactic">f_equal</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">map_app</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">K2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">sym_eq</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">f_equal2</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">f_equal2</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">sym_eq</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">right</span>; <span class="id" type="var">exists</span> ((<span class="id" type="var">length</span> <span class="id" type="var">ls1</span>) :: <span class="id" type="var">p</span>); <span class="id" type="var">exists</span> <span class="id" type="var">x</span>; <span class="id" type="var">exists</span> <span class="id" type="var">ui'</span>; <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">J1</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">nth_error_at_pos</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">K1</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">K2</span>; <span class="id" type="tactic">replace</span> (<span class="id" type="var">length</span> <span class="id" type="var">ls1</span>) <span class="id" type="keyword">with</span> (<span class="id" type="var">length</span> <span class="id" type="var">lt1</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="tactic">f_equal</span>; <span class="id" type="var">revert</span> <span class="id" type="var">L2</span>; <span class="id" type="tactic">clear</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">lt1</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t1</span> <span class="id" type="var">lt1</span>]; <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">u</span> =&gt; <span class="id" type="var">u</span> :: <span class="id" type="var">lt2</span>)); <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span>; <span class="id" type="tactic">apply</span> <span class="id" type="tactic">f_equal</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHlt1</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">J2</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">length_map</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">R_reg_one_step</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span>, (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">x</span>, <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">t</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">s</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H0</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span> |]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H0</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">r</span> <span class="id" type="var">l</span> <span class="id" type="var">sigma</span> <span class="id" type="var">H</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x</span> | ]; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">discriminate</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">R_var</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">IHl</span> <span class="id" type="var">s</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H0</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span> | <span class="id" type="var">g</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">H0</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H0</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">r</span> <span class="id" type="var">l'</span> <span class="id" type="var">sigma</span> <span class="id" type="var">H</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">x_in_left</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">var_in_subterm2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> (<span class="id" type="var">in_impl_mem</span> (@<span class="id" type="var">eq</span> <span class="id" type="var">_</span>) (<span class="id" type="keyword">fun</span> <span class="id" type="var">a</span> =&gt; <span class="id" type="var">refl_equal</span> <span class="id" type="var">a</span>) <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">x_in_left</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">p</span> <span class="id" type="var">Sub</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">subterm_in_instantiated_term</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">Sub</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">case_eq</span> (<span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">r</span> <span class="id" type="var">p</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">u'</span> <span class="id" type="var">Sub'</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">Sub'</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">u'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x'</span> | ]; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">intro</span>; <span class="id" type="tactic">discriminate</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">assert</span> (<span class="id" type="var">x'_in_r</span> : <span class="id" type="var">In</span> <span class="id" type="var">x'</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">r</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">var_in_subterm</span> <span class="id" type="var">x'</span> <span class="id" type="var">r</span> <span class="id" type="var">p</span> <span class="id" type="var">Sub'</span>); <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">x'_in_l</span> : <span class="id" type="var">In</span> <span class="id" type="var">x'</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">l'</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">R_reg</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H</span>); <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">var_in_subterm2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> (<span class="id" type="var">in_impl_mem</span> (@<span class="id" type="var">eq</span> <span class="id" type="var">_</span>) (<span class="id" type="keyword">fun</span> <span class="id" type="var">a</span> =&gt; <span class="id" type="var">refl_equal</span> <span class="id" type="var">a</span>) <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">x'_in_l</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">q</span> <span class="id" type="var">Sub''</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">var_in_subterm</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x'</span>)) <span class="id" type="var">q</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">subterm_at_pos_apply_subst_apply_subst_subterm_at_pos</span> <span class="id" type="var">l'</span> <span class="id" type="var">q</span> <span class="id" type="var">sigma</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Sub''</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">K</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> [<span class="id" type="var">x'</span> [<span class="id" type="var">p'</span> [<span class="id" type="var">p''</span> [<span class="id" type="var">K</span> [<span class="id" type="var">x'_in_r</span> [<span class="id" type="var">Sub1</span> <span class="id" type="var">Sub2</span>]]]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">x'_in_l</span> : <span class="id" type="var">In</span> <span class="id" type="var">x'</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">l'</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">R_reg</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H</span>); <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">var_in_subterm2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> (<span class="id" type="var">in_impl_mem</span> (@<span class="id" type="var">eq</span> <span class="id" type="var">_</span>) (<span class="id" type="keyword">fun</span> <span class="id" type="var">a</span> =&gt; <span class="id" type="var">refl_equal</span> <span class="id" type="var">a</span>) <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">x'_in_l</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">q</span> <span class="id" type="var">Sub''</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">var_in_subterm</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x'</span>)) <span class="id" type="var">q</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">subterm_at_pos_apply_subst_apply_subst_subterm_at_pos</span> <span class="id" type="var">l'</span> <span class="id" type="var">q</span> <span class="id" type="var">sigma</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Sub''</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">var_in_subterm</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>) <span class="id" type="var">p''</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">one_step_in_list</span> <span class="id" type="var">H3</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">t</span> [<span class="id" type="var">s</span> [<span class="id" type="var">k</span> [<span class="id" type="var">k'</span> [<span class="id" type="var">K</span> [<span class="id" type="var">K1</span> <span class="id" type="var">K2</span>]]]]]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">l</span> <span class="id" type="var">l1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">x</span>; <span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_list_unfold</span>; <span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_list_list_app</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">x_in_ksk'</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">in_app_or</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">x_in_ksk'</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">x_in_k</span> | <span class="id" type="var">x_in_sk'</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">x_in_sk'</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">in_app_or</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">x_in_sk'</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">x_in_s</span> | <span class="id" type="var">in_in_k'</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">left</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span> <span class="id" type="keyword">with</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <span class="id" type="var">collapse_subst</span> <span class="id" type="var">s</span> := <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">apply_subst</span> (<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">v</span> : <span class="id" type="var">variable</span> =&gt; (<span class="id" type="var">v</span>, <span class="id" type="var">Var</span> (<span class="id" type="var">inject</span> 0))) (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>)) <span class="id" type="var">s</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Inductive</span> <span class="id" type="var">Rwf</span> : <span class="id" type="var">relation</span> <span class="id" type="var">term</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Ren</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">s'</span>, <span class="id" type="var">one_step</span> <span class="id" type="var">R</span> (<span class="id" type="var">collapse_subst</span> <span class="id" type="var">s'</span>) (<span class="id" type="var">collapse_subst</span> <span class="id" type="var">s</span>) -&gt; <span class="id" type="var">Rwf</span> <span class="id" type="var">s'</span> <span class="id" type="var">s</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">find_col</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">vars</span> <span class="id" type="var">v</span>, <span class="id" type="var">In</span> <span class="id" type="var">v</span> <span class="id" type="var">vars</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">v0</span> : <span class="id" type="var">T1.variable</span> =&gt; (<span class="id" type="var">v0</span>, <span class="id" type="var">T1.Var</span> (<span class="id" type="var">inject</span> 0))) <span class="id" type="var">vars</span>) = <span class="id" type="var">Some</span> (<span class="id" type="var">Var</span> (<span class="id" type="var">inject</span> 0)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">vars</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_vars</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> (<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">v0</span> =&gt; (<span class="id" type="var">v0</span>, <span class="id" type="var">T1.Var</span> (<span class="id" type="var">inject</span> 0))) <span class="id" type="var">vars</span>)); [<span class="id" type="tactic">intros</span> <span class="id" type="var">v_val</span> <span class="id" type="var">v_col</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v_col</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find_mem</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">v_col</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v'</span> [<span class="id" type="var">col1</span> [<span class="id" type="var">col2</span> [<span class="id" type="var">v_eq_v'</span> <span class="id" type="var">H</span>]]]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">v'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">v_in_col</span> : <span class="id" type="var">In</span> (<span class="id" type="var">v</span>,v_val) (<span class="id" type="var">col1</span> ++ (<span class="id" type="var">v</span>,v_val) :: <span class="id" type="var">col2</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_in_col</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_in_col</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">v_in_col</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v'</span> [<span class="id" type="var">v_eq_v'</span> <span class="id" type="var">v_in_col</span>]]; <span class="id" type="tactic">injection</span> <span class="id" type="var">v_eq_v'</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">find_not_found</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">v</span> (<span class="id" type="var">Var</span> (<span class="id" type="var">inject</span> 0)) <span class="id" type="var">_</span> <span class="id" type="var">v_col</span> (<span class="id" type="var">eq_var_bool_refl</span> <span class="id" type="var">v</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">Acc_Rwf</span> : <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span>, <span class="id" type="var">well_formed</span> <span class="id" type="var">s</span> -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">s</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span>, <span class="id" type="var">well_formed</span> <span class="id" type="var">s</span> -&gt; <span class="id" type="var">Acc</span> <span class="id" type="var">Rwf</span> <span class="id" type="var">s</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">W</span> <span class="id" type="var">s</span> <span class="id" type="var">Ws</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_incl</span> <span class="id" type="keyword">with</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">x0</span> <span class="id" type="var">y</span> : <span class="id" type="var">T1.term</span> =&gt; <span class="id" type="var">one_step</span> <span class="id" type="var">R</span> (<span class="id" type="var">collapse_subst</span> <span class="id" type="var">x0</span>) (<span class="id" type="var">collapse_subst</span> <span class="id" type="var">y</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">Wellfounded.Inverse_Image.Acc_inverse_image</span> <span class="id" type="var">term</span> <span class="id" type="var">term</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">collapse_subst</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">W</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">collapse_subst</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_apply_subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">well_formed_subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span>; <span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> (<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">v0</span> =&gt; (<span class="id" type="var">v0</span>, <span class="id" type="var">T1.Var</span> (<span class="id" type="var">inject</span> 0))) (<span class="id" type="var">T1.var_list</span> <span class="id" type="var">s</span>))); [<span class="id" type="tactic">intros</span> <span class="id" type="var">v_val</span> <span class="id" type="var">v_col</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v_col</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find_mem</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">v_col</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v'</span> [<span class="id" type="var">col1</span> [<span class="id" type="var">col2</span> [<span class="id" type="var">v_eq_v'</span> <span class="id" type="var">H</span>]]]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">v'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">v_in_col</span> : <span class="id" type="var">In</span> (<span class="id" type="var">v</span>,v_val) (<span class="id" type="var">col1</span> ++ (<span class="id" type="var">v</span>,v_val) :: <span class="id" type="var">col2</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_in_col</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_in_col</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">v_in_col</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v'</span> [<span class="id" type="var">v_eq_v'</span> <span class="id" type="var">v_in_col</span>]]; <span class="id" type="tactic">injection</span> <span class="id" type="var">v_eq_v'</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">one_step_Rwf</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">one_step</span> <span class="id" type="var">R</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span> -&gt; <span class="id" type="var">Rwf</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Ren</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">collapse_subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">replace</span> (<span class="id" type="var">T1.apply_subst</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">v</span> : <span class="id" type="var">T1.variable</span> =&gt; (<span class="id" type="var">v</span>, <span class="id" type="var">T1.Var</span> (<span class="id" type="var">inject</span> 0))) (<span class="id" type="var">T1.var_list</span> <span class="id" type="var">t</span>)) <span class="id" type="var">t</span>) <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">T1.apply_subst</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">v</span> : <span class="id" type="var">T1.variable</span> =&gt; (<span class="id" type="var">v</span>, <span class="id" type="var">T1.Var</span> (<span class="id" type="var">inject</span> 0))) (<span class="id" type="var">T1.var_list</span> <span class="id" type="var">s</span>)) <span class="id" type="var">t</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">one_step_apply_subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">subst_eq_vars</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_t</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">v_in_s</span> : <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">R_reg_one_step</span> <span class="id" type="keyword">with</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">find_col</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">find_col</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">acc_decomposed_term</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span>, <span class="id" type="var">well_formed</span> <span class="id" type="var">s</span> -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">s</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span>,   <span class="id" type="var">well_formed</span> <span class="id" type="var">s</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">l</span>, <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step_list</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>)) <span class="id" type="var">l</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">sigma</span>, <span class="id" type="var">l</span> = <span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">x</span> =&gt; <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>)) (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span>, <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,u) <span class="id" type="var">sigma</span> -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">u</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span>, <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,u) <span class="id" type="var">sigma</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">u</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">True</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> =&gt; (<span class="id" type="keyword">match</span> <span class="id" type="var">F.arity</span> <span class="id" type="var">f</span> <span class="id" type="keyword">with</span> <span class="id" type="var">Free</span> <span class="id" type="var">n</span> =&gt; <span class="id" type="var">n</span> | <span class="id" type="var">_</span> =&gt; 2 <span class="id" type="keyword">end</span>) &lt;&gt; <span class="id" type="var">length</span> <span class="id" type="var">l</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span>, <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,u) <span class="id" type="var">sigma</span> -&gt; <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,v) <span class="id" type="var">sigma</span> -&gt; <span class="id" type="var">u</span> = <span class="id" type="var">v</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span> <span class="id" type="var">u</span>, <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,u) <span class="id" type="var">sigma</span> -&gt; <span class="id" type="var">In</span> (<span class="id" type="var">y</span>,u) <span class="id" type="var">sigma</span> -&gt; <span class="id" type="var">x</span> = <span class="id" type="var">y</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span>, <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">sigma</span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">s</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">WfwfR</span> <span class="id" type="var">s</span> <span class="id" type="var">Ws</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">Acc_s</span> :=  <span class="id" type="var">Acc_Rwf</span> <span class="id" type="var">WfwfR</span> <span class="id" type="var">s</span> <span class="id" type="var">Ws</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">Acc_s</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">s</span> <span class="id" type="var">Acc_s</span> <span class="id" type="var">IHs</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">clear</span> <span class="id" type="var">Acc_s</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">l</span> <span class="id" type="var">Acc_l</span>; <span class="id" type="var">revert</span> <span class="id" type="var">s</span> <span class="id" type="var">Ws</span> <span class="id" type="var">IHs</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">Acc_l</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">l</span> <span class="id" type="var">Acc_l'</span> <span class="id" type="var">IHl</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">Acc_l</span> : <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step_list</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>)) <span class="id" type="var">l</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_l'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">clear</span> <span class="id" type="var">Acc_l'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">Ws</span> <span class="id" type="var">IHs</span> <span class="id" type="var">sigma</span> <span class="id" type="var">H0</span> <span class="id" type="var">Acc_sigma</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">H3</span> <span class="id" type="var">H4</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">rewrite_decomposed_term</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">s</span>) <span class="id" type="var">s</span> <span class="id" type="var">sigma</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>) <span class="id" type="var">Ws</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">H3</span> <span class="id" type="var">H4</span> <span class="id" type="var">u</span> <span class="id" type="var">H</span>) <span class="id" type="keyword">as</span> [[<span class="id" type="var">t</span> [<span class="id" type="var">J1</span> <span class="id" type="var">J2</span>]] | <span class="id" type="var">J2</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">J2</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">IHs</span> <span class="id" type="var">t</span>) <span class="id" type="keyword">with</span> (<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">x</span> =&gt; <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>)) (<span class="id" type="var">var_list</span> <span class="id" type="var">t</span>)); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">one_step_Rwf</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_rwr</span> <span class="id" type="keyword">with</span> <span class="id" type="var">R</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">t_step</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">acc_one_step_list</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_sig</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_in_sig</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">v_in_sig</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x</span> [<span class="id" type="var">v_in_sig</span> <span class="id" type="var">x_in_t</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">acc_one_step_list</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Acc_l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_l</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> <span class="id" type="var">x</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">R_reg_one_step</span> <span class="id" type="keyword">with</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">x_in_t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H4</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">R_reg_one_step</span> <span class="id" type="keyword">with</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">J2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">p</span> [<span class="id" type="var">x</span> [<span class="id" type="var">u'</span> [<span class="id" type="var">Sub</span> [<span class="id" type="var">H</span> <span class="id" type="var">H'</span>]]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">H5</span> : <span class="id" type="var">exists</span> <span class="id" type="var">y</span>, <span class="id" type="var">exists</span> <span class="id" type="var">s'</span>, <span class="id" type="var">exists</span> <span class="id" type="var">sigma'</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">s'</span> = <span class="id" type="var">replace_at_pos</span> <span class="id" type="var">s</span> (<span class="id" type="var">Var</span> <span class="id" type="var">y</span>) <span class="id" type="var">p</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">sigma'</span> = <span class="id" type="var">sigma</span> \/ (~In <span class="id" type="var">y</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>)) /\ <span class="id" type="var">sigma'</span> = (<span class="id" type="var">y</span>,u') :: <span class="id" type="var">sigma</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">well_formed</span> <span class="id" type="var">s'</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">u</span> = <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma'</span> <span class="id" type="var">s'</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Acc</span> (<span class="id" type="var">one_step_list</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>)) (<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">x</span>  =&gt; <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma'</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>)) (<span class="id" type="var">var_list</span> <span class="id" type="var">s'</span>)) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> (<span class="id" type="var">x</span> : <span class="id" type="var">T1.variable</span>) (<span class="id" type="var">u</span> : <span class="id" type="var">T1.term</span>), <span class="id" type="var">In</span> (<span class="id" type="var">x</span>, <span class="id" type="var">u</span>) <span class="id" type="var">sigma'</span> -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">u</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> (<span class="id" type="var">x</span> : <span class="id" type="var">T1.variable</span>) (<span class="id" type="var">u</span> : <span class="id" type="var">T1.term</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">In</span> (<span class="id" type="var">x</span>, <span class="id" type="var">u</span>) <span class="id" type="var">sigma'</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">u</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">T1.Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">True</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">T1.Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">T1.F.arity</span> <span class="id" type="var">f</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">AC</span> =&gt; 2<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">C</span> =&gt; 2<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Free</span> <span class="id" type="var">n</span> =&gt; <span class="id" type="var">n</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span> &lt;&gt; <span class="id" type="var">length</span> <span class="id" type="var">l</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> (<span class="id" type="var">x</span> : <span class="id" type="var">T1.variable</span>) (<span class="id" type="var">u</span> <span class="id" type="var">v</span> : <span class="id" type="var">T1.term</span>), <span class="id" type="var">In</span> (<span class="id" type="var">x</span>, <span class="id" type="var">u</span>) <span class="id" type="var">sigma'</span> -&gt; <span class="id" type="var">In</span> (<span class="id" type="var">x</span>, <span class="id" type="var">v</span>) <span class="id" type="var">sigma'</span> -&gt; <span class="id" type="var">u</span> = <span class="id" type="var">v</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> (<span class="id" type="var">x</span> <span class="id" type="var">y</span> : <span class="id" type="var">T1.variable</span>) (<span class="id" type="var">u</span> : <span class="id" type="var">T1.term</span>), <span class="id" type="var">In</span> (<span class="id" type="var">x</span>, <span class="id" type="var">u</span>) <span class="id" type="var">sigma'</span> -&gt; <span class="id" type="var">In</span> (<span class="id" type="var">y</span>, <span class="id" type="var">u</span>) <span class="id" type="var">sigma'</span> -&gt; <span class="id" type="var">x</span> = <span class="id" type="var">y</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> : <span class="id" type="var">T1.variable</span>, <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">T1.var_list</span> <span class="id" type="var">s'</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">sigma'</span>)) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">In</span> (<span class="id" type="var">y</span>,u') <span class="id" type="var">sigma'</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">mem_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">T.eq_bool_ok</span> <span class="id" type="var">u'</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">snd</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">sigma</span>)); <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">case</span> (<span class="id" type="var">mem_bool</span> <span class="id" type="var">T.eq_bool</span> <span class="id" type="var">u'</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">snd</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">sigma</span>)); [<span class="id" type="tactic">intro</span> <span class="id" type="var">u'_in_sigma</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">u'_not_in_sigma</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">u'_in_sigma'</span> : <span class="id" type="var">In</span> <span class="id" type="var">u'</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">snd</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">sigma</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">mem_impl_in</span> <span class="id" type="keyword">with</span> (@<span class="id" type="var">eq</span> <span class="id" type="var">_</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">u'_in_sigma'</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">u'_in_sigma'</span> <span class="id" type="keyword">as</span> [[<span class="id" type="var">y</span> <span class="id" type="var">u''</span>] [<span class="id" type="var">u'_eq_u''</span> <span class="id" type="var">u'_in_sigma'</span>]]; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">u'_eq_u''</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">u''</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> <span class="id" type="var">y</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">replace_at_pos</span> <span class="id" type="var">s</span> (<span class="id" type="var">Var</span> <span class="id" type="var">y</span>) <span class="id" type="var">p</span>); <span class="id" type="var">exists</span> <span class="id" type="var">sigma</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_replace_at_pos</span>; <span class="id" type="tactic">simpl</span>; [<span class="id" type="tactic">trivial</span> | <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">subst_replace_at_pos</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">u</span> =&gt; <span class="id" type="var">replace_at_pos</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">s</span>) <span class="id" type="var">u</span> <span class="id" type="var">p</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">y</span> <span class="id" type="var">sigma</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">y_val</span> <span class="id" type="var">y_sigma</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">y_sigma</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">H2</span> <span class="id" type="keyword">with</span> <span class="id" type="var">y</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find_mem</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">y_sigma</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">y'</span> [<span class="id" type="var">sig1</span> [<span class="id" type="var">sig2</span> [<span class="id" type="var">y_eq_y'</span> <span class="id" type="var">K</span>]]]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">y'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">find_not_found</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">y</span> <span class="id" type="var">y</span> <span class="id" type="var">u'</span> <span class="id" type="var">sigma</span> <span class="id" type="var">y_sigma</span> (<span class="id" type="var">eq_var_bool_refl</span> <span class="id" type="var">y</span>) <span class="id" type="var">u'_in_sigma'</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">is_a_pos_exists_subterm</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>); <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">acc_one_step_list</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_sig</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_in_sig</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">v_in_sig</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">z</span> [<span class="id" type="var">v_in_sig</span> <span class="id" type="var">z_in_t</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">acc_one_step_list</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Acc_l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">z</span> <span class="id" type="var">y</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">z</span> <span class="id" type="var">y</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">z_eq_y</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">z_diff_y</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">z</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">v_in_sig</span>; <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">y</span> <span class="id" type="var">sigma</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">y_val</span> <span class="id" type="var">y_sigma</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">y_sigma</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">replace</span> <span class="id" type="var">y_val</span> <span class="id" type="keyword">with</span> <span class="id" type="var">u'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_sigma</span> <span class="id" type="keyword">with</span> <span class="id" type="var">y</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">H2</span> <span class="id" type="var">y</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find_mem</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">y_sigma</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">y'</span> [<span class="id" type="var">sig1</span> [<span class="id" type="var">sig2</span> [<span class="id" type="var">y'_eq_y</span> <span class="id" type="var">K</span>]]]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">y'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">find_not_found</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">y</span> <span class="id" type="var">y</span> <span class="id" type="var">u'</span> <span class="id" type="var">sigma</span> <span class="id" type="var">y_sigma</span> (<span class="id" type="var">eq_var_bool_refl</span> <span class="id" type="var">y</span>) <span class="id" type="var">u'_in_sigma'</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">var_in_replace_at_pos</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">z_in_t</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">z_in_s</span> | <span class="id" type="var">z_in_y</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_sigma</span> <span class="id" type="keyword">with</span> <span class="id" type="var">z</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">v_in_sig</span>; <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">z</span> <span class="id" type="var">sigma</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">z_val</span> <span class="id" type="var">z_sigma</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">z_sigma</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find_mem</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">z_sigma</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">z'</span> [<span class="id" type="var">sig1</span> [<span class="id" type="var">sig2</span> [<span class="id" type="var">z_eq_z'</span> <span class="id" type="var">K</span>]]]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">z</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">z_in_sig</span> := <span class="id" type="var">H4</span> <span class="id" type="var">_</span> <span class="id" type="var">z_in_s</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">z_in_sig</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">z_in_sig</span> <span class="id" type="keyword">as</span> [[<span class="id" type="var">z'</span> <span class="id" type="var">z_val</span>] [<span class="id" type="var">z_eq_z'</span> <span class="id" type="var">z_in_sig</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">z_eq_z'</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">z'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">find_not_found</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">z</span> <span class="id" type="var">z</span> <span class="id" type="var">z_val</span> <span class="id" type="var">sigma</span> <span class="id" type="var">z_sigma</span> (<span class="id" type="var">eq_var_bool_refl</span> <span class="id" type="var">z</span>) <span class="id" type="var">z_in_sig</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">z_in_y</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">z_eq_y</span> | <span class="id" type="var">z_in_nil</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">absurd</span> (<span class="id" type="var">z</span>=y); <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">sym_eq</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">z</span> <span class="id" type="var">z_in_t</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">var_in_replace_at_pos</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">z_in_t</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">z_in_s</span> | <span class="id" type="var">z_in_y</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">H4</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">z_in_y</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">z_eq_y</span> | <span class="id" type="var">z_in_nil</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">z</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">y</span>,u'); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">trivial</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">set</span> (<span class="id" type="var">m</span> := (<span class="id" type="var">S</span> (<span class="id" type="var">maxl</span> <span class="id" type="var">_</span> (<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">xt</span> =&gt; (<span class="id" type="var">inject_inv</span> (<span class="id" type="var">fst</span> <span class="id" type="var">xt</span>), <span class="id" type="var">snd</span> <span class="id" type="var">xt</span>)) <span class="id" type="var">sigma</span>)))).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> (<span class="id" type="var">inject</span> <span class="id" type="var">m</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> (<span class="id" type="var">replace_at_pos</span> <span class="id" type="var">s</span> (<span class="id" type="var">Var</span> (<span class="id" type="var">inject</span> <span class="id" type="var">m</span>)) <span class="id" type="var">p</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> ((<span class="id" type="var">inject</span> <span class="id" type="var">m</span>, <span class="id" type="var">u'</span>) :: <span class="id" type="var">sigma</span>); <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">right</span>; <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">m_in_s</span>; <span class="id" type="tactic">assert</span> (<span class="id" type="var">m_in_sig</span> := <span class="id" type="var">H4</span> <span class="id" type="var">_</span> <span class="id" type="var">m_in_s</span>); <span class="id" type="var">absurd</span> (<span class="id" type="var">m</span> &lt; <span class="id" type="var">m</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">lt_irrefl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">m_in_sig</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">m_in_sig</span> <span class="id" type="keyword">as</span> [[<span class="id" type="var">z'</span> <span class="id" type="var">t</span>] [<span class="id" type="var">z_eq_z'</span> <span class="id" type="var">z_in_sig</span>]]; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">z_eq_z'</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">z'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">m</span> <span class="id" type="tactic">at</span> 2; <span class="id" type="tactic">apply</span> <span class="id" type="var">le_n_S</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">maxl_is_max</span> <span class="id" type="keyword">with</span> <span class="id" type="var">t</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">inject</span> <span class="id" type="var">m</span>,t); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Hinject2</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_replace_at_pos</span>; <span class="id" type="tactic">simpl</span>; [<span class="id" type="tactic">trivial</span> | <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">subst_replace_at_pos</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">eq_var_bool_refl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">s</span> =&gt; <span class="id" type="var">replace_at_pos</span> <span class="id" type="var">s</span> <span class="id" type="var">u'</span> <span class="id" type="var">p</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">subst_eq_vars</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">z</span> <span class="id" type="var">z_in_s</span>; <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">z</span> (<span class="id" type="var">inject</span> <span class="id" type="var">m</span>)); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">z</span> (<span class="id" type="var">inject</span> <span class="id" type="var">m</span>)); [<span class="id" type="tactic">intro</span> <span class="id" type="var">z_eq_m</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">absurd</span> (<span class="id" type="var">m</span> &lt; <span class="id" type="var">m</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">lt_irrefl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">le_lt_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">inject_inv</span> <span class="id" type="var">z</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">z</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Hinject2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">le_n</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">z_in_sig</span> := <span class="id" type="var">H4</span> <span class="id" type="var">_</span> <span class="id" type="var">z_in_s</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">z_in_sig</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">z_in_sig</span> <span class="id" type="keyword">as</span> [[<span class="id" type="var">z'</span> <span class="id" type="var">t</span>] [<span class="id" type="var">z_eq_z'</span> <span class="id" type="var">z_in_sig</span>]]; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">z_eq_z'</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">z'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">m</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">le_n_S</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">maxl_is_max</span> <span class="id" type="keyword">with</span> <span class="id" type="var">t</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">z</span>,t); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">is_a_pos_exists_subterm</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>); <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">acc_one_step_list</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">t_in_sigma'</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">t_in_sigma'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">t_in_sigma'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">z</span> [<span class="id" type="var">K1</span> <span class="id" type="var">K2</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">var_in_replace_at_pos</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">K2</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">z_in_s</span> | <span class="id" type="var">z_in_m</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">acc_one_step_list</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Acc_l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_l</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> <span class="id" type="var">z</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">revert</span> <span class="id" type="var">K1</span>; <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">z</span> (<span class="id" type="var">inject</span> <span class="id" type="var">m</span>)); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">z</span> (<span class="id" type="var">inject</span> <span class="id" type="var">m</span>)); [<span class="id" type="tactic">intro</span> <span class="id" type="var">z_eq_m</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">trivial</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">absurd</span> (<span class="id" type="var">m</span> &lt; <span class="id" type="var">m</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">lt_irrefl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">le_lt_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">inject_inv</span> <span class="id" type="var">z</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">z</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Hinject2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">le_n</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">z_in_sig</span> := <span class="id" type="var">H4</span> <span class="id" type="var">_</span> <span class="id" type="var">z_in_s</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">z_in_sig</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">z_in_sig</span> <span class="id" type="keyword">as</span> [[<span class="id" type="var">z'</span> <span class="id" type="var">t'</span>] [<span class="id" type="var">z_eq_z'</span> <span class="id" type="var">z_in_sig</span>]]; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">z_eq_z'</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">z'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">m</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">le_n_S</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">maxl_is_max</span> <span class="id" type="keyword">with</span> <span class="id" type="var">t'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">z</span>,t'); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">z_in_m</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">z_eq_m</span> | <span class="id" type="var">z_in_nil</span>]; [<span class="id" type="tactic">subst</span> <span class="id" type="var">z</span> | <span class="id" type="var">contradiction</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">revert</span> <span class="id" type="var">K1</span>; <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">eq_var_bool_refl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">t</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_inv</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">sigma</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">x_val</span> <span class="id" type="var">x_sigma</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">x_sigma</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_sigma</span> <span class="id" type="keyword">with</span> <span class="id" type="var">x</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find_mem</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>  <span class="id" type="var">x_sigma</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">x'</span> [<span class="id" type="var">sig1</span> [<span class="id" type="var">sig2</span> [<span class="id" type="var">x_eq_x'</span> <span class="id" type="var">H''</span>]]]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">x'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H''</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">WfwfR</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">y</span> <span class="id" type="var">uu</span> [<span class="id" type="var">yuu_eq_xu</span> | <span class="id" type="var">yuu_in_sigma</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">yuu_eq_xu</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">uu</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_inv</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">sigma</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">x_val</span> <span class="id" type="var">x_sigma</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">x_sigma</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_sigma</span> <span class="id" type="keyword">with</span> <span class="id" type="var">x</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find_mem</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>  <span class="id" type="var">x_sigma</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">x'</span> [<span class="id" type="var">sig1</span> [<span class="id" type="var">sig2</span> [<span class="id" type="var">x_eq_x'</span> <span class="id" type="var">H''</span>]]]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">x'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H''</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">WfwfR</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_sigma</span> <span class="id" type="keyword">with</span> <span class="id" type="var">y</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">y</span> <span class="id" type="var">uu</span> [<span class="id" type="var">yuu_eq_xu</span> | <span class="id" type="var">yuu_in_sigma</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">yuu_eq_xu</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">y</span> <span class="id" type="var">uu</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">u'</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">f</span> <span class="id" type="var">k</span>]; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1'</span> <span class="id" type="var">t2'</span> <span class="id" type="var">H''</span> | <span class="id" type="var">f'</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2'</span> <span class="id" type="var">H''</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H''</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">r</span> <span class="id" type="var">l</span> <span class="id" type="var">tau</span> <span class="id" type="var">H'''</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H''</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">y</span> | <span class="id" type="var">g</span> <span class="id" type="var">l</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">R_var</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H'''</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">revert</span> <span class="id" type="var">H</span>; <span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">sigma</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">x_val</span> <span class="id" type="var">x_sigma</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">x_sigma</span>]; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">intro</span>; <span class="id" type="tactic">discriminate</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">x_in_sig</span> : <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,x_val) <span class="id" type="var">sigma</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find_mem</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">x_sigma</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">x'</span> [<span class="id" type="var">sig1</span> [<span class="id" type="var">sig2</span> [<span class="id" type="var">x_eq_x'</span> <span class="id" type="var">K</span>]]]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">x'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">H1</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">x_in_sig</span>); <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H</span>; <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">map_length</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">L</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">L</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">well_formed_unfold</span> (<span class="id" type="var">proj2</span> (<span class="id" type="var">WR</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H'''</span>))) <span class="id" type="keyword">as</span> [<span class="id" type="var">_</span> <span class="id" type="var">L'</span>]; <span class="id" type="tactic">apply</span> <span class="id" type="var">sym_eq</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">F.arity</span> <span class="id" type="var">g</span>); <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">H1</span> <span class="id" type="var">x</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l2'</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">replace</span> (<span class="id" type="var">length</span> <span class="id" type="var">k</span>) <span class="id" type="keyword">with</span> (<span class="id" type="var">length</span> <span class="id" type="var">l2'</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">K</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H8</span>; <span class="id" type="var">revert</span> <span class="id" type="var">H8</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">sigma</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">x_val</span> <span class="id" type="var">x_sigma</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">x_sigma</span>]; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">intro</span>; <span class="id" type="tactic">discriminate</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">find_mem</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">x_sigma</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">x'</span> [<span class="id" type="var">sig1</span> [<span class="id" type="var">sig2</span> [<span class="id" type="var">x_eq_x'</span> <span class="id" type="var">K'</span>]]]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">x'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">K'</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">revert</span> <span class="id" type="var">H''</span>; <span class="id" type="tactic">clear</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H''</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">H''</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHH''</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">H1</span> <span class="id" type="var">y</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">y</span> <span class="id" type="var">uu</span> <span class="id" type="var">vv</span> [<span class="id" type="var">yuu_eq_xu</span> | <span class="id" type="var">yuu_in_sigma</span>] [<span class="id" type="var">yvv_eq_xu</span> | <span class="id" type="var">yvv_in_sigma</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">yuu_eq_xu</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">y</span> <span class="id" type="var">uu</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">yvv_eq_xu</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">vv</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">yuu_eq_xu</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> <span class="id" type="var">y_eq_m</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">absurd</span> (<span class="id" type="var">m</span> &lt; <span class="id" type="var">m</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">lt_irrefl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">le_lt_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">inject_inv</span> <span class="id" type="var">y</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">y</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Hinject2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">le_n</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">m</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">le_n_S</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">maxl_is_max</span> <span class="id" type="keyword">with</span> <span class="id" type="var">vv</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">y</span>, <span class="id" type="var">vv</span>); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">yvv_eq_xu</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> <span class="id" type="var">y_eq_m</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">absurd</span> (<span class="id" type="var">m</span> &lt; <span class="id" type="var">m</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">lt_irrefl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">le_lt_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">inject_inv</span> <span class="id" type="var">y</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">y</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Hinject2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">le_n</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">m</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">le_n_S</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">maxl_is_max</span> <span class="id" type="keyword">with</span> <span class="id" type="var">uu</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">y</span>, <span class="id" type="var">uu</span>); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">H2</span> <span class="id" type="var">y</span>); <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">y</span> <span class="id" type="var">z</span> <span class="id" type="var">uu</span> [<span class="id" type="var">yuu_eq_xu</span> | <span class="id" type="var">yuu_in_sigma</span>] [<span class="id" type="var">zuu_eq_xu</span> | <span class="id" type="var">zuu_in_sigma</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">yuu_eq_xu</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">y</span> <span class="id" type="var">uu</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">zuu_eq_xu</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">yuu_eq_xu</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">uu_eq_u'</span> <span class="id" type="var">y_eq_m</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">u'_not_in_sigma</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">u'</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_impl_mem</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">z</span>,uu); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">zuu_eq_xu</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">uu_eq_u'</span> <span class="id" type="var">z_eq_m</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">u'_not_in_sigma</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">u'</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_impl_mem</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">y</span>,uu); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">H3</span> <span class="id" type="var">y</span> <span class="id" type="var">z</span> <span class="id" type="var">uu</span>); <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">z</span> <span class="id" type="var">z_in_s'</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">var_in_replace_at_pos</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">z_in_s'</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">z_in_s</span> | <span class="id" type="var">z_in_m</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">right</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H4</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">z_in_m</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">z_eq_m</span> | <span class="id" type="var">z_in_nil</span>]; [<span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span> | <span class="id" type="var">contradiction</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">H5</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">y</span> [<span class="id" type="var">s'</span> [<span class="id" type="var">sigma'</span> [<span class="id" type="var">k0</span> [<span class="id" type="var">K0</span> [<span class="id" type="var">Ws'</span> [<span class="id" type="var">K</span> [<span class="id" type="var">Acc_sigma'</span> [<span class="id" type="var">K1</span> [<span class="id" type="var">K2</span> [<span class="id" type="var">K3</span> [<span class="id" type="var">K4</span> [<span class="id" type="var">K5</span> <span class="id" type="var">K6</span>]]]]]]]]]]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">K</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">x</span> =&gt; <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma'</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>)) (<span class="id" type="var">var_list</span> <span class="id" type="var">s'</span>)); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">y_sig</span> : <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma'</span> (<span class="id" type="var">Var</span> <span class="id" type="var">y</span>) = <span class="id" type="var">u'</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">y</span> <span class="id" type="var">sigma'</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">y_val</span> <span class="id" type="var">y_sig</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">y_sig</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">K3</span> <span class="id" type="var">y</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find_mem</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">y_sig</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">y'</span> [<span class="id" type="var">sig1</span> [<span class="id" type="var">sig3</span> [<span class="id" type="var">y_eq_y'</span> <span class="id" type="var">J</span>]]]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">y</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">J</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">find_not_found</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">y</span> <span class="id" type="var">y</span> <span class="id" type="var">u'</span> <span class="id" type="var">sigma'</span> <span class="id" type="var">y_sig</span> (<span class="id" type="var">eq_var_bool_refl</span> <span class="id" type="var">y</span>) <span class="id" type="var">K6</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">x_sig</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">x</span>, <span class="id" type="var">x</span>&lt;&gt; <span class="id" type="var">y</span> -&gt; <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma'</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>) = <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">z</span> <span class="id" type="var">z_diff_y</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">K0</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">K0</span> | [<span class="id" type="var">y_not_in_s</span> <span class="id" type="var">K0</span>]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">sigma'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">z</span> <span class="id" type="var">y</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">z</span> <span class="id" type="var">y</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">z_eq_y</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">absurd</span> (<span class="id" type="var">z</span>=y); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">k0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">K0</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">K0</span> | [<span class="id" type="var">y_not_in_s</span> <span class="id" type="var">K0</span>]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">sigma'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">clear</span> <span class="id" type="var">x_sig</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">revert</span> <span class="id" type="var">H</span> <span class="id" type="var">y_sig</span> <span class="id" type="var">Sub</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">clear</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">revert</span> <span class="id" type="var">sigma</span> <span class="id" type="var">p</span> <span class="id" type="var">x</span> <span class="id" type="var">u'</span> <span class="id" type="var">y</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">s</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma</span> <span class="id" type="var">p</span> <span class="id" type="var">x</span> <span class="id" type="var">u'</span> <span class="id" type="var">y</span> <span class="id" type="var">H</span> <span class="id" type="var">y_sig</span> <span class="id" type="var">Sub</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">p</span> <span class="id" type="keyword">as</span> [ | ]; [<span class="id" type="tactic">injection</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">v</span> | <span class="id" type="tactic">discriminate</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="var">replace_at_pos</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="var">var_list</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">y_sig</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">y_sig</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">IHl</span> <span class="id" type="var">sigma</span> <span class="id" type="var">p</span> <span class="id" type="var">x</span> <span class="id" type="var">u'</span> <span class="id" type="var">y</span> <span class="id" type="var">H</span> <span class="id" type="var">y_sig</span> <span class="id" type="var">Sub</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">p</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">p</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Sub</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">revert</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">nth_error_ok_in</span> <span class="id" type="var">i</span> <span class="id" type="var">l</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">nth_error</span> <span class="id" type="var">l</span> <span class="id" type="var">i</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">ti</span> | ]; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">discriminate</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">H'</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">l1</span> [<span class="id" type="var">l2</span> [<span class="id" type="var">L</span> <span class="id" type="var">H''</span>]]]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">Sub</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">replace_at_pos_unfold</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">replace_at_pos_list_replace_at_pos_in_subterm</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">do</span> 2 (<span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_list_unfold</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_list_list_app</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">map_app</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="var">var_list_list</span>; <span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> <span class="id" type="var">map_app</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">set</span> (<span class="id" type="var">k1</span> :=  (<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">x0</span> : <span class="id" type="var">T1.variable</span> =&gt; <span class="id" type="var">T1.apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">T1.Var</span> <span class="id" type="var">x0</span>)) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">T1.var_list_list</span> <span class="id" type="var">l1</span>))) <span class="id" type="keyword">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">set</span> (<span class="id" type="var">k2</span> :=  (<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">x0</span> : <span class="id" type="var">T1.variable</span> =&gt; <span class="id" type="var">T1.apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">T1.Var</span> <span class="id" type="var">x0</span>)) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">T1.var_list_list</span> <span class="id" type="var">l2</span>))) <span class="id" type="keyword">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">clearbody</span> <span class="id" type="var">k1</span> <span class="id" type="var">k2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">Hi</span> : <span class="id" type="var">one_step_list</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">x0</span> : <span class="id" type="var">T1.variable</span> =&gt; <span class="id" type="var">T1.apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">T1.Var</span> <span class="id" type="var">x0</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">T1.var_list</span> (<span class="id" type="var">T1.replace_at_pos</span> <span class="id" type="var">ti</span> (<span class="id" type="var">T1.Var</span> <span class="id" type="var">y</span>) <span class="id" type="var">p</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">x0</span> : <span class="id" type="var">T1.variable</span> =&gt; <span class="id" type="var">T1.apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">T1.Var</span> <span class="id" type="var">x0</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">T1.var_list</span> <span class="id" type="var">ti</span>))).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span> <span class="id" type="keyword">with</span> <span class="id" type="var">x</span> <span class="id" type="var">u'</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">set</span> (<span class="id" type="var">k</span> := <span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">x0</span> : <span class="id" type="var">T1.variable</span> =&gt; <span class="id" type="var">T1.apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">T1.Var</span> <span class="id" type="var">x0</span>)) (<span class="id" type="var">T1.var_list</span> <span class="id" type="var">ti</span>)) <span class="id" type="keyword">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">set</span> (<span class="id" type="var">k'</span> := <span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">x0</span> : <span class="id" type="var">T1.variable</span> =&gt; <span class="id" type="var">T1.apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">T1.Var</span> <span class="id" type="var">x0</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">T1.var_list</span> (<span class="id" type="var">T1.replace_at_pos</span> <span class="id" type="var">ti</span> (<span class="id" type="var">T1.Var</span> <span class="id" type="var">y</span>) <span class="id" type="var">p</span>))) <span class="id" type="keyword">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">clearbody</span> <span class="id" type="var">k</span> <span class="id" type="var">k'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">k1</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">s1</span> <span class="id" type="var">k1</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">Hi</span>; [<span class="id" type="var">left</span> | <span class="id" type="var">right</span>]; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">revert</span> <span class="id" type="var">H</span> <span class="id" type="var">x_sig</span> <span class="id" type="var">y_sig</span> <span class="id" type="var">y_not_in_s</span> <span class="id" type="var">Sub</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">clear</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">revert</span> <span class="id" type="var">sigma</span> <span class="id" type="var">p</span> <span class="id" type="var">x</span> <span class="id" type="var">u'</span> <span class="id" type="var">y</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">s</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma</span> <span class="id" type="var">p</span> <span class="id" type="var">x</span> <span class="id" type="var">u'</span> <span class="id" type="var">y</span> <span class="id" type="var">H</span> <span class="id" type="var">x_sig</span> <span class="id" type="var">y_sig</span> <span class="id" type="var">y_not_in_s</span> <span class="id" type="var">Sub</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">p</span> <span class="id" type="keyword">as</span> [ | ]; [<span class="id" type="tactic">injection</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">v</span> | <span class="id" type="tactic">discriminate</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="var">replace_at_pos</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="var">var_list</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">y_sig</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">y_sig</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">IHl</span> <span class="id" type="var">sigma</span> <span class="id" type="var">p</span> <span class="id" type="var">x</span> <span class="id" type="var">u'</span> <span class="id" type="var">y</span> <span class="id" type="var">H</span> <span class="id" type="var">x_sig</span> <span class="id" type="var">y_sig</span> <span class="id" type="var">y_not_in_s</span> <span class="id" type="var">Sub</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">p</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">p</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Sub</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">revert</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">nth_error_ok_in</span> <span class="id" type="var">i</span> <span class="id" type="var">l</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">nth_error</span> <span class="id" type="var">l</span> <span class="id" type="var">i</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">ti</span> | ]; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">discriminate</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">H'</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">l1</span> [<span class="id" type="var">l2</span> [<span class="id" type="var">L</span> <span class="id" type="var">H''</span>]]]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">Sub</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">replace_at_pos_unfold</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">replace_at_pos_list_replace_at_pos_in_subterm</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">do</span> 2 (<span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_list_unfold</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_list_list_app</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">map_app</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="var">var_list_list</span>; <span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> <span class="id" type="var">map_app</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">set</span> (<span class="id" type="var">k1</span> :=  (<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">x0</span> : <span class="id" type="var">T1.variable</span> =&gt; <span class="id" type="var">T1.apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">T1.Var</span> <span class="id" type="var">x0</span>)) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">T1.var_list_list</span> <span class="id" type="var">l1</span>))) <span class="id" type="keyword">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">set</span> (<span class="id" type="var">k1'</span> := (<span class="id" type="var">map</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">fun</span> <span class="id" type="var">x0</span> : <span class="id" type="var">T1.variable</span> =&gt; <span class="id" type="var">T1.apply_subst</span> ((<span class="id" type="var">y</span>, <span class="id" type="var">u'</span>) :: <span class="id" type="var">sigma</span>) (<span class="id" type="var">T1.Var</span> <span class="id" type="var">x0</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">T1.var_list_list</span> <span class="id" type="var">l1</span>))) <span class="id" type="keyword">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">k1_eq_k1'</span> : <span class="id" type="var">k1</span> = <span class="id" type="var">k1'</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">y_not_in_l1</span> : ~In <span class="id" type="var">y</span> (<span class="id" type="var">var_list_list</span> <span class="id" type="var">l1</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">y_in_l1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">y_not_in_s</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_list_list_app</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">set</span> (<span class="id" type="var">vl1</span> := (<span class="id" type="var">var_list_list</span> <span class="id" type="var">l1</span>)) <span class="id" type="keyword">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">clearbody</span> <span class="id" type="var">vl1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">vl1</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">v1</span> <span class="id" type="var">vl1</span>]; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">k1</span> <span class="id" type="var">k1'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">IHvl1</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">IHvl1</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">IHvl1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">v1_sig</span> := <span class="id" type="var">x_sig</span> <span class="id" type="var">v1</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v1_sig</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">v1_sig</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">v1_sig</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">v1_eq_y</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">y_not_in_l1</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">y_in_l1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">y_not_in_l1</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">clearbody</span> <span class="id" type="var">k1</span> <span class="id" type="var">k1'</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">k1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">set</span> (<span class="id" type="var">k2</span> :=  (<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">x0</span> : <span class="id" type="var">T1.variable</span> =&gt; <span class="id" type="var">T1.apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">T1.Var</span> <span class="id" type="var">x0</span>)) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">T1.var_list_list</span> <span class="id" type="var">l2</span>))) <span class="id" type="keyword">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">set</span> (<span class="id" type="var">k2'</span> := (<span class="id" type="var">map</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">fun</span> <span class="id" type="var">x0</span> : <span class="id" type="var">T1.variable</span> =&gt; <span class="id" type="var">T1.apply_subst</span> ((<span class="id" type="var">y</span>, <span class="id" type="var">u'</span>) :: <span class="id" type="var">sigma</span>) (<span class="id" type="var">T1.Var</span> <span class="id" type="var">x0</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">T1.var_list_list</span> <span class="id" type="var">l2</span>))) <span class="id" type="keyword">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">k2_eq_k2'</span> : <span class="id" type="var">k2</span> = <span class="id" type="var">k2'</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">y_not_in_l2</span> : ~In <span class="id" type="var">y</span> (<span class="id" type="var">var_list_list</span> <span class="id" type="var">l2</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">y_in_l2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">y_not_in_s</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_list_list_app</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">set</span> (<span class="id" type="var">vl2</span> := (<span class="id" type="var">var_list_list</span> <span class="id" type="var">l2</span>)) <span class="id" type="keyword">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">clearbody</span> <span class="id" type="var">vl2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">vl2</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">v2</span> <span class="id" type="var">vl2</span>]; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">k2</span> <span class="id" type="var">k2'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">IHvl2</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">IHvl2</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">IHvl2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">v2_sig</span> := <span class="id" type="var">x_sig</span> <span class="id" type="var">v2</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v2_sig</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">v2_sig</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">v2_sig</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">v2_eq_y</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">y_not_in_l2</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">y_in_l2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">y_not_in_l2</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">clearbody</span> <span class="id" type="var">k2</span> <span class="id" type="var">k2'</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">k2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">Hi</span> : <span class="id" type="var">one_step_list</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">x0</span> : <span class="id" type="var">T1.variable</span> =&gt; <span class="id" type="var">T1.apply_subst</span> ((<span class="id" type="var">y</span>,u') :: <span class="id" type="var">sigma</span>) (<span class="id" type="var">T1.Var</span> <span class="id" type="var">x0</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">T1.var_list</span> (<span class="id" type="var">T1.replace_at_pos</span> <span class="id" type="var">ti</span> (<span class="id" type="var">T1.Var</span> <span class="id" type="var">y</span>) <span class="id" type="var">p</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">x0</span> : <span class="id" type="var">T1.variable</span> =&gt; <span class="id" type="var">T1.apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">T1.Var</span> <span class="id" type="var">x0</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">T1.var_list</span> <span class="id" type="var">ti</span>))).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span> <span class="id" type="keyword">with</span> <span class="id" type="var">x</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">y_in_ti</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">y_not_in_s</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_list_unfold</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_list_list_app</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">set</span> (<span class="id" type="var">k</span> := <span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">x0</span> : <span class="id" type="var">T1.variable</span> =&gt; <span class="id" type="var">T1.apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">T1.Var</span> <span class="id" type="var">x0</span>)) (<span class="id" type="var">T1.var_list</span> <span class="id" type="var">ti</span>)) <span class="id" type="keyword">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">set</span> (<span class="id" type="var">k'</span> := <span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">x0</span> : <span class="id" type="var">T1.variable</span> =&gt; <span class="id" type="var">T1.apply_subst</span> ((<span class="id" type="var">y</span>,u') :: <span class="id" type="var">sigma</span>) (<span class="id" type="var">T1.Var</span> <span class="id" type="var">x0</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">T1.var_list</span> (<span class="id" type="var">T1.replace_at_pos</span> <span class="id" type="var">ti</span> (<span class="id" type="var">T1.Var</span> <span class="id" type="var">y</span>) <span class="id" type="var">p</span>))) <span class="id" type="keyword">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">clearbody</span> <span class="id" type="var">k</span> <span class="id" type="var">k'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">k1'</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">s1</span> <span class="id" type="var">k1</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">Hi</span>; [<span class="id" type="var">left</span> | <span class="id" type="var">right</span>]; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">s''</span> <span class="id" type="var">s''_R_s'</span> <span class="id" type="var">Ws''</span> <span class="id" type="var">l''</span> <span class="id" type="var">Acc_l''</span> <span class="id" type="var">sigma''</span> <span class="id" type="var">J0</span> <span class="id" type="var">Acc_sigma''</span> <span class="id" type="var">J1</span> <span class="id" type="var">J2</span> <span class="id" type="var">J3</span> <span class="id" type="var">J4</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHs</span> <span class="id" type="keyword">with</span> <span class="id" type="var">l''</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">s''_R_s'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t'</span> <span class="id" type="var">t''</span> <span class="id" type="var">J</span>]; <span class="id" type="tactic">subst</span> <span class="id" type="var">t'</span> <span class="id" type="var">t''</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">s'</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Ren</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">replace</span> (<span class="id" type="var">collapse_subst</span> <span class="id" type="var">s</span>) <span class="id" type="keyword">with</span> (<span class="id" type="var">collapse_subst</span> (<span class="id" type="var">T1.replace_at_pos</span> <span class="id" type="var">s</span> (<span class="id" type="var">T1.Var</span> <span class="id" type="var">y</span>) <span class="id" type="var">p</span>)); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">revert</span> <span class="id" type="var">Sub</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">clear</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">Sub</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">col_map</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">collapse_subst</span> <span class="id" type="var">t</span> = <span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">Var</span> (<span class="id" type="var">inject</span> 0)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">map</span> <span class="id" type="var">collapse_subst</span> <span class="id" type="var">l</span>) <span class="id" type="keyword">end</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">clear</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">collapse_subst</span>; <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">eq_var_bool_refl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">collapse_subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_list_unfold</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="tactic">f_equal</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">f</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">map_eq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">t_in_l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">subst_eq_vars</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_t'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">find_col</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">find_col</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">in_split</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">t_in_l</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">l1</span> [<span class="id" type="var">l2</span> <span class="id" type="var">H</span>]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_list_list_app</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">revert</span> <span class="id" type="var">p</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">s</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">p</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">p</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">p</span>]; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">discriminate</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">injection</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">v</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> <span class="id" type="var">col_map</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">IH</span> <span class="id" type="var">p</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">p</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">p</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">replace_at_pos_unfold</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> <span class="id" type="var">col_map</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="tactic">f_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Sub</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">revert</span> <span class="id" type="var">Sub</span>; <span class="id" type="var">case_eq</span> (<span class="id" type="var">nth_error</span> <span class="id" type="var">l</span> <span class="id" type="var">i</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">ti</span> <span class="id" type="var">H</span> <span class="id" type="var">Sub</span>| <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">discriminate</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">nth_error_ok_in</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">l1</span> [<span class="id" type="var">l2</span> [<span class="id" type="var">L</span> <span class="id" type="var">H'</span>]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">replace_at_pos_list_replace_at_pos_in_subterm</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> <span class="id" type="var">map_app</span>; <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="tactic">f_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">t</span> =&gt; <span class="id" type="var">t</span> :: <span class="id" type="var">map</span> <span class="id" type="var">collapse_subst</span> <span class="id" type="var">l2</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IH</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">almost_const</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">match</span> <span class="id" type="var">F.arity</span> <span class="id" type="var">f</span> <span class="id" type="keyword">with</span> <span class="id" type="var">Free</span> <span class="id" type="var">n</span> =&gt; <span class="id" type="var">n</span> | <span class="id" type="var">_</span> =&gt; 2 <span class="id" type="keyword">end</span> ) &lt;&gt; <span class="id" type="var">length</span> <span class="id" type="var">l</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">Acc_l</span>; <span class="id" type="var">revert</span> <span class="id" type="var">f</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">acc_one_step_list</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Acc_l</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">Acc_l</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">l</span> <span class="id" type="var">Acc_l</span> <span class="id" type="var">IHl</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">L</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H1</span> | <span class="id" type="var">g</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">H2</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H1</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">r</span> <span class="id" type="var">l'</span> <span class="id" type="var">sigma</span> <span class="id" type="var">H2</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">l'</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">g</span> <span class="id" type="var">l'</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">R_var</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H0</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">L</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">map_length</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">Wf</span> := <span class="id" type="var">WR</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H0</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">well_formed_unfold</span> (<span class="id" type="var">proj2</span> <span class="id" type="var">Wf</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">_</span> <span class="id" type="var">L'</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">sym_eq</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">F.arity</span> <span class="id" type="var">f</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">replace</span> (<span class="id" type="var">length</span> <span class="id" type="var">l1</span>) <span class="id" type="keyword">with</span> (<span class="id" type="var">length</span> <span class="id" type="var">l</span>); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">sym_eq</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">rwr_list_length_eq</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">acc_well_formed_acc_all</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">well_formed</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">Acc</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">WfR</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">y</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H1</span> | ].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H1</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">sigma</span>]; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">t2</span> <span class="id" type="keyword">as</span> [ | ]; [<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">R_var</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H3</span>) | <span class="id" type="tactic">discriminate</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">Acc_l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">eq_nat_dec</span> (<span class="id" type="keyword">match</span> <span class="id" type="var">F.arity</span> <span class="id" type="var">f</span> <span class="id" type="keyword">with</span> <span class="id" type="var">Free</span> <span class="id" type="var">n</span> =&gt; <span class="id" type="var">n</span> | <span class="id" type="var">_</span> =&gt; 2 <span class="id" type="keyword">end</span> ) (<span class="id" type="var">length</span> <span class="id" type="var">l</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">L</span> | <span class="id" type="var">L</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">decompose_term</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">s</span> [<span class="id" type="var">sigma</span> [<span class="id" type="var">H0</span> [<span class="id" type="var">Ws</span> [<span class="id" type="var">H1</span> [<span class="id" type="var">H2</span> [<span class="id" type="var">H3</span> <span class="id" type="var">H4</span>]]]]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">s</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">z</span> | <span class="id" type="var">g</span> <span class="id" type="var">k</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="var">revert</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">z</span> <span class="id" type="var">sigma</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">z_val</span> <span class="id" type="var">z_sig</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">z_sig</span>]; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">discriminate</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">H1</span> <span class="id" type="var">z</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">find_mem</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">z_sig</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">z'</span> [<span class="id" type="var">sig1</span> [<span class="id" type="var">sig2</span> [<span class="id" type="var">z_eq_z'</span> <span class="id" type="var">H</span>]]]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">z'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">acc_decomposed_term</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">x</span> =&gt; <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>)) (<span class="id" type="var">var_list</span> (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">k</span>))); <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">acc_one_step_list</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">t_in_sig</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">t_in_sig</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">t_in_sig</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x</span> [<span class="id" type="var">H</span> <span class="id" type="var">x_in_s</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">var_in_subterm2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> (<span class="id" type="var">in_impl_mem</span> (@<span class="id" type="var">eq</span> <span class="id" type="var">_</span>) (<span class="id" type="keyword">fun</span> <span class="id" type="var">a</span> =&gt; <span class="id" type="var">refl_equal</span> <span class="id" type="var">a</span>) <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">x_in_s</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">p</span> <span class="id" type="var">Sub</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">p</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">p</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Sub</span>; <span class="id" type="var">revert</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">nth_error_ok_in</span> <span class="id" type="var">i</span> <span class="id" type="var">k</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">nth_error</span> <span class="id" type="var">k</span> <span class="id" type="var">i</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">ti</span> | ].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">H'</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">l1</span> [<span class="id" type="var">l2</span> [<span class="id" type="var">L'</span> <span class="id" type="var">H''</span>]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">t</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">acc_subterms_3</span> <span class="id" type="keyword">with</span> <span class="id" type="var">p</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">ti</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_l</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> <span class="id" type="var">ti</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">k</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">subterm_at_pos_apply_subst_apply_subst_subterm_at_pos</span> <span class="id" type="var">ti</span> <span class="id" type="var">p</span> <span class="id" type="var">sigma</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span> <span class="id" type="var">xu_in_sig</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">x_in_s</span> : <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">k</span>))).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H4</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">x</span>,u); <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">replace</span> <span class="id" type="var">u</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">var_in_subterm2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>  (<span class="id" type="var">in_impl_mem</span> (@<span class="id" type="var">eq</span> <span class="id" type="var">_</span>) (<span class="id" type="keyword">fun</span> <span class="id" type="var">a</span> =&gt; <span class="id" type="var">refl_equal</span> <span class="id" type="var">a</span>) <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">x_in_s</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">p</span> <span class="id" type="var">Sub</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">p</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">p</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Sub</span>; <span class="id" type="var">revert</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">nth_error_ok_in</span> <span class="id" type="var">i</span> <span class="id" type="var">k</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">nth_error</span> <span class="id" type="var">k</span> <span class="id" type="var">i</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">ti</span> | ].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">H'</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">l1</span> [<span class="id" type="var">l2</span> [<span class="id" type="var">L'</span> <span class="id" type="var">H''</span>]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">Sub</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">acc_subterms_3</span> <span class="id" type="keyword">with</span> <span class="id" type="var">p</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">ti</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_l</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> <span class="id" type="var">ti</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">k</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">subterm_at_pos_apply_subst_apply_subst_subterm_at_pos</span> <span class="id" type="var">ti</span> <span class="id" type="var">p</span> <span class="id" type="var">sigma</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">subst_aux</span> <span class="id" type="keyword">with</span> <span class="id" type="var">sigma</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H4</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">almost_const</span>; <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">End</span> <span class="id" type="var">Dec_well_formed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">are_constructors_of_R</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">R</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">v</span> <span class="id" type="var">t</span>, ~ <span class="id" type="var">R</span> <span class="id" type="var">t</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>)) -&gt; <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span>  <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">t'</span>, (<span class="id" type="var">refl_trans_clos</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>) <span class="id" type="var">t'</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)) -&gt;<br/>
&nbsp;&nbsp;(~defined <span class="id" type="var">R</span> <span class="id" type="var">f</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="var">exists</span> <span class="id" type="var">l'</span>, <span class="id" type="var">t'</span> = <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l'</span> /\ <span class="id" type="var">refl_trans_clos</span> (<span class="id" type="var">one_step_list</span> (<span class="id" type="var">one_step</span> <span class="id" type="var">R</span>)) <span class="id" type="var">l'</span> <span class="id" type="var">l</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">R</span> <span class="id" type="var">R_var</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">t'</span> <span class="id" type="var">H</span> <span class="id" type="var">Cf</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">u</span> | <span class="id" type="var">u1</span> <span class="id" type="var">u2</span> <span class="id" type="var">K</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="var">exists</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">split</span>; [<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span> | <span class="id" type="var">left</span>].<br/>
<span class="id" type="tactic">set</span> (<span class="id" type="var">t</span> := <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) <span class="id" type="keyword">in</span> *.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H</span> := <span class="id" type="var">refl_equal</span> <span class="id" type="var">t</span>).<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">t</span> <span class="id" type="tactic">at</span> 2 <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="var">clearbody</span> <span class="id" type="var">t</span>; <span class="id" type="var">revert</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">K</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">u1</span> <span class="id" type="var">u2</span> <span class="id" type="var">K1</span> | <span class="id" type="var">u1</span> <span class="id" type="var">u2</span> <span class="id" type="var">u3</span> <span class="id" type="var">K1</span> <span class="id" type="var">Kn</span>]; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">K1</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v1</span> <span class="id" type="var">v2</span> <span class="id" type="var">K</span> | <span class="id" type="var">g</span> <span class="id" type="var">k1</span> <span class="id" type="var">k2</span> <span class="id" type="var">K</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">K1</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">K</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v1</span> <span class="id" type="var">v2</span> <span class="id" type="var">sigma</span> <span class="id" type="var">H</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">K</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">v2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x2</span> | <span class="id" type="var">f2</span> <span class="id" type="var">l2</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">R_var</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H1</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Cf</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="var">constructor</span> 1 <span class="id" type="keyword">with</span> <span class="id" type="var">l2</span> <span class="id" type="var">v1</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="var">exists</span> <span class="id" type="var">k1</span>; <span class="id" type="tactic">split</span>; [<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span> | <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>].<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">IHKn</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">l'</span> [<span class="id" type="var">H1</span> <span class="id" type="var">H2</span>]]; <span class="id" type="tactic">clear</span> <span class="id" type="var">IHKn</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">K1</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v1</span> <span class="id" type="var">v2</span> <span class="id" type="var">K</span> | <span class="id" type="var">g</span> <span class="id" type="var">k1</span> <span class="id" type="var">k2</span> <span class="id" type="var">K</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">K1</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">K</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v1</span> <span class="id" type="var">v2</span> <span class="id" type="var">sigma</span> <span class="id" type="var">H</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">K</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">v2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x2</span> | <span class="id" type="var">f2</span> <span class="id" type="var">l2</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">R_var</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H1</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Cf</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="var">constructor</span> 1 <span class="id" type="keyword">with</span> <span class="id" type="var">l2</span> <span class="id" type="var">v1</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="var">exists</span> <span class="id" type="var">k1</span>; <span class="id" type="tactic">split</span>; [<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span> | <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_trans_clos_is_trans</span> <span class="id" type="keyword">with</span> <span class="id" type="var">l'</span>].<br/>
<span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">End</span> <span class="id" type="var">Make</span>.<br/>

<br/>
</div>
</div>

<div id="footer">
<hr/><a href="index.html">Index</a><hr/>This page has been generated by <a href="http://www.lix.polytechnique.fr/coq/">coqdoc</a>
</div>

</div>

</body>
</html>