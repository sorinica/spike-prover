<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"/>
<link href="coqdoc.css" rel="stylesheet" type="text/css"/>
<title>term_algebra.term</title>
</head>

<body>

<div id="page">

<div id="header">
</div>

<div id="main">

<h1 class="libtitle">Library term_algebra.term</h1>

<div class="code">

<br/>
</div>

<div class="doc">
<a name="lab55"></a><h1 class="section">Term algebra defined as functor from a Module Signature and a Module Variable.</h1>

</div>
<div class="code">

<br/>
<span class="id" type="keyword">Add</span> <span class="id" type="var">LoadPath</span> "basis".<br/>
<span class="id" type="keyword">Add</span> <span class="id" type="var">LoadPath</span> "list_extensions".<br/>

<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Recdef</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">List</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">closure</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">more_list</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">list_permut</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">list_set</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Arith</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">decidable_set</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Setoid</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">term_spec</span>.<br/>

<br/>
<span class="id" type="keyword">Set</span> <span class="id" type="keyword">Implicit</span> <span class="id" type="var">Arguments</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab56"></a><h1 class="section">A functor building a Term Module from a Signature and a set of Variables.</h1>

</div>
<div class="code">

<br/>
<span class="id" type="keyword">Module</span> <span class="id" type="var">Make'</span> (<span class="id" type="var">F1</span> : <span class="id" type="var">Signature</span>) (<span class="id" type="var">X1</span> : <span class="id" type="var">decidable_set.S</span>) &lt;: <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Term</span> <span class="id" type="keyword">with</span> <span class="id" type="keyword">Module</span> <span class="id" type="var">F</span> := <span class="id" type="var">F1</span> <span class="id" type="keyword">with</span> <span class="id" type="keyword">Module</span> <span class="id" type="var">X</span> := <span class="id" type="var">X1</span>.<br/>

<br/>
<span class="id" type="keyword">Module</span> <span class="id" type="var">F</span> := <span class="id" type="var">F1</span>.<br/>
<span class="id" type="keyword">Import</span> <span class="id" type="var">F1</span>.<br/>

<br/>
<span class="id" type="keyword">Module</span> <span class="id" type="var">X</span> := <span class="id" type="var">X1</span>.<br/>
<span class="id" type="keyword">Import</span> <span class="id" type="var">X1</span>.<br/>

<br/>
<span class="id" type="keyword">Notation</span> <span class="id" type="var">symbol</span> := <span class="id" type="var">Symb.A</span>.<br/>
<span class="id" type="keyword">Notation</span> <span class="id" type="var">eq_symb_bool</span> := <span class="id" type="var">Symb.eq_bool</span>.<br/>

<br/>
<span class="id" type="keyword">Notation</span> <span class="id" type="var">variable</span> := <span class="id" type="var">X.A</span>.<br/>
<span class="id" type="keyword">Notation</span> <span class="id" type="var">eq_var_bool</span> := <span class="id" type="var">X.eq_bool</span>.<br/>

<br/>
<span class="id" type="keyword">Module</span> <span class="id" type="var">EX</span> := <span class="id" type="var">decidable_set.Convert</span> (<span class="id" type="var">X</span>).<br/>
<span class="id" type="keyword">Module</span> <span class="id" type="var">VSet</span> : <br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">list_set.S</span> <span class="id" type="keyword">with</span> <span class="id" type="keyword">Definition</span> <span class="id" type="var">EDS.A</span> := <span class="id" type="var">X.A</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">with</span> <span class="id" type="keyword">Definition</span> <span class="id" type="var">EDS.eq_A</span> := @<span class="id" type="var">eq</span> <span class="id" type="var">X.A</span> := <span class="id" type="var">list_set.Make</span> (<span class="id" type="var">EX</span>).<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">eq_symb_bool_refl</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">f</span>, <span class="id" type="var">eq_symb_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">f</span> = <span class="id" type="var">true</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">f</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">Symb.eq_bool_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">f</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">eq_symb_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">f</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">f_diff_f</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">f_diff_f</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">eq_var_bool_refl</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">v</span>, <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">v</span> = <span class="id" type="var">true</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">v</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v</span> <span class="id" type="var">v</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">v</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">v_diff_v</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">v_diff_v</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
Definition of terms. 
Arity is not taken into account, and terms may be hill-formed. 
</div>
<div class="code">

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">term</span> : <span class="id" type="keyword">Set</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">Var</span> : <span class="id" type="var">variable</span> -&gt; <span class="id" type="var">term</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Term</span> : <span class="id" type="var">symbol</span> -&gt; <span class="id" type="var">list</span> <span class="id" type="var">term</span> -&gt; <span class="id" type="var">term</span>.<br/>

<br/>
</div>

<div class="doc">
Definition and a few properties of the size of a term.
</div>
<div class="code">
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">size</span> (<span class="id" type="var">t</span>:term) : <span class="id" type="var">nat</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">v</span> =&gt; 1<br/>
&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">_</span> <span class="id" type="var">l</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">size_list</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">fix</span> <span class="id" type="var">size_list</span> (<span class="id" type="var">l</span> : <span class="id" type="var">list</span> <span class="id" type="var">term</span>) {<span class="id" type="keyword">struct</span> <span class="id" type="var">l</span>} : <span class="id" type="var">nat</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; 0<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">t</span> :: <span class="id" type="var">lt</span> =&gt; <span class="id" type="var">size</span> <span class="id" type="var">t</span> + <span class="id" type="var">size_list</span> <span class="id" type="var">lt</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>) <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1 + <span class="id" type="var">size_list</span> <span class="id" type="var">l</span><br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">size_unfold</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>,<br/>
&nbsp;<span class="id" type="var">size</span> <span class="id" type="var">t</span> = <span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; 1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> =&gt; 1 + <span class="id" type="var">list_size</span> <span class="id" type="var">size</span> <span class="id" type="var">l</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="tactic">f_equal</span>.<br/>
<span class="id" type="var">revert</span> <span class="id" type="var">l</span>; <span class="id" type="var">fix</span> 1.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">l</span>.<br/>
<span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">size_unfold</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="keyword">Defined</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">size_ge_one</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, 1 &lt;= <span class="id" type="var">size</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">le_n</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">size_unfold</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">le_n_S</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">le_O_n</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="var">Function</span> <span class="id" type="var">var_in_term_list</span> (<span class="id" type="var">x</span> : <span class="id" type="var">variable</span>) (<span class="id" type="var">l</span> : <span class="id" type="var">list</span> <span class="id" type="var">term</span>) <br/>
{ <span class="id" type="keyword">measure</span> (<span class="id" type="var">list_size</span> <span class="id" type="var">size</span>) <span class="id" type="var">l</span> } : <span class="id" type="var">bool</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">Var</span> <span class="id" type="var">y</span>) :: <span class="id" type="var">l</span> =&gt; <span class="id" type="var">orb</span> (<span class="id" type="var">eq_var_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span>) (<span class="id" type="var">var_in_term_list</span> <span class="id" type="var">x</span> <span class="id" type="var">l</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">Term</span> <span class="id" type="var">_</span> <span class="id" type="var">ll</span>) :: <span class="id" type="var">l</span> =&gt; <span class="id" type="var">orb</span> (<span class="id" type="var">var_in_term_list</span> <span class="id" type="var">x</span> <span class="id" type="var">ll</span>) (<span class="id" type="var">var_in_term_list</span> <span class="id" type="var">x</span> <span class="id" type="var">l</span>)<br/>
<span class="id" type="keyword">end</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> <span class="id" type="var">l</span> <span class="id" type="var">t</span> <span class="id" type="var">l'</span> <span class="id" type="var">y</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span>;  <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> <span class="id" type="var">l</span> <span class="id" type="var">t</span> <span class="id" type="var">l'</span> <span class="id" type="var">f</span> <span class="id" type="var">ll</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> <span class="id" type="var">l</span> <span class="id" type="var">t</span> <span class="id" type="var">l'</span> <span class="id" type="var">f</span> <span class="id" type="var">ll</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">lt_le_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">size</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">ll</span>)).<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">size_unfold</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="keyword">Defined</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">var_in_term</span> (<span class="id" type="var">v</span> : <span class="id" type="var">variable</span>) (<span class="id" type="var">t</span> : <span class="id" type="var">term</span>) : <span class="id" type="var">bool</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">x</span> =&gt;  (<span class="id" type="var">eq_var_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">v</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">_</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">var_in_term_list</span> <span class="id" type="var">v</span> <span class="id" type="var">l</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">var_list</span> (<span class="id" type="var">t</span> : <span class="id" type="var">term</span>) : <span class="id" type="var">list</span> <span class="id" type="var">variable</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">x</span> =&gt; (<span class="id" type="var">x</span> :: <span class="id" type="var">nil</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">_</span> <span class="id" type="var">l</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">var_list_list</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">fix</span> <span class="id" type="var">var_list_list</span> (<span class="id" type="var">l</span> : <span class="id" type="var">list</span> <span class="id" type="var">term</span>) {<span class="id" type="keyword">struct</span> <span class="id" type="var">l</span>} : <span class="id" type="var">list</span> <span class="id" type="var">variable</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">nil</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">t</span> :: <span class="id" type="var">lt</span> =&gt; <span class="id" type="var">var_list</span> <span class="id" type="var">t</span> ++ <span class="id" type="var">var_list_list</span> <span class="id" type="var">lt</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>) <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">var_list_list</span> <span class="id" type="var">l</span><br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="var">Function</span> <span class="id" type="var">var_list_list</span> (<span class="id" type="var">l</span> : <span class="id" type="var">list</span> <span class="id" type="var">term</span>) {<span class="id" type="keyword">struct</span> <span class="id" type="var">l</span>} : <span class="id" type="var">list</span> <span class="id" type="var">variable</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">nil</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">t</span> :: <span class="id" type="var">lt</span> =&gt; <span class="id" type="var">var_list</span> <span class="id" type="var">t</span> ++ <span class="id" type="var">var_list_list</span> <span class="id" type="var">lt</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">var_list_list_app</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>, <span class="id" type="var">var_list_list</span> (<span class="id" type="var">l1</span> ++ <span class="id" type="var">l2</span>) = (<span class="id" type="var">var_list_list</span> <span class="id" type="var">l1</span>) ++ <span class="id" type="var">var_list_list</span> <span class="id" type="var">l2</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="var">fix</span> 1; <span class="id" type="tactic">intros</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">l1</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">l1</span>.<br/>
<span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">l1</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">ass_app</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_list_list_app</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">in_var_list_list</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">l</span> <span class="id" type="var">v</span>, <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">var_list_list</span> <span class="id" type="var">l</span>) -&gt; <span class="id" type="var">exists</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> /\ <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">t</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="var">fix</span> 1; <span class="id" type="tactic">intro</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">l</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_nil</span>; <span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_tl</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">in_app_or</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">v_in_tl</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v_in_t</span> | <span class="id" type="var">v_in_l</span>].<br/>
<span class="id" type="var">exists</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">split</span>; [<span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span> | <span class="id" type="tactic">assumption</span>].<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">in_var_list_list</span> <span class="id" type="var">l</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_l</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">u</span> [<span class="id" type="var">u_in_l</span> <span class="id" type="var">v_in_u</span>]].<br/>
<span class="id" type="var">exists</span> <span class="id" type="var">u</span>; <span class="id" type="tactic">split</span>; [<span class="id" type="var">right</span> | <span class="id" type="var">idtac</span>]; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">mem_var_list_list</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">l</span> <span class="id" type="var">v</span>, <span class="id" type="var">mem</span> (@<span class="id" type="var">eq</span> <span class="id" type="var">_</span>) <span class="id" type="var">v</span> (<span class="id" type="var">var_list_list</span> <span class="id" type="var">l</span>) -&gt; <span class="id" type="var">exists</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> /\ <span class="id" type="var">mem</span> (@<span class="id" type="var">eq</span> <span class="id" type="var">_</span>) <span class="id" type="var">v</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">t</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="var">fix</span> 1; <span class="id" type="tactic">intro</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">l</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_nil</span>; <span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_tl</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">mem_or_app</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_in_tl</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">v_in_tl</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v_in_t</span> | <span class="id" type="var">v_in_l</span>].<br/>
<span class="id" type="var">exists</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">split</span>; [<span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span> | <span class="id" type="tactic">assumption</span>].<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">mem_var_list_list</span> <span class="id" type="var">l</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_l</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">u</span> [<span class="id" type="var">u_in_l</span> <span class="id" type="var">v_in_u</span>]].<br/>
<span class="id" type="var">exists</span> <span class="id" type="var">u</span>; <span class="id" type="tactic">split</span>; [<span class="id" type="var">right</span> | <span class="id" type="var">idtac</span>]; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">var_in_term_list_is_sound</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">l</span>, <span class="id" type="var">var_in_term_list</span> <span class="id" type="var">x</span> <span class="id" type="var">l</span> = <span class="id" type="var">true</span> &lt;-&gt; <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list_list</span> <span class="id" type="var">l</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">l</span>; <span class="id" type="var">functional</span> <span class="id" type="tactic">induction</span> (<span class="id" type="var">var_in_term_list</span> <span class="id" type="var">x</span> <span class="id" type="var">l</span>) <span class="id" type="keyword">as</span> [ | <span class="id" type="var">x'</span> <span class="id" type="var">y</span> <span class="id" type="var">l</span> <span class="id" type="var">H1</span> <span class="id" type="var">IH</span> | <span class="id" type="var">x'</span> <span class="id" type="var">f</span> <span class="id" type="var">ll</span> <span class="id" type="var">l</span> <span class="id" type="var">H1</span> <span class="id" type="var">IHll</span> <span class="id" type="var">IHl</span>].<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intuition</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">IH</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">eq_var_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span>); <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">x_eq_y</span>; <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">sym_eq</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">x_diff_y</span>; <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">x_in_l</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">intros</span> [<span class="id" type="var">y_eq_x</span> | <span class="id" type="var">x_in_l</span>]; [<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">x_diff_y</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">sym_eq</span> | <span class="id" type="var">idtac</span>]; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">split</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">x_in_ll_l</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">Bool.orb_prop</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">x_in_ll_l</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">x_in_ll</span> | <span class="id" type="var">x_in_l</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">IHll</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">IHl</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">case</span> (<span class="id" type="var">in_app_or</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">x_in_ll_l</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">x_in_ll</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">x_in_l</span>].<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">IHll</span> <span class="id" type="keyword">in</span> <span class="id" type="var">x_in_ll</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">x_in_ll</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">IHl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">x_in_l</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">x_in_l</span>; <span class="id" type="tactic">case</span> (<span class="id" type="var">var_in_term_list</span> <span class="id" type="var">x</span> <span class="id" type="var">ll</span>); <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">var_in_term_is_sound</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">t</span>, <span class="id" type="var">var_in_term</span> <span class="id" type="var">x</span> <span class="id" type="var">t</span> = <span class="id" type="var">true</span> &lt;-&gt; <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">t</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">y</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">y</span> <span class="id" type="var">x</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">eq_var_bool</span> <span class="id" type="var">y</span> <span class="id" type="var">x</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">y_eq_x</span> <span class="id" type="var">_</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> <span class="id" type="var">Abs</span>; <span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">y_diff_x</span> <span class="id" type="var">y_in_x</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">y_in_x</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">y_in_x</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">y_eq_x</span>; <span class="id" type="var">absurd</span> (<span class="id" type="var">y</span> = <span class="id" type="var">x</span>); <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">Abs</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">Abs</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">var_in_term_list_is_sound</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">var_list_unfold</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>,<br/>
&nbsp;<span class="id" type="var">var_list</span> <span class="id" type="var">t</span> = <span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">x</span> =&gt; (<span class="id" type="var">x</span> :: <span class="id" type="var">nil</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">_</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">var_list_list</span> <span class="id" type="var">l</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">direct_subterm</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">t2</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">False</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">_</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">In</span> <span class="id" type="var">t1</span> <span class="id" type="var">l</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">size_direct_subterm</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">direct_subterm</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> -&gt; <span class="id" type="var">size</span> <span class="id" type="var">t1</span> &lt; <span class="id" type="var">size</span> <span class="id" type="var">t2</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">direct_subterm</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">t2</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t2</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">a</span> <span class="id" type="var">Abs</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">Abs</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">size_unfold</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)).<br/>
<span class="id" type="var">revert</span> <span class="id" type="var">t1</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">f</span>; <span class="id" type="var">fix</span> 2.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">Abs</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">Abs</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> <span class="id" type="var">t1_in_tl</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">t1_in_tl</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t1_in_tl</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">t_eq_t1</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">t1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">le_n_S</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">le_plus_l</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">t_in_l</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">lt_le_trans</span> <span class="id" type="keyword">with</span> (1 + <span class="id" type="var">list_size</span> <span class="id" type="var">size</span> <span class="id" type="var">l</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">size_direct_subterm</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">le_n_S</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">le_plus_r</span>.<br/>
<span class="id" type="keyword">Defined</span>.<br/>

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">symb_in_term</span> (<span class="id" type="var">f</span> : <span class="id" type="var">symbol</span>) (<span class="id" type="var">t</span>:term) : <span class="id" type="var">bool</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">false</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">l</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">symb_in_term_list</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">fix</span> <span class="id" type="var">symb_in_term_list</span> <span class="id" type="var">f</span> (<span class="id" type="var">l</span> : <span class="id" type="var">list</span> <span class="id" type="var">term</span>) {<span class="id" type="keyword">struct</span> <span class="id" type="var">l</span>} : <span class="id" type="var">bool</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">t</span> :: <span class="id" type="var">lt</span> =&gt; <span class="id" type="var">orb</span> (<span class="id" type="var">symb_in_term</span> <span class="id" type="var">f</span> <span class="id" type="var">t</span>) (<span class="id" type="var">symb_in_term_list</span> <span class="id" type="var">f</span> <span class="id" type="var">lt</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>) <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">orb</span> (<span class="id" type="var">eq_symb_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span>) (<span class="id" type="var">symb_in_term_list</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">symb_in_term_list</span> <span class="id" type="var">f</span> (<span class="id" type="var">l</span> : <span class="id" type="var">list</span> <span class="id" type="var">term</span>) {<span class="id" type="keyword">struct</span> <span class="id" type="var">l</span>} : <span class="id" type="var">bool</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">t</span> :: <span class="id" type="var">lt</span> =&gt; <span class="id" type="var">orb</span> (<span class="id" type="var">symb_in_term</span> <span class="id" type="var">f</span> <span class="id" type="var">t</span>) (<span class="id" type="var">symb_in_term_list</span> <span class="id" type="var">f</span> <span class="id" type="var">lt</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">symb_list</span> (<span class="id" type="var">t</span> : <span class="id" type="var">term</span>) : <span class="id" type="var">list</span> <span class="id" type="var">symbol</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">x</span> =&gt; <span class="id" type="var">nil</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">symb_list_list</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">fix</span> <span class="id" type="var">symb_list_list</span> (<span class="id" type="var">l</span> : <span class="id" type="var">list</span> <span class="id" type="var">term</span>) {<span class="id" type="keyword">struct</span> <span class="id" type="var">l</span>} : <span class="id" type="var">list</span> <span class="id" type="var">symbol</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">nil</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">t</span> :: <span class="id" type="var">lt</span> =&gt; <span class="id" type="var">symb_list</span> <span class="id" type="var">t</span> ++ <span class="id" type="var">symb_list_list</span> <span class="id" type="var">lt</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>) <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">f</span> :: (<span class="id" type="var">symb_list_list</span> <span class="id" type="var">l</span>)<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="var">Function</span> <span class="id" type="var">symb_list_list</span> (<span class="id" type="var">l</span> : <span class="id" type="var">list</span> <span class="id" type="var">term</span>) {<span class="id" type="keyword">struct</span> <span class="id" type="var">l</span>} : <span class="id" type="var">list</span> <span class="id" type="var">symbol</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">nil</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">t</span> :: <span class="id" type="var">lt</span> =&gt; <span class="id" type="var">symb_list</span> <span class="id" type="var">t</span> ++ <span class="id" type="var">symb_list_list</span> <span class="id" type="var">lt</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">symb_list_list_app</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>, <span class="id" type="var">symb_list_list</span> (<span class="id" type="var">l1</span> ++ <span class="id" type="var">l2</span>) = (<span class="id" type="var">symb_list_list</span> <span class="id" type="var">l1</span>) ++ <span class="id" type="var">symb_list_list</span> <span class="id" type="var">l2</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="var">fix</span> 1; <span class="id" type="tactic">intros</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">l1</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">l1</span>.<br/>
<span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">l1</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">ass_app</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">symb_list_list_app</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">in_symb_list_list</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">l</span> <span class="id" type="var">f</span>, <span class="id" type="var">In</span> <span class="id" type="var">f</span> (<span class="id" type="var">symb_list_list</span> <span class="id" type="var">l</span>) -&gt; <span class="id" type="var">exists</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> /\ <span class="id" type="var">In</span> <span class="id" type="var">f</span> (<span class="id" type="var">symb_list</span> <span class="id" type="var">t</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="var">fix</span> 1; <span class="id" type="tactic">intro</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">l</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_nil</span>; <span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_tl</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">in_app_or</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">v_in_tl</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v_in_t</span> | <span class="id" type="var">v_in_l</span>].<br/>
<span class="id" type="var">exists</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">split</span>; [<span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span> | <span class="id" type="tactic">assumption</span>].<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">in_symb_list_list</span> <span class="id" type="var">l</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_l</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">u</span> [<span class="id" type="var">u_in_l</span> <span class="id" type="var">v_in_u</span>]].<br/>
<span class="id" type="var">exists</span> <span class="id" type="var">u</span>; <span class="id" type="tactic">split</span>; [<span class="id" type="var">right</span> | <span class="id" type="var">idtac</span>]; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">symb_in_term_unfold</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">t</span>,  <span class="id" type="var">symb_in_term</span> <span class="id" type="var">f</span> <span class="id" type="var">t</span> = <span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">l</span> =&gt;  <span class="id" type="var">orb</span> (<span class="id" type="var">eq_symb_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span>) (<span class="id" type="var">symb_in_term_list</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">g</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">symb_in_term_list_app</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>, <span class="id" type="var">symb_in_term_list</span> <span class="id" type="var">f</span> (<span class="id" type="var">l1</span> ++ <span class="id" type="var">l2</span>) = <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">orb</span> (<span class="id" type="var">symb_in_term_list</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span>) (<span class="id" type="var">symb_in_term_list</span> <span class="id" type="var">f</span> <span class="id" type="var">l2</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="var">fix</span> 2.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">l1</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">l1</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">l1</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">Bool.orb_assoc</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">b</span> =&gt; <span class="id" type="var">orb</span> (<span class="id" type="var">symb_in_term</span> <span class="id" type="var">f</span> <span class="id" type="var">t</span>) <span class="id" type="var">b</span>)).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">symb_in_term_list_app</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">symb_in_direct_subterm</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">t</span> <span class="id" type="var">g</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="var">symb_in_term</span> <span class="id" type="var">g</span> <span class="id" type="var">t</span> = <span class="id" type="var">true</span> -&gt; <span class="id" type="var">symb_in_term</span> <span class="id" type="var">g</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) = <span class="id" type="var">true</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">s</span> <span class="id" type="var">g</span> <span class="id" type="var">s_in_l</span> <span class="id" type="var">g_in_s</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">symb_in_term_unfold</span>.<br/>
<span class="id" type="tactic">case</span> (<span class="id" type="var">eq_symb_bool</span> <span class="id" type="var">g</span> <span class="id" type="var">f</span>).<br/>
<span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="var">revert</span> <span class="id" type="var">l</span> <span class="id" type="var">s_in_l</span>; <span class="id" type="var">fix</span> 1.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">l</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">Abs</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">Abs</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="var">In</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> <span class="id" type="var">s_in_tl</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">s_in_tl</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">s_in_tl</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t_eq_s</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">g_in_s</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s_in_l</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">case</span> (<span class="id" type="var">symb_in_term</span> <span class="id" type="var">g</span> <span class="id" type="var">t</span>).<br/>
<span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">symb_in_direct_subterm</span> <span class="id" type="var">_</span> <span class="id" type="var">s_in_l</span>); <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">eq_bool</span> (<span class="id" type="var">t1</span> <span class="id" type="var">t2</span> :term) : <span class="id" type="var">bool</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">t1</span>, <span class="id" type="var">t2</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">v1</span>, <span class="id" type="var">Var</span> <span class="id" type="var">v2</span> =&gt; <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v1</span> <span class="id" type="var">v2</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span>, <span class="id" type="var">Term</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">false</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>, <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">false</span>  <br/>
&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f1</span> <span class="id" type="var">l1</span>, <span class="id" type="var">Term</span> <span class="id" type="var">f2</span> <span class="id" type="var">l2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">if</span> <span class="id" type="var">eq_symb_bool</span> <span class="id" type="var">f1</span> <span class="id" type="var">f2</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">eq_bool_list</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">fix</span> <span class="id" type="var">eq_bool_list</span> (<span class="id" type="var">l1</span> <span class="id" type="var">l2</span>: <span class="id" type="var">list</span> <span class="id" type="var">term</span>) {<span class="id" type="keyword">struct</span> <span class="id" type="var">l1</span>} : <span class="id" type="var">bool</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l1</span>, <span class="id" type="var">l2</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span>, <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span>, (<span class="id" type="var">_</span> :: <span class="id" type="var">_</span>) =&gt; <span class="id" type="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">_</span>::_), <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">t1</span> :: <span class="id" type="var">k1</span>, <span class="id" type="var">t2</span> :: <span class="id" type="var">k2</span> =&gt; <span class="id" type="keyword">if</span> <span class="id" type="var">eq_bool</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="keyword">then</span> <span class="id" type="var">eq_bool_list</span> <span class="id" type="var">k1</span> <span class="id" type="var">k2</span> <span class="id" type="keyword">else</span> <span class="id" type="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>) <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">eq_bool_list</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">else</span> <span class="id" type="var">false</span><br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">eq_bool_ok</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="keyword">match</span> <span class="id" type="var">eq_bool</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="keyword">with</span> <span class="id" type="var">true</span> =&gt; <span class="id" type="var">t1</span> = <span class="id" type="var">t2</span> | <span class="id" type="var">false</span> =&gt; <span class="id" type="var">t1</span>&lt;&gt; <span class="id" type="var">t2</span> <span class="id" type="keyword">end</span>.<br/>
<span class="id" type="var">fix</span> 1.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">t1</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">t1</span>; [<span class="id" type="tactic">intro</span> <span class="id" type="var">v1</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">f1</span> <span class="id" type="var">l1</span>]; (<span class="id" type="tactic">intro</span> <span class="id" type="var">t2</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">t2</span>; [<span class="id" type="tactic">intro</span> <span class="id" type="var">v2</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">f2</span> <span class="id" type="var">l2</span>]); <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v1</span> <span class="id" type="var">v2</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v1</span> <span class="id" type="var">v2</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v1_eq_v2</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">v1_eq_v2</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v1_diff_v2</span> <span class="id" type="var">v1_eq_v2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">v1_diff_v2</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">v1_eq_v2</span>; <span class="id" type="tactic">intro</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f1</span> <span class="id" type="var">f2</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">eq_symb_bool</span> <span class="id" type="var">f1</span> <span class="id" type="var">f2</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f1_eq_f2</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">f1_eq_f2</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">eq_bool_list_ok</span> : <span class="id" type="keyword">match</span> (<span class="id" type="var">fix</span> <span class="id" type="var">eq_bool_list</span> (<span class="id" type="var">l0</span> <span class="id" type="var">l3</span> : <span class="id" type="var">list</span> <span class="id" type="var">term</span>) : <span class="id" type="var">bool</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l0</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="keyword">match</span> <span class="id" type="var">l3</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">_</span> :: <span class="id" type="var">_</span> =&gt; <span class="id" type="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">t3</span> :: <span class="id" type="var">k1</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l3</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">t4</span> :: <span class="id" type="var">k2</span> =&gt; <span class="id" type="keyword">if</span> <span class="id" type="var">eq_bool</span> <span class="id" type="var">t3</span> <span class="id" type="var">t4</span> <span class="id" type="keyword">then</span> <span class="id" type="var">eq_bool_list</span> <span class="id" type="var">k1</span> <span class="id" type="var">k2</span> <span class="id" type="keyword">else</span> <span class="id" type="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>) <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="keyword">with</span> <span class="id" type="var">true</span> =&gt; <span class="id" type="var">l1</span> = <span class="id" type="var">l2</span> | <span class="id" type="var">false</span> =&gt; <span class="id" type="var">l1</span> &lt;&gt; <span class="id" type="var">l2</span> <span class="id" type="keyword">end</span>).<br/>
<span class="id" type="var">revert</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>; <span class="id" type="tactic">clear</span> - <span class="id" type="var">eq_bool_ok0</span>.<br/>
<span class="id" type="var">fix</span> <span class="id" type="var">eq_bool_list_ok</span> 1.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">l1</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">l1</span>; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">k1</span>]; (<span class="id" type="tactic">intro</span> <span class="id" type="var">l2</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">l2</span>; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">t2</span> <span class="id" type="var">k2</span>]).<br/>
<span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">eq_bool_ok0</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">eq_bool</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">t1_eq_t2</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">t1_eq_t2</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">eq_bool_list_ok</span> <span class="id" type="var">k1</span> <span class="id" type="var">k2</span>); <br/>
<span class="id" type="tactic">case</span> ((<span class="id" type="var">fix</span> <span class="id" type="var">eq_bool_list</span> (<span class="id" type="var">l0</span> <span class="id" type="var">l3</span> : <span class="id" type="var">list</span> <span class="id" type="var">term</span>) : <span class="id" type="var">bool</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l0</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="keyword">match</span> <span class="id" type="var">l3</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">_</span> :: <span class="id" type="var">_</span> =&gt; <span class="id" type="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">t3</span> :: <span class="id" type="var">k3</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l3</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">t4</span> :: <span class="id" type="var">k4</span> =&gt; <span class="id" type="keyword">if</span> <span class="id" type="var">eq_bool</span> <span class="id" type="var">t3</span> <span class="id" type="var">t4</span> <span class="id" type="keyword">then</span> <span class="id" type="var">eq_bool_list</span> <span class="id" type="var">k3</span> <span class="id" type="var">k4</span> <span class="id" type="keyword">else</span> <span class="id" type="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>) <span class="id" type="var">k1</span> <span class="id" type="var">k2</span>).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">k1_eq_k2</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">k1_eq_k2</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">k1_diff_k2</span> <span class="id" type="var">tk1_eq_tk2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">k1_diff_k2</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">tk1_eq_tk2</span>; <span class="id" type="tactic">intro</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t1_diff_t2</span> <span class="id" type="var">tk1_eq_tk2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">t1_diff_t2</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">tk1_eq_tk2</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="var">revert</span> <span class="id" type="var">eq_bool_list_ok</span>;<br/>
<span class="id" type="tactic">case</span> ((<span class="id" type="var">fix</span> <span class="id" type="var">eq_bool_list</span> (<span class="id" type="var">l0</span> <span class="id" type="var">l3</span> : <span class="id" type="var">list</span> <span class="id" type="var">term</span>) : <span class="id" type="var">bool</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l0</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l3</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">_</span> :: <span class="id" type="var">_</span> =&gt; <span class="id" type="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">t3</span> :: <span class="id" type="var">k1</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l3</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">t4</span> :: <span class="id" type="var">k2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">if</span> <span class="id" type="var">eq_bool</span> <span class="id" type="var">t3</span> <span class="id" type="var">t4</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">then</span> <span class="id" type="var">eq_bool_list</span> <span class="id" type="var">k1</span> <span class="id" type="var">k2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">else</span> <span class="id" type="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>) <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">l1_eq_l2</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">l1_eq_l2</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">l1_diff_l2</span> <span class="id" type="var">fl1_eq_fl2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">l1_diff_l2</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">fl1_eq_fl2</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f1_diff_f2</span> <span class="id" type="var">fl1_eq_fl2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">f1_diff_f2</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">fl1_eq_fl2</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Defined</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">eq_term_dec</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">t</span> <span class="id" type="var">t'</span>:term, {<span class="id" type="var">t</span>=t'}+{t&lt;&gt;t'}.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">t'</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">eq_bool_ok</span> <span class="id" type="var">t</span> <span class="id" type="var">t'</span>).<br/>
<span class="id" type="tactic">case</span> (<span class="id" type="var">eq_bool</span> <span class="id" type="var">t</span> <span class="id" type="var">t'</span>).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">t_eq_t'</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">t_diff_t'</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Defined</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">term_term_dec</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span>:term*term, {<span class="id" type="var">x</span>=y}+{~x=y}.<br/>
<span class="id" type="tactic">intros</span> [<span class="id" type="var">a</span> <span class="id" type="var">b</span>] [<span class="id" type="var">a'</span> <span class="id" type="var">b'</span>].<br/>
<span class="id" type="tactic">case</span> (<span class="id" type="var">eq_term_dec</span> <span class="id" type="var">a</span> <span class="id" type="var">a'</span>).<br/>
<span class="id" type="tactic">case</span> (<span class="id" type="var">eq_term_dec</span> <span class="id" type="var">b</span> <span class="id" type="var">b'</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">Heq1</span> <span class="id" type="var">Heq2</span>;<span class="id" type="var">left</span>;<span class="id" type="tactic">f_equal</span>;<span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">abs</span> <span class="id" type="var">_</span>;<span class="id" type="var">right</span>;<span class="id" type="tactic">intro</span> <span class="id" type="var">Heq</span>;<span class="id" type="tactic">elim</span> <span class="id" type="var">abs</span>;<span class="id" type="tactic">injection</span> <span class="id" type="var">Heq</span>;<span class="id" type="tactic">intros</span>;<span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">abs</span>;<span class="id" type="var">right</span>;<span class="id" type="tactic">intro</span> <span class="id" type="var">Heq</span>;<span class="id" type="tactic">elim</span> <span class="id" type="var">abs</span>;<span class="id" type="tactic">injection</span> <span class="id" type="var">Heq</span>;<span class="id" type="tactic">intros</span>;<span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Defined</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">rel_dec</span> : <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> (<span class="id" type="var">P</span> : <span class="id" type="var">relation</span> <span class="id" type="var">term</span>) <span class="id" type="var">Plist</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span>, <span class="id" type="var">P</span> <span class="id" type="var">v</span> <span class="id" type="var">u</span> &lt;-&gt; <span class="id" type="var">In</span> (<span class="id" type="var">u</span>,v) <span class="id" type="var">Plist</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">r</span> <span class="id" type="var">l</span>, {<span class="id" type="var">P</span> <span class="id" type="var">r</span> <span class="id" type="var">l</span>}+{~P <span class="id" type="var">r</span> <span class="id" type="var">l</span>}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">P</span> <span class="id" type="var">Plist</span> <span class="id" type="var">Plist_ok</span> <span class="id" type="var">r</span> <span class="id" type="var">l</span>; <span class="id" type="var">revert</span> <span class="id" type="var">P</span> <span class="id" type="var">Plist_ok</span>.<br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">Plist</span> <span class="id" type="keyword">as</span> [ | [<span class="id" type="var">u</span> <span class="id" type="var">v</span>] <span class="id" type="var">Plist</span>]; <span class="id" type="tactic">intros</span> <span class="id" type="var">P</span> <span class="id" type="var">Plist_ok</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Plist_ok</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">eq_bool_ok</span> <span class="id" type="var">r</span> <span class="id" type="var">v</span>); <span class="id" type="tactic">destruct</span> (<span class="id" type="var">eq_bool</span> <span class="id" type="var">r</span> <span class="id" type="var">v</span>).<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">eq_bool_ok</span> <span class="id" type="var">l</span> <span class="id" type="var">u</span>); <span class="id" type="tactic">destruct</span> (<span class="id" type="var">eq_bool</span> <span class="id" type="var">l</span> <span class="id" type="var">u</span>).<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">l</span> <span class="id" type="var">r</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Plist_ok</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">l_diff_u</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">IHPlist</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">v'</span> <span class="id" type="var">u'</span> =&gt; <span class="id" type="var">P</span> <span class="id" type="var">v'</span> <span class="id" type="var">u'</span> /\ <span class="id" type="var">In</span> (<span class="id" type="var">u'</span>,v') <span class="id" type="var">Plist</span>)) <span class="id" type="keyword">as</span> [[<span class="id" type="var">Ok</span> <span class="id" type="var">_</span>] | <span class="id" type="var">Ko</span>].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">intros</span> [<span class="id" type="var">_</span> <span class="id" type="var">H</span>]; <span class="id" type="tactic">exact</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">split</span>; [<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Plist_ok</span>; <span class="id" type="var">right</span> | ]; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Plist_ok</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">H</span> | <span class="id" type="var">H</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">l_diff_u</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">sym_eq</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Ko</span>; <span class="id" type="tactic">split</span>; [<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Plist_ok</span>; <span class="id" type="var">right</span> | ]; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">r_diff_v</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">IHPlist</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">v'</span> <span class="id" type="var">u'</span> =&gt; <span class="id" type="var">P</span> <span class="id" type="var">v'</span> <span class="id" type="var">u'</span> /\ <span class="id" type="var">In</span> (<span class="id" type="var">u'</span>,v') <span class="id" type="var">Plist</span>)) <span class="id" type="keyword">as</span> [[<span class="id" type="var">Ok</span> <span class="id" type="var">_</span>] | <span class="id" type="var">Ko</span>].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">intros</span> [<span class="id" type="var">_</span> <span class="id" type="var">H</span>]; <span class="id" type="tactic">exact</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">split</span>; [<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Plist_ok</span>; <span class="id" type="var">right</span> | ]; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Plist_ok</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">H</span> | <span class="id" type="var">H</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">r_diff_v</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">sym_eq</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Ko</span>; <span class="id" type="tactic">split</span>; [<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Plist_ok</span>; <span class="id" type="var">right</span> | ]; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Defined</span>.<br/>

<br/>
<span class="id" type="keyword">Module</span> <span class="id" type="var">Term_eq_dec</span> : <span class="id" type="var">decidable_set.S</span> <span class="id" type="keyword">with</span> <span class="id" type="keyword">Definition</span> <span class="id" type="var">A</span>:= <span class="id" type="var">term</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">with</span> <span class="id" type="keyword">Definition</span> <span class="id" type="var">eq_bool</span> := <span class="id" type="var">eq_bool</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">with</span> <span class="id" type="keyword">Definition</span> <span class="id" type="var">eq_bool_ok</span> := <span class="id" type="var">eq_bool_ok</span>.<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">A</span> := <span class="id" type="var">term</span>.<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">eq_bool</span> := <span class="id" type="var">eq_bool</span>.<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">eq_bool_ok</span> := <span class="id" type="var">eq_bool_ok</span>.<br/>
<span class="id" type="keyword">End</span> <span class="id" type="var">Term_eq_dec</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab57"></a><h2 class="section">Recursion on terms.</h2>

</div>
<div class="code">
<span class="id" type="keyword">Section</span> <span class="id" type="var">Recursion</span>.<br/>
<span class="id" type="keyword">Variable</span> <span class="id" type="var">P</span> : <span class="id" type="var">term</span> -&gt; <span class="id" type="keyword">Type</span>.<br/>
<span class="id" type="keyword">Variable</span> <span class="id" type="var">Pl</span> : <span class="id" type="var">list</span> <span class="id" type="var">term</span> -&gt; <span class="id" type="keyword">Type</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">term_rec2</span> : (<span class="id" type="keyword">forall</span> <span class="id" type="var">n</span> <span class="id" type="var">t</span>, <span class="id" type="var">size</span> <span class="id" type="var">t</span> &lt;= <span class="id" type="var">n</span> -&gt; <span class="id" type="var">P</span> <span class="id" type="var">t</span>) -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">P</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">H</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">H</span> (<span class="id" type="var">size</span> <span class="id" type="var">t</span>) <span class="id" type="var">t</span>); <span class="id" type="tactic">apply</span> <span class="id" type="var">le_n</span>.<br/>
<span class="id" type="keyword">Defined</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">term_rec3</span> :<br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">v</span>, <span class="id" type="var">P</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>)) -&gt; (<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="var">P</span> <span class="id" type="var">t</span>) -&gt; <span class="id" type="var">P</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)) -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">P</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>

<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">Hv</span> <span class="id" type="var">Halg</span>.<br/>
<span class="id" type="var">fix</span> 1.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">t</span>;<span class="id" type="tactic">case</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">exact</span> <span class="id" type="var">Hv</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">a</span>.<br/>

<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">l</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">Halg</span>.<br/>
<span class="id" type="var">revert</span> <span class="id" type="var">l</span>.<br/>
<span class="id" type="var">fix</span> <span class="id" type="var">term_list_rec_3</span> 1  .<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">l</span>;<span class="id" type="tactic">case</span> <span class="id" type="var">l</span>.<br/>
<span class="id" type="tactic">simpl</span>;<span class="id" type="tactic">intros</span> <span class="id" type="var">t0</span> <span class="id" type="var">abs</span>;<span class="id" type="tactic">elim</span> <span class="id" type="var">abs</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t0</span> <span class="id" type="var">l0</span> <span class="id" type="var">t1</span> .<br/>
<span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">case</span> (<span class="id" type="var">eq_term_dec</span> <span class="id" type="var">t0</span> <span class="id" type="var">t1</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t_eq_t1</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">t_eq_t1</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">t_eq_t1</span>. <span class="id" type="tactic">assert</span> (<span class="id" type="var">In</span> <span class="id" type="var">t1</span> <span class="id" type="var">l0</span>).<br/>
<span class="id" type="tactic">case</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">intro</span> <span class="id" type="var">abs</span>;<span class="id" type="tactic">elim</span> <span class="id" type="var">t_eq_t1</span>;<span class="id" type="tactic">exact</span> <span class="id" type="var">abs</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">h</span>;<span class="id" type="tactic">exact</span> <span class="id" type="var">h</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">term_list_rec_3</span> <span class="id" type="keyword">with</span> <span class="id" type="var">l0</span>.<br/>
<span class="id" type="tactic">exact</span> <span class="id" type="var">H0</span>.<br/>

<br/>
<span class="id" type="keyword">Defined</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">term_rec4</span> :<br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">v</span>, <span class="id" type="var">P</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>)) -&gt; (<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>, <span class="id" type="var">Pl</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="var">P</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)) -&gt;<br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">l</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="var">P</span> <span class="id" type="var">t</span>) -&gt; <span class="id" type="var">Pl</span> <span class="id" type="var">l</span>) -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">P</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">Hvar</span> <span class="id" type="var">Hterm</span> <span class="id" type="var">Hlist</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec2</span>; <br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">n</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">Size_t</span>.<br/>
<span class="id" type="var">absurd</span> (1&lt;=0); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">le_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">size</span> <span class="id" type="var">t</span>); <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">size_ge_one</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">x</span> | <span class="id" type="var">f</span> <span class="id" type="var">l</span> ]; <span class="id" type="tactic">trivial</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Hterm</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Hlist</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">In_t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHn</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">lt_n_Sm_le</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">lt_le_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">size</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)); <span class="id" type="tactic">trivial</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">size_direct_subterm</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Defined</span>.<br/>
<span class="id" type="keyword">End</span> <span class="id" type="var">Recursion</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab58"></a><h2 class="section">Double recursion on terms.</h2>

</div>
<div class="code">
<span class="id" type="keyword">Section</span> <span class="id" type="var">DoubleRecursion</span>.<br/>
<span class="id" type="keyword">Variable</span> <span class="id" type="var">P2</span> : <span class="id" type="var">term</span> -&gt; <span class="id" type="var">term</span> -&gt; <span class="id" type="keyword">Type</span>.<br/>
<span class="id" type="keyword">Variable</span> <span class="id" type="var">Pl2</span> : <span class="id" type="var">list</span> <span class="id" type="var">term</span> -&gt; <span class="id" type="var">list</span> <span class="id" type="var">term</span> -&gt; <span class="id" type="keyword">Type</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">term_rec7</span> :<br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">v1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">P2</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v1</span>) <span class="id" type="var">t2</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">v2</span>, <span class="id" type="var">P2</span> <span class="id" type="var">t1</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v2</span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">f1</span> <span class="id" type="var">f2</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>, <span class="id" type="var">Pl2</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> -&gt; <span class="id" type="var">P2</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f1</span> <span class="id" type="var">l1</span>) (<span class="id" type="var">Term</span> <span class="id" type="var">f2</span> <span class="id" type="var">l2</span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">In</span> <span class="id" type="var">t1</span> <span class="id" type="var">l1</span> -&gt; <span class="id" type="var">In</span> <span class="id" type="var">t2</span> <span class="id" type="var">l2</span> -&gt; <span class="id" type="var">P2</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>) -&gt; <span class="id" type="var">Pl2</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">P2</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">Hvt</span> <span class="id" type="var">Htv</span> <span class="id" type="var">Hterm</span> <span class="id" type="var">Hlist</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">t1</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec2</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">n</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t1</span>;<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">Size_t1</span>.<br/>
<span class="id" type="var">absurd</span> (1&lt;=0); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">le_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">size</span> <span class="id" type="var">t1</span>); <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">size_ge_one</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t1</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">x1</span> | <span class="id" type="var">f1</span> <span class="id" type="var">l1</span> ]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t2</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">x2</span> | <span class="id" type="var">f2</span> <span class="id" type="var">l2</span> ]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Hterm</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Hlist</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">In_t1</span> <span class="id" type="var">In_t2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHn</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">lt_n_Sm_le</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">lt_le_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">size</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f1</span> <span class="id" type="var">l1</span>)); <span class="id" type="tactic">trivial</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">size_direct_subterm</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Defined</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">term_rec8</span> :<br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">v1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">P2</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v1</span>) <span class="id" type="var">t2</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">v2</span>, <span class="id" type="var">P2</span> <span class="id" type="var">t1</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v2</span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">f1</span> <span class="id" type="var">f2</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>, <span class="id" type="var">Pl2</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span> -&gt; <span class="id" type="var">P2</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f1</span> <span class="id" type="var">l1</span>) (<span class="id" type="var">Term</span> <span class="id" type="var">f2</span> <span class="id" type="var">l2</span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>, <span class="id" type="var">In</span> <span class="id" type="var">t1</span> <span class="id" type="var">l1</span> -&gt; <span class="id" type="var">In</span> <span class="id" type="var">t2</span> <span class="id" type="var">l2</span> -&gt; <span class="id" type="var">P2</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>) -&gt; <span class="id" type="var">Pl2</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>, <span class="id" type="var">Pl2</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">Hvt</span> <span class="id" type="var">Htv</span> <span class="id" type="var">Hterm</span> <span class="id" type="var">Hlist</span> <span class="id" type="var">l1</span> <span class="id" type="var">l2</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Hlist</span>;<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec7</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Defined</span>.<br/>
<span class="id" type="keyword">End</span> <span class="id" type="var">DoubleRecursion</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab59"></a><h2 class="section">Well-formedness of terms, according to the arity.</h2>

</div>
<div class="code">
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">well_formed_bool</span> (<span class="id" type="var">t</span>:term) : <span class="id" type="var">bool</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">true</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">well_formed_list</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">fix</span> <span class="id" type="var">well_formed_list</span> (<span class="id" type="var">l</span>:list <span class="id" type="var">term</span>) : <span class="id" type="var">bool</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">h</span> :: <span class="id" type="var">tl</span> =&gt; <span class="id" type="var">andb</span> (<span class="id" type="var">well_formed_bool</span> <span class="id" type="var">h</span>)  (<span class="id" type="var">well_formed_list</span> <span class="id" type="var">tl</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>) <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">andb</span> (<span class="id" type="var">well_formed_list</span> <span class="id" type="var">l</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">match</span> <span class="id" type="var">arity</span> <span class="id" type="var">f</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Free</span> <span class="id" type="var">n</span> =&gt; <span class="id" type="var">beq_nat</span> (<span class="id" type="var">length</span> <span class="id" type="var">l</span>) <span class="id" type="var">n</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">_</span> =&gt; <span class="id" type="var">beq_nat</span> (<span class="id" type="var">length</span> <span class="id" type="var">l</span>) 2<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">well_formed</span> <span class="id" type="var">t</span> := <span class="id" type="var">well_formed_bool</span> <span class="id" type="var">t</span> = <span class="id" type="var">true</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">well_formed_unfold</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">well_formed</span> <span class="id" type="var">t</span> -&gt;<br/>
&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span> <br/>
&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">True</span><br/>
&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">u</span>, <span class="id" type="var">In</span> <span class="id" type="var">u</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="var">well_formed</span> <span class="id" type="var">u</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">match</span> <span class="id" type="var">arity</span> <span class="id" type="var">f</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Free</span> <span class="id" type="var">n</span> =&gt; <span class="id" type="var">length</span> <span class="id" type="var">l</span> = <span class="id" type="var">n</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">_</span> =&gt; <span class="id" type="var">length</span> <span class="id" type="var">l</span> = 2<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>)<br/>
&nbsp;<span class="id" type="keyword">end</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">well_formed</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">x</span> | <span class="id" type="var">f</span> <span class="id" type="var">l</span> ]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Bool.andb_true_iff</span>.<br/>
<span class="id" type="tactic">intros</span> [<span class="id" type="var">Wl</span> <span class="id" type="var">Ar</span>]; <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">Ar</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">Abs</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">Abs</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Bool.andb_true_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Wl</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">Wl</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">Wa</span> <span class="id" type="var">Wl</span>]; <span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> [<span class="id" type="var">Eq_u_a</span> | <span class="id" type="var">In_u</span>].<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">u</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">revert</span> <span class="id" type="var">Ar</span>; <span class="id" type="tactic">case</span> (<span class="id" type="var">arity</span> <span class="id" type="var">f</span>); <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">beq_nat_eq</span>; <span class="id" type="tactic">symmetry</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">well_formed_fold</span> :<br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>,<br/>
&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span> <br/>
&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">True</span><br/>
&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">u</span>, <span class="id" type="var">In</span> <span class="id" type="var">u</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="var">well_formed</span> <span class="id" type="var">u</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">match</span> <span class="id" type="var">arity</span> <span class="id" type="var">f</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Free</span> <span class="id" type="var">n</span> =&gt; <span class="id" type="var">length</span> <span class="id" type="var">l</span> = <span class="id" type="var">n</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">_</span> =&gt; <span class="id" type="var">length</span> <span class="id" type="var">l</span> = 2<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>)<br/>
&nbsp;<span class="id" type="keyword">end</span> -&gt; <span class="id" type="var">well_formed</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">well_formed</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">x</span> | <span class="id" type="var">f</span> <span class="id" type="var">l</span> ]; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> [<span class="id" type="var">Wl</span> <span class="id" type="var">Ar</span>]; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Bool.andb_true_iff</span>.<br/>
<span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">Ar</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Bool.andb_true_iff</span>; <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Wl</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Wl</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">revert</span> <span class="id" type="var">Ar</span>; <span class="id" type="tactic">case</span> (<span class="id" type="var">arity</span> <span class="id" type="var">f</span>).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">Ar</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Ar</span>; <span class="id" type="tactic">symmetry</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">beq_nat_refl</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">Ar</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Ar</span>; <span class="id" type="tactic">symmetry</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">beq_nat_refl</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">n</span> <span class="id" type="var">Ar</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Ar</span>; <span class="id" type="tactic">symmetry</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">beq_nat_refl</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab60"></a><h2 class="section">Substitutions.</h2>

</div>
<div class="code">
<span class="id" type="keyword">Definition</span> <span class="id" type="var">substitution</span> := <span class="id" type="var">list</span> (<span class="id" type="var">variable</span> * <span class="id" type="var">term</span>).<br/>

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">apply_subst</span> (<span class="id" type="var">sigma</span> : <span class="id" type="var">substitution</span>) (<span class="id" type="var">t</span> : <span class="id" type="var">term</span>) {<span class="id" type="keyword">struct</span> <span class="id" type="var">t</span>} : <span class="id" type="var">term</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">v</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">None</span> =&gt; <span class="id" type="var">t</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Some</span> <span class="id" type="var">v_sigma</span> =&gt; <span class="id" type="var">v_sigma</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">map</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">l</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">empty_subst_is_id</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">apply_subst</span> <span class="id" type="var">nil</span> <span class="id" type="var">t</span> = <span class="id" type="var">t</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">IH</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>));<br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span>]; <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">IH</span> <span class="id" type="var">t</span>).<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IH</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">empty_subst_is_id_list</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">l</span>, <span class="id" type="var">map</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">nil</span>) <span class="id" type="var">l</span> = <span class="id" type="var">l</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span>]; <span class="id" type="tactic">simpl</span>; <br/>
[<span class="id" type="var">idtac</span> | <span class="id" type="tactic">rewrite</span> <span class="id" type="var">empty_subst_is_id</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHl</span>];<br/>
<span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
Composition of substitutions. 
</div>
<div class="code">
<span class="id" type="keyword">Definition</span> <span class="id" type="var">map_subst</span> (<span class="id" type="var">f</span> : <span class="id" type="var">variable</span> -&gt; <span class="id" type="var">term</span> -&gt; <span class="id" type="var">term</span>) <span class="id" type="var">sigma</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">x</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> (<span class="id" type="var">x</span> : <span class="id" type="var">variable</span> * <span class="id" type="var">term</span>) <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">v</span>, <span class="id" type="var">v_sigma</span>) =&gt; (<span class="id" type="var">v</span>, <span class="id" type="var">f</span> <span class="id" type="var">v</span> <span class="id" type="var">v_sigma</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">sigma</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">subst_comp</span> <span class="id" type="var">sigma1</span> <span class="id" type="var">sigma2</span> :=<br/>
&nbsp;&nbsp;(<span class="id" type="var">map_subst</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">_</span> <span class="id" type="var">t</span> =&gt; <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma1</span> <span class="id" type="var">t</span>) <span class="id" type="var">sigma2</span>)<br/>
&nbsp;&nbsp;++ <br/>
&nbsp;&nbsp;(<span class="id" type="var">map_subst</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">v</span> <span class="id" type="var">t</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma2</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">None</span> =&gt; <span class="id" type="var">t</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Some</span> <span class="id" type="var">v_sigma2</span> =&gt; <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma1</span> <span class="id" type="var">v_sigma2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">sigma1</span>).<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">subst_comp_is_subst_comp_aux1</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma</span> <span class="id" type="var">f</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> (<span class="id" type="var">map_subst</span> <span class="id" type="var">f</span> <span class="id" type="var">sigma</span>) =<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;| <span class="id" type="var">None</span> =&gt; <span class="id" type="var">None</span><br/>
&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Some</span> <span class="id" type="var">t</span> =&gt; <span class="id" type="var">Some</span> (<span class="id" type="var">f</span> <span class="id" type="var">v</span> <span class="id" type="var">t</span>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma</span> <span class="id" type="var">f</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">sigma</span> <span class="id" type="keyword">as</span> [ | [<span class="id" type="var">v1</span> <span class="id" type="var">a1</span>] <span class="id" type="var">sigma</span>]; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v</span> <span class="id" type="var">v1</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">v1</span>).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">v_eq_v1</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">v1</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHsigma</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">subst_comp_is_subst_comp_aux2</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma1</span> <span class="id" type="var">sigma2</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">find</span> (<span class="id" type="var">B</span>:= <span class="id" type="var">term</span>) <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> (<span class="id" type="var">sigma1</span> ++ <span class="id" type="var">sigma2</span>)  =<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma1</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Some</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma1</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">None</span> =&gt; <span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma2</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="var">fix</span> 2.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma1</span> <span class="id" type="var">sigma2</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">sigma1</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">sigma1</span>.<br/>
<span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">p</span> <span class="id" type="var">sigma</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">v1</span> <span class="id" type="var">a1</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">case</span> (<span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">v1</span>).<br/>
<span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">subst_comp_is_subst_comp_aux2</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">subst_comp_is_subst_comp</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">sigma1</span> <span class="id" type="var">sigma2</span> <span class="id" type="var">t</span>,<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">apply_subst</span> (<span class="id" type="var">subst_comp</span> <span class="id" type="var">sigma1</span> <span class="id" type="var">sigma2</span>) <span class="id" type="var">t</span> =<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma1</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma2</span> <span class="id" type="var">t</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">sigma1</span> <span class="id" type="var">sigma2</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">subst_comp</span>;<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">subst_comp_is_subst_comp_aux2</span>;<br/>
<span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> <span class="id" type="var">subst_comp_is_subst_comp_aux1</span>;<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma2</span>); <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">simpl</span>;<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma1</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">IH</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>));<br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">a</span> <span class="id" type="var">l</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">IH</span> <span class="id" type="var">a</span>).<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IH</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">instantiated_subterm</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">u</span> <span class="id" type="var">u'</span> <span class="id" type="var">sigma</span>, <span class="id" type="var">trans_clos</span> <span class="id" type="var">direct_subterm</span> <span class="id" type="var">u</span> <span class="id" type="var">u'</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">trans_clos</span> <span class="id" type="var">direct_subterm</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">u</span>) (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">u'</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">u'</span> <span class="id" type="var">sigma</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">trans_incl2</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> [ | <span class="id" type="var">f</span> <span class="id" type="var">l</span>] <span class="id" type="var">s_in_l</span>.<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
Well-formed substitutions. 
</div>
<div class="code">
<span class="id" type="keyword">Definition</span> <span class="id" type="var">well_formed_subst</span> <span class="id" type="var">sigma</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">v</span>, <span class="id" type="keyword">match</span> <span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">None</span> =&gt; <span class="id" type="var">True</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Some</span> <span class="id" type="var">t</span> =&gt; <span class="id" type="var">well_formed</span> <span class="id" type="var">t</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">well_formed_apply_subst</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">sigma</span>, <span class="id" type="var">well_formed_subst</span> <span class="id" type="var">sigma</span> -&gt; <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">well_formed</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">well_formed</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">well_formed</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">sigma</span> <span class="id" type="var">W_sigma</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">W_sigma</span> <span class="id" type="var">v</span>); <br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">Hrec</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Bool.andb_true_iff</span>; <span class="id" type="tactic">intros</span> [<span class="id" type="var">Wl</span> <span class="id" type="var">Ar</span>].<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Bool.andb_true_iff</span>; <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">Ar</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">a</span> <span class="id" type="var">l</span>]; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Bool.andb_true_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Wl</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">Wl</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">Wa</span> <span class="id" type="var">Wl'</span>].<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Bool.andb_true_iff</span>; <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Hrec</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Hrec</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">length_map</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">well_formed_apply_subst_strong</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span>, <span class="id" type="var">var_in_term</span> <span class="id" type="var">x</span> <span class="id" type="var">t</span> = <span class="id" type="var">true</span> -&gt; <span class="id" type="var">well_formed</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>))) -&gt; <br/>
&nbsp;&nbsp;<span class="id" type="var">well_formed</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">well_formed</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">W_sigma</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">W_sigma</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">eq_var_bool_refl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">IHl</span> <span class="id" type="var">W_sigma</span> <span class="id" type="var">Wfl</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">well_formed_unfold</span> <span class="id" type="var">Wfl</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">Wl</span> <span class="id" type="var">Af</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">Wfl</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_fold</span>; <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">u_in_mapl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">u_in_mapl</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">u_in_mapl</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">t</span> [<span class="id" type="var">H</span> <span class="id" type="var">t_in_l</span>]].<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">u</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">W_sigma</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_in_term_is_sound</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">in_split_set</span> <span class="id" type="var">_</span> <span class="id" type="var">eq_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">t_in_l</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">l'</span> [<span class="id" type="var">l''</span> <span class="id" type="var">H</span>]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">l</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_list_unfold</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_list_list_app</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">var_in_term_is_sound</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Wl</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">map_length</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">well_formed_remove_subst</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>, <span class="id" type="var">well_formed</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>) -&gt; <span class="id" type="var">well_formed</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">Hrec</span> <span class="id" type="var">Wfl</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">well_formed_unfold</span> <span class="id" type="var">Wfl</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">Wl</span> <span class="id" type="var">Af</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">Wfl</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">length_map</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Af</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_fold</span>; <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">u_in_l</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">Hrec</span> <span class="id" type="var">u</span> <span class="id" type="var">u_in_l</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Wl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> <span class="id" type="var">u</span>; <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">well_formed_remove_term</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>, <span class="id" type="var">well_formed</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span>, <span class="id" type="var">var_in_term</span> <span class="id" type="var">x</span> <span class="id" type="var">t</span> = <span class="id" type="var">true</span> -&gt; <span class="id" type="var">well_formed</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>)).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">W</span> <span class="id" type="var">x</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v</span> <span class="id" type="var">x</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">x</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v_eq_x</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">exact</span> <span class="id" type="var">W</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">Hrec</span> <span class="id" type="var">Wfl</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="var">apply_subst</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Wfl</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">well_formed_unfold</span> <span class="id" type="var">Wfl</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">Wl</span> <span class="id" type="var">_</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">Wfl</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_in_term_is_sound</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_list_unfold</span>.<br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v_in_tl</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">in_app_or</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">v_in_tl</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v_in_t</span> | <span class="id" type="var">v_in_l</span>].<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">Hrec</span> <span class="id" type="var">t</span>).<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Wl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span>; <span class="id" type="var">exists</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_in_term_is_sound</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">tail_prop</span> <span class="id" type="var">_</span> <span class="id" type="var">Hrec</span>).<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">tail_prop</span> <span class="id" type="var">_</span> <span class="id" type="var">Wl</span>).<br/>
<span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab61"></a><h2 class="section">Positions in a term.</h2>

</div>
<div class="code">
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">is_a_pos</span> (<span class="id" type="var">t</span> : <span class="id" type="var">term</span>) (<span class="id" type="var">p</span> : <span class="id" type="var">list</span> <span class="id" type="var">nat</span>) {<span class="id" type="keyword">struct</span> <span class="id" type="var">p</span>}: <span class="id" type="var">bool</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">p</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">true</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">i</span> :: <span class="id" type="var">q</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">_</span> <span class="id" type="var">l</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">nth_error</span> <span class="id" type="var">l</span> <span class="id" type="var">i</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Some</span> <span class="id" type="var">ti</span> =&gt; <span class="id" type="var">is_a_pos</span> <span class="id" type="var">ti</span> <span class="id" type="var">q</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">None</span> =&gt; <span class="id" type="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="var">Function</span> <span class="id" type="var">subterm_at_pos</span> (<span class="id" type="var">t</span> : <span class="id" type="var">term</span>) (<span class="id" type="var">p</span> : <span class="id" type="var">list</span> <span class="id" type="var">nat</span>) {<span class="id" type="keyword">struct</span> <span class="id" type="var">p</span>}: <span class="id" type="var">option</span> <span class="id" type="var">term</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">p</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">Some</span> <span class="id" type="var">t</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">i</span> :: <span class="id" type="var">q</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">_</span> <span class="id" type="var">l</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">nth_error</span> <span class="id" type="var">l</span> <span class="id" type="var">i</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Some</span> <span class="id" type="var">ti</span> =&gt; <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">ti</span> <span class="id" type="var">q</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">None</span> =&gt; <span class="id" type="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">is_subterm</span> (<span class="id" type="var">s</span> <span class="id" type="var">t</span> : <span class="id" type="var">term</span>) : <span class="id" type="var">bool</span>  :=<br/>
&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span> <br/>
&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">x</span> =&gt; <span class="id" type="keyword">match</span> <span class="id" type="var">s</span> <span class="id" type="keyword">with</span> <span class="id" type="var">Var</span> <span class="id" type="var">y</span> =&gt; <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span> | <span class="id" type="var">_</span> =&gt; <span class="id" type="var">false</span> <span class="id" type="keyword">end</span><br/>
&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">fix</span> <span class="id" type="var">is_subterm_list</span> (<span class="id" type="var">l</span> : <span class="id" type="var">list</span> <span class="id" type="var">term</span>) : <span class="id" type="var">bool</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">t</span> :: <span class="id" type="var">l</span> =&gt; <span class="id" type="var">orb</span> (<span class="id" type="var">is_subterm</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>) (<span class="id" type="var">is_subterm_list</span> <span class="id" type="var">l</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span> <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">orb</span> (<span class="id" type="var">eq_bool</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span>) (<span class="id" type="var">is_subterm_list</span> <span class="id" type="var">l</span>)<br/>
&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">is_subterm_ok_true</span> : <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">is_subterm</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> = <span class="id" type="var">true</span> -&gt; {<span class="id" type="var">p</span> : <span class="id" type="var">list</span> <span class="id" type="var">nat</span> | <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> <span class="id" type="var">s</span>}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">s</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">y</span> | ]; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">H</span>; [ | <span class="id" type="tactic">discriminate</span>].<br/>
<span class="id" type="var">exists</span> <span class="id" type="var">nil</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">apply</span> <span class="id" type="tactic">f_equal</span>; <br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span>); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">exact</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">H</span> =&gt; <span class="id" type="var">H</span>).<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">s</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x</span> | <span class="id" type="var">g</span> <span class="id" type="var">k</span>]; <span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">IHl</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="var">case_eq</span> (<span class="id" type="var">is_subterm</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>) <span class="id" type="var">t</span>).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">IHl</span> <span class="id" type="var">_</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) <span class="id" type="var">Sub</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">p</span> <span class="id" type="var">Sub'</span>].<br/>
<span class="id" type="var">exists</span> (0 :: <span class="id" type="var">p</span>); <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">nSub</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">nSub</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">IHl0</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">p</span> <span class="id" type="var">Sub</span>].<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>; [<span class="id" type="var">right</span> | ]; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">p</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">p</span>].<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="var">exists</span> (<span class="id" type="var">S</span> <span class="id" type="var">i</span> :: <span class="id" type="var">p</span>); <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="var">case_eq</span> (<span class="id" type="var">eq_bool</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">k</span>)).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">s_eq_t</span>; <span class="id" type="var">exists</span> <span class="id" type="var">nil</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">eq_bool_ok</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">k</span>)); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">s_eq_t</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">s_eq_t'</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="tactic">f_equal</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">s_diff_t</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">eq_bool_ok</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">k</span>)); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">s_diff_t</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">s_diff_t</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">s_diff_t</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">s_diff_t</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H'</span> : {<span class="id" type="var">i</span> : <span class="id" type="var">nat</span> &amp; {<span class="id" type="var">p</span> : <span class="id" type="var">list</span> <span class="id" type="var">nat</span> | <span class="id" type="var">subterm_at_pos</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) (<span class="id" type="var">i</span> :: <span class="id" type="var">p</span>) = <span class="id" type="var">Some</span> (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">k</span>)}}).<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="var">case_eq</span> (<span class="id" type="var">is_subterm</span> (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">k</span>) <span class="id" type="var">t</span>).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">IHl</span> <span class="id" type="var">_</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) <span class="id" type="var">Sub</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">p</span> <span class="id" type="var">Sub'</span>].<br/>
<span class="id" type="var">exists</span> 0; <span class="id" type="var">exists</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">nSub</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">nSub</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">IHl0</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">i</span> [<span class="id" type="var">p</span> <span class="id" type="var">Sub</span>]].<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>; [<span class="id" type="var">right</span> | ]; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="var">exists</span> (<span class="id" type="var">S</span> <span class="id" type="var">i</span>); <span class="id" type="var">exists</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">H'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">i</span> [<span class="id" type="var">p</span> <span class="id" type="var">Sub</span>]]; <span class="id" type="var">exists</span> (<span class="id" type="var">i</span> :: <span class="id" type="var">p</span>); <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Defined</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">is_subterm_ok_false</span> : <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">is_subterm</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> = <span class="id" type="var">false</span> -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">p</span>, <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> &lt;&gt; <span class="id" type="var">Some</span> <span class="id" type="var">s</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">s</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">y</span> | ]; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">H</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">p</span>]; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span>); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">x_diff_y</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">x_diff_y</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">exact</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">H</span> =&gt; <span class="id" type="var">H</span>).<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">s</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x</span> | <span class="id" type="var">g</span> <span class="id" type="var">k</span>]; <span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">IHl</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">intros</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">p</span>] <span class="id" type="var">Sub</span>.<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>, <span class="id" type="var">Sub</span>.<br/>
<span class="id" type="var">revert</span> <span class="id" type="var">i</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="tactic">intros</span> [ | <span class="id" type="var">i</span>] <span class="id" type="var">Sub</span> ; <span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">i</span> <span class="id" type="var">Sub</span>; <span class="id" type="var">case_eq</span> (<span class="id" type="var">is_subterm</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>) <span class="id" type="var">t</span>).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">Sub'</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Sub'</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">nSub</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">nSub</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">i</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span>]; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">IHl</span> <span class="id" type="var">_</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) <span class="id" type="var">nSub</span> <span class="id" type="var">p</span> <span class="id" type="var">Sub</span>).<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Sub</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHl0</span> <span class="id" type="keyword">with</span> <span class="id" type="var">i</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>; [<span class="id" type="var">right</span> | ]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">p</span>].<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">t_eq_s'</span>; <span class="id" type="tactic">assert</span> (<span class="id" type="var">t_eq_s</span> : <span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">k</span> = <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>).<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">t_eq_s'</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">t_eq_s'</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">eq_bool_ok</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">k</span>)); <span class="id" type="var">case_eq</span> (<span class="id" type="var">eq_bool</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">k</span>));<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H1</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">t_eq_s</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="keyword">if</span> <span class="id" type="var">eq_symb_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">fix</span> <span class="id" type="var">eq_bool_list</span> (<span class="id" type="var">l1</span> <span class="id" type="var">l2</span> : <span class="id" type="var">list</span> <span class="id" type="var">term</span>) : <span class="id" type="var">bool</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l1</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="keyword">match</span> <span class="id" type="var">l2</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">_</span> :: <span class="id" type="var">_</span> =&gt; <span class="id" type="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">t1</span> :: <span class="id" type="var">k1</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l2</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">t2</span> :: <span class="id" type="var">k2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">if</span> <span class="id" type="var">eq_bool</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="keyword">then</span> <span class="id" type="var">eq_bool_list</span> <span class="id" type="var">k1</span> <span class="id" type="var">k2</span> <span class="id" type="keyword">else</span> <span class="id" type="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>) <span class="id" type="var">l</span> <span class="id" type="var">k</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">else</span> <span class="id" type="var">false</span>).<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="var">revert</span> <span class="id" type="var">i</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="tactic">intros</span> [ | <span class="id" type="var">i</span>]; <span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">intros</span> [ | <span class="id" type="var">i</span>]; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">is_subterm</span> (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">k</span>) <span class="id" type="var">t</span>); [<span class="id" type="tactic">discriminate</span> | <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHl0</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>; [<span class="id" type="var">right</span> | ]; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">is_subterm</span> (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">k</span>) <span class="id" type="var">t</span>); [<span class="id" type="tactic">discriminate</span> | <span class="id" type="tactic">assumption</span>].<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">subterm_at_pos_dec</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span>, {<span class="id" type="var">p</span> : <span class="id" type="var">list</span> <span class="id" type="var">nat</span> | <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> <span class="id" type="var">s</span>}+{forall <span class="id" type="var">p</span>, <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> &lt;&gt; <span class="id" type="var">Some</span> <span class="id" type="var">s</span>}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="var">fix</span> 1.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">s</span>; [<span class="id" type="tactic">intro</span> <span class="id" type="var">x'</span>| <span class="id" type="tactic">intros</span> <span class="id" type="var">f'</span> <span class="id" type="var">l'</span>].<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">x</span> <span class="id" type="var">x'</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">eq_var_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">x'</span>).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">x_eq_x'</span>; <span class="id" type="var">left</span>; <span class="id" type="var">exists</span> <span class="id" type="var">nil</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">x_eq_x'</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">x_diff_x'</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">p</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">x_diff_x'</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">exact</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">n</span> <span class="id" type="var">p</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">discriminate</span>.<br/>

<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">p</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">n</span> <span class="id" type="var">p</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">discriminate</span>.<br/>

<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">eq_bool_ok</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) <span class="id" type="var">s</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">eq_bool</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) <span class="id" type="var">s</span>).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">t_eq_s</span>; <span class="id" type="var">left</span>; <span class="id" type="var">exists</span> <span class="id" type="var">nil</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">t_eq_s</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t_diff_s</span>;<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">IH</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">s</span>,  {<span class="id" type="var">p</span> : <span class="id" type="var">list</span> <span class="id" type="var">nat</span> | <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> <span class="id" type="var">s</span>} +<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{(<span class="id" type="keyword">forall</span> <span class="id" type="var">p</span> : <span class="id" type="var">list</span> <span class="id" type="var">nat</span>, <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> &lt;&gt; <span class="id" type="var">Some</span> <span class="id" type="var">s</span>)}).<br/>
<span class="id" type="tactic">clear</span> - <span class="id" type="var">subterm_at_pos_dec</span>.<br/>
<span class="id" type="var">revert</span> <span class="id" type="var">l</span>; <span class="id" type="var">fix</span> <span class="id" type="var">subterm_at_pos_dec_list</span> 1.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">l</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">Abs</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">Abs</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t1</span> <span class="id" type="var">l</span> <span class="id" type="var">t</span> <span class="id" type="var">t_in_t1l</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">eq_bool_ok</span> <span class="id" type="var">t</span> <span class="id" type="var">t1</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">eq_bool</span> <span class="id" type="var">t</span> <span class="id" type="var">t1</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t_eq_t1</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">t_eq_t1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">subterm_at_pos_dec</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t_diff_t1</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">subterm_at_pos_dec_list</span> <span class="id" type="var">l</span> <span class="id" type="var">t</span>).<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">t_in_t1l</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">t_in_t1l</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t_in_t1l</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">t1_eq_t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">t_diff_t1</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">t1_eq_t</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">t_in_l</span>; <span class="id" type="tactic">exact</span> <span class="id" type="var">t_in_l</span>.<br/>

<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">IH'</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">s</span>, {<span class="id" type="var">n</span> :nat &amp; {<span class="id" type="var">t</span> : <span class="id" type="var">term</span> &amp; {<span class="id" type="var">p</span> | (<span class="id" type="var">nth_error</span> <span class="id" type="var">l</span> <span class="id" type="var">n</span>) = <span class="id" type="var">Some</span> <span class="id" type="var">t</span> /\ <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> <span class="id" type="var">s</span>}}} + <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{(<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">p</span>, <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> &lt;&gt; <span class="id" type="var">Some</span> <span class="id" type="var">s</span>)}).<br/>
<span class="id" type="tactic">clear</span> -IH.<br/>
<span class="id" type="var">revert</span> <span class="id" type="var">l</span> <span class="id" type="var">IH</span>; <span class="id" type="var">fix</span> 1.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">l</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> <span class="id" type="var">s</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">Abs</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">Abs</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> <span class="id" type="var">IH</span> <span class="id" type="var">s</span>.<br/>
<span class="id" type="tactic">case</span> (<span class="id" type="var">IH</span> <span class="id" type="var">t</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) <span class="id" type="var">s</span>).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">s_in_t</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">s_in_t</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">p</span> <span class="id" type="var">Sub</span>; <span class="id" type="var">left</span>; <span class="id" type="var">exists</span> 0; <span class="id" type="var">exists</span> <span class="id" type="var">t</span>; <span class="id" type="var">exists</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">s_not_in_t</span>; <span class="id" type="tactic">case</span> (<span class="id" type="var">subterm_at_pos_dec</span> <span class="id" type="var">l</span> (<span class="id" type="var">tail_set</span> <span class="id" type="var">_</span> <span class="id" type="var">IH</span>) <span class="id" type="var">s</span>).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">s_in_l</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">s_in_l</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">n</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">tn</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">p</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">E</span> <span class="id" type="var">Sub</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">S</span> <span class="id" type="var">n</span>); <span class="id" type="var">exists</span> <span class="id" type="var">tn</span>; <span class="id" type="var">exists</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">s_not_in_l</span>; <span class="id" type="var">right</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t'</span> <span class="id" type="var">t'_in_tl</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">t'_in_tl</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">t'_in_tl</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">t_eq_t'</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">t_eq_t'</span>; <span class="id" type="tactic">exact</span> <span class="id" type="var">s_not_in_t</span>.<br/>
<span class="id" type="tactic">exact</span> (<span class="id" type="var">s_not_in_l</span> <span class="id" type="var">t'</span>).<br/>
<span class="id" type="tactic">case</span> (<span class="id" type="var">IH'</span> <span class="id" type="var">s</span>); <span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">case</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">n</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">p</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">E</span> <span class="id" type="var">Sub</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">n</span> :: <span class="id" type="var">p</span>); <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">E</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">p</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">t_eq_s</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">t_diff_s</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">t_eq_s</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">t_eq_s'</span>; <span class="id" type="tactic">exact</span> <span class="id" type="var">t_eq_s'</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">n</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">nth_error_ok_in</span> <span class="id" type="var">n</span> <span class="id" type="var">l</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">nth_error</span> <span class="id" type="var">l</span> <span class="id" type="var">n</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">tn</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">case</span> (<span class="id" type="var">H'</span> <span class="id" type="var">tn</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)); <span class="id" type="tactic">clear</span> <span class="id" type="var">H'</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">l1</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H'</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">l2</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H'</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">L</span> <span class="id" type="var">H'</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">H</span> <span class="id" type="var">tn</span>); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="keyword">Defined</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">subterm_at_pos_dec_alt</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span>, {<span class="id" type="var">p</span> : <span class="id" type="var">list</span> <span class="id" type="var">nat</span> | <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> <span class="id" type="var">s</span>}+ {~exists <span class="id" type="var">p</span>, <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> <span class="id" type="var">s</span>}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">case</span> (<span class="id" type="var">subterm_at_pos_dec</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span>).<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>;<span class="id" type="var">left</span>;<span class="id" type="tactic">exact</span> <span class="id" type="var">H</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">not_Sub</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">right</span>;<span class="id" type="tactic">intro</span> <span class="id" type="var">abs</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">case</span> <span class="id" type="var">abs</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">p</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">not_Sub</span> <span class="id" type="var">_</span> <span class="id" type="var">H</span>).<br/>
<span class="id" type="keyword">Defined</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">subterm_subterm</span> : <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span>, <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> <span class="id" type="var">s</span> -&gt; (<span class="id" type="var">t</span>=s) \/ (<span class="id" type="var">trans_clos</span> <span class="id" type="var">direct_subterm</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">generalize</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">p</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">p</span>]; <span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Sub</span>.<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v</span> | <span class="id" type="var">f</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">assert</span> (<span class="id" type="var">H</span> := <span class="id" type="var">nth_error_ok_in</span> <span class="id" type="var">i</span> <span class="id" type="var">l</span>); <br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">nth_error</span> <span class="id" type="var">l</span> <span class="id" type="var">i</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">ti</span> | ].<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">H</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">l1</span> [<span class="id" type="var">l2</span> [<span class="id" type="var">L</span> <span class="id" type="var">H'</span>]]].<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">IHp</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">Sub</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">ti_eq_s</span> | <span class="id" type="var">Subi</span>].<br/>
<span class="id" type="tactic">subst</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">t_step</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">trans_clos_is_trans</span> <span class="id" type="keyword">with</span> <span class="id" type="var">ti</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">subst</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">t_step</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">size_subterm_at_pos</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span> <span class="id" type="var">i</span> <span class="id" type="var">p</span>, <span class="id" type="keyword">match</span> <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">t</span> (<span class="id" type="var">i</span> :: <span class="id" type="var">p</span>) <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Some</span> <span class="id" type="var">u</span> =&gt; <span class="id" type="var">size</span> <span class="id" type="var">u</span> &lt; <span class="id" type="var">size</span> <span class="id" type="var">t</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">None</span> =&gt; <span class="id" type="var">True</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">i</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">generalize</span> <span class="id" type="var">t</span> <span class="id" type="var">i</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span> <span class="id" type="var">i</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">p</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">j</span> <span class="id" type="var">p</span>].<br/>
<span class="id" type="tactic">intros</span> [ <span class="id" type="var">v</span> | <span class="id" type="var">f</span> <span class="id" type="var">l</span> ] <span class="id" type="var">j</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="var">subterm_at_pos</span>; <span class="id" type="var">cbv</span> <span class="id" type="var">iota</span> <span class="id" type="var">beta</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">nth_error_ok_in</span> <span class="id" type="var">j</span> <span class="id" type="var">l</span>); <span class="id" type="tactic">destruct</span> (<span class="id" type="var">nth_error</span> <span class="id" type="var">l</span> <span class="id" type="var">j</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">tj</span> | ]; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">trivial</span>].<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">size_direct_subterm</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">H</span> <span class="id" type="var">tj</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">l1</span> [<span class="id" type="var">l2</span> [<span class="id" type="var">_</span> <span class="id" type="var">H'</span>]]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">simpl</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> [ <span class="id" type="var">v</span> | <span class="id" type="var">f</span> <span class="id" type="var">l</span> ] <span class="id" type="var">i</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="var">subterm_at_pos</span>; <span class="id" type="var">cbv</span> <span class="id" type="var">iota</span> <span class="id" type="var">beta</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">nth_error_ok_in</span> <span class="id" type="var">i</span> <span class="id" type="var">l</span>); <span class="id" type="tactic">destruct</span> (<span class="id" type="var">nth_error</span> <span class="id" type="var">l</span> <span class="id" type="var">i</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">ti</span> | ]; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">trivial</span>].<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">ti_in_l</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">IHp</span> <span class="id" type="var">ti</span> <span class="id" type="var">j</span>); <span class="id" type="tactic">simpl</span> <span class="id" type="var">subterm_at_pos</span>; <br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">ti</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">vi</span> | <span class="id" type="var">fi</span> <span class="id" type="var">li</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">nth_error_ok_in</span> <span class="id" type="var">j</span> <span class="id" type="var">li</span>); <span class="id" type="tactic">destruct</span> (<span class="id" type="var">nth_error</span> <span class="id" type="var">li</span> <span class="id" type="var">j</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">tij</span> | ]; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">trivial</span>].<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">tij_in_li</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">tij</span> <span class="id" type="var">p</span>) <span class="id" type="keyword">as</span> [ <span class="id" type="var">u</span> | ]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">lt_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">size</span> (<span class="id" type="var">Term</span> <span class="id" type="var">fi</span> <span class="id" type="var">li</span>)); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">size_direct_subterm</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">ti_in_l</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">l1</span> [<span class="id" type="var">l2</span> [<span class="id" type="var">_</span> <span class="id" type="var">H'</span>]]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">simpl</span>;<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">size_strict_subterm</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">trans_clos</span> <span class="id" type="var">direct_subterm</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">size</span> <span class="id" type="var">s</span> &lt; <span class="id" type="var">size</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">Sub</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">H</span> | <span class="id" type="var">s</span> <span class="id" type="var">u</span> <span class="id" type="var">t</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">size_direct_subterm</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">lt_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">size</span> <span class="id" type="var">u</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">size_direct_subterm</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">subterm_subterm_non_nil</span> : <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span>, <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> <span class="id" type="var">s</span> -&gt; <span class="id" type="var">p</span> &lt;&gt; <span class="id" type="var">nil</span> -&gt; (<span class="id" type="var">trans_clos</span> <span class="id" type="var">direct_subterm</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span> <span class="id" type="var">H</span> <span class="id" type="var">H0</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">subterm_subterm</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> <span class="id" type="var">H</span>).<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> 1;[|assumption].<br/>
&nbsp;&nbsp;<span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">p</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">elim</span> <span class="id" type="var">H0</span>;<span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> (<span class="id" type="var">size_subterm_at_pos</span> <span class="id" type="var">s</span> <span class="id" type="var">n</span> <span class="id" type="var">p</span>).<br/>
&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">h</span>;<span class="id" type="tactic">apply</span> <span class="id" type="var">False_ind</span>;<span class="id" type="tactic">apply</span> (<span class="id" type="var">lt_irrefl</span> <span class="id" type="var">_</span> <span class="id" type="var">h</span>).<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">var_in_subterm</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">v</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span>, <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> <span class="id" type="var">s</span> -&gt; <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>)  -&gt; <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">t</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">generalize</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">p</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">p</span>]; <span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">H</span> <span class="id" type="var">v_in_s</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">g</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H'</span> := <span class="id" type="var">nth_error_ok_in</span> <span class="id" type="var">i</span> <span class="id" type="var">l</span>).<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">nth_error</span> <span class="id" type="var">l</span> <span class="id" type="var">i</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">ti</span> | ].<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">H'</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">l1</span> [<span class="id" type="var">l2</span> [<span class="id" type="var">L</span> <span class="id" type="var">H''</span>]]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">l</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_list_unfold</span>.<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">H'</span> <span class="id" type="var">L</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">l1</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t1</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">IHp</span> <span class="id" type="var">s</span> <span class="id" type="var">ti</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>.<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">var_in_subterm2</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">v</span> <span class="id" type="var">t</span>, <span class="id" type="var">mem</span> (@<span class="id" type="var">eq</span> <span class="id" type="var">_</span>) <span class="id" type="var">v</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">t</span>) -&gt; {<span class="id" type="var">p</span> : <span class="id" type="var">list</span> <span class="id" type="var">nat</span> | <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>)}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">v_in_x</span>; <span class="id" type="var">exists</span> (@<span class="id" type="var">nil</span> <span class="id" type="var">nat</span>); <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">v_in_x</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v_eq_x</span> | <span class="id" type="var">v_in_nil</span>]; [<span class="id" type="tactic">subst</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span> | <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_list_unfold</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span>]; <span class="id" type="tactic">intros</span> <span class="id" type="var">IH</span> <span class="id" type="var">v_in_l</span>.<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_in_l</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">mem_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">t</span>)); <span class="id" type="tactic">case</span> (<span class="id" type="var">mem_bool</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">t</span>)); [<span class="id" type="tactic">intro</span> <span class="id" type="var">v_in_t</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v_not_in_t</span>].<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">IH</span> <span class="id" type="var">t</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) <span class="id" type="var">v_in_t</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">p</span> <span class="id" type="var">Sub</span>].<br/>
<span class="id" type="var">exists</span> (0 :: <span class="id" type="var">p</span>); <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">v_in_l'</span> : <span class="id" type="var">mem</span> (@<span class="id" type="var">eq</span> <span class="id" type="var">_</span>) <span class="id" type="var">v</span> (<span class="id" type="var">var_list_list</span> <span class="id" type="var">l</span>)).<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">mem_or_app</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_in_l</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">v_in_l</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v_in_t</span> | <span class="id" type="var">v_in_l</span>].<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">mem</span> (@<span class="id" type="var">eq</span> <span class="id" type="var">_</span>) <span class="id" type="var">v</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">t</span>)); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">IHl</span> (<span class="id" type="var">tail_set</span> <span class="id" type="var">_</span> <span class="id" type="var">IH</span>) <span class="id" type="var">v_in_l'</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">p</span> <span class="id" type="var">Sub</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">p</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">p</span>]; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Sub</span>.<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="var">exists</span> (<span class="id" type="var">S</span>(<span class="id" type="var">i</span>) :: <span class="id" type="var">p</span>); <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">symb_in_subterm</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span>, <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> <span class="id" type="var">s</span> -&gt; <span class="id" type="var">symb_in_term</span> <span class="id" type="var">f</span> <span class="id" type="var">s</span> = <span class="id" type="var">true</span> -&gt; <span class="id" type="var">symb_in_term</span> <span class="id" type="var">f</span> <span class="id" type="var">t</span> = <span class="id" type="var">true</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="var">fix</span> 4.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">exact</span> <span class="id" type="var">H'</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">n</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">Abs</span>; <span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">g</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">nth_error_ok_in</span> <span class="id" type="var">n</span> <span class="id" type="var">l</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">nth_error</span> <span class="id" type="var">l</span> <span class="id" type="var">n</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">tn</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">case</span> (<span class="id" type="var">H</span> <span class="id" type="var">tn</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">l1</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H'</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">l2</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H'</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">L</span> <span class="id" type="var">H'</span> <span class="id" type="var">Sub</span> <span class="id" type="var">f_in_s</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">symb_in_term_unfold</span>.<br/>
<span class="id" type="tactic">case</span> (<span class="id" type="var">eq_symb_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span>).<br/>
<span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">symb_in_term_list_app</span>.<br/>
<span class="id" type="tactic">case</span> (<span class="id" type="var">symb_in_term_list</span> <span class="id" type="var">f</span> <span class="id" type="var">l1</span>).<br/>
<span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">symb_in_subterm</span> <span class="id" type="var">f</span> <span class="id" type="var">s</span> <span class="id" type="var">tn</span> <span class="id" type="var">p</span> <span class="id" type="var">Sub</span> <span class="id" type="var">f_in_s</span>); <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> <span class="id" type="var">Abs</span>; <span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">symb_list_ok</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">f</span> (<span class="id" type="var">symb_list</span> <span class="id" type="var">t</span>) &lt;-&gt; <span class="id" type="var">symb_in_term</span> <span class="id" type="var">f</span> <span class="id" type="var">t</span> = <span class="id" type="var">true</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; [<span class="id" type="var">contradiction</span> <span class="id" type="var">H</span> | <span class="id" type="tactic">discriminate</span> <span class="id" type="var">H</span>].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">g</span> <span class="id" type="var">l</span> <span class="id" type="var">IH</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span>); <span class="id" type="tactic">destruct</span> (<span class="id" type="var">eq_symb_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">f_eq_g</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">f_diff_g</span>]; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">split</span>; [<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">sym_eq</span>; <span class="id" type="tactic">assumption</span>].<br/>
<span class="id" type="tactic">split</span>; [<span class="id" type="tactic">intros</span> [<span class="id" type="var">H</span> | <span class="id" type="var">H</span>] | <span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">f_diff_g</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">sym_eq</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="var">contradiction</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">in_app_or</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">f_in_t</span> | <span class="id" type="var">f_in_l</span>].<br/>
<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">IH</span> <span class="id" type="var">_</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>))) <span class="id" type="keyword">in</span> <span class="id" type="var">f_in_t</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">f_in_t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHl</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">symb_in_term</span> <span class="id" type="var">f</span> <span class="id" type="var">t</span>); <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IH</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="var">right</span>.<br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="tactic">discriminate</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="var">case_eq</span> (<span class="id" type="var">symb_in_term</span> <span class="id" type="var">f</span> <span class="id" type="var">t</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">f_in_t</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">f_not_in_t</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IH</span>; [<span class="id" type="tactic">assumption</span> | <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IH</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">f_not_in_t</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">symb_list_list_ok</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>, <span class="id" type="var">In</span> <span class="id" type="var">f</span> (<span class="id" type="var">symb_list_list</span> <span class="id" type="var">l</span>) &lt;-&gt; <span class="id" type="var">symb_in_term_list</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> = <span class="id" type="var">true</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span>]; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">in_app_or</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">Ht</span> | <span class="id" type="var">Hl</span>].<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">symb_list_ok</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Ht</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Ht</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Hl</span>; <span class="id" type="tactic">case</span> (<span class="id" type="var">symb_in_term</span> <span class="id" type="var">f</span> <span class="id" type="var">t</span>); <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="var">case_eq</span> (<span class="id" type="var">symb_in_term</span> <span class="id" type="var">f</span> <span class="id" type="var">t</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">f_in_t</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">f_not_in_t</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">symb_list_ok</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">f_not_in_t</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">is_a_pos_exists_subterm</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span>, <span class="id" type="var">is_a_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> = <span class="id" type="var">true</span> &lt;-&gt; <span class="id" type="var">exists</span> <span class="id" type="var">u</span>, <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> <span class="id" type="var">u</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span>; <span class="id" type="var">revert</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">p</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">q</span> ].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>; <span class="id" type="var">exists</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">x</span> | <span class="id" type="var">f</span> <span class="id" type="var">l</span> ]; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">intros</span> [<span class="id" type="var">u</span> <span class="id" type="var">Abs</span>]; <span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">nth_error</span> <span class="id" type="var">l</span> <span class="id" type="var">i</span>) <span class="id" type="keyword">as</span> [ <span class="id" type="var">ti</span> | ].<br/>
<span class="id" type="tactic">intro</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">IHq</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">intros</span> [<span class="id" type="var">u</span> <span class="id" type="var">Sub</span>]; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">nth_error</span> <span class="id" type="var">l</span> <span class="id" type="var">i</span>).<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHq</span>; <span class="id" type="var">exists</span> <span class="id" type="var">u</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">well_formed_subterm</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span>, <span class="id" type="var">well_formed</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> <span class="id" type="var">s</span> -&gt; <span class="id" type="var">well_formed</span> <span class="id" type="var">s</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="var">fix</span> 2; <span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">p</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">Wt</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">i</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">Wt</span> <span class="id" type="var">Sub</span>; <span class="id" type="var">case_eq</span> (<span class="id" type="var">nth_error</span> <span class="id" type="var">l</span> <span class="id" type="var">i</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">ti</span> <span class="id" type="var">F</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">F</span>]; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">F</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Sub</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">well_formed_subterm</span> <span class="id" type="var">ti</span> <span class="id" type="var">p</span>).<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">proj1</span> (<span class="id" type="var">well_formed_unfold</span> <span class="id" type="var">Wt</span>)).<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">nth_error_ok_in</span> <span class="id" type="var">i</span> <span class="id" type="var">l</span> <span class="id" type="var">F</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">l'</span> [<span class="id" type="var">l''</span> [<span class="id" type="var">_</span> <span class="id" type="var">H</span>]]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">replace_at_pos</span> (<span class="id" type="var">t</span> <span class="id" type="var">u</span> : <span class="id" type="var">term</span>) (<span class="id" type="var">p</span> : <span class="id" type="var">list</span> <span class="id" type="var">nat</span>) {<span class="id" type="keyword">struct</span> <span class="id" type="var">p</span>} : <span class="id" type="var">term</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">p</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">u</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">i</span> :: <span class="id" type="var">q</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">t</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">replace_at_pos_list</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">fix</span> <span class="id" type="var">replace_at_pos_list</span> <span class="id" type="var">j</span> (<span class="id" type="var">l</span> : <span class="id" type="var">list</span> <span class="id" type="var">term</span>) {<span class="id" type="keyword">struct</span> <span class="id" type="var">l</span>}: <span class="id" type="var">list</span> <span class="id" type="var">term</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">nil</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">h</span> :: <span class="id" type="var">tl</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">j</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">O</span> =&gt; (<span class="id" type="var">replace_at_pos</span> <span class="id" type="var">h</span> <span class="id" type="var">u</span> <span class="id" type="var">q</span>) :: <span class="id" type="var">tl</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">S</span> <span class="id" type="var">k</span> =&gt; <span class="id" type="var">h</span> :: (<span class="id" type="var">replace_at_pos_list</span> <span class="id" type="var">k</span> <span class="id" type="var">tl</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>) <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">replace_at_pos_list</span> <span class="id" type="var">i</span> <span class="id" type="var">l</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">replace_at_pos_list</span> (<span class="id" type="var">l</span> : <span class="id" type="var">list</span> <span class="id" type="var">term</span>) (<span class="id" type="var">u</span> : <span class="id" type="var">term</span>) (<span class="id" type="var">i</span> : <span class="id" type="var">nat</span>) (<span class="id" type="var">p</span> : <span class="id" type="var">list</span> <span class="id" type="var">nat</span>) <br/>
&nbsp;{<span class="id" type="keyword">struct</span> <span class="id" type="var">l</span>}: <span class="id" type="var">list</span> <span class="id" type="var">term</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">nil</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">h</span> :: <span class="id" type="var">tl</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">i</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">O</span> =&gt; (<span class="id" type="var">replace_at_pos</span> <span class="id" type="var">h</span> <span class="id" type="var">u</span> <span class="id" type="var">p</span>) :: <span class="id" type="var">tl</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">S</span> <span class="id" type="var">j</span> =&gt; <span class="id" type="var">h</span> :: (<span class="id" type="var">replace_at_pos_list</span> <span class="id" type="var">tl</span>  <span class="id" type="var">u</span> <span class="id" type="var">j</span> <span class="id" type="var">p</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">replace_at_pos_unfold</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">u</span> <span class="id" type="var">i</span> <span class="id" type="var">q</span>,<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">replace_at_pos</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) <span class="id" type="var">u</span> (<span class="id" type="var">i</span> :: <span class="id" type="var">q</span>) = <span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">replace_at_pos_list</span> <span class="id" type="var">l</span> <span class="id" type="var">u</span> <span class="id" type="var">i</span> <span class="id" type="var">q</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">u</span> <span class="id" type="var">i</span> <span class="id" type="var">q</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)); <br/>
<span class="id" type="tactic">generalize</span> <span class="id" type="var">u</span> <span class="id" type="var">i</span> <span class="id" type="var">q</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">u</span> <span class="id" type="var">i</span> <span class="id" type="var">q</span>; <br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [| <span class="id" type="var">t</span> <span class="id" type="var">l</span>]; <span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">i</span> <span class="id" type="var">q</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">i</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span> ]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">IHl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">replace_at_pos_is_replace_at_pos1</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span> <span class="id" type="var">u</span> <span class="id" type="var">p</span>, <span class="id" type="var">is_a_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> = <span class="id" type="var">true</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="var">subterm_at_pos</span> (<span class="id" type="var">replace_at_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">u</span> <span class="id" type="var">p</span>) <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> <span class="id" type="var">u</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">p</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">q</span> ]; <span class="id" type="tactic">trivial</span>;<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">IHl</span> <span class="id" type="var">u</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">p</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">q</span> ]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">replace_at_pos_unfold</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">generalize</span> <span class="id" type="var">i</span> <span class="id" type="var">q</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">i</span> <span class="id" type="var">q</span>; <br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span> ]; <span class="id" type="tactic">intros</span> <span class="id" type="var">i</span> <span class="id" type="var">q</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">i</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span> ]; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">i</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span> ]; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">IHl</span> <span class="id" type="var">t</span>); <span class="id" type="tactic">trivial</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHl0</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">replace_at_pos_is_replace_at_pos2</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> <span class="id" type="var">u</span>, <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> <span class="id" type="var">u</span> -&gt; <span class="id" type="var">replace_at_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">u</span> <span class="id" type="var">p</span> = <span class="id" type="var">t</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">p</span> <span class="id" type="var">u</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">p</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">q</span> ]; <span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">inversion_clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">IHl</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">p</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">q</span> ].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">inversion_clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">u</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">replace_at_pos_unfold</span>; <br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)); <span class="id" type="tactic">generalize</span> <span class="id" type="var">i</span> <span class="id" type="var">q</span> <span class="id" type="var">u</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">i</span> <span class="id" type="var">q</span> <span class="id" type="var">u</span> <span class="id" type="var">H</span>;<br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span> ]; <span class="id" type="tactic">intros</span> <span class="id" type="var">i</span> <span class="id" type="var">q</span> <span class="id" type="var">u</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">i</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span> ]; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">i</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span> ]; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHl0</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">subterm_at_pos_apply_subst_apply_subst_subterm_at_pos</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> <span class="id" type="var">sigma</span>, <br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Some</span> <span class="id" type="var">u</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">subterm_at_pos</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>) <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">u</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">None</span> =&gt; <span class="id" type="var">True</span><br/>
<span class="id" type="keyword">end</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">p</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">q</span> ]; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">IHl</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">p</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">q</span> ]; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H</span> : <span class="id" type="keyword">forall</span> (<span class="id" type="var">l</span> : <span class="id" type="var">list</span> <span class="id" type="var">term</span>) <span class="id" type="var">i</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">nth_error</span> <span class="id" type="var">l</span> <span class="id" type="var">i</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Some</span> <span class="id" type="var">li</span> =&gt; <span class="id" type="var">In</span> <span class="id" type="var">li</span> <span class="id" type="var">l</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">None</span> =&gt; <span class="id" type="var">True</span> <span class="id" type="keyword">end</span>).<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">IHl</span> <span class="id" type="var">l</span> <span class="id" type="var">i</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">l</span>;<br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span> ]; <span class="id" type="tactic">intro</span> <span class="id" type="var">i</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">i</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span> ]; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">IHl</span> <span class="id" type="var">i</span>); <span class="id" type="tactic">destruct</span> (<span class="id" type="var">nth_error</span> <span class="id" type="var">l</span> <span class="id" type="var">i</span>); <span class="id" type="tactic">trivial</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">generalize</span> <span class="id" type="var">i</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">i</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">l</span> <span class="id" type="var">ll</span> ]; <br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">i</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">i</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span> ]; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">sigma</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHll</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">replace_at_pos_list_replace_at_pos_in_subterm</span> :<br/>
<span class="id" type="keyword">forall</span> <span class="id" type="var">l1</span> <span class="id" type="var">ui</span> <span class="id" type="var">l2</span> <span class="id" type="var">u</span> <span class="id" type="var">i</span> <span class="id" type="var">p</span>, <span class="id" type="var">length</span> <span class="id" type="var">l1</span> = <span class="id" type="var">i</span> -&gt;<br/>
&nbsp;<span class="id" type="var">replace_at_pos_list</span> (<span class="id" type="var">l1</span> ++ <span class="id" type="var">ui</span> :: <span class="id" type="var">l2</span>) <span class="id" type="var">u</span> <span class="id" type="var">i</span> <span class="id" type="var">p</span> = <br/>
&nbsp;<span class="id" type="var">l1</span> ++ (<span class="id" type="var">replace_at_pos</span> <span class="id" type="var">ui</span> <span class="id" type="var">u</span> <span class="id" type="var">p</span>) :: <span class="id" type="var">l2</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">l1</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">l1</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">u1</span> <span class="id" type="var">l1</span> ]; <span class="id" type="tactic">intros</span> <span class="id" type="var">ui</span> <span class="id" type="var">l2</span> <span class="id" type="var">u</span> <span class="id" type="var">i</span> <span class="id" type="var">p</span> <span class="id" type="var">L</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">L</span>.<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">i</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">i</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span> ].<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHl1</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">inversion</span> <span class="id" type="var">L</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">well_formed_replace_at_pos</span> :<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">p</span> <span class="id" type="var">t</span> <span class="id" type="var">u</span>, <span class="id" type="var">well_formed</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">well_formed</span> <span class="id" type="var">u</span> -&gt; <span class="id" type="var">well_formed</span> (<span class="id" type="var">replace_at_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">u</span> <span class="id" type="var">p</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">p</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">p</span>]; <span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">u</span> <span class="id" type="var">Wt</span> <span class="id" type="var">Wu</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">x</span> | <span class="id" type="var">f</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">replace_at_pos_unfold</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">well_formed_unfold</span> <span class="id" type="var">Wt</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">Wl</span> <span class="id" type="var">L</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">Wt</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">well_formed_fold</span>; <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">L</span>; <span class="id" type="var">revert</span> <span class="id" type="var">i</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">i</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">i</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">i</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> [<span class="id" type="var">H</span> | <span class="id" type="var">H</span>].<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHp</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Wl</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Wl</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">i</span> <span class="id" type="var">v</span> [<span class="id" type="var">H</span> | <span class="id" type="var">H</span>].<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Wl</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span> <span class="id" type="keyword">with</span> <span class="id" type="var">i</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Wl</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">replace</span> (<span class="id" type="var">length</span> (<span class="id" type="var">replace_at_pos_list</span> <span class="id" type="var">l</span> <span class="id" type="var">u</span> <span class="id" type="var">i</span> <span class="id" type="var">p</span>)) <span class="id" type="keyword">with</span> (<span class="id" type="var">length</span> <span class="id" type="var">l</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">clear</span>; <span class="id" type="var">revert</span> <span class="id" type="var">i</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span>]; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> [ | <span class="id" type="var">n</span>]; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">IHl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">subst_replace_at_pos</span> : <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span> <span class="id" type="var">u</span> <span class="id" type="var">p</span> <span class="id" type="var">sigma</span>, <span class="id" type="var">is_a_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> = <span class="id" type="var">true</span> -&gt; <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">replace_at_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">u</span> <span class="id" type="var">p</span>) =<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">replace_at_pos</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>) (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">u</span>) <span class="id" type="var">p</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">u</span> <span class="id" type="var">p</span>; <span class="id" type="var">revert</span> <span class="id" type="var">t</span> <span class="id" type="var">u</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">p</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">p</span>]; <span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">u</span> <span class="id" type="var">sigma</span> <span class="id" type="var">Hpos</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x</span> | <span class="id" type="var">f</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">replace_at_pos_unfold</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="var">apply_subst</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">replace_at_pos_unfold</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="tactic">f_equal</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hpos</span>.<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">f</span>.<br/>
<span class="id" type="var">revert</span> <span class="id" type="var">i</span> <span class="id" type="var">u</span> <span class="id" type="var">sigma</span> <span class="id" type="var">Hpos</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span>]; <span class="id" type="tactic">intros</span> [ | <span class="id" type="var">n</span>] <span class="id" type="var">u</span> <span class="id" type="var">sigma</span> <span class="id" type="var">Hpos</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">t</span> =&gt; <span class="id" type="var">t</span> :: <span class="id" type="var">map</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">l</span>)).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHp</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="tactic">f_equal</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">subterm_in_instantiated_term</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">sigma</span>, <span class="id" type="var">subterm_at_pos</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>) <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> <span class="id" type="var">s</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Some</span> <span class="id" type="var">u'</span> =&gt; <span class="id" type="var">s</span> = <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">u'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">None</span> =&gt; <span class="id" type="var">exists</span> <span class="id" type="var">v</span>, <span class="id" type="var">exists</span> <span class="id" type="var">q</span>, <span class="id" type="var">exists</span> <span class="id" type="var">q'</span>, <span class="id" type="var">p</span> = <span class="id" type="var">q</span> ++ <span class="id" type="var">q'</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">t</span>)  /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">q</span> = <span class="id" type="var">Some</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">subterm_at_pos</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>)) <span class="id" type="var">q'</span> = <span class="id" type="var">Some</span> <span class="id" type="var">s</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">p</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">p</span>]; <span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">sigma</span> <span class="id" type="var">Sub</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v</span> | <span class="id" type="var">f</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="var">exists</span> <span class="id" type="var">v</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v_sigma</span> | ].<br/>
<span class="id" type="var">exists</span> (@<span class="id" type="var">nil</span> <span class="id" type="var">nat</span>); <span class="id" type="var">exists</span> (<span class="id" type="var">i</span> :: <span class="id" type="var">p</span>); <span class="id" type="tactic">repeat</span> <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Sub</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H</span> := <span class="id" type="var">nth_error_map</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">l</span> <span class="id" type="var">i</span>).<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">nth_error</span> (<span class="id" type="var">map</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">l</span>) <span class="id" type="var">i</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">ti_sigma</span> | ].<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H'</span> := <span class="id" type="var">nth_error_ok_in</span> <span class="id" type="var">i</span> <span class="id" type="var">l</span>).<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">nth_error</span> <span class="id" type="var">l</span> <span class="id" type="var">i</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">ti</span> | ].<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">H'</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">l1</span> [<span class="id" type="var">l2</span> [<span class="id" type="var">L</span> <span class="id" type="var">H'''</span>]]]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">subst</span>;<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">IHp</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">Sub</span>).<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">ti</span> <span class="id" type="var">p</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">u</span> | ]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> [<span class="id" type="var">v</span> [<span class="id" type="var">q</span> [<span class="id" type="var">q'</span> [<span class="id" type="var">p_eq_qq'</span> [<span class="id" type="var">v_in_ti</span> [<span class="id" type="var">Sub'</span> <span class="id" type="var">Sub''</span>]]]]]].<br/>
<span class="id" type="var">exists</span> <span class="id" type="var">v</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">length</span> <span class="id" type="var">l1</span> :: <span class="id" type="var">q</span>); <span class="id" type="var">exists</span> <span class="id" type="var">q'</span>; <span class="id" type="tactic">repeat</span> <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span>  <span class="id" type="var">var_in_subterm</span> <span class="id" type="keyword">with</span> <span class="id" type="var">ti</span> (<span class="id" type="var">length</span> <span class="id" type="var">l1</span> :: <span class="id" type="var">nil</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">nth_error_at_pos</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">nth_error_at_pos</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">subterm_in_subterm</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">p</span> <span class="id" type="var">q</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">u</span>, <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> <span class="id" type="var">s</span> -&gt; <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">s</span> <span class="id" type="var">q</span> = <span class="id" type="var">Some</span> <span class="id" type="var">u</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">t</span> (<span class="id" type="var">p</span> ++ <span class="id" type="var">q</span>) = <span class="id" type="var">Some</span> <span class="id" type="var">u</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">p</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">p</span>]; <span class="id" type="tactic">intros</span> <span class="id" type="var">q</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">u</span> <span class="id" type="var">Sub1</span> <span class="id" type="var">Sub2</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Sub1</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">Sub1</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">Sub1</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Sub1</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v</span> | <span class="id" type="var">f</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">nth_error</span> <span class="id" type="var">l</span> <span class="id" type="var">i</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">ti</span> | ].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHp</span> <span class="id" type="keyword">with</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">subterm_in_subterm2</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">p</span> <span class="id" type="var">q</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">t</span> (<span class="id" type="var">p</span> ++ <span class="id" type="var">q</span>) = <span class="id" type="var">Some</span> <span class="id" type="var">s</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> <span class="id" type="var">u</span>, <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> <span class="id" type="var">u</span> /\ <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">u</span> <span class="id" type="var">q</span> = <span class="id" type="var">Some</span> <span class="id" type="var">s</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">p</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">p</span>]; <span class="id" type="tactic">intros</span> <span class="id" type="var">q</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">Sub</span>.<br/>
<span class="id" type="var">exists</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Sub</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v</span> | <span class="id" type="var">f</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">nth_error_ok_in</span> <span class="id" type="var">i</span> <span class="id" type="var">l</span>); <span class="id" type="tactic">destruct</span> (<span class="id" type="var">nth_error</span> <span class="id" type="var">l</span> <span class="id" type="var">i</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">ti</span> | ].<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">H</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">l1</span> [<span class="id" type="var">l2</span> [<span class="id" type="var">L</span> <span class="id" type="var">H'</span>]]]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">IHp</span> <span class="id" type="var">q</span> <span class="id" type="var">s</span> <span class="id" type="var">ti</span> <span class="id" type="var">Sub</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">u</span> [<span class="id" type="var">Sub'</span> <span class="id" type="var">H''</span>]].<br/>
<span class="id" type="var">exists</span> <span class="id" type="var">u</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">nth_error_at_pos</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">subterm_subterm_alt</span> : <br/>
&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span>, <span class="id" type="var">refl_trans_clos</span> <span class="id" type="var">direct_subterm</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; {<span class="id" type="var">p</span> : <span class="id" type="var">list</span> <span class="id" type="var">nat</span> | <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> <span class="id" type="var">s</span>}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span>, <span class="id" type="var">refl_trans_clos</span> <span class="id" type="var">direct_subterm</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> -&gt; <span class="id" type="var">exists</span> <span class="id" type="var">p</span>, <span class="id" type="var">subterm_at_pos</span> <span class="id" type="var">t</span> <span class="id" type="var">p</span> = <span class="id" type="var">Some</span> <span class="id" type="var">s</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">u</span> | <span class="id" type="var">t'</span> <span class="id" type="var">s'</span> <span class="id" type="var">H'</span>].<br/>
<span class="id" type="tactic">subst</span>; <span class="id" type="var">exists</span> <span class="id" type="var">nil</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">s'</span> <span class="id" type="var">t'</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">H'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">H</span> | <span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">u</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span>].<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x</span> | <span class="id" type="var">f</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">in_split</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">l1</span> [<span class="id" type="var">l2</span> <span class="id" type="var">H'</span>]].<br/>
<span class="id" type="var">exists</span> (<span class="id" type="var">length</span> <span class="id" type="var">l1</span> :: <span class="id" type="var">nil</span>); <span class="id" type="tactic">subst</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">nth_error_at_pos</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">t</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x</span> | <span class="id" type="var">f</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H1</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">in_split</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H1</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">l1</span> [<span class="id" type="var">l2</span> <span class="id" type="var">H'</span>]].<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">IHH2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">p</span> <span class="id" type="var">Sub</span>]; <span class="id" type="var">exists</span> (<span class="id" type="var">p</span> ++ (<span class="id" type="var">length</span> <span class="id" type="var">l1</span>) :: <span class="id" type="var">nil</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">subterm_in_subterm</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">nth_error_at_pos</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">subterm_at_pos_dec</span> <span class="id" type="var">t</span> <span class="id" type="var">s</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">Sub</span> | <span class="id" type="var">not_Sub</span>].<br/>
<span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">H</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H'</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">p</span> <span class="id" type="var">Sub</span>]; <span class="id" type="tactic">apply</span> (<span class="id" type="var">not_Sub</span> <span class="id" type="var">p</span> <span class="id" type="var">Sub</span>).<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">var_in_replace_at_pos</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">s</span> <span class="id" type="var">p</span> <span class="id" type="var">u</span> <span class="id" type="var">x</span>, <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> (<span class="id" type="var">replace_at_pos</span> <span class="id" type="var">s</span> <span class="id" type="var">u</span> <span class="id" type="var">p</span>)) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">s</span>) \/ <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">u</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">p</span>; <span class="id" type="var">revert</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">p</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">p</span>].<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">u</span> <span class="id" type="var">x</span> <span class="id" type="var">x_in_u</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">u</span> <span class="id" type="var">x</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">s</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v</span> | <span class="id" type="var">f</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">replace_at_pos_unfold</span>; <span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_list_unfold</span>.<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">f</span>; <span class="id" type="var">revert</span> <span class="id" type="var">i</span> <span class="id" type="var">u</span> <span class="id" type="var">x</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span>]; <span class="id" type="tactic">intros</span> <span class="id" type="var">i</span> <span class="id" type="var">u</span> <span class="id" type="var">x</span>.<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="var">replace_at_pos_list</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">i</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span>].<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">in_app_or</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">H1</span> | <span class="id" type="var">H1</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">IHp</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H1</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">H2</span> | <span class="id" type="var">H2</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H1</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">in_app_or</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">H1</span> | <span class="id" type="var">H1</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">IHl</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H1</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">H2</span> | <span class="id" type="var">H2</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">H1</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">remove_garbage_subst</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">sigma</span> : <span class="id" type="var">substitution</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;{<span class="id" type="var">sigma'</span> : <span class="id" type="var">substitution</span> | (<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span>, <span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">sigma</span> = <span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">sigma'</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">val</span>, <span class="id" type="var">In</span> (<span class="id" type="var">x</span>,val) <span class="id" type="var">sigma'</span> -&gt; <span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">sigma'</span> = <span class="id" type="var">Some</span> <span class="id" type="var">val</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span> <span class="id" type="var">val</span> <span class="id" type="var">val'</span> (<span class="id" type="var">tau</span> <span class="id" type="var">tau'</span> <span class="id" type="var">tau''</span> : <span class="id" type="var">substitution</span>), <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">sigma'</span> = <span class="id" type="var">tau</span> ++ (<span class="id" type="var">x</span>,val) :: <span class="id" type="var">tau'</span> ++ (<span class="id" type="var">y</span>,val') :: <span class="id" type="var">tau''</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">x</span> &lt;&gt; <span class="id" type="var">y</span>)}.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="var">fix</span> 1.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">sigma</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">sigma</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">sigma</span>.<br/>
<span class="id" type="var">exists</span> <span class="id" type="var">nil</span>; <span class="id" type="tactic">repeat</span> <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">val</span> <span class="id" type="var">Abs</span>; <span class="id" type="tactic">elim</span> <span class="id" type="var">Abs</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span> <span class="id" type="var">val</span> <span class="id" type="var">val'</span> <span class="id" type="var">tau</span> <span class="id" type="var">tau'</span> <span class="id" type="var">tau''</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">tau</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">tau</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">Abs</span>; <span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">p</span> <span class="id" type="var">tau</span> <span class="id" type="var">Abs</span>; <span class="id" type="tactic">discriminate</span>.<br/>

<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">p</span> <span class="id" type="var">sigma</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">val</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">remove_garbage_subst</span> <span class="id" type="var">sigma</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">sigma'</span> [<span class="id" type="var">H1</span> [<span class="id" type="var">H2</span> <span class="id" type="var">H3</span>]]].<br/>
<span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">sigma'</span>).<br/>

<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">val'</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">find_mem</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">x'</span> [<span class="id" type="var">sigma1</span> [<span class="id" type="var">sigma2</span> [<span class="id" type="var">H'</span> <span class="id" type="var">H''</span>]]]].<br/>
<span class="id" type="var">exists</span> ((<span class="id" type="var">x</span>,val) :: <span class="id" type="var">sigma1</span> ++ <span class="id" type="var">sigma2</span>); <span class="id" type="tactic">subst</span> <span class="id" type="var">x'</span>; <span class="id" type="tactic">repeat</span> <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">y</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="var">case_eq</span> (<span class="id" type="var">eq_var_bool</span> <span class="id" type="var">y</span> <span class="id" type="var">x</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">y_eq_x</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">x_diff_y</span>]; [<span class="id" type="tactic">trivial</span> | <span class="id" type="var">idtac</span>].<br/>
<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">H1</span> <span class="id" type="var">y</span>); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H''</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">sigma'</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span> <span class="id" type="var">H3</span> <span class="id" type="var">H</span> <span class="id" type="var">H''</span>;<br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">sigma1</span> <span class="id" type="keyword">as</span> [ | [<span class="id" type="var">x1</span> <span class="id" type="var">val1</span>] <span class="id" type="var">sigma1</span>]; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">x_diff_y</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="var">case_eq</span> (<span class="id" type="var">eq_var_bool</span> <span class="id" type="var">y</span> <span class="id" type="var">x1</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">y_eq_x1</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">y_diff_x1</span>]; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">apply</span> <span class="id" type="var">IHsigma1</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">y</span> <span class="id" type="var">val''</span> [<span class="id" type="var">H4</span> | <span class="id" type="var">H4</span>].<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">H4</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H4</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">eq_var_bool_refl</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="var">case_eq</span> (<span class="id" type="var">eq_var_bool</span> <span class="id" type="var">y</span> <span class="id" type="var">x</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">y_eq_x</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">y_diff_x</span>].<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">in_app_or</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H4</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">H5</span> | <span class="id" type="var">H5</span>];<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">In_split</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H5</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">tau1</span> [<span class="id" type="var">tau2</span> <span class="id" type="var">H6</span>]]; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">y</span> = <span class="id" type="var">x</span>).<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">H3</span> <span class="id" type="var">y</span> <span class="id" type="var">x</span> <span class="id" type="var">val''</span> <span class="id" type="var">val'</span> <span class="id" type="var">tau1</span> <span class="id" type="var">tau2</span> <span class="id" type="var">sigma2</span>); <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">ass_app</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">y</span> <span class="id" type="var">x</span>); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">y_eq_x</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">y_eq_x'</span>; <span class="id" type="tactic">exact</span> <span class="id" type="var">y_eq_x'</span>.<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">x</span> = <span class="id" type="var">y</span>).<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">H3</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span> <span class="id" type="var">val'</span> <span class="id" type="var">val''</span> <span class="id" type="var">sigma1</span> <span class="id" type="var">tau1</span> <span class="id" type="var">tau2</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">y</span> <span class="id" type="var">x</span>); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">y_eq_x</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">y_eq_x'</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">y_eq_x'</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- (<span class="id" type="var">H2</span> <span class="id" type="var">y</span> <span class="id" type="var">val''</span>); <span class="id" type="tactic">subst</span> <span class="id" type="var">sigma'</span>.<br/>
<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">find_diff</span> (@<span class="id" type="var">eq</span> <span class="id" type="var">variable</span>)).<br/>
<span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">exact</span> <span class="id" type="var">X.eq_bool_ok</span>.<br/>
<span class="id" type="tactic">exact</span> <span class="id" type="var">y_diff_x</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">in_insert</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">sigma</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">x1</span> <span class="id" type="var">y</span> <span class="id" type="var">val1</span> <span class="id" type="var">valy</span> [ | [<span class="id" type="var">z</span> <span class="id" type="var">zval</span>] <span class="id" type="var">tau</span>] <span class="id" type="var">tau'</span> <span class="id" type="var">tau''</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H'''</span>;<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H'''</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">H'''</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H'''</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">yvaly_in_sigma12</span> : <span class="id" type="var">In</span> (<span class="id" type="var">y</span>,valy) (<span class="id" type="var">sigma1</span> ++ <span class="id" type="var">sigma2</span>)).<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">in_app_or</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">yvaly_in_sigma12</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">yvaly_in_sigma1</span> | <span class="id" type="var">yvaly_in_sigma2</span>].<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">In_split</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">yvaly_in_sigma1</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">tau1</span> [<span class="id" type="var">tau2</span> <span class="id" type="var">H'</span>]].<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">x1_eq_y</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">H3</span> <span class="id" type="var">y</span> <span class="id" type="var">x1</span> <span class="id" type="var">valy</span> <span class="id" type="var">val'</span> <span class="id" type="var">tau1</span> <span class="id" type="var">tau2</span> <span class="id" type="var">sigma2</span>); <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">ass_app</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">In_split</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">yvaly_in_sigma2</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">tau1</span> [<span class="id" type="var">tau2</span> <span class="id" type="var">H'</span>]].<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">H3</span> <span class="id" type="var">x1</span> <span class="id" type="var">y</span> <span class="id" type="var">val'</span> <span class="id" type="var">valy</span> <span class="id" type="var">sigma1</span> <span class="id" type="var">tau1</span> <span class="id" type="var">tau2</span>); <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">insert_2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> (<span class="id" type="var">z</span>,val') <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H0</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">tau1</span> [<span class="id" type="var">tau2</span> [<span class="id" type="var">tau3</span> <span class="id" type="var">H4</span>]]].<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">H3</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H4</span>).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">H4</span>; <span class="id" type="var">exists</span> ((<span class="id" type="var">x</span>,val) :: <span class="id" type="var">sigma'</span>); <span class="id" type="tactic">repeat</span> <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">y</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="var">case_eq</span> (<span class="id" type="var">eq_var_bool</span> <span class="id" type="var">y</span> <span class="id" type="var">x</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">y_eq_x</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">y_diff_x</span>]; [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">apply</span> <span class="id" type="var">H1</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">y</span> <span class="id" type="var">valy</span>  [<span class="id" type="var">H</span> | <span class="id" type="var">H</span>].<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">eq_var_bool_refl</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="var">case_eq</span> (<span class="id" type="var">eq_var_bool</span> <span class="id" type="var">y</span> <span class="id" type="var">x</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">y_eq_x</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">y_diff_x</span>].<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">In</span> (<span class="id" type="var">y</span>,valy) <span class="id" type="var">sigma'</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">find_not_found</span> <span class="id" type="keyword">with</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">x</span>.<br/>
<span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span>) (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">y</span> <span class="id" type="var">x</span>); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">y_eq_x</span>.<br/>
<span class="id" type="tactic">case</span> (<span class="id" type="var">eq_var_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">x_diff_y</span> <span class="id" type="var">y_eq_x'</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">x_diff_y</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">y_eq_x'</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">y</span> <span class="id" type="var">z</span> <span class="id" type="var">valy</span> <span class="id" type="var">valz</span> [ | [<span class="id" type="var">u</span> <span class="id" type="var">valu</span>] <span class="id" type="var">tau</span>] <span class="id" type="var">tau'</span> <span class="id" type="var">tau''</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">y_eq_z</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">y</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">find_not_found</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">_</span> <span class="id" type="var">z</span> <span class="id" type="var">valz</span> <span class="id" type="var">_</span> <span class="id" type="var">H4</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">eq_var_bool_refl</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">H3</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)).<br/>
<span class="id" type="keyword">Defined</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">subst_eq_vars</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">t</span> <span class="id" type="var">sigma</span> <span class="id" type="var">sigma'</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">v</span>, <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">t</span>) -&gt; <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>) = <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma'</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>)) <br/>
&nbsp;&nbsp;&nbsp;&lt;-&gt; <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span> = <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma'</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">sigma</span> <span class="id" type="var">sigma'</span>; <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">IHl</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">map_eq</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">t_in_l</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">In_split</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">t_in_l</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">l1</span> [<span class="id" type="var">l2</span> <span class="id" type="var">H'</span>]]; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">var_in_subterm</span> <span class="id" type="keyword">with</span> <span class="id" type="var">t</span> (<span class="id" type="var">length</span> <span class="id" type="var">l1</span> :: <span class="id" type="var">nil</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">nth_error_at_pos</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">pattern</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> [<span class="id" type="var">x_eq_v</span> | <span class="id" type="var">F</span>]; [<span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span> | <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">IHl</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_l</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_list_unfold</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_in_l</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">t</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">H</span> <span class="id" type="var">H'</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_in_l</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">in_app_or</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>  <span class="id" type="var">v_in_l</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v_in_t</span> | <span class="id" type="var">v_in_l'</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span> <span class="id" type="keyword">with</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHl0</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">s</span> <span class="id" type="var">s_in_l</span> <span class="id" type="var">H''</span> <span class="id" type="var">x</span> <span class="id" type="var">x_in_s</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">IHl</span> <span class="id" type="var">s</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">subst_rest</span> <span class="id" type="var">vars</span> <span class="id" type="var">sigma</span> : <span class="id" type="var">substitution</span> :=<br/>
<span class="id" type="keyword">match</span> <span class="id" type="var">sigma</span> <span class="id" type="keyword">with</span><br/>
| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">nil</span><br/>
| (<span class="id" type="var">x</span>,u) :: <span class="id" type="var">sigma</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">if</span> <span class="id" type="var">mem_bool</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">vars</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">then</span> (<span class="id" type="var">x</span>,u) :: (<span class="id" type="var">subst_rest</span> <span class="id" type="var">vars</span> <span class="id" type="var">sigma</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">else</span> <span class="id" type="var">subst_rest</span> <span class="id" type="var">vars</span> <span class="id" type="var">sigma</span><br/>
<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">subst_rest_ok</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">vars</span> <span class="id" type="var">sigma</span> <span class="id" type="var">v</span>, <span class="id" type="var">In</span> <span class="id" type="var">v</span> <span class="id" type="var">vars</span> -&gt; <span class="id" type="var">apply_subst</span> (<span class="id" type="var">subst_rest</span> <span class="id" type="var">vars</span> <span class="id" type="var">sigma</span>) (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>) = <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="var">fix</span> 2.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">vars</span> <span class="id" type="var">sigma</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">sigma</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">sigma</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">p</span> <span class="id" type="var">sigma</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">p</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">z</span> <span class="id" type="var">t</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_vars</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">mem_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">z</span> <span class="id" type="var">vars</span>);<br/>
<span class="id" type="tactic">case</span> (<span class="id" type="var">mem_bool</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">z</span> <span class="id" type="var">vars</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">z_in_vars</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">z_not_in_vars</span>].<br/>
<span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">z</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v_eq_z</span> | <span class="id" type="var">v_diff_z</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">subst_rest_ok</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v</span> <span class="id" type="var">z</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">z</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">v_eq_z</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v_diff_z</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">z_not_in_vars</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_impl_mem</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">subst_rest_ok</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">subst_rest_rest</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">vars</span> <span class="id" type="var">sigma</span> <span class="id" type="var">v</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> (<span class="id" type="var">v</span>,t) (<span class="id" type="var">subst_rest</span> <span class="id" type="var">vars</span> <span class="id" type="var">sigma</span>) -&gt; <span class="id" type="var">In</span> <span class="id" type="var">v</span> <span class="id" type="var">vars</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="var">fix</span> 2.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">vars</span> <span class="id" type="var">sigma</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">sigma</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">sigma</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">t</span>; <span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">p</span> <span class="id" type="var">sigma</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">p</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">z</span> <span class="id" type="var">t</span> <span class="id" type="var">v</span> <span class="id" type="var">u</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">mem_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">z</span> <span class="id" type="var">vars</span>);<br/>
<span class="id" type="tactic">case</span> (<span class="id" type="var">mem_bool</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">z</span> <span class="id" type="var">vars</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">z_in_vars</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">z_not_in_vars</span>].<br/>
<span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">intros</span> [<span class="id" type="var">zt_eq_vu</span> | <span class="id" type="var">vu_in_rest</span>].<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">zt_eq_vu</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">mem_impl_in</span> <span class="id" type="keyword">with</span> (@<span class="id" type="var">eq</span> <span class="id" type="var">_</span>).<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">subst_rest_rest</span> <span class="id" type="var">vars</span> <span class="id" type="var">sigma</span> <span class="id" type="var">v</span> <span class="id" type="var">u</span> <span class="id" type="var">vu_in_rest</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">subst_rest_rest</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">subst_rest_subst</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">vars</span> <span class="id" type="var">sigma</span> <span class="id" type="var">v</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> (<span class="id" type="var">v</span>,t) (<span class="id" type="var">subst_rest</span> <span class="id" type="var">vars</span> <span class="id" type="var">sigma</span>) -&gt; <span class="id" type="var">In</span> (<span class="id" type="var">v</span>,t) <span class="id" type="var">sigma</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="var">fix</span> 2.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">vars</span> <span class="id" type="var">sigma</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">sigma</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">sigma</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">t</span>; <span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">p</span> <span class="id" type="var">sigma</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">p</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">z</span> <span class="id" type="var">t</span> <span class="id" type="var">v</span> <span class="id" type="var">u</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">mem_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">z</span> <span class="id" type="var">vars</span>);<br/>
<span class="id" type="tactic">case</span> (<span class="id" type="var">mem_bool</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">z</span> <span class="id" type="var">vars</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">z_in_vars</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">z_not_in_vars</span>].<br/>
<span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">intros</span> [<span class="id" type="var">zt_eq_vu</span> | <span class="id" type="var">vu_in_rest</span>].<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">subst_rest_subst</span> <span class="id" type="var">vars</span>); <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">vu_in_rest</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">subst_rest_subst</span> <span class="id" type="var">vars</span>); <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">subst_rest_subst_rest</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">vars</span> <span class="id" type="var">sigma</span> <span class="id" type="var">v</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">v</span> <span class="id" type="var">vars</span> -&gt; <span class="id" type="var">In</span> (<span class="id" type="var">v</span>,t) <span class="id" type="var">sigma</span> -&gt; <span class="id" type="var">In</span> (<span class="id" type="var">v</span>,t) (<span class="id" type="var">subst_rest</span> <span class="id" type="var">vars</span> <span class="id" type="var">sigma</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="var">fix</span> 2; <span class="id" type="tactic">intros</span> <span class="id" type="var">vars</span> <span class="id" type="var">sigma</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">sigma</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">sigma</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">p</span> <span class="id" type="var">sigma</span>; <span class="id" type="tactic">case</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">p</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">u</span> <span class="id" type="var">v</span> <span class="id" type="var">t</span> <span class="id" type="var">x_in_vars</span>.<br/>
<span class="id" type="tactic">intros</span> [<span class="id" type="var">xu_eq_vt</span> | <span class="id" type="var">vt_in_sigma</span>].<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">xu_eq_vt</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">xu_eq_vt</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">v</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">mem_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">x</span> <span class="id" type="var">vars</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">mem_bool</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">vars</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">x_not_in_vars</span>].<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">x_not_in_vars</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_impl_mem</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">case</span> (<span class="id" type="var">mem_bool</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">x</span> <span class="id" type="var">vars</span>).<br/>
<span class="id" type="var">right</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">subst_rest_subst_rest</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">subst_rest_subst_rest</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">extend_with_id</span> <span class="id" type="var">vars</span> <span class="id" type="var">sigma</span> :=<br/>
&nbsp;&nbsp;(<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">x</span> =&gt; (<span class="id" type="var">x</span>,Var <span class="id" type="var">x</span>)) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">filter</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">x</span> =&gt;  <span class="id" type="var">negb</span> (<span class="id" type="var">mem_bool</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">x</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">sigma</span>))) <span class="id" type="var">vars</span>))<br/>
&nbsp;&nbsp;++ <span class="id" type="var">sigma</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">subst_trivial_ext</span> :<br/>
<span class="id" type="keyword">forall</span> <span class="id" type="var">vars</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>, <span class="id" type="var">apply_subst</span> (<span class="id" type="var">extend_with_id</span> <span class="id" type="var">vars</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">t</span> = <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">extend_with_id</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">vars</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">subst_eq_vars</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">find_app</span>.<br/>
<span class="id" type="var">case_eq</span> (<span class="id" type="var">mem_bool</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> : <span class="id" type="var">variable</span> * <span class="id" type="var">term</span> =&gt; <span class="id" type="var">fst</span> <span class="id" type="var">st</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">x</span> : <span class="id" type="var">variable</span> =&gt; (<span class="id" type="var">x</span>, <span class="id" type="var">Var</span> <span class="id" type="var">x</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">filter</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">fun</span> <span class="id" type="var">x</span> : <span class="id" type="var">variable</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">negb</span> (<span class="id" type="var">mem_bool</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">x</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">sigma</span>))) <span class="id" type="var">vars</span>))));<br/>
&nbsp;&nbsp;[<span class="id" type="tactic">intro</span> <span class="id" type="var">v_in</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>].<br/>
<span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">x</span> : <span class="id" type="var">variable</span> =&gt; (<span class="id" type="var">x</span>, <span class="id" type="var">Var</span> <span class="id" type="var">x</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">filter</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">fun</span> <span class="id" type="var">x</span> : <span class="id" type="var">variable</span> =&gt; <span class="id" type="var">negb</span> (<span class="id" type="var">mem_bool</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">x</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">sigma</span>))) <span class="id" type="var">vars</span>)));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="id" type="tactic">intros</span> <span class="id" type="var">x'</span> <span class="id" type="var">F</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">F</span>].<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find_mem</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">F</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v'</span> [<span class="id" type="var">l1</span> [<span class="id" type="var">l2</span> [<span class="id" type="var">v_eq_v'</span> <span class="id" type="var">H</span>]]]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">v'</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">v_in'</span> : <span class="id" type="var">In</span> (<span class="id" type="var">v</span>,x') (<span class="id" type="var">l1</span> ++ (<span class="id" type="var">v</span>,x') :: <span class="id" type="var">l2</span>)).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_in'</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_in'</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">v_in'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v'</span> [<span class="id" type="var">v_eq_v'</span> <span class="id" type="var">v_in'</span>]]; <span class="id" type="tactic">injection</span> <span class="id" type="var">v_eq_v'</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">v_eq_v'</span>; <span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">v'</span> <span class="id" type="var">x'</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">filter_In</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_in'</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">v_in'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">_</span> <span class="id" type="var">v_in'</span>].<br/>
<span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">v_val</span> <span class="id" type="var">v_sigma</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_equal</span>].<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find_mem</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">v_sigma</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v'</span> [<span class="id" type="var">sig1</span> [<span class="id" type="var">sig2</span> [<span class="id" type="var">v_eq_v'</span> <span class="id" type="var">H'</span>]]]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">v'</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H'</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_in'</span>; <span class="id" type="tactic">clear</span> - <span class="id" type="var">v_in'</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">sig1</span> <span class="id" type="keyword">as</span> [ | [<span class="id" type="var">u</span> <span class="id" type="var">u'</span>] <span class="id" type="var">sig1</span>]; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_in'</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">eq_var_bool_refl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_in'</span>; <span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">u</span>); [<span class="id" type="tactic">discriminate</span> | <span class="id" type="tactic">apply</span> <span class="id" type="var">IHsig1</span> ; <span class="id" type="tactic">assumption</span>].<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">v_mem</span> := <span class="id" type="var">mem_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v</span><br/>
(<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> : <span class="id" type="var">variable</span> * <span class="id" type="var">term</span> =&gt; <span class="id" type="var">fst</span> <span class="id" type="var">st</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">x</span> : <span class="id" type="var">variable</span> =&gt; (<span class="id" type="var">x</span>, <span class="id" type="var">Var</span> <span class="id" type="var">x</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">filter</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">fun</span> <span class="id" type="var">x</span> : <span class="id" type="var">variable</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">negb</span> (<span class="id" type="var">mem_bool</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">x</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">sigma</span>))) <span class="id" type="var">vars</span>)))); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">v_in</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_mem</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">v_in''</span> := <span class="id" type="var">mem_impl_in</span> (@<span class="id" type="var">eq</span> <span class="id" type="var">variable</span>) (<span class="id" type="keyword">fun</span> <span class="id" type="var">a</span> <span class="id" type="var">b</span> <span class="id" type="var">P</span> =&gt; <span class="id" type="var">P</span>) <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">v_mem</span>).<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_in''</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">v_in''</span> <span class="id" type="keyword">as</span> [[<span class="id" type="var">v'</span> <span class="id" type="var">u</span>] [<span class="id" type="var">v_eq_v'</span> <span class="id" type="var">v_in3</span>]]; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_eq_v'</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">v'</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">refine</span> (<span class="id" type="var">find_not_found</span>  <span class="id" type="var">X.eq_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">v</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">F</span> (<span class="id" type="var">eq_var_bool_refl</span> <span class="id" type="var">v</span>) <span class="id" type="var">v_in3</span>).<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">o_list_size</span> <span class="id" type="var">pb1</span> <span class="id" type="var">pb2</span> := <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">list_size</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">size</span> (<span class="id" type="var">fst</span> (<span class="id" type="var">B</span>:=term) <span class="id" type="var">st</span>)) <span class="id" type="var">pb1</span> &lt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">list_size</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> =&gt; <span class="id" type="var">size</span> (<span class="id" type="var">fst</span> (<span class="id" type="var">B</span>:=term) <span class="id" type="var">st</span>)) <span class="id" type="var">pb2</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">wf_size</span> : <span class="id" type="var">well_founded</span> <span class="id" type="var">o_list_size</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">well_founded</span>, <span class="id" type="var">o_list_size</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">pb</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">list_size</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> : <span class="id" type="var">term</span> * <span class="id" type="var">term</span> =&gt; <span class="id" type="var">size</span> (<span class="id" type="var">fst</span> <span class="id" type="var">st</span>)) <span class="id" type="var">pb</span>); <span class="id" type="tactic">clear</span> <span class="id" type="var">pb</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">n</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">n</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">n</span>].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">y</span> <span class="id" type="var">Abs</span>; <span class="id" type="var">absurd</span> (<span class="id" type="var">list_size</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> : <span class="id" type="var">term</span> * <span class="id" type="var">term</span> =&gt; <span class="id" type="var">size</span> (<span class="id" type="var">fst</span> <span class="id" type="var">st</span>)) <span class="id" type="var">y</span> &lt; 0); <span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">y</span> <span class="id" type="var">Sy</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">Sy</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Acc_intro</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">x</span> <span class="id" type="var">Sx</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHn</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">IHn</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Defined</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">matching_call1</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">patt</span> <span class="id" type="var">subj</span> <span class="id" type="var">pb</span>, <span class="id" type="var">o_list_size</span> <span class="id" type="var">pb</span> ((<span class="id" type="var">patt</span>, <span class="id" type="var">subj</span>) :: <span class="id" type="var">pb</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">patt</span> <span class="id" type="var">sibj</span> <span class="id" type="var">pb</span>;<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">o_list_size</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">pattern</span> (<span class="id" type="var">list_size</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> : <span class="id" type="var">term</span> * <span class="id" type="var">term</span> =&gt; <span class="id" type="var">size</span> (<span class="id" type="var">fst</span> <span class="id" type="var">st</span>)) <span class="id" type="var">pb</span>); <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">plus_O_n</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">plus_lt_compat_r</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">lt</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">size_ge_one</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">matching_call2</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">pat</span> <span class="id" type="var">sub</span> <span class="id" type="var">f</span> <span class="id" type="var">lpat</span> <span class="id" type="var">g</span> <span class="id" type="var">lsub</span> <span class="id" type="var">pb</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">o_list_size</span> ((<span class="id" type="var">pat</span>,sub) :: <span class="id" type="var">nil</span>) ((<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">pat</span> :: <span class="id" type="var">lpat</span>), <span class="id" type="var">Term</span> <span class="id" type="var">g</span> (<span class="id" type="var">sub</span> :: <span class="id" type="var">lsub</span>)) :: <span class="id" type="var">pb</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">pat</span> <span class="id" type="var">sub</span> <span class="id" type="var">f</span> <span class="id" type="var">lpat</span> <span class="id" type="var">g</span> <span class="id" type="var">lsub</span> <span class="id" type="var">pb</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">o_list_size</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">arith</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">matching_call3</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">pat</span> <span class="id" type="var">sub</span> <span class="id" type="var">f</span> <span class="id" type="var">lpat</span> <span class="id" type="var">g</span> <span class="id" type="var">lsub</span> <span class="id" type="var">pb</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">o_list_size</span> ((<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">lpat</span>, <span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">lsub</span>):: <span class="id" type="var">pb</span>) ((<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">pat</span> :: <span class="id" type="var">lpat</span>), <span class="id" type="var">Term</span> <span class="id" type="var">g</span> (<span class="id" type="var">sub</span> :: <span class="id" type="var">lsub</span>)) :: <span class="id" type="var">pb</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">pat</span> <span class="id" type="var">sub</span> <span class="id" type="var">f</span> <span class="id" type="var">lpat</span> <span class="id" type="var">g</span> <span class="id" type="var">lsub</span> <span class="id" type="var">pb</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">o_list_size</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">lt_n_S</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">plus_assoc</span>.<br/>
&nbsp;<span class="id" type="tactic">pattern</span> ((<span class="id" type="var">fix</span> <span class="id" type="var">size_list</span> (<span class="id" type="var">l</span> : <span class="id" type="var">list</span> <span class="id" type="var">term</span>) : <span class="id" type="var">nat</span> :=<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; 0<br/>
&nbsp;&nbsp;&nbsp;| <span class="id" type="var">t</span> :: <span class="id" type="var">lt</span> =&gt; <span class="id" type="var">size</span> <span class="id" type="var">t</span> + <span class="id" type="var">size_list</span> <span class="id" type="var">lt</span><br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>) <span class="id" type="var">lpat</span> + <span class="id" type="var">list_size</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> : <span class="id" type="var">term</span> * <span class="id" type="var">term</span> =&gt; <span class="id" type="var">size</span> (<span class="id" type="var">fst</span> <span class="id" type="var">st</span>)) <span class="id" type="var">pb</span>);<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">plus_O_n</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">plus_lt_compat_r</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">lt</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">size_ge_one</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab62"></a><h3 class="section">Definition of a step of matching.</h3>

</div>
<div class="code">
<span class="id" type="keyword">Definition</span> <span class="id" type="var">F_matching</span>:<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">pb</span> (<span class="id" type="var">mrec</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">p</span>, <span class="id" type="var">o_list_size</span> <span class="id" type="var">p</span> <span class="id" type="var">pb</span> -&gt; <span class="id" type="var">option</span> <span class="id" type="var">substitution</span>),<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">option</span> <span class="id" type="var">substitution</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> [ | [<span class="id" type="var">patt</span> <span class="id" type="var">subj</span>] <span class="id" type="var">pb</span>] <span class="id" type="var">mrec</span>.<br/>
<span class="id" type="tactic">exact</span> (<span class="id" type="var">Some</span> <span class="id" type="var">nil</span>).<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Size</span> := <span class="id" type="var">matching_call1</span> <span class="id" type="var">patt</span> <span class="id" type="var">subj</span> <span class="id" type="var">pb</span>).<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">patt</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x</span> | <span class="id" type="var">f</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="tactic">set</span> (<span class="id" type="var">o_subst</span> := <span class="id" type="var">mrec</span> <span class="id" type="var">_</span> <span class="id" type="var">Size</span>).<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">o_subst</span> <span class="id" type="keyword">as</span> [<span class="id" type="tactic">subst</span> | <span class="id" type="var">None</span>].<br/>
<span class="id" type="tactic">exact</span> (<span class="id" type="var">merge</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">eq_bool</span> ((<span class="id" type="var">x</span>,subj) :: <span class="id" type="var">nil</span>) <span class="id" type="tactic">subst</span>).<br/>
<span class="id" type="tactic">exact</span> <span class="id" type="var">None</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">subj</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x</span> | <span class="id" type="var">g</span> <span class="id" type="var">m</span>].<br/>
<span class="id" type="tactic">exact</span> <span class="id" type="var">None</span>.<br/>
<span class="id" type="var">case_eq</span> (<span class="id" type="var">eq_symb_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">f_eq_g</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">f_diff_g</span>].<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">pat</span> <span class="id" type="var">lpat</span>]; <span class="id" type="tactic">destruct</span> <span class="id" type="var">m</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">sub</span> <span class="id" type="var">lsub</span>].<br/>
<span class="id" type="tactic">set</span> (<span class="id" type="var">o_subst</span> := <span class="id" type="var">mrec</span> <span class="id" type="var">_</span> <span class="id" type="var">Size</span>).<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">o_subst</span> <span class="id" type="keyword">as</span> [<span class="id" type="tactic">subst</span> | <span class="id" type="var">None</span>].<br/>
<span class="id" type="tactic">exact</span> (<span class="id" type="var">Some</span> <span class="id" type="tactic">subst</span>).<br/>
<span class="id" type="tactic">exact</span> <span class="id" type="var">None</span>.<br/>
<span class="id" type="tactic">exact</span> <span class="id" type="var">None</span>.<br/>
<span class="id" type="tactic">exact</span> <span class="id" type="var">None</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Size1</span> := <span class="id" type="var">matching_call2</span> <span class="id" type="var">pat</span> <span class="id" type="var">sub</span> <span class="id" type="var">f</span> <span class="id" type="var">lpat</span> <span class="id" type="var">g</span> <span class="id" type="var">lsub</span> <span class="id" type="var">pb</span>).<br/>
<span class="id" type="tactic">set</span> (<span class="id" type="var">o_subst1</span> := <span class="id" type="var">mrec</span> <span class="id" type="var">_</span> <span class="id" type="var">Size1</span>).<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">o_subst1</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">subst1</span> | ].<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Size2</span> :=matching_call3 <span class="id" type="var">pat</span> <span class="id" type="var">sub</span> <span class="id" type="var">f</span> <span class="id" type="var">lpat</span> <span class="id" type="var">g</span> <span class="id" type="var">lsub</span> <span class="id" type="var">pb</span>).<br/>
<span class="id" type="tactic">set</span> (<span class="id" type="var">o_subst2</span> := <span class="id" type="var">mrec</span> <span class="id" type="var">_</span> <span class="id" type="var">Size2</span>).<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">o_subst2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">subst2</span> | ].<br/>
<span class="id" type="tactic">exact</span> (<span class="id" type="var">merge</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">eq_bool</span> <span class="id" type="var">subst1</span> <span class="id" type="var">subst2</span>).<br/>
<span class="id" type="tactic">exact</span> <span class="id" type="var">None</span>.<br/>
<span class="id" type="tactic">exact</span> <span class="id" type="var">None</span>.<br/>
<span class="id" type="tactic">exact</span> <span class="id" type="var">None</span>.<br/>
<span class="id" type="keyword">Defined</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab63"></a><h3 class="section">Definition of matching.</h3>

</div>
<div class="code">
<span class="id" type="keyword">Definition</span> <span class="id" type="var">matching</span> : <span class="id" type="var">list</span> (<span class="id" type="var">term</span> * <span class="id" type="var">term</span>) -&gt; <span class="id" type="var">option</span> <span class="id" type="var">substitution</span> :=<br/>
<span class="id" type="keyword">Fix</span> <span class="id" type="var">wf_size</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">option</span> <span class="id" type="var">substitution</span>) <span class="id" type="var">F_matching</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab64"></a><h3 class="section">A more practical equivalent definition of matching.</h3>

</div>
<div class="code">
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">matching_unfold</span> : <br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">l</span> : <span class="id" type="var">list</span> (<span class="id" type="var">term</span>*term), <span class="id" type="var">matching</span> <span class="id" type="var">l</span> = @<span class="id" type="var">F_matching</span> <span class="id" type="var">l</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">y</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">matching</span> <span class="id" type="var">y</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">lpb</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">matching</span>.<br/>
<span class="id" type="tactic">refine</span> (<span class="id" type="var">Fix_eq</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">lpb</span>).<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">lpb</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">lpb</span> <span class="id" type="var">F</span> <span class="id" type="var">G</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">unfold</span> <span class="id" type="var">F_matching</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">lpb</span> <span class="id" type="keyword">as</span> [ | [<span class="id" type="var">patt</span> <span class="id" type="var">subj</span>] <span class="id" type="var">lpb</span>]; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">auto</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">patt</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x</span> | <span class="id" type="var">f</span> <span class="id" type="var">l</span>]; <span class="id" type="tactic">destruct</span> <span class="id" type="var">subj</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">y</span> | <span class="id" type="var">g</span> <span class="id" type="var">m</span>]; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">auto</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">case</span> (<span class="id" type="var">eq_symb_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">pat</span> <span class="id" type="var">lpat</span>]; <span class="id" type="tactic">destruct</span> <span class="id" type="var">m</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">sub</span> <span class="id" type="var">lsub</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">do</span> 2 <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">matching_unfold2</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">pb</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">matching</span> <span class="id" type="var">pb</span> =<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">pb</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">Some</span> <span class="id" type="var">nil</span><br/>
&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">patt</span>, <span class="id" type="var">subj</span>) :: <span class="id" type="var">pb</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">patt</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">x</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">matching</span> <span class="id" type="var">pb</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Some</span> <span class="id" type="tactic">subst</span> =&gt; <span class="id" type="var">merge</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">eq_bool</span> ((<span class="id" type="var">x</span>,subj) :: <span class="id" type="var">nil</span>) <span class="id" type="tactic">subst</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">None</span> =&gt; <span class="id" type="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">subj</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Var</span> <span class="id" type="var">_</span> =&gt; <span class="id" type="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">m</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">if</span> <span class="id" type="var">eq_symb_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">m</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">matching</span> <span class="id" type="var">pb</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">sub1</span> :: <span class="id" type="var">lsub</span> =&gt; <span class="id" type="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">pat1</span> :: <span class="id" type="var">lpat</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">m</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> =&gt; <span class="id" type="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">sub1</span> :: <span class="id" type="var">lsub</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> (<span class="id" type="var">matching</span> ((<span class="id" type="var">pat1</span>, <span class="id" type="var">sub1</span>) :: <span class="id" type="var">nil</span>)) <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Some</span> <span class="id" type="var">subst1</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span>  (<span class="id" type="var">matching</span> ((<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">lpat</span>, <span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">lsub</span>) :: <span class="id" type="var">pb</span>)) <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Some</span> <span class="id" type="tactic">subst</span> =&gt; <span class="id" type="var">merge</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">eq_bool</span> <span class="id" type="var">subst1</span> <span class="id" type="tactic">subst</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">None</span> =&gt; <span class="id" type="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">None</span> =&gt; <span class="id" type="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">else</span> <span class="id" type="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">pb</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">matching_unfold</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">F_matching</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">pb</span> <span class="id" type="keyword">as</span> [ | [<span class="id" type="var">patt</span> <span class="id" type="var">subj</span>] <span class="id" type="var">pb</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">patt</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">x</span> | <span class="id" type="var">f</span> <span class="id" type="var">l</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">subj</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x</span> | <span class="id" type="var">g</span> <span class="id" type="var">m</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">case</span> (<span class="id" type="var">eq_symb_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">pat1</span> <span class="id" type="var">lpat</span>]; <span class="id" type="tactic">destruct</span> <span class="id" type="var">m</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">sub1</span> <span class="id" type="var">lsub</span>]; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">matching</span> <span class="id" type="var">pb</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">matching_correct_aux</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">pb</span> <span class="id" type="var">sigma</span>, <span class="id" type="var">matching</span> <span class="id" type="var">pb</span> = <span class="id" type="var">Some</span> <span class="id" type="var">sigma</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id" type="keyword">forall</span> <span class="id" type="var">v</span> <span class="id" type="var">t1</span>, <span class="id" type="var">In</span> (<span class="id" type="var">v</span>,t1) <span class="id" type="var">sigma</span> &lt;-&gt; <span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma</span> = <span class="id" type="var">Some</span> <span class="id" type="var">t1</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">v</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span>, <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">p</span>) -&gt; <span class="id" type="var">In</span> (<span class="id" type="var">p</span>,s) <span class="id" type="var">pb</span> -&gt; <span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma</span> &lt;&gt; <span class="id" type="var">None</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">v</span>, <span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma</span> &lt;&gt; <span class="id" type="var">None</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> <span class="id" type="var">p</span>, <span class="id" type="var">exists</span> <span class="id" type="var">s</span>, <span class="id" type="var">In</span> (<span class="id" type="var">p</span>,s) <span class="id" type="var">pb</span> /\ <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">p</span>)) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span>, <span class="id" type="var">In</span> (<span class="id" type="var">p</span>,s) <span class="id" type="var">pb</span> -&gt; <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">p</span> = <span class="id" type="var">s</span>)).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Rt</span> : <span class="id" type="var">reflexive</span> <span class="id" type="var">_</span> (@<span class="id" type="var">eq</span> <span class="id" type="var">term</span>)).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">a</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">change_hyp</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">sigma</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">v</span> <span class="id" type="var">t1</span>, <span class="id" type="var">In</span> (<span class="id" type="var">v</span>,t1) <span class="id" type="var">sigma</span> &lt;-&gt; <span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma</span> = <span class="id" type="var">Some</span> <span class="id" type="var">t1</span>)  -&gt;<br/>
&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">a1</span> <span class="id" type="var">a1'</span> <span class="id" type="var">b1</span> <span class="id" type="var">c1</span>, <span class="id" type="var">In</span> (<span class="id" type="var">a1</span>,b1) <span class="id" type="var">sigma</span> -&gt; <span class="id" type="var">In</span> (<span class="id" type="var">a1'</span>,c1) <span class="id" type="var">sigma</span> -&gt; <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">a1</span> <span class="id" type="var">a1'</span> = <span class="id" type="var">true</span> -&gt; <span class="id" type="var">eq_bool</span> <span class="id" type="var">b1</span> <span class="id" type="var">c1</span> =true)).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">sigma</span> <span class="id" type="var">H</span> <span class="id" type="var">v</span> <span class="id" type="var">v'</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> <span class="id" type="var">H1</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v</span> <span class="id" type="var">v'</span>) (<span class="id" type="var">eq_bool_ok</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>).<br/>
<span class="id" type="tactic">case</span> (<span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">v'</span>).<br/>
<span class="id" type="tactic">case</span> (<span class="id" type="var">eq_bool</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v_eq_v'</span> <span class="id" type="var">t1_diff_t2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">t1_diff_t2</span>.<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">v'</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H1</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H3</span>; <span class="id" type="tactic">exact</span> <span class="id" type="var">H3</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">Abs</span>; <span class="id" type="tactic">discriminate</span>.<br/>

<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">pb</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">pb</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">well_founded_ind</span> <span class="id" type="var">wf_size</span>); <span class="id" type="tactic">clear</span> <span class="id" type="var">pb</span>.<br/>
<span class="id" type="tactic">intros</span> [ | [<span class="id" type="var">patt</span> <span class="id" type="var">subj</span>] <span class="id" type="var">pb</span>] <span class="id" type="var">IH</span> <span class="id" type="var">sigma</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">matching_unfold2</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">repeat</span> <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>;<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">try</span> <span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="var">absurd</span> (@<span class="id" type="var">None</span> <span class="id" type="var">term</span> = <span class="id" type="var">None</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">patt</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">x</span> | <span class="id" type="var">f</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H'</span> := <span class="id" type="var">IH</span> <span class="id" type="var">_</span> (<span class="id" type="var">matching_call1</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>)).<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">matching</span> <span class="id" type="var">pb</span>) <span class="id" type="keyword">as</span> [<span class="id" type="tactic">subst</span> | ].<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">H'</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)); <span class="id" type="tactic">clear</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">intros</span> [<span class="id" type="var">IH1</span> [<span class="id" type="var">IH2</span> [<span class="id" type="var">IH4</span> <span class="id" type="var">IH3</span>]]].<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H'</span> := <span class="id" type="var">merge_correct</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">eq_bool_ok</span> <span class="id" type="var">EX.eq_proof</span> <span class="id" type="var">Rt</span> ((<span class="id" type="var">x</span>,subj) :: <span class="id" type="var">nil</span>) <span class="id" type="tactic">subst</span>).<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">H'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">H1</span> [<span class="id" type="var">H2</span> <span class="id" type="var">H3</span>]].<br/>
<span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">t1</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">Ht1</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H''</span> := <span class="id" type="var">merge_inv</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">eq_bool_ok</span> <span class="id" type="var">EX.eq_proof</span> <span class="id" type="var">Rt</span> ((<span class="id" type="var">x</span>,subj) :: <span class="id" type="var">nil</span>) <span class="id" type="tactic">subst</span>).<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H''</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">find_not_found</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">v</span> <span class="id" type="var">t1</span> <span class="id" type="var">sigma</span>).<br/>
<span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t2</span> <span class="id" type="var">F</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">apply</span> <span class="id" type="tactic">f_equal</span>; <span class="id" type="tactic">symmetry</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">t1_eq_t2</span> : <span class="id" type="var">eq_bool</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> = <span class="id" type="var">true</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">H''</span> <span class="id" type="keyword">with</span> <span class="id" type="var">v</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">w</span> <span class="id" type="var">w'</span> <span class="id" type="var">u1</span> <span class="id" type="var">u2</span> [<span class="id" type="var">wu1_eq_xs</span> | <span class="id" type="var">wu1_in_nil</span>] [<span class="id" type="var">wu2_eq_xs</span> | <span class="id" type="var">wu2_in_nil</span>]; <span class="id" type="tactic">try</span> <span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">wu1_eq_xs</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">wu2_eq_xs</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">eq_bool_ok</span> <span class="id" type="var">u2</span> <span class="id" type="var">u2</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">eq_bool</span> <span class="id" type="var">u2</span> <span class="id" type="var">u2</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">u2_diff_u2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">u2_diff_u2</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">change_hyp</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find_mem</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">F</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v'</span> [<span class="id" type="var">l1</span> [<span class="id" type="var">l2</span> [<span class="id" type="var">K1</span> <span class="id" type="var">K2</span>]]]]; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">eq_var_bool_refl</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">eq_bool_ok</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">t1_eq_t2</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">Eq</span>; <span class="id" type="tactic">exact</span> <span class="id" type="var">Eq</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> <span class="id" type="var">Abs</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">Abs</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>) (<span class="id" type="var">eq_var_bool_refl</span> <span class="id" type="var">v</span>) <span class="id" type="var">Ht1</span>).<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find_mem</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">Ht1</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v'</span> [<span class="id" type="var">l1</span> [<span class="id" type="var">l2</span> [<span class="id" type="var">K1</span> <span class="id" type="var">K2</span>]]]]; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span> <span class="id" type="var">v_in_p</span> [<span class="id" type="var">ps_eq_xsubj</span> | <span class="id" type="var">ps_in_pb</span>].<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">ps_eq_xsubj</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">ps_eq_xsubj</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">v_in_p</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v_eq_x</span> | <span class="id" type="var">v_in_nil</span>]; [<span class="id" type="tactic">subst</span> <span class="id" type="var">v</span> | <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">H1</span> <span class="id" type="var">x</span> <span class="id" type="var">s</span>).<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">eq_var_bool_refl</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">K2</span> := <span class="id" type="var">IH2</span> <span class="id" type="var">v</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span> <span class="id" type="var">v_in_p</span> <span class="id" type="var">ps_in_pb</span>).<br/>
<span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="tactic">subst</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v_subst</span> <span class="id" type="var">H'</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">H2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H'</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">b'</span> [<span class="id" type="var">H''</span> <span class="id" type="var">_</span>]]; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H''</span>; <span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H'</span> <span class="id" type="keyword">in</span> <span class="id" type="var">K2</span>; <span class="id" type="var">absurd</span> (@<span class="id" type="var">None</span> <span class="id" type="var">term</span> = <span class="id" type="var">None</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">assert</span> (<span class="id" type="var">H3v</span> := <span class="id" type="var">H3</span> <span class="id" type="var">v</span>).<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v_sigma</span> | ].<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">H3v</span> <span class="id" type="var">v_sigma</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">case1</span> | <span class="id" type="var">case2</span>].<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">case1</span>; <span class="id" type="var">revert</span> <span class="id" type="var">case1</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v</span> <span class="id" type="var">x</span>); <span class="id" type="tactic">case</span> (<span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">x</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">v_eq_x</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">v_diff_x</span>].<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">v</span>; <span class="id" type="var">exists</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>); <span class="id" type="var">exists</span> <span class="id" type="var">subj</span>; <span class="id" type="tactic">split</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intro</span>; <span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">IH4</span> <span class="id" type="var">v</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">p</span> [<span class="id" type="var">s</span> [<span class="id" type="var">ps_in_pb</span> <span class="id" type="var">v_in_p</span>]]].<br/>
<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">proj2</span> <span class="id" type="var">case2</span>); <span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="var">exists</span> <span class="id" type="var">p</span>; <span class="id" type="var">exists</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">absurd</span> (@<span class="id" type="var">None</span> <span class="id" type="var">term</span> = <span class="id" type="var">None</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span> [<span class="id" type="var">ps_eq_xsubj</span> | <span class="id" type="var">ps_in_pb</span>].<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">K1</span> := <span class="id" type="var">H1</span> <span class="id" type="var">x</span> <span class="id" type="var">subj</span>).<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">ps_eq_xsubj</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">ps_eq_xsubj</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">K1</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">eq_var_bool_refl</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">K2</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">v</span>, <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">p</span>) -&gt; <span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="tactic">subst</span> &lt;&gt; <span class="id" type="var">None</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_p</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IH2</span> <span class="id" type="keyword">with</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">KK2</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">v</span>, <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">p</span>) -&gt; <span class="id" type="var">apply_subst</span> <span class="id" type="tactic">subst</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>) = <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>)).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_p</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">K2</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_p</span>) (<span class="id" type="var">H2</span> <span class="id" type="var">v</span>); <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="tactic">subst</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v_subst</span> | ].<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">K2</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> <span class="id" type="var">K2</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">K2</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">b</span> [<span class="id" type="var">K3</span> <span class="id" type="var">K4</span>]].<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">K3</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">eq_bool_ok</span> <span class="id" type="var">v_subst</span> <span class="id" type="var">b</span>); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">K4</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">K5</span>; <span class="id" type="tactic">exact</span> <span class="id" type="var">K5</span>.<br/>
<span class="id" type="tactic">intro</span>; <span class="id" type="var">absurd</span> (@<span class="id" type="var">None</span> <span class="id" type="var">term</span> = <span class="id" type="var">None</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- (<span class="id" type="var">IH3</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">ps_in_pb</span>).<br/>
<span class="id" type="tactic">symmetry</span>.<br/>
<span class="id" type="tactic">generalize</span> <span class="id" type="var">KK2</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">s</span> <span class="id" type="var">ps_in_pb</span> <span class="id" type="var">K2</span> <span class="id" type="var">KK2</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">term_rec3</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">p</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">KK2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">KK2</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span> <span class="id" type="var">IHl</span> <span class="id" type="var">KK2</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">IHl'</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">t</span>, <span class="id" type="var">In</span> <span class="id" type="var">t</span> <span class="id" type="var">l</span> -&gt; <span class="id" type="var">apply_subst</span> <span class="id" type="tactic">subst</span> <span class="id" type="var">t</span> = <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">t</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t</span> <span class="id" type="var">t_in_l</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_t</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">KK2</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">In_split</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">t_in_l</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">l1</span> [<span class="id" type="var">l2</span> <span class="id" type="var">H'</span>]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">l</span>.<br/>
<span class="id" type="tactic">apply</span> (@<span class="id" type="var">var_in_subterm</span> <span class="id" type="var">v</span> <span class="id" type="var">t</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">l1</span> ++ <span class="id" type="var">t</span> :: <span class="id" type="var">l2</span>)) (<span class="id" type="var">length</span> <span class="id" type="var">l1</span> :: <span class="id" type="var">nil</span>)); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">nth_error_at_pos</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>)).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">map_eq</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">discriminate</span>.<br/>

<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">subj</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x</span> | <span class="id" type="var">g</span> <span class="id" type="var">m</span>].<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span>); <span class="id" type="var">revert</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">case</span> (<span class="id" type="var">eq_symb_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span>); [<span class="id" type="tactic">intros</span> <span class="id" type="var">H</span> <span class="id" type="var">f_eq_g</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">H</span> <span class="id" type="var">f_diff_g</span>].<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">pat1</span> <span class="id" type="var">lpat</span>]; <span class="id" type="tactic">destruct</span> <span class="id" type="var">m</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">sub1</span> <span class="id" type="var">lsub</span>].<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">IH</span> <span class="id" type="var">_</span> (<span class="id" type="var">matching_call1</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">sigma</span> <span class="id" type="var">H</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">H1</span> [<span class="id" type="var">H2</span> [<span class="id" type="var">H4</span> <span class="id" type="var">H3</span>]]].<br/>
<span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span> <span class="id" type="var">v_in_p</span> [<span class="id" type="var">ps_eq_ff</span> | <span class="id" type="var">ps_in_pb</span>].<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">ps_eq_ff</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">H2</span> <span class="id" type="keyword">with</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">H4</span> <span class="id" type="var">_</span> <span class="id" type="var">H'</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">p</span> [<span class="id" type="var">s</span> [<span class="id" type="var">ps_in_pb</span> <span class="id" type="var">v_in_p</span>]]].<br/>
<span class="id" type="var">exists</span> <span class="id" type="var">p</span>; <span class="id" type="var">exists</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span> [<span class="id" type="var">ps_eq_ff</span> | <span class="id" type="var">ps_in_pb</span>].<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">ps_eq_ff</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">H3</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H'</span> := <span class="id" type="var">IH</span> <span class="id" type="var">_</span> (<span class="id" type="var">matching_call2</span> <span class="id" type="var">pat1</span> <span class="id" type="var">sub1</span> <span class="id" type="var">f</span> <span class="id" type="var">lpat</span> <span class="id" type="var">g</span> <span class="id" type="var">lsub</span> <span class="id" type="var">pb</span>)).<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">matching</span> ((<span class="id" type="var">pat1</span>,sub1) :: <span class="id" type="var">nil</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">subst1</span> | ].<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">H'</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)); <span class="id" type="tactic">clear</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">intros</span> [<span class="id" type="var">IH1</span> [<span class="id" type="var">IH2</span> [<span class="id" type="var">IH4</span> <span class="id" type="var">IH3</span>]]].<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H'</span> := <span class="id" type="var">IH</span> <span class="id" type="var">_</span> (<span class="id" type="var">matching_call3</span> <span class="id" type="var">pat1</span> <span class="id" type="var">sub1</span> <span class="id" type="var">f</span> <span class="id" type="var">lpat</span> <span class="id" type="var">g</span> <span class="id" type="var">lsub</span> <span class="id" type="var">pb</span>)).<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">matching</span> ((<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">lpat</span>, <span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">lsub</span>) :: <span class="id" type="var">pb</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="tactic">subst</span> | ].<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">H'</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)); <span class="id" type="tactic">clear</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">intros</span> [<span class="id" type="var">IH1'</span> [<span class="id" type="var">IH2'</span> [<span class="id" type="var">IH4'</span> <span class="id" type="var">IH3'</span>]]].<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H'</span> := <span class="id" type="var">merge_correct</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">eq_bool_ok</span> <span class="id" type="var">EX.eq_proof</span> <span class="id" type="var">Rt</span> <span class="id" type="var">subst1</span> <span class="id" type="tactic">subst</span>).<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">H'</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">H1</span> [<span class="id" type="var">H2</span> <span class="id" type="var">H3</span>]].<br/>
<span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">t1</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">Ht1</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H''</span> := <span class="id" type="var">merge_inv</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">eq_bool_ok</span> <span class="id" type="var">EX.eq_proof</span> <span class="id" type="var">Rt</span> <span class="id" type="var">subst1</span> <span class="id" type="tactic">subst</span>).<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H''</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">find_not_found</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">v</span> <span class="id" type="var">t1</span> <span class="id" type="var">sigma</span>).<br/>
<span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">t2</span> <span class="id" type="var">F</span> <span class="id" type="var">_</span>; <span class="id" type="tactic">apply</span> <span class="id" type="tactic">f_equal</span>; <span class="id" type="tactic">symmetry</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">t1_eq_t2</span> : <span class="id" type="var">eq_bool</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span> = <span class="id" type="var">true</span>).<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">H''</span> <span class="id" type="keyword">with</span> <span class="id" type="var">v</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">change_hyp</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">change_hyp</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find_mem</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">F</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v'</span> [<span class="id" type="var">l1</span> [<span class="id" type="var">l2</span> [<span class="id" type="var">K1</span> <span class="id" type="var">K2</span>]]]]; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">eq_var_bool_refl</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">eq_bool_ok</span> <span class="id" type="var">t1</span> <span class="id" type="var">t2</span>); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">t1_eq_t2</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">Eq</span>; <span class="id" type="tactic">exact</span> <span class="id" type="var">Eq</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> <span class="id" type="var">Abs</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">Abs</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>) (<span class="id" type="var">eq_var_bool_refl</span> <span class="id" type="var">v</span>) <span class="id" type="var">Ht1</span>).<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find_mem</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">Ht1</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v'</span> [<span class="id" type="var">l1</span> [<span class="id" type="var">l2</span> [<span class="id" type="var">K1</span> <span class="id" type="var">K2</span>]]]]; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span> <span class="id" type="var">v_in_p</span> [<span class="id" type="var">ps_eq_patsub</span> | <span class="id" type="var">ps_in_pb</span>].<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">ps_eq_patsub</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">ps_eq_patsub</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_in_p</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">in_app_or</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">v_in_p</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v_in_pat1</span> | <span class="id" type="var">v_in_lpat</span>].<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">K2</span> := <span class="id" type="var">IH2</span> <span class="id" type="var">v</span> <span class="id" type="var">pat1</span> <span class="id" type="var">sub1</span> <span class="id" type="var">v_in_pat1</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>))).<br/>
<span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">subst1</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v_subst</span> <span class="id" type="var">H'</span>.<br/>
<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">H1</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H'</span>); <span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H'</span> <span class="id" type="keyword">in</span> <span class="id" type="var">K2</span>; <span class="id" type="var">absurd</span> (@<span class="id" type="var">None</span> <span class="id" type="var">term</span> = <span class="id" type="var">None</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">K2</span> := <span class="id" type="var">IH2'</span> <span class="id" type="var">v</span> (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">lpat</span>) (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">lsub</span>) <span class="id" type="var">v_in_lpat</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>))).<br/>
<span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="tactic">subst</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v_subst</span> <span class="id" type="var">H'</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">H2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H'</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">b</span> [<span class="id" type="var">K3</span> <span class="id" type="var">_</span>]]; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">K3</span>; <span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H'</span> <span class="id" type="keyword">in</span> <span class="id" type="var">K2</span>; <span class="id" type="var">absurd</span> (@<span class="id" type="var">None</span> <span class="id" type="var">term</span> = <span class="id" type="var">None</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">K2</span> := <span class="id" type="var">IH2'</span> <span class="id" type="var">v</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span> <span class="id" type="var">v_in_p</span> (<span class="id" type="var">or_intror</span> <span class="id" type="var">_</span> <span class="id" type="var">ps_in_pb</span>)).<br/>
<span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="tactic">subst</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v_subst</span> <span class="id" type="var">H'</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">H2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H'</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">b</span> [<span class="id" type="var">K3</span> <span class="id" type="var">_</span>]]; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">K3</span>; <span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H'</span> <span class="id" type="keyword">in</span> <span class="id" type="var">K2</span>; <span class="id" type="var">absurd</span> (@<span class="id" type="var">None</span> <span class="id" type="var">term</span> = <span class="id" type="var">None</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">split</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">assert</span> (<span class="id" type="var">H3v</span> := <span class="id" type="var">H3</span> <span class="id" type="var">v</span>).<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v_sigma</span> | ].<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">H3v</span> <span class="id" type="var">v_sigma</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">case1</span> | <span class="id" type="var">case2</span>].<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">IH4</span> <span class="id" type="var">v</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">p</span> [<span class="id" type="var">s</span> [<span class="id" type="var">ps_in_pb</span> <span class="id" type="var">v_in_p</span>]]].<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">case1</span>; <span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="var">exists</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">pat1</span> :: <span class="id" type="var">lpat</span>)); <span class="id" type="var">exists</span> (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> (<span class="id" type="var">sub1</span> :: <span class="id" type="var">lsub</span>)); <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">ps_in_pb</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">ps_eq_pat1sub1</span> | <span class="id" type="var">ps_in_nil</span>].<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">ps_eq_pat1sub1</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">ps_eq_pat1sub1</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">IH4'</span> <span class="id" type="var">v</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">p</span> [<span class="id" type="var">s</span> [<span class="id" type="var">ps_in_pb</span> <span class="id" type="var">v_in_p</span>]]].<br/>
<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">proj2</span> <span class="id" type="var">case2</span>); <span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">ps_in_pb</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">ps_eq_patsub</span> | <span class="id" type="var">ps_in_pb</span>].<br/>
<span class="id" type="var">exists</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">pat1</span> :: <span class="id" type="var">lpat</span>)); <span class="id" type="var">exists</span> (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> (<span class="id" type="var">sub1</span> :: <span class="id" type="var">lsub</span>)); <span class="id" type="tactic">split</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">ps_eq_patsub</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">ps_eq_patsub</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">in_or_app</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">exists</span> <span class="id" type="var">p</span>; <span class="id" type="var">exists</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">absurd</span> (@<span class="id" type="var">None</span> <span class="id" type="var">term</span> = <span class="id" type="var">None</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span> [<span class="id" type="var">ps_eq_patsub</span> | <span class="id" type="var">ps_in_pb</span>].<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">ps_eq_patsub</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">ps_eq_patsub</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">replace</span> (<span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">pat1</span>) <span class="id" type="keyword">with</span> <span class="id" type="var">sub1</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="tactic">f_equal</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">l</span> =&gt; <span class="id" type="var">Term</span> <span class="id" type="var">g</span> (<span class="id" type="var">sub1</span> :: <span class="id" type="var">l</span>))).<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">K</span> := <span class="id" type="var">IH3'</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>))).<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">K</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">K</span>; <span class="id" type="tactic">symmetry</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">map_eq</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">p</span> <span class="id" type="var">p_in_lpat</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">subst_eq_vars</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">K2</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">v</span>, <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">p</span>) -&gt; <span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="tactic">subst</span> &lt;&gt; <span class="id" type="var">None</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_p</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IH2'</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">lpat</span>) (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">lsub</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">In_split</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">p_in_lpat</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">lpat1</span> [<span class="id" type="var">lpat2</span> <span class="id" type="var">H'</span>]]; <span class="id" type="tactic">subst</span> <span class="id" type="var">lpat</span>.<br/>
<span class="id" type="tactic">apply</span> (@<span class="id" type="var">var_in_subterm</span> <span class="id" type="var">v</span> <span class="id" type="var">p</span> (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> (<span class="id" type="var">lpat1</span> ++ <span class="id" type="var">p</span> :: <span class="id" type="var">lpat2</span>)) (<span class="id" type="var">length</span> <span class="id" type="var">lpat1</span> :: <span class="id" type="var">nil</span>)); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">nth_error_at_pos</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_p</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">K2</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_p</span>) (<span class="id" type="var">H2</span> <span class="id" type="var">v</span>); <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="tactic">subst</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v_subst</span> | ].<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">K2</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> <span class="id" type="var">K2</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">K2</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">b</span> [<span class="id" type="var">K3</span> <span class="id" type="var">K4</span>]]; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">K3</span>;  <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">eq_bool_ok</span> <span class="id" type="var">v_subst</span> <span class="id" type="var">b</span>); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">K4</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">K5</span>; <span class="id" type="tactic">exact</span> <span class="id" type="var">K5</span>.<br/>
<span class="id" type="tactic">intro</span>; <span class="id" type="var">absurd</span> (@<span class="id" type="var">None</span> <span class="id" type="var">term</span> = <span class="id" type="var">None</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">K</span> := <span class="id" type="var">IH3</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>))).<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">K</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">K</span>; <span class="id" type="tactic">symmetry</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">subst_eq_vars</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">K2</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">v</span>, <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">pat1</span>) -&gt; <span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">subst1</span> &lt;&gt; <span class="id" type="var">None</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_pat1</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IH2</span> <span class="id" type="keyword">with</span> <span class="id" type="var">pat1</span> <span class="id" type="var">sub1</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">left</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_pat1</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">K2</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_pat1</span>) (<span class="id" type="var">H1</span> <span class="id" type="var">v</span>); <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">subst1</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v_subst1</span> | ].<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">K2</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> <span class="id" type="var">K2</span>; <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">K2</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intro</span>; <span class="id" type="var">absurd</span> (@<span class="id" type="var">None</span> <span class="id" type="var">term</span> = <span class="id" type="var">None</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- (<span class="id" type="var">IH3'</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> (<span class="id" type="var">or_intror</span> <span class="id" type="var">_</span> <span class="id" type="var">ps_in_pb</span>)).<br/>
<span class="id" type="tactic">symmetry</span>; <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">subst_eq_vars</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">K2</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">v</span>, <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">p</span>) -&gt; <span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="tactic">subst</span> &lt;&gt; <span class="id" type="var">None</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_p</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IH2'</span> <span class="id" type="keyword">with</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">trivial</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_p</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">K2</span> <span class="id" type="var">v</span> <span class="id" type="var">v_in_p</span>) (<span class="id" type="var">H2</span> <span class="id" type="var">v</span>); <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="tactic">subst</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v_subst</span> | ].<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">K2</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">_</span> <span class="id" type="var">K2</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">K2</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)) <span class="id" type="keyword">as</span> [<span class="id" type="var">b</span> [<span class="id" type="var">K3</span> <span class="id" type="var">K4</span>]]; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">K3</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">eq_bool_ok</span> <span class="id" type="var">v_subst</span> <span class="id" type="var">b</span>); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">K4</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">K5</span>; <span class="id" type="tactic">exact</span> <span class="id" type="var">K5</span>.<br/>
<span class="id" type="tactic">intro</span>; <span class="id" type="var">absurd</span> (@<span class="id" type="var">None</span> <span class="id" type="var">term</span> = <span class="id" type="var">None</span>); <span class="id" type="tactic">trivial</span>.<br/>

<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">matching_correct</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">pb</span> <span class="id" type="var">sigma</span>, <span class="id" type="var">matching</span> <span class="id" type="var">pb</span> = <span class="id" type="var">Some</span> <span class="id" type="var">sigma</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id" type="keyword">forall</span> <span class="id" type="var">v</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span>, <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">p</span>) -&gt; <span class="id" type="var">In</span> (<span class="id" type="var">p</span>,s) <span class="id" type="var">pb</span> -&gt; <span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma</span> &lt;&gt; <span class="id" type="var">None</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">v</span>, <span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">sigma</span> &lt;&gt; <span class="id" type="var">None</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exists</span> <span class="id" type="var">p</span>, <span class="id" type="var">exists</span> <span class="id" type="var">s</span>, <span class="id" type="var">In</span> (<span class="id" type="var">p</span>,s) <span class="id" type="var">pb</span> /\ <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">p</span>)) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">forall</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span>, <span class="id" type="var">In</span> (<span class="id" type="var">p</span>,s) <span class="id" type="var">pb</span> -&gt; <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">p</span> = <span class="id" type="var">s</span>)).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">pb</span> <span class="id" type="var">sigma</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">matching_correct_aux</span> <span class="id" type="var">pb</span> <span class="id" type="var">H</span>); <span class="id" type="tactic">intuition</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">matching_complete</span> :<br/>
&nbsp;&nbsp;<span class="id" type="keyword">forall</span> <span class="id" type="var">pb</span> <span class="id" type="var">sigma</span>, (<span class="id" type="keyword">forall</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span>, <span class="id" type="var">In</span> (<span class="id" type="var">p</span>,s) <span class="id" type="var">pb</span> -&gt; <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">p</span> = <span class="id" type="var">s</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">matching</span> <span class="id" type="var">pb</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Some</span> <span class="id" type="var">tau</span> =&gt; <span class="id" type="keyword">forall</span> <span class="id" type="var">v</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span>, <span class="id" type="var">In</span> <span class="id" type="var">v</span> (<span class="id" type="var">var_list</span> <span class="id" type="var">p</span>) -&gt; <span class="id" type="var">In</span> (<span class="id" type="var">p</span>,s) <span class="id" type="var">pb</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">apply_subst</span> <span class="id" type="var">tau</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>) = <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> (<span class="id" type="var">Var</span> <span class="id" type="var">v</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">None</span> =&gt; <span class="id" type="var">False</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Rt</span> : <span class="id" type="var">reflexive</span> <span class="id" type="var">_</span> (@<span class="id" type="var">eq</span> <span class="id" type="var">term</span>)).<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">a</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">pb</span>; <span class="id" type="tactic">pattern</span> <span class="id" type="var">pb</span>; <span class="id" type="tactic">apply</span> (<span class="id" type="var">well_founded_ind</span> <span class="id" type="var">wf_size</span>); <span class="id" type="tactic">clear</span> <span class="id" type="var">pb</span>.<br/>
<span class="id" type="tactic">intros</span> [ | [<span class="id" type="var">patt</span> <span class="id" type="var">subj</span>] <span class="id" type="var">pb</span>] <span class="id" type="var">IH</span> <span class="id" type="var">sigma</span> <span class="id" type="var">H</span>;<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">matching_unfold2</span>.<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">tailH</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span> : <span class="id" type="var">term</span>, <span class="id" type="var">In</span> (<span class="id" type="var">p</span>, <span class="id" type="var">s</span>) <span class="id" type="var">pb</span> -&gt; <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">p</span> = <span class="id" type="var">s</span>).<br/>
<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Hsigma</span> := <span class="id" type="var">IH</span> <span class="id" type="var">_</span> (<span class="id" type="var">matching_call1</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">sigma</span> <span class="id" type="var">tailH</span>).<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">patt</span> <span class="id" type="keyword">as</span> [ <span class="id" type="var">x</span> | <span class="id" type="var">f</span> <span class="id" type="var">l</span>].<br/>
<span class="id" type="var">case_eq</span> (<span class="id" type="var">matching</span> <span class="id" type="var">pb</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="tactic">subst</span> <span class="id" type="var">matching_pb_eq_subst</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">matching_pb_eq_subst</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hsigma</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">matching_correct_aux</span> <span class="id" type="var">pb</span> <span class="id" type="var">matching_pb_eq_subst</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">C1</span> [<span class="id" type="var">C2</span> [<span class="id" type="var">C4</span> <span class="id" type="var">C3</span>]]].<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H''</span> := <span class="id" type="var">merge_correct</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">eq_bool_ok</span> <span class="id" type="var">EX.eq_proof</span> <span class="id" type="var">Rt</span> ((<span class="id" type="var">x</span>,subj) :: <span class="id" type="var">nil</span>) <span class="id" type="tactic">subst</span>).<br/>
<span class="id" type="var">case_eq</span> (<span class="id" type="var">merge</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">eq_bool</span> ((<span class="id" type="var">x</span>, <span class="id" type="var">subj</span>) :: <span class="id" type="var">nil</span>) <span class="id" type="tactic">subst</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">tau</span> <span class="id" type="var">matching_pb_eq_tau</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">matching_pb_eq_tau</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H''</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">H''</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">H1</span> [<span class="id" type="var">H2</span> <span class="id" type="var">H3</span>]].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span> <span class="id" type="var">v_in_p</span> [<span class="id" type="var">ps_eq_xsubj</span> | <span class="id" type="var">ps_in_pb</span>].<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">ps_eq_xsubj</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">ps_eq_xsubj</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">v_in_p</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v_eq_x</span> | <span class="id" type="var">v_in_nil</span>]; [<span class="id" type="var">idtac</span> | <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">H</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>) <span class="id" type="var">s</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>))).<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">H1</span> <span class="id" type="var">x</span> <span class="id" type="var">s</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">eq_var_bool_refl</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- (<span class="id" type="var">Hsigma</span> <span class="id" type="var">v</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span> <span class="id" type="var">v_in_p</span> <span class="id" type="var">ps_in_pb</span>).<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">assert</span> (<span class="id" type="var">K2</span> := <span class="id" type="var">C2</span> <span class="id" type="var">v</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span> <span class="id" type="var">v_in_p</span> <span class="id" type="var">ps_in_pb</span>).<br/>
<span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="tactic">subst</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v_subst</span> <span class="id" type="var">H''</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">H2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H''</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">b</span> [<span class="id" type="var">K3</span> <span class="id" type="var">K4</span>]]; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">K3</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">symmetry</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">eq_bool_ok</span> <span class="id" type="var">v_subst</span> <span class="id" type="var">b</span>); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">K4</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">K5</span>; <span class="id" type="tactic">exact</span> <span class="id" type="var">K5</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">H''</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H''</span> <span class="id" type="keyword">in</span> <span class="id" type="var">K2</span>; <span class="id" type="var">absurd</span> (@<span class="id" type="var">None</span> <span class="id" type="var">term</span> = <span class="id" type="var">None</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">matching_pb_eq_none</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">matching_pb_eq_none</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H''</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">H''</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v</span> [<span class="id" type="var">v'</span> [<span class="id" type="var">t1</span> [<span class="id" type="var">t2</span> [<span class="id" type="var">H1</span> [<span class="id" type="var">H2</span> [<span class="id" type="var">v_eq_v'</span> <span class="id" type="var">t1_diff_t2</span>]]]]]]].<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v</span> <span class="id" type="var">v'</span>); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">v_eq_v'</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">v_eq_v''</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">v'</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">eq_bool_ok</span> <span class="id" type="var">t2</span> <span class="id" type="var">t1</span>); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">t1_diff_t2</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t1_diff_t2</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">t1_diff_t2</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">C1</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">C1</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H2</span>.<br/>
<span class="id" type="tactic">case</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H1</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">C4</span> <span class="id" type="var">v</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">p</span> [<span class="id" type="var">s</span> [<span class="id" type="var">ps_in_pb</span> <span class="id" type="var">v_in_p</span>]]].<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v</span> <span class="id" type="var">x</span>); <span class="id" type="tactic">destruct</span> (<span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">x</span>); <br/>
[<span class="id" type="tactic">intros</span> <span class="id" type="var">v_eq_x</span> | <span class="id" type="tactic">intros</span> <span class="id" type="var">v_diff_x</span>; <span class="id" type="tactic">discriminate</span>].<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">subj</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Hv</span> := <span class="id" type="var">Hsigma</span> <span class="id" type="var">x</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span> <span class="id" type="var">v_in_p</span> <span class="id" type="var">ps_in_pb</span>).<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Hv'</span> := <span class="id" type="var">H</span> (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>) <span class="id" type="var">t1</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>))).<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Hv'</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hv</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hv</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H2</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hv</span>; <span class="id" type="var">absurd</span> (<span class="id" type="var">t2</span> = <span class="id" type="var">t1</span>); <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H1</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">t1_diff_t2</span>; <span class="id" type="tactic">symmetry</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H3</span>; <span class="id" type="tactic">exact</span> <span class="id" type="var">H3</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">matching_pb_eq_none</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">matching_pb_eq_none</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hsigma</span>.<br/>
<span class="id" type="tactic">elim</span> <span class="id" type="var">Hsigma</span>.<br/>

<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">subj</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x</span> | <span class="id" type="var">g</span> <span class="id" type="var">m</span>].<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H'</span> := <span class="id" type="var">H</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">l</span>) (<span class="id" type="var">Var</span> <span class="id" type="var">x</span>) (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>))); <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H'</span>.<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="var">case_eq</span> (<span class="id" type="var">eq_symb_bool</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span>); [<span class="id" type="tactic">intro</span> <span class="id" type="var">f_eq_g</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">f_diff_g</span>].<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">pat1</span> <span class="id" type="var">lpat</span>]; <span class="id" type="tactic">destruct</span> <span class="id" type="var">m</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">sub1</span> <span class="id" type="var">lsub</span>].<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">matching</span> <span class="id" type="var">pb</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">tau</span> | ].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span> <span class="id" type="var">v_in_p</span> [<span class="id" type="var">ps_eq_ff</span> | <span class="id" type="var">ps_in_pb</span>].<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">ps_eq_ff</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_in_p</span>; <span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">Hsigma</span> <span class="id" type="keyword">with</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H'</span> := <span class="id" type="var">H</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">nil</span>) (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> (<span class="id" type="var">sub1</span> :: <span class="id" type="var">lsub</span>)) (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>))); <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H'</span>.<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H'</span> := <span class="id" type="var">H</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> (<span class="id" type="var">pat1</span> :: <span class="id" type="var">lpat</span>)) (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">nil</span>) (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>))); <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H'</span>.<br/>
<span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H'</span> := <span class="id" type="var">IH</span> <span class="id" type="var">_</span> (<span class="id" type="var">matching_call2</span> <span class="id" type="var">pat1</span> <span class="id" type="var">sub1</span> <span class="id" type="var">f</span> <span class="id" type="var">lpat</span> <span class="id" type="var">g</span> <span class="id" type="var">lsub</span> <span class="id" type="var">pb</span>)).<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Correct</span> := <span class="id" type="var">matching_correct_aux</span> ((<span class="id" type="var">pat1</span>,sub1) :: <span class="id" type="var">nil</span>)).<br/>
<span class="id" type="var">case_eq</span> (<span class="id" type="var">matching</span> ((<span class="id" type="var">pat1</span>,sub1) :: <span class="id" type="var">nil</span>)).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">subst1</span> <span class="id" type="var">matching_pat1sub1_eq_subst1</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">Correct</span> <span class="id" type="var">_</span> <span class="id" type="var">matching_pat1sub1_eq_subst1</span>) <span class="id" type="keyword">as</span>  [<span class="id" type="var">C1</span> [<span class="id" type="var">C2</span> [<span class="id" type="var">C4</span> <span class="id" type="var">C3</span>]]]; <span class="id" type="tactic">clear</span> <span class="id" type="var">Correct</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H''</span> := <span class="id" type="var">IH</span> <span class="id" type="var">_</span> (<span class="id" type="var">matching_call3</span> <span class="id" type="var">pat1</span> <span class="id" type="var">sub1</span> <span class="id" type="var">f</span> <span class="id" type="var">lpat</span> <span class="id" type="var">g</span> <span class="id" type="var">lsub</span> <span class="id" type="var">pb</span>)).<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Correct'</span> := <span class="id" type="var">matching_correct_aux</span> ((<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">lpat</span>, <span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">lsub</span>) :: <span class="id" type="var">pb</span>)).<br/>
<span class="id" type="var">case_eq</span> (<span class="id" type="var">matching</span> ((<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">lpat</span>, <span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">lsub</span>) :: <span class="id" type="var">pb</span>)).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="tactic">subst</span> <span class="id" type="var">matching_pb_eq_subst</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">Correct'</span> <span class="id" type="var">_</span> <span class="id" type="var">matching_pb_eq_subst</span>) <span class="id" type="keyword">as</span>  [<span class="id" type="var">C1'</span> [<span class="id" type="var">C2'</span> [<span class="id" type="var">C4'</span> <span class="id" type="var">C3'</span>]]]; <span class="id" type="tactic">clear</span> <span class="id" type="var">Correct'</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H'''</span> := <span class="id" type="var">merge_correct</span> <span class="id" type="var">_</span> <span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">_</span> <span class="id" type="var">eq_bool_ok</span> <span class="id" type="var">EX.eq_proof</span> <span class="id" type="var">Rt</span> <span class="id" type="var">subst1</span> <span class="id" type="tactic">subst</span>).<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">headH</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span>, <span class="id" type="var">In</span> (<span class="id" type="var">p</span>,s) ((<span class="id" type="var">pat1</span>,sub1) :: <span class="id" type="var">nil</span>) -&gt; <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">p</span> = <span class="id" type="var">s</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span> [<span class="id" type="var">ps_eq_pat1sub1</span> | <span class="id" type="var">ps_in_nil</span>]; [<span class="id" type="var">idtac</span> | <span class="id" type="var">contradiction</span>].<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">ps_eq_pat1sub1</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">ps_eq_pat1sub1</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">K</span> := <span class="id" type="var">H</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>))).<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">Hsigma1</span> := <span class="id" type="var">IH</span> <span class="id" type="var">_</span> (<span class="id" type="var">matching_call2</span>  <span class="id" type="var">pat1</span> <span class="id" type="var">sub1</span> <span class="id" type="var">f</span> <span class="id" type="var">lpat</span> <span class="id" type="var">g</span> <span class="id" type="var">lsub</span> <span class="id" type="var">pb</span>) <span class="id" type="var">sigma</span> <span class="id" type="var">headH</span>).<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">matching_pat1sub1_eq_subst1</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hsigma1</span>.<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">tailH</span>; <span class="id" type="tactic">assert</span> (<span class="id" type="var">tailH</span> : <span class="id" type="keyword">forall</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span>, <span class="id" type="var">In</span> (<span class="id" type="var">p</span>,s) ((<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">lpat</span>, <span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">lsub</span>) :: <span class="id" type="var">pb</span>) -&gt; <span class="id" type="var">apply_subst</span> <span class="id" type="var">sigma</span> <span class="id" type="var">p</span> = <span class="id" type="var">s</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span> [<span class="id" type="var">ps_eq_patsub</span> | <span class="id" type="var">ps_in_pb</span>].<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">ps_eq_patsub</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">ps_eq_patsub</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">K</span> := <span class="id" type="var">H</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>))).<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">Hsigma</span>; <span class="id" type="tactic">assert</span> (<span class="id" type="var">Hsigma</span> := <span class="id" type="var">IH</span> <span class="id" type="var">_</span> (<span class="id" type="var">matching_call3</span>  <span class="id" type="var">pat1</span> <span class="id" type="var">sub1</span> <span class="id" type="var">f</span> <span class="id" type="var">lpat</span> <span class="id" type="var">g</span> <span class="id" type="var">lsub</span> <span class="id" type="var">pb</span>) <span class="id" type="var">sigma</span> <span class="id" type="var">tailH</span>).<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">matching_pb_eq_subst</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hsigma</span>.<br/>
<span class="id" type="var">case_eq</span> (<span class="id" type="var">merge</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">eq_bool</span> <span class="id" type="var">subst1</span> <span class="id" type="tactic">subst</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">tau</span> <span class="id" type="var">matching_pb_eq_tau</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">matching_pb_eq_tau</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H'''</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">H'''</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">H1</span> [<span class="id" type="var">H2</span> <span class="id" type="var">H3</span>]].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span> <span class="id" type="var">v_in_p</span> [<span class="id" type="var">ps_eq_pat_sub</span> | <span class="id" type="var">ps_in_pb</span>].<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">ps_eq_pat_sub</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">ps_eq_pat_sub</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">var_list_unfold</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_in_p</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">v_in_p</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">in_app_or</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">v_in_p</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">v_in_pat1</span> | <span class="id" type="var">v_in_lpat</span>]; <span class="id" type="tactic">clear</span> <span class="id" type="var">v_in_p</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- (<span class="id" type="var">Hsigma1</span> <span class="id" type="var">v</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">v_in_pat1</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>))).<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">assert</span> (<span class="id" type="var">K2</span> := <span class="id" type="var">C2</span> <span class="id" type="var">v</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">v_in_pat1</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>))).<br/>
<span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="var">subst1</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v_subst1</span> <span class="id" type="var">H'''</span>; <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">H1</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H'''</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">H'''</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H'''</span> <span class="id" type="keyword">in</span> <span class="id" type="var">K2</span>; <span class="id" type="var">absurd</span> (@<span class="id" type="var">None</span> <span class="id" type="var">term</span> = <span class="id" type="var">None</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">K</span> := <span class="id" type="var">Hsigma</span> <span class="id" type="var">v</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">lpat</span>) (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">lsub</span>)).<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">K</span> <span class="id" type="var">v_in_lpat</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>))); <span class="id" type="tactic">clear</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">K</span>.<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">assert</span> (<span class="id" type="var">K2</span> := <span class="id" type="var">C2'</span> <span class="id" type="var">v</span> (<span class="id" type="var">Term</span> <span class="id" type="var">f</span> <span class="id" type="var">lpat</span>) (<span class="id" type="var">Term</span> <span class="id" type="var">g</span> <span class="id" type="var">lsub</span>)).<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">K2</span>; <span class="id" type="tactic">generalize</span> (<span class="id" type="var">K2</span> <span class="id" type="var">v_in_lpat</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>))); <span class="id" type="tactic">clear</span> <span class="id" type="var">K2</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">K2</span>.<br/>
<span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="tactic">subst</span>); [<span class="id" type="var">idtac</span> | <span class="id" type="tactic">intro</span> <span class="id" type="var">H'''</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H'''</span> <span class="id" type="keyword">in</span> <span class="id" type="var">K2</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">False_rec</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">K2</span>; <span class="id" type="tactic">reflexivity</span>].<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v_subst</span> <span class="id" type="var">H'''</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">H2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H'''</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">b</span> [<span class="id" type="var">K3</span> <span class="id" type="var">K4</span>]].<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">eq_bool_ok</span> <span class="id" type="var">v_subst</span> <span class="id" type="var">b</span>); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">K4</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">K4</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">K4</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">b</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H'''</span> <span class="id" type="keyword">in</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">K3</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">K</span> := <span class="id" type="var">Hsigma</span> <span class="id" type="var">v</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span> <span class="id" type="var">v_in_p</span> (<span class="id" type="var">or_intror</span> <span class="id" type="var">_</span> <span class="id" type="var">ps_in_pb</span>)).<br/>
<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">assert</span> (<span class="id" type="var">K2</span> := <span class="id" type="var">C2'</span> <span class="id" type="var">v</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span> <span class="id" type="var">v_in_p</span> (<span class="id" type="var">or_intror</span> <span class="id" type="var">_</span> <span class="id" type="var">ps_in_pb</span>)).<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">K</span>; <span class="id" type="var">case_eq</span> (<span class="id" type="var">find</span> <span class="id" type="var">eq_var_bool</span> <span class="id" type="var">v</span> <span class="id" type="tactic">subst</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">v_subst</span> <span class="id" type="var">H'''</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">H2</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H'''</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">b</span> [<span class="id" type="var">K3</span> <span class="id" type="var">K4</span>]].<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">eq_bool_ok</span> <span class="id" type="var">v_subst</span> <span class="id" type="var">b</span>); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">K4</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">K4</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">K4</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">b</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H'''</span> <span class="id" type="keyword">in</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">K3</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">H'''</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H'''</span> <span class="id" type="keyword">in</span> <span class="id" type="var">K2</span>; <span class="id" type="var">absurd</span> (@<span class="id" type="var">None</span> <span class="id" type="var">term</span> = <span class="id" type="var">None</span>); <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">matching_pb_eq_none</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">matching_pb_eq_none</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H'''</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">H'''</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v</span> [<span class="id" type="var">v'</span> [<span class="id" type="var">t1</span> [<span class="id" type="var">t2</span> [<span class="id" type="var">H1</span> [<span class="id" type="var">H2</span> [<span class="id" type="var">v_eq_v'</span> <span class="id" type="var">t1_diff_t2</span>]]]]]]].<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">X.eq_bool_ok</span> <span class="id" type="var">v</span> <span class="id" type="var">v'</span>); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">v_eq_v'</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">v_eq_v''</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">v'</span>.<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">eq_bool_ok</span> <span class="id" type="var">t2</span> <span class="id" type="var">t1</span>); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">t1_diff_t2</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">t1_diff_t2</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">t1_diff_t2</span>.<br/>
<span class="id" type="tactic">case</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H1</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">C4</span> <span class="id" type="var">v</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">p</span> [<span class="id" type="var">s</span> [<span class="id" type="var">ps_in_pb</span> <span class="id" type="var">v_in_p</span>]]].<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H1v</span> := <span class="id" type="var">Hsigma1</span> <span class="id" type="var">v</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span> <span class="id" type="var">v_in_p</span> <span class="id" type="var">ps_in_pb</span>); <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H1v</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H1</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H1v</span>.<br/>
<span class="id" type="tactic">destruct</span> (<span class="id" type="var">C4'</span> <span class="id" type="var">v</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">p'</span> [<span class="id" type="var">s'</span> [<span class="id" type="var">ps'_in_pb</span> <span class="id" type="var">v_in_p'</span>]]].<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">C1'</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">discriminate</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">H2v</span> := <span class="id" type="var">Hsigma</span> <span class="id" type="var">v</span> <span class="id" type="var">p'</span> <span class="id" type="var">s'</span> <span class="id" type="var">v_in_p'</span> <span class="id" type="var">ps'_in_pb</span>); <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H2v</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H2v</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H1v</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">C1'</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H2</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H1v</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">t1_diff_t2</span>; <span class="id" type="tactic">symmetry</span>; <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">t1_diff_t2</span>; <span class="id" type="tactic">symmetry</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">C1'</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H1</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">C1'</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H1</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">H2</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H3</span>; <span class="id" type="tactic">exact</span> <span class="id" type="var">H3</span>.<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">matching_pb_eq_none</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">matching_pb_eq_none</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H''</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">H''</span> <span class="id" type="var">sigma</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span> [<span class="id" type="var">ps_eq_patsub</span> | <span class="id" type="var">ps_in_pb</span>].<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">ps_eq_patsub</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">ps_eq_patsub</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">K</span> := <span class="id" type="var">H</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>))).<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>; <span class="id" type="var">right</span>; <span class="id" type="tactic">trivial</span>.<br/>

<br/>
<span class="id" type="tactic">intro</span> <span class="id" type="var">matching_pb_eq_none</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">matching_pb_eq_none</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H'</span>.<br/>
<span class="id" type="tactic">apply</span> (<span class="id" type="var">H'</span> <span class="id" type="var">sigma</span>).<br/>
<span class="id" type="tactic">intros</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span> [<span class="id" type="var">ps_eq_patsub</span> | <span class="id" type="var">ps_in_pb</span>].<br/>
<span class="id" type="tactic">injection</span> <span class="id" type="var">ps_eq_patsub</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">ps_eq_patsub</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">p</span> <span class="id" type="var">s</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">K</span> := <span class="id" type="var">H</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>))).<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="var">absurd</span> (<span class="id" type="var">f</span>=g).<br/>
<span class="id" type="tactic">generalize</span> (<span class="id" type="var">F.Symb.eq_bool_ok</span> <span class="id" type="var">f</span> <span class="id" type="var">g</span>); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">f_diff_g</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H3</span>; <span class="id" type="tactic">exact</span> <span class="id" type="var">H3</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="var">K</span> := <span class="id" type="var">H</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> (<span class="id" type="var">or_introl</span> <span class="id" type="var">_</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>))).<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">injection</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">trivial</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">End</span> <span class="id" type="var">Make'</span>.<br/>

<br/>
<span class="id" type="keyword">Module</span> <span class="id" type="var">Make</span> (<span class="id" type="var">F1</span> : <span class="id" type="var">Signature</span>) (<span class="id" type="var">X1</span> : <span class="id" type="var">decidable_set.S</span>) : <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Term</span> <span class="id" type="keyword">with</span> <span class="id" type="keyword">Module</span> <span class="id" type="var">F</span> := <span class="id" type="var">F1</span> <span class="id" type="keyword">with</span> <span class="id" type="keyword">Module</span> <span class="id" type="var">X</span> := <span class="id" type="var">X1</span> := <span class="id" type="var">Make'</span> <span class="id" type="var">F1</span> <span class="id" type="var">X1</span>.<br/>

<br/>

<br/>
</div>
</div>

<div id="footer">
<hr/><a href="index.html">Index</a><hr/>This page has been generated by <a href="http://www.lix.polytechnique.fr/coq/">coqdoc</a>
</div>

</div>

</body>
</html>